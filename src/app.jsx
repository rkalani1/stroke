import React, { useState, useEffect, useRef, useMemo, useContext } from 'react';
import { createRoot } from 'react-dom/client';
import { createIcons, icons } from 'lucide';
import ais2026 from './guidelines/ais-2026.json';
import cancerStroke2026 from './guidelines/cancer-stroke-2026.json';
import cardiacBrainHealth2024 from './guidelines/cardiac-brain-health-2024.json';
import cvt2024 from './guidelines/cvt-2024.json';
import ich2022 from './guidelines/ich-2022.json';
import maternalStroke2026 from './guidelines/maternal-stroke-2026.json';
import perioperativeStroke2021 from './guidelines/perioperative-stroke-2021.json';
import poststrokeCognitive2023 from './guidelines/poststroke-cognitive-2023.json';
import poststrokePrimaryCare2021 from './guidelines/poststroke-primary-care-2021.json';
import poststrokeSpasticity2026 from './guidelines/poststroke-spasticity-2026.json';
import primaryPrevention2024 from './guidelines/primary-prevention-2024.json';
import premorbidDisability2022 from './guidelines/premorbid-disability-2022.json';
import secondaryPrevention2021 from './guidelines/secondary-prevention-2021.json';
import sah2023 from './guidelines/sah-2023.json';
import systemicComplications2024 from './guidelines/systemic-complications-2024.json';
import svinLargeCore2025 from './guidelines/svin-large-core-2025.json';
import tiaEd2023 from './guidelines/tia-ed-2023.json';

        const STORAGE_PREFIX = (window.strokeAppStorage && window.strokeAppStorage.prefix) || 'strokeApp:';
        const APP_DATA_KEY = (window.strokeAppStorage && window.strokeAppStorage.appDataKey) || 'stroke.appData.v2';
        const LEGACY_KEYS = (window.strokeAppStorage && window.strokeAppStorage.legacyKeys) || [
          'app_version',
          'darkMode',
          'activeTab',
          'patientData',
          'nihssScore',
          'aspectsScore',
          'gcsItems',
          'mrsScore',
          'ichScoreItems',
          'abcd2Items',
          'chads2vascItems',
          'ropeItems',
          'huntHessGrade',
          'wfnsGrade',
          'hasbledItems',
          'rcvs2Items',
          'strokeCodeForm',
          'lkwTime',
          'currentStep',
          'completedSteps',
          'aspectsRegionState',
          'pcAspectsRegions',
          'telestrokeNote',
          'telestrokeTemplate',
          'thrombolysisAlertsMuted',
          'timerSidebarCollapsed',
          'shiftPatients',
          'currentPatientId',
          'consultationType',
          'ttlHoursOverride',
          'lastUpdated',
          'legacyMigrated'
        ];
        const LEGACY_SESSION_KEYS = (window.strokeAppStorage && window.strokeAppStorage.legacySessionKeys) || ['error_reload_attempted'];
        const DEFAULT_TTL_HOURS = 12;
        const LAST_UPDATED_KEY = 'lastUpdated';
        const LEGACY_MIGRATION_KEY = 'legacyMigrated';
        const APP_DATA_SCHEMA_VERSION = 1;
        // Default contacts are empty — users configure their own via Settings > Contact Directory
        const DEFAULT_CONTACTS = [
          { id: 'stroke-phone', label: 'Stroke Phone', phone: '', note: 'Primary hub' },
          { id: 'stat-pharmacy', label: 'STAT Pharmacy', phone: '', note: '' },
          { id: 'rad-hotline', label: 'Stroke RAD Hotline', phone: '', note: '' },
          { id: 'rad-reading-room', label: 'RAD Reading Room', phone: '', note: '' },
          { id: 'angio-suite', label: 'Angio Suite', phone: '', note: '' },
          { id: 'stat-ct', label: 'STAT CT', phone: '', note: '' },
          { id: 'transfusion', label: 'Transfusion Services', phone: '', note: '' },
          { id: 'transfer-center', label: 'Transfer Center', phone: '', note: '' },
          { id: 'neurosurgery', label: 'Neurosurgery On-Call', phone: '', note: '' },
          { id: 'it-helpdesk', label: 'IT Help Desk', phone: '', note: '' }
        ];

        const parseStoredValue = (raw) => {
          if (raw === null || raw === undefined) return null;
          try {
            return JSON.parse(raw);
          } catch {
            return raw;
          }
        };

        const normalizeStoredValue = (value, fallback) => {
          if (value === undefined || value === null || value === 'undefined' || value === 'null') {
            return fallback;
          }
          if (typeof value === 'object' && value !== null && 'data' in value && 'expiresAt' in value) {
            if (typeof value.expiresAt === 'number' && Date.now() > value.expiresAt) {
              return fallback;
            }
            return value.data;
          }
          return value;
        };

        const getKey = (name, fallback) => {
          const namespaced = localStorage.getItem(STORAGE_PREFIX + name);
          if (namespaced !== null) {
            return normalizeStoredValue(parseStoredValue(namespaced), fallback);
          }
          const legacy = localStorage.getItem(name);
          if (legacy !== null) {
            return normalizeStoredValue(parseStoredValue(legacy), fallback);
          }
          return fallback;
        };

        const touchLastUpdated = () => {
          try {
            localStorage.setItem(STORAGE_PREFIX + LAST_UPDATED_KEY, JSON.stringify(Date.now()));
          } catch (e) {
            console.warn('Failed to update lastUpdated:', e);
            if (e.name === 'QuotaExceededError' || e.code === 22) {
              throw e;
            }
          }
        };

        const setKey = (name, value, options = {}) => {
          try {
            localStorage.setItem(STORAGE_PREFIX + name, JSON.stringify(value));
            if (!options.skipLastUpdated && name !== LAST_UPDATED_KEY) {
              touchLastUpdated();
            }
          } catch (e) {
            console.warn('Failed to save key:', name, e);
            if (e.name === 'QuotaExceededError' || e.code === 22) {
              throw e; // Re-throw quota errors for caller to handle
            }
          }
        };

        const removeKey = (name) => {
          localStorage.removeItem(STORAGE_PREFIX + name);
          localStorage.removeItem(name);
        };

        const clearAllAppStorage = () => {
          if (window.strokeAppStorage && typeof window.strokeAppStorage.clearAppStorage === 'function') {
            window.strokeAppStorage.clearAppStorage({ includeLegacy: true });
            return;
          }
          try {
            Object.keys(localStorage).forEach((key) => {
              if (key.startsWith(STORAGE_PREFIX)) {
                localStorage.removeItem(key);
              }
            });
            localStorage.removeItem(APP_DATA_KEY);
            LEGACY_KEYS.forEach((key) => localStorage.removeItem(key));
            Object.keys(sessionStorage).forEach((key) => {
              if (key.startsWith(STORAGE_PREFIX)) {
                sessionStorage.removeItem(key);
              }
            });
            LEGACY_SESSION_KEYS.forEach((key) => sessionStorage.removeItem(key));
          } catch (e) {
            console.warn('Storage clear failed:', e);
          }
        };

        const migrateLegacyStorage = () => {
          try {
            const migrated = localStorage.getItem(STORAGE_PREFIX + LEGACY_MIGRATION_KEY);
            if (migrated) return;
            LEGACY_KEYS.forEach((key) => {
              const legacyValue = localStorage.getItem(key);
              if (legacyValue === null) return;
              const parsed = parseStoredValue(legacyValue);
              const normalized = normalizeStoredValue(parsed, undefined);
              if (normalized !== undefined) {
                localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(normalized));
              }
            });
            localStorage.setItem(STORAGE_PREFIX + LEGACY_MIGRATION_KEY, JSON.stringify(true));
          } catch (e) {
            console.warn('Legacy storage migration failed:', e);
          }
        };

        const ensureArray = (value, fallback = []) => Array.isArray(value) ? value : fallback;
        const toIsoString = (value = new Date()) => {
          try {
            return new Date(value).toISOString();
          } catch {
            return new Date().toISOString();
          }
        };
        const safeParseDt = (val) => {
          if (!val) return null;
          const d = new Date(val);
          return Number.isNaN(d.getTime()) ? null : d;
        };
        const safeFormatTime = (val) => {
          const d = safeParseDt(val);
          return d ? d.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'}) : null;
        };

        const GlobalPatientContext = React.createContext(null);
        const useGlobalPatient = () => useContext(GlobalPatientContext);

        // ============================================
        // TOAST NOTIFICATION SYSTEM
        // ============================================
        let toastIdCounter = 0;


        const ToastContainer = ({ toasts, removeToast }) => {
          return React.createElement('div', {
            className: 'fixed bottom-20 left-1/2 -translate-x-1/2 z-[100] flex flex-col-reverse gap-2 pointer-events-none max-w-md w-full px-4',
            'aria-live': 'polite',
            'aria-atomic': 'true'
          }, toasts.map(t => React.createElement('div', {
            key: t.id,
            className: `pointer-events-auto flex items-center gap-2 px-4 py-3 rounded-xl shadow-lg border text-sm font-medium transition-all animate-toast-in toast-alert ${
              t.type === 'success' ? 'bg-emerald-600 text-white border-emerald-700' :
              t.type === 'error' ? 'bg-red-600 text-white border-red-700' :
              t.type === 'warning' ? 'bg-amber-600 text-white border-amber-700' :
              'bg-slate-800 text-white border-slate-700'
            }`,
            role: t.type === 'error' ? 'alert' : 'status'
          },
            React.createElement('span', { className: 'flex-1' }, t.message),
            React.createElement('button', {
              onClick: () => removeToast(t.id),
              className: 'ml-2 opacity-70 hover:opacity-100 transition-opacity text-white',
              'aria-label': 'Dismiss'
            }, '\u00D7')
          )));
        };

        // ============================================
        // CONFIRMATION MODAL (replaces confirm/prompt)
        // ============================================
        const ConfirmModal = ({ config, onClose }) => {
          const [inputValue, setInputValue] = React.useState(config.defaultValue || '');
          if (!config) return null;
          return React.createElement('div', { className: 'fixed inset-0 z-[200] flex items-center justify-center p-4' },
            React.createElement('div', { className: 'fixed inset-0 bg-black/40', onClick: () => { if (!config.required) onClose(null); }, role: 'presentation', 'aria-hidden': 'true' }),
            React.createElement('div', { className: 'relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 space-y-4', role: 'dialog', 'aria-modal': 'true', 'aria-labelledby': 'confirm-modal-title' },
              React.createElement('h3', { id: 'confirm-modal-title', className: 'text-lg font-bold text-slate-900' }, config.title || 'Confirm'),
              config.message && React.createElement('p', { className: 'text-sm text-slate-600' }, config.message),
              config.input && React.createElement('div', { className: 'space-y-1' },
                config.inputLabel && React.createElement('label', { className: 'block text-xs font-medium text-slate-700' }, config.inputLabel),
                config.inputType === 'textarea'
                  ? React.createElement('textarea', {
                      value: inputValue,
                      onChange: (e) => setInputValue(e.target.value),
                      rows: 3,
                      className: 'w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none',
                      placeholder: config.placeholder || '',
                      autoFocus: true
                    })
                  : React.createElement('input', {
                      type: 'text',
                      value: inputValue,
                      onChange: (e) => setInputValue(e.target.value),
                      className: 'w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none',
                      placeholder: config.placeholder || '',
                      autoFocus: true
                    })
              ),
              React.createElement('div', { className: 'flex justify-end gap-2' },
                React.createElement('button', {
                  onClick: () => onClose(null),
                  className: 'px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors'
                }, 'Cancel'),
                React.createElement('button', {
                  onClick: () => onClose(config.input ? inputValue : true),
                  className: `px-4 py-2 text-sm font-medium text-white rounded-lg transition-colors ${
                    config.danger ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'
                  }`
                }, config.confirmLabel || 'Confirm')
              )
            )
          );
        };

        // ============================================
        // ERROR BOUNDARY
        // ============================================
        class ErrorBoundary extends React.Component {
          constructor(props) {
            super(props);
            this.state = { hasError: false, error: null };
          }
          static getDerivedStateFromError(error) {
            return { hasError: true, error };
          }
          componentDidCatch(error, info) {
            console.error('ErrorBoundary caught:', error, info);
          }
          render() {
            if (this.state.hasError) {
              return React.createElement('div', {
                className: 'p-4 bg-red-50 border border-red-200 rounded-xl text-center space-y-3'
              },
                React.createElement('p', { className: 'text-red-800 font-semibold' }, 'Something went wrong in this section.'),
                React.createElement('p', { className: 'text-sm text-red-600' }, this.state.error?.message || ''),
                React.createElement('button', {
                  onClick: () => this.setState({ hasError: false, error: null }),
                  className: 'px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition-colors'
                }, 'Reset Section')
              );
            }
            return this.props.children;
          }
        }

        // ============================================
        // ENCOUNTER TEMPLATES
        // ============================================
        const ENCOUNTER_TEMPLATES = [
          { id: 'blank', label: 'Blank Encounter', icon: 'file-plus', description: 'Start fresh', defaults: {} },
          { id: 'acute-lvo', label: 'Acute LVO', icon: 'zap', description: 'Large vessel occlusion workup', defaults: { diagnosisCategory: 'ischemic', diagnosis: 'Ischemic stroke - LVO' } },
          { id: 'tia', label: 'TIA Workup', icon: 'activity', description: 'Transient ischemic attack evaluation', defaults: { diagnosisCategory: 'ischemic', diagnosis: 'TIA' } },
          { id: 'wakeup', label: 'Wake-up Stroke', icon: 'moon', description: 'Unknown onset / wake-up presentation', defaults: { diagnosisCategory: 'ischemic', lkwUnknown: true, wakeUpStrokeWorkflow: { isWakeUpStroke: true } } },
          { id: 'ich-anticoag', label: 'ICH on Anticoagulation', icon: 'alert-triangle', description: 'Hemorrhage with reversal needed', defaults: { diagnosisCategory: 'ich', diagnosis: 'Intracerebral hemorrhage' } },
          { id: 'sah', label: 'SAH', icon: 'droplets', description: 'Subarachnoid hemorrhage management', defaults: { diagnosisCategory: 'sah', diagnosis: 'Subarachnoid hemorrhage' } },
          { id: 'posterior', label: 'Posterior Circulation', icon: 'brain', description: 'Basilar/vertebral stroke', defaults: { diagnosisCategory: 'ischemic', diagnosis: 'Posterior circulation stroke' } },
          { id: 'minor-stroke', label: 'Minor Stroke', icon: 'activity', description: 'NIHSS ≤5, DAPT protocol', defaults: { diagnosisCategory: 'ischemic', diagnosis: 'Minor ischemic stroke' } }
        ];

        // ============================================
        // CLINICAL PEARLS
        // ============================================
        const CLINICAL_PEARLS = {
          tnk: 'TNK 0.25 mg/kg is non-inferior to alteplase with similar sICH rates (3.4% vs 3.2%) and simpler single-bolus administration (AcT trial, Lancet 2022).',
          evt: 'EVT benefit is time-dependent: NNT ~2.6 overall at 0-6h (HERMES). Late-window with perfusion selection: NNT ~2.8 (DAWN), ~3.6 (DEFUSE-3). Every 15-min delay reduces benefit.',
          ich_bp: 'INTERACT3: Intensive BP lowering + bundle of care improves functional outcomes in ICH (Lancet 2023).',
          doac_timing: 'ELAN/CATALYST: Early DOAC restart after ischemic stroke — mild (NIHSS <8): 48h; moderate (NIHSS 8-15): day 3-5; severe (NIHSS ≥16): day 6-14 with repeat imaging.',
          aspects: 'ASPECTS 6-10: Standard EVT eligibility. ASPECTS 3-5: Consider EVT for mRS 0-1 patients with anterior LVO (SELECT2, ANGEL-ASPECT).',
          pcc: 'Fixed-dose PCC (2000 units) for warfarin reversal in ICH — check INR at 15-30 min post-infusion.',
          wakeup: 'DWI-FLAIR mismatch suggests onset <4.5h; CTP mismatch allows treatment up to 9h from midpoint of sleep (WAKE-UP, EXTEND).'
        };

        // ============================================
        // CHANGELOG
        // ============================================
        const CHANGELOG = [
          { version: '2.5', date: '2025-06', items: ['Updated ICH algorithms to pocket cards', 'Replaced EVT mermaid flowcharts with scannable tables', 'Added warfarin/DOAC reversal step-cards', 'Added post-thrombolytic ICH protocol', 'Added angioedema management', 'Added contrast allergy protocol', 'Added BP management quick reference'] },
          { version: '2.6', date: '2025-07', items: ['Simplified encounter to Video Telestroke / Phone Consult', 'Removed inpatient/clinic contexts and quick/full mode toggle'] },
          { version: '3.0', date: '2025-08', items: ['Toast notification system replacing inline alerts', 'Replaced all confirm/prompt dialogs with styled modals', 'Persistent timer visible across all tabs', 'Encounter templates for common presentations', 'Encounter history with shift handoff support', 'Focus mode for active encounters', 'Calculator drawer with inline scoring', 'Section completion indicators', 'Keyboard shortcuts (Ctrl+Shift+C, Ctrl+K, etc.)', 'Improved mobile touch targets', 'Visual timeline for stroke events', 'Auto-filtering trials by patient characteristics', 'References search and filtering', 'Error boundaries for graceful failure recovery', 'Service worker for offline support'] },
          { version: '3.1', date: '2025-09', items: ['Added vital signs (HR, SpO2, Temp) to encounter and notes', 'Added EKG/Telemetry input fields', 'GCS score included in all note templates', 'Weight unit toggle (kg/lbs) with auto-conversion', 'Edoxaban added to anticoagulant system', 'aPTT auto-blocks TNK when >40s', 'Standardized platelet units (K/μL) throughout', 'Inline lab validation badges (glucose, INR, platelets, aPTT)', 'Andexanet alfa aligned to PCC-first protocol', 'Consent documentation in transfer notes', 'Fixed keyboard shortcut conflicts and section completion', 'Improved reset logic for new patients'] },
          { version: '3.2', date: '2025-10', items: ['Notes now show consultation type (Telephone vs Video Telestroke)', 'BP phase target included in consultation, transfer, and signout notes', 'TOAST classification in transfer and discharge notes', 'Anticoagulation details with DOAC timing in consultation note', 'Transfer note shows weight, premorbid mRS, contrast allergy flag', 'Dysphagia screening and VTE prophylaxis in discharge note', 'Transfer note alerts for NPO status and contrast allergy', 'SAH + anticoagulation reversal warning', 'GCS ≤8 airway protection alert', 'Edoxaban CrCl >95 reduced efficacy warning', 'Hypoglycemia + TNK escalated to error severity', 'BP phase auto-reverts when diagnosis changes', 'Fixed INR/aPTT orphaned comma in lab line', 'Trial eligibility reset on new case'] },
          { version: '3.3', date: '2025-11', items: ['CrCl calculator prioritized by diagnosis in calculator tab', 'Post-TNK neuro check schedule standardized (q15min×2h, q30min×6h, q1h×16h)', 'SAH seizure prophylaxis with specific indications in admission orders', 'Osmotic therapy data in discharge note (agent, Na+ target, osmolality)', 'Nutritional support and feeding route in discharge note', 'Falls risk screening in discharge note', 'Driving restrictions with commercial driver flag in discharge note', 'Clipboard fallback for insecure contexts (HTTP/dev builds)', 'Deep merge of stored data prevents crashes when new fields are added', 'All calculator copy buttons now have accessible labels', 'ICH Volume, Andexanet, and Enoxaparin calculators now sort by diagnosis priority'] },
          { version: '3.4', date: '2026-02', items: ['SAH aneurysm characteristics (location, size, securing method) with posterior circulation and giant aneurysm alerts', 'SAH vasospasm/DCI monitoring protocol (TCD, neuro checks, sodium, induced HTN) with safety guard', 'ICH surgical decision support (cerebellar >15mL, hydrocephalus, midline shift, deterioration) with neurosurgery urgency alert', 'Stroke vascular territory selector (MCA/ACA/PCA/basilar/vertebral/cerebellar/lacunar/watershed) with posterior circulation guidance', 'Stroke phenotype classifier (cortical-LVO, embolic, lacunar, posterior, dissection, watershed, cardioembolic)', 'Symptom trajectory tracking (stable/improving/fluctuating/worsening/resolved) with clinical alerts', 'Post-thrombolytic monitoring protocol checklist with sICH risk calculator (5 factors)', 'Family/surrogate communication log with auto-timestamp', 'All new fields integrated into consult, transfer, signout, progress, discharge, and Pulsara templates', 'Fixed GCS reference in ICH guideline conditions (seizure prophylaxis, MIE eligibility)', 'Fixed FUNC score GCS 13-15 returning null instead of 2 points', 'State cleanup on diagnosis category change includes nested objects'] }
        ];

        const parseBloodPressure = (bpString) => {
          if (!bpString) return null;
          const match = bpString.match(/(\d{2,3})\s*\/\s*(\d{2,3})/);
          if (!match) return null;
          return {
            systolic: parseInt(match[1], 10),
            diastolic: parseInt(match[2], 10)
          };
        };

        const getWindowStatusFromTime = (timeFromLKW) => {
          if (!timeFromLKW) return null;
          if (timeFromLKW.total <= 4.5) {
            if (timeFromLKW.total < 3) {
              return { color: 'green', message: 'Within TNK window (<3h)', urgent: false, eligible: 'tnk' };
            }
            return { color: 'yellow', message: 'Extended TNK window (3-4.5h)', urgent: false, eligible: 'tnk' };
          }
          if (timeFromLKW.total < 6) {
            return { color: 'orange', message: 'TNK window closed - EVT window (4.5-6h)', urgent: true, eligible: 'evt-early' };
          }
          if (timeFromLKW.total < 24) {
            return { color: 'red', message: 'Late EVT window (6-24h - needs perfusion imaging)', urgent: true, eligible: 'evt-late' };
          }
          return { color: 'gray', message: 'Beyond standard treatment window', urgent: false, eligible: 'none' };
        };

        const useStrokeWindow = ({
          lkwDate,
          lkwTime,
          lkwUnknown,
          discoveryDate,
          discoveryTime,
          now
        }) => {
          return useMemo(() => {
            const buildDate = (dateStr, timeStr) => {
              if (!dateStr || !timeStr) return null;
              const [year, month, day] = dateStr.split('-').map(Number);
              const [hours, minutes] = timeStr.split(':').map(Number);
              if (!year || !month || !day || Number.isNaN(hours) || Number.isNaN(minutes)) return null;
              return new Date(year, month - 1, day, hours, minutes);
            };

            const discovery = buildDate(discoveryDate, discoveryTime);
            const lkw = buildDate(lkwDate, lkwTime);
            const reference = lkwUnknown ? discovery : lkw;
            if (!reference) {
              return { timeFrom: null, status: null, label: lkwUnknown ? 'Discovery' : 'LKW' };
            }

            const nowTime = now instanceof Date ? now : new Date();
            const diffMs = Math.max(0, nowTime - reference);
            const diffHrs = diffMs / (1000 * 60 * 60);
            const diffMins = (diffMs / (1000 * 60)) % 60;
            const timeFrom = {
              hours: Math.floor(diffHrs),
              minutes: Math.floor(Math.abs(diffMins)),
              total: diffHrs,
              label: lkwUnknown ? 'Discovery' : 'LKW'
            };
            return {
              timeFrom,
              status: getWindowStatusFromTime(timeFrom),
              label: timeFrom.label
            };
          }, [lkwDate, lkwTime, lkwUnknown, discoveryDate, discoveryTime, now instanceof Date ? now.getTime() : now]);
        };

        const DOAC_PROTOCOLS = {
          catalyst: {
            label: 'CATALYST early-start (default)',
            days: { minor: 1, moderate: 3, severe: 6 }
          },
          '1-3-6-12': {
            label: '1-3-6-12 rule',
            days: { minor: 1, moderate: 3, severe: 6, verySevere: 12 }
          }
        };

        const calculateDOACStart = (nihss, onsetDate, protocol = 'catalyst') => {
          const nihssVal = parseFloat(nihss);
          if (!onsetDate) return null;
          const onset = new Date(onsetDate);
          if (Number.isNaN(onset.getTime())) return null;
          const rule = DOAC_PROTOCOLS[protocol] || DOAC_PROTOCOLS.catalyst;
          const severity = Number.isNaN(nihssVal)
            ? 'moderate'
            : nihssVal < 8
              ? 'minor'
              : nihssVal <= 15
                ? 'moderate'
                : nihssVal >= 21 && rule.days.verySevere
                  ? 'verySevere'
                  : 'severe';
          const days = rule.days[severity] ?? rule.days.severe ?? rule.days.moderate;
          const startDate = new Date(onset);
          startDate.setDate(startDate.getDate() + days);
          return { severity, days, startDate };
        };

        const generateId = (prefix = 'id') => {
          const stamp = Date.now().toString(36);
          const rand = Math.random().toString(36).slice(2, 8);
          return `${prefix}_${stamp}_${rand}`;
        };

        const copyPlainText = async (text) => {
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
              return true;
            }
            return copyFallback(text);
          } catch (e) {
            return copyFallback(text);
          }
        };


        const copyWithSectionHeaders = async (sections) => {
          const content = sections
            .filter(section => section && section.body && section.body.trim())
            .map(section => `=== ${section.title} ===\n${section.body}`)
            .join('\n\n');
          if (!content.trim()) return false;
          return copyPlainText(content.trim());
        };



        const importJSON = (file) => {
          return new Promise((resolve, reject) => {
            if (!file) {
              reject(new Error('No file provided'));
              return;
            }
            if (file.size > 10 * 1024 * 1024) {
              reject(new Error('File too large (>10MB) — likely not a valid case export'));
              return;
            }
            if (file.type && !file.type.includes('json') && !file.type.includes('text')) {
              reject(new Error('Invalid file type — expected JSON'));
              return;
            }
            const reader = new FileReader();
            reader.onload = () => {
              try {
                const parsed = JSON.parse(reader.result);
                if (!parsed || typeof parsed !== 'object' || Array.isArray(parsed)) {
                  reject(new Error('Invalid JSON structure — expected an object'));
                  return;
                }
                // Schema validation: must have recognizable app structure
                const hasAppData = parsed.schemaVersion || parsed.appData;
                const hasCaseData = parsed.telestrokeNote || parsed.strokeCodeForm || parsed.patientData;
                if (!hasAppData && !hasCaseData) {
                  reject(new Error('Unrecognized file format — missing telestrokeNote, strokeCodeForm, or schemaVersion'));
                  return;
                }
                // Validate telestrokeNote shape if present
                const note = parsed.telestrokeNote || parsed.appData?.telestrokeNote;
                if (note) {
                  if (typeof note !== 'object' || Array.isArray(note)) {
                    reject(new Error('Invalid telestrokeNote — expected an object'));
                    return;
                  }
                  // Check for unexpected executable content
                  const noteStr = JSON.stringify(note);
                  if (/<script/i.test(noteStr) || /javascript:/i.test(noteStr)) {
                    reject(new Error('Import blocked — file contains potentially unsafe content'));
                    return;
                  }
                }
                resolve(parsed);
              } catch (e) {
                reject(new Error('Invalid JSON — ' + e.message));
              }
            };
            reader.onerror = () => reject(reader.error || new Error('File read failed'));
            reader.readAsText(file);
          });
        };

        const DEID_PATTERNS = [
          { id: 'mrn', label: 'Possible MRN (long numeric ID)', regex: /\b\d{7,}\b/ },
          { id: 'dob', label: 'Possible DOB/date', regex: /\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/ },
          { id: 'phone', label: 'Possible phone number', regex: /\b(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/ },
          { id: 'email', label: 'Possible email address', regex: /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/i }
        ];

        const getDeidWarnings = (text) => {
          if (!text || typeof text !== 'string') return [];
          return DEID_PATTERNS.filter(pattern => pattern.regex.test(text)).map(pattern => pattern.label);
        };

        const getDefaultClipboardPacks = () => ([
          {
            id: 'telestroke-consult',
            title: 'Telestroke Consult Pack',
            description: 'Summary for consult documentation.',
            sections: [
              { id: 'summary', title: 'Summary', enabled: true, template: 'Alias: {PATIENT_ALIAS}\nAge/Sex: {AGE}{SEX}\nNIHSS: {NIHSS}\nDx: {DIAGNOSIS}\nLVO: {LVO}\nWeight: {WEIGHT_KG} kg' },
              { id: 'times', title: 'Key Times', enabled: true, template: 'LKW: {LKW}\nArrival: {ARRIVAL}\nCT: {CT_TIME}\nCTA: {CTA_TIME}' },
              { id: 'imaging', title: 'Imaging', enabled: true, template: 'CT: {CT_RESULTS}\nCTA: {CTA_RESULTS}\nASPECTS: {ASPECTS}' },
              { id: 'plan', title: 'Plan', enabled: true, template: 'TNK: {TNK_STATUS}\nEVT: {EVT_STATUS}\nDisposition: {DISPOSITION}' }
            ]
          },
          {
            id: 'transfer-pack',
            title: 'Transfer Pack',
            description: 'Transfer-ready summary for receiving centers.',
            sections: [
              { id: 'summary', title: 'Summary', enabled: true, template: 'Alias: {PATIENT_ALIAS}\nAge/Sex: {AGE}{SEX}\nNIHSS: {NIHSS}\nDx: {DIAGNOSIS}\nLVO: {LVO}' },
              { id: 'imaging', title: 'Imaging', enabled: true, template: 'CT: {CT_RESULTS}\nCTA: {CTA_RESULTS}\nASPECTS: {ASPECTS}\nPerfusion: {CTP_RESULTS}' },
              { id: 'treatment', title: 'Treatment', enabled: true, template: 'TNK: {TNK_STATUS}\nEVT: {EVT_STATUS}\nTransfer status: {TRANSFER_STATUS}' }
            ]
          },
          {
            id: 'signout-pack',
            title: 'Signout Pack',
            description: 'End-of-shift signout snapshot.',
            sections: [
              { id: 'summary', title: 'Summary', enabled: true, template: 'Alias: {PATIENT_ALIAS}\nAge/Sex: {AGE}{SEX}\nNIHSS: {NIHSS}\nDx: {DIAGNOSIS}\nDisposition: {DISPOSITION}' },
              { id: 'pending', title: 'Pending / Follow-up', enabled: true, template: '{PENDING_ITEMS}' }
            ]
          },
          {
            id: 'ich-pack',
            title: 'ICH Pack',
            description: 'ICH-specific bundle.',
            sections: [
              { id: 'summary', title: 'Summary', enabled: true, template: 'Alias: {PATIENT_ALIAS}\nAge/Sex: {AGE}{SEX}\nICH Score: {ICH_SCORE}\nGCS: {GCS}\nBP: {BP}' },
              { id: 'imaging', title: 'Imaging', enabled: true, template: 'CT: {CT_RESULTS}\nHematoma: {HEMATOMA}\nIVH: {IVH}' },
              { id: 'plan', title: 'Plan', enabled: true, template: 'Reversal: {REVERSAL}\nDisposition: {DISPOSITION}' }
            ]
          }
        ]);

          const getDefaultSettings = () => ({
            deidMode: true,
            allowFreeTextStorage: false,
            ttlHoursOverride: null,
            defaultConsultationType: 'videoTelestroke',
            workflowPersona: 'senior',
            contacts: DEFAULT_CONTACTS,
          });

        const getDefaultAppData = () => ({
          schemaVersion: APP_DATA_SCHEMA_VERSION,
          settings: getDefaultSettings(),
          shiftBoards: [],
          uiState: {
            lastActiveTab: 'encounter',
            lastShiftBoardId: null,
            lastManagementSubTab: 'ich',
            lastLibrarySection: 'management',
            legacyMigratedAt: null,
            searchHighlightId: null,
          },
          encounter: {
            clipboardPacks: getDefaultClipboardPacks(),
            clipboardPackVisibility: {}
          }
        });

        const mergeAppData = (base, incoming) => {
          const merged = {
            ...base,
            ...incoming,
            settings: { ...base.settings, ...(incoming && incoming.settings ? incoming.settings : {}) },
            uiState: { ...base.uiState, ...(incoming && incoming.uiState ? incoming.uiState : {}) },
            encounter: { ...base.encounter, ...(incoming && incoming.encounter ? incoming.encounter : {}) }
          };
          delete merged.pinnedReferences;
          merged.shiftBoards = ensureArray(merged.shiftBoards, []);
          merged.encounter.clipboardPacks = ensureArray(merged.encounter.clipboardPacks, getDefaultClipboardPacks());
          return merged;
        };

        const migrateAppData = (data) => {
          const next = { ...data };
          const version = Number.isFinite(next.schemaVersion) ? next.schemaVersion : 0;
          if (version < APP_DATA_SCHEMA_VERSION) {
            next.schemaVersion = APP_DATA_SCHEMA_VERSION;
          }
          return next;
        };

        const migrateLegacyToAppData = (data) => {
          if (data.uiState && data.uiState.legacyMigratedAt) return data;
          const next = mergeAppData(getDefaultAppData(), data);

          const legacyActiveTab = getKey('activeTab', null);
          if (legacyActiveTab) {
            next.uiState.lastActiveTab = legacyActiveTab;
          }

          const legacyTtl = getKey('ttlHoursOverride', null);
          if (Number.isFinite(Number(legacyTtl)) && Number(legacyTtl) > 0) {
            next.settings.ttlHoursOverride = Number(legacyTtl);
          }


          next.uiState.legacyMigratedAt = toIsoString();
          return next;
        };

        const loadAppData = () => {
          const base = getDefaultAppData();
          const raw = localStorage.getItem(APP_DATA_KEY);
          if (!raw) {
            return migrateLegacyToAppData(base);
          }
          try {
            const parsed = JSON.parse(raw);
            const merged = mergeAppData(base, parsed);
            return migrateLegacyToAppData(migrateAppData(merged));
          } catch (e) {
            console.warn('Failed to parse app data:', e);
            return migrateLegacyToAppData(base);
          }
        };

        const saveAppData = (data) => {
          try {
            localStorage.setItem(APP_DATA_KEY, JSON.stringify(data));
            touchLastUpdated();
          } catch (e) {
            if (e.name === 'QuotaExceededError' || e.code === 22) {
              console.error('Storage quota exceeded:', e);
              try { document.dispatchEvent(new CustomEvent('storage-quota-exceeded')); } catch (_) {}
            } else {
              console.warn('Failed to save app data:', e);
            }
          }
        };

        const parseLastUpdated = (value) => {
          if (typeof value === 'number' && Number.isFinite(value)) return value;
          if (typeof value === 'string') {
            const numeric = Number(value);
            if (Number.isFinite(numeric)) return numeric;
            const parsedDate = Date.parse(value);
            if (!Number.isNaN(parsedDate)) return parsedDate;
          }
          return null;
        };

        const applyStorageExpiration = (ttlHours) => {
          const lastUpdatedRaw = getKey(LAST_UPDATED_KEY, null);
          const lastUpdated = parseLastUpdated(lastUpdatedRaw);
          if (!lastUpdated || !Number.isFinite(ttlHours) || ttlHours <= 0) {
            return false;
          }
          const ttlMs = ttlHours * 60 * 60 * 1000;
          if (Date.now() - lastUpdated > ttlMs) {
            clearAllAppStorage();
            return true;
          }
          return false;
        };

        migrateLegacyStorage();
        const INITIAL_APP_DATA = loadAppData();
        const storedTtlOverride = INITIAL_APP_DATA.settings.ttlHoursOverride ?? getKey('ttlHoursOverride', null);
        const initialTtlHours = Number.isFinite(storedTtlOverride) && storedTtlOverride > 0
          ? storedTtlOverride
          : DEFAULT_TTL_HOURS;
        const INITIAL_STORAGE_EXPIRED = applyStorageExpiration(initialTtlHours);

        const MANAGEMENT_SUBTABS = ['ich', 'ischemic', 'sah', 'tia', 'cvt', 'calculators', 'references'];
        const LIBRARY_SECTIONS = ['management', 'trials'];
        const LEGACY_MANAGEMENT_TABS = {
          ich: 'ich',
          protocols: 'ischemic',
          calculators: 'calculators',
          evidence: 'references'
        };

        const normalizeManagementSubTab = (value) => {
          if (!value) return null;
          const normalized = String(value).toLowerCase();
          if (MANAGEMENT_SUBTABS.includes(normalized)) return normalized;
          if (LEGACY_MANAGEMENT_TABS[normalized]) return LEGACY_MANAGEMENT_TABS[normalized];
          return null;
        };

        const VALID_TABS = [
          'dashboard',
          'encounter',
          'library',
          'settings',
          'management',
          'trials'
        ];

        const parseHashRoute = (hash) => {
          if (!hash) return { tab: 'encounter' };
          const cleaned = hash.replace(/^#\/?/, '').trim();
          if (!cleaned) {
            return { tab: 'encounter' };
          }
          const parts = cleaned.split('/').filter(Boolean);
          const root = parts[0];
          const sub = parts[1];

          switch (root) {
            case 'dashboard':
              return { tab: 'dashboard' };
            case 'home':
              return { tab: 'encounter' };
            case 'encounter':
              return { tab: 'encounter' };
            case 'library':
              return { tab: 'library', sub: LIBRARY_SECTIONS.includes(sub) ? sub : 'management' };
            case 'settings':
              return { tab: 'settings' };
            case 'management':
              return { tab: 'management', sub: normalizeManagementSubTab(sub) };
            case 'ich':
            case 'protocols':
            case 'calculators':
            case 'evidence':
              return { tab: 'management', sub: LEGACY_MANAGEMENT_TABS[root] };
            case 'trials':
              return { tab: 'trials' };
            default:
              return null;
          }
        };

        const buildHashRoute = (tab, sub) => {
          switch (tab) {
            case 'dashboard':
              return '#/dashboard';
            case 'encounter':
              return '#/encounter';
            case 'library': {
              const librarySub = LIBRARY_SECTIONS.includes(sub) ? sub : 'management';
              return `#/library/${librarySub}`;
            }
            case 'settings':
              return '#/settings';
            case 'management': {
              const managementSub = normalizeManagementSubTab(sub);
              return managementSub ? `#/management/${managementSub}` : '#/management';
            }
            case 'ich':
              return '#/management/ich';
            case 'protocols':
              return '#/management/ischemic';
            case 'calculators':
              return '#/management/calculators';
            case 'trials':
              return '#/trials';
            case 'evidence':
              return '#/management/references';
            default:
              return '#/encounter';
          }
        };

        const StrokeClinicalTool = () => {
          const defaultTelestrokeTemplate = `Reason for Consultation: Acute stroke evaluation — {chiefComplaint}

Chief complaint: {chiefComplaint}
Last known well (date/time): {lkwDate} {lkwTime}
HPI: {hpiDemographics} p/w {symptoms} at {lkwTime}
Relevant PMH: {pmh}
Medications: {medications}

Objective:
Vitals: BP {presentingBP}, HR {heartRate}, SpO2 {spO2}%, Temp {temperature}°F
{bpPreTNKLine}
Labs: Glucose {glucose}, Plt {plateletCount}K, Cr {creatinine}, INR {inr}{ptt}
Exam: NIHSS {nihss} {gcs}- {nihssDetails}

Imaging: I personally reviewed imaging
NCCT Head ({ctTime}): {ctResults} {aspects}
CTA Head/Neck ({ctaDate} {ctaTime}): {ctaResults} {vesselOcclusion}
CTP: {ctpResults}
Telemetry/EKG: {ekgResults}

Assessment and Plan:
Suspected Diagnosis: {diagnosis}
After ensuring that there were no evident contraindications, TNK administration was recommended at {tnkAdminTime}. Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the patient, family/LNOK, and OSH provider.
TNK was administered at {tnkAdminTime} after a brief time-out.

Recommendations:
{recommendationsText}

Clinician Name`;

          const getDefaultStrokeCodeForm = () => ({
            age: '',
            sex: '',
            hx: '',
            sx: '',
            lkw: '',
            lkw_date: new Date().toISOString().split('T')[0],
            nihss: '',
            aspects: '',
            def: '',
            hct: '',
            cta: '',
            ctp: '',
            tnk: [],
            tnk_rec: '',
            evt_rec: '',
            rec_reason: ''
          });

          const getDefaultAspectsRegionState = () => ([
            { id: 'M1', name: 'M1 - Anterior MCA cortex', checked: true },
            { id: 'M2', name: 'M2 - MCA cortex lateral to insular ribbon', checked: true },
            { id: 'M3', name: 'M3 - Posterior MCA cortex', checked: true },
            { id: 'M4', name: 'M4 - Anterior MCA territory immediately superior to M1', checked: true },
            { id: 'M5', name: 'M5 - Lateral MCA territory immediately superior to M2', checked: true },
            { id: 'M6', name: 'M6 - Posterior MCA territory immediately superior to M3', checked: true },
            { id: 'IC', name: 'IC - Internal capsule', checked: true },
            { id: 'L', name: 'L - Lentiform nucleus', checked: true },
            { id: 'C', name: 'C - Caudate', checked: true },
            { id: 'I', name: 'I - Insular ribbon', checked: true }
          ]);

          const getDefaultPcAspectsRegions = () => ([
            { id: 'THAL-L', name: 'Left Thalamus', checked: true, points: 1 },
            { id: 'THAL-R', name: 'Right Thalamus', checked: true, points: 1 },
            { id: 'MIDBRAIN', name: 'Midbrain', checked: true, points: 2 },
            { id: 'PONS', name: 'Pons', checked: true, points: 2 },
            { id: 'CEREBELLUM-L', name: 'Left Cerebellar Hemisphere', checked: true, points: 1 },
            { id: 'CEREBELLUM-R', name: 'Right Cerebellar Hemisphere', checked: true, points: 1 },
            { id: 'PCA-L', name: 'Left Occipital Lobe (PCA Territory)', checked: true, points: 1 },
            { id: 'PCA-R', name: 'Right Occipital Lobe (PCA Territory)', checked: true, points: 1 }
          ]);

          const getDefaultTelestrokeNote = () => ({
            // Consultation metadata
            consultStartTime: '',
            callerName: '',
            callerRole: '',
            attendingPhysician: '',
            // Calling Site for Telephone Consults
            callingSite: '',
            callingSiteOther: '',
            alias: '',
            chiefComplaint: '',
            lkwDate: new Date().toISOString().split('T')[0],
            lkwTime: new Date().toTimeString().slice(0, 5),
            lkwUnknown: false,
            discoveryDate: '',
            discoveryTime: '',
            age: '',
            sex: '',
            affectedSide: '',
            weight: '',
            weightEstimated: false,
            lastDOACDose: '',
            lastDOACType: '',
            // DTN Time Metrics
            dtnEdArrival: '',
            dtnStrokeAlert: '',
            dtnCtStarted: '',
            dtnCtRead: '',
            dtnTnkOrdered: '',
            dtnTnkAdministered: '',
            symptoms: '',
            pmh: '',
            medications: '',
            premorbidMRS: '',
            vesselOcclusion: [],
            presentingBP: '',
            heartRate: '',
            spO2: '',
            temperature: '',
            bpPreTNK: '',
            bpPreTNKTime: '',
            bpPhase: 'pre-tnk',
            bpPostEVT: '',
            glucose: '',
            creatinine: '',
            height: '',
            inr: '',
            pt: '',
            ptt: '',
            plateletCount: '',
            allergies: '',
            contrastAllergy: false,
            nihss: '',
            nihssDetails: '',
            disablingDeficit: false,
            ctDate: new Date().toISOString().split('T')[0],
            ctTime: '',
            ctResults: '',
            ctaDate: new Date().toISOString().split('T')[0],
            ctaTime: '',
            ctaResults: '',
            ctpResults: '',
            ctpStructured: { coreVolume: '', penumbraVolume: '', mismatchRatio: '' },
            collateralGrade: '',
            earlyInfarctSigns: false,
            denseArterySign: false,
            ekgResults: '',
            wakeUpStrokeWorkflow: {
              isWakeUpStroke: false,
              mriAvailable: null,
              dwi: {
                positiveForLesion: false,
                lesionVolume: ''
              },
              flair: {
                noMarkedHyperintensity: false
              },
              ageEligible: false,
              nihssEligible: false,
              extendCriteria: {
                nihss4to26: false,
                premorbidMRSLt2: false,
                ischemicCoreLte70: false,
                mismatchRatioGte1_2: false,
                timeWindow4_5to9h: false
              },
              imagingRecommendation: '',
              wakeUpEligible: null,
              extendEligible: null
            },
            diagnosis: '',
            diagnosisCategory: '',
            tnkRecommended: false,
            tnkAutoBlocked: false,
            tnkAutoBlockReason: '',
            evtRecommended: false,
            rationale: '',
            tnkConsentDiscussed: false,
            tnkConsentType: '',
            tnkConsentTime: '',
            tnkConsentWith: '',
            patientFamilyConsent: false,
            presumedConsent: false,
            preTNKSafetyPause: false,
            tnkAdminTime: '',
            // Post-TNK monitoring
            postTnkNeuroChecksStarted: false,
            postTnkBpMonitoring: false,
            postTnkRepeatCTOrdered: false,
            postTnkAntiplateletHeld: false,
            // Post-TNK complications
            sichDetected: false,
            angioedemaDetected: false,
            reperfusionHemorrhage: false,
            clinicalDeterioration: false,
            complicationNotes: '',
            admitLocation: '',
            recommendationsText: '',
            transferAccepted: false,
            transferReceivingFacility: '',
            transferRationale: '',
            transferImagingShareMethod: '',
            transferImagingShareLink: '',
            transportMode: '',
            transportEta: '',
            transportNotes: '',
            disposition: '',
            codeStatus: '',
            // Transfer checklist (telephone form flat fields)
            transferImagingShared: false,
            transferLabsSent: false,
            transferIVAccess: false,
            transferBPStable: false,
            transferFamilyNotified: false,
            doorTime: '',
            needleTime: '',
            punctureTime: '',
            tnkContraindicationChecklist: {
              activeInternalBleeding: false,
              recentIntracranialSurgery: false,
              recentStroke: false,
              recentHeadTrauma: false,
              extensiveHypoattenuation: false,
              intracranialTumor: false,
              knownBleedingDiathesis: false,
              severeUncontrolledHTN: false,
              currentICH: false,
              recentMajorSurgery: false,
              recentGIGUBleeding: false,
              recentArterialPuncture: false,
              recentLumbarPuncture: false,
              pregnancy: false,
              seizureAtOnset: false,
              lowPlatelets: false,
              recentMI: false,
              acutePericarditis: false,
              elevatedAPTT: false,
              warfarinElevatedINR: false,
              recentHeparin: false,
              lowGlucose: false,
              highGlucose: false,
              recentDOAC: false,
              unrupturedAneurysm10mm: false,
              cerebralMicrobleeds: false,
              lecanemab: false
            },
            tnkContraindicationReviewed: false,
            tnkContraindicationReviewTime: '',
            decisionLog: [],
            // Phase 2: Guided Clinical Pathway fields
            ichBPManaged: false,
            ichReversalInitiated: false,
            ichSeizureProphylaxis: false,
            ichNeurosurgeryConsulted: false,
            // Phase 4: SAH fields
            sahGrade: '',
            sahGradeScale: '',
            sahBPManaged: false,
            sahNimodipine: false,
            sahEVDPlaced: false,
            sahAneurysmSecured: false,
            sahNeurosurgeryConsulted: false,
            sahSeizureProphylaxis: false,
            fisherGrade: '',
            sahAneurysmLocation: '',
            sahAneurysmSize: '',
            sahSecuringMethod: '',
            sahVasospasmMonitoring: {
              tcdOrdered: false,
              neuroChecksQ1h: false,
              sodiumMonitoring: false,
              dciSuspected: false,
              inducedHypertension: false,
              notes: ''
            },
            // ICH surgical assessment
            ichSurgicalCriteria: {
              cerebellarGt15mL: false,
              hydrocephalus: false,
              midlineShift: false,
              clinicalDeterioration: false,
              surgeryDiscussed: false,
              surgeryDecision: ''
            },
            // Stroke territory & phenotype
            strokeTerritory: '',
            strokePhenotype: '',
            // Family communication
            familyCommunication: {
              discussed: false,
              withWhom: '',
              topicsDiscussed: '',
              time: ''
            },
            // Symptom trajectory
            symptomTrajectory: '',
            symptomOnsetNIHSS: '',
            // Post-TNK monitoring
            postTNKMonitoring: {
              neuroChecksQ15min: false,
              bpChecksQ15min: false,
              bleedingWatch: false,
              repeatImagingOrdered: false,
              cardiacMonitoring: false
            },
            // ASPECTS regions
            aspectsRegions: { C: false, L: false, IC: false, I: false, M1: false, M2: false, M3: false, M4: false, M5: false, M6: false },
            pcAspectsRegions: { pons: false, midbrain: false, cerebL: false, cerebR: false, pcaL: false, pcaR: false, thalL: false, thalR: false },
            ticiScore: '',
            // Phase 4: CVT fields
            cvtAnticoagStarted: false,
            cvtAnticoagType: '',
            cvtIcpManaged: false,
            cvtSeizureManaged: false,
            cvtHematologyConsulted: false,
            // Phase 5: TIA Pathway fields
            tiaWorkup: {
              mriDwi: false,
              ctaHeadNeck: false,
              ecg12Lead: false,
              telemetry: false,
              echo: false,
              labsCbc: false,
              labsBmp: false,
              labsA1c: false,
              labsLipids: false,
              labsTsh: false
            },
            tiaWorkupReviewed: false,
            // Phase 5: Etiologic Classification (TOAST)
            toastClassification: '',
            // Phase 5: Cardiac Workup
            cardiacWorkup: {
              ecgComplete: false,
              telemetryOrdered: false,
              echoOrdered: false,
              extendedMonitoring: '',
              extendedMonitoringType: '',
              pfoEvaluation: '',
              pascalClassification: ''
            },
            // Phase 5: Cervical Artery Dissection
            dissectionPathway: {
              antithromboticStarted: false,
              antithromboticType: '',
              imagingFollowUp: '',
              vascularImagingDate: ''
            },
            // Phase 5: Screening Tools
            screeningTools: {
              phq2Score: '',
              phq2Positive: false,
              mocaScore: '',
              mocaReferral: false,
              stopBangScore: '',
              stopBangPositive: false,
              seizureRisk: ''
            },
            // Phase 5: Secondary Prevention Dashboard
            secondaryPrevention: {
              bpTarget: '',
              bpMeds: '',
              bpIntensiveCandidate: false,
              ldlCurrent: '',
              ldlTarget: '<70',
              statinDose: '',
              ezetimibeAdded: false,
              pcsk9Added: false,
              inclisiranConsidered: false,
              glp1ra: '',
              glp1raIndication: '',
              sglt2i: '',
              sglt2iIndication: '',
              colchicineConsidered: false,
              colchicineIndication: '',
              cyp2c19Tested: false,
              cyp2c19Result: '',
              diabetesManagement: '',
              smokingStatus: '',
              smokingCessationRx: '',
              exercisePlan: '',
              exerciseMinPerWeek: '',
              dietPlan: '',
              dietAdherence: '',
              antiplateletRegimen: '',
              daptDuration: '',
              followUpTimeline: ''
            },
            // ICH Anticoagulation Resumption
            ichAnticoagResumption: {
              ichLocation: '',
              caaFeatures: false,
              chadsVascScore: '',
              hasbledScore: '',
              timeSinceICH: '',
              decision: '',
              rationale: '',
              laaoConsidered: false
            },
            // Carotid Revascularization
            carotidManagement: {
              stenosisSide: '',
              stenosisDegree: '',
              symptomatic: false,
              intervention: '',
              medicalManagement: ''
            },
            // Etiology Workup Planner
            etiologyWorkup: {
              suggestedTests: [],
              completedTests: {},
              customNote: ''
            },
            // Consent Communication Kit
            consentKit: {
              evtConsentDiscussed: false,
              evtConsentType: '',
              evtConsentTime: '',
              transferConsentDiscussed: false,
              consentDocCopied: false
            },
            // ESUS / Cryptogenic Pathway
            esusWorkup: {
              cardiacMonitoringType: '',
              cardiacMonitoringDuration: '',
              afDetected: false,
              teePerformed: false,
              teeFindings: '',
              hypercoagWorkup: false,
              esusAntiplatelet: ''
            },
            // DOAC Timing (AF-related stroke)
            doacTiming: {
              strokeSeverity: '',
              hemorrhagicTransformation: false,
              htClassification: '',
              doacInitiationDay: '',
              doacAgent: ''
            },
            // Hemorrhagic Transformation
            hemorrhagicTransformation: {
              detected: false,
              classification: '',
              symptomatic: false,
              managementActions: '',
              antithromboticHeld: false,
              reimagingPlanned: false
            },
            // Post-TNK Angioedema
            angioedema: {
              detected: false,
              severity: '',
              aceInhibitorUse: false,
              stepsTaken: {},
              intubated: false,
              resolved: false,
              onsetTime: ''
            },
            // Dysphagia Screening
            dysphagiaScreening: {
              bedsideScreenPerformed: false,
              bedsideScreenResult: '',
              instrumentalAssessment: '',
              npoStatus: false,
              slpConsultOrdered: false
            },
            // Early Mobilization
            earlyMobilization: {
              timingDecision: '',
              mobilizationStarted: false,
              sessionFrequency: '',
              contraindications: ''
            },
            // VTE Prophylaxis
            vteProphylaxis: {
              ipcApplied: false,
              pharmacoProphylaxis: '',
              enoxaparinDose: '',
              postTpaTimerStarted: false,
              hematoStabilityConfirmed: false,
              antiXaMonitoring: false
            },
            // Fever Management
            feverManagement: {
              feverDetected: false,
              maxTemp: '',
              feverProtocolInitiated: false,
              bsasScore: '',
              infectionWorkupSent: false,
              escalationLevel: ''
            },
            // Osmotic Therapy
            osmoticTherapy: {
              agentUsed: '',
              indication: '',
              serumSodium: '',
              serumOsmolality: '',
              sodiumTarget: '',
              correctionRate: '',
              baselineNa: '',
              baselineNaTime: '',
              repeatNa: '',
              repeatNaTime: '',
              weight: '',
              mannitolOsmGap: ''
            },
            // Nutritional Support
            nutritionalSupport: {
              feedingRoute: '',
              ngPlacementDay: '',
              pegConsiderationDay: '',
              nutritionConsultOrdered: false,
              caloricTarget: ''
            },
            // Drug Interaction Alerts
            drugInteractions: {
              aedDoacInteraction: false,
              aedType: '',
              statinInteraction: false,
              statinInteractionDrug: '',
              doacDoseAppropriate: '',
              doacDoseReductionCriteria: ''
            },
            // Anticoag Bridging (PAUSE Protocol)
            anticoagBridging: {
              bridgingNeeded: false,
              doacType: '',
              crCl: '',
              procedureRisk: '',
              holdDays: '',
              resumeDay: '',
              warfarinBridgeIndication: ''
            },
            // Young Adult Workup (age <50)
            youngAdultWorkup: {
              tier1Complete: false,
              tier1Items: { ctaMra: false, tteBubble: false, ecg: false, telemetry: false, drugScreen: false, basicLabs: false },
              tier2Complete: false,
              tier2Items: { tee: false, extendedMonitoring: false, aplPanel: false },
              tier3Items: { rcvsWorkup: false, thrombophilia: false, fabry: false, cadasil: false, vasculitis: false }
            },
            // Structured mRS Assessment
            mrsAssessment: {
              discharge: '',
              day30: '',
              day90: '',
              month6: '',
              month12: ''
            },
            // Driving Restrictions
            drivingRestrictions: {
              counselingProvided: false,
              restrictionDuration: '',
              drivingEvalReferral: false,
              commercialDriver: false,
              residualDeficits: ''
            },
            // Return to Work
            returnToWork: {
              workingAge: false,
              priorOccupation: '',
              rtBarriers: [],
              vocationalRehabReferral: false,
              expectedTimeline: '',
              phasedReturnPlan: false
            },
            // Sexual Activity Counseling
            sexualHealthCounseling: {
              discussed: false,
              clearanceGiven: false,
              medicationReview: false,
              concerns: ''
            },
            // Air Travel
            airTravelRestrictions: {
              counselingProvided: false,
              restrictionDuration: '',
              supplementalO2Needed: false
            },
            // Spasticity
            spasticity: {
              screenPerformed: false,
              ashworthScore: '',
              location: '',
              treatment: '',
              botoxReferral: false
            },
            // Central Post-Stroke Pain
            centralPain: {
              screenPerformed: false,
              painPresent: false,
              painType: '',
              treatment: ''
            },
            // Post-Stroke Fatigue
            fatigue: {
              screenPerformed: false,
              fatiguePresent: false,
              severity: '',
              management: ''
            },
            // Alcohol / Substance Screening
            substanceScreening: {
              alcoholAuditC: '',
              alcoholCounseling: false,
              substanceUseScreen: false,
              substancesIdentified: ''
            },
            // Hormonal Risk Assessment
            hormonalRisk: {
              combinedOCPUse: false,
              hrtUse: false,
              migraineWithAura: false,
              counselingProvided: false
            },
            // CVT Anticoag Phases
            cvtAnticoag: {
              acutePhase: '',
              transitionAgent: '',
              duration: '',
              apsStatus: '',
              etiologyProvoked: false
            },
            // Palliative Care
            palliativeCare: {
              screeningTriggered: false,
              consultOrdered: false,
              goalsOfCareDiscussed: false,
              goalsOfCareOutcome: '',
              dnrPostponementAlert: false
            },
            // Falls Risk
            fallsRisk: {
              screenPerformed: false,
              highRisk: false,
              preventionPlanInitiated: false,
              balanceProgramReferral: false
            },
            // Phase 5: Special Populations
            pregnancyStroke: false,
            activeCancer: false,
            sickleCellDisease: false,
            infectiveEndocarditis: false,
            decompressiveCraniectomy: {
              considered: false,
              age: '',
              nihssThreshold: false,
              territorySize: '',
              timing: ''
            },
            rehabReferral: {
              pt: false,
              ot: false,
              slp: false,
              neuropsych: false,
              socialWork: false,
              vocationalRehab: false,
              intensityPrescribed: false,
              aphasiaReferral30d: false,
              cognitiveScreenDischarge: false,
              cognitiveScreen3mo: false,
              neuropsychReferral: false,
              caregiver_strokeSigns: false,
              caregiver_medicationAdmin: false,
              caregiver_bpMonitoring: false,
              caregiver_safeTransfers: false,
              caregiver_dysphagiaDiet: false,
              caregiver_emergencyPlan: false
            },
            // Phase 4: Discharge Checklist
            dischargeChecklist: {
              antiplateletOrAnticoag: false,
              statinPrescribed: false,
              bpMedOptimized: false,
              diabetesManaged: false,
              smokingCessation: false,
              dietCounseling: false,
              exerciseCounseling: false,
              followUpNeurology: false,
              followUpNeurologyTimeframe: '',
              followUpPCP: false,
              followUpPCPTimeframe: '',
              followUpCardiology: false,
              rehabilitationOrdered: false,
              rehabilitationType: '',
              patientEducation: false,
              drivingRestrictions: false,
              swallowScreened: false,
              swallowScreenResult: '',
              dvtProphylaxis: false,
              dvtProphylaxisType: '',
              imagingFollowUp: '',
              repeatCT24h: false,
              mriOrdered: false
            },
            dischargeChecklistReviewed: false,
            dischargeNIHSS: '',
            // Inline calculator state
            ichVolumeCalc: { lengthCm: '', widthCm: '', slicesCm: '' },
            andexanetCalc: { doacType: '', lastDoseHours: '', doacDoseMg: '' },
            crclCalc: { age: '', weight: '', sex: 'M', cr: '' },
            enoxCalc: { weightKg: '', crCl: '' }
          });

          // Load saved data from localStorage with validation
          const loadFromStorage = (key, defaultValue) => {
            try {
              const saved = getKey(key, undefined);
              if (saved === undefined || saved === null) return defaultValue;

              // Validate that arrays are actually arrays (fix for completedSteps issue)
              if (Array.isArray(defaultValue) && !Array.isArray(saved)) {
                console.warn(`Invalid data type for ${key}, expected array. Resetting to default.`);
                return defaultValue;
              }

              return saved;
            } catch (e) {
              console.warn(`Error loading ${key} from localStorage:`, e);
              return defaultValue;
            }
          };

          // PHI Protection - shift handoff data expires after 24 hours
          const SHIFT_DATA_TTL_MS = 24 * 60 * 60 * 1000;

          const loadShiftData = (key, defaultValue) => {
            try {
              const item = getKey(key, null);
              if (!item) return defaultValue;
              // Enforce TTL — expired data should not be returned
              if (item && typeof item === 'object' && item.expiresAt) {
                if (Date.now() > item.expiresAt) {
                  try { localStorage.removeItem(STORAGE_PREFIX + key); } catch (_) {}
                  return defaultValue;
                }
                return item.data !== undefined ? item.data : defaultValue;
              }
              return item;
            } catch (e) {
              console.warn(`Error loading ${key}:`, e);
              return defaultValue;
            }
          };

          const saveShiftData = (key, value) => {
            try {
              setKey(key, { data: value, expiresAt: Date.now() + SHIFT_DATA_TTL_MS });
            } catch (e) {
              console.warn(`Error saving ${key}:`, e);
            }
          };

          const [appData, setAppData] = useState(() => INITIAL_APP_DATA);
          const settings = appData.settings || getDefaultSettings();
          const userPersona = settings.workflowPersona === 'trainee' ? 'trainee' : 'senior';
          const isTraineeMode = userPersona === 'trainee';

          const updateAppData = (updater) => {
            setAppData((prev) => {
              const next = typeof updater === 'function' ? updater(prev) : updater;
              return mergeAppData(getDefaultAppData(), next);
            });
          };

          const initialActiveTab = (() => {
            const storedTab = appData.uiState.lastActiveTab || 'encounter';
            if (LEGACY_MANAGEMENT_TABS[storedTab]) return 'management';
            if (storedTab === 'management' || storedTab === 'trials') return 'library';
            return storedTab;
          })();
          const initialManagementSubTab = (() => {
            const storedSubTab = normalizeManagementSubTab(appData.uiState.lastManagementSubTab);
            if (storedSubTab) return storedSubTab;
            const legacySubTab = LEGACY_MANAGEMENT_TABS[appData.uiState.lastActiveTab];
            return legacySubTab || 'ich';
          })();
          const initialLibrarySection = (() => {
            const stored = String(appData.uiState.lastLibrarySection || '').toLowerCase();
            if (LIBRARY_SECTIONS.includes(stored)) return stored;
            return appData.uiState.lastActiveTab === 'trials' ? 'trials' : 'management';
          })();

          const [activeTab, setActiveTab] = useState(initialActiveTab);
          const [librarySection, setLibrarySection] = useState(initialLibrarySection);
          const [routeReady, setRouteReady] = useState(false);
          const [notice, setNotice] = useState(null);
          const [clearUndo, setClearUndo] = useState(null);
          const [storageExpired, setStorageExpired] = useState(INITIAL_STORAGE_EXPIRED);
          // actionsOpen removed — handled by settings menu
          const [encounterPhase, setEncounterPhase] = useState('phase-triage');
          const [clinicalContext, setClinicalContext] = useState(() => {
            const consultMode = loadFromStorage('consultationType', settings.defaultConsultationType || 'telephone');
            return consultMode === 'videoTelestroke' ? 'acute' : 'phone';
          });
          const [noteTemplate, setNoteTemplate] = useState(loadFromStorage('noteTemplate', 'consult'));
          const [calcDrawerOpen, setCalcDrawerOpen] = useState(false);
          const [settingsMenuOpen, setSettingsMenuOpen] = useState(false);
          // Phase 2: Guided Clinical Pathway UI state
          const [pathwayCollapsed, setPathwayCollapsed] = useState(true);
          const [guidelineRecsExpanded, setGuidelineRecsExpanded] = useState(false);
          const [appConfig, setAppConfig] = useState({ institutionLinks: [], ttlHoursOverride: null });
          const [configLoaded, setConfigLoaded] = useState(false);
          const [ttlHours, setTtlHours] = useState(settings.ttlHoursOverride || DEFAULT_TTL_HOURS);

          const [patientData, setPatientData] = useState(loadFromStorage('patientData', {}));
          const [nihssScore, setNihssScore] = useState(loadFromStorage('nihssScore', 0));
          const [aspectsScore, setAspectsScore] = useState(loadFromStorage('aspectsScore', 10));

          const [searchQuery, setSearchQuery] = useState('');
          const [copiedText, setCopiedText] = useState('');
          const [isMounted, setIsMounted] = useState(false);
          const [editableTemplate, setEditableTemplate] = useState(loadFromStorage('telestrokeTemplate', defaultTelestrokeTemplate));

          // Time tracking
          const [currentTime, setCurrentTime] = useState(new Date());
          const [lkwTime, setLkwTime] = useState(() => {
            const storedLkwTime = loadFromStorage('lkwTime', null);
            if (storedLkwTime) {
              const parsed = new Date(storedLkwTime);
              if (!Number.isNaN(parsed.getTime())) return parsed;
            }
            return new Date();
          });

          // Thrombolysis window alert state
          const [alertsMuted, setAlertsMuted] = useState(getKey('thrombolysisAlertsMuted', false) === true);
          const [lastAlertPlayed, setLastAlertPlayed] = useState(null);
          const [alertFlashing, setAlertFlashing] = useState(false);
          const [elapsedSeconds, setElapsedSeconds] = useState(0);

          // Save status
          const [saveStatus, setSaveStatus] = useState('saved');
          const [lastSaved, setLastSaved] = useState(null);

          // Critical alerts state
          const [criticalAlerts, setCriticalAlerts] = useState([]);

          // Search
          const [searchResults, setSearchResults] = useState([]);
          const [searchOpen, setSearchOpen] = useState(false);
          const [searchContext, setSearchContext] = useState('header');
          const [searchActiveIndex, setSearchActiveIndex] = useState(-1);
          const [evidenceFilter, setEvidenceFilter] = useState('');
          const [guidelineLibraryQuery, setGuidelineLibraryQuery] = useState('');
          const [guidelineLibraryGuideline, setGuidelineLibraryGuideline] = useState('');
          const [guidelineLibrarySection, setGuidelineLibrarySection] = useState('');
          const [guidelineLibraryClass, setGuidelineLibraryClass] = useState('');
          const [showKeyboardHelp, setShowKeyboardHelp] = useState(false);
          const [deidWarnings, setDeidWarnings] = useState({});

          // Workflow tracking
          const [currentStep, setCurrentStep] = useState(loadFromStorage('currentStep', 0));
          const [completedSteps, setCompletedSteps] = useState(loadFromStorage('completedSteps', []));

          // ============================================
          // SHIFT TRACKING: Multi-patient management
          // ============================================
          // Each patient in shift has: id, summary, timestamp, formState snapshot
          const [shiftPatients, setShiftPatients] = useState(loadFromStorage('shiftPatients', []));
          const [currentPatientId, setCurrentPatientId] = useState(loadFromStorage('currentPatientId', null));


          // Collapsible Timer Sidebar state (default: expanded on desktop, collapsed on mobile)
          const [timerSidebarCollapsed, setTimerSidebarCollapsed] = useState(() => {
            const saved = getKey('timerSidebarCollapsed', null);
            if (saved !== null && saved !== undefined) return saved === true;
            return window.innerWidth < 1024; // collapsed by default on mobile/tablet
          });

          // ============================================
          // CONSULTATION TYPE: Telephone, Video Telestroke
          // ============================================
          const [consultationType, setConsultationType] = useState(loadFromStorage('consultationType', settings.defaultConsultationType || 'telephone'));
          useEffect(() => {
            const nextContext = consultationType === 'videoTelestroke' ? 'acute' : 'phone';
            setClinicalContext((prev) => (prev === nextContext ? prev : nextContext));
          }, [consultationType]);

          const [managementSubTab, setManagementSubTab] = useState(initialManagementSubTab);
          // Management flags removed — all sections now render unconditionally

          // Toast notification system
          const [toasts, setToasts] = useState([]);
          const addToast = React.useCallback((message, type = 'info', duration) => {
            if (duration === undefined) duration = type === 'error' ? 6000 : 3000;
            const id = ++toastIdCounter;
            setToasts(prev => [...prev.slice(-4), { id, message, type }]);
            if (duration > 0) {
              setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), duration);
            }
            return id;
          }, []);
          const removeToast = React.useCallback((id) => {
            setToasts(prev => prev.filter(t => t.id !== id));
          }, []);

          // Confirmation modal state (replaces confirm/prompt)
          const [confirmConfig, setConfirmConfig] = useState(null);
          const alertFlashTimeoutRef = useRef(null);
          const lastAlertPlayedRef = useRef(null);
          const confirmResolveRef = useRef(null);
          const showConfirm = React.useCallback((config) => {
            return new Promise((resolve) => {
              confirmResolveRef.current = resolve;
              setConfirmConfig(config);
            });
          }, []);
          const handleConfirmClose = React.useCallback((result) => {
            if (confirmResolveRef.current) {
              confirmResolveRef.current(result);
              confirmResolveRef.current = null;
            }
            setConfirmConfig(null);
          }, []);

          // Focus mode
          const [focusMode, setFocusMode] = useState(false);
          const [weightUnit, setWeightUnit] = useState(loadFromStorage('weightUnit', 'kg')); // 'kg' or 'lbs' — stored value is always kg

          // Online/offline status
          const [isOnline, setIsOnline] = useState(typeof navigator !== 'undefined' ? navigator.onLine : true);

          // Encounter history
          const [encounterHistory, setEncounterHistory] = useState(() => {
            try {
              const stored = localStorage.getItem('strokeApp:encounterHistory');
              return stored ? JSON.parse(stored) : [];
            } catch { return []; }
          });

          // Changelog modal
          const [showChangelog, setShowChangelog] = useState(false);


          const [selectedPackId, setSelectedPackId] = useState(appData.encounter.clipboardPacks?.[0]?.id || 'telestroke-consult');


          const shiftBoards = appData.shiftBoards || [];
          const clipboardPacks = appData.encounter.clipboardPacks || getDefaultClipboardPacks();
          const activeShiftBoardId = appData.uiState.lastShiftBoardId || (shiftBoards[0] ? shiftBoards[0].id : null);
          const activeShiftBoard = shiftBoards.find((board) => board.id === activeShiftBoardId) || null;

          // Ref and state for Part 6 (Treatment Decision) scroll visibility
          const treatmentDecisionRef = useRef(null);
          const backupImportRef = useRef(null);
          const searchContainerRef = useRef(null);
          const generateNoteRef = useRef(null);
          const copyToClipboardRef = useRef(null);
          const navigateToRef = useRef(null);
          const exportToPDFRef = useRef(null);
          // mermaidInitializedRef removed — no more mermaid diagrams
          const decisionStateRef = useRef({
            tnkRecommended: false,
            evtRecommended: false,
            transferAccepted: false,
            tnkContraindicationReviewed: false,
            tnkConsentDiscussed: false,
            tnkAdminTime: ''
          });

          const [gcsItems, setGcsItems] = useState(loadFromStorage('gcsItems', {
            eye: '',
            verbal: '',
            motor: ''
          }));
          const [mrsScore, setMrsScore] = useState(loadFromStorage('mrsScore', ''));
          const [ichScoreItems, setIchScoreItems] = useState(loadFromStorage('ichScoreItems', {
            gcs: '', // Changed to single field for mutual exclusivity
            age80: false,
            volume30: false,
            ivh: false,
            infratentorial: false,
            lobar: false, // FUNC Score: lobar vs deep supratentorial
            preCogImpairment: false // FUNC Score: pre-ICH cognitive impairment
          }));
          const [ichVolumeParams, setIchVolumeParams] = useState(loadFromStorage('ichVolumeParams', { a: '', b: '', thicknessMm: '', numSlices: '' }));

          useEffect(() => {
            const { a, b, thicknessMm, numSlices } = ichVolumeParams;
            if (a && b && thicknessMm && numSlices) {
              const aV = parseFloat(a), bV = parseFloat(b), tV = parseFloat(thicknessMm), nV = parseFloat(numSlices);
              if ([aV, bV, tV, nV].some(v => isNaN(v) || v <= 0)) return;
              const cCm = (tV / 10) * nV;
              const vol = (aV * bV * cCm) / 2;
              if (!isNaN(vol) && vol > 0) {
                setIchScoreItems(prev => {
                  const isHigh = vol >= 30;
                  if (prev.volume30 !== isHigh) {
                    return { ...prev, volume30: isHigh };
                  }
                  return prev;
                });
              }
            }
          }, [ichVolumeParams]);
          const ichVolumeEstimate = useMemo(() => {
            const { a, b, thicknessMm, numSlices } = ichVolumeParams;
            const aVal = parseFloat(a);
            const bVal = parseFloat(b);
            const tVal = parseFloat(thicknessMm);
            const nVal = parseFloat(numSlices);
            if ([aVal, bVal, tVal, nVal].some(val => Number.isNaN(val) || val <= 0)) return null;
            const cCm = (tVal / 10) * nVal;
            const vol = (aVal * bVal * cCm) / 2;
            if (Number.isNaN(vol) || vol <= 0) return null;
            return {
              value: vol,
              display: vol.toFixed(1),
              exceeds30: vol >= 30
            };
          }, [ichVolumeParams]);
          const [abcd2Items, setAbcd2Items] = useState(loadFromStorage('abcd2Items', {
            age60: false,
            bp: false,
            unilateralWeakness: false,
            speechDisturbance: false,
            duration: '', // Changed to single field for mutual exclusivity
            diabetes: false
          }));
          const [chads2vascItems, setChads2vascItems] = useState(loadFromStorage('chads2vascItems', {
            chf: false,
            hypertension: false,
            age75: false,
            diabetes: false,
            strokeTia: false,
            vascular: false,
            age65: false,
            female: false
          }));
          const [ropeItems, setRopeItems] = useState(loadFromStorage('ropeItems', {
            noHypertension: false,
            noDiabetes: false,
            noStrokeTia: false,
            nonsmoker: false,
            cortical: false,
            age: ''
          }));
          const [huntHessGrade, setHuntHessGrade] = useState(loadFromStorage('huntHessGrade', ''));
          const [wfnsGrade, setWfnsGrade] = useState(loadFromStorage('wfnsGrade', ''));
          const [hasbledItems, setHasbledItems] = useState(loadFromStorage('hasbledItems', {
            hypertension: false,
            renalDisease: false,
            liverDisease: false,
            stroke: false,
            bleeding: false,
            labileINR: false,
            elderly: false,
            drugs: false,
            alcohol: false
          }));
          const [rcvs2Items, setRcvs2Items] = useState(loadFromStorage('rcvs2Items', {
            recurrentTCH: false,
            carotidInvolvement: false,
            vasoconstrictiveTrigger: false,
            female: false,
            sah: false
          }));
          const [phasesItems, setPhasesItems] = useState(loadFromStorage('phasesItems', {
            population: 'north_american',
            hypertension: false,
            age70: false,
            size: '',
            earlierSAH: false,
            site: 'ica'
          }));
          const [trialsCategory, setTrialsCategory] = useState('ischemic');
          const [trialsRecruitingOnly, setTrialsRecruitingOnly] = useState(false);

          const [strokeCodeForm, setStrokeCodeForm] = useState(loadFromStorage('strokeCodeForm', getDefaultStrokeCodeForm()));
          const [aspectsRegionState, setAspectsRegionState] = useState(loadFromStorage('aspectsRegionState', getDefaultAspectsRegionState()));

          // PC-ASPECTS regions state
          const [pcAspectsRegions, setPcAspectsRegions] = useState(loadFromStorage('pcAspectsRegions', getDefaultPcAspectsRegions()));

          // Telestroke Documentation State — deep merge saved data with defaults
          // Ensures new nested objects (wakeUpStrokeWorkflow, osmoticTherapy, etc.) are always present
          const [telestrokeNote, setTelestrokeNote] = useState(() => {
            const saved = loadFromStorage('telestrokeNote', null);
            if (!saved) return getDefaultTelestrokeNote();
            const defaults = getDefaultTelestrokeNote();
            const merged = { ...defaults };
            for (const key of Object.keys(saved)) {
              if (saved[key] !== undefined && saved[key] !== null) {
                if (typeof defaults[key] === 'object' && defaults[key] !== null && !Array.isArray(defaults[key])
                    && typeof saved[key] === 'object' && !Array.isArray(saved[key])) {
                  merged[key] = { ...defaults[key], ...saved[key] };
                  // Two-level deep merge: restore default sub-objects (e.g. wakeUpStrokeWorkflow.dwi)
                  for (const subKey of Object.keys(defaults[key])) {
                    if (typeof defaults[key][subKey] === 'object' && defaults[key][subKey] !== null && !Array.isArray(defaults[key][subKey])
                        && typeof merged[key][subKey] === 'object' && merged[key][subKey] !== null && !Array.isArray(merged[key][subKey])) {
                      merged[key][subKey] = { ...defaults[key][subKey], ...merged[key][subKey] };
                    } else if (merged[key][subKey] === undefined || merged[key][subKey] === null) {
                      merged[key][subKey] = defaults[key][subKey];
                    }
                  }
                } else {
                  merged[key] = saved[key];
                }
              }
            }
            return merged;
          });

          const [autoSyncCalculators, setAutoSyncCalculators] = useState(loadFromStorage('autoSyncCalculators', true));
          const [evtDecisionInputs, setEvtDecisionInputs] = useState(loadFromStorage('evtDecisionInputs', {
            population: 'adult',
            occlusion: 'lvo',
            timeWindow: 'auto',
            aspects: '6-10',
            mrs: '0-1',
            nihss: '',
            pcAspects: '>=6'
          }));
          const [doacProtocol, setDoacProtocol] = useState(loadFromStorage('doacProtocol', 'catalyst'));
          const [nursingFlowsheetChecks, setNursingFlowsheetChecks] = useState({});
          const [protocolModal, setProtocolModal] = useState(null);

          const lkwDateForWindow = lkwTime
            ? `${lkwTime.getFullYear()}-${String(lkwTime.getMonth() + 1).padStart(2, '0')}-${String(lkwTime.getDate()).padStart(2, '0')}`
            : telestrokeNote.lkwDate;
          const lkwTimeForWindow = lkwTime
            ? lkwTime.toTimeString().slice(0, 5)
            : telestrokeNote.lkwTime;
          const strokeWindow = useStrokeWindow({
            lkwDate: lkwDateForWindow,
            lkwTime: lkwTimeForWindow,
            lkwUnknown: telestrokeNote.lkwUnknown,
            discoveryDate: telestrokeNote.discoveryDate,
            discoveryTime: telestrokeNote.discoveryTime,
            now: currentTime
          });

          const patientContextValue = useMemo(() => ({
            age: telestrokeNote.age,
            sex: telestrokeNote.sex,
            weight: telestrokeNote.weight,
            height: telestrokeNote.height,
            creatinine: telestrokeNote.creatinine,
            diagnosis: telestrokeNote.diagnosis,
            diagnosisCategory: telestrokeNote.diagnosisCategory,
            nihss: telestrokeNote.nihss || nihssScore,
            telestrokeNote,
            setTelestrokeNote
          }), [telestrokeNote, nihssScore]);

          const calculatorDiagnosisKey = useMemo(() => {
            if (telestrokeNote.diagnosisCategory) return telestrokeNote.diagnosisCategory;
            const diag = (telestrokeNote.diagnosis || '').toLowerCase();
            if (diag.includes('ich') || diag.includes('hemorrhage')) return 'ich';
            if (diag.includes('sah') || diag.includes('subarachnoid')) return 'sah';
            if (diag.includes('tia')) return 'tia';
            if (diag.includes('ischemic')) return 'ischemic';
            return 'other';
          }, [telestrokeNote.diagnosisCategory, telestrokeNote.diagnosis]);

          const calculatorPriorityMap = {
            ich: ['ich-score', 'gcs', 'mrs', 'hasbled', 'crcl'],
            ischemic: ['abcd2', 'mrs', 'chads2vasc', 'hasbled', 'rope', 'crcl'],
            sah: ['hunt-hess', 'gcs', 'crcl'],
            tia: ['abcd2', 'chads2vasc', 'hasbled', 'crcl'],
            other: []
          };
          const calculatorLabelMap = {
            'gcs': 'GCS',
            'ich-score': 'ICH Score',
            'mrs': 'mRS',
            'abcd2': 'ABCD²',
            'chads2vasc': 'CHA₂DS₂-VASc',
            'hasbled': 'HAS-BLED',
            'rope': 'ROPE',
            'hunt-hess': 'Hunt-Hess/WFNS',
            'rcvs2': 'RCVS²',
            'crcl': 'CrCl'
          };
          const calculatorPriorityList = calculatorPriorityMap[calculatorDiagnosisKey] || [];
          const getCalculatorOrder = (id, fallback = 0) => {
            const idx = calculatorPriorityList.indexOf(id);
            if (idx === -1) return fallback;
            return -1 * (calculatorPriorityList.length - idx);
          };

          const bpPhaseTargets = {
            'pre-tnk': { label: 'Pre-lysis', systolic: 185, diastolic: 110 },
            'post-tnk': { label: 'Post-TNK', systolic: 180, diastolic: 105 },
            'post-evt': { label: 'Post-EVT', systolic: 180, diastolic: 105 },
            'no-lytics': { label: 'No lytics/No EVT', systolic: 220, diastolic: 120 },
            'ich': { label: 'ICH (INTERACT3/AHA 2022)', systolic: 140, diastolic: 90 },
            'sah': { label: 'SAH (pre-securing, target <160)', systolic: 160, diastolic: 100 },
            'sah-secured': { label: 'SAH (post-securing)', systolic: 140, diastolic: 90 },
            'cvt': { label: 'CVT (permissive)', systolic: 220, diastolic: 110 },
            'cvt-hemorrhage': { label: 'CVT with hemorrhage', systolic: 140, diastolic: 90 },
            'pregnancy': { label: 'Pregnancy/Postpartum stroke', systolic: 160, diastolic: 110 },
            'preeclampsia': { label: 'Preeclampsia/Eclampsia', systolic: 140, diastolic: 90 }
          };
          const currentBpPhase = telestrokeNote.bpPhase || 'pre-tnk';
          const currentBpTarget = bpPhaseTargets[currentBpPhase] || bpPhaseTargets['pre-tnk'];
          const currentBpReading = parseBloodPressure(telestrokeNote.bpPostEVT || telestrokeNote.bpPreTNK || telestrokeNote.presentingBP);
          const bpWithinTarget = currentBpReading
            ? currentBpReading.systolic <= currentBpTarget.systolic && currentBpReading.diastolic <= currentBpTarget.diastolic
            : null;

          const protocolDetailMap = useMemo(() => ({
            PCC: {
              title: '4F-PCC (Kcentra)',
              dosing: 'PCC (Kcentra) weight-based: INR 1.3-3.9 → 25 IU/kg; INR 4-6 → 35 IU/kg; INR >6 → 50 IU/kg (max 5000 IU). INR <1.3: PCC likely not needed. Use PCC calculator for exact dose.',
              note: 'Give simultaneously with vitamin K 10 mg IV. Check PT/INR at 15-30 min, 6h, and 24h after PCC. If INR >1.5 at 15-30 min → consult hematology for additional PCC. If INR >1.5 at 24h → repeat vitamin K 10 mg IV over 30 min.'
            },
            PCC_DOAC: {
              title: '4F-PCC for DOAC Reversal',
              dosing: 'PCC (Kcentra) 2000 units IVPB. Consider ONLY if no contraindications.',
              note: 'For dabigatran: use only if idarucizumab unavailable. For rivaroxaban/apixaban: consider if Direct Xa Inhibitor screen elevated.'
            },
            VITK: {
              title: 'Vitamin K',
              dosing: '10 mg IV — give immediately for all warfarin patients.',
              note: 'Repeat 10 mg IV over 30 min if INR >1.5 at 24h post-PCC.'
            },
            IDA: {
              title: 'Idarucizumab (Praxbind)',
              dosing: '5 g IV total: two 2.5 g doses, ≤15 min apart, each infused over 5-10 min.',
              note: 'Specific reversal for dabigatran. If unavailable → consider PCC (Kcentra) 2000 units.'
            },
            FFP: {
              title: 'Fresh Frozen Plasma (FFP)',
              dosing: '4 units emergency-release FFP → check INR → if >1.5 give 4 more type-specific units → if still >1.5 consult hematology.',
              note: 'Use ONLY if PCC unavailable. FFP pathway is slower and less effective than PCC.'
            },
            CHARCOAL: {
              title: 'Activated Charcoal',
              dosing: 'Administer if DOAC ingestion <2 hours ago.',
              note: 'Most effective when given early. Use for dabigatran, rivaroxaban, or apixaban.'
            },
            CRYO: {
              title: 'Cryoprecipitate',
              dosing: '2 pools cryoprecipitate IV over 10-30 min (takes ~15-20 min to prepare).',
              note: 'For post-thrombolytic ICH. Give empirically if CT delayed >30 min and fibrinogen <200. Repeat hemorrhage panel after administration.'
            },
            TXA: {
              title: 'Tranexamic Acid (TXA)',
              dosing: '1 g IV over 10 min.',
              note: 'For post-thrombolytic ICH after cryoprecipitate. Give when intracranial blood confirmed on CT.'
            },
            METHYLPRED: {
              title: 'Methylprednisolone',
              dosing: '125 mg IV (for angioedema).',
              note: 'Part of angioedema management protocol. For contrast allergy premedication: 40 mg IV.'
            },
            DIPHEN: {
              title: 'Diphenhydramine',
              dosing: '50 mg IV.',
              note: 'For angioedema management and contrast allergy premedication.'
            },
            EPI: {
              title: 'Epinephrine',
              dosing: 'Epinephrine 0.3 mg IM (1 mg/mL solution) into anterolateral thigh. Nebulized for upper airway edema: 3-5 mL of 1:1000 (1 mg/mL) solution, or racemic epinephrine 0.5 mL of 2.25%.',
              note: 'For worsening angioedema. IM preferred over SC (faster absorption per AHA/WAO guidelines). Use if symptoms progress despite methylprednisolone and diphenhydramine.'
            },
            ICATIBANT: {
              title: 'Icatibant',
              dosing: '30 mg SC.',
              note: 'Bradykinin B2 receptor antagonist. Consider for ACE inhibitor-related angioedema refractory to initial treatment.'
            },
            BERINERT: {
              title: 'C1 Esterase Inhibitor (Berinert)',
              dosing: '20 IU/kg IV.',
              note: 'Plasma-derived C1 esterase inhibitor. For refractory orolingual angioedema associated with IV thrombolytic. Refer to local angioedema management protocol.'
            },
            HYDROCORT: {
              title: 'Hydrocortisone',
              dosing: '200 mg IV (OR Methylprednisolone 40 mg IV).',
              note: 'LVO contrast allergy protocol: Immediately prior to contrast, give Hydrocortisone 200mg IV OR Methylprednisolone 40mg + Diphenhydramine 50mg IV. Obtain verbal approval from Stroke attending, Emergency MD, AND Neuroradiology before proceeding. Excludes known contrast-related anaphylaxis (cardiovascular collapse). Document consent + approving physicians.'
            },
            FAMOTIDINE: {
              title: 'Famotidine',
              dosing: 'Famotidine 20 mg IV.',
              note: 'H2 blocker for angioedema management protocol. (Ranitidine withdrawn by FDA April 2020 due to NDMA.)'
            },
            PROT1: {
              title: 'Protamine (UFH)',
              classOfRec: 'Class IIa',
              dosing: '1 mg per 100 units UFH given in last 2-3h (max 50 mg/dose), slow IV over 10 min. Recheck anti-Xa; if >0.1 → additional 0.5 mg per 100 units (max cumulative 50 mg). (COR 2a/C)',
              note: 'Check anti-Xa level. If platelets <100K, send HIT antibodies and consult Hematology if positive.'
            },
            PROT2: {
              title: 'Protamine (LMWH)',
              classOfRec: 'Class IIb',
              dosing: 'Last dose <8h: Protamine 1 mg per 1 mg enoxaparin (max 50 mg). 8-12h: 0.5 mg per 1 mg enoxaparin (max 50 mg). >12h: likely unnecessary — check anti-Xa. (COR 2b/C)',
              note: 'Protamine only partially reverses LMWH (~60% anti-Xa neutralization). Second dose may be considered if ongoing bleeding.'
            },
            NICARDIPINE: {
              title: 'Nicardipine (Cardene)',
              dosing: 'Start 5 mg/hr IV. Titrate by 2.5 mg/hr every 5-15 min. Max 15 mg/hr.',
              note: 'Preferred continuous infusion for stroke BP management. Onset 5-15 min. Avoid in severe aortic stenosis or advanced heart failure.'
            },
            LABETALOL: {
              title: 'Labetalol',
              dosing: '10-20 mg IV over 1-2 min. May repeat every 10-20 min. Max 300 mg total. Infusion: 2-8 mg/min.',
              note: 'Combined alpha/beta blocker. Avoid in asthma/COPD, bradycardia, 2nd/3rd-degree heart block, decompensated HF. Hold if HR <60.'
            },
            LEVETIRACETAM: {
              title: 'Levetiracetam (Keppra)',
              dosing: '500-1000 mg IV/PO q12h. Load: 1000-2000 mg IV for acute seizure.',
              note: 'For SAH seizure prophylaxis (if cortical SAH, IVH, poor-grade HH 3-5, or seizure at onset). Limit prophylaxis to 3-7 days; avoid prolonged routine use. Renal adjust: CrCl <30 → reduce dose 50%.'
            },
            NIMODIPINE: {
              title: 'Nimodipine (Nymalize)',
              dosing: '60 mg PO/NG q4h x 21 days. Start within 96h of SAH onset.',
              note: 'Calcium channel blocker for SAH vasospasm prevention. Only proven agent to improve outcomes. If hypotension: reduce to 30 mg q2h (maintains daily dose while reducing peak levels). Do NOT give IV (risk of severe hypotension/cardiac arrest).'
            }
          }), []);

          const protocolDetailRef = useRef(protocolDetailMap);
          useEffect(() => {
            protocolDetailRef.current = protocolDetailMap;
          }, [protocolDetailMap]);

          // Online/offline detection
          useEffect(() => {
            const goOnline = () => setIsOnline(true);
            const goOffline = () => setIsOnline(false);
            window.addEventListener('online', goOnline);
            window.addEventListener('offline', goOffline);
            return () => {
              window.removeEventListener('online', goOnline);
              window.removeEventListener('offline', goOffline);
            };
          }, []);

          // Auto-route management sub-tab when diagnosis changes
          useEffect(() => {
            const cat = telestrokeNote.diagnosisCategory;
            if (cat && MANAGEMENT_SUBTABS.includes(cat)) {
              setManagementSubTab(cat);
            }
          }, [telestrokeNote.diagnosisCategory]);

          // Trials data
          const trialsData = {
            ischemic: {
                title: "Ischemic Stroke Studies",
                hasSubsections: true,
                subsections: {
                    acute: {
                        title: "Acute Trials",
                        trials: [
                            {
                                name: "SISTER Trial",
                                nct: "NCT05948566",
                                phase: "Phase 2",
                                status: "",
                                description: "TS23 (monoclonal antibody to α2-antiplasmin) for late thrombolysis in acute ischemic stroke patients presenting 4.5-24 hours from last known well",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Suspected anterior circulation acute ischemic stroke",
                                    "NIH Stroke Scale score ≥4 prior to randomization (participant must have a clearly disabling deficit if NIHSS is 4-5)",
                                    "Time from last known well: 4.5-24 hours",
                                    "Favorable baseline neuroimaging consisting of ALL of the following:",
                                    "• ASPECTS ≥6 on CT (or ASPECTS ≥7 on MRI)",
                                    "• Favorable perfusion imaging on CTP/MR-PWI consisting of ALL:",
                                    "  - Mismatch ratio of penumbra:core >1.2",
                                    "  - Mismatch volume >10 cc",
                                    "  - Ischemic core volume <70 cc",
                                    "Able to receive assigned study drug within 4.5 to 24 hours of stroke onset or last known well",
                                    "Informed consent obtained from participant or legally authorized representative",
                                    "Study drug administration encouraged within 90 minutes after qualifying perfusion image (allowed up to 120 minutes)"
                                ],
                                exclusion: [
                                    "Received endovascular treatment with clot engagement (patients with groin puncture but no clot engagement due to spontaneous distal migration are permitted)",
                                    "Received or planned to receive intravenous thrombolysis",
                                    "Pre-stroke modified Rankin score >2",
                                    "Previous treatment with TS23 or known previous allergy to antibody therapy",
                                    "Known pregnancy, breastfeeding, or plan to breastfeed within 3 months of receiving TS23",
                                    "Positive urine or serum pregnancy test for women of childbearing potential",
                                    "Known previous stroke in the past 90 days",
                                    "Known previous intracranial hemorrhage, intracranial neoplasm, subarachnoid hemorrhage, or arteriovenous malformation",
                                    "Known active diagnosis of intracranial neoplasm",
                                    "Clinical presentation suggestive of subarachnoid hemorrhage (even if initial CT scan was normal)",
                                    "Surgery or biopsy of parenchymal organ in the past 30 days",
                                    "Known trauma with internal injuries or persistent ulcerative wounds in the past 30 days",
                                    "Severe head trauma in the past 90 days",
                                    "Persistent systolic blood pressure >180mmHg or diastolic blood pressure >105mmHg despite best medical management",
                                    "Serious systemic hemorrhage in the past 30 days",
                                    "Hereditary or acquired hemorrhagic diathesis or coagulation factor deficiency",
                                    "Use of dual antiplatelet agents within 48 hours prior to stroke symptom onset",
                                    "International normalized ratio (INR) >1.7 or partial thromboplastin time (PTT) > 2x upper limit of normal",
                                    "Use of direct thrombin inhibitors or direct factor Xa inhibitors within past 48 hours unless aPTT, INR, platelet count, ecarin clotting time (ECT), thrombin time (TT), or appropriate factor Xa activity assays are normal",
                                    "Glucose <50 mg/dL or >400 mg/dL",
                                    "Platelets <100,000/µL",
                                    "Known severe renal failure with creatinine >3 mg/dL or glomerular filtration rate <30 mL/min",
                                    "Severe contrast allergy that cannot be managed medically",
                                    "Suspected cerebral vasculitis based on medical history and CTA/MRA",
                                    "Suspected intracranial dissection based on medical history and CTA/MRA",
                                    "Intracranial stenosis related to atherosclerosis proximal to intracranial thrombus",
                                    "Intracranial stent in place proximal to the intracranial occlusion",
                                    "Acute myocardial infarction in past 7 days",
                                    "Major surgery (requiring intubation or transfusion) in past 30 days",
                                    "Suspicion of aortic dissection on history, examination, or imaging",
                                    "Presumed septic embolus; suspicion of bacterial endocarditis",
                                    "Life expectancy <90 days",
                                    "Currently participating in another investigational drug or device study"
                                ]
                            },
                            {
                                name: "STEP-EVT Trial",
                                nct: "NCT06289985",
                                phase: "Adaptive Platform",
                                status: "",
                                description: "NIH StrokeNet adaptive platform trial optimizing endovascular therapy for mild stroke and medium/distal vessel occlusions",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Acute ischemic stroke due to large vessel occlusion (LVO) or medium vessel occlusion (MVO)",
                                    "Within 24 hours of last known well",
                                    "For Low NIHSS Domain:",
                                    "• NIHSS 0-5 with ICA or M1 occlusion",
                                    "• Disabling symptoms despite low NIHSS",
                                    "For Medium/Distal Vessel Occlusion Domain:",
                                    "• M2, M3, or M4 occlusion",
                                    "• A1, A2, or A3 occlusion",
                                    "• P1, P2, or P3 occlusion",
                                    "• Appropriate perfusion imaging criteria demonstrating salvageable tissue",
                                    "Ability to start EVT within appropriate time window",
                                    "Pre-stroke mRS ≤2 (able to live independently)",
                                    "Informed consent from patient or legally authorized representative"
                                ],
                                exclusion: [
                                    "Known pre-existing medical, neurological or psychiatric disease that would confound outcome evaluations",
                                    "Known serious, advanced, or terminal illness with life expectancy <6 months",
                                    "Unfavorable vascular anatomy limiting endovascular access to occluded artery",
                                    "Acute occlusions in multiple vascular territories",
                                    "Suspected septic embolus",
                                    "Suspected bacterial endocarditis",
                                    "Seizure at stroke onset with postictal residual impairments",
                                    "Contrast allergy precluding EVT that cannot be adequately pre-medicated",
                                    "Chronic total occlusion of target vessel",
                                    "Known intracranial dissection",
                                    "Known vasculitis",
                                    "Known moyamoya disease or syndrome",
                                    "Pregnancy or positive pregnancy test",
                                    "Currently breastfeeding",
                                    "Large core infarct (ASPECTS <3 or core volume >100cc depending on time window)",
                                    "Evidence of intracranial hemorrhage on baseline imaging",
                                    "Clinical suspicion of subarachnoid hemorrhage despite negative imaging",
                                    "Known bleeding diathesis or coagulopathy",
                                    "Platelet count <50,000/μL",
                                    "INR >3.0",
                                    "Blood glucose <50mg/dL",
                                    "Refractory hypertension (SBP >185 or DBP >110 despite treatment)",
                                    "Currently participating in another interventional clinical trial"
                                ]
                            },
                            {
                                name: "TESTED",
                                nct: "NCT05911568",
                                phase: "Comparative Effectiveness",
                                status: "",
                                description: "EVT vs medical therapy in LVO with pre-existing disability (mRS 3-4)",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Pre-stroke mRS 3-4 for at least 3 months prior to index stroke",
                                    "Large vessel occlusion:",
                                    "• ICA terminus",
                                    "• M1 segment of MCA",
                                    "• Dominant/co-dominant M2 segment",
                                    "Within 24 hours of last known well",
                                    "NIHSS ≥6",
                                    "ASPECTS ≥3 on non-contrast CT or ≥4 on MRI",
                                    "For 6-24 hour window: evidence of salvageable tissue on perfusion imaging",
                                    "Able to undergo groin puncture within time window",
                                    "Informed consent from patient or legally authorized representative"
                                ],
                                exclusion: [
                                    "Pre-stroke mRS 0-2 or mRS 5-6",
                                    "Life expectancy <6 months from non-stroke condition",
                                    "Pre-stroke disability deemed temporary or reversible",
                                    "Known pregnancy",
                                    "Evidence of intracranial hemorrhage",
                                    "Large established infarct (>1/3 MCA territory)",
                                    "Bilateral strokes",
                                    "Known vasculitis or moyamoya",
                                    "Intracranial tumor",
                                    "Currently participating in another stroke intervention trial",
                                    "Inability to follow up at 90 days"
                                ]
                            }
                        ]
                    },
                    inpatient: {
                        title: "Subacute Enrollment",
                        trials: [
                            {
                                name: "VERIFY Study",
                                nct: "NCT05338697",
                                phase: "Observational",
                                status: "",
                                description: "Early TMS/MRI/clinical measures to predict upper extremity motor recovery",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Acute ischemic stroke within 7 days of onset",
                                    "Upper extremity weakness (shoulder abduction and/or finger extension ≤4 on MRC scale)",
                                    "Able to provide informed consent or has LAR",
                                    "Able to participate in study assessments",
                                    "Expected to survive at least 90 days"
                                ],
                                exclusion: [
                                    "Contraindications to TMS:",
                                    "• Implanted electronic devices (pacemaker, cochlear implant, etc.)",
                                    "• Intracranial metal",
                                    "• History of seizures",
                                    "• Active psychiatric medication affecting cortical excitability",
                                    "Contraindications to MRI",
                                    "Unable to complete follow-up visits at 30 and 90 days",
                                    "Pre-stroke mRS >2",
                                    "Bilateral upper extremity weakness",
                                    "Previous stroke affecting motor function",
                                    "Other neurological conditions affecting motor function",
                                    "Pregnancy"
                                ]
                            },
                            {
                                name: "DISCOVERY Study",
                                nct: "NCT04916210",
                                phase: "Observational",
                                status: "",
                                description: "Cognitive trajectories and biomarkers after stroke (includes AIS/ICH/SAH)",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Admitted with one of the following:",
                                    "• Acute ischemic stroke",
                                    "• Intracerebral hemorrhage",
                                    "• Aneurysmal subarachnoid hemorrhage",
                                    "Radiographic confirmation of stroke diagnosis",
                                    "Baseline visit can be completed within 6 weeks of stroke",
                                    "Fluent in English or Spanish",
                                    "Has study partner who knows patient well (contact ≥1x/week)",
                                    "Able to provide informed consent or has LAR",
                                    "Expected to survive at least 1 year"
                                ],
                                exclusion: [
                                    "Pre-stroke dementia diagnosis",
                                    "Pre-stroke cognitive impairment interfering with daily activities",
                                    "Concurrent enrollment in interventional trial affecting cognition",
                                    "Unable to complete study protocol due to:",
                                    "• Severe aphasia preventing cognitive testing",
                                    "• Severe motor impairment preventing testing",
                                    "• Blindness or severe visual impairment",
                                    "• Deafness or severe hearing impairment",
                                    "Active substance abuse",
                                    "Severe psychiatric illness affecting participation",
                                    "Terminal illness with life expectancy <1 year",
                                    "Previous enrollment in DISCOVERY",
                                    "Planned move out of area within study period"
                                ]
                            },
                            {
                                name: "CLARITY Trial",
                                nct: "NCT07174414",
                                phase: "Phase 3",
                                status: "Not yet recruiting",
                                description: "Cilostazol for Prevention of Recurrent Stroke Trial: adding cilostazol vs placebo to single antiplatelet therapy after recent stroke/TIA",
                                inclusion: [
                                    "History of ischemic stroke OR transient ischemic attack (TIA) in the 180 days prior to enrollment",
                                    "Currently taking antiplatelet medication as standard of care"
                                ],
                                exclusion: [
                                    "History of spontaneous intracranial hemorrhage within the prior 2 years",
                                    "Moderate to severe heart failure",
                                    "Any condition that the investigator judges would pose significant hazard if investigational therapy is initiated"
                                ]
                            },
                            {
                                name: "INTERCEPT Trial",
                                nct: "NCT05723926",
                                phase: "Not Applicable",
                                status: "Recruiting",
                                description: "Carotid Implants for PreveNtion of STrokE ReCurrEnce from Large Vessel Occlusion in atrial fibrillation patients treated with oral anticoagulation",
                                inclusion: [
                                    "Age >55 years",
                                    "Ischemic stroke attributed to large vessel occlusion (LVO) with initial NIHSS >5",
                                    "Neurological and functional status (NIHSS and mRS), assessed 4 weeks to 20 months after index stroke, is stable and reflects residual index-stroke disability",
                                    "Residual disability from index stroke due to hemiparesis with mRS 2-4",
                                    "On oral anticoagulation for atrial fibrillation (DOAC or VKA) with at least one high-risk recurrent stroke criterion:",
                                    "• High-risk PFO by PASCAL",
                                    "• Spontaneous echocardiographic contrast in LAA",
                                    "• LAA peak flow velocity ≤20 cm/s",
                                    "• Spontaneous echocardiographic contrast in left atrium",
                                    "• Left atrial peak flow velocity ≤20 cm/s",
                                    "Signed informed consent"
                                ],
                                exclusion: [
                                    "History of intracerebral hemorrhage prior to randomization",
                                    "Severe disability before index stroke (mRS >4)",
                                    "Neurological or non-neurological condition leading to severe pre-index-stroke disability (mRS >4)",
                                    "Life expectancy <1 year",
                                    "High bleeding risk (HAS-BLED score >3)",
                                    "Other indication for oral anticoagulation apart from atrial fibrillation, including:",
                                    "• Venous thromboembolism",
                                    "• Prosthetic valve replacement",
                                    "• Severe mitral stenosis",
                                    "LAA anatomy unsuitable for closure device",
                                    "Prior surgeries/procedures involving left atrial appendage, including:",
                                    "• Prior surgical LAA closure or excision",
                                    "• Prior transcatheter closure of PFO/ASD",
                                    "Carotid artery stenosis >70% on the index-stroke side",
                                    "Carotid artery stent on the index-stroke side",
                                    "Existing indication for carotid intervention after randomization",
                                    "Ischemic stroke due to cervical artery dissection",
                                    "Inability to participate in follow-up program",
                                    "Current participation in another interventional trial"
                                ]
                            }
                        ]
                    },
                    imaging: {
                        title: "Imaging Studies",
                        trials: [
                            {
                                name: "ESUS Imaging Study",
                                nct: "NCT03820375",
                                phase: "Observational",
                                status: "",
                                description: "Cardiac and intracranial vessel wall MRI to reclassify ESUS",
                                inclusion: [
                                    "ESUS diagnosis",
                                    "Age ≥18 years",
                                    "Within 30 days of index stroke"
                                ],
                                exclusion: [
                                    "MRI contraindications",
                                    "Known stroke etiology"
                                ]
                            },
                            {
                                name: "MOCHA Imaging",
                                nct: "PMC8821414",
                                phase: "Observational",
                                status: "",
                                description: "Automated intracranial vessel-wall analysis for non-stenotic ICAD detection",
                                inclusion: [
                                    "Atherosclerotic lesions within the cerebrovascular tree clinically detected based on stenosis presence on clinical luminal imaging",
                                    "Presence of two or more atherosclerotic risk factors:",
                                    "• Age >50 years for men or >60 years for women",
                                    "• Hypertension",
                                    "• Diabetes mellitus", 
                                    "• Hyperlipidemia",
                                    "• Obesity",
                                    "• Smoking history",
                                    "No clinical evidence for other intracranial vasculopathies",
                                    "High-resolution MRI vessel wall imaging available"
                                ],
                                exclusion: [
                                    "Poor MRI image quality limiting vessel wall analysis",
                                    "Known intracranial vasculopathy (vasculitis, moyamoya, dissection)",
                                    "Unable to undergo MRI scanning",
                                    "Contraindications to MRI contrast if required for imaging protocol"
                                ]
                            }
                        ]
                    }
                }
            },
            ich: {
                title: "Intracerebral Hemorrhage Studies",
                hasSubsections: true,
                subsections: {
                    trials: {
                        title: "Trials",
                        trials: [
                            {
                                name: "SATURN Trial",
                                nct: "NCT03936361",
                                phase: "Phase 3",
                                status: "",
                                description: "Statins for intracerebral hemorrhage: Continue vs discontinue after lobar ICH",
                                inclusion: [
                                    "Age ≥50 years",
                                    "Spontaneous lobar intracerebral hemorrhage confirmed by CT or MRI",
                                    "Taking statin therapy at time of ICH onset for ≥1 month",
                                    "Modified Rankin Scale ≤4 at time of randomization",
                                    "Randomization within 7 days of ICH",
                                    "Clinical indication for statin therapy (dyslipidemia, atherosclerotic disease, diabetes)",
                                    "Able to provide informed consent or has LAR",
                                    "Expected to survive at least 6 months"
                                ],
                                exclusion: [
                                    "Deep (non-lobar) ICH location",
                                    "Secondary causes of ICH:",
                                    "• Trauma",
                                    "• Known brain tumor",
                                    "• Known vascular malformation or aneurysm",
                                    "• Hemorrhagic transformation of ischemic stroke",
                                    "• Known or suspected CNS vasculitis",
                                    "• Coagulopathy (INR >1.5, platelet count <100,000)",
                                    "• Drug-related (cocaine, amphetamines)",
                                    "Recent MI (<3 months) or unstable angina",
                                    "Coronary revascularization within past year",
                                    "Diabetes mellitus with prior MI or coronary revascularization",
                                    "Clear contraindication to statin discontinuation per treating physician",
                                    "Statin-related myopathy or rhabdomyolysis",
                                    "Severe hepatic impairment (ALT/AST >3x ULN)",
                                    "Life expectancy <6 months from non-ICH condition",
                                    "Unable to follow study protocol",
                                    "Pregnancy or breastfeeding",
                                    "Participation in another interventional trial"
                                ]
                            },
                            {
                                name: "ASPIRE Trial",
                                nct: "NCT03907046",
                                phase: "Phase 3",
                                status: "",
                                description: "Apixaban vs aspirin for stroke prevention after ICH in atrial fibrillation",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Spontaneous ICH confirmed by CT or MRI",
                                    "Non-valvular atrial fibrillation (paroxysmal, persistent, or permanent)",
                                    "CHA2DS2-VASc score ≥2",
                                    "Randomization 14-180 days after ICH",
                                    "Modified Rankin Scale ≤4 at randomization",
                                    "Able to take oral medications",
                                    "Informed consent obtained"
                                ],
                                exclusion: [
                                    "Clear indication for anticoagulation other than AF:",
                                    "• Mechanical heart valve",
                                    "• Recent DVT/PE requiring anticoagulation",
                                    "• Left ventricular thrombus",
                                    "Left atrial appendage closure device",
                                    "Valvular AF (moderate-severe mitral stenosis, mechanical valve)",
                                    "Secondary causes of ICH requiring specific treatment",
                                    "Creatinine ≥2.5mg/dL or CrCl <25mL/min",
                                    "Hepatic insufficiency (Child-Pugh B or C)",
                                    "Active bleeding or high bleeding risk condition",
                                    "Uncontrolled hypertension (BP ≥180/100 on multiple readings)",
                                    "Platelet count <100,000/μL",
                                    "Hemoglobin <8g/dL",
                                    "Need for dual antiplatelet therapy",
                                    "Contraindication to aspirin or apixaban",
                                    "Pregnancy or breastfeeding",
                                    "Life expectancy <1 year",
                                    "Unable to adhere to study protocol",
                                    "Participation in another antithrombotic trial"
                                ]
                            },
                            {
                                name: "cAPPricorn-1 Trial",
                                nct: "NCT06393712",
                                phase: "Phase 2",
                                status: "",
                                description: "Intrathecal ALN-APP (mivelsiran) for cerebral amyloid angiopathy",
                                inclusion: [
                                    "For sporadic CAA:",
                                    "• Age ≥50 years",
                                    "• Meets Boston Criteria v2.0 for probable CAA",
                                    "• Prior symptomatic lobar ICH ≥90 days ago",
                                    "For Dutch-type hereditary CAA:",
                                    "• Age ≥30 years",
                                    "• Confirmed E693Q APP variant",
                                    "• Prior ICH ≥90 days ago (if applicable)",
                                    "MRI evidence of CAA (microbleeds, superficial siderosis)",
                                    "Modified Rankin Scale ≤4",
                                    "Able to undergo lumbar punctures",
                                    "Adequate contraception if childbearing potential",
                                    "Informed consent obtained"
                                ],
                                exclusion: [
                                    "ICH within 90 days of screening",
                                    "Other cause of ICH identified",
                                    "ALT or AST >3× upper limit of normal",
                                    "eGFR <30 mL/min/1.73m²",
                                    "Platelet count <100,000/μL",
                                    "INR >1.5 or aPTT >1.5× ULN",
                                    "Contraindication to lumbar puncture",
                                    "Active CNS infection or inflammation",
                                    "Intrathecal pump or shunt",
                                    "Spinal cord compression or injury",
                                    "History of chemical or radiation meningitis",
                                    "Pregnancy or breastfeeding",
                                    "Life expectancy <2 years",
                                    "Chronic use of anticoagulation that cannot be stopped for LP",
                                    "Prior treatment with gene therapy or oligonucleotide therapy",
                                    "Participation in another interventional trial within 30 days"
                                ]
                            },
                            {
                                name: "MINUTE Trial",
                                nct: "NCT07260916",
                                phase: "Phase 2",
                                status: "Not yet recruiting",
                                description: "Multi-arm pilot trial of intravenous glibenclamide and blood-pressure treatment strategy in acute spontaneous intracerebral hemorrhage with CTA spot sign",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Acute spontaneous supratentorial intracerebral hemorrhage",
                                    "Presentation within 6 hours from symptom onset or last known well",
                                    "Baseline Glasgow Coma Scale >4",
                                    "Baseline NIHSS >6",
                                    "Baseline ICH volume 5-80 mL",
                                    "Pre-event modified Rankin Scale <3",
                                    "Persistent systolic blood pressure >140 mmHg despite at least one antihypertensive treatment",
                                    "Initial CTA demonstrates active contrast extravasation (spot sign)",
                                    "Willing and able to comply with protocol and follow-up"
                                ],
                                exclusion: [
                                    "Secondary cause of intracerebral hemorrhage, including:",
                                    "• Trauma",
                                    "• Aneurysm",
                                    "• Arteriovenous malformation",
                                    "• Dural arteriovenous fistula",
                                    "• Brain tumor",
                                    "• Hemorrhagic transformation of ischemic stroke",
                                    "Brainstem hemorrhage",
                                    "Large intraventricular hemorrhage as primary diagnosis",
                                    "Need for immediate surgery at presentation",
                                    "Baseline INR >1.4 or platelet count <100,000/mm3",
                                    "Use of anticoagulant medication within 48 hours",
                                    "Known allergy or hypersensitivity to glibenclamide or formulation excipients",
                                    "Severe renal impairment (eGFR <30 mL/min/1.73m²)",
                                    "Active severe hepatic disease",
                                    "Pregnancy or breastfeeding",
                                    "Participation in another interventional trial that may confound outcomes"
                                ]
                            }
                        ]
                    },
                    observational: {
                        title: "Observational",
                        trials: [
                            {
                                name: "MIRROR Registry",
                                nct: "NCT04494295",
                                phase: "Observational Registry",
                                status: "",
                                description: "Minimally invasive endoscopic ICH evacuation using Aurora Surgiscope System",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Spontaneous supratentorial ICH confirmed by CT",
                                    "ICH volume ≥20mL",
                                    "Surgery planned within 24 hours of last known well",
                                    "NIHSS >5",
                                    "Baseline mRS ≤2",
                                    "GCS ≥5",
                                    "Ability to undergo general anesthesia",
                                    "Informed consent from patient or LAR"
                                ],
                                exclusion: [
                                    "Secondary ICH due to:",
                                    "• Vascular lesion (AVM, aneurysm, dural fistula)",
                                    "• Brain tumor",
                                    "• Trauma",
                                    "• Hemorrhagic transformation of ischemic stroke",
                                    "• Moyamoya disease",
                                    "Fixed and dilated pupils",
                                    "Bilateral extensor posturing",
                                    "Infratentorial or brainstem ICH",
                                    "Intraventricular hemorrhage as primary pathology",
                                    "Life expectancy <6 months from other condition",
                                    "Uncorrectable coagulopathy (INR >1.4, platelets <100,000)",
                                    "Known pregnancy",
                                    "Prisoner or ward of state",
                                    "Participation in another interventional trial"
                                ]
                            },
                            {
                                name: "DISCOVERY Study (ICH Cohort)",
                                nct: "NCT04916210",
                                phase: "Observational",
                                status: "",
                                description: "Cognitive trajectories and biomarkers after ICH",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Admitted with intracerebral hemorrhage",
                                    "Radiographic confirmation of ICH",
                                    "Baseline visit within 6 weeks of ICH",
                                    "Fluent in English or Spanish",
                                    "Has study partner with regular contact",
                                    "Expected survival ≥1 year"
                                ],
                                exclusion: [
                                    "Pre-existing dementia",
                                    "Unable to complete cognitive testing",
                                    "Concurrent enrollment in cognitive intervention trial",
                                    "Active substance abuse",
                                    "Severe psychiatric illness",
                                    "Terminal illness with life expectancy <1 year"
                                ]
                            }
                        ]
                    }
                }
            },
            rehab: {
                title: "Rehabilitation",
                trials: [
                    {
                        name: "MR-PICS Study",
                        nct: "NCT06506279",
                        phase: "Phase 2",
                        status: "",
                        description: "Motor Recovery through Plasticity-Inducing Cortical Stimulation using CorTec Brain Interchange System for chronic stroke recovery",
                        inclusion: [
                            "Post-ischemic stroke patients with upper extremity deficit",
                            "Chronic stroke (minimum 6 months post-stroke)",
                            "Age 22-80 years",
                            "Able to participate meaningfully in rehabilitation (Upper Extremity Fugl-Meyer score 25-45)",
                            "Disability measured between 3-4 on modified Rankin Scale",
                            "Minimum 30% preservation of corticospinal tract integrity",
                            "Ability to provide informed consent",
                            "Medically stable and cleared for neurosurgical procedure",
                            "Willingness to comply with study protocol and follow-up visits",
                            "Access to caregiver support during recovery period"
                        ],
                        exclusion: [
                            "Seizure disorder or history of seizures",
                            "Contraindications to neurosurgical procedures",
                            "Contraindications to MRI scanning",
                            "Active psychiatric condition that would interfere with participation",
                            "Pregnancy or nursing",
                            "Life expectancy less than 2 years",
                            "Current participation in other interventional clinical trials",
                            "Inability to stop anti-platelet medications 7 days before and 3 days after surgery",
                            "Therapeutic anticoagulation that cannot be safely interrupted",
                            "Active substance abuse or dependence",
                            "Severe cognitive impairment preventing informed consent",
                            "Glenohumeral subluxation, adhesive capsulitis, or upper extremity contractures with associated pain that would limit participation",
                            "Implanted electronic devices incompatible with study procedures",
                            "Prior brain surgery or cranial implants",
                            "Hemorrhagic stroke (intracerebral hemorrhage excluded)",
                            "Bilateral stroke or multiple stroke locations"
                        ]
                    }
                ]
            },
            cadasil: {
                title: "CADASIL",
                trials: [
                    {
                        name: "CADASIL Registry",
                        nct: "NCT05567744",
                        phase: "Observational Registry",
                        status: "",
                        description: "Longitudinal registry for genetically confirmed or suspected CADASIL",
                        inclusion: [
                            "Confirmed NOTCH3 mutation or suspected CADASIL",
                            "Age ≥18 years"
                        ],
                        exclusion: [
                            "Unable to provide consent"
                        ]
                    }
                ]
            }
          };

          // =================================================================
          // ANTICOAGULANT INFORMATION - Drug-specific half-lives, thrombolysis
          // =================================================================
          // SHARED LABEL CONSTANTS
          const AP_LABELS = { 'dapt-21': 'DAPT x 21 days', 'asa-mono': 'ASA monotherapy', 'clopidogrel-mono': 'Clopidogrel monotherapy', 'asa-er-dipyridamole': 'ASA/ER-Dipyridamole', 'doac-af': 'DOAC for AF', 'anticoag-other': 'Anticoagulation (other)' };
          const AP_LABELS_SHORT = { 'dapt-21': 'DAPT x21d', 'asa-mono': 'ASA', 'clopidogrel-mono': 'Clopidogrel', 'asa-er-dipyridamole': 'ASA/ER-Dipyridamole', 'doac-af': 'DOAC (AF)', 'anticoag-other': 'Anticoagulation' };
          const TOAST_LABELS = { 'large-artery': 'Large Artery Atherosclerosis', 'cardioembolism': 'Cardioembolism', 'small-vessel': 'Small Vessel Occlusion (Lacunar)', 'other-determined': 'Other Determined Etiology', 'cryptogenic': 'Cryptogenic/ESUS' };

          // CALLING SITES - Unified list for both telephone and video consults
          // =================================================================
          // Calling sites — configure via Settings or enter manually per encounter
          const CALLING_SITES = [
            { group: 'Hub Sites', sites: ['Hub A', 'Hub B', 'Hub C'] },
            { group: 'Spoke Sites', sites: [
              'Spoke Site 1',
              'Spoke Site 2',
              'Spoke Site 3',
              'Spoke Site 4',
              'Spoke Site 5'
            ]}
          ];

          // =================================================================
          // ANTICOAGULANT_INFO - Drug-specific half-lives, monitoring
          // thresholds, and ICH reversal protocols
          // Sources: AHA/ASA Guidelines, NEJM, Stroke Journal
          // =================================================================
          const ANTICOAGULANT_INFO = {
            apixaban: {
              name: 'Apixaban (Eliquis)',
              class: 'Direct Factor Xa Inhibitor',
              halfLife: '8-12 hours',
              halfLifeNote: 'Prolonged in renal impairment',
              thrombolysisThreshold: '48 hours since last dose',
              thrombolysisNote: 'Consider anti-Xa level if <48h - thrombolysis may be given if anti-Xa <30 ng/mL',
              ichReversal: {
                primary: '4-Factor PCC (Kcentra) 2000 units IVPB (local protocol) or 50 IU/kg (max 5000 IU)',
                alternative: 'Activated PCC (FEIBA) 50 IU/kg if 4F-PCC unavailable',
                note: 'Suggested protocol: 4F-PCC 2000 units IV first-line. Andexanet alfa may not be available at all centers — check local formulary. AHA/ASA 2022 lists andexanet as Class IIa but PCC shows similar efficacy (Panos et al. Crit Care Med 2025). Discuss with Hematology if PCC ineffective.'
              },
              monitoring: 'Anti-Xa level (calibrated for apixaban)'
            },
            rivaroxaban: {
              name: 'Rivaroxaban (Xarelto)',
              class: 'Direct Factor Xa Inhibitor',
              halfLife: '5-9 hours (young), 11-13 hours (elderly)',
              halfLifeNote: 'Prolonged in renal impairment',
              thrombolysisThreshold: '48 hours since last dose',
              thrombolysisNote: 'Consider anti-Xa level if <48h - thrombolysis may be given if anti-Xa <30 ng/mL',
              ichReversal: {
                primary: '4-Factor PCC (Kcentra) 2000 units IVPB (local protocol) or 50 IU/kg (max 5000 IU)',
                alternative: 'Activated PCC (FEIBA) 50 IU/kg if 4F-PCC unavailable',
                note: 'Suggested protocol: 4F-PCC 2000 units IV first-line. Andexanet alfa may not be available at all centers — check local formulary. AHA/ASA 2022 lists andexanet as Class IIa but PCC shows similar efficacy (Panos et al. Crit Care Med 2025). Discuss with Hematology if PCC ineffective.'
              },
              monitoring: 'Anti-Xa level (calibrated for rivaroxaban)'
            },
            dabigatran: {
              name: 'Dabigatran (Pradaxa)',
              class: 'Direct Thrombin Inhibitor',
              halfLife: '12-17 hours',
              halfLifeNote: 'Significantly prolonged in renal impairment (up to 28h if CrCl <30)',
              thrombolysisThreshold: '48 hours since last dose',
              thrombolysisNote: 'Consider dTT or ECT if <48h - thrombolysis may be given if dTT/ECT normal or aPTT <40s',
              ichReversal: {
                primary: 'Idarucizumab (Praxbind) 5g IV (2 x 2.5g vials)',
                alternative: '4-Factor PCC (Kcentra) 50 IU/kg if idarucizumab unavailable',
                note: 'Idarucizumab is the ONLY FDA-approved specific reversal agent for dabigatran'
              },
              monitoring: 'dTT (dilute thrombin time), ECT, or aPTT (less reliable)'
            },
            edoxaban: {
              name: 'Edoxaban (Savaysa)',
              class: 'Direct Factor Xa Inhibitor',
              halfLife: '10-14 hours',
              halfLifeNote: 'Prolonged in low body weight (<60kg) and renal impairment',
              thrombolysisThreshold: '48 hours since last dose',
              thrombolysisNote: 'No calibrated specific assay widely available; Direct Xa Inhibitor screen may help exclude presence',
              ichReversal: {
                primary: '4-Factor PCC (Kcentra) 2000 units IVPB (local protocol) or 50 IU/kg (max 5000 IU)',
                alternative: 'Activated PCC (FEIBA) 50 IU/kg if 4F-PCC unavailable',
                note: 'Andexanet alfa is NOT indicated for edoxaban reversal. 4F-PCC is the primary reversal agent. Consider PCC if no contraindications and Direct Xa Inhibitor screen elevated.'
              },
              monitoring: 'Direct Xa Inhibitor screen (not widely calibrated for edoxaban)'
            },
            warfarin: {
              name: 'Warfarin (Coumadin)',
              class: 'Vitamin K Antagonist',
              halfLife: '20-60 hours',
              halfLifeNote: 'Variable, depends on individual metabolism',
              thrombolysisThreshold: 'INR ≤1.7',
              thrombolysisNote: 'Contraindicated if INR >1.7, PT >15s, or aPTT >40s',
              ichReversal: {
                primary: 'Vitamin K 10mg IV + 4-Factor PCC (Kcentra) based on INR and weight',
                pccDosing: 'INR 2-4: 25 IU/kg; INR 4-6: 35 IU/kg; INR >6: 50 IU/kg (max 5000 IU)',
                alternative: 'FFP 10-15 mL/kg if PCC unavailable (less effective, volume overload risk)',
                note: 'Vitamin K should always be given for sustained reversal'
              },
              monitoring: 'INR, PT'
            },
            heparin: {
              name: 'Unfractionated Heparin (UFH)',
              class: 'Indirect Thrombin Inhibitor',
              halfLife: '1-2 hours',
              halfLifeNote: 'Dose-dependent, cleared faster at higher doses',
              thrombolysisThreshold: 'aPTT must be ≤40s (normal) at time of administration',
              thrombolysisNote: 'UFH clearance is rapid (t½ 1-2h) but thrombolysis eligibility is aPTT-based, not time-based. Check aPTT; if >40s, wait and recheck.',
              ichReversal: {
                primary: 'Protamine sulfate 1mg per 100 units UFH (last 2-3 hours)',
                maxDose: 'Max 50mg protamine per dose',
                note: 'Protamine has rapid onset; re-dose if continued bleeding'
              },
              monitoring: 'aPTT, anti-Xa level'
            },
            lmwh: {
              name: 'Low Molecular Weight Heparin (Enoxaparin, etc.)',
              class: 'Indirect Factor Xa/IIa Inhibitor',
              halfLife: '4-6 hours',
              halfLifeNote: 'Prolonged in renal impairment',
              thrombolysisThreshold: '24 hours since last therapeutic dose',
              thrombolysisNote: 'Contraindicated within 24h of therapeutic dose; prophylactic dosing may be acceptable',
              ichReversal: {
                primary: 'Protamine: <8h since dose → 1mg per 1mg enoxaparin; 8-12h → 0.5mg per 1mg; >12h → likely unnecessary (check anti-Xa). Max single dose 50mg. May repeat 0.5mg/mg if bleeding persists.',
                note: 'Protamine only partially reverses LMWH (~60% anti-Xa activity neutralized). Anti-Xa level guides additional dosing.'
              },
              monitoring: 'Anti-Xa level (preferred), aPTT (unreliable)'
            },
            fondaparinux: {
              name: 'Fondaparinux (Arixtra)',
              class: 'Indirect Factor Xa Inhibitor (synthetic pentasaccharide)',
              halfLife: '17-21 hours',
              halfLifeNote: 'Significantly prolonged in renal impairment (up to 72h if CrCl <30). Contraindicated if CrCl <30.',
              thrombolysisThreshold: '48 hours since last dose (long half-life)',
              thrombolysisNote: 'No specific reversal agent. Check anti-Xa level; thrombolysis may be considered if anti-Xa undetectable.',
              ichReversal: {
                primary: 'Recombinant Factor VIIa (rFVIIa) 90 mcg/kg IV — limited evidence',
                alternative: '4-Factor PCC 50 IU/kg may partially correct, but not reliably studied for fondaparinux',
                note: 'No specific reversal agent exists. Protamine is INEFFECTIVE. rFVIIa has been used off-label. Consider Hematology consult. Supportive care and time (long half-life) are primary strategy.'
              },
              monitoring: 'Anti-Xa level (calibrated for fondaparinux)'
            }
          };

          // =================================================================
          // TRIAL ELIGIBILITY CONFIG - Modular structure for easy modification
          // Adding a new trial = Adding an object to this config
          // =================================================================
          // Helper: returns null (unknown) when value can't be parsed, preventing NaN comparisons
          const tryInt = (v) => { const n = parseInt(v, 10); return isNaN(n) ? null : n; };
          const trialGte = (v, threshold) => { const n = tryInt(v); return n === null ? null : n >= threshold; };
          const trialLte = (v, threshold) => { const n = tryInt(v); return n === null ? null : n <= threshold; };
          const TRIAL_ELIGIBILITY_CONFIG = {
            SISTER: {
              id: 'SISTER',
              name: 'SISTER Trial',
              nct: 'NCT05948566',
              category: 'ischemic',
              quickDescription: 'Late thrombolysis (4.5-24h) for anterior circulation stroke, no TNK/EVT',
              keyTakeaways: [
                'Tests whether IV thrombolysis benefits patients 4.5-24h from LKW who are NOT candidates for EVT',
                'Requires perfusion mismatch on CTP — target is the "TIMELESS-ineligible" population',
                'If positive, could expand treatment to patients who currently receive no acute reperfusion therapy'
              ],
              lookingFor: [
                'Anterior circulation stroke',
                'Late presenter (4.5-24h from LKW)',
                'NOT getting TNK or EVT',
                'Has salvageable tissue on CTP (mismatch profile)'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 18), required: true },
                { id: 'nihss', label: 'NIHSS ≥6 (or 4-5 disabling)', field: 'nihss', evaluate: (data) => trialGte(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss, 6), required: true },
                { id: 'timeWindow', label: '4.5-24h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs >= 4.5 && hrs <= 24;
                  }, required: true },
                { id: 'noTNK', label: 'No IV thrombolysis', field: 'tnkRecommended', evaluate: (data) => data.telestrokeNote?.tnkRecommended === false, required: true },
                { id: 'noEVT', label: 'No EVT planned', field: 'evtRecommended', evaluate: (data) => data.telestrokeNote?.evtRecommended === false, required: true },
                { id: 'aspects', label: 'ASPECTS ≥6', field: 'aspects', evaluate: (data) => trialGte(data.aspectsScore, 6), required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS ≤2', field: 'premorbidMRS', evaluate: (data) => trialLte(data.telestrokeNote?.premorbidMRS, 2), required: true },
                { id: 'ctpMismatch', label: 'CTP mismatch profile', field: 'ctpResults', evaluate: (data) => {
                    const ctp = (data.telestrokeNote?.ctpResults || '').toLowerCase();
                    return ctp.includes('mismatch') || ctp.includes('penumbra') || ctp.includes('salvageable');
                  }, required: true }
              ],
              exclusionFlags: [
                { id: 'priorStroke90d', label: 'Prior stroke <90 days', field: 'priorStroke90d' },
                { id: 'priorICH', label: 'Prior intracranial hemorrhage', field: 'priorICH' },
                { id: 'onAnticoag', label: 'On anticoagulation', field: 'lastDOACType', evaluate: (data) => !!data.telestrokeNote?.lastDOACType }
              ]
            },
            STEP: {
              id: 'STEP',
              name: 'STEP-EVT Trial',
              nct: 'NCT06289985',
              category: 'ischemic',
              quickDescription: 'Adaptive platform for mild LVO or medium/distal vessel occlusions',
              keyTakeaways: [
                'NIH StrokeNet adaptive platform with two domains: mild stroke with LVO (NIHSS 0-5) and medium/distal vessel occlusions (M2-M4, A1-A3, P1-P3)',
                'ESCAPE-MeVO (2025) showed NO benefit of EVT for M2/proximal M3 (higher mortality in EVT arm) — STEP aims to identify subgroups that may benefit using adaptive design',
                'Adaptive design allows rapid testing of multiple EVT devices and techniques'
              ],
              lookingFor: [
                'Two domains: Low NIHSS with LVO, OR Medium/Distal Vessel Occlusion',
                'Low NIHSS (0-5) + ICA/M1 occlusion, or',
                'M2/M3/M4, A1-A3, P1-P3 occlusion regardless of NIHSS'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 18), required: true },
                { id: 'timeWindow', label: 'Within 24h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs <= 24;
                  }, required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS ≤2', field: 'premorbidMRS', evaluate: (data) => trialLte(data.telestrokeNote?.premorbidMRS, 2), required: true },
                { id: 'vesselOcclusion', label: 'LVO or MeVO present', field: 'vesselOcclusion', evaluate: (data) => {
                    const occlusion = data.telestrokeNote?.vesselOcclusion || [];
                    return occlusion.length > 0;
                  }, required: true },
                { id: 'domainMatch', label: 'Matches Low-NIHSS or MeVO domain', field: 'nihss', evaluate: (data) => {
                    const nihss = parseInt(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss, 10);
                    const occlusion = data.telestrokeNote?.vesselOcclusion || [];
                    // Low NIHSS domain: NIHSS 0-5 with ICA or M1
                    const lowNIHSSMatch = nihss <= 5 && (occlusion.includes('ICA') || occlusion.includes('M1'));
                    // MeVO domain: M2, M3, A1-A3, P1-P3
                    const mevoMatch = occlusion.some(v => ['M2', 'M3', 'M4', 'A1', 'A2', 'A3', 'P1', 'P2', 'P3'].includes(v));
                    return lowNIHSSMatch || mevoMatch;
                  }, required: true }
              ],
              exclusionFlags: [
                { id: 'pregnancy', label: 'Pregnancy', field: 'pregnancy' },
                { id: 'hemorrhage', label: 'Evidence of hemorrhage', field: 'hemorrhage' }
              ]
            },
            PICASSO: {
              id: 'PICASSO',
              name: 'PICASSO Trial',
              nct: 'NCT05611242',
              category: 'ischemic',
              quickDescription: 'Tandem lesion: carotid stenosis + intracranial LVO',
              keyTakeaways: [
                'Tandem lesions (extracranial carotid + intracranial LVO) are common but excluded from most EVT trials',
                'Tests emergent carotid stenting + EVT vs EVT alone for tandem occlusions',
                'Addresses a gap where no RCT has established optimal management of the extracranial component'
              ],
              lookingFor: [
                'Tandem lesion (carotid + intracranial)',
                'Extracranial ICA stenosis 70-100%',
                'Plus intracranial LVO (ICA-T, M1, proximal M2)'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age 18-79', field: 'age', evaluate: (data) => {
                    const age = parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age, 10);
                    return age >= 18 && age <= 79;
                  }, required: true },
                { id: 'timeWindow', label: 'Within 16h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs <= 16;
                  }, required: true },
                { id: 'nihss', label: 'NIHSS ≥4', field: 'nihss', evaluate: (data) => trialGte(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss, 4), required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS 0-2', field: 'premorbidMRS', evaluate: (data) => trialLte(data.telestrokeNote?.premorbidMRS, 2), required: true },
                { id: 'aspects', label: 'ASPECTS ≥7', field: 'aspects', evaluate: (data) => trialGte(data.aspectsScore, 7), required: true },
                { id: 'tandemLesion', label: 'Tandem lesion present', field: 'ctaResults', evaluate: (data) => {
                    const cta = (data.telestrokeNote?.ctaResults || data.strokeCodeForm?.cta || '').toLowerCase();
                    return (cta.includes('tandem') || (cta.includes('carotid') && (cta.includes('m1') || cta.includes('ica'))));
                  }, required: true }
              ],
              exclusionFlags: []
            },
            TESTED: {
              id: 'TESTED',
              name: 'TESTED',
              nct: 'NCT05911568',
              category: 'ischemic',
              quickDescription: 'EVT in patients with pre-existing disability (mRS 3-4)',
              keyTakeaways: [
                'All major EVT trials excluded patients with pre-existing disability (mRS 3-4)',
                'These patients are routinely denied EVT despite no evidence of futility',
                'If positive, would extend EVT eligibility to a large underserved population'
              ],
              lookingFor: [
                'Patient with EXISTING disability (mRS 3-4)',
                'LVO stroke within 24h',
                'ASPECTS ≥3'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 18), required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS 3-4', field: 'premorbidMRS', evaluate: (data) => {
                    const mrs = parseInt(data.telestrokeNote?.premorbidMRS, 10);
                    return mrs >= 3 && mrs <= 4;
                  }, required: true },
                { id: 'nihss', label: 'NIHSS ≥6', field: 'nihss', evaluate: (data) => trialGte(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss, 6), required: true },
                { id: 'timeWindow', label: 'Within 24h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs <= 24;
                  }, required: true },
                { id: 'aspects', label: 'ASPECTS ≥3', field: 'aspects', evaluate: (data) => trialGte(data.aspectsScore, 3), required: true },
                { id: 'lvo', label: 'LVO present', field: 'vesselOcclusion', evaluate: (data) => {
                    const occlusion = data.telestrokeNote?.vesselOcclusion || [];
                    return occlusion.some(v => ['ICA', 'M1', 'M2'].includes(v));
                  }, required: true }
              ],
              exclusionFlags: []
            },
            SATURN: {
              id: 'SATURN',
              name: 'SATURN Trial',
              nct: 'NCT03936361',
              category: 'ich',
              quickDescription: 'Statin continuation vs discontinuation after lobar ICH',
              keyTakeaways: [
                'Lobar ICH raises concern for CAA — statins may increase recurrent ICH risk in CAA patients',
                'Many patients are on statins for cardiovascular prevention; stopping may increase MACE risk',
                'First RCT to directly address the statin dilemma after lobar ICH'
              ],
              lookingFor: [
                'Lobar ICH (NOT deep/basal ganglia)',
                'Already on statin therapy',
                'Age ≥50'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥50', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 50), required: true },
                { id: 'lobarICH', label: 'Lobar ICH location', field: 'ichLocation', evaluate: (data) => {
                    const loc = (data.ichLocation || '').toLowerCase();
                    return loc.includes('lobar') || loc.includes('cortical');
                  }, required: true },
                { id: 'onStatin', label: 'On statin at ICH onset', field: 'onStatin', evaluate: (data) => data.onStatin === true, required: true },
                { id: 'mrs', label: 'mRS ≤4 at randomization', field: 'mrsScore', evaluate: (data) => trialLte(data.mrsScore, 4), required: true }
              ],
              exclusionFlags: [
                { id: 'deepICH', label: 'Deep/non-lobar ICH', field: 'ichLocation' },
                { id: 'recentMI', label: 'Recent MI <3 months', field: 'recentMI' }
              ]
            },
            ASPIRE: {
              id: 'ASPIRE',
              name: 'ASPIRE Trial',
              nct: 'NCT03907046',
              category: 'ich',
              quickDescription: 'Apixaban vs aspirin post-ICH in atrial fibrillation',
              keyTakeaways: [
                'ICH patients with AF face a dilemma: anticoagulation prevents ischemic stroke but may cause recurrent ICH',
                'PRESTIGE-AF showed non-inferiority of DOAC vs no anticoag; ASPIRE directly compares apixaban to aspirin',
                'Enrollment window is 14-180 days post-ICH — flag for outpatient follow-up'
              ],
              lookingFor: [
                'ICH patient with atrial fibrillation',
                'Randomize 14-180 days post-ICH',
                'CHA2DS2-VASc ≥2'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 18), required: true },
                { id: 'ichConfirmed', label: 'ICH confirmed', field: 'diagnosis', evaluate: (data) => {
                    return data.telestrokeNote?.diagnosisCategory === 'ich';
                  }, required: true },
                { id: 'afib', label: 'Atrial fibrillation', field: 'pmh', evaluate: (data) => {
                    const pmh = (data.telestrokeNote?.pmh || '').toLowerCase();
                    return pmh.includes('afib') || pmh.includes('atrial fib') || pmh.includes('af ') || pmh.includes('a-fib');
                  }, required: true },
                { id: 'mrs', label: 'mRS ≤4', field: 'mrsScore', evaluate: (data) => trialLte(data.mrsScore, 4), required: true }
              ],
              exclusionFlags: [
                { id: 'mechValve', label: 'Mechanical heart valve', field: 'mechValve' }
              ]
            },
            VERIFY: {
              id: 'VERIFY',
              name: 'VERIFY Study',
              nct: 'NCT05338697',
              category: 'ischemic',
              quickDescription: 'Observational: TMS/MRI to predict motor recovery',
              keyTakeaways: [
                'Uses TMS + MRI biomarkers to predict upper extremity motor recovery trajectory',
                'Observational — enrollment is straightforward with minimal patient burden',
                'Could establish precision rehab: matching therapy intensity to predicted recovery potential'
              ],
              lookingFor: [
                'Acute ischemic stroke within 7 days',
                'Upper extremity weakness',
                'Inpatient enrollment opportunity'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 18), required: true },
                { id: 'ueWeakness', label: 'Upper extremity weakness', field: 'symptoms', evaluate: (data) => {
                    const sx = (data.telestrokeNote?.symptoms || '').toLowerCase();
                    return sx.includes('arm') || sx.includes('upper') || sx.includes('hand') || sx.includes('weakness');
                  }, required: false },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS ≤2', field: 'premorbidMRS', evaluate: (data) => trialLte(data.telestrokeNote?.premorbidMRS, 2), required: true }
              ],
              exclusionFlags: [
                { id: 'seizures', label: 'History of seizures', field: 'seizures' },
                { id: 'implants', label: 'Implanted devices (pacemaker, etc.)', field: 'implants' }
              ]
            },
            DISCOVERY: {
              id: 'DISCOVERY',
              name: 'DISCOVERY Study',
              nct: 'NCT04916210',
              category: 'ischemic',
              quickDescription: 'Observational: Cognitive trajectories post-stroke',
              keyTakeaways: [
                'Maps cognitive decline trajectories after stroke (AIS, ICH, and SAH) over 2 years',
                'Aims to identify modifiable risk factors for post-stroke cognitive impairment',
                'Low barrier — observational with cognitive testing at standard follow-up intervals'
              ],
              lookingFor: [
                'Any stroke type (AIS, ICH, SAH)',
                'Baseline visit within 6 weeks',
                'Able to complete cognitive testing'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 18), required: true },
                { id: 'strokeConfirmed', label: 'Stroke confirmed', field: 'diagnosis', evaluate: (data) => {
                    const cat = data.telestrokeNote?.diagnosisCategory;
                    return !!cat && cat !== 'mimic';
                  }, required: true }
              ],
              exclusionFlags: [
                { id: 'preDementia', label: 'Pre-existing dementia', field: 'preDementia' }
              ]
            },
            MOST: {
              id: 'MOST',
              name: 'MOST Trial',
              nct: 'NCT05326139',
              category: 'ischemic',
              quickDescription: 'Multi-arm thrombolysis optimization: TNK dose-finding and adjunctive nerinetide',
              keyTakeaways: [
                'Adaptive platform testing TNK 0.40 mg/kg (higher dose) vs standard 0.25 mg/kg for AIS with LVO',
                'Also testing nerinetide (NA-1) as neuroprotective adjunct to EVT',
                'Could establish optimized TNK dosing for LVO patients proceeding to EVT'
              ],
              lookingFor: [
                'Acute ischemic stroke with LVO',
                'Eligible for IV thrombolysis',
                'Within 4.5 hours from LKW',
                'Age 18+'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 18), required: true },
                { id: 'nihss', label: 'NIHSS ≥6', field: 'nihss', evaluate: (data) => trialGte(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss, 6), required: true },
                { id: 'timeWindow', label: 'Within 4.5h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs < 4.5;
                  }, required: true },
                { id: 'lvo', label: 'LVO confirmed (ICA/M1)', field: 'vesselOcclusion', evaluate: (data) => {
                    const occlusion = data.telestrokeNote?.vesselOcclusion || [];
                    return occlusion.some(v => ['ICA', 'M1'].includes(v));
                  }, required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS 0-1', field: 'premorbidMRS', evaluate: (data) => trialLte(data.telestrokeNote?.premorbidMRS, 1), required: true }
              ],
              exclusionFlags: [
                { id: 'onAnticoag', label: 'On anticoagulation', field: 'onAnticoag' },
                { id: 'hemorrhage', label: 'Evidence of hemorrhage on CT', field: 'hemorrhage' }
              ]
            },
            CAPTIVA: {
              id: 'CAPTIVA',
              name: 'CAPTIVA Trial',
              nct: 'NCT05047172',
              category: 'ischemic',
              quickDescription: 'Ticagrelor+ASA vs rivaroxaban+ASA vs clopidogrel+ASA for intracranial atherosclerosis',
              keyTakeaways: [
                'Three-arm trial for symptomatic intracranial atherosclerotic stenosis (ICAS) 70-99%',
                'Tests ticagrelor+ASA and low-dose rivaroxaban+ASA against standard clopidogrel+ASA',
                'Addresses a major unmet need — recurrent stroke risk is 12-20% at 1 year despite DAPT for ICAS'
              ],
              lookingFor: [
                'Symptomatic intracranial stenosis 70-99%',
                'Ischemic stroke or TIA attributed to ICAS',
                'Within 21 days of qualifying event',
                'Age ≥30'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥30', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 30), required: true },
                { id: 'diagnosis', label: 'Ischemic stroke or TIA', field: 'diagnosis', evaluate: (data) => {
                    const cat = data.telestrokeNote?.diagnosisCategory;
                    return cat === 'ischemic' || cat === 'tia';
                  }, required: true },
                { id: 'icas', label: 'Intracranial stenosis 70-99% (ICAS)', field: 'ctaResults', evaluate: (data) => {
                    const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                    return cta.includes('stenosis') || cta.includes('intracranial') || cta.includes('icas') || cta.includes('atheroscler');
                  }, required: true },
                { id: 'premorbidMRS', label: 'mRS ≤3', field: 'premorbidMRS', evaluate: (data) => trialLte(data.telestrokeNote?.premorbidMRS, 3), required: true }
              ],
              exclusionFlags: [
                { id: 'cardioembolic', label: 'Cardioembolic source (AF, valve)', field: 'cardioembolic' },
                { id: 'onAnticoag', label: 'On full-dose anticoagulation', field: 'onAnticoag' }
              ]
            },
            RHAPSODY: {
              id: 'RHAPSODY',
              name: 'RHAPSODY Trial',
              nct: 'NCT04953325',
              category: 'ischemic',
              quickDescription: '3K3A-APC neuroprotection after thrombolysis/EVT for moderate-severe AIS',
              keyTakeaways: [
                '3K3A-APC (activated protein C variant) showed signal for reduced ICH and improved outcomes in phase 2',
                'First neuroprotective agent with mechanistic basis in stroke (anti-inflammatory, anti-apoptotic, BBB stabilization)',
                'Given as IV infusion after reperfusion — does not delay standard treatment'
              ],
              lookingFor: [
                'Moderate-severe acute ischemic stroke (NIHSS ≥5)',
                'Received IVT and/or EVT',
                'Can start study drug within 15h of LKW',
                'Age 18+'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => trialGte(data.telestrokeNote?.age || data.strokeCodeForm?.age, 18), required: true },
                { id: 'nihss', label: 'NIHSS ≥5', field: 'nihss', evaluate: (data) => trialGte(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss, 5), required: true },
                { id: 'reperfusion', label: 'Received IVT and/or EVT', field: 'tnkRecommended', evaluate: (data) => {
                    return data.telestrokeNote?.tnkRecommended === true || data.telestrokeNote?.evtRecommended === true;
                  }, required: true },
                { id: 'timeWindow', label: 'Within 15h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs <= 15;
                  }, required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS 0-2', field: 'premorbidMRS', evaluate: (data) => trialLte(data.telestrokeNote?.premorbidMRS, 2), required: true }
              ],
              exclusionFlags: [
                { id: 'hemorrhage', label: 'Symptomatic ICH', field: 'hemorrhage' }
              ]
            }
          };

          // =================================================================
          // GUIDELINE RECOMMENDATIONS KNOWLEDGE BASE
          // Evidence-based recommendations from current stroke guidelines
          // =================================================================
          // Guideline URL lookup — maps guideline name substrings to source URLs
          const GUIDELINE_URLS = {
            'Early Management of Acute Ischemic Stroke 2026': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000513',
            'Spontaneous ICH 2022': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000407',
            'Secondary Stroke Prevention 2021': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000375',
            'Primary Prevention of Stroke 2024': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000475',
            'Primary Prevention 2024': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000475',
            'Aneurysmal SAH 2023': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000436',
            'Cerebral Venous Thrombosis 2024': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000456',
            'Maternal Stroke 2026': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000514',
            'Maternal Stroke in Pregnancy and Postpartum 2026': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000514',
            'Systemic Complications of Acute Stroke 2024': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000477',
            'Palliative Care in Stroke 2024': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000479',
            'Classification and Management of Ischemic Stroke in Patients With Active Cancer': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000517',
            'Cardiac Contributions to Brain Health': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000476',
            'Transient Ischemic Attack in the Emergency Department': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000418',
            'Cognitive Impairment After Ischemic and Hemorrhagic Stroke': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000430',
            'Endovascular Treatment and Thrombolysis for Acute Ischemic Stroke in Patients With Premorbid Disability or Dementia': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000406',
            'Primary Care of Adult Patients After Stroke': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000382',
            'Perioperative Neurological Evaluation and Management': 'https://www.ahajournals.org/doi/10.1161/CIR.0000000000000968',
            'Early Recognition and Intervention for Poststroke Spasticity': 'https://www.ahajournals.org/doi/10.1161/STR.0000000000000515',
            'Intracranial Atherosclerosis': 'https://www.aan.com/Guidelines/home/GuidelineDetail/1103',
            'CATALYST': 'https://doi.org/10.1016/S1474-4422(25)00057-5',
            'TIMELESS': 'https://doi.org/10.1056/NEJMoa2412179',
            'CREST-2': 'https://doi.org/10.1056/NEJMoa2408498',
            'ECST-2': 'https://doi.org/10.1016/S1474-4422(25)00049-6',
            'SELECT': 'https://doi.org/10.1056/NEJMoa2305049',
            'CHANCE-2': 'https://doi.org/10.1056/NEJMoa2104816',
            'CONVINCE': 'https://doi.org/10.1016/S0140-6736(24)00663-8',
            'ESCAPE-MeVO': 'https://doi.org/10.1056/NEJMoa2411227',
            'SVIN Large-Core EVT 2025': 'https://www.ahajournals.org/doi/10.1161/SVIN.124.001581',
            'ACC Expert Consensus': 'https://doi.org/10.1016/j.jacc.2024.03.389'
          };

          const getGuidelineUrl = (guidelineStr) => {
            if (!guidelineStr) return null;
            for (const [key, url] of Object.entries(GUIDELINE_URLS)) {
              if (guidelineStr.includes(key)) return url;
            }
            return null;
          };

          const GUIDELINE_LIBRARY = [
            ais2026,
            ich2022,
            sah2023,
            cvt2024,
            maternalStroke2026,
            primaryPrevention2024,
            secondaryPrevention2021,
            svinLargeCore2025,
            cancerStroke2026,
            premorbidDisability2022,
            tiaEd2023,
            systemicComplications2024,
            poststrokeCognitive2023,
            poststrokeSpasticity2026,
            poststrokePrimaryCare2021,
            perioperativeStroke2021,
            cardiacBrainHealth2024
          ];
          const GUIDELINE_LIBRARY_INDEX = GUIDELINE_LIBRARY.map((guideline) => ({
            ...guideline,
            recommendations: guideline.recommendations.map((rec, index) => ({
              ...rec,
              id: rec.id || `${guideline.id}-${index + 1}`,
              sourceUrl: guideline.publisherUrl || guideline.pdfUrl,
              pdfSourceUrl: rec.page && guideline.pdfUrl ? `${guideline.pdfUrl}#page=${rec.page}` : null
            }))
          }));

          const GUIDELINE_CLASS_COLORS = {
            I: 'bg-emerald-600 text-white',
            IIa: 'bg-blue-500 text-white',
            IIb: 'bg-amber-500 text-white',
            III: 'bg-red-600 text-white',
            Statement: 'bg-slate-500 text-white'
          };

          const GUIDELINE_RECOMMENDATIONS = {
            // ---------------------------------------------------------------
            // BLOOD PRESSURE MANAGEMENT
            // ---------------------------------------------------------------
            bp_pre_tnk: {
              id: 'bp_pre_tnk',
              category: 'Blood Pressure',
              title: 'Pre-thrombolysis BP target',
              recommendation: 'Maintain BP <185/110 mmHg before and during IV thrombolysis administration.',
              detail: 'Use IV labetalol 10-20 mg or nicardipine 5 mg/hr (titrate by 2.5 mg/hr q5-15 min, max 15 mg/hr). If BP cannot be maintained <185/110, thrombolysis is contraindicated.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              medications: ['Labetalol 10-20 mg IV', 'Nicardipine 5 mg/hr IV'],
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const timeFrom = data.timeFromLKW;
                const inWindow = timeFrom && timeFrom.total <= 4.5;
                return isIschemic && (inWindow || data.telestrokeNote?.tnkRecommended);
              }
            },
            bp_post_tnk: {
              id: 'bp_post_tnk',
              category: 'Blood Pressure',
              title: 'Post-thrombolysis BP target',
              recommendation: 'Maintain BP <180/105 mmHg for 24 hours after IV thrombolysis.',
              detail: 'Monitor BP every 15 minutes for 2 hours, then every 30 minutes for 6 hours, then hourly for 16 hours. Intensive SBP <140 mmHg is NOT recommended (Class III: No Benefit).',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              medications: ['Labetalol IV PRN', 'Nicardipine infusion'],
              conditions: (data) => {
                return !!data.telestrokeNote?.tnkAdminTime;
              }
            },
            bp_post_evt: {
              id: 'bp_post_evt',
              category: 'Blood Pressure',
              title: 'Post-EVT BP management (Class III: Harm)',
              recommendation: 'Do NOT target SBP <140 mmHg after successful EVT reperfusion. Maintain SBP <180/105.',
              detail: 'ENCHANTED2/MT and OPTIMAL-BP trials demonstrated that intensive BP lowering (SBP <140) post-EVT was associated with worse functional outcomes (Class III: Harm). Standard target SBP <180/105 is recommended.',
              classOfRec: 'III',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              caveats: 'Based on ENCHANTED2/MT (2023) and OPTIMAL-BP (2024). Applies to successful reperfusion (mTICI 2b-3).',
              conditions: (data) => {
                return !!data.telestrokeNote?.evtRecommended;
              }
            },
            bp_ich_acute: {
              id: 'bp_ich_acute',
              category: 'Blood Pressure',
              title: 'ICH acute BP target',
              recommendation: 'For ICH with presenting SBP 150-220, acute lowering to SBP <140 mmHg is safe and reasonable (Class IIa, LOE B-R per AHA/ASA 2022; INTERACT2). Avoid SBP <130 (ATACH-2: no benefit, possible harm).',
              detail: 'AHA/ASA 2022 ICH guideline: for ICH with presenting SBP 150-220, acute lowering to SBP 140 mmHg is safe and reasonable (Class IIa, LOE B-R, INTERACT2). Avoid SBP <130 (Class III: Harm, ATACH-2). For SBP >220, safety of intensive lowering is uncertain. Nicardipine infusion preferred. Maintain target for at least 24 hours.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=17',
              medications: ['Nicardipine 5 mg/hr IV (titrate to 15 mg/hr)', 'Labetalol 10-20 mg IV bolus PRN'],
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            bp_ich_avoid_low: {
              id: 'bp_ich_avoid_low',
              category: 'Blood Pressure',
              title: 'Avoid overly aggressive BP lowering in ICH',
              recommendation: 'Avoid lowering SBP to <130 mmHg in mild to moderate ICH (potentially harmful).',
              detail: 'Aggressive SBP <130 is associated with worse outcomes in mild to moderate ICH.',
              classOfRec: 'III',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=17',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            bp_ischemic_no_lysis: {
              id: 'bp_ischemic_no_lysis',
              category: 'Blood Pressure',
              title: 'Ischemic stroke BP (no thrombolysis)',
              recommendation: 'Permissive hypertension: treat only if BP >220/120 mmHg in first 24-48 hours. Lower by 15% in first 24 hours if treating.',
              detail: 'For patients not receiving thrombolysis or EVT, aggressive BP lowering may worsen ischemic penumbra. After 24-48h, initiate oral antihypertensives to target <130/80 for secondary prevention.',
              classOfRec: 'I',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                return isIschemic && !data.telestrokeNote?.tnkRecommended && !data.telestrokeNote?.evtRecommended;
              }
            },

            // ---------------------------------------------------------------
            // THROMBOLYSIS
            // ---------------------------------------------------------------
            tnk_standard: {
              id: 'tnk_standard',
              category: 'Thrombolysis',
              title: 'IV TNK for acute ischemic stroke',
              recommendation: 'Administer TNK 0.25 mg/kg (max 25 mg) single IV bolus within 4.5 hours of symptom onset.',
              detail: 'TNK is the preferred thrombolytic due to single-bolus dosing (Class I, LOE A). Administer at spoke and transfer immediately for EVT evaluation if LVO suspected. Do not delay for imaging beyond NCCT.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              medications: ['TNK 0.25 mg/kg IV bolus (max 25 mg)'],
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const timeFrom = data.timeFromLKW;
                return isIschemic && timeFrom && timeFrom.total <= 4.5;
              }
            },
            tnk_extended_imaging: {
              id: 'tnk_extended_imaging',
              category: 'Thrombolysis',
              title: 'Extended window IVT (4.5-9h or wake-up)',
              recommendation: 'IV thrombolysis (TNK or alteplase) is reasonable in the 4.5-9 hour or wake-up window when mismatch imaging shows salvageable tissue.',
              detail: 'Use CT perfusion, MR perfusion, or DWI/FLAIR mismatch to select patients. EXTEND supports perfusion mismatch (4.5-9h), WAKE-UP supports DWI/FLAIR mismatch for unknown onset. IST-3 (Lancet 2012, n=3035): IVT up to 6h, included many >80 yr — primary ordinal analysis neutral, but supported that age alone should not exclude IVT. ECASS-III (NEJM 2008): established 3-4.5h window. 4.5-24h IVT remains investigational (TIMELESS/SISTER).',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026; EXTEND; WAKE-UP.',
              medications: ['TNK 0.25 mg/kg IV bolus (max 25 mg)'],
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const timeFrom = data.timeFromLKW;
                return isIschemic && timeFrom && timeFrom.total > 4.5 && timeFrom.total <= 9;
              }
            },

            // ---------------------------------------------------------------
            // ENDOVASCULAR THERAPY (EVT)
            // ---------------------------------------------------------------
            evt_standard: {
              id: 'evt_standard',
              category: 'EVT',
              title: 'EVT for LVO within 6 hours',
              recommendation: 'EVT recommended for anterior LVO (ICA, M1) within 6 hours of onset with NIHSS ≥6. ASPECTS 3-10: generally eligible per local protocol.',
              detail: 'Suggested protocol: Early window (0-6h) — ASPECTS 3-10 generally eligible for EVT. ASPECTS 0-2: consider in very select cases; consider CTP to evaluate if estimated core volume ≤70-100cc. Do not delay transfer for TNK response. Administer TNK at spoke and transfer immediately for EVT evaluation.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const timeFrom = data.timeFromLKW;
                const hasLVO = (data.telestrokeNote?.vesselOcclusion || []).some(v =>
                  /ica|m1|mca|basilar/i.test(v)
                );
                return nihss >= 6 && timeFrom && timeFrom.total <= 6 && hasLVO;
              }
            },
            evt_late_window: {
              id: 'evt_late_window',
              category: 'EVT',
              title: 'EVT late window (6-24h)',
              recommendation: 'EVT recommended 6-24 hours from onset for anterior LVO with NIHSS ≥6 and ASPECTS 6-10. Requires favorable perfusion imaging or good collaterals.',
              detail: 'Suggested protocol: Late window (6-24h) — ASPECTS 6-10 generally eligible. ASPECTS 3-5: generally eligible; consider CTP to evaluate if estimated core volume ≤100cc + mismatch present. ASPECTS 0-2: EVT benefit is unclear. Based on DAWN/DEFUSE-3 criteria. Age ≥80 requires NIHSS ≥10. Good collateral status on CTA may independently predict benefit when CTP unavailable.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              caveats: 'Collateral grading on multiphase CTA or single-phase CTA may support EVT candidacy when CTP unavailable.',
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const age = parseInt(data.telestrokeNote?.age, 10) || 0;
                const minNIHSS = age >= 80 ? 10 : 6; // DAWN: age ≥80 requires NIHSS ≥10
                const timeFrom = data.timeFromLKW;
                const hasLVO = (data.telestrokeNote?.vesselOcclusion || []).some(v =>
                  /ica|m1|mca|basilar/i.test(v)
                );
                return nihss >= minNIHSS && timeFrom && timeFrom.total > 6 && timeFrom.total <= 24 && hasLVO;
              }
            },
            evt_large_core_early: {
              id: 'evt_large_core_early',
              category: 'EVT',
              title: 'EVT for large core (ASPECTS 0-5, 0-6h)',
              recommendation: 'EVT is recommended for anterior LVO within 0-6 hours when ASPECTS is 3-5 (generally eligible). ASPECTS 0-2: consider in very select cases with CTP core ≤70-100cc.',
              detail: 'Suggested protocol: ASPECTS 3-10 generally eligible in early window. ASPECTS 0-2: consider CTP to evaluate if estimated core volume ≤70-100cc. SVIN 2025 large-core guidance supports EVT across ASPECTS 0-5 in the early window based on LASTE, SELECT2, ANGEL-ASPECT, RESCUE-Japan LIMIT, TENSION, and TESLA. Higher sICH risk with lower ASPECTS; discuss goals of care.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'SVIN Large-Core EVT 2025',
              reference: 'Mokin M et al. Stroke Vasc Interv Neurol. 2025;5:e001581. DOI: 10.1161/SVIN.124.001581.',
              caveats: 'Trial eligibility generally required pre-stroke mRS 0-1 and age 18-80. Higher sICH risk; discuss goals of care.',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/SVIN.124.001581#page=10',
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const timeFrom = data.timeFromLKW;
                const aspects = Number.isFinite(data.aspectsScore) ? data.aspectsScore : null;
                const hasLVO = (data.telestrokeNote?.vesselOcclusion || []).some(v =>
                  /ica|m1|mca|basilar/i.test(v)
                );
                return nihss >= 6 && !!timeFrom && timeFrom.total <= 6 && aspects !== null && aspects <= 5 && hasLVO;
              }
            },
            evt_large_core_late: {
              id: 'evt_large_core_late',
              category: 'EVT',
              title: 'EVT for large core (ASPECTS 3-5, 6-24h)',
              recommendation: 'EVT is recommended for anterior circulation LVO within 6-24 hours when ASPECTS is 3-5.',
              detail: 'SVIN 2025: late-window large-core EVT supported by ANGEL-ASPECT and RESCUE-Japan LIMIT. CTP-based selection per SELECT2/ANGEL-ASPECT (core 50-100 mL) is also Class I, LOE A.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'SVIN Large-Core EVT 2025',
              reference: 'Mokin M et al. Stroke Vasc Interv Neurol. 2025;5:e001581. DOI: 10.1161/SVIN.124.001581.',
              caveats: 'Eligibility often required pre-stroke mRS 0-1 and age 18-80. Discuss goals of care and higher hemorrhage risk.',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/SVIN.124.001581#page=10',
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const timeFrom = data.timeFromLKW;
                const aspects = Number.isFinite(data.aspectsScore) ? data.aspectsScore : null;
                const hasLVO = (data.telestrokeNote?.vesselOcclusion || []).some(v =>
                  /ica|m1|mca|basilar/i.test(v)
                );
                return nihss >= 6 && !!timeFrom && timeFrom.total > 6 && timeFrom.total <= 24 && aspects !== null && aspects >= 3 && aspects <= 5 && hasLVO;
              }
            },
            evt_large_core_uncertain: {
              id: 'evt_large_core_uncertain',
              category: 'EVT',
              title: 'EVT for very large core (ASPECTS 0-2, 6-24h)',
              recommendation: 'For ASPECTS 0-2 in the 6-24 hour window, the benefit of EVT is uncertain.',
              detail: 'SVIN 2025 assigns Class IIb, LOE B-R for ASPECTS 0-2 in late window. Consider exceptional cases or trials only.',
              classOfRec: 'IIb',
              levelOfEvidence: 'B-R',
              guideline: 'SVIN Large-Core EVT 2025',
              reference: 'Mokin M et al. Stroke Vasc Interv Neurol. 2025;5:e001581. DOI: 10.1161/SVIN.124.001581.',
              caveats: 'Discuss goals of care and low likelihood of independence; prioritize trial enrollment when available.',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/SVIN.124.001581#page=10',
              conditions: (data) => {
                const timeFrom = data.timeFromLKW;
                const aspects = Number.isFinite(data.aspectsScore) ? data.aspectsScore : null;
                const hasLVO = (data.telestrokeNote?.vesselOcclusion || []).some(v =>
                  /ica|m1|mca|basilar/i.test(v)
                );
                return !!timeFrom && timeFrom.total > 6 && timeFrom.total <= 24 && aspects !== null && aspects <= 2 && hasLVO;
              }
            },
            evt_basilar: {
              id: 'evt_basilar',
              category: 'EVT',
              title: 'EVT for basilar artery occlusion',
              recommendation: 'EVT is recommended for basilar artery occlusion within 24 hours of onset when NIHSS ≥10 and pc-ASPECTS ≥6.',
              detail: 'Suggested protocol: Basilar EVT — LKW ≤24h, NIHSS ≥10, pc-ASPECTS ≥6. Based on ATTENTION and BAOCHE trials (2023). Benefit demonstrated up to 24 hours with significant deficit.',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const timeFrom = data.timeFromLKW;
                const hasBasilar = (data.telestrokeNote?.vesselOcclusion || []).some(v =>
                  /basilar/i.test(v)
                );
                return hasBasilar && timeFrom && timeFrom.total <= 24 && nihss >= 10;
              }
            },

            // ---------------------------------------------------------------
            // ANTITHROMBOTIC THERAPY
            // ---------------------------------------------------------------
            dapt_minor_stroke: {
              id: 'dapt_minor_stroke',
              category: 'Antithrombotic',
              title: 'DAPT for minor stroke/TIA (NIHSS ≤3)',
              recommendation: 'Dual antiplatelet therapy (aspirin + clopidogrel) for 21 days in minor ischemic stroke (NIHSS ≤3) or high-risk TIA (ABCD2 ≥4), then transition to single antiplatelet.',
              detail: 'Start within 24 hours of onset. Loading dose: ASA 325 mg + clopidogrel 300 mg, then ASA 81 mg + clopidogrel 75 mg daily for 21 days. Based on CHANCE/POINT trials. For CYP2C19 LOF carriers: consider ticagrelor 180 mg load + ASA, then ticagrelor 90 mg BID + ASA x 21 days, followed by ticagrelor monotherapy (CHANCE-2, Class IIb).',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'AIS 2026 Rec #12. CHANCE: Wang Y et al. NEJM 2013. POINT: Johnston SC et al. NEJM 2018. CHANCE-2: Wang Y et al. NEJM 2021.',
              medications: ['ASA 325 mg load then 81 mg daily', 'Clopidogrel 300 mg load then 75 mg daily x 21 days', 'Alt (CYP2C19 LOF): Ticagrelor 180 mg load then 90 mg BID + ASA x 21 days'],
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                return isIschemic && nihss <= 3 && !data.telestrokeNote?.tnkRecommended && !data.telestrokeNote?.evtRecommended;
              }
            },
            dapt_ticagrelor_nihss5: {
              id: 'dapt_ticagrelor_nihss5',
              category: 'Antithrombotic',
              title: 'Ticagrelor + ASA for minor stroke (NIHSS 4-5)',
              recommendation: 'For NIHSS ≤5 noncardioembolic AIS or high-risk TIA (ABCD2 ≥6), DAPT with ticagrelor + aspirin for 30 days may be considered.',
              detail: 'Ticagrelor 180 mg load + ASA 325 mg, then ticagrelor 90 mg BID + ASA 81 mg daily x 30 days (AIS-2026 Rec #13, Class IIb). This extends DAPT eligibility to NIHSS 4-5 patients using ticagrelor-based regimen. Standard clopidogrel-based DAPT (CHANCE/POINT) applies to NIHSS ≤3. ⚠ Drug interactions: AVOID strong CYP3A4 inhibitors (ketoconazole, itraconazole, clarithromycin, ritonavir) and inducers (rifampin, phenytoin, carbamazepine). USE CAUTION with moderate CYP3A4 inhibitors (diltiazem, verapamil). Monitor for bradycardia (especially with beta-blockers or digoxin). Dyspnea occurs in ~14% — usually benign, self-resolving.',
              classOfRec: 'IIb',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'AIS 2026 Rec #13. THALES: Johnston SC et al. NEJM 2020.',
              medications: ['Ticagrelor 180 mg load then 90 mg BID x 30 days', 'ASA 325 mg load then 81 mg daily x 30 days'],
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                return isIschemic && nihss >= 4 && nihss <= 5 && !data.telestrokeNote?.tnkRecommended && !data.telestrokeNote?.evtRecommended;
              }
            },
            anticoag_af_timing: {
              id: 'anticoag_af_timing',
              category: 'Antithrombotic',
              title: 'Early DOAC initiation in AF-related stroke',
              recommendation: 'Initiate DOAC early after AF-related ischemic stroke based on infarct severity: minor stroke within 48 hours, moderate stroke day 3-5, severe/large stroke day 6-14.',
              detail: 'Based on CATALYST meta-analysis (ELAN, OPTIMAS, TIMING, START pooled data). No increased risk of symptomatic ICH with early DOAC initiation vs delayed. Individual timing should consider hemorrhagic transformation on imaging. DOAC preferred over warfarin (Class I, LOE A).',
              classOfRec: 'IIa',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021 + CATALYST Meta-Analysis 2025',
              reference: 'Fischer U et al. Lancet Neurol. 2025. CATALYST: Collaboration for Antithrombotic Timing After Acute Ischaemic Stroke.',
              medications: ['Apixaban 5 mg BID (preferred)', 'Rivaroxaban 20 mg daily', 'Dabigatran 150 mg BID'],
              caveats: 'Timing categories per CATALYST: mild (NIHSS <8, small infarct) 48h; moderate (NIHSS 8-15) day 3-5; severe (NIHSS ≥16 or large infarct) day 6-14. Reassess imaging before starting if any concern for hemorrhagic transformation.',
              conditions: (data) => {
                const meds = (data.telestrokeNote?.medications || '').toLowerCase();
                const pmh = (data.telestrokeNote?.pmh || '').toLowerCase();
                const hasAF = pmh.includes('afib') || pmh.includes('atrial fib') || pmh.includes('a-fib') || pmh.includes('af ') ||
                              meds.includes('apixaban') || meds.includes('rivaroxaban') || meds.includes('eliquis') || meds.includes('xarelto') ||
                              meds.includes('warfarin') || meds.includes('coumadin') || meds.includes('dabigatran') || meds.includes('pradaxa');
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                return isIschemic && hasAF;
              }
            },
            sicas_dapt: {
              id: 'sicas_dapt',
              category: 'Antithrombotic',
              title: 'Symptomatic intracranial atherosclerosis (sICAS) DAPT',
              recommendation: 'DAPT (aspirin + clopidogrel) for 90 days for severe symptomatic intracranial stenosis (70-99%), then aspirin 325 mg monotherapy.',
              detail: 'Do NOT offer intracranial stenting as initial treatment (Class III). Add high-intensity statin with LDL target <70 mg/dL. Based on SAMMPRIS trial evidence.',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'AAN Intracranial Atherosclerosis Practice Advisory 2022 (reaffirmed 2025)',
              reference: 'AAN Practice Advisory 2022. Reaffirmed 2025.',
              medications: ['ASA 325 mg daily (after 90-day DAPT)', 'Clopidogrel 75 mg daily x 90 days', 'High-intensity statin'],
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return isIschemic && (dx.includes('intracranial') || dx.includes('icas') || cta.includes('intracranial stenosis') || cta.includes('icas'));
              }
            },

            // ---------------------------------------------------------------
            // STATIN THERAPY
            // ---------------------------------------------------------------
            statin_ischemic: {
              id: 'statin_ischemic',
              category: 'Statin',
              title: 'High-intensity statin for ischemic stroke',
              recommendation: 'Initiate high-intensity statin therapy (atorvastatin 40-80 mg or rosuvastatin 20-40 mg) with LDL target <70 mg/dL.',
              detail: 'Add ezetimibe if LDL not at goal on max statin. Consider PCSK9 inhibitor if still not at goal. Start during hospitalization.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467. DOI: 10.1161/STR.0000000000000375',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000375#page=21',
              medications: ['Atorvastatin 80 mg daily', 'Rosuvastatin 20-40 mg daily', 'Ezetimibe 10 mg if LDL not at goal'],
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return cat === 'ischemic' || cat === 'tia';
              }
            },

            // ---------------------------------------------------------------
            // ANTICOAGULATION REVERSAL (ICH)
            // ---------------------------------------------------------------
            reversal_warfarin: {
              id: 'reversal_warfarin',
              category: 'Reversal',
              title: 'Warfarin reversal in ICH',
              recommendation: 'Administer IV Vitamin K 10 mg + 4-factor PCC (KCentra) for ICH on warfarin. Target INR <1.5 within 4 hours.',
              detail: '4F-PCC preferred over FFP for rapid INR correction; give vitamin K after PCC to prevent rebound INR. Recheck INR at 15-30 minutes and repeat PCC if needed.',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=19',
              medications: ['Vitamin K 10 mg IV over 20 min', '4F-PCC (KCentra) 2000 units IVPB (fixed-dose) or 25-50 IU/kg based on INR (AHA)'],
              conditions: (data) => {
                const meds = (data.telestrokeNote?.medications || '').toLowerCase();
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const onWarfarin = meds.includes('warfarin') || meds.includes('coumadin');
                return isICH && onWarfarin;
              }
            },
            reversal_dabigatran: {
              id: 'reversal_dabigatran',
              category: 'Reversal',
              title: 'Dabigatran reversal in ICH',
              recommendation: 'Administer idarucizumab (Praxbind) 5g IV (2 x 2.5g) for ICH on dabigatran.',
              detail: 'Reversal is immediate with idarucizumab. If unavailable, 4F-PCC 50 IU/kg IV is preferred (aPCC is second-line).',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=19',
              medications: ['Idarucizumab (Praxbind) 5g IV', 'Alt: 4F-PCC 50 IU/kg IV if idarucizumab unavailable', 'Alt: aPCC (FEIBA) 50 IU/kg if both unavailable'],
              conditions: (data) => {
                const meds = (data.telestrokeNote?.medications || '').toLowerCase();
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const onDabigatran = meds.includes('dabigatran') || meds.includes('pradaxa');
                return isICH && onDabigatran;
              }
            },
            reversal_xa_inhibitor: {
              id: 'reversal_xa_inhibitor',
              category: 'Reversal',
              title: 'Factor Xa inhibitor reversal in ICH',
              recommendation: 'Administer 4F-PCC (Kcentra) 2000 units IVPB for ICH on apixaban/rivaroxaban/edoxaban (local protocol).',
              detail: 'AHA/ASA 2022 lists andexanet alfa as Class IIa (LOE B-NR) for Xa inhibitor-associated ICH. 4F-PCC 2000 units IV is a common first-line approach when andexanet is unavailable. PCC shows similar efficacy to andexanet (Panos et al. Crit Care Med 2025). Consult Hematology attending for complex cases or if PCC ineffective.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Spontaneous ICH 2022 (modified per suggested protocol)',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=19',
              medications: ['4F-PCC (Kcentra) 2000 units IV immediately (first-line)', 'Andexanet alfa (Class IIa per AHA/ASA 2022) — check local formulary availability'],
              conditions: (data) => {
                const meds = (data.telestrokeNote?.medications || '').toLowerCase();
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const onXaInhibitor = meds.includes('apixaban') || meds.includes('eliquis') ||
                                      meds.includes('rivaroxaban') || meds.includes('xarelto');
                return isICH && onXaInhibitor;
              }
            },
            antiplatelet_desmopressin: {
              id: 'antiplatelet_desmopressin',
              category: 'Reversal',
              title: 'Antiplatelet-associated ICH: desmopressin',
              recommendation: 'Desmopressin with or without platelet transfusion may be considered for antiplatelet-associated ICH, but effectiveness is uncertain.',
              detail: 'Consider desmopressin 0.3 mcg/kg IV once; evidence is limited and benefits are uncertain.',
              classOfRec: 'IIb',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=23',
              medications: ['Desmopressin 0.3 mcg/kg IV x1'],
              conditions: (data) => {
                const meds = (data.telestrokeNote?.medications || '').toLowerCase();
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const onAntiplatelet = meds.includes('aspirin') || meds.includes('asa') ||
                  meds.includes('clopidogrel') || meds.includes('plavix') ||
                  meds.includes('ticagrelor') || meds.includes('brilinta') ||
                  meds.includes('prasugrel') || meds.includes('effient') ||
                  meds.includes('dipyridamole') || meds.includes('aggrenox');
                return isICH && onAntiplatelet;
              }
            },
            antiplatelet_platelet_transfusion_surgery: {
              id: 'antiplatelet_platelet_transfusion_surgery',
              category: 'Reversal',
              title: 'Platelet transfusion before emergency neurosurgery',
              recommendation: 'For aspirin-associated ICH requiring emergency neurosurgery, platelet transfusion might be considered.',
              detail: 'Consider only when emergent neurosurgery is planned.',
              classOfRec: 'IIb',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=23',
              conditions: (data) => {
                const meds = (data.telestrokeNote?.medications || '').toLowerCase();
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const onAspirin = meds.includes('aspirin') || meds.includes('asa');
                return isICH && onAspirin && !!data.telestrokeNote?.ichNeurosurgeryConsulted;
              }
            },
            antiplatelet_platelet_transfusion_harm: {
              id: 'antiplatelet_platelet_transfusion_harm',
              category: 'Reversal',
              title: 'Avoid platelet transfusion in aspirin-associated ICH (no surgery)',
              recommendation: 'Do NOT give platelet transfusion for aspirin-associated ICH when emergency surgery is not planned.',
              detail: 'Platelet transfusion is potentially harmful in this setting (PATCH trial).',
              classOfRec: 'III',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=23',
              conditions: (data) => {
                const meds = (data.telestrokeNote?.medications || '').toLowerCase();
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const onAspirin = meds.includes('aspirin') || meds.includes('asa');
                return isICH && onAspirin && !data.telestrokeNote?.ichNeurosurgeryConsulted;
              }
            },
            ich_vte_ipc: {
              id: 'ich_vte_ipc',
              category: 'Supportive Care',
              title: 'ICH: IPC for VTE prophylaxis',
              recommendation: 'Start intermittent pneumatic compression (IPC) on the day of diagnosis for VTE prophylaxis.',
              detail: 'IPC reduces DVT/PE risk in nonambulatory ICH patients.',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=29',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            ich_vte_heparin: {
              id: 'ich_vte_heparin',
              category: 'Supportive Care',
              title: 'ICH: pharmacologic VTE prophylaxis timing',
              recommendation: 'SQ heparin 48 hours after IPH onset per local protocol, once hematoma is stable on repeat imaging. SCDs/IPC in the interim.',
              detail: 'Suggested protocol: SQ heparin at 48h after ICH onset. Use SCDs/IPC immediately on admission until pharmacologic prophylaxis initiated. AHA/ASA 2022: Low-dose UFH or LMWH at 24-48h may be reasonable (Class IIb). Balance thrombosis prevention against hematoma expansion risk; obtain a stability CT before starting.',
              classOfRec: 'IIb',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=29',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            ich_vte_stockings: {
              id: 'ich_vte_stockings',
              category: 'Supportive Care',
              title: 'Avoid compression stockings alone in ICH',
              recommendation: 'Graduated compression stockings alone are not beneficial for VTE prophylaxis.',
              detail: 'Use IPC instead; stockings alone do not reduce VTE risk.',
              classOfRec: 'III',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=29',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            ich_seizure_clinical: {
              id: 'ich_seizure_clinical',
              category: 'Seizures',
              title: 'ICH: treat clinical seizures',
              recommendation: 'Treat clinical seizures in ICH with antiseizure medication.',
              detail: 'Levetiracetam is commonly used; avoid routine prophylaxis in patients without seizures.',
              classOfRec: 'I',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=34',
              conditions: (data) => {
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const sx = (data.telestrokeNote?.symptoms || '').toLowerCase();
                return isICH && (sx.includes('seizure') || sx.includes('convulsion'));
              }
            },
            ich_seizure_eeg: {
              id: 'ich_seizure_eeg',
              category: 'Seizures',
              title: 'ICH: treat electrographic seizures',
              recommendation: 'Treat confirmed electrographic seizures in ICH, especially with impaired consciousness.',
              detail: 'Use EEG when mental status is unexplained or fluctuating.',
              classOfRec: 'I',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=34',
              conditions: (data) => {
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const gcs = data.gcsScore || null;
                return isICH && gcs !== null && gcs >= 3 && gcs <= 12;
              }
            },
            ich_seizure_cEEG: {
              id: 'ich_seizure_cEEG',
              category: 'Seizures',
              title: 'ICH: continuous EEG for unexplained mental status',
              recommendation: 'Continuous EEG (at least 24 hours) is reasonable for unexplained or fluctuating mental status in ICH.',
              detail: 'Electrographic seizures are common in impaired consciousness without overt convulsions.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=34',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            ich_seizure_prophylaxis: {
              id: 'ich_seizure_prophylaxis',
              category: 'Seizures',
              title: 'ICH: avoid prophylactic antiseizure meds',
              recommendation: 'Prophylactic antiseizure medication is not beneficial in ICH without seizures.',
              detail: 'Avoid routine prophylaxis unless clinical or electrographic seizures occur. Risk factors for seizures: cortical ICH, lobar location, large hematoma volume. If seizures develop, levetiracetam is preferred first-line agent.',
              classOfRec: 'III',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=34',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            ich_evd_ivh: {
              id: 'ich_evd_ivh',
              category: 'ICH',
              title: 'IVH: EVD for large IVH with decreased consciousness',
              recommendation: 'EVD is recommended for large IVH with impaired consciousness to reduce mortality.',
              detail: 'Use EVD over medical management alone for obstructive hydrocephalus or large IVH.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=39',
              conditions: (data) => {
                const ct = (data.telestrokeNote?.ctResults || '').toLowerCase();
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const hasIVH = ct.includes('ivh') || ct.includes('intraventricular');
                return isICH && hasIVH;
              }
            },
            ich_mis_evac: {
              id: 'ich_mis_evac',
              category: 'ICH',
              title: 'Minimally invasive ICH evacuation (MIE)',
              recommendation: 'For spontaneous lobar IPH 30-80cc, ≤24h onset, NIHSS >5, GCS 5-15, age 18-80, mRS 0-1: consider MIE. Contact MIE neurosurgery (see contact directory).',
              detail: 'Select endoscopic or stereotactic aspiration approaches based on local expertise. Functional outcome benefit is uncertain.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000407#page=37',
              conditions: (data) => {
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const gcs = data.gcsScore || null;
                return isICH && gcs !== null && gcs >= 5 && gcs <= 12;
              }
            },

            // ---------------------------------------------------------------
            // DISPOSITION & TRANSFER
            // ---------------------------------------------------------------
            transfer_evt: {
              id: 'transfer_evt',
              category: 'Disposition',
              title: 'Transfer for EVT evaluation',
              recommendation: 'Transfer LVO patients to EVT-capable center immediately. Do NOT wait for clinical response to IV thrombolysis before initiating transfer.',
              detail: 'Administer TNK at spoke site (if eligible) and initiate transfer simultaneously. Time-to-reperfusion is the critical metric.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              conditions: (data) => {
                const hasLVO = (data.telestrokeNote?.vesselOcclusion || []).some(v =>
                  /ica|m1|mca|basilar/i.test(v)
                );
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                return hasLVO && nihss >= 6;
              }
            },
            cerebellar_ich_surgery: {
              id: 'cerebellar_ich_surgery',
              category: 'Disposition',
              title: 'Cerebellar ICH: surgical evacuation',
              recommendation: 'Urgent surgical evacuation for cerebellar ICH >15 mL with neurological deterioration, brainstem compression, or obstructive hydrocephalus.',
              detail: 'EVD alone insufficient for large cerebellar hemorrhages. Suboccipital craniectomy recommended. Transfer to neurosurgical center emergently.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'Greenberg SM et al. Stroke. 2022;53:e282-e361. DOI: 10.1161/STR.0000000000000407',
              sourceUrl: getGuidelineUrl('AHA/ASA Spontaneous ICH 2022') + '#page=42',
              conditions: (data) => {
                const ct = (data.telestrokeNote?.ctResults || '').toLowerCase();
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const isCerebellar = ct.includes('cerebell') || dx.includes('cerebell') || ct.includes('posterior fossa');
                return isICH && isCerebellar;
              }
            },
            supratentorial_ich_surgery: {
              id: 'supratentorial_ich_surgery',
              category: 'Disposition',
              title: 'Supratentorial ICH: surgery evidence (STICH/STICH-II/MISTIE-III)',
              recommendation: 'Routine open craniotomy for supratentorial ICH is NOT recommended (Class III: No Benefit). Minimally invasive surgery (MIS) with clot reduction to <15 mL may improve functional outcomes and is under active investigation.',
              detail: 'STICH (Lancet 2005): Open craniotomy vs initial conservative Rx — no benefit (n=1033, OR 0.89). STICH-II (Lancet 2013): Early surgery for lobar ICH 10-100 mL, <1 cm from surface — no significant benefit (n=601, OR 0.86). MISTIE-III (Lancet 2019): MIS with tPA clot irrigation — primary endpoint negative, but subgroup achieving residual clot <15 mL had improved mRS 0-3 (adjusted OR 2.58). ENRICH (JAMA 2024): Early MIS with BrainPath for lobar ICH showed improved utility-weighted mRS. CLEAR III (Lancet 2017): intraventricular alteplase reduced mortality but did not improve functional outcome.',
              classOfRec: 'III',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Spontaneous ICH 2022',
              reference: 'STICH: Lancet 2005;365:387-97. STICH-II: Lancet 2013;382:397-408. MISTIE-III: Lancet 2019;393:1021-32.',
              conditions: (data) => {
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const ct = (data.telestrokeNote?.ctResults || '').toLowerCase();
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return isICH && !ct.includes('cerebell') && !dx.includes('cerebell');
              }
            },
            decompressive_craniectomy: {
              id: 'decompressive_craniectomy',
              category: 'Disposition',
              title: 'Decompressive craniectomy for malignant MCA infarction',
              recommendation: 'Consider decompressive craniectomy within 48 hours for malignant MCA infarction with deteriorating neurological status despite medical therapy. Strongest evidence for age <60.',
              detail: 'Age <60: Strongly recommended (Class I, LOE A). NNT 2 for survival, NNT 4 for mRS 0-3. Based on pooled analysis of DECIMAL, DESTINY, HAMLET. Age 61+: Reduces mortality (33% vs 70%) but 32% of survivors have mRS 5 (DESTINY-II). Requires explicit goals-of-care discussion. Consider concurrent palliative care consultation. Class IIb, LOE B-R for age >60.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const age = parseInt(data.telestrokeNote?.age, 10) || 0;
                const isIschemic = data.telestrokeNote?.diagnosisCategory === 'ischemic';
                return isIschemic && nihss >= 15 && age > 0 && age < 60;
              }
            },

            // ---------------------------------------------------------------
            // SECONDARY PREVENTION
            // ---------------------------------------------------------------
            carotid_intervention: {
              id: 'carotid_intervention',
              category: 'Secondary Prevention',
              title: 'Carotid intervention for symptomatic stenosis',
              recommendation: 'Carotid endarterectomy (CEA) or stenting within 2 weeks for symptomatic carotid stenosis 70-99%. Consider for 50-69% based on patient factors.',
              detail: 'CEA preferred if age >70 and suitable anatomy. CAS reasonable if high surgical risk. Benefit diminishes if delayed beyond 2 weeks.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467. DOI: 10.1161/STR.0000000000000375',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000375#page=32',
              conditions: (data) => {
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return cta.includes('carotid') && (cta.includes('stenosis') || cta.includes('occlus'));
              }
            },
            pfo_closure: {
              id: 'pfo_closure',
              category: 'Secondary Prevention',
              title: 'PFO closure for cryptogenic stroke',
              recommendation: 'PFO closure is recommended for patients age 18-60 with cryptogenic ischemic stroke and high-risk PFO features (atrial septal aneurysm, large shunt).',
              detail: 'Based on CLOSE, RESPECT, REDUCE trials. Also antiplatelet therapy. Anticoagulation if concurrent DVT/PE.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467. DOI: 10.1161/STR.0000000000000375',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000375#page=48',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const toast = (data.telestrokeNote?.toastClassification || '').toLowerCase();
                const age = parseInt(data.telestrokeNote?.age, 10) || 0;
                return isIschemic && (dx.includes('cryptogenic') || dx.includes('pfo') || dx.includes('esus') || toast === 'cryptogenic') && age >= 18 && age <= 60;
              }
            },

            adamts13_cryptogenic: {
              id: 'adamts13_cryptogenic',
              category: 'Secondary Prevention',
              title: 'ADAMTS13 testing in cryptogenic stroke workup',
              recommendation: 'Consider ADAMTS13 testing in cryptogenic stroke patients age <50 with platelet count <300K. Order when considering antiphospholipid testing (same trigger).',
              detail: 'TTP can present as cryptogenic stroke without classic hematologic findings. ADAMTS13 <30% → emergent hematology consult for plasma exchange. Lab: reference lab (check local turnaround time — may not be available daily). Send BEFORE day of discharge — low result requires emergent readmission.',
              classOfRec: 'IIb',
              levelOfEvidence: 'C-LD',
              guideline: 'Suggested Protocol; AHA/ASA Secondary Prevention 2021',
              reference: 'Matthews et al. J Stroke Cerebrovasc Dis. 2022;31(6):106431. Chiasakul & Cuker. Hematology. 2018.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const age = parseInt(data.telestrokeNote?.age, 10) || 0;
                const toast = (data.telestrokeNote?.toastClassification || '').toLowerCase();
                return isIschemic && (dx.includes('cryptogenic') || dx.includes('esus') || toast === 'cryptogenic') && age < 50;
              }
            },

            direct_to_angio: {
              id: 'direct_to_angio',
              category: 'EVT',
              title: 'Direct-to-angio for stable LVO transfers',
              recommendation: 'For medically and neurologically STABLE transfer patients with LVO and last neuroimaging <3h who did NOT receive lytics: consider direct-to-angio (bypass repeat imaging in ED).',
              detail: 'Suggested protocol: Goal door-to-puncture ≤45 min for transfer LVO cases. Assessment at triage by ED, Neuro, and IR. If all deem patient stable → transport directly to IR suite. Does NOT apply to: (1) clinical improvement with NIHSS <6, (2) neurologic worsening (NIHSS increase ≥4), (3) patients who received lytics at OSH, (4) unstable medical issues. Applies to transfers from referring facilities.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-EO',
              guideline: 'Suggested Protocol',
              reference: 'Direct to Angio for LVO pts without lytics and within 3h of last neuroimaging.',
              conditions: (data) => {
                const vessels = data.telestrokeNote?.vesselOcclusion || [];
                const hasLVO = vessels.some(v => /ica|m1|basilar/i.test(v));
                return hasLVO && !!data.telestrokeNote?.evtRecommended && !data.telestrokeNote?.tnkRecommended;
              }
            },

            neurosurgery_communication: {
              id: 'neurosurgery_communication',
              category: 'Acute',
              title: 'Neurosurgery consultation protocol',
              recommendation: 'Neurology/stroke attending should approve neurosurgery consultations for IPH or large ischemic stroke. Structured communication reduces unnecessary consultations.',
              detail: 'Suggested protocol: (1) Neurology team evaluates patient and discusses with stroke attending before consulting neurosurgery. (2) If stroke attending recommends against surgery, communicate this clearly. (3) If disagreement, stroke attending and neurosurgery attending discuss directly. (4) Do not recommend surgical procedures to families without a finalized, mutually agreed plan with neurosurgery.',
              classOfRec: 'N/A',
              levelOfEvidence: 'N/A',
              guideline: 'Suggested Protocol',
              reference: 'Communication with Neurosurgery protocol.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isICH = cat === 'ich';
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || data.nihssScore || 0;
                const isLargeIschemic = cat === 'ischemic' && nihss >= 15;
                return isICH || isLargeIschemic;
              }
            },

            // ---------------------------------------------------------------
            // BRIDGING IVT + EVT
            // ---------------------------------------------------------------
            bridging_ivt_evt: {
              id: 'bridging_ivt_evt',
              category: 'EVT',
              title: 'IV thrombolysis before EVT (bridging therapy)',
              recommendation: 'Administer IV thrombolysis to eligible patients even when EVT is planned. Do NOT withhold IVT to expedite EVT (Class I, LOE A).',
              detail: 'SWIFT DIRECT, MR CLEAN NO IV, DIRECT-MT: direct EVT was non-inferior only at high-volume centers with groin puncture achievable within 60 min. Standard of care remains bridging IVT + EVT. Exception: Direct EVT may be reasonable when IVT is contraindicated or groin puncture is achievable within 60 min at a comprehensive stroke center (Class IIb).',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'SWIFT DIRECT (Lancet 2022), MR CLEAN NO IV (Lancet 2022), DIRECT-MT (Lancet 2020)',
              conditions: (data) => {
                return !!data.telestrokeNote?.evtRecommended;
              }
            },

            // ---------------------------------------------------------------
            // ARCADIA ATRIAL CARDIOPATHY
            // ---------------------------------------------------------------
            arcadia_atrial_cardiopathy: {
              id: 'arcadia_atrial_cardiopathy',
              category: 'ESUS/Cryptogenic',
              title: 'No benefit of apixaban for atrial cardiopathy (ARCADIA)',
              recommendation: 'Do NOT prescribe empiric anticoagulation for cryptogenic stroke with atrial cardiopathy markers. Aspirin is appropriate.',
              detail: 'ARCADIA (JAMA 2024): Apixaban 5mg BID vs aspirin 81mg daily in cryptogenic stroke with atrial cardiopathy (P-wave terminal force >5000 uV*ms, NT-proBNP >250, LA enlargement). HR 1.00 for recurrent stroke. Stopped for futility. P-wave abnormalities and elevated NT-proBNP do NOT justify empiric anticoagulation without confirmed AF.',
              classOfRec: 'III',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Secondary Prevention 2024 Update',
              reference: 'Kamel H et al. JAMA. 2024;331(11):981-990. DOI: 10.1001/jama.2024.0840',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('cryptogenic') || dx.includes('esus');
              }
            },

            // ---------------------------------------------------------------
            // LAAO AFTER ICH (STROKE-CLOSE)
            // ---------------------------------------------------------------
            laao_after_ich: {
              id: 'laao_after_ich',
              category: 'ICH',
              title: 'LAA closure after ICH with AF (STROKE-CLOSE)',
              recommendation: 'LAA closure may be reasonable for ICH patients with AF who have high thromboembolic risk and high rebleeding risk, particularly lobar ICH with CAA features.',
              detail: 'STROKE-CLOSE (Lancet 2024): Watchman FLX vs medical therapy in ICH patients with AF. Primary composite (stroke, SE, major bleed, CV death) HR 0.61 favoring LAA closure. Most benefit in lobar ICH. Consider outpatient referral for structural heart/EP evaluation. Limitations: open-label, moderate sample size.',
              classOfRec: 'IIb',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022 + STROKE-CLOSE 2024',
              reference: 'STROKE-CLOSE: Nielsen TH et al. Lancet. 2024.',
              conditions: (data) => {
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const afib = (data.telestrokeNote?.ekgFindings || '').toLowerCase().includes('fib') ||
                             (data.telestrokeNote?.ekgFindings || '').toLowerCase().includes('af');
                return isICH && afib;
              }
            },

            // ---------------------------------------------------------------
            // PREGNANCY + EVT
            // ---------------------------------------------------------------
            pregnancy_evt: {
              id: 'pregnancy_evt',
              category: 'Special Populations',
              title: 'EVT in pregnancy',
              recommendation: 'EVT is reasonable in pregnant patients with LVO when standard eligibility criteria are met. Same indications as non-pregnant patients.',
              detail: 'Use lead shielding over pelvis during angiography. Minimize fluoroscopy time. Coordinate with OB before and after procedure. Gadolinium contrast is avoided in pregnancy but iodinated contrast for EVT is acceptable when benefit outweighs risk. Post-procedure: fetal monitoring. Consider lactation consultation if contrast administered.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Stroke in Pregnancy Scientific Statement 2024',
              reference: 'AHA/ASA Scientific Statement. Stroke. 2024.',
              conditions: (data) => {
                const isPreg = (data.telestrokeNote?.specialPopulations || '').toLowerCase().includes('pregn') ||
                               (data.telestrokeNote?.pmh || '').toLowerCase().includes('pregn');
                return isPreg && !!data.telestrokeNote?.evtRecommended;
              }
            },

            // ---------------------------------------------------------------
            // SUPPORTIVE CARE
            // ---------------------------------------------------------------
            dysphagia_screen: {
              id: 'dysphagia_screen',
              category: 'Supportive Care',
              title: 'Dysphagia screening',
              recommendation: 'Keep patient NPO until formal dysphagia screening is passed. Screen before any oral intake including medications.',
              detail: 'Use validated bedside screening tool (e.g., Yale Swallow Protocol, 3-oz water test). SLP evaluation for failed screens. Aspiration pneumonia is a leading cause of post-stroke mortality.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            vte_prophylaxis: {
              id: 'vte_prophylaxis',
              category: 'Supportive Care',
              title: 'VTE prophylaxis',
              recommendation: 'IPC/SCDs on admission. Post-lytic: SQ heparin at 24h (after stable follow-up imaging). Post-ICH: SQ heparin at 48h (after stable repeat imaging). SCDs in the interim.',
              detail: 'Suggested protocol: Post-thrombolysis — SQ heparin 24h after lytic administration, after follow-up CT shows no hemorrhage. Post-ICH — SQ heparin 48h after IPH onset, after stability CT. IPC/SCDs should be placed on admission for all immobile stroke patients and continued until pharmacologic prophylaxis initiated.',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'AHA Systemic Complications of Acute Stroke 2024',
              reference: 'AHA Scientific Statement 2024. DOI: 10.1161/STR.0000000000000477',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000477#page=6',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            glycemic_management: {
              id: 'glycemic_management',
              category: 'Glycemic',
              title: 'Glycemic management (Class III: Harm for intensive insulin)',
              recommendation: 'Target glucose 140-180 mg/dL. Do NOT use IV insulin to target 80-130 mg/dL (Class III: Harm). Treat hypoglycemia <60 mg/dL emergently.',
              detail: 'SHINE trial demonstrated no benefit and increased hypoglycemia with intensive glucose control (80-130). Subcutaneous insulin sliding scale preferred for mild hyperglycemia.',
              classOfRec: 'III',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000513',
              conditions: (data) => {
                const glucose = parseInt(data.telestrokeNote?.glucose, 10) || 0;
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isStroke = !!cat && cat !== 'mimic';
                return isStroke && (glucose > 180 || glucose < 60 || glucose === 0);
              }
            },
            fever_management: {
              id: 'fever_management',
              category: 'Supportive Care',
              title: 'Fever management',
              recommendation: 'Treat fever (>38C) with acetaminophen and identify source. Maintain normothermia.',
              detail: 'Fever worsens outcomes in stroke. Search for UTI, pneumonia, line infection. Induced hypothermia not recommended outside clinical trials.',
              classOfRec: 'I',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA Systemic Complications of Acute Stroke 2024',
              reference: 'AHA Scientific Statement 2024. DOI: 10.1161/STR.0000000000000477',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000477#page=4',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },

            // ---------------------------------------------------------------
            // GOALS OF CARE
            // ---------------------------------------------------------------
            goc_ich: {
              id: 'goc_ich',
              category: 'Goals of Care',
              title: 'Goals-of-care discussion in ICH',
              recommendation: 'Initiate goals-of-care discussion for ICH Score >= 3. Avoid early DNR orders that may limit aggressive care in first 24-48 hours.',
              detail: 'Self-fulfilling prophecy of early care withdrawal is well-documented in ICH. Recommend full care for minimum 24-48 hours while prognostic picture clarifies. ICH Score is for prognostication, not to determine treatment limits.',
              classOfRec: 'I',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Spontaneous ICH 2022 + AHA Palliative Care in Stroke 2024',
              reference: 'Greenberg SM et al. Stroke. 2022. DOI: 10.1161/STR.0000000000000407; AHA 2024. DOI: 10.1161/STR.0000000000000479',
              conditions: (data) => {
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const ichScore = data.ichScore || 0;
                return isICH && ichScore >= 3;
              }
            },

            // ---------------------------------------------------------------
            // SAH MANAGEMENT (2023 AHA/ASA Aneurysmal SAH)
            // ---------------------------------------------------------------
            sah_bp_presecuring: {
              id: 'sah_bp_presecuring',
              category: 'SAH Management',
              title: 'SAH: BP management (pre-aneurysm securing)',
              recommendation: 'Target SBP <160 mmHg before aneurysm is secured. Avoid SBP >160 to reduce rebleeding risk.',
              detail: 'Use short-acting IV agents (nicardipine or labetalol) for rapid titration. Avoid nitroprusside (may increase ICP). Balance between rebleed prevention and cerebral perfusion.',
              classOfRec: 'I',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA/ASA Aneurysmal SAH 2023',
              reference: 'Hoh BL et al. Stroke. 2023;54:e314-e370. DOI: 10.1161/STR.0000000000000436',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000436#page=13',
              medications: ['Nicardipine 5 mg/hr IV (titrate to 15 mg/hr)', 'Labetalol 10-20 mg IV bolus PRN'],
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'sah' && !data.telestrokeNote?.sahAneurysmSecured;
              }
            },
            sah_bp_postsecuring: {
              id: 'sah_bp_postsecuring',
              category: 'SAH Management',
              title: 'SAH: BP management (post-aneurysm securing)',
              recommendation: 'After aneurysm secured: target SBP <140 mmHg baseline. During vasospasm/DCI window (days 4-14), induced hypertension with SBP target 160-200 may be used as rescue for symptomatic DCI.',
              detail: 'Post-securing targets are less restrictive than pre-securing since rebleed risk is eliminated. During the DCI window, maintain euvolemia with isotonic saline — prophylactic hypervolemia/triple-H therapy is NOT recommended (Class III: No Benefit). Induced hypertension should only be initiated for symptomatic vasospasm/DCI (new focal deficit or declining exam) after aneurysm is secured. Consider endovascular rescue (intra-arterial verapamil/nicardipine, balloon angioplasty) for refractory vasospasm.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Aneurysmal SAH 2023',
              reference: 'Hoh BL et al. Stroke. 2023;54:e314-e370.',
              medications: ['Vasopressor augmentation for symptomatic DCI: phenylephrine or norepinephrine drip to SBP 160-200', 'Maintain euvolemia with isotonic saline (avoid hypotonic fluids)'],
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'sah' && !!data.telestrokeNote?.sahAneurysmSecured;
              }
            },
            sah_nimodipine: {
              id: 'sah_nimodipine',
              category: 'SAH Management',
              title: 'SAH: Nimodipine for vasospasm prevention',
              recommendation: 'Administer nimodipine 60 mg PO/NG q4h for 21 days. Begin as soon as possible after SAH diagnosis.',
              detail: 'Only calcium channel blocker proven to improve outcomes after SAH. Reduces DCI, not angiographic vasospasm — this distinction matters (CONSCIOUS-1/2/3: clazosentan reduced angiographic vasospasm but NO improvement in functional outcome, stopped for futility; confirms vasospasm ≠ DCI). If hypotension occurs, reduce to 30 mg q2h. Do not give IV. Hepatic impairment (Child-Pugh A/B): reduce to 30 mg q4h; Child-Pugh C: avoid or 30 mg q6h with close monitoring. Caution with CYP3A4 inhibitors (azoles, macrolides, protease inhibitors). Administer ≥1h before or 2h after meals.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Aneurysmal SAH 2023',
              reference: 'Hoh BL et al. Stroke. 2023;54:e314-e370. DOI: 10.1161/STR.0000000000000436',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000436#page=26',
              medications: ['Nimodipine 60 mg PO/NG q4h x 21 days'],
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'sah';
              }
            },
            sah_seizure: {
              id: 'sah_seizure',
              category: 'SAH Management',
              title: 'SAH: Seizure management',
              recommendation: 'Short-term (3-7 day) seizure prophylaxis may be considered. Routine long-term prophylaxis is NOT recommended.',
              detail: 'Consider levetiracetam over phenytoin (phenytoin associated with worse cognitive outcomes). Continuous EEG monitoring for poor-grade SAH (HH 4-5). Routine prophylactic AEDs beyond 7 days are associated with harm.',
              classOfRec: 'IIb',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Aneurysmal SAH 2023',
              reference: 'Hoh BL et al. Stroke. 2023;54:e314-e370. DOI: 10.1161/STR.0000000000000436',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000436#page=31',
              medications: ['Levetiracetam 500-1000 mg IV/PO q12h (preferred)', 'Avoid phenytoin if possible'],
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'sah';
              }
            },
            sah_aneurysm_securing: {
              id: 'sah_aneurysm_securing',
              category: 'SAH Management',
              title: 'SAH: Early aneurysm securing (clip or coil)',
              recommendation: 'Secure ruptured aneurysm as early as feasible, ideally within 24 hours to reduce rebleeding risk.',
              detail: 'ISAT (Lancet 2002, n=2143): Coiling superior to clipping for aneurysms amenable to both (23.7% vs 30.6% poor outcome at 1 yr; long-term follow-up: benefit maintained at 10 yr, higher retreatment with coils). BRAT (J Neurosurg 2015, 6-yr update): Equivalent outcomes between clip and coil at 6 yr, with higher retreatment for coils. Endovascular coiling preferred for posterior circulation and elderly. Microsurgical clipping may be preferred for MCA aneurysms, large hematomas requiring evacuation, or wide-neck aneurysms. Multidisciplinary decision.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Aneurysmal SAH 2023',
              reference: 'Hoh BL et al. Stroke. 2023;54:e314-e370. DOI: 10.1161/STR.0000000000000436',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000436#page=14',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'sah' && !data.telestrokeNote?.sahAneurysmSecured;
              }
            },
            sah_euvolemia: {
              id: 'sah_euvolemia',
              category: 'SAH Management',
              title: 'SAH: Euvolemia maintenance',
              recommendation: 'Maintain euvolemia with isotonic crystalloids. Avoid hypovolemia and prophylactic hypervolemia (triple-H therapy is NOT recommended).',
              detail: 'Target euvolemia with isotonic saline. Monitor for cerebral salt wasting and SIADH. Induced hypertension may be considered as rescue for symptomatic DCI after aneurysm securing.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Aneurysmal SAH 2023',
              reference: 'Hoh BL et al. Stroke. 2023;54:e314-e370. DOI: 10.1161/STR.0000000000000436',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000436#page=20',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'sah';
              }
            },
            sah_evd: {
              id: 'sah_evd',
              category: 'SAH Management',
              title: 'SAH: External ventricular drain (EVD)',
              recommendation: 'Place EVD for acute hydrocephalus or poor-grade SAH (Hunt & Hess 3-5) with decreased level of consciousness.',
              detail: 'CSF diversion improves outcomes in acute hydrocephalus. Monitor for ventriculitis. Consider weaning after aneurysm securing and clinical improvement.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Aneurysmal SAH 2023',
              reference: 'Hoh BL et al. Stroke. 2023;54:e314-e370. DOI: 10.1161/STR.0000000000000436',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000436#page=30',
              conditions: (data) => {
                const isSAH = data.telestrokeNote?.diagnosisCategory === 'sah';
                const grade = parseInt(data.telestrokeNote?.sahGrade, 10) || 0;
                return isSAH && grade >= 3;
              }
            },

            // ---------------------------------------------------------------
            // CVT MANAGEMENT (2024 AHA Cerebral Venous Thrombosis)
            // ---------------------------------------------------------------
            cvt_anticoag_acute: {
              id: 'cvt_anticoag_acute',
              category: 'CVT Management',
              title: 'CVT: Acute anticoagulation',
              recommendation: 'Initiate therapeutic anticoagulation with LMWH or UFH, even in the presence of hemorrhagic infarction or small parenchymal hemorrhage.',
              detail: 'LMWH preferred over UFH in most cases. Enoxaparin 1 mg/kg q12h or weight-based UFH with aPTT target 60-80s. Hemorrhagic transformation is NOT a contraindication. For large parenchymal hemorrhages, individualize decision.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA Cerebral Venous Thrombosis 2024',
              reference: 'Saposnik G et al. Stroke. 2024. DOI: 10.1161/STR.0000000000000456',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000456#page=6',
              medications: ['Enoxaparin 1 mg/kg SC q12h', 'UFH weight-based (aPTT 60-80s)'],
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('cvt') || dx.includes('venous thrombosis') || dx.includes('cerebral venous') || dx.includes('dural sinus');
              }
            },
            cvt_anticoag_longterm: {
              id: 'cvt_anticoag_longterm',
              category: 'CVT Management',
              title: 'CVT: Long-term anticoagulation',
              recommendation: 'Transition to warfarin (INR 2-3) for 3-12 months. DOACs may be considered as alternative in provoked CVT without severe features.',
              detail: 'Duration: 3-6 months for provoked CVT, 6-12 months for unprovoked, indefinite if recurrent VTE or severe thrombophilia. ACTION-CVT supports DOAC non-inferiority for mild-moderate CVT. Warfarin preferred for severe CVT or antiphospholipid syndrome.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA Cerebral Venous Thrombosis 2024',
              reference: 'Saposnik G et al. Stroke. 2024. DOI: 10.1161/STR.0000000000000456',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000456#page=6',
              medications: ['Warfarin target INR 2-3', 'DOAC alternative: rivaroxaban 20 mg or apixaban 5 mg BID'],
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('cvt') || dx.includes('venous thrombosis') || dx.includes('cerebral venous') || dx.includes('dural sinus');
              }
            },
            cvt_icp_management: {
              id: 'cvt_icp_management',
              category: 'CVT Management',
              title: 'CVT: Elevated ICP management',
              recommendation: 'Monitor for elevated ICP and neurologic deterioration in CVT. Consider decompressive craniectomy for malignant edema with impending herniation.',
              detail: 'Severe CVT with parenchymal lesions and mass effect should prompt emergent neurosurgical evaluation. Decompressive craniectomy is a lifesaving option in selected patients.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA Cerebral Venous Thrombosis 2024',
              reference: 'Saposnik G et al. Stroke. 2024. DOI: 10.1161/STR.0000000000000456',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000456#page=8',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('cvt') || dx.includes('venous thrombosis') || dx.includes('cerebral venous') || dx.includes('dural sinus');
              }
            },
            cvt_seizure: {
              id: 'cvt_seizure',
              category: 'CVT Management',
              title: 'CVT: Seizure management',
              recommendation: 'Seizure prophylaxis is reasonable for CVT with supratentorial parenchymal lesions. Treat acute seizures with standard ASMs.',
              detail: 'Seizures occur in ~40% of CVT patients. Supratentorial hemorrhagic or ischemic lesions increase risk. Levetiracetam preferred. Duration: typically 3-6 months, taper if seizure-free and lesion resolved.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA Cerebral Venous Thrombosis 2024',
              reference: 'Saposnik G et al. Stroke. 2024. DOI: 10.1161/STR.0000000000000456',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000456#page=2',
              medications: ['Levetiracetam 500-1000 mg PO/IV q12h'],
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('cvt') || dx.includes('venous thrombosis') || dx.includes('cerebral venous') || dx.includes('dural sinus');
              }
            },
            cvt_thrombophilia: {
              id: 'cvt_thrombophilia',
              category: 'CVT Management',
              title: 'CVT: Thrombophilia workup',
              recommendation: 'Evaluate for underlying thrombophilia in unprovoked CVT, especially in young patients. Defer testing until after acute phase if possible.',
              detail: 'Test for: Factor V Leiden, prothrombin G20210A, antithrombin III, protein C/S, antiphospholipid antibodies. Hormonal risk factors (OCP, pregnancy) are most common provoked cause. TIMING: Do NOT test protein C, protein S, or antithrombin during acute admission — levels are reduced by acute thrombosis, heparin (AT), and warfarin (protein C/S). Defer to outpatient testing at 2-4 weeks, off anticoagulation for protein-based assays. Genetic tests (FVL, PT G20210A) and APL antibodies can be sent acutely.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA Cerebral Venous Thrombosis 2024',
              reference: 'Saposnik G et al. Stroke. 2024. DOI: 10.1161/STR.0000000000000456',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000456#page=2',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const age = parseInt(data.telestrokeNote?.age, 10) || 0;
                return (dx.includes('cvt') || dx.includes('venous thrombosis') || dx.includes('cerebral venous') || dx.includes('dural sinus')) && age <= 60;
              }
            },

            // ---------------------------------------------------------------
            // TIA-SPECIFIC RECOMMENDATIONS
            // ---------------------------------------------------------------
            tia_admit: {
              id: 'tia_admit',
              category: 'TIA',
              title: 'TIA: Hospital admission',
              recommendation: 'Admit ALL TIA patients for urgent workup regardless of ABCD2 score.',
              detail: 'Inpatient evaluation allows rapid completion of workup (MRI DWI, CTA, cardiac monitoring, labs) and early initiation of secondary prevention. Reduces 90-day stroke risk by 80% compared to outpatient evaluation.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021 + 2026 Update',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467; Powers WJ et al. Stroke. 2026.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('tia');
              }
            },
            tia_mri_dwi: {
              id: 'tia_mri_dwi',
              category: 'TIA',
              title: 'TIA: MRI with DWI',
              recommendation: 'Obtain MRI with DWI for all TIA patients to evaluate for acute infarction.',
              detail: 'DWI-positive TIA (i.e., tissue-based minor stroke) carries higher recurrence risk. MRI also helps classify etiology. If MRI unavailable, CT is acceptable but inferior for small infarct detection.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('tia');
              }
            },
            tia_vascular_imaging: {
              id: 'tia_vascular_imaging',
              category: 'TIA',
              title: 'TIA: Vascular imaging (CTA/MRA)',
              recommendation: 'Obtain CTA or MRA of head and neck for all TIA patients to evaluate for large artery stenosis or occlusion.',
              detail: 'Identifies symptomatic carotid stenosis (CEA/CAS candidate), intracranial stenosis (DAPT candidate), or dissection. Urgent imaging within 24 hours preferred.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('tia');
              }
            },
            tia_cardiac_monitoring: {
              id: 'tia_cardiac_monitoring',
              category: 'TIA',
              title: 'TIA: Cardiac monitoring for AF detection',
              recommendation: 'Perform cardiac monitoring for AF detection: 30-day ambulatory monitor preferred, 14-day patch if unavailable, ILR in select cases.',
              detail: 'AF is found in up to 25% of cryptogenic stroke/TIA with prolonged monitoring. 30-day event monitor (e.g., Zio AT) is preferred. If unavailable, 14-day continuous patch (e.g., Zio Patch). ILR (e.g., LINQ) considered if high suspicion and no AF detected on ambulatory monitoring.',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021 + 2026 Update',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467; CRYSTAL-AF, EMBRACE trials.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('tia');
              }
            },
            tia_echo: {
              id: 'tia_echo',
              category: 'TIA',
              title: 'TIA: Echocardiography',
              recommendation: 'Obtain echocardiography (TTE with bubble study; TEE if PFO or structural pathology suspected).',
              detail: 'Identifies PFO, atrial septal aneurysm, valvular disease, or intracardiac thrombus. PFO closure may be indicated based on PASCAL classification in appropriate patients.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('tia');
              }
            },
            tia_dapt: {
              id: 'tia_dapt',
              category: 'TIA',
              title: 'TIA: DAPT for high-risk TIA',
              recommendation: 'Start DAPT (aspirin + clopidogrel) within 24 hours for high-risk TIA, continue for 21 days, then single antiplatelet.',
              detail: 'Loading: ASA 325 mg + clopidogrel 300 mg. Maintenance: ASA 81 mg + clopidogrel 75 mg x 21 days. Based on CHANCE/POINT/THALES trials. High-risk TIA = ABCD2 >=4 or DWI+ on MRI.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467.',
              medications: ['ASA 325 mg load then 81 mg daily', 'Clopidogrel 300 mg load then 75 mg daily x 21 days'],
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('tia');
              }
            },

            // ---------------------------------------------------------------
            // CERVICAL ARTERY DISSECTION
            // ---------------------------------------------------------------
            dissection_antithrombotic: {
              id: 'dissection_antithrombotic',
              category: 'Dissection',
              title: 'Cervical artery dissection: Antithrombotic therapy',
              recommendation: 'Antiplatelet or anticoagulation for cervical artery dissection. Either approach is reasonable (no proven superiority of one over the other).',
              detail: 'CADISS trial showed no significant difference between antiplatelet and anticoagulation. Choice depends on clinical factors: anticoagulation may be preferred for pseudoaneurysm, free-floating thrombus, or recurrent events on antiplatelet. Duration: typically 3-6 months.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'CADISS Trial Investigators. Lancet Neurol. 2015;14:361-367.',
              medications: ['ASA 81-325 mg daily', 'OR Heparin bridge to warfarin (INR 2-3)', 'OR DOAC (off-label, growing evidence)'],
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return dx.includes('dissect') || cta.includes('dissect');
              }
            },
            dissection_imaging_followup: {
              id: 'dissection_imaging_followup',
              category: 'Dissection',
              title: 'Cervical artery dissection: Imaging follow-up',
              recommendation: 'Repeat vascular imaging (CTA or MRA) at 3-6 months to assess for recanalization or pseudoaneurysm evolution.',
              detail: 'Most dissections heal within 3-6 months. Persistent stenosis/occlusion or pseudoaneurysm may warrant continued antithrombotic therapy. If fully recanalized, may consider stopping anticoagulation and switching to antiplatelet.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return dx.includes('dissect') || cta.includes('dissect');
              }
            },
            dissection_avoid_manipulation: {
              id: 'dissection_avoid_manipulation',
              category: 'Dissection',
              title: 'Cervical artery dissection: Avoid cervical manipulation',
              recommendation: 'Advise patients to avoid cervical manipulation (chiropractic, aggressive physical therapy) during healing phase.',
              detail: 'While causation is debated, cervical manipulation is associated with vertebral and carotid dissection. Patients should avoid high-velocity neck movements during the healing period (minimum 3 months).',
              classOfRec: 'IIb',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return dx.includes('dissect') || cta.includes('dissect');
              }
            },
            dissection_no_thrombolysis_contraindication: {
              id: 'dissection_no_thrombolysis_contraindication',
              category: 'Dissection',
              title: 'Dissection: TNK is NOT contraindicated',
              recommendation: 'Cervical artery dissection is NOT an absolute contraindication to IV thrombolysis if within the treatment window.',
              detail: 'Observational data suggests IV thrombolysis in dissection-related stroke is safe and may be beneficial. Treat according to standard TNK eligibility criteria.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                const timeFrom = data.timeFromLKW;
                return (dx.includes('dissect') || cta.includes('dissect')) && timeFrom && timeFrom.total <= 4.5;
              }
            },

            // ---------------------------------------------------------------
            // SPECIAL POPULATIONS
            // ---------------------------------------------------------------
            pregnancy_stroke: {
              id: 'pregnancy_stroke',
              category: 'Special Populations',
              title: 'Stroke in pregnancy',
              recommendation: 'Pregnancy should not delay acute stroke care. IV thrombolysis may be considered when benefits outweigh risks; EVT preferred for LVO. Consult OB immediately.',
              detail: 'Maternal stroke statement: CT/CTA or MRI are acceptable; lead shielding is not recommended. Alteplase/tenecteplase do not cross placenta; weigh bleeding risk, especially early postpartum or recent cesarean/neuraxial anesthesia. Low-dose aspirin is safe; LMWH is preferred anticoagulant in pregnancy; avoid warfarin in first trimester.',
              classOfRec: 'IIb',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA Maternal Stroke in Pregnancy and Postpartum 2026',
              reference: 'Miller E et al. Stroke. 2026. DOI: 10.1161/STR.0000000000000514',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000514#page=10',
              conditions: (data) => {
                const checklist = data.telestrokeNote?.tnkContraindicationChecklist || {};
                return !!checklist.pregnancy || !!data.telestrokeNote?.pregnancyStroke;
              }
            },

            // ---------------------------------------------------------------
            // DISCHARGE / SECONDARY PREVENTION
            // ---------------------------------------------------------------
            discharge_antiplatelet: {
              id: 'discharge_antiplatelet',
              category: 'Discharge',
              title: 'Discharge: Antiplatelet or anticoagulation',
              recommendation: 'Ensure appropriate antithrombotic therapy is prescribed at discharge. Antiplatelet for non-cardioembolic stroke; anticoagulation for AF-related stroke.',
              detail: 'ASA 81-325 mg, clopidogrel 75 mg, or DAPT based on stroke subtype. DOAC for AF (apixaban preferred). Verify no gaps in medication reconciliation.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467. DOI: 10.1161/STR.0000000000000375',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return cat === 'ischemic' || cat === 'tia';
              }
            },
            discharge_statin: {
              id: 'discharge_statin',
              category: 'Discharge',
              title: 'Discharge: High-intensity statin',
              recommendation: 'Prescribe high-intensity statin at discharge with LDL target <70 mg/dL for ischemic stroke/TIA patients.',
              detail: 'Atorvastatin 80 mg or rosuvastatin 20-40 mg. Add ezetimibe if not at goal. Verify statin is on discharge medication list.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467. DOI: 10.1161/STR.0000000000000375',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000375#page=21',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return cat === 'ischemic' || cat === 'tia';
              }
            },
            discharge_bp_management: {
              id: 'discharge_bp_management',
              category: 'Discharge',
              title: 'Discharge: BP optimization',
              recommendation: 'Initiate or optimize antihypertensive therapy at discharge targeting BP <130/80 for secondary stroke prevention.',
              detail: 'ACE inhibitor or ARB + thiazide diuretic preferred. Initiate after 24-48 hours for ischemic stroke. Individualize timing for ICH (may start earlier). SBP <120 may be considered for selected patients (Class IIa, ESPRIT 2024). Use caution with bilateral severe carotid stenosis or orthostatic symptoms.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467. DOI: 10.1161/STR.0000000000000375',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000375#page=20',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },

            // ---------------------------------------------------------------
            // ICH ANTICOAGULATION RESUMPTION
            // ---------------------------------------------------------------
            ich_anticoag_resumption: {
              id: 'ich_anticoag_resumption',
              category: 'ICH Management',
              title: 'Anticoagulation resumption after ICH',
              recommendation: 'Anticoagulation resumption after ICH should be individualized based on ICH location, CHA\u2082DS\u2082-VASc score, and recurrent hemorrhage risk. Non-lobar ICH with high thromboembolic risk may benefit from DOAC reinitiation at 4-8 weeks.',
              detail: 'PRESTIGE-AF (2025): DOACs dramatically reduced ischemic stroke (HR 0.05) but increased recurrent ICH (HR 10.89). ENRICH-AF halted lobar ICH enrollment due to excess recurrent hemorrhage. For non-lobar ICH with CHA\u2082DS\u2082-VASc \u22654, DOAC reinitiation is reasonable after shared decision-making at 4-8 weeks. For lobar ICH (possible CAA), consider LAAO or avoidance of anticoagulation. DOACs preferred over warfarin when anticoagulation is chosen.',
              classOfRec: 'IIb',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Spontaneous ICH 2022 + PRESTIGE-AF/ENRICH-AF 2025',
              reference: 'PRESTIGE-AF: Lancet 2025; SoSTART: Lancet Neurol 2021; APACHE-AF: Lancet Neurol 2021',
              conditions: (data) => {
                const isICH = data.telestrokeNote?.diagnosisCategory === 'ich';
                const hasAF = (data.telestrokeNote?.pmh || '').toLowerCase().includes('fib') || (data.telestrokeNote?.pmh || '').toLowerCase().includes('af');
                return isICH && hasAF;
              }
            },

            // ---------------------------------------------------------------
            // CAROTID REVASCULARIZATION
            // ---------------------------------------------------------------
            carotid_symptomatic: {
              id: 'carotid_symptomatic',
              category: 'Carotid',
              title: 'Symptomatic carotid stenosis management',
              recommendation: 'For symptomatic carotid stenosis \u226550%, CEA within 2 weeks is recommended. Optimal medical management is the foundation for all patients.',
              detail: 'Symptomatic = stroke/TIA referable to the carotid territory within 6 months. CEA remains Class I for symptomatic stenosis \u226550%. Intensive medical management includes SBP <130, LDL <70, high-intensity statin, and antiplatelet therapy. CAS is an alternative for patients at high surgical risk.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Stroke Prevention 2021',
              reference: 'Kleindorfer DO et al. Stroke. 2021;52:e364-e467',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000375#page=32',
              conditions: (data) => {
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return cta.includes('carotid') && (cta.includes('stenosis') || cta.includes('occlusion'));
              }
            },
            carotid_asymptomatic: {
              id: 'carotid_asymptomatic',
              category: 'Carotid',
              title: 'Asymptomatic carotid stenosis (CREST-2)',
              recommendation: 'For asymptomatic carotid stenosis \u226570%, intensive medical management alone is the primary approach. CEA is NOT superior to intensive medical management (CREST-2, 2025).',
              detail: 'CREST-2 (NEJM 2025): CEA + intensive medical management did NOT significantly reduce stroke/death vs. intensive medical management alone. CAS + intensive medical management showed modest benefit (NNT=31 at 4 years) at high-volume centers. Intensive medical management protocol: SBP <130, LDL <70 (add PCSK9i if needed), health coaching, smoking cessation. Annual duplex surveillance recommended.',
              classOfRec: 'IIa',
              levelOfEvidence: 'A',
              guideline: 'CREST-2 (NEJM 2025); ECST-2 (Lancet Neurol 2025)',
              reference: 'CREST-2: NEJM 2025; ECST-2: Lancet Neurology 2025',
              conditions: (data) => {
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return cta.includes('carotid') && (cta.includes('stenosis') || cta.includes('narrowing'));
              }
            },

            // ---------------------------------------------------------------
            // ESUS / CRYPTOGENIC STROKE
            // ---------------------------------------------------------------
            esus_monitoring: {
              id: 'esus_monitoring',
              category: 'ESUS/Cryptogenic',
              title: 'Prolonged cardiac monitoring for cryptogenic stroke',
              recommendation: 'For cryptogenic/ESUS stroke, prolonged cardiac monitoring (\u226514 days, ideally implantable loop recorder) is recommended to detect occult AF.',
              detail: 'ACC 2024 ECDP: \u226514 days monitoring, especially if patient is anticoagulation candidate. ILR as initial strategy reasonable in select high-risk patients. PER-DIEM trial: ILR detected AF in 15.3% vs 4.7% with 30-day monitor at 1 year. If AF detected, transition to anticoagulation. NAVIGATE-ESUS, RE-SPECT ESUS, ATTICUS, ARCADIA: routine empiric anticoagulation NOT recommended for ESUS (Class III).',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'ACC Expert Consensus Decision Pathway 2024',
              reference: '2024 ACC ECDP; JACC 2024. PER-DIEM: Lancet Neurol 2024.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const toast = (data.telestrokeNote?.toastClassification || '').toLowerCase();
                return dx.includes('cryptogenic') || dx.includes('esus') || toast.includes('cryptogenic') || toast.includes('undetermined');
              }
            },

            // ---------------------------------------------------------------
            // DOAC TIMING IN AF-STROKE (CATALYST)
            // ---------------------------------------------------------------
            doac_timing_af: {
              id: 'doac_timing_af',
              category: 'Antithrombotic',
              title: 'Early DOAC initiation in AF-related stroke (CATALYST)',
              recommendation: 'For AF-related ischemic stroke without large hemorrhagic transformation, DOAC initiation within 4 days reduces recurrent ischemic stroke vs. later initiation (\u22655 days).',
              detail: 'CATALYST IPDMA (Lancet 2025, n=5,441): Early DOAC (≤4 days) reduced primary composite (recurrent ischemic stroke, sICH, or unclassified stroke) by 30% (OR 0.70, P=0.039). No increase in sICH. Timing guidance for MEDICALLY MANAGED strokes: Mild (NIHSS ≤8): start ≤4 days. Moderate (NIHSS 8-15): 3-5 days. Severe/large HT: 6-14 days. POST-THROMBOLYSIS CAVEAT: CATALYST enrolled predominantly medically managed strokes. If IV TNK/tPA was given, defer DOAC by 3-5 additional days (peak hemorrhagic transformation risk day 1-3 post-thrombolysis). Repeat imaging at day 2-3 to rule out symptomatic HT before starting DOAC. Post-TNK timing: Mild post-TNK → day 3-5; Moderate post-TNK → day 5-7; Severe post-TNK → day 7-14.',
              classOfRec: 'IIa',
              levelOfEvidence: 'A',
              guideline: 'CATALYST IPDMA 2025',
              reference: 'CATALYST: Lancet 2025. Pooled TIMING, ELAN, OPTIMAS, START.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const hasAF = (data.telestrokeNote?.pmh || '').toLowerCase().includes('fib') || (data.telestrokeNote?.pmh || '').toLowerCase().includes('af');
                return isIschemic && hasAF;
              }
            },

            // ---------------------------------------------------------------
            // HEMORRHAGIC TRANSFORMATION
            // ---------------------------------------------------------------
            hemorrhagic_transformation: {
              id: 'hemorrhagic_transformation',
              category: 'Complications',
              title: 'Hemorrhagic transformation management',
              recommendation: 'Classify hemorrhagic transformation using ECASS criteria (HI-1, HI-2, PH-1, PH-2). Symptomatic ICH (PH-2 or neurological worsening) requires emergent management.',
              detail: 'ECASS Classification: HI-1 (small petechiae along infarct margin), HI-2 (confluent petechiae within infarct, no mass effect), PH-1 (blood clots ≤30% of infarct, mild mass effect), PH-2 (blood clots >30% with significant mass effect). SYMPTOMATIC HT MANAGEMENT (PH-2 or NIHSS worsening ≥4): (1) STOP TNK infusion immediately if still running. (2) STAT CT head. (3) STAT labs: CBC, PT/INR, aPTT, fibrinogen, type & screen. (4) Cryoprecipitate 10 units IV (target fibrinogen >200 mg/dL); give empirically if fibrinogen result delayed. (5) TXA 1g IV over 10 min AFTER cryoprecipitate started. (6) Platelet transfusion 6-10 units if platelets <100K; recheck CBC 15-30 min post-transfusion. (7) Hold all antithrombotics and antiplatelet agents. (8) Target SBP <140 mmHg. (9) NEUROSURGERY CONSULTATION for: ICH volume >30 mL, >30% hematoma expansion, IVH with mass effect, midline shift >5 mm, herniation risk, or refractory coagulopathy. (10) ICU admission for PH-1/PH-2. (11) Repeat imaging at 24h.',
              classOfRec: 'I',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026.',
              conditions: (data) => {
                return !!data.telestrokeNote?.tnkAdminTime || !!data.telestrokeNote?.hemorrhagicTransformation?.detected;
              }
            },

            angioedema_post_tnk: {
              id: 'angioedema_post_tnk',
              category: 'Complications',
              title: 'Post-thrombolysis orolingual angioedema',
              recommendation: 'Monitor for orolingual angioedema after TNK, especially in patients on ACE inhibitors. Occurs in 1-5% of tPA/TNK recipients, typically within 2 hours. Immediate airway assessment is critical.',
              detail: 'Stepwise management: 1) Stop TNK infusion if still running + hold ACEi. 2) Methylprednisolone 125 mg IV + Diphenhydramine 50 mg IV + Famotidine 20 mg IV. 3) If progressing: Epinephrine 0.3 mg IM (1:1000). 4) Refractory: Icatibant 30 mg SC (bradykinin B2 receptor antagonist) or C1 esterase inhibitor concentrate 20 U/kg IV. 5) Prepare for intubation if tongue/floor of mouth involvement. Risk factors: ACE inhibitor use (5x risk), anterior circulation infarcts involving insular cortex.',
              classOfRec: 'I',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026. Yayan J. Int J Gen Med. 2013;6:539-544.',
              conditions: (data) => {
                return !!data.telestrokeNote?.angioedema?.detected || (!!data.telestrokeNote?.tnkAdminTime && (data.telestrokeNote?.medications || '').toLowerCase().match(/lisinopril|enalapril|ramipril|captopril|benazepril|fosinopril|perindopril|quinapril|trandolapril|ace.?i/));
              }
            },

            // ---------------------------------------------------------------
            // HYPERGLYCEMIA (2026 UPDATE)
            // ---------------------------------------------------------------
            hyperglycemia_acute: {
              id: 'hyperglycemia_acute',
              category: 'Supportive Care',
              title: 'Hyperglycemia management in acute stroke (2026 update)',
              recommendation: 'Target glucose 140-180 mg/dL. Initiate insulin when glucose persistently >180 mg/dL. Intensive glucose lowering to 80-130 mg/dL with IV insulin is Class III (Harm).',
              detail: 'Intensive glycemic control (80-130 mg/dL) caused symptomatic hypoglycemia in 1-in-9 patients and is explicitly recommended against. Protocol: critically ill/post-TNK patients: start IV insulin infusion with q1h glucose checks; transition to basal-bolus SC when stabilized. Sliding-scale SC insulin for less acute. Avoid glucose <70 mg/dL (neuronal injury risk). ADA 2026 aligned: 100-180 mg/dL for non-critically ill hospitalized patients.',
              classOfRec: 'III',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026; ADA Standards of Care 2026.',
              caveats: 'Class III: Harm applies to the intensive target of 80-130 mg/dL, NOT to treating hyperglycemia above 180.',
              conditions: (data) => {
                const glucose = parseFloat(data.telestrokeNote?.glucose) || 0;
                return glucose > 180;
              }
            },

            // ---------------------------------------------------------------
            // SEIZURE MANAGEMENT (UPDATED 2025)
            // ---------------------------------------------------------------
            seizure_acute_stroke: {
              id: 'seizure_acute_stroke',
              category: 'Supportive Care',
              title: 'Post-stroke seizure management (2025 update)',
              recommendation: 'Prophylactic antiseizure medications are NOT recommended routinely. If seizures occur, levetiracetam or lamotrigine are preferred. Avoid phenytoin and valproic acid.',
              detail: 'Primary prophylaxis: generally not recommended (Cochrane review: no clear benefit). Early seizures (within 7 days): low recurrence risk (10-20%), consider short-term treatment with taper. Late/unprovoked seizures (>7 days): 70% 10-year recurrence, long-term ASM recommended. Preferred agents (2025 network meta-analysis, Neurology): Levetiracetam (fewest recurrences, good tolerability), Lamotrigine (fewest adverse events), Lacosamide (favorable safety). AVOID: Phenytoin (higher mortality, drug interactions), Valproic acid (higher mortality). Start LEV 500 mg BID, titrate to 1000-1500 mg BID as needed.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA 2022 ICH; 2025 Network Meta-analysis (Neurology)',
              reference: 'ASM Network Meta-analysis: Neurology 2025. DOI: 10.1212/WNL.0000000000210231',
              conditions: (data) => {
                const screening = data.telestrokeNote?.screeningTools || {};
                return screening.seizureRisk === 'high' || screening.seizureRisk === 'moderate';
              }
            },

            // ---------------------------------------------------------------
            // DYSPHAGIA SCREENING (2026)
            // ---------------------------------------------------------------
            dysphagia_screening: {
              id: 'dysphagia_screening',
              category: 'Supportive Care',
              title: 'Dysphagia screening (2026 AHA)',
              recommendation: 'All stroke patients must undergo bedside dysphagia screening before any oral intake. Failure should trigger instrumental assessment (FEES or VFSS) by SLP.',
              detail: 'Validated bedside tools: Gugging Swallowing Screen (GUSS), Toronto Bedside Swallowing Screening Test (TOR-BSST), 3-oz Water Swallow Test. Instrumental assessment (FEES or videofluoroscopic swallowing study) recommended when resources allow, especially for silent aspiration detection. FEES can be performed at bedside (advantage for critically ill). Early nurse-led bedside screening reduces pneumonia rates. NPO until screen passed.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },

            // ---------------------------------------------------------------
            // EARLY MOBILIZATION
            // ---------------------------------------------------------------
            early_mobilization: {
              id: 'early_mobilization',
              category: 'Supportive Care',
              title: 'Early mobilization after stroke (AVERT)',
              recommendation: 'Avoid very early mobilization (<24 hours) for severe strokes (NIHSS >16) and ICH. Start graduated mobilization at 24-48 hours with short, frequent sessions.',
              detail: 'AVERT Phase III (n=2,104): Very early mobilization within 24 hours was HARMFUL (aOR 0.73, P=0.004), especially in severe strokes and ICH. Optimal: start at 24-48 hours from onset with hemodynamic stability. Recommended session: 15-45 minutes, 1-3 times daily. Short frequent sessions superior to prolonged single sessions (AVERT dose-response analysis).',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-R',
              guideline: 'AVERT Phase III (Lancet 2015); VA/DoD Stroke Rehab CPG 2024',
              reference: 'AVERT: Lancet 2015;386:46-55.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },

            // ---------------------------------------------------------------
            // DECOMPRESSIVE CRANIECTOMY (EXPANDED)
            // ---------------------------------------------------------------
            decompressive_craniectomy_cerebellar: {
              id: 'decompressive_craniectomy_cerebellar',
              category: 'Special Populations',
              title: 'Suboccipital decompressive craniectomy for cerebellar infarction',
              recommendation: 'Suboccipital decompressive craniectomy is a life-saving procedure for expansive cerebellar infarction with brainstem compression or hydrocephalus.',
              detail: 'Class I, LOE B-NR. Indications: large cerebellar infarction with progressive neurological deterioration, brainstem compression, or obstructive hydrocephalus. EVD may be placed for acute hydrocephalus but alone may be insufficient if cerebellar swelling is the primary problem. Resection of necrotic cerebellar tissue may be combined with decompression. No absolute age cutoff; decision based on premorbid function, imaging, and clinical trajectory.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'Powers WJ et al. Stroke. 2026.',
              conditions: (data) => {
                const ct = (data.telestrokeNote?.ctResults || '').toLowerCase();
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return ct.includes('cerebellar') || cta.includes('pica') || cta.includes('sca') || cta.includes('cerebellar');
              }
            },

            // ---------------------------------------------------------------
            // GLP-1 RA SECONDARY PREVENTION
            // ---------------------------------------------------------------
            glp1ra_secondary_prevention: {
              id: 'glp1ra_secondary_prevention',
              category: 'Secondary Prevention',
              title: 'GLP-1 RA for cardiovascular/stroke prevention',
              recommendation: 'Semaglutide is recommended for stroke patients with T2DM and established ASCVD (Class I, LOE A). Consider for patients with BMI \u226527 + CVD even without diabetes (Class IIa).',
              detail: 'SELECT (NEJM 2023, n=17,604): Semaglutide 2.4 mg weekly reduced MACE by 20% (HR 0.80, P<0.001) in overweight/obese patients with CVD but without diabetes. SUSTAIN-6: 39% reduction in nonfatal stroke (HR 0.61, P=0.04) in T2DM. SOUL (2025): 14% MACE reduction in T2DM, leading to EMA approval as first stroke management therapy. FDA approved March 2024 for MACE risk reduction in adults with overweight/obesity and established CVD. Benefit independent of baseline adiposity and weight loss.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Secondary Prevention; SELECT (NEJM 2023); SOUL (2025)',
              reference: 'SELECT: NEJM 2023. SUSTAIN-6: NEJM 2016. SOUL: 2025.',
              conditions: (data) => {
                const pmh = (data.telestrokeNote?.pmh || '').toLowerCase();
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isStroke = cat === 'ischemic' || cat === 'tia';
                const hasDM = pmh.includes('diabet') || pmh.includes('dm') || pmh.includes('a1c');
                const hasObesity = pmh.includes('obes') || pmh.includes('bmi');
                return isStroke && (hasDM || hasObesity);
              }
            },

            // ---------------------------------------------------------------
            // PCSK9 / LDL TARGETS
            // ---------------------------------------------------------------
            ldl_aggressive_target: {
              id: 'ldl_aggressive_target',
              category: 'Secondary Prevention',
              title: 'Aggressive LDL lowering for stroke prevention',
              recommendation: 'Target LDL <55 mg/dL with \u226550% reduction from baseline for atherosclerotic stroke/TIA. Add ezetimibe, then PCSK9 inhibitor if not at goal on max statin.',
              detail: 'TST (Lancet Neurol 2020): LDL <70 reduced composite endpoint by 22%. SPARCL: atorvastatin 80 mg reduced stroke 16%, \u226550% LDL reduction yielded 31% stroke reduction. ESC/EAS 2019: LDL <55 for very-high-risk ASCVD. FOURIER 2025 subanalysis: LDL <40 mg/dL optimal for prior stroke patients (no safety concerns, no increase in hemorrhagic stroke). Escalation ladder: high-intensity statin \u2192 add ezetimibe 10 mg \u2192 add PCSK9i (evolocumab/alirocumab) \u2192 recheck 6-8 weeks. Inclisiran (twice-yearly injection) available for adherence challenges. Oral PCSK9 agents (enlicitide) in pipeline.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA 2021; TST (Lancet Neurol 2020); FOURIER (AHA 2025)',
              reference: 'TST: Lancet Neurol 2020. SPARCL: NEJM 2006. FOURIER subanalysis: AHA 2025.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const toast = (data.telestrokeNote?.toastClassification || '').toLowerCase();
                return isIschemic && (toast.includes('athero') || toast === '' || toast.includes('undetermined'));
              }
            },

            // ---------------------------------------------------------------
            // CYP2C19-GUIDED ANTIPLATELET (CHANCE-2)
            // ---------------------------------------------------------------
            cyp2c19_guided_dapt: {
              id: 'cyp2c19_guided_dapt',
              category: 'Antithrombotic',
              title: 'CYP2C19-guided antiplatelet selection (CHANCE-2)',
              recommendation: 'For minor stroke/TIA patients on DAPT, consider CYP2C19 testing. Loss-of-function carriers benefit from ticagrelor + ASA instead of clopidogrel + ASA.',
              detail: 'CHANCE-2 (NEJM 2021, n=6,412 CYP2C19 LOF carriers): Ticagrelor + ASA \u00d7 21 days then ticagrelor mono \u00d7 90 days reduced 1-year stroke by 20% (HR 0.80, P=0.007) vs. clopidogrel + ASA. Benefit entirely in first 90 days. THALES: Ticagrelor + ASA \u00d7 30 days reduced stroke/death (HR 0.83) regardless of genotype but with higher severe bleeding (HR 3.99). Standard DAPT (non-LOF carriers): clopidogrel 300 mg load + ASA 325 mg, then clopidogrel 75 mg + ASA 81 mg \u00d7 21 days, then clopidogrel mono.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-R',
              guideline: 'CHANCE-2 (NEJM 2021); THALES (NEJM 2020)',
              reference: 'CHANCE-2: NEJM 2021. 1-year follow-up: Neurology 2024. THALES: NEJM 2020.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || 0;
                return isIschemic && nihss <= 5;
              }
            },

            // ---------------------------------------------------------------
            // COLCHICINE
            // ---------------------------------------------------------------
            colchicine_secondary_prevention: {
              id: 'colchicine_secondary_prevention',
              category: 'Secondary Prevention',
              title: 'Colchicine for stroke + coronary artery disease (emerging)',
              recommendation: 'Colchicine 0.5 mg daily may be considered for patients with stroke AND coronary artery disease, particularly with elevated hsCRP. Evidence is emerging but not yet definitive for stroke-only patients.',
              detail: 'CONVINCE (Lancet 2024, n=3,154): Non-cardioembolic stroke/TIA. Primary endpoint not met (HR 0.84, P=0.12) but underpowered (stopped early due to COVID). Meta-analysis (eClinicalMedicine 2024): ischemic stroke reduced 27% (RR 0.73, 95% CI 0.58-0.90) when pooled with LoDoCo2/COLCOT. CHANCE-3 (BMJ 2024): negative in minor stroke/TIA. CLEAR SYNERGY: negative. Side effects: diarrhea 12%, ~20% discontinuation. Contraindicated in severe renal impairment. Monitor CRP as biomarker of response.',
              classOfRec: 'IIb',
              levelOfEvidence: 'B-R',
              guideline: 'CONVINCE (Lancet 2024); Meta-analysis (eClinicalMedicine 2024)',
              reference: 'CONVINCE: Lancet 2024. CHANCE-3: BMJ 2024. Meta-analysis: eClinicalMedicine 2024.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const pmh = (data.telestrokeNote?.pmh || '').toLowerCase();
                const hasCAD = pmh.includes('cad') || pmh.includes('coronary') || pmh.includes('mi') || pmh.includes('stent') || pmh.includes('cabg');
                return isIschemic && hasCAD;
              }
            },

            // ---------------------------------------------------------------
            // CANCER-ASSOCIATED STROKE
            // ---------------------------------------------------------------
            cancer_stroke_management: {
              id: 'cancer_stroke_management',
              category: 'Special Populations',
              title: 'Cancer-associated stroke management',
              recommendation: 'For ischemic stroke in patients with active cancer: extend workup (D-dimer, blood cultures, TEE for NBTE), classify mechanism (cancer-related vs conventional), and tailor secondary prevention. Consider LMWH for cancer-related hypercoagulability; oncology co-management recommended.',
              detail: 'AHA 2026 Scientific Statement on Cancer-Associated Stroke: Trousseau syndrome (cancer hypercoagulability) typically presents with multiterritory infarcts, elevated D-dimer (often >5x ULN), and no conventional etiology. Mechanism classification: probable cancer-related (NBTE, DIC, tumor embolism) vs possible vs conventional. Extended workup: D-dimer, fibrinogen, blood smear (schistocytes), blood cultures (if febrile), TTE→TEE (marantic vegetations), body CT. TNK: use standard criteria; avoid if brain metastases, platelets <100K, or coagulopathy. Secondary prevention: for probable cancer-related stroke, LMWH (enoxaparin 1 mg/kg BID or dalteparin 200 IU/kg daily) is preferred. DOAC vs LMWH for cancer-associated VTE is evolving (SELECT-D, HOKUSAI-VTE Cancer). Antiplatelet therapy if conventional mechanism. Life expectancy and goals of care are central to decision-making.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'Classification and Management of Ischemic Stroke in Patients With Active Cancer',
              reference: 'AHA Scientific Statement 2026. Navi BB et al. Stroke. 2026.',
              conditions: (data) => {
                return !!data.telestrokeNote?.activeCancer;
              }
            },

            // ---------------------------------------------------------------
            // SICKLE CELL DISEASE STROKE
            // ---------------------------------------------------------------
            sickle_cell_stroke: {
              id: 'sickle_cell_stroke',
              category: 'Special Populations',
              title: 'Sickle cell disease — acute stroke management',
              recommendation: 'For acute ischemic stroke in sickle cell disease: initiate exchange transfusion urgently (target HbS <30%, Hgb ~10 g/dL). Simple transfusion if exchange unavailable. Hematology and transfusion medicine consult STAT. IV thrombolysis is NOT contraindicated.',
              detail: 'AHA/ASA Guidelines: Exchange transfusion is the cornerstone of acute SCD stroke treatment (Class I). Target: HbS <30%, total Hgb ~10 g/dL (avoid >10 — hyperviscosity risk). If exchange transfusion unavailable, simple transfusion to Hgb 10 g/dL as bridge. TNK/alteplase: not contraindicated but do NOT delay exchange transfusion. EVT: appropriate for LVO per standard criteria. Secondary prevention: chronic exchange transfusion program (target HbS <30% indefinitely) + hydroxyurea (SWITCH trial: hydroxyurea + phlebotomy inferior to transfusion + chelation for secondary prevention). STOP trial: TCD screening in pediatric SCD; chronic transfusion reduced stroke risk 92%. Contact transfusion services immediately.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'STOP: Adams RJ et al. NEJM 1998. SWITCH: Ware RE et al. Lancet 2016.',
              conditions: (data) => {
                return !!data.telestrokeNote?.sickleCellDisease;
              }
            },

            // ---------------------------------------------------------------
            // INFECTIVE ENDOCARDITIS STROKE
            // ---------------------------------------------------------------
            endocarditis_stroke: {
              id: 'endocarditis_stroke',
              category: 'Special Populations',
              title: 'Infective endocarditis — stroke management',
              recommendation: 'For stroke due to infective endocarditis: AVOID systemic anticoagulation and IV thrombolysis (high hemorrhagic transformation risk). EVT is preferred for LVO. Order blood cultures, STAT echocardiography (TEE), and CTA to screen for mycotic aneurysms. ID and cardiac surgery consultation.',
              detail: 'IV thrombolysis is contraindicated (AHA/ASA Class III). Anticoagulation is generally avoided in IE-related stroke due to high rates of hemorrhagic transformation, EXCEPT for mechanical prosthetic valve endocarditis (continue anticoagulation, Class IIa). EVT may be considered for LVO with disabling deficits (Class IIb). Mycotic aneurysm screening: CTA head/neck; if positive, consider conventional angiography. Mycotic aneurysms may require endovascular treatment or surgical clipping. Timing of cardiac surgery after stroke: small infarct — early surgery acceptable; large infarct or hemorrhagic conversion — delay 2-4 weeks if hemodynamically stable. Antibiotic therapy per ID guidance (minimum 4-6 weeks IV). Blood cultures x3 from separate sites before antibiotics.',
              classOfRec: 'III',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'AHA/AHA Infective Endocarditis Guidelines 2015. Stroke in IE: Baddour et al. Circulation 2015.',
              conditions: (data) => {
                return !!data.telestrokeNote?.infectiveEndocarditis;
              }
            },

            // ---------------------------------------------------------------
            // INTRACRANIAL ATHEROSCLEROSIS (ICAD)
            // ---------------------------------------------------------------
            icad_management: {
              id: 'icad_management',
              category: 'Antithrombotic',
              title: 'Intracranial atherosclerotic disease (ICAD) management',
              recommendation: 'Aggressive medical management is first-line for intracranial stenosis: DAPT + high-intensity statin + BP <140/90. Intracranial stenting is NOT recommended routinely (Class III: Harm).',
              detail: 'SAMMPRIS: PTAS was inferior to aggressive medical management (30-day stroke/death 14.7% vs 5.8%). CASSISS: No benefit of stenting + medical therapy. Pooled analysis (n=809): 30-day stroke/death significantly higher with PTAS (10.5% vs 4.2%, HR 2.62). Medical protocol: DAPT (ASA + clopidogrel) \u00d7 90 days, then single antiplatelet. High-intensity statin (LDL <70). SBP <140/90. Stenting considered ONLY after \u22652 recurrent events on max medical therapy at experienced centers (Class IIb, LOE C).',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: '2022 AAN Intracranial Atherosclerosis',
              reference: 'SAMMPRIS: NEJM 2011. CASSISS: JAMA 2022. Pooled IPD: 2025.',
              conditions: (data) => {
                const toast = (data.telestrokeNote?.toastClassification || '').toLowerCase();
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return toast.includes('large artery') || cta.includes('intracranial stenosis') || cta.includes('intracranial atheroscler');
              }
            },

            // ---------------------------------------------------------------
            // MEVO EVT (NOT RECOMMENDED)
            // ---------------------------------------------------------------
            mevo_evt_not_recommended: {
              id: 'mevo_evt_not_recommended',
              category: 'EVT',
              title: 'MeVO/distal occlusion EVT: NOT recommended routinely (exceptions below)',
              recommendation: 'EVT for M2-M4 MCA, ACA, and PCA occlusions is NOT recommended routinely (2025 trial data). EXCEPTION: Consider EVT in select cases of proximal/dominant M2 segment MCA occlusion ≤1cm of bifurcation when salvageable tissue present and LKW ≤24h.',
              detail: 'Suggested protocol: MeVO — consider in select proximal or dominant M2 segment MCA occlusion ≤1cm of bifurcation in horizontal segment when there is evidence of salvageable tissue + LKW ≤24h. NOT recommended for M2-M4 MCA, ACA, and PCA occlusions. Trial data: ESCAPE-MeVO (NEJM 2025, n=530): No benefit of EVT for MeVO. Higher mortality in EVT group (13.3% vs 8.4%, HR 1.82). sICH higher (5.4% vs 2.2%). DISTAL (n=543): No benefit. DISCOUNT: Consistent negative results. Flag M2/M3 patients for clinical trial enrollment (e.g., STEP trial).',
              classOfRec: 'III',
              levelOfEvidence: 'B-R',
              guideline: 'ESCAPE-MeVO (NEJM 2025); DISTAL (2025); DISCOUNT (2025)',
              reference: 'ESCAPE-MeVO: NEJM 2025. DISTAL: 2025. DISCOUNT: 2025.',
              caveats: 'Local protocol may permit consideration of proximal M2 EVT in highly select cases. Discuss with neurointerventionalist.',
              conditions: (data) => {
                const vessels = data.telestrokeNote?.vesselOcclusion || [];
                return vessels.some(v => /m2|m3|m4|distal|mevo|medium vessel/i.test(v));
              }
            },

            // ---------------------------------------------------------------
            // POST-EVT BP DRIP PROTOCOL
            // ---------------------------------------------------------------
            bp_post_evt_drip: {
              id: 'bp_post_evt_drip',
              category: 'Blood Pressure',
              title: 'Post-EVT BP drip titration protocol',
              recommendation: 'For post-EVT BP management, use nicardipine 5-15 mg/hr or clevidipine 1-2 mg/hr. Maintain SBP <180/105; avoid targeting SBP <140 (Class III: Harm).',
              detail: 'Nicardipine: start 5 mg/hr, titrate by 2.5 mg/hr every 5-15 min (max 15 mg/hr). Clevidipine: start 1-2 mg/hr, double every 90 seconds initially (max 32 mg/hr). For successfully recanalized (mTICI 2b-3): maintain SBP <180, avoid SBP <140. For non-recanalized: SBP <180. ENCHANTED2/MT: SBP <120 was harmful. OPTIMAL-BP (JAMA 2024): intensive <140 showed no benefit. BP-TARGET: intensive 100-129 showed no benefit. BEST-II (Stroke 2024): SBP 100-129 vs 130-159 post-EVT — lower targets trended toward worse outcomes; maintain SBP floor ~130 post-EVT. Meta-analysis of 4 RCTs: intensive targets reduced functional independence by 23%.',
              classOfRec: 'I',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026',
              reference: 'ENCHANTED2/MT: Lancet 2022. OPTIMAL-BP: JAMA 2024. BP-TARGET: Lancet Neurol 2021.',
              medications: ['Nicardipine 5 mg/hr IV (titrate q5-15min, max 15)', 'Clevidipine 1-2 mg/hr IV'],
              conditions: (data) => {
                return !!data.telestrokeNote?.evtRecommended;
              }
            },

            // ---------------------------------------------------------------
            // POST-THROMBECTOMY DECT / FOLLOW-UP IMAGING
            // ---------------------------------------------------------------
            post_evt_dect: {
              id: 'post_evt_dect',
              category: 'EVT',
              title: 'Post-thrombectomy follow-up imaging (DECT/NCCT)',
              recommendation: 'Routine 24h NCCT (or DECT if available) for all post-EVT patients. Immediate NCCT/DECT if clinical deterioration, concern for ICH, or failed recanalization.',
              detail: 'Suggested protocol: Post-thrombectomy imaging — (1) IMMEDIATE NCCT/DECT: clinical deterioration (new deficit, declining GCS), concern for hemorrhage, failed recanalization (mTICI 0-2a), or any symptomatic change. (2) ROUTINE 24h NCCT/DECT: stable patients with successful recanalization (mTICI 2b-3) — assess for hemorrhagic transformation before initiating antithrombotics. DECT advantage: dual-energy CT distinguishes iodine contrast staining from true hemorrhage, avoiding unnecessary delays in antithrombotic initiation. If DECT shows contrast staining only (no hemorrhage), may consider earlier antithrombotic start per neurointerventionalist recommendation.',
              classOfRec: 'I',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA/ASA Early Management of Acute Ischemic Stroke 2026; Suggested Protocol',
              reference: 'Powers WJ et al. Stroke. 2026.',
              conditions: (data) => {
                return !!data.telestrokeNote?.evtRecommended;
              }
            },

            // ---------------------------------------------------------------
            // SGLT2 INHIBITORS
            // ---------------------------------------------------------------
            sglt2i_guidance: {
              id: 'sglt2i_guidance',
              category: 'Secondary Prevention',
              title: 'SGLT2 inhibitors in stroke patients',
              recommendation: 'SGLT2 inhibitors are recommended for cardiorenal benefits (HF, CKD) but NOT specifically for stroke prevention. Consider sotagliflozin if dual stroke + HF benefit is desired.',
              detail: 'Meta-analysis (71 RCTs, n=105,914): SGLT2 inhibitors did NOT significantly reduce total stroke (RR 0.96, NS) or ischemic stroke (RR 0.89, NS). Exception: sotagliflozin (dual SGLT1/2 inhibitor) reduced all stroke types (RR 0.74, P=0.04). SGLT2i reduced hemorrhagic stroke (RR 0.62, P=0.04). Primary indications: HF (regardless of EF), CKD (eGFR 20-45), T2DM with cardiorenal comorbidity. GLP-1 RAs offer superior stroke protection in indirect comparisons.',
              classOfRec: 'IIa',
              levelOfEvidence: 'A',
              guideline: 'ADA Standards 2026; SMART-C Meta-analysis (Circulation)',
              reference: 'SGLT2i Stroke Meta-analysis: JSCVD 2024. SMART-C: Circulation 2024.',
              conditions: (data) => {
                const pmh = (data.telestrokeNote?.pmh || '').toLowerCase();
                return pmh.includes('heart failure') || pmh.includes('hf') || pmh.includes('ckd') || pmh.includes('kidney');
              }
            },

            // ---------------------------------------------------------------
            // DEPRESSION SCREENING
            // ---------------------------------------------------------------
            depression_screening_schedule: {
              id: 'depression_screening_schedule',
              category: 'Post-Stroke Care',
              title: 'Post-stroke depression screening schedule',
              recommendation: 'Screen all stroke patients for depression using PHQ-2/PHQ-9 at discharge, 1 month, 3 months, 6 months, and 12 months post-stroke. SSRIs for diagnosed PSD only.',
              detail: 'Post-stroke depression affects ~30% of survivors. SSRIs for diagnosed PSD only (Class IIa) — NOT routine for recovery (Class III per FOCUS/AFFINITY/EFFECTS: no improvement in mRS). Preferred agents: sertraline, escitalopram. Drug interaction flag: SSRIs + DAPT = 29% higher hemorrhagic stroke risk. FLAME trial (small) suggested fluoxetine enhanced motor recovery, but 3 large RCTs (FOCUS n=3,127, AFFINITY n=1,280, EFFECTS) all negative for functional recovery. SSRIs increase falls, fractures, and hyponatremia risk.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA 2021; FOCUS (Lancet 2019); AFFINITY (JAMA Neurol 2020)',
              reference: 'FOCUS: Lancet 2019. AFFINITY: JAMA Neurology 2020.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },

            // ---------------------------------------------------------------
            // SLEEP APNEA
            // ---------------------------------------------------------------
            sleep_apnea_screening: {
              id: 'sleep_apnea_screening',
              category: 'Post-Stroke Care',
              title: 'Sleep apnea screening and management after stroke',
              recommendation: 'Screen all stroke/TIA patients for sleep apnea (STOP-BANG or Berlin Questionnaire). CPAP benefit for vascular event prevention is uncertain (SAVE trial negative).',
              detail: 'OSA affects ~70% of stroke patients and is an independent risk factor. SAVE trial (n=2,687, including 1,183 with prior stroke): CPAP did NOT reduce recurrent vascular events or mortality. However, adherence was poor (~3.3 h/night). Some evidence of improved neurological recovery. Class IIa for screening; Class IIb for CPAP treatment (uncertain vascular benefit; possible neurological recovery benefit). Refer for polysomnography if high-risk on screening. Track CPAP adherence if prescribed.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA Secondary Prevention 2021; SAVE (NEJM 2016)',
              reference: 'SAVE: NEJM 2016. CPAP meta-analysis: PMC 2023.',
              conditions: (data) => {
                const screening = data.telestrokeNote?.screeningTools || {};
                return (parseInt(screening.stopBangScore, 10) || 0) >= 3 || !!screening.stopBangPositive;
              }
            },

            // ---------------------------------------------------------------
            // MEDITERRANEAN DIET
            // ---------------------------------------------------------------
            mediterranean_diet: {
              id: 'mediterranean_diet',
              category: 'Secondary Prevention',
              title: 'Mediterranean diet for stroke prevention',
              recommendation: 'Mediterranean diet is recommended for secondary stroke prevention (Class I, LOE B). DASH diet has been downgraded due to lack of direct stroke endpoint RCT data.',
              detail: 'PREDIMED: 42% stroke reduction (HR 0.58, 95% CI 0.42-0.82) — stronger effect than for MI or CV death. Meta-analysis of RCTs (2024): OR 0.63 for stroke incidence. 2024 AHA/ASA: Mediterranean diet upgraded; DASH diet downgraded. Italian National Guidelines 2025: high-quality evidence for Mediterranean diet + EVOO or nuts. Key components: EVOO, nuts, fish, vegetables, fruit, legumes, whole grains. Limit red meat, processed foods, added sugars. MEDAS-14 score can track adherence.',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA 2024; PREDIMED; Italian National Guidelines 2025',
              reference: 'PREDIMED: NEJM 2018. Meta-analysis: Wiley 2024.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            // VTE PROPHYLAXIS
            vte_ipc_admission: {
              id: 'vte_ipc_admission',
              category: 'Acute',
              title: 'IPC at admission for immobile stroke patients',
              recommendation: 'Intermittent pneumatic compression (IPC) should be applied immediately at admission for all immobile AIS and ICH patients (Class I, LOE A). Graduated compression stockings alone are NOT effective (Class III).',
              detail: 'CLOTS 3 trial: IPC reduced DVT from 12.1% to 8.5% (OR 0.65). TED hose alone showed no benefit (CLOTS 1). IPC should be continued until patient is independently mobile. Pharmacologic VTE prophylaxis added after 24-48h (post-thrombolysis: wait 24h + clear CT).',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA 2019 AIS; AHA/ASA 2022 ICH; CLOTS 3',
              reference: 'CLOTS 3: Lancet 2013.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            vte_enoxaparin_timing: {
              id: 'vte_enoxaparin_timing',
              category: 'Acute',
              title: 'Enoxaparin preferred over UFH for VTE prophylaxis',
              recommendation: 'Enoxaparin preferred over UFH for pharmacologic VTE prophylaxis. Post-lytic: start at 24h after stable imaging. Post-ICH: start at 48h after stable imaging. SCDs until then.',
              detail: 'Suggested protocol: SQ heparin 24h after lytic, 48h after IPH. SCDs/IPC in the interim. PREVAIL trial: enoxaparin 40mg SC daily reduced VTE from 16% to 8.1% vs UFH. Duration: 10-14 days or until independently mobile. Anti-Xa monitoring (0.2-0.5 IU/mL) for BMI >40 or CrCl <30.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'PREVAIL; AHA/ASA 2019; ACCP 9th Ed',
              reference: 'PREVAIL: Stroke 2007.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            // FEVER MANAGEMENT
            fever_management_protocol: {
              id: 'fever_management_protocol',
              category: 'Acute',
              title: 'Fever management in acute stroke',
              recommendation: 'Target temperature 36.0-37.5C. Treat fever >37.5C within 1 hour. Acetaminophen is first-line; avoid NSAIDs in stroke (Class III). Implement FeSS bundle: Fever-Sugar-Swallowing.',
              detail: 'Stepwise protocol: (1) Infection workup + treat, (2) Scheduled acetaminophen 650-1000mg q6h, (3) Surface cooling + counter-warming, (4) IV magnesium 2g bolus, (5) Buspirone 30mg q8h. Use BSAS (0-3) to guide anti-shivering therapy. QASC trial: FeSS bundle reduced death/dependency by 16%. Note: Prophylactic hypothermia (34-35°C) is NOT recommended for ischemic stroke (EuroHYP-1, Lancet Neurol 2019: neutral; Class III).',
              classOfRec: 'IIa',
              levelOfEvidence: 'B-NR',
              guideline: 'NTCR 2023; ESO/QASC; AHA/ASA 2019',
              reference: 'QASC: Lancet 2011.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            // OSMOTIC THERAPY
            osmotic_therapy_protocol: {
              id: 'osmotic_therapy_protocol',
              category: 'Acute',
              title: 'Osmotic therapy for cerebral edema',
              recommendation: 'Mannitol 20% (0.5-1g/kg bolus) for euvolemic/hypervolemic patients; HTS 3% (250mL bolus) for hypotensive/hyponatremic. HTS 23.4% 30mL via central line for refractory herniation.',
              detail: 'Mannitol: hold if osmolality >320 or osmolar gap >20. HTS: target Na 145-155 for severe edema; do not exceed 8-10 mEq/L/24h correction (ODS risk). HTS preferred in renal insufficiency (mannitol accumulates). BMP q6h with mannitol; Na q4-6h with HTS.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'NCS Guidelines; ENLS Protocol',
              reference: 'NCS Osmotic Therapy: Neurocrit Care 2020.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return cat === 'ich' || dx.includes('edema') || dx.includes('malignant') || dx.includes('herniat');
              }
            },
            // NUTRITION
            nutrition_ng_peg_timing: {
              id: 'nutrition_ng_peg_timing',
              category: 'Acute',
              title: 'Nutritional support after stroke',
              recommendation: 'If dysphagia screen failed: NG tube within 24-48h. PEG consideration at day 14-21 if dysphagia persists. NG is preferred for first 2-3 weeks (FOOD trial).',
              detail: 'FOOD trial: early PEG (within 7 days) had worse 6-month outcomes than NG feeding. Nutritional targets: 25-30 kcal/kg/day, protein 1.0-1.5 g/kg/day. Enteral nutrition within 24-48h. Antithrombotics can be continued during PEG placement (ASGE 2024).',
              classOfRec: 'IIa',
              levelOfEvidence: 'A',
              guideline: 'FOOD Trial; ESPEN Guidelines; AHA/ASA 2019',
              reference: 'FOOD Trial: Lancet 2005.',
              conditions: (data) => {
                return !!(data.telestrokeNote?.dysphagiaScreening?.bedsideScreenResult === 'fail');
              }
            },
            // PLATELET TRANSFUSION WARNING
            platelet_transfusion_ich: {
              id: 'platelet_transfusion_ich',
              category: 'ICH',
              title: 'Platelet transfusion harmful in ICH on aspirin',
              recommendation: 'Platelet transfusion is HARMFUL in ICH patients on antiplatelet therapy unless emergency surgery is planned (Class III Harm, LOE B-R).',
              detail: 'PATCH trial: platelet transfusion increased odds of death/dependence (OR 2.05, 95% CI 1.18-3.56). Only transfuse if emergency neurosurgery is imminent.',
              classOfRec: 'III',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA 2022 ICH; PATCH Trial',
              reference: 'PATCH: Lancet 2016.',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            // ICH SCORE DISCLAIMER
            ich_score_no_limit: {
              id: 'ich_score_no_limit',
              category: 'ICH',
              title: 'ICH score must not be used to limit treatment',
              recommendation: 'ICH severity scores must NOT be used to limit care or justify withdrawal of treatment (Class I, LOE B-NR). Postpone new DNR orders until at least hospital day 2.',
              detail: 'Self-fulfilling prophecy of withdrawal is well-documented. Full aggressive care recommended for minimum 24-48 hours. ICH score measures severity, not prognosis.',
              classOfRec: 'I',
              levelOfEvidence: 'B-NR',
              guideline: 'AHA/ASA 2022 ICH',
              reference: 'Hemphill et al. ICH Score: Stroke 2001; 2022 ICH Guidelines.',
              conditions: (data) => {
                return data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            // PERMISSIVE HYPERTENSION
            permissive_hypertension: {
              id: 'permissive_hypertension',
              category: 'Acute',
              title: 'Permissive hypertension in acute ischemic stroke',
              recommendation: 'Do NOT treat BP <220/120 in acute ischemic stroke without reperfusion therapy, at least in first 24h (Class III, LOE A). Restart home antihypertensives at 24-72h if neurologically stable.',
              detail: 'Treatment of moderate hypertension in non-reperfused AIS worsens penumbral perfusion. CSBP and AHA/ASA agree: permissive approach unless other organ damage (aortic dissection, MI, HF).',
              classOfRec: 'III',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA 2019 AIS; CSBP Acute 2022',
              reference: 'AHA/ASA AIS Guidelines 2019.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return cat === 'ischemic' || cat === 'tia';
              }
            },
            // BASILAR ARTERY OCCLUSION EVT
            basilar_evt_class1: {
              id: 'basilar_evt_class1',
              category: 'Acute',
              title: 'Basilar artery occlusion EVT within 24h',
              recommendation: 'EVT is recommended for basilar artery occlusion within 24h in patients with NIHSS >=10 and mild ischemic damage on imaging (Class I, LOE A).',
              detail: 'ATTENTION and BAOCHE trials: first Class I evidence for posterior circulation EVT. Requires CT/CTA confirming basilar occlusion. Exclude patients with extensive brainstem infarction.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA 2026 AIS Guideline; ATTENTION; BAOCHE',
              reference: 'ATTENTION: NEJM 2022. BAOCHE: NEJM 2022.',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                const cta = (data.telestrokeNote?.ctaResults || '').toLowerCase();
                return (dx.includes('basilar') || cta.includes('basilar'));
              }
            },
            // STATUS EPILEPTICUS PROTOCOL
            status_epilepticus_protocol: {
              id: 'status_epilepticus_protocol',
              category: 'Acute',
              title: 'Status epilepticus management in stroke',
              recommendation: 'SE first-line at 5 min: IV lorazepam 0.1 mg/kg (max 4 mg, repeat x1) or IM midazolam 10 mg if no IV access. Second-line at 20 min: fosphenytoin, LEV, or valproate (all equivalent per ESETT). Third-line at 40 min: anesthetic doses.',
              detail: 'RAMPART trial: IM midazolam superior to IV lorazepam when no IV access. ESETT trial: LEV, fosphenytoin, and VPA equally effective for benzodiazepine-refractory SE (~45% each). Benzodiazepine underdosing occurs in >2/3 of cases. Refractory SE (>30 min): Intubation + midazolam 0.2 mg/kg bolus then 0.05-2 mg/kg/hr OR propofol 1-2 mg/kg bolus then 20-80 mcg/kg/min. Target burst suppression on EEG x 24-48h, then slowly wean.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AES 2016 (AAN-endorsed); ESETT',
              reference: 'RAMPART: NEJM 2012. ESETT: NEJM 2019.',
              conditions: (data) => {
                const seizure = (data.telestrokeNote?.screeningTools?.seizureRisk || '').toLowerCase();
                return seizure.includes('seizure') || seizure.includes('status');
              }
            },
            // DAPT AUTO-STOP
            dapt_auto_stop: {
              id: 'dapt_auto_stop',
              category: 'Secondary Prevention',
              title: 'DAPT must not continue beyond 90 days',
              recommendation: 'Do NOT continue DAPT beyond 90 days — increased bleeding without additional benefit (Class III, LOE A). Convert to monotherapy at day 21-90.',
              detail: 'CHANCE: 21-day DAPT optimal. POINT: 90-day DAPT had more bleeding. ESO and AHA agree: auto-stop DAPT and transition to monotherapy. Flag patients still on DAPT at 90-day visit.',
              classOfRec: 'III',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA 2021; ESO DAPT 2021',
              reference: 'CHANCE: NEJM 2013. POINT: NEJM 2018.',
              conditions: (data) => {
                const ap = (data.telestrokeNote?.secondaryPrevention?.antiplateletRegimen || '');
                return ap.includes('dapt');
              }
            },
            // COMPASS: Dual Pathway Inhibition for polyvascular disease
            compass_dual_pathway: {
              id: 'compass_dual_pathway',
              category: 'Secondary Prevention',
              title: 'COMPASS: Low-dose rivaroxaban + aspirin for polyvascular atherosclerosis',
              recommendation: 'For ischemic stroke patients with concomitant CAD or PAD (polyvascular atherosclerotic disease), low-dose rivaroxaban 2.5 mg BID + aspirin 100 mg daily may be considered to reduce recurrent vascular events.',
              detail: 'COMPASS (Eikelboom, NEJM 2017, n=27,395): rivaroxaban 2.5mg BID + ASA vs ASA alone in stable atherosclerotic disease — 24% relative risk reduction in MACE (HR 0.76), NNT ~77/yr. Modest increase in major bleeding (HR 1.70) but no increase in fatal/ICH bleeding. Most benefit in polyvascular disease (CAD+PAD or CAD+cerebrovascular). Not studied specifically in acute stroke; consider after stabilization. AHA/ASA 2021 secondary prevention includes this as an option (Class IIb).',
              classOfRec: 'IIb',
              levelOfEvidence: 'B-R',
              guideline: 'AHA/ASA Secondary Prevention 2021',
              reference: 'COMPASS: Eikelboom JW et al. NEJM 2017;377:1319-1330.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                const isIschemic = cat === 'ischemic' || cat === 'tia';
                const hx = (data.telestrokeNote?.medicalHistory || '').toLowerCase();
                const hasPolyvasc = hx.includes('cad') || hx.includes('coronary') || hx.includes('pad') || hx.includes('peripheral arterial') || hx.includes('mi') || hx.includes('cabg') || hx.includes('stent');
                return isIschemic && hasPolyvasc;
              }
            },
            // DRUG INTERACTION: AED-DOAC
            aed_doac_interaction: {
              id: 'aed_doac_interaction',
              category: 'Safety',
              title: 'Enzyme-inducing AEDs reduce DOAC levels',
              recommendation: 'Carbamazepine, phenytoin, and phenobarbital are contraindicated with DOACs due to CYP3A4/P-gp induction reducing DOAC plasma levels. Use LEV, lacosamide, gabapentin, or pregabalin instead.',
              detail: 'If enzyme-inducing AED is unavoidable, switch DOAC to warfarin with INR monitoring. Safe AED options: levetiracetam, lacosamide, gabapentin, pregabalin, lamotrigine (weak inducer — monitor).',
              classOfRec: 'III',
              levelOfEvidence: 'B-NR',
              guideline: 'EHRA 2018 Practical Guide',
              reference: 'EHRA 2018; Expert Opinion Drug Safety 2024.',
              conditions: (data) => {
                const ap = (data.telestrokeNote?.secondaryPrevention?.antiplateletRegimen || '');
                return ap.includes('doac') || ap.includes('anticoag');
              }
            },
            // SPASTICITY
            spasticity_screening: {
              id: 'spasticity_screening',
              category: 'Follow-up',
              title: 'Spasticity screening and botulinum toxin referral',
              recommendation: 'Screen for spasticity (Modified Ashworth Scale) at follow-up visits. Botulinum toxin A is first-line for focal spasticity (Class I, LOE A). Refer early (<3 months) for optimal outcomes.',
              detail: 'Botox superior to oral tizanidine with fewer side effects. Intrathecal baclofen for refractory generalized spasticity. Also screen for hemiplegic shoulder pain — consider NMES and sling.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Rehab 2016; AAN BoNT Guideline 2016',
              reference: 'AAN BoNT Guideline: Neurology 2016.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            // CENTRAL POST-STROKE PAIN
            central_pain_management: {
              id: 'central_pain_management',
              category: 'Follow-up',
              title: 'Central post-stroke pain screening and treatment',
              recommendation: 'Screen for CPSP at 3-6 months. First-line: amitriptyline 75 mg/day. Alternative: lamotrigine. Do NOT use opioids for neuropathic/central pain.',
              detail: 'CPSP prevalence 1-12%. Burning/shooting pain in affected territory, often with allodynia. Lamotrigine uniquely effective for central (not peripheral) neuropathic pain with ~30% reduction. Gabapentin/pregabalin may also be tried.',
              classOfRec: 'IIa',
              levelOfEvidence: 'B',
              guideline: 'NeuPSIG; EFNS Guidelines; AAN PDN 2022',
              reference: 'NeuPSIG: Pain 2015.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            // PALLIATIVE CARE
            palliative_care_screening: {
              id: 'palliative_care_screening',
              category: 'Acute',
              title: 'Early palliative care screening for serious stroke',
              recommendation: 'Screen for palliative care needs in high-NIHSS AIS, large ICH, or failed EVT. Structure goals-of-care conversations at key decision points. Postpone new DNR orders until hospital day 2.',
              detail: 'AHA 2025 Palliative Care Statement. Triggers: decompressive craniectomy decision, failed recanalization, transition to comfort care. Full aggressive care recommended for minimum 24-48h in ICH.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-EO',
              guideline: 'AHA 2025 Palliative Care Statement; AHA/ASA 2022 ICH',
              reference: 'AHA Palliative Care: Stroke 2025.',
              conditions: (data) => {
                const nihss = parseInt(data.telestrokeNote?.nihss, 10) || 0;
                return nihss >= 20 || data.telestrokeNote?.diagnosisCategory === 'ich';
              }
            },
            // ALCOHOL SCREENING
            alcohol_screening: {
              id: 'alcohol_screening',
              category: 'Secondary Prevention',
              title: 'Alcohol screening and counseling',
              recommendation: 'Screen all stroke patients with AUDIT-C. Counsel: limit to <=2 drinks/day (men), <=1 drink/day (women). Heavy alcohol use increases stroke risk (Class IIa, LOE C-LD).',
              detail: 'AUDIT-C: 3-question screen, score >=4 (men) or >=3 (women) is positive. Screen for other substances (cannabis, cocaine, amphetamines). Cocaine/amphetamines are significant stroke risk factors.',
              classOfRec: 'IIa',
              levelOfEvidence: 'C-LD',
              guideline: 'AHA/ASA 2021 Secondary Prevention; 2024 Primary Prevention',
              reference: 'AHA/ASA Secondary Prevention 2021.',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000475#page=40',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            },
            // HORMONAL RISK
            hormonal_stroke_risk: {
              id: 'hormonal_stroke_risk',
              category: 'Secondary Prevention',
              title: 'Hormonal contraception and HRT stroke risk',
              recommendation: 'Combined hormonal contraception is contraindicated in migraine with aura (Class I). Oral estrogen-containing HRT increases stroke risk in women >=60 or >10 years post-menopause (Class III Harm).',
              detail: 'Switch combined OCP to progestin-only or nonhormonal alternative if migraine with aura. Transdermal estrogen may have lower stroke risk than oral. Discuss risk-benefit of HRT individually.',
              classOfRec: 'I/III',
              levelOfEvidence: 'B-NR/A',
              guideline: 'AHA/ASA 2024 Primary Prevention',
              reference: 'AHA/ASA Primary Prevention 2024.',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000475#page=49',
              conditions: (data) => {
                const sex = data.telestrokeNote?.sex;
                return sex === 'F';
              }
            },
            // CVT ANTICOAG PHASES
            cvt_anticoag_phases: {
              id: 'cvt_anticoag_phases',
              category: 'CVT',
              title: 'CVT three-phase anticoagulation',
              recommendation: 'Acute: LMWH or UFH. Transition: VKA (INR 2-3) or DOAC. Duration: 3-12 months (provoked) or indefinite (APS/malignancy/thrombophilia). VKA is MANDATORY for APS (especially triple-positive).',
              detail: 'CSBP CVT 2024: DOACs are NOT routine first-line for CVT. APS patients must use warfarin. Etiology determines duration: provoked (OCP, pregnancy, infection) → 3-6 months; unprovoked → 6-12 months; recurrent/prothrombotic → indefinite.',
              classOfRec: 'I',
              levelOfEvidence: 'B-R',
              guideline: 'CSBP CVT 2024; ESO CVT Guidelines',
              reference: 'CSBP CVT Module 2024.',
              sourceUrl: 'https://www.ahajournals.org/doi/pdf/10.1161/STR.0000000000000456#page=6',
              conditions: (data) => {
                const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                return dx.includes('cvt') || dx.includes('venous') || dx.includes('sinus');
              }
            },
            // PAUSE PROTOCOL
            pause_protocol: {
              id: 'pause_protocol',
              category: 'Procedure Planning',
              title: 'PAUSE protocol for DOAC peri-procedural management',
              recommendation: 'No heparin bridging for DOAC patients. Factor Xa inhibitors: hold 1 day (low risk) or 2 days (high risk) if CrCl >=30; add 1 day if CrCl <30. Dabigatran: hold 1-5 days based on renal function and risk.',
              detail: 'PAUSE study (NEJM 2019): simple interruption without bridging is safe and effective. Warfarin bridging with enoxaparin indicated ONLY for: stroke/TIA within 3 months, mechanical mitral valve, or aortic valve with additional risk factors (BRIDGE Trial).',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'PAUSE Study; BRIDGE Trial; ACC 2024',
              reference: 'PAUSE: NEJM 2019. BRIDGE: NEJM 2015.',
              conditions: (data) => {
                const ap = (data.telestrokeNote?.secondaryPrevention?.antiplateletRegimen || '');
                return ap.includes('doac') || ap.includes('anticoag');
              }
            },
            // FALLS RISK
            falls_risk_screening: {
              id: 'falls_risk_screening',
              category: 'Follow-up',
              title: 'Falls risk screening and prevention',
              recommendation: 'Screen for falls risk at discharge and every follow-up visit. Initiate fall prevention program during hospitalization. Refer to community exercise programs with balance training (Class I, LOE A).',
              detail: 'Stroke patients have 2-5x increased fall risk. In-hospital falls prevention: bed alarms, non-slip footwear, assist devices. Post-discharge: structured balance/exercise program reduces falls by 25-40%.',
              classOfRec: 'I',
              levelOfEvidence: 'A',
              guideline: 'AHA/ASA Rehab 2016',
              reference: 'AHA/ASA Rehab Guideline 2016.',
              conditions: (data) => {
                const cat = data.telestrokeNote?.diagnosisCategory;
                return !!cat && cat !== 'mimic';
              }
            }
          };

          const getPathwayForDiagnosis = (diagnosis) => {
            if (!diagnosis) return 'shared';
            const dx = diagnosis.toLowerCase();
            if (dx.includes('mimic') || dx.includes('non-stroke') || dx.includes('seizure') || dx.includes('migraine') || dx.includes('conversion') || dx.includes('bell')) return 'mimic';
            if (dx.includes('sah') || dx.includes('subarachnoid')) return 'sah';
            if (dx.includes('cvt') || dx.includes('venous thrombosis') || dx.includes('cerebral venous') || dx.includes('dural sinus')) return 'cvt';
            if (dx.includes('ich') || dx.includes('hemorrhag') || dx.includes('intracerebral') || dx.includes('bleed')) return 'ich';
            if (dx.includes('dissect')) return 'dissection';
            if (dx.includes('tia') || dx.includes('transient ischemic')) return 'tia';
            if (dx.includes('ischemic') || dx.includes('stroke') || dx.includes('lvo') || dx.includes('occlusion')) return 'ischemic';
            return 'shared';
          };

          const getTrialTabCategory = (diagnosisCategory = '', diagnosis = '') => {
            const pathway = diagnosisCategory || getPathwayForDiagnosis(diagnosis);
            if (!pathway || pathway === 'shared') return null;
            if (pathway === 'sah' || pathway === 'ich') return 'ich';
            if (pathway === 'tia' || pathway === 'ischemic') return 'ischemic';
            return null;
          };

          // =================================================================
          // ELIGIBILITY EVALUATION FUNCTION
          // =================================================================
          const evaluateTrialEligibility = (trialId, data) => {
            const config = TRIAL_ELIGIBILITY_CONFIG[trialId];
            if (!config) return null;

            const results = {
              trialId,
              trialName: config.name,
              category: config.category,
              quickDescription: config.quickDescription,
              lookingFor: config.lookingFor,
              keyTakeaways: config.keyTakeaways || [],
              nct: config.nct,
              criteria: [],
              exclusions: [],
              status: 'pending', // 'eligible', 'not_eligible', 'needs_info', 'pending'
              metCount: 0,
              notMetCount: 0,
              unknownCount: 0,
              requiredMissing: 0
            };

            // Evaluate key criteria
            config.keyCriteria.forEach(criterion => {
              let status = 'unknown';
              let value = null;

              try {
                const evalResult = criterion.evaluate(data);
                if (evalResult === true) {
                  status = 'met';
                  results.metCount++;
                } else if (evalResult === false) {
                  status = 'not_met';
                  results.notMetCount++;
                  if (criterion.required) results.requiredMissing++;
                } else {
                  status = 'unknown';
                  results.unknownCount++;
                }
              } catch (e) {
                status = 'unknown';
                results.unknownCount++;
              }

              results.criteria.push({
                id: criterion.id,
                label: criterion.label,
                status,
                required: criterion.required
              });
            });

            // Evaluate exclusion flags
            config.exclusionFlags.forEach(exclusion => {
              let triggered = false;
              try {
                if (exclusion.evaluate) {
                  triggered = exclusion.evaluate(data);
                } else {
                  triggered = data[exclusion.field] === true;
                }
              } catch (e) {
                triggered = false;
              }

              if (triggered) {
                results.exclusions.push({
                  id: exclusion.id,
                  label: exclusion.label,
                  triggered: true
                });
                results.notMetCount++;
                results.status = 'not_eligible';
              }
            });

            // Determine overall status
            if (results.exclusions.some(e => e.triggered)) {
              results.status = 'not_eligible';
            } else if (results.requiredMissing > 0) {
              results.status = 'not_eligible';
            } else if (results.unknownCount > 0) {
              results.status = 'needs_info';
            } else if (results.notMetCount === 0) {
              results.status = 'eligible';
            } else {
              results.status = 'not_eligible';
            }

            return results;
          };

          // Evaluate all trials for current patient
          const evaluateAllTrials = (data) => {
            const results = {};
            Object.keys(TRIAL_ELIGIBILITY_CONFIG).forEach(trialId => {
              results[trialId] = evaluateTrialEligibility(trialId, data);
            });
            return results;
          };

          // Trial eligibility state
          const [trialEligibility, setTrialEligibility] = useState({});

          // Navigate to Trials tab with specific trial selected
          const navigateToTrial = (trialId) => {
            const config = TRIAL_ELIGIBILITY_CONFIG[trialId];
            if (!config) return;

            navigateTo('library', { subTab: 'trials' });

            // Create the same slug used in TrialCard from the trial name
            const trialSlug = config.name.toLowerCase()
              .replace(/\s+trial$/i, '')
              .replace(/[^a-z0-9]/g, '-')
              .replace(/-+/g, '-')
              .replace(/^-|-$/g, '');

            // Scroll to trial after tab switch
            setTimeout(() => {
              const trialElement = document.getElementById(`trial-${trialSlug}`);
              if (trialElement) {
                // Open the details element if closed
                trialElement.open = true;
                trialElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add highlight effect
                trialElement.classList.add('ring-4', 'ring-blue-400', 'ring-opacity-75');
                setTimeout(() => {
                  trialElement.classList.remove('ring-4', 'ring-blue-400', 'ring-opacity-75');
                }, 2000);
              }
            }, 150);
          };

          const navigateToTrialCard = (trialName, category) => {
            if (!trialName) return;
            navigateTo('library', { subTab: 'trials' });
            if (category) setTrialsCategory(category);
            const trialSlug = String(trialName).toLowerCase()
              .replace(/\s+trial$/i, '')
              .replace(/[^a-z0-9]/g, '-')
              .replace(/-+/g, '-')
              .replace(/^-|-$/g, '');
            setTimeout(() => {
              const trialElement = document.getElementById(`trial-${trialSlug}`);
              if (trialElement) {
                trialElement.open = true;
                trialElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                trialElement.classList.add('ring-4', 'ring-blue-400', 'ring-opacity-75');
                setTimeout(() => {
                  trialElement.classList.remove('ring-4', 'ring-blue-400', 'ring-opacity-75');
                }, 2000);
              }
            }, 180);
          };

          const isTrialActivelyRecruiting = (trial) => {
            const status = String(trial?.status || '').toLowerCase().trim();
            if (!status) return false;
            if (status.includes('not yet recruiting')) return false;
            if (status.includes('active, not recruiting')) return false;
            if (status.includes('closed') || status.includes('completed') || status.includes('terminated') || status.includes('withdrawn') || status.includes('suspended')) return false;
            return status.includes('recruiting') || status.includes('enrolling');
          };

          const filterTrialsForDisplay = (trials = []) => {
            if (!trialsRecruitingOnly) return trials;
            return trials.filter((trial) => isTrialActivelyRecruiting(trial));
          };

          const countTrialsInCategory = (categoryData, { filtered = false } = {}) => {
            if (!categoryData) return 0;
            const listForCount = (trials) => (filtered ? filterTrialsForDisplay(trials) : (trials || []));
            if (categoryData.hasSubsections) {
              return Object.values(categoryData.subsections).reduce((acc, subsection) => acc + listForCount(subsection.trials).length, 0);
            }
            return listForCount(categoryData.trials).length;
          };

          const setVisibleTrialCardsOpen = (shouldOpen) => {
            requestAnimationFrame(() => {
              const trialCards = document.querySelectorAll('#tabpanel-trials details[id^="trial-"]');
              trialCards.forEach((card) => {
                card.open = !!shouldOpen;
              });
            });
          };

          // Render trial card — called as function (not JSX component) to preserve <details> open state across re-renders
          const renderTrialCard = (trial, category, key) => {
            const getCategoryColor = (cat) => {
              switch(cat) {
                case 'ischemic': return 'bg-blue-600 text-white';
                case 'ich': return 'bg-red-600 text-white';
                case 'rehab': return 'bg-emerald-600 text-white';
                case 'cadasil': return 'bg-purple-600 text-white';
                default: return 'bg-slate-600 text-white';
              }
            };

            const getCategoryBorderColor = (cat) => {
              switch(cat) {
                case 'ischemic': return 'border-blue-200';
                case 'ich': return 'border-red-200';
                case 'rehab': return 'border-emerald-200';
                case 'cadasil': return 'border-purple-200';
                default: return 'border-slate-200';
              }
            };

            // Create a slug-friendly ID from the trial name
            const trialSlug = trial.name.toLowerCase()
              .replace(/\s+trial$/i, '')
              .replace(/[^a-z0-9]/g, '-')
              .replace(/-+/g, '-')
              .replace(/^-|-$/g, '');
            const criteriaPreviewCount = settings.workflowPersona === 'trainee' ? 8 : 6;
            const inclusionItems = Array.isArray(trial.inclusion) ? trial.inclusion : [];
            const exclusionItems = Array.isArray(trial.exclusion) ? trial.exclusion : [];
            const inclusionPreview = inclusionItems.slice(0, criteriaPreviewCount);
            const exclusionPreview = exclusionItems.slice(0, criteriaPreviewCount);
            const inclusionRemainder = inclusionItems.slice(criteriaPreviewCount);
            const exclusionRemainder = exclusionItems.slice(criteriaPreviewCount);

            return (
              <details
                key={key}
                id={`trial-${trialSlug}`}
                className={`bg-white rounded-lg shadow-md overflow-hidden border-2 ${getCategoryBorderColor(category)} hover:shadow-lg transition-shadow`}
              >
                <summary className={`${getCategoryColor(category)} p-4 cursor-pointer list-none`}>
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <h3 className="text-xl font-bold mb-2">{trial.name}</h3>
                      <div className="flex flex-wrap gap-2 mb-3">
                        <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-semibold">
                          {trial.phase}
                        </span>
                        {trial.status && (
                          <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-semibold">
                            {trial.status}
                          </span>
                        )}
                      </div>
                      <p className="text-white text-opacity-95">{trial.description}</p>
                    </div>
                    <div className="ml-4">
                      <svg
                        className="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </div>
                  </div>
                  <div className="mt-3 flex items-center">
                    {trial.nct.startsWith('NCT') ? (
                      <button
                        className="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center"
                        onClick={(e) => {
                          e.stopPropagation();
                          window.open(`https://clinicaltrials.gov/study/${trial.nct}`, '_blank');
                        }}
                      >
                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        {trial.nct}
                      </button>
                    ) : (
                      <span className="text-sm opacity-90">Reference: {trial.nct}</span>
                    )}
                  </div>
                </summary>

                <div className="bg-slate-50 p-4 border-t border-slate-200">
                  <div className="mb-4 flex flex-wrap items-center gap-2 text-xs">
                    <span className="px-2.5 py-1 rounded-full border border-emerald-200 bg-emerald-50 text-emerald-800 font-semibold">
                      Inclusion: {inclusionItems.length}
                    </span>
                    <span className="px-2.5 py-1 rounded-full border border-red-200 bg-red-50 text-red-800 font-semibold">
                      Exclusion: {exclusionItems.length}
                    </span>
                    <span className="px-2.5 py-1 rounded-full border border-slate-200 bg-white text-slate-600">
                      Scan top criteria first, then expand full list
                    </span>
                  </div>
                  {/* Key Takeaways - pulled from TRIAL_ELIGIBILITY_CONFIG by NCT */}
                  {(() => {
                    const matchedConfig = Object.values(TRIAL_ELIGIBILITY_CONFIG).find(c => c.nct === trial.nct);
                    if (!matchedConfig || !matchedConfig.keyTakeaways || matchedConfig.keyTakeaways.length === 0) return null;
                    return (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <h4 className="font-bold text-blue-800 mb-2 text-sm flex items-center gap-1.5">
                          <i aria-hidden="true" data-lucide="lightbulb" className="w-4 h-4"></i>
                          Key Takeaways
                        </h4>
                        <ul className="space-y-1">
                          {matchedConfig.keyTakeaways.map((t, i) => (
                            <li key={i} className="text-sm text-blue-900 flex gap-2">
                              <span className="text-blue-500 mt-0.5 shrink-0">&#8227;</span>
                              <span>{t}</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                    );
                  })()}
                  <div className="grid md:grid-cols-2 gap-6">
                    <div>
                      <h4 className="font-bold text-emerald-700 mb-3 text-lg">Inclusion Criteria</h4>
                      <ul className="space-y-2">
                        {inclusionPreview.map((item, idx) => (
                          <li key={idx} className="flex items-start">
                            <span className="text-emerald-500 mr-2 mt-1">•</span>
                            <span className="text-slate-700 text-sm leading-relaxed">{item}</span>
                          </li>
                        ))}
                      </ul>
                      {inclusionRemainder.length > 0 && (
                        <details className="mt-3 rounded-lg border border-emerald-200 bg-white">
                          <summary className="cursor-pointer px-3 py-2 text-sm font-semibold text-emerald-800 hover:bg-emerald-50">
                            Show remaining {inclusionRemainder.length} inclusion criteria
                          </summary>
                          <ul className="px-3 pb-3 space-y-2">
                            {inclusionRemainder.map((item, idx) => (
                              <li key={`inc-rem-${idx}`} className="flex items-start">
                                <span className="text-emerald-500 mr-2 mt-1">•</span>
                                <span className="text-slate-700 text-sm leading-relaxed">{item}</span>
                              </li>
                            ))}
                          </ul>
                        </details>
                      )}
                    </div>
                    <div>
                      <h4 className="font-bold text-red-700 mb-3 text-lg">Exclusion Criteria</h4>
                      <ul className="space-y-2">
                        {exclusionPreview.map((item, idx) => (
                          <li key={idx} className="flex items-start">
                            <span className="text-red-500 mr-2 mt-1">•</span>
                            <span className="text-slate-700 text-sm leading-relaxed">{item}</span>
                          </li>
                        ))}
                      </ul>
                      {exclusionRemainder.length > 0 && (
                        <details className="mt-3 rounded-lg border border-red-200 bg-white">
                          <summary className="cursor-pointer px-3 py-2 text-sm font-semibold text-red-800 hover:bg-red-50">
                            Show remaining {exclusionRemainder.length} exclusion criteria
                          </summary>
                          <ul className="px-3 pb-3 space-y-2">
                            {exclusionRemainder.map((item, idx) => (
                              <li key={`exc-rem-${idx}`} className="flex items-start">
                                <span className="text-red-500 mr-2 mt-1">•</span>
                                <span className="text-slate-700 text-sm leading-relaxed">{item}</span>
                              </li>
                            ))}
                          </ul>
                        </details>
                      )}
                    </div>
                  </div>
                  {trial.nct.startsWith('NCT') && (
                    <div className="mt-6 pt-4 border-t border-slate-200 text-center">
                      <button
                        className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center"
                        onClick={() => window.open(`https://clinicaltrials.gov/study/${trial.nct}`, '_blank')}
                      >
                        <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        View Full Details on ClinicalTrials.gov
                      </button>
                    </div>
                  )}
                </div>
              </details>
            );
          };


          // NIH Stroke Scale items
          const nihssItems = [
            { id: 'consciousness', name: '1a. Level of Consciousness', options: ['Alert (0)', 'Drowsy (1)', 'Stuporous (2)', 'Coma (3)'] },
            { id: 'loc_questions', name: '1b. LOC Questions', options: ['Both correct (0)', 'One correct (1)', 'Neither correct (2)'] },
            { id: 'loc_commands', name: '1c. LOC Commands', options: ['Obeys both correctly (0)', 'Obeys one correctly (1)', 'Neither correctly (2)'] },
            { id: 'best_gaze', name: '2. Best Gaze', options: ['Normal (0)', 'Partial gaze palsy (1)', 'Forced deviation (2)'] },
            { id: 'visual', name: '3. Visual', options: ['No visual loss (0)', 'Partial hemianopia (1)', 'Complete hemianopia (2)', 'Bilateral hemianopia (3)'] },
            { id: 'facial_palsy', name: '4. Facial Palsy', options: ['Normal (0)', 'Minor asymmetry (1)', 'Partial facial paralysis (2)', 'Complete facial paralysis (3)'] },
            { id: 'motor_arm_left', name: '5a. Motor Arm-Left', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_arm_right', name: '5b. Motor Arm-Right', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_leg_left', name: '6a. Motor Leg-Left', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_leg_right', name: '6b. Motor Leg-Right', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'limb_ataxia', name: '7. Limb Ataxia', options: ['Absent (0)', 'Present in upper or lower (1)', 'Present in both (2)'] },
            { id: 'sensory', name: '8. Sensory', options: ['Normal (0)', 'Partial loss (1)', 'Dense loss (2)'] },
            { id: 'language', name: '9. Best Language†', options: ['No aphasia (0)', 'Mild-moderate aphasia (1)', 'Severe aphasia (2)', 'Mute, global aphasia (3)'] },
            { id: 'dysarthria', name: '10. Dysarthria†', options: ['Normal articulation (0)', 'Mild-moderate slurring (1)', 'Severe dysarthria (2)', 'Intubated/other (UN)'] },
            { id: 'extinction', name: '11. Extinction and Inattention', options: ['No neglect (0)', 'Visual, tactile, auditory, spatial, or personal inattention (1)', 'Profound hemi-inattention (2)'] }
          ];

          // Calculate NIHSS score
          const calculateNIHSS = (responses) => {
            const total = Object.values(responses).reduce((sum, response) => {
              if (typeof response !== 'string') return sum;
              if (response.includes('UN')) return sum; // Untestable items do not contribute to total
              const match = response.match(/\((\d+)\)/);
              const score = match ? parseInt(match[1], 10) : 0;
              return sum + (isNaN(score) ? 0 : score);
            }, 0);
            return Math.min(total, 42);
          };

          // Calculate ASPECTS score
          const calculateASPECTS = (regions) => {
            return regions.filter(region => region.checked).length;
          };

          // Calculate PC-ASPECTS score
          const calculatePCAspects = (regions) => {
            return regions.reduce((total, region) => {
              return total + (region.checked ? region.points : 0);
            }, 0);
          };

          // Calculate GCS score
          const calculateGCS = (items) => {
            const rawEye = parseInt(items.eye || 0, 10) || 0;
            const rawVerbal = parseInt(items.verbal || 0, 10) || 0;
            const rawMotor = parseInt(items.motor || 0, 10) || 0;
            if (rawEye === 0 && rawVerbal === 0 && rawMotor === 0) return 0; // Not entered
            const eye = Math.min(4, Math.max(1, rawEye || 1));
            const verbal = Math.min(5, Math.max(1, rawVerbal || 1));
            const motor = Math.min(6, Math.max(1, rawMotor || 1));
            return eye + verbal + motor;
          };

          // Calculate ICH score
          const calculateICHScore = (items) => {
            let score = 0;
            if (items.gcs === 'gcs34') score += 2;
            else if (items.gcs === 'gcs512') score += 1;
            if (items.age80) score += 1;
            if (items.volume30) score += 1;
            if (items.ivh) score += 1;
            if (items.infratentorial) score += 1;
            return score;
          };

          // Calculate ABCD2 score
          const calculateABCD2Score = (items) => {
            let score = 0;
            if (items.age60) score += 1;
            if (items.bp) score += 1;
            if (items.unilateralWeakness) score += 2;
            if (items.speechDisturbance && !items.unilateralWeakness) score += 1;
            if (items.duration === 'duration10') score += 1;
            else if (items.duration === 'duration60') score += 2;
            if (items.diabetes) score += 1;
            return score;
          };

          // Calculate CHADS2-VASc score
          const calculateCHADS2VascScore = (items) => {
            let score = 0;
            if (items.chf) score += 1;
            if (items.hypertension) score += 1;
            if (items.age75) score += 2;
            else if (items.age65) score += 1;
            if (items.diabetes) score += 1;
            if (items.strokeTia) score += 2;
            if (items.vascular) score += 1;
            if (items.female) score += 1;
            return score;
          };

          // Calculate ROPE score
          const calculateROPEScore = (items) => {
            let score = 0;
            if (items.noHypertension) score += 1;
            if (items.noDiabetes) score += 1;
            if (items.noStrokeTia) score += 1;
            if (items.nonsmoker) score += 1;
            if (items.cortical) score += 1;

            // Age points
            const age = parseInt(items.age, 10) || 0;
            if (age >= 18 && age <= 29) score += 5;
            else if (age >= 30 && age <= 39) score += 4;
            else if (age >= 40 && age <= 49) score += 3;
            else if (age >= 50 && age <= 59) score += 2;
            else if (age >= 60 && age <= 69) score += 1;
            // 70+ years gets 0 points

            return score;
          };

          // Calculate HAS-BLED score
          const calculateHASBLEDScore = (items) => {
            let score = 0;
            if (items.hypertension) score += 1;
            if (items.renalDisease) score += 1;
            if (items.liverDisease) score += 1;
            if (items.stroke) score += 1;
            if (items.bleeding) score += 1;
            if (items.labileINR) score += 1;
            if (items.elderly) score += 1;
            if (items.drugs) score += 1;
            if (items.alcohol) score += 1;
            return score;
          };

          // Calculate RCVS2 score
          const calculateRCVS2Score = (items) => {
            let score = 0;
            if (items.recurrentTCH) score += 5;
            if (items.carotidInvolvement) score -= 2; // Carotid involvement suggests PACNS, not RCVS
            if (items.vasoconstrictiveTrigger) score += 3;
            if (items.female) score += 1;
            if (items.sah) score += 1; // Convexity SAH favors RCVS
            return Math.max(0, score);
          };

          // Calculate PHASES score for unruptured intracranial aneurysm rupture risk
          const calculatePHASESScore = (items) => {
            let score = 0;
            // Population
            if (items.population === 'japanese') score += 3;
            else if (items.population === 'finnish') score += 5;
            // Hypertension
            if (items.hypertension) score += 1;
            // Age ≥70
            if (items.age70) score += 1;
            // Size
            const size = parseFloat(items.size) || 0;
            if (size >= 20) score += 10;
            else if (size >= 10) score += 6;
            else if (size >= 7) score += 3;
            // Earlier SAH from different aneurysm
            if (items.earlierSAH) score += 1;
            // Site
            if (items.site === 'mca') score += 2;
            else if (items.site === 'aca_pcomm_posterior') score += 4;
            return score;
          };

          const getPHASESRisk = (score) => {
            if (score <= 2) return { risk: '0.4%', level: 'Very low' };
            if (score <= 4) return { risk: '0.7%', level: 'Low' };
            if (score <= 6) return { risk: '1.5%', level: 'Low-Moderate' };
            if (score <= 8) return { risk: '2.4%', level: 'Moderate' };
            if (score <= 10) return { risk: '3.6%', level: 'Moderate-High' };
            return { risk: '17.8%', level: 'High' };
          };

          // =================================================================
          // ICH VOLUME CALCULATOR (ABC/2 method)
          // =================================================================
          const calculateICHVolume = (items) => {
            const a = parseFloat(items.lengthCm) || 0;
            const b = parseFloat(items.widthCm) || 0;
            const c = parseFloat(items.slicesCm) || 0;
            if (a <= 0 || b <= 0 || c <= 0) return null;
            const volume = (a * b * c) / 2;
            return { volume: Math.round(volume * 10) / 10, isLarge: volume >= 30, isExpanding: false };
          };

          // =================================================================
          // WEIGHT-BASED MEDICATION DOSING CALCULATORS
          // =================================================================
          const calculateEnoxaparinDose = (weightKg, crCl) => {
            const weight = parseFloat(weightKg) || 0;
            const parsedCrCl = parseFloat(crCl);
            const renalClearance = (!isNaN(parsedCrCl) && parsedCrCl > 0) ? parsedCrCl : null;
            if (weight <= 0 || weight > 350) return null;
            const crClUnknown = renalClearance === null;
            const isRenalAdjusted = renalClearance !== null && renalClearance < 30;
            // Treatment dose: 1 mg/kg
            const treatmentDose = Math.round(weight * 1);
            // Prophylaxis dose: fixed 40 mg (30 mg if CrCl <30, 40 mg q12h if >100 kg)
            const prophylaxisDose = isRenalAdjusted ? 30 : 40;
            const prophylaxisFreq = weight > 100 && !isRenalAdjusted ? 'q12h' : 'daily';
            const crClWarning = crClUnknown ? ' ⚠ CrCl unknown — verify renal function before dosing' : '';
            const obesityWarning = treatmentDose > 150 ? ' ⚠ Treatment dose >150 mg — consider anti-Xa monitoring (target 0.5-1.0 IU/mL at 4h post-dose) for morbid obesity' : '';
            // Once-daily treatment: 1.5 mg/kg (alternative to BID, max ~180 mg)
            const dailyTreatmentDose = Math.round(weight * 1.5);
            const dailyTreatmentNote = isRenalAdjusted
              ? `Daily treatment: ${treatmentDose} mg SC daily (CrCl <30 — use 1 mg/kg daily)`
              : `Daily treatment (alternative): ${dailyTreatmentDose} mg SC daily`;
            const dailyTreatmentWarning = dailyTreatmentDose > 180 ? ' ⚠ Daily dose >180 mg — consider BID dosing with anti-Xa monitoring' : '';
            return {
              dose: treatmentDose,
              dailyDose: dailyTreatmentDose,
              frequency: isRenalAdjusted ? 'daily' : 'BID',
              isRenalAdjusted,
              crClUnknown,
              note: (isRenalAdjusted ? `Treatment: ${treatmentDose} mg SC daily (CrCl <30)` : `Treatment: ${treatmentDose} mg SC BID`) + crClWarning + obesityWarning,
              dailyTreatmentNote: dailyTreatmentNote + dailyTreatmentWarning + crClWarning,
              prophylaxisNote: `VTE Prophylaxis: ${prophylaxisDose} mg SC ${prophylaxisFreq}${isRenalAdjusted ? ' (renal-adjusted)' : ''}${weight > 100 && !isRenalAdjusted ? ' (weight >100 kg)' : ''}` + crClWarning
            };
          };

          const calculateAndexanetDose = (doacType, lastDoseHours, doacDoseMg) => {
            const hours = Math.max(0, parseFloat(lastDoseHours) || 0);
            const doseMg = Math.max(0, parseFloat(doacDoseMg) || 0);
            const isApixaban = (doacType || '').toLowerCase().includes('apixaban');
            const isRivaroxaban = (doacType || '').toLowerCase().includes('rivaroxaban');
            const lowDose = { regimen: 'low-dose', bolus: '400 mg IV over 15-30 min', infusion: '4 mg/min x 120 min (480 mg)', total: '880 mg', doseWarning: null };
            const highDose = { regimen: 'high-dose', bolus: '800 mg IV over 15-30 min', infusion: '8 mg/min x 120 min (960 mg)', total: '1760 mg', doseWarning: null };
            if (isApixaban) {
              // FDA label: low-dose for apixaban ≤5mg regardless of time, OR any dose ≥8h ago
              if (hours >= 8) return lowDose;
              if (doseMg > 0 && doseMg <= 5) return { ...lowDose, doseWarning: 'Low-dose regimen: apixaban dose ≤5 mg (per FDA label).' };
              if (doseMg > 5) return { ...highDose, doseWarning: 'High-dose regimen: apixaban >5 mg and last dose <8h ago.' };
              // Dose unknown, <8h — default low-dose with warning (standard dose is 5mg BID)
              return { ...lowDose, doseWarning: 'DOAC dose not entered. Standard apixaban (5 mg BID) → low-dose. If patient was on 10 mg BID and last dose <8h, use high-dose. Enter DOAC dose to confirm.' };
            }
            if (isRivaroxaban) {
              // FDA label: low-dose for rivaroxaban ≤10mg regardless of time, OR any dose ≥8h ago
              if (hours >= 8) return lowDose;
              if (doseMg > 0 && doseMg <= 10) return { ...lowDose, doseWarning: 'Low-dose regimen: rivaroxaban dose ≤10 mg (per FDA label).' };
              if (doseMg > 10) return { ...highDose, doseWarning: 'High-dose regimen: rivaroxaban >10 mg and last dose <8h ago.' };
              // Dose unknown, <8h — default high-dose with warning (common dose is 20mg)
              return { ...highDose, doseWarning: 'DOAC dose not entered. Common rivaroxaban dose (20 mg daily) → high-dose. If patient was on ≤10 mg, use low-dose. Enter DOAC dose to confirm.' };
            }
            return { regimen: 'N/A', bolus: 'Not applicable for this DOAC', infusion: '', total: '', doseWarning: null };
          };

          // =================================================================
          // TNK DOSING CALCULATOR (0.25 mg/kg, max 25 mg)
          // =================================================================
          // =================================================================
          // COCKCROFT-GAULT CrCl CALCULATOR
          // =================================================================
          const calculateCrCl = (age, weight, sex, creatinine, heightCm) => {
            const a = parseFloat(age);
            const w = parseFloat(weight);
            const cr = parseFloat(creatinine);
            if (!a || !w || !cr || a <= 0 || w <= 0 || cr < 0.1) return null;
            if (a > 120) return null;
            if (sex !== 'M' && sex !== 'F') return null;
            const sexFactor = (sex === 'F') ? 0.85 : 1.0;
            const crcl = ((140 - a) * w * sexFactor) / (72 * cr);
            // BMI-based obesity check (if height available)
            const h = parseFloat(heightCm);
            const bmi = (h && h > 0) ? w / ((h / 100) ** 2) : null;
            const isObese = bmi && bmi > 30;
            // Adjusted body weight CrCl for obese patients
            let adjBwCrCl = null;
            if (isObese && h > 0) {
              const heightIn = h / 2.54;
              const ibw = Math.max(30, sex === 'M' ? 50 + 2.3 * (heightIn - 60) : 45.5 + 2.3 * (heightIn - 60));
              const adjBw = ibw + 0.4 * (w - ibw);
              adjBwCrCl = Math.round(((140 - a) * adjBw * sexFactor) / (72 * cr) * 10) / 10;
            }
            return {
              value: Math.round(crcl * 10) / 10,
              adjBwValue: adjBwCrCl,
              isLow: crcl < 30,
              isBorderline: crcl >= 30 && crcl < 50,
              isObese,
              bmi: bmi ? Math.round(bmi * 10) / 10 : null,
              renalCategory: crcl < 15 ? 'severe-dialysis' : crcl < 30 ? 'severe' : crcl < 50 ? 'moderate' : crcl < 90 ? 'mild' : 'normal',
              label: crcl < 15 ? 'Severe (consider dialysis)' : crcl < 30 ? 'Severe (<30)' : crcl < 50 ? 'Moderate (30-49)' : crcl < 90 ? 'Mild (50-89)' : 'Normal (≥90)',
              obesityWarning: isObese ? `BMI >30 — CrCl may be overestimated. Adjusted body weight CrCl: ${adjBwCrCl} mL/min. Use AdjBW CrCl for DOAC dosing decisions.` : null
            };
          };

          const calculateTNKDose = (weightKg) => {
            const weight = parseFloat(weightKg);
            if (isNaN(weight) || weight <= 0 || weight > 350) return null;

            // TNK dosing: 0.25 mg/kg, maximum 25 mg, rounded to nearest 0.5 mg (syringe precision)
            const rawDose = weight * 0.25;
            const finalDose = Math.min(Math.round(rawDose * 2) / 2, 25);

            // Pre-calculated doses for common weight ranges
            const doseTable = [
              { minWeight: 0, maxWeight: 59.9, dose: 'Variable (0.25 mg/kg)', vial: 'Calculate' },
              { minWeight: 60, maxWeight: 69.9, dose: '15-17.5 mg', vial: '3-3.5 mL' },
              { minWeight: 70, maxWeight: 79.9, dose: '17.5-20 mg', vial: '3.5-4 mL' },
              { minWeight: 80, maxWeight: 89.9, dose: '20-22.5 mg', vial: '4-4.5 mL' },
              { minWeight: 90, maxWeight: 99.9, dose: '22.5-25 mg', vial: '4.5-5 mL' },
              { minWeight: 100, maxWeight: Infinity, dose: '25 mg (MAX)', vial: '5 mL' }
            ];

            return {
              weightKg: weight,
              calculatedDose: finalDose.toFixed(1),
              volume: `${(finalDose / 5).toFixed(1)} mL`,
              isMaxDose: rawDose >= 25,
              doseTable
            };
          };

          // =================================================================
          // PCC DOSE CALCULATOR (AHA weight-based reference alongside fixed-dose)
          // =================================================================
          const calculatePCCDose = (weightKg, inrVal) => {
            const weight = parseFloat(weightKg);
            const inr = parseFloat(inrVal);
            if (isNaN(weight) || weight <= 0 || weight > 350) return null;
            let iuPerKg = null;
            let inrTierNote = '';
            if (!isNaN(inr)) {
              if (inr < 1.3) { iuPerKg = null; inrTierNote = 'INR <1.3 — PCC likely not needed; give Vitamin K 10 mg IV'; }
              else if (inr < 2) { iuPerKg = 25; inrTierNote = 'INR 1.3-1.9 — consider 4F-PCC 25 IU/kg (COR 2b/C)'; }
              else if (inr < 4) { iuPerKg = 25; inrTierNote = 'INR 2.0-3.9 — 4F-PCC 25 IU/kg (COR 1/B)'; }
              else if (inr <= 6) { iuPerKg = 35; inrTierNote = 'INR 4.0-6.0 — 4F-PCC 35 IU/kg (COR 1/B)'; }
              else { iuPerKg = 50; inrTierNote = 'INR >6 — 4F-PCC 50 IU/kg (COR 1/B)'; }
            }
            const ahaDose = iuPerKg ? Math.min(Math.round(weight * iuPerKg), 5000) : null;
            return { fixedDose: 2000, ahaDose, iuPerKg, weight, inrTierNote };
          };

          // =================================================================
          // ALTEPLASE (tPA) DOSE CALCULATOR
          // =================================================================
          const calculateAlteplaseDose = (weightKg) => {
            const weight = parseFloat(weightKg);
            if (isNaN(weight) || weight <= 0 || weight > 350) return null;
            const totalDose = Math.min(+(weight * 0.9).toFixed(1), 90);
            const bolus = +(totalDose * 0.1).toFixed(1);
            const infusion = +(totalDose * 0.9).toFixed(1);
            return { totalDose, bolus, infusion, weightKg: weight, capped: weight * 0.9 > 90 };
          };

          // =================================================================
          // BP THRESHOLD CHECKER FOR THROMBOLYSIS
          // =================================================================
          const getBPThresholdStatus = (bpString) => {
            if (!bpString || typeof bpString !== 'string') {
              return { status: 'unknown', systolic: null, diastolic: null };
            }

            const bpMatch = bpString.match(/(\d{2,3})\s*\/\s*(\d{2,3})/);
            if (!bpMatch) {
              return { status: 'unknown', systolic: null, diastolic: null };
            }

            const systolic = parseInt(bpMatch[1], 10);
            const diastolic = parseInt(bpMatch[2], 10);

            if (isNaN(systolic) || isNaN(diastolic)) {
              return { status: 'unknown', systolic: null, diastolic: null };
            }

            // Thresholds for TNK/tPA eligibility
            const MAX_SBP = 185;
            const MAX_DBP = 110;
            const BORDERLINE_SBP_LOW = 175;
            const BORDERLINE_DBP_LOW = 105;

            let status = 'ok';
            let message = 'OK for lysis';
            let badgeClass = 'bg-emerald-100 text-emerald-800 border-emerald-300';
            let icon = '';

            // Check if too high (absolute contraindication)
            if (systolic > MAX_SBP || diastolic > MAX_DBP) {
              status = 'too_high';
              message = 'Too high for TNK';
              badgeClass = 'bg-red-100 text-red-800 border-red-300';
              icon = '[X]';
            }
            // Check if borderline
            else if ((systolic >= BORDERLINE_SBP_LOW && systolic <= MAX_SBP) ||
                     (diastolic >= BORDERLINE_DBP_LOW && diastolic <= MAX_DBP)) {
              status = 'borderline';
              message = 'Borderline';
              badgeClass = 'bg-amber-100 text-amber-800 border-amber-300';
              icon = '[!]';
            }

            // Calculate how much to lower if too high
            const sbpToLower = Math.max(0, systolic - MAX_SBP);
            const dbpToLower = Math.max(0, diastolic - MAX_DBP);

            return {
              status,
              systolic,
              diastolic,
              message,
              badgeClass,
              icon,
              sbpToLower,
              dbpToLower,
              needsLowering: sbpToLower > 0 || dbpToLower > 0
            };
          };

          // =================================================================
          // 4-FACTOR PCC (KCENTRA) DOSING CALCULATOR
          // =================================================================
          const calculate4FPCC = (weightKg, inr) => {
            const weight = parseFloat(weightKg);
            const inrValue = parseFloat(inr);
            if (isNaN(weight) || weight <= 0 || weight > 350) return null;

            let unitsPerKg;
            let description;

            if (isNaN(inrValue)) {
              unitsPerKg = 25;
              description = 'INR unknown — using default 25 IU/kg';
            } else if (inrValue < 1.3) {
              unitsPerKg = null;
              description = 'INR <1.3 — PCC likely not needed; give Vitamin K 10 mg IV';
            } else if (inrValue < 2) {
              unitsPerKg = 25;
              description = 'INR 1.3-1.9 — consider PCC 25 IU/kg (COR 2b/C)';
            } else if (inrValue < 4) {
              unitsPerKg = 25;
              description = 'INR 2.0-3.9 — PCC 25 IU/kg (COR 1/B)';
            } else if (inrValue <= 6) {
              unitsPerKg = 35;
              description = 'INR 4.0-6.0 — PCC 35 IU/kg (COR 1/B)';
            } else {
              unitsPerKg = 50;
              description = 'INR >6 — PCC 50 IU/kg (COR 1/B)';
            }

            const totalDose = unitsPerKg ? Math.min(weight * unitsPerKg, 5000) : null;

            return {
              weightKg: weight,
              inr: inrValue || 'unknown',
              unitsPerKg,
              totalDose: totalDose ? Math.round(totalDose) : null,
              isMaxDose: unitsPerKg ? weight * unitsPerKg >= 5000 : false,
              description
            };
          };

          // =================================================================
          // DTN (DOOR-TO-NEEDLE) TIME CALCULATIONS
          // =================================================================
          const calculateDTNMetrics = () => {
            const metrics = {
              doorToCT: null,
              doorToNeedle: null,
              ctToNeedle: null,
              doorToPuncture: null,
              timestamps: {}
            };

            // Parse timestamps (validated)
            const edArrival = safeParseDt(telestrokeNote.dtnEdArrival);
            const ctStarted = safeParseDt(telestrokeNote.dtnCtStarted);
            const ctRead = safeParseDt(telestrokeNote.dtnCtRead);
            const tnkAdmin = safeParseDt(telestrokeNote.dtnTnkAdministered);

            metrics.timestamps = {
              edArrival,
              strokeAlert: safeParseDt(telestrokeNote.dtnStrokeAlert),
              ctStarted,
              ctRead,
              tnkOrdered: safeParseDt(telestrokeNote.dtnTnkOrdered),
              tnkAdmin
            };

            // Door-to-CT: ED Arrival → CT started
            if (edArrival && ctStarted) {
              const diffMs = ctStarted - edArrival;
              const diffMins = Math.round(diffMs / (1000 * 60));
              metrics.doorToCT = diffMins;
            }

            // Door-to-Needle (DTN): ED Arrival → TNK administered
            if (edArrival && tnkAdmin) {
              const diffMs = tnkAdmin - edArrival;
              const diffMins = Math.round(diffMs / (1000 * 60));
              metrics.doorToNeedle = diffMins;
            }

            // CT-to-Needle: CT read → TNK administered
            if (ctRead && tnkAdmin) {
              const diffMs = tnkAdmin - ctRead;
              const diffMins = Math.round(diffMs / (1000 * 60));
              metrics.ctToNeedle = diffMins;
            }

            // Door-to-Puncture (DTP): ED Arrival → Puncture time
            if (edArrival && telestrokeNote.punctureTime) {
              const [pH, pM] = telestrokeNote.punctureTime.split(':').map(Number);
              if (!isNaN(pH) && !isNaN(pM)) {
                const punctureDate = new Date(edArrival);
                punctureDate.setHours(pH, pM, 0, 0);
                if (punctureDate < edArrival) punctureDate.setDate(punctureDate.getDate() + 1);
                const dtpMinutes = Math.round((punctureDate - edArrival) / (1000 * 60));
                // Cap at 24h — values >24h likely indicate data entry error
                if (dtpMinutes >= 0 && dtpMinutes <= 1440) {
                  metrics.doorToPuncture = dtpMinutes;
                }
              }
            }

            return metrics;
          };

          // Get DTN benchmark status and color
          const getDTNBenchmark = (dtnMinutes) => {
            if (dtnMinutes === null) return null;
            if (dtnMinutes <= 45) {
              return {
                status: 'excellent',
                color: 'green',
                label: 'Excellent',
                target: 45,
                delta: dtnMinutes - 45
              };
            } else if (dtnMinutes <= 60) {
              return {
                status: 'good',
                color: 'yellow',
                label: 'Good',
                target: 60,
                delta: dtnMinutes - 45 // Compare to ideal target
              };
            } else {
              return {
                status: 'needs_improvement',
                color: 'red',
                label: 'Needs Improvement',
                target: 60,
                delta: dtnMinutes - 60
              };
            }
          };

          // Format DTN metrics for Epic note
          const formatDTNForNote = () => {
            const metrics = calculateDTNMetrics();
            if (!metrics.doorToNeedle && !metrics.doorToPuncture && !metrics.doorToCT) return '';

            const benchmark = getDTNBenchmark(metrics.doorToNeedle);
            let noteText = '\nTime Metrics:\n';

            if (metrics.doorToCT !== null) {
              noteText += `Door-to-CT: ${metrics.doorToCT} minutes\n`;
            }
            if (metrics.doorToNeedle !== null) {
              noteText += `Door-to-Needle (DTN): ${metrics.doorToNeedle} minutes`;

              if (benchmark) {
                noteText += ` (${benchmark.label}`;
                if (benchmark.delta > 0) {
                  noteText += `, +${benchmark.delta} min over ${benchmark.target} min target`;
                } else if (benchmark.delta < 0) {
                  noteText += `, ${Math.abs(benchmark.delta)} min under ${benchmark.target} min target`;
                }
                noteText += ')';
              }
              noteText += '\n';
            }

            if (metrics.ctToNeedle !== null) {
              noteText += `CT-to-Needle: ${metrics.ctToNeedle} minutes\n`;
            }

            if (metrics.doorToPuncture !== null) {
              noteText += `Door-to-Puncture (DTP): ${metrics.doorToPuncture} minutes${metrics.doorToPuncture <= 90 ? '' : ' (exceeded 90 min target)'}\n`;
            }

            return noteText;
          };

          // =================================================================
          // CONTRAINDICATION DETECTION
          // =================================================================
          const detectContraindications = (data) => {
            const alerts = [];

            // Glucose check
            const glucose = parseFloat(data.telestrokeNote?.glucose);
            if (!isNaN(glucose)) {
              if (glucose < 50) {
                alerts.push({ severity: 'critical', label: 'Hypoglycemia — TNK CONTRAINDICATION', message: `Glucose ${glucose} mg/dL (<50) — CONTRAINDICATION to thrombolysis. Correct to >100 mg/dL and reassess neurologic deficit before TNK eligibility.`, field: 'glucose' });
              } else if (glucose > 400) {
                alerts.push({ severity: 'warning', label: 'Severe hyperglycemia', message: `Glucose ${glucose} mg/dL - Correct; if deficits persist, IVT remains eligible`, field: 'glucose' });
              }
            }

            // INR check
            const inr = parseFloat(data.telestrokeNote?.inr);
            if (!isNaN(inr) && inr > 1.7) {
              alerts.push({ severity: 'critical', label: 'Elevated INR', message: `INR ${inr.toFixed(1)} >1.7 - tPA/TNK CONTRAINDICATED`, field: 'inr' });
            }

            // Platelet check (value stored in K/μL, e.g. 150 = 150,000/μL)
            const platelets = parseFloat(data.telestrokeNote?.plateletCount);
            if (!isNaN(platelets) && platelets < 100) {
              alerts.push({ severity: 'critical', label: 'Low Platelets', message: `Platelets ${platelets}K/μL (<100K) - tPA/TNK CONTRAINDICATED`, field: 'plateletCount' });
            }

            // aPTT check
            const ptt = parseFloat(data.telestrokeNote?.ptt);
            if (!isNaN(ptt) && ptt > 40) {
              alerts.push({ severity: 'critical', label: 'Elevated aPTT', message: `aPTT ${ptt}s (>40s) - tPA/TNK CONTRAINDICATED`, field: 'ptt' });
            }

            // ICH/SAH diagnosis check
            const diagCat = data.telestrokeNote?.diagnosisCategory;
            if (diagCat === 'ich' || diagCat === 'sah') {
              alerts.push({ severity: 'critical', label: diagCat === 'sah' ? 'SAH Diagnosis' : 'ICH Diagnosis', message: `${diagCat.toUpperCase()} diagnosis - Thrombolytics CONTRAINDICATED`, field: 'diagnosisCategory' });
            }

            // Heparin/LMWH/Fondaparinux check
            const acType = data.telestrokeNote?.lastDOACType;
            if (acType === 'heparin' || acType === 'lmwh') {
              const acName = acType === 'heparin' ? 'Heparin' : 'LMWH';
              alerts.push({ severity: 'warning', label: `Recent ${acName}`, message: `${acName} use - Check aPTT (must be ≤40s for TNK eligibility)`, field: 'lastDOACType' });
            }
            if (acType === 'fondaparinux') {
              alerts.push({ severity: 'warning', label: 'Fondaparinux', message: 'Fondaparinux (t½ 17-21h) — check anti-Xa level. No specific reversal. Thrombolysis may be considered if anti-Xa undetectable.', field: 'lastDOACType' });
            }

            // BP check (parse from string like "185/110")
            const bp = data.telestrokeNote?.presentingBP || '';
            const bpMatch = bp.match(/(\d+)\s*\/\s*(\d+)/);
            if (bpMatch) {
              const systolic = parseInt(bpMatch[1], 10);
              const diastolic = parseInt(bpMatch[2], 10);
              if (systolic > 185 || diastolic > 110) {
                alerts.push({ severity: 'warning', label: 'Elevated BP', message: `${systolic}/${diastolic} exceeds 185/110 - Must lower before TNK`, field: 'presentingBP' });
              }
            }

            // DOAC check (renal-adjusted clearance threshold)
            if (data.telestrokeNote?.lastDOACType && data.telestrokeNote?.lastDOACDose) {
              const doacType = data.telestrokeNote.lastDOACType;
              if (doacType !== 'warfarin' && doacType !== 'heparin' && doacType !== 'lmwh' && doacType !== 'fondaparinux' && doacType !== 'none') {
                const lastDose = new Date(data.telestrokeNote.lastDOACDose);
                if (Number.isNaN(lastDose.getTime())) {
                  alerts.push({ severity: 'info', label: 'DOAC Date', message: 'Could not parse DOAC last dose date/time — verify and re-enter', field: 'lastDOACDose' });
                } else {
                const now = new Date();
                const hoursSinceDose = (now - lastDose) / (1000 * 60 * 60);
                if (hoursSinceDose < 0) {
                  alerts.push({ severity: 'error', label: 'DOAC Time Error', message: 'Last DOAC dose is in the future — verify date/time entry', field: 'lastDOACDose' });
                } else {
                const crcl = calculateCrCl(data.telestrokeNote?.age, data.telestrokeNote?.weight, data.telestrokeNote?.sex, data.telestrokeNote?.creatinine, data.telestrokeNote?.height);
                const crclVal = crcl ? crcl.value : null;
                const halfLifeMap = { apixaban: crclVal && crclVal < 30 ? 15 : 10, rivaroxaban: crclVal && crclVal < 30 ? 13 : 9, dabigatran: crclVal && crclVal < 30 ? 28 : crclVal && crclVal < 50 ? 18 : 14, edoxaban: crclVal && crclVal < 30 ? 16 : 12 };
                const estHalfLife = halfLifeMap[doacType] || 12;
                const clearanceThreshold = estHalfLife * 5; // 5 half-lives ≈97% cleared
                const threshold = Math.max(48, clearanceThreshold);
                if (hoursSinceDose < threshold) {
                  const doacName = ANTICOAGULANT_INFO[doacType]?.name || doacType;
                  const renalNote = crclVal && crclVal < 50 ? ` (CrCl ${Math.round(crclVal)} — clearance prolonged)` : !crclVal ? ' (CrCl unknown — enter for renal-adjusted estimate)' : '';
                  alerts.push({ severity: 'warning', label: 'Recent DOAC', message: `${doacName} ${hoursSinceDose.toFixed(0)}h ago${renalNote} - Check drug-specific assay`, field: 'lastDOACDose' });
                }
                }
                }
              }
            }

            // Age + NIHSS check (SPAN-100)
            const age = parseInt(data.telestrokeNote?.age, 10);
            const nihss = parseInt(data.telestrokeNote?.nihss, 10);
            if (!isNaN(age) && !isNaN(nihss) && (age + nihss >= 100)) {
              alerts.push({ severity: 'info', label: 'SPAN-100', message: `Age ${age} + NIHSS ${nihss} = ${age + nihss} ≥100 - Higher sICH risk`, field: 'nihss' });
            }

            // Time window check
            const lkwDate = data.telestrokeNote?.lkwDate;
            const lkwTime = data.telestrokeNote?.lkwTime;
            if (lkwDate && lkwTime) {
              const lkw = new Date(`${lkwDate}T${lkwTime}`);
              if (!Number.isNaN(lkw.getTime())) {
              const now = new Date();
              const hoursFromLKW = (now - lkw) / (1000 * 60 * 60);
              const wakeUpExtended = data.telestrokeNote?.wakeUpStrokeWorkflow?.extendEligible;
              if (hoursFromLKW > 4.5 && data.telestrokeNote?.tnkRecommended && !wakeUpExtended) {
                alerts.push({ severity: 'warning', label: 'Late Window', message: `${hoursFromLKW.toFixed(1)}h from LKW - Verify imaging criteria`, field: 'lkwTime' });
              } else if (hoursFromLKW > 4.5 && data.telestrokeNote?.tnkRecommended && wakeUpExtended) {
                alerts.push({ severity: 'info', label: 'Extended Window', message: `${hoursFromLKW.toFixed(1)}h from LKW - Wake-up stroke extended eligibility active`, field: 'lkwTime' });
              }
              }
            }

            // ACE inhibitor angioedema risk pre-TNK
            const medsLower = (data.telestrokeNote?.medications || '').toLowerCase();
            if (/lisinopril|enalapril|ramipril|captopril|benazepril|fosinopril|quinapril|perindopril|trandolapril|moexipril/.test(medsLower)) {
              alerts.push({ severity: 'warning', label: 'ACE-I + TNK', message: 'ACE inhibitor detected — 5x increased angioedema risk with thrombolysis. Prepare airway management.', field: 'medications' });
            }

            // Dual antiplatelet therapy detection
            const antiplatelets = [];
            if (/aspirin|asa\b|ecotrin/.test(medsLower)) antiplatelets.push('aspirin');
            if (/clopidogrel|plavix/.test(medsLower)) antiplatelets.push('clopidogrel');
            if (/ticagrelor|brilinta/.test(medsLower)) antiplatelets.push('ticagrelor');
            if (/prasugrel|effient/.test(medsLower)) antiplatelets.push('prasugrel');
            if (antiplatelets.length >= 2) {
              alerts.push({ severity: 'warning', label: 'DAPT', message: `Dual antiplatelet (${antiplatelets.join(' + ')}) — increased hemorrhage risk with TNK. Weigh benefit vs bleed risk.`, field: 'medications' });
            }

            // PT check
            const ptVal = parseFloat(data.telestrokeNote?.pt);
            if (!isNaN(ptVal) && ptVal > 15) {
              alerts.push({ severity: 'critical', label: 'Elevated PT', message: `PT ${ptVal.toFixed(1)}s (>15s) — tPA/TNK CONTRAINDICATED`, field: 'pt' });
            }

            // Pediatric age exclusion
            if (!isNaN(age) && age < 18) {
              alerts.push({ severity: 'critical', label: 'Pediatric Patient', message: `Age ${age} (<18) — IV thrombolysis eligibility requires age ≥18 per AHA/ASA guidelines`, field: 'age' });
            }

            // Pregnancy + DOAC contraindication
            if (data.telestrokeNote?.pregnancyStroke && ['apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban'].includes(acType)) {
              const pregnancyDoacName = ANTICOAGULANT_INFO[acType]?.name || acType;
              alerts.push({ severity: 'critical', label: 'Pregnancy + DOAC', message: `Pregnant/postpartum on ${pregnancyDoacName} — DOACs contraindicated in pregnancy. Switch to LMWH or UFH.`, field: 'pregnancyStroke' });
            }

            // Low weight warning for thrombolytic dosing
            const weight = parseFloat(data.telestrokeNote?.weight);
            if (!isNaN(weight) && weight > 0 && weight < 30) {
              alerts.push({ severity: 'warning', label: 'Low Weight', message: `Weight ${weight} kg (<30 kg) — verify actual weight; thrombolytic dosing may be subtherapeutic`, field: 'weight' });
            }

            return alerts;
          };

          // Privacy: Persist app data and update lastUpdated (TTL handled globally)
          const saveWithExpiration = (key, data) => {
            try {
              setKey(key, data);
              setSaveStatus('saved');
              setLastSaved(new Date());
            } catch (e) {
              setSaveStatus('error');
              console.error('Save failed:', e);
              if (e.name === 'QuotaExceededError' || e.code === 22) {
                addToast('Storage full — data may not be saved. Export your note or clear old data.', 'error');
              }
            }
          };

          const loadWithExpiration = (key, defaultValue) => {
            try {
              return loadFromStorage(key, defaultValue);
            } catch (e) {
              console.warn('Load failed:', e);
              return defaultValue;
            }
          };

          // Batched debounced save — collects all pending writes and flushes them together
          const pendingWritesRef = React.useRef({});
          const batchSaveTimerRef = React.useRef(null);

          const debouncedSave = React.useCallback((key, data) => {
            pendingWritesRef.current[key] = data;
            if (batchSaveTimerRef.current) clearTimeout(batchSaveTimerRef.current);
            batchSaveTimerRef.current = setTimeout(() => {
              setSaveStatus('saving');
              const writes = { ...pendingWritesRef.current };
              pendingWritesRef.current = {};
              let anyFailed = false;
              for (const [k, v] of Object.entries(writes)) {
                try {
                  saveWithExpiration(k, v);
                } catch (e) {
                  // Re-queue failed writes so they retry on next flush
                  pendingWritesRef.current[k] = v;
                  anyFailed = true;
                  console.error('Partial save failed for key:', k, e);
                }
              }
              if (anyFailed) {
                setSaveStatus('error');
                addToast('Some data failed to save — will retry automatically.', 'error');
              }
            }, 1000);
          }, []);

          // ====================================
          // SHIFT MANAGEMENT FUNCTIONS
          // ============================================

          // Generate unique patient ID
          const generatePatientId = () => {
            return `pt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          };

          // Get current patient summary for display
          const getCurrentPatientSummary = () => {
            const age = telestrokeNote.age || '?';
            const sex = telestrokeNote.sex || '?';
            const symptoms = telestrokeNote.symptoms || 'Stroke symptoms';
            const nihss = telestrokeNote.nihss || nihssScore || '?';
            const timeFromLKW = calculateTimeFromLKW();
            const timeDisplay = timeFromLKW ? `${timeFromLKW.hours}h ${timeFromLKW.minutes}m` : '?';

            // Determine primary vessel/syndrome
            let vesselInfo = '';
            const vessels = telestrokeNote.vesselOcclusion || [];
            if (vessels.includes('M1')) vesselInfo = 'M1';
            else if (vessels.includes('ICA')) vesselInfo = 'ICA';
            else if (vessels.includes('M2')) vesselInfo = 'M2';
            else if (telestrokeNote.ctaResults) {
              const ctaLower = String(telestrokeNote.ctaResults).toLowerCase();
              if (ctaLower.includes('m1')) vesselInfo = 'M1';
              else if (ctaLower.includes('ica')) vesselInfo = 'ICA';
            }

            return {
              age,
              sex,
              symptoms: symptoms.substring(0, 30) + (symptoms.length > 30 ? '...' : ''),
              nihss,
              timeFromLKW: timeDisplay,
              vesselInfo,
              shortLabel: `${age}${sex} ${vesselInfo || 'AIS'} NIHSS ${nihss}`,
              fullLabel: `${age}yo ${sex === 'M' ? 'M' : sex === 'F' ? 'F' : '?'}, ${vesselInfo || 'Stroke'}, NIHSS ${nihss}, ${timeDisplay} from LKW`
            };
          };

          // Count trials by eligibility status
          const getTrialEligibilitySummary = () => {
            const counts = { eligible: 0, needsInfo: 0, notEligible: 0, total: 0 };
            Object.values(trialEligibility).forEach(result => {
              if (!result) return;
              counts.total++;
              if (result.status === 'eligible') counts.eligible++;
              else if (result.status === 'needs_info') counts.needsInfo++;
              else if (result.status === 'not_eligible') counts.notEligible++;
            });
            return counts;
          };

          // Save current patient to shift list
          const saveCurrentPatientToShift = () => {
            const patientId = currentPatientId || generatePatientId();
            const summary = getCurrentPatientSummary();
            const trialSummary = getTrialEligibilitySummary();

            const patientSnapshot = {
              id: patientId,
              timestamp: Date.now(),
              summary,
              trialSummary,
              // Save form state for restoration
              formState: {
                telestrokeNote: { ...telestrokeNote },
                strokeCodeForm: { ...strokeCodeForm },
                lkwTime: lkwTime ? lkwTime.toISOString() : null,
                nihssScore,
                aspectsScore,
                mrsScore,
                gcsItems: { ...gcsItems },
                ichScoreItems: { ...ichScoreItems },
                abcd2Items: { ...abcd2Items },
                chads2vascItems: { ...chads2vascItems },
                ropeItems: { ...ropeItems },
                huntHessGrade,
                wfnsGrade,
                hasbledItems: { ...hasbledItems },
                rcvs2Items: { ...rcvs2Items },
                phasesItems: { ...phasesItems },
                evtDecisionInputs: { ...evtDecisionInputs },
                doacProtocol,
                currentStep,
                completedSteps: [...completedSteps]
              }
            };

            setShiftPatients(prev => {
              // Update existing or add new
              const existingIndex = prev.findIndex(p => p.id === patientId);
              if (existingIndex >= 0) {
                const updated = [...prev];
                updated[existingIndex] = patientSnapshot;
                return updated;
              }
              return [...prev, patientSnapshot];
            });

            if (!currentPatientId) {
              setCurrentPatientId(patientId);
            }

            return patientId;
          };

          // Switch to a different patient from shift list
          const switchToPatient = (patientId) => {
            // First save current patient if any meaningful data exists
            if (currentPatientId && (telestrokeNote.age || telestrokeNote.diagnosis || telestrokeNote.nihss || nihssScore > 0)) {
              saveCurrentPatientToShift();
            }

            // Find and load the selected patient
            const patient = shiftPatients.find(p => p.id === patientId);
            if (!patient) {
              showNotice('Patient not found in shift list', 'warning');
              return;
            }

            const { formState } = patient;
            setTelestrokeNote(formState.telestrokeNote);
            setStrokeCodeForm(formState.strokeCodeForm);
            setLkwTime(safeParseDt(formState.lkwTime));
            setNihssScore(formState.nihssScore);
            setAspectsScore(formState.aspectsScore);
            setMrsScore(formState.mrsScore);
            setGcsItems(formState.gcsItems || { eye: '', verbal: '', motor: '' });
            if (formState.ichScoreItems) setIchScoreItems(formState.ichScoreItems);
            if (formState.abcd2Items) setAbcd2Items(formState.abcd2Items);
            if (formState.chads2vascItems) setChads2vascItems(formState.chads2vascItems);
            if (formState.ropeItems) setRopeItems(formState.ropeItems);
            if (formState.huntHessGrade !== undefined) setHuntHessGrade(formState.huntHessGrade);
            if (formState.wfnsGrade !== undefined) setWfnsGrade(formState.wfnsGrade);
            if (formState.hasbledItems) setHasbledItems(formState.hasbledItems);
            if (formState.rcvs2Items) setRcvs2Items(formState.rcvs2Items);
            if (formState.phasesItems) setPhasesItems(formState.phasesItems);
            if (formState.evtDecisionInputs) setEvtDecisionInputs(formState.evtDecisionInputs);
            if (formState.doacProtocol) setDoacProtocol(formState.doacProtocol);
            if (formState.currentStep !== undefined) setCurrentStep(formState.currentStep);
            if (formState.completedSteps) setCompletedSteps(formState.completedSteps);
            setCurrentPatientId(patientId);

          };

          // Start a new patient (save current first)
          const startNewPatient = () => {
            // Save current if any meaningful data exists
            if (telestrokeNote.age || telestrokeNote.diagnosis || telestrokeNote.nihss || nihssScore > 0) {
              saveCurrentPatientToShift();
            }

            clearCurrentCase({ generateNewId: true });
          };

          // Remove patient from shift list
          const removePatientFromShift = (patientId) => {
            setShiftPatients(prev => prev.filter(p => p.id !== patientId));
            if (currentPatientId === patientId) {
              setCurrentPatientId(null);
            }
          };

          const extractTemplateVariables = (text) => {
            if (!text) return [];
            const matches = text.match(/{[A-Z0-9_]+}/g) || [];
            return [...new Set(matches.map((match) => match.replace(/[{}]/g, '')))];
          };

          const fillTemplate = (template, values) => {
            if (!template) return '';
            return template.replace(/{([A-Z0-9_]+)}/g, (match, key) => {
              const replacement = values[key];
              return replacement === null || replacement === undefined ? '' : String(replacement);
            });
          };

          const buildEncounterTemplateContext = () => {
            const lkw = telestrokeNote.lkwDate && telestrokeNote.lkwTime
              ? `${telestrokeNote.lkwDate} ${telestrokeNote.lkwTime}`
              : '';
            return {
              PATIENT_ALIAS: telestrokeNote.alias || '',
              AGE: telestrokeNote.age || '',
              SEX: telestrokeNote.sex || '',
              NIHSS: telestrokeNote.nihss || nihssScore || '',
              DIAGNOSIS: telestrokeNote.diagnosis || '',
              LVO: (telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None').join(', '),
              WEIGHT_KG: telestrokeNote.weight || '',
              LKW: lkw,
              ARRIVAL: telestrokeNote.dtnEdArrival ? new Date(telestrokeNote.dtnEdArrival).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '',
              CT_TIME: telestrokeNote.ctTime || '',
              CTA_TIME: telestrokeNote.ctaTime || '',
              CT_RESULTS: telestrokeNote.ctResults || '',
              CTA_RESULTS: telestrokeNote.ctaResults || '',
              CTP_RESULTS: telestrokeNote.ctpResults || '',
              ASPECTS: aspectsScore !== 10 ? aspectsScore : '',
              TNK_STATUS: telestrokeNote.tnkRecommended ? (telestrokeNote.tnkAdminTime ? `Given at ${telestrokeNote.tnkAdminTime}` : 'Recommended') : 'Not given',
              EVT_STATUS: telestrokeNote.evtRecommended ? 'Recommended' : 'Not recommended',
              DISPOSITION: telestrokeNote.disposition || '',
              TRANSFER_STATUS: telestrokeNote.transferAccepted ? 'Accepted' : '',
              PENDING_ITEMS: telestrokeNote.recommendationsText || '',
              ICH_SCORE: calculateICHScore(ichScoreItems),
              GCS: calculateGCS(gcsItems),
              BP: telestrokeNote.presentingBP || '',
              HEMATOMA: telestrokeNote.ctResults || '',
              IVH: telestrokeNote.ctResults ? (String(telestrokeNote.ctResults).toLowerCase().includes('ivh') ? 'IVH present' : 'No IVH') : '',
              REVERSAL: telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType] ? ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal?.primary || '' : ''
            };
          };

          const getSelectedClipboardPack = () => {
            return clipboardPacks.find((pack) => pack.id === selectedPackId) || clipboardPacks[0] || null;
          };

          const buildClipboardPackSections = (pack) => {
            if (!pack) return [];
            const context = buildEncounterTemplateContext();
            return (pack.sections || [])
              .filter((section) => section.enabled)
              .map((section) => ({
                title: section.title,
                body: fillTemplate(section.template, context)
              }));
          };

          const copySelectedClipboardPack = async () => {
            const pack = getSelectedClipboardPack();
            if (!pack) return;
            const sections = buildClipboardPackSections(pack);
            const ok = await copyWithSectionHeaders(sections);
            if (ok) {
              setCopiedText('Clipboard pack');
            }
          };

          const updateShiftBoard = (boardId, updater) => {
            updateAppData((prev) => ({
              ...prev,
              shiftBoards: prev.shiftBoards.map((board) => {
                if (board.id !== boardId) return board;
                const updated = updater(board);
                return { ...updated, updatedAt: toIsoString() };
              })
            }));
          };

          const setActiveShiftBoard = (boardId) => {
            updateAppData((prev) => ({
              ...prev,
              uiState: { ...prev.uiState, lastShiftBoardId: boardId }
            }));
          };

          const addShiftBoard = async () => {
            const name = await showConfirm({
              title: 'New Board',
              input: true,
              inputLabel: 'Board name',
              placeholder: 'New Board',
              defaultValue: 'New Board',
              confirmLabel: 'Create'
            });
            if (!name) return;
            const boardId = generateId('board');
            updateAppData((prev) => ({
              ...prev,
              shiftBoards: [
                {
                  id: boardId,
                  name: String(name).trim() || 'New Board',
                  createdAt: toIsoString(),
                  updatedAt: toIsoString(),
                  archived: false,
                  patients: []
                },
                ...prev.shiftBoards
              ],
              uiState: { ...prev.uiState, lastShiftBoardId: boardId }
            }));
          };

          const renameShiftBoard = async (boardId) => {
            const board = shiftBoards.find((item) => item.id === boardId);
            if (!board) return;
            const name = await showConfirm({
              title: 'Rename Board',
              input: true,
              inputLabel: 'Board name',
              defaultValue: board.name,
              confirmLabel: 'Rename'
            });
            if (!name) return;
            updateShiftBoard(boardId, (current) => ({ ...current, name: String(name).trim() || current.name }));
          };

          const archiveShiftBoard = (boardId, archived = true) => {
            updateShiftBoard(boardId, (current) => ({ ...current, archived }));
          };

          const addShiftPatientCard = () => {
            if (!activeShiftBoard) return;
            const patient = {
              id: generateId('pt'),
              alias: generateAlias(),
              label: '',
              location: '',
              problemSummary: '',
              tasks: [],
              pendingResults: [],
              freeNotes: ''
            };
            updateShiftBoard(activeShiftBoard.id, (board) => ({
              ...board,
              patients: [patient, ...(board.patients || [])]
            }));
          };

          const updateShiftPatient = (patientId, updates) => {
            if (!activeShiftBoard) return;
            updateShiftBoard(activeShiftBoard.id, (board) => ({
              ...board,
              patients: (board.patients || []).map((patient) => patient.id === patientId ? { ...patient, ...updates } : patient)
            }));
          };

          const removeShiftPatient = (patientId) => {
            if (!activeShiftBoard) return;
            updateShiftBoard(activeShiftBoard.id, (board) => ({
              ...board,
              patients: (board.patients || []).filter((patient) => patient.id !== patientId)
            }));
          };

          const addShiftTask = (patientId, text) => {
            if (!activeShiftBoard || !text) return;
            updateShiftBoard(activeShiftBoard.id, (board) => ({
              ...board,
              patients: (board.patients || []).map((patient) => {
                if (patient.id !== patientId) return patient;
                const task = {
                  id: generateId('task'),
                  text: text.trim(),
                  priority: 'med',
                  owner: 'me',
                  dueAt: '',
                  status: 'todo',
                  createdAt: toIsoString(),
                  completedAt: null
                };
                return { ...patient, tasks: [task, ...(patient.tasks || [])] };
              })
            }));
          };

          const promptAddShiftTask = async () => {
            if (!activeShiftBoard || !(activeShiftBoard.patients || []).length) {
              showNotice('Add a patient before creating a task.', 'warning');
              return;
            }
            const taskText = await showConfirm({
              title: 'New Task',
              input: true,
              inputLabel: 'Task description',
              placeholder: 'e.g., Check INR at 6h',
              confirmLabel: 'Add Task'
            });
            if (!taskText) return;
            const targetPatient = activeShiftBoard.patients[0];
            addShiftTask(targetPatient.id, String(taskText));
          };

          const updateShiftTask = (patientId, taskId, updates) => {
            if (!activeShiftBoard) return;
            updateShiftBoard(activeShiftBoard.id, (board) => ({
              ...board,
              patients: (board.patients || []).map((patient) => {
                if (patient.id !== patientId) return patient;
                return {
                  ...patient,
                  tasks: (patient.tasks || []).map((task) => task.id === taskId
                    ? {
                        ...task,
                        ...updates,
                        completedAt: updates.status === 'done' ? toIsoString() : task.completedAt
                      }
                    : task)
                };
              })
            }));
          };

          const addPendingResult = (patientId, label) => {
            if (!activeShiftBoard || !label) return;
            updateShiftBoard(activeShiftBoard.id, (board) => ({
              ...board,
              patients: (board.patients || []).map((patient) => {
                if (patient.id !== patientId) return patient;
                const result = {
                  id: generateId('result'),
                  label: label.trim(),
                  status: 'pending',
                  dueAt: '',
                  resultSummary: ''
                };
                return { ...patient, pendingResults: [result, ...(patient.pendingResults || [])] };
              })
            }));
          };

          const updatePendingResult = (patientId, resultId, updates) => {
            if (!activeShiftBoard) return;
            updateShiftBoard(activeShiftBoard.id, (board) => ({
              ...board,
              patients: (board.patients || []).map((patient) => {
                if (patient.id !== patientId) return patient;
                return {
                  ...patient,
                  pendingResults: (patient.pendingResults || []).map((result) => result.id === resultId ? { ...result, ...updates } : result)
                };
              })
            }));
          };

          const generateRoundsChecklist = (board) => {
            if (!board) return '';
            let text = `ROUNDS CHECKLIST - ${board.name}\n---\n`;
            (board.patients || []).forEach((patient) => {
              text += `${patient.alias || 'Patient'}${patient.label ? ` (${patient.label})` : ''}\n`;
              if (patient.problemSummary) text += `- Summary: ${patient.problemSummary}\n`;
              const openTasks = (patient.tasks || []).filter((task) => task.status !== 'done');
              if (openTasks.length) {
                text += `- Tasks:\n`;
                openTasks.forEach((task) => {
                  text += `  • ${task.text} (${task.priority})\n`;
                });
              }
              const pending = (patient.pendingResults || []).filter((result) => result.status !== 'resulted');
              if (pending.length) {
                text += `- Pending:\n`;
                pending.forEach((result) => {
                  text += `  • ${result.label}\n`;
                });
              }
              text += '\n';
            });
            return text.trim();
          };

          // ============================================
          // ENCOUNTER HISTORY
          // ============================================
          const saveEncounterToHistory = React.useCallback(() => {
            if (!telestrokeNote.age && !nihssScore && !telestrokeNote.diagnosis) return;
            const snapshot = {
              id: generateId('enc'),
              timestamp: Date.now(),
              age: telestrokeNote.age,
              sex: telestrokeNote.sex,
              diagnosis: telestrokeNote.diagnosis || 'No diagnosis',
              nihss: telestrokeNote.nihss || nihssScore || 0,
              tnk: telestrokeNote.tnkRecommended ? 'Yes' : 'No',
              evt: telestrokeNote.evtRecommended ? 'Yes' : 'No',
              consultationType
            };
            setEncounterHistory(prev => {
              const next = [snapshot, ...prev].slice(0, 20);
              try { localStorage.setItem('strokeApp:encounterHistory', JSON.stringify(next)); } catch {}
              return next;
            });
          }, [telestrokeNote, nihssScore, consultationType]);

          // ============================================
          // KEYBOARD SHORTCUTS
          // ============================================
          useEffect(() => {
            const handleKeyDown = (e) => {
              const primary = e.metaKey || e.ctrlKey;
              const key = String(e.key || '');
              const lowerKey = key.toLowerCase();
              const targetTag = e.target?.tagName?.toLowerCase?.() || '';
              const targetIsInput = targetTag === 'input' || targetTag === 'textarea' || targetTag === 'select' || !!e.target?.isContentEditable;
              const activeTag = document.activeElement?.tagName?.toLowerCase?.() || '';
              const activeIsInput = activeTag === 'input' || activeTag === 'textarea' || activeTag === 'select' || !!document.activeElement?.isContentEditable;

              // Escape — close one layer at a time
              if (key === 'Escape') {
                if (settingsMenuOpen) { setSettingsMenuOpen(false); return; }
                if (searchOpen) { setSearchOpen(false); return; }
                if (showKeyboardHelp) { setShowKeyboardHelp(false); return; }
                if (showChangelog) { setShowChangelog(false); return; }
                if (confirmConfig) { handleConfirmClose(null); return; }
                if (protocolModal) { setProtocolModal(null); return; }
                if (calcDrawerOpen) { setCalcDrawerOpen(false); return; }
                if (focusMode) { setFocusMode(false); return; }
                return;
              }

              // Cmd/Ctrl + K — open global search
              if (primary && !e.shiftKey && !e.altKey && lowerKey === 'k') {
                e.preventDefault();
                setSearchOpen(true);
                setSearchContext('header');
                requestAnimationFrame(() => {
                  document.querySelector('input[placeholder*="Search"]')?.focus();
                });
                return;
              }

              // "/" — focus search when not typing
              if (!primary && !e.altKey && key === '/' && !targetIsInput) {
                e.preventDefault();
                setSearchOpen(true);
                setSearchContext('header');
                requestAnimationFrame(() => {
                  document.querySelector('input[placeholder*="Search"]')?.focus();
                });
                return;
              }

              // "?" — toggle keyboard help (outside inputs)
              if (!primary && !e.altKey && key === '?' && !targetIsInput) {
                e.preventDefault();
                setShowKeyboardHelp(prev => !prev);
                return;
              }

              // Ctrl/Cmd+Shift+C — copy consult note
              if (primary && e.shiftKey && !e.altKey && lowerKey === 'c') {
                e.preventDefault();
                const note = generateNoteRef.current?.();
                if (note) copyToClipboardRef.current?.(note, 'consult-note');
                return;
              }

              // Ctrl/Cmd+Shift+N — jump to next required/recommended encounter field
              if (primary && e.shiftKey && !e.altKey && lowerKey === 'n') {
                e.preventDefault();
                jumpToNextRequiredEncounterField();
                return;
              }

              // Ctrl/Cmd+Shift+K — toggle calculators
              if (primary && e.shiftKey && !e.altKey && lowerKey === 'k') {
                e.preventDefault();
                setCalcDrawerOpen(prev => !prev);
                return;
              }

              // Ctrl/Cmd+Shift+F — toggle focus mode
              if (primary && e.shiftKey && !e.altKey && lowerKey === 'f') {
                e.preventDefault();
                setFocusMode(prev => !prev);
                return;
              }

              // Ctrl/Cmd + E — export PDF
              if (primary && !e.shiftKey && !e.altKey && lowerKey === 'e') {
                e.preventDefault();
                exportToPDFRef.current?.();
                return;
              }

              // Ctrl/Cmd + 1/2/3/4 — tab navigation
              if (primary && !e.shiftKey && !e.altKey) {
                const tabMap = {
                  '1': { tab: 'dashboard' },
                  '2': { tab: 'encounter' },
                  '3': { tab: 'library' },
                  '4': { tab: 'settings' }
                };
                if (tabMap[key]) {
                  e.preventDefault();
                  const target = tabMap[key];
                  navigateToRef.current?.(target.tab, { subTab: target.subTab });
                  return;
                }
              }

              // Remaining plain-key shortcuts should not fire while typing
              if (targetIsInput || activeIsInput) return;

              // 1/2/3/4 — switch encounter phases when in encounter tab
              if (!primary && !e.altKey && !e.shiftKey) {
                const phaseMap = {
                  '1': 'phase-triage',
                  '2': 'phase-decision',
                  '3': 'phase-management',
                  '4': 'phase-documentation'
                };
                if (phaseMap[key] && activeTab === 'encounter') {
                  e.preventDefault();
                  setEncounterPhase(phaseMap[key]);
                  scrollToSection(phaseMap[key]);
                  return;
                }
                // M key — mute/unmute timer alerts (encounter only)
                if (lowerKey === 'm' && activeTab === 'encounter') {
                  toggleAlertMute();
                  return;
                }
              }
            };
            document.addEventListener('keydown', handleKeyDown);
            return () => document.removeEventListener('keydown', handleKeyDown);
          }, [activeTab, calcDrawerOpen, protocolModal, confirmConfig, focusMode, settingsMenuOpen, searchOpen, showKeyboardHelp, showChangelog, telestrokeNote.age, telestrokeNote.sex, telestrokeNote.nihss, telestrokeNote.ctResults, telestrokeNote.diagnosis, telestrokeNote.disposition, lkwTime, nihssScore]);


          // Persist shift patients to localStorage
          React.useEffect(() => {
            saveWithExpiration('shiftPatients', shiftPatients);
          }, [shiftPatients]);

          React.useEffect(() => {
            if (currentPatientId) {
              setKey('currentPatientId', currentPatientId);
            }
          }, [currentPatientId]);

          React.useEffect(() => {
            saveAppData(appData);
          }, [appData]);

          const noticeTimeoutRef = React.useRef(null);
          const clearUndoTimeoutRef = React.useRef(null);
          const hasHandledExpiredRef = React.useRef(false);

          const showNotice = (message, type = 'info', options = {}) => {
            const { timeoutMs = 4000, persist = false } = options;
            if (noticeTimeoutRef.current) {
              clearTimeout(noticeTimeoutRef.current);
            }
            setNotice({ message, type });
            addToast(message, type, timeoutMs);
            if (!persist) {
              noticeTimeoutRef.current = setTimeout(() => {
                setNotice(null);
              }, timeoutMs);
            }
          };

          const resetAppStateToDefaults = () => {
            setAppData(getDefaultAppData());
            setPatientData({});
            setNihssScore(0);
            setAspectsScore(10);
            setLkwTime(new Date());
            setStrokeCodeForm(getDefaultStrokeCodeForm());
            setAspectsRegionState(getDefaultAspectsRegionState());
            setPcAspectsRegions(getDefaultPcAspectsRegions());
            setGcsItems({ eye: '', verbal: '', motor: '' });
            setMrsScore('');
            setIchScoreItems({ gcs: '', age80: false, volume30: false, ivh: false, infratentorial: false, lobar: false, preCogImpairment: false });
            setAbcd2Items({ age60: false, bp: false, unilateralWeakness: false, speechDisturbance: false, duration: '', diabetes: false });
            setChads2vascItems({ chf: false, hypertension: false, age75: false, diabetes: false, strokeTia: false, vascular: false, age65: false, female: false });
            setRopeItems({ noHypertension: false, noDiabetes: false, noStrokeTia: false, nonsmoker: false, cortical: false, age: '' });
            setHuntHessGrade('');
            setWfnsGrade('');
            setHasbledItems({ hypertension: false, renalDisease: false, liverDisease: false, stroke: false, bleeding: false, labileINR: false, elderly: false, drugs: false, alcohol: false });
            setRcvs2Items({ recurrentTCH: false, carotidInvolvement: false, vasoconstrictiveTrigger: false, female: false, sah: false });
            setPhasesItems({ population: 'north_american', hypertension: false, age70: false, size: '', earlierSAH: false, site: 'ica' });
            setCurrentStep(0);
            setCompletedSteps([]);
            setShiftPatients([]);
            setCurrentPatientId(null);

            setConsultationType(getDefaultSettings().defaultConsultationType || 'videoTelestroke');
            setManagementSubTab('ich');
            setAlertsMuted(false);
            setLastAlertPlayed(null);
            setAlertFlashing(false);
            setElapsedSeconds(0);
            setTimerSidebarCollapsed(window.innerWidth < 1024);
            setTelestrokeNote(getDefaultTelestrokeNote());
            setEditableTemplate(defaultTelestrokeTemplate);
            setSearchQuery('');
            setSearchResults([]);
            setSearchOpen(false);
            setSearchContext('header');
            setEvidenceFilter('');
            setShowKeyboardHelp(false);
            setCopiedText('');
            setCriticalAlerts([]);
            setTrialsCategory('ischemic');
            setTrialsRecruitingOnly(false);
            setSaveStatus('saved');
            setLastSaved(null);
            setNotice(null);
            setPathwayCollapsed(true);
            setGuidelineRecsExpanded(false);
            setDeidWarnings({});
            setEvtDecisionInputs({ population: 'adult', occlusion: 'lvo', timeWindow: 'auto', aspects: '6-10', mrs: '0-1', nihss: '', pcAspects: '>=6' });
            setDoacProtocol('catalyst');
            setNursingFlowsheetChecks({});
            setAutoSyncCalculators(true);
            setIchVolumeParams({ a: '', b: '', thicknessMm: '', numSlices: '' });
            setWeightUnit('kg');
          };

          const navigateTo = (tab, options = {}) => {
            const { clearSearch = false, subTab = null } = options;
            const rawTab = tab || 'encounter';
            const legacySubTab = LEGACY_MANAGEMENT_TABS[rawTab];
            let nextTab = rawTab;
            let nextLibrarySection = librarySection;

            if (legacySubTab) {
              nextTab = 'library';
            } else if (!VALID_TABS.includes(nextTab)) {
              nextTab = 'encounter';
            }

            if (rawTab === 'management') {
              nextTab = 'library';
              nextLibrarySection = 'management';
            } else if (rawTab === 'trials') {
              nextTab = 'library';
              nextLibrarySection = 'trials';
            } else if (rawTab === 'library') {
              nextLibrarySection = LIBRARY_SECTIONS.includes(subTab) ? subTab : nextLibrarySection || 'management';
            }

            let nextManagementSubTab = managementSubTab;
            if (nextTab === 'management' || nextTab === 'library') {
              const resolvedSubTab = normalizeManagementSubTab(subTab) || legacySubTab || managementSubTab || 'ich';
              nextManagementSubTab = resolvedSubTab;
              setManagementSubTab(resolvedSubTab);
            }

            if (nextTab === 'library') {
              setLibrarySection(nextLibrarySection);
            }

            setActiveTab(nextTab);

            updateAppData((prev) => ({
              ...prev,
              uiState: {
                ...prev.uiState,
                lastActiveTab: nextTab,
                lastManagementSubTab: (nextTab === 'management' || nextTab === 'library') ? nextManagementSubTab : prev.uiState.lastManagementSubTab,
                lastLibrarySection: nextTab === 'library' ? nextLibrarySection : prev.uiState.lastLibrarySection
              }
            }));

            if (clearSearch) {
              setSearchQuery('');
              setSearchResults([]);
              setSearchOpen(false);
              setSearchContext('header');
            }
          };
          navigateToRef.current = navigateTo;

          const setSearchHighlight = (id) => {
            updateAppData((prev) => ({
              ...prev,
              uiState: {
                ...prev.uiState,
                searchHighlightId: id
              }
            }));
          };

          // Utility Functions
          const shouldPersistFreeText = settings.allowFreeTextStorage === true;

          const updateSettings = (updates) => {
            updateAppData((prev) => ({
              ...prev,
              settings: {
                ...prev.settings,
                ...updates
              }
            }));
          };


          const addDecisionLogEntry = (label, detail = '') => {
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            setTelestrokeNote((prev) => ({
              ...prev,
              decisionLog: [
                { id: generateId('decision'), label, detail, time },
                ...(prev.decisionLog || [])
              ]
            }));
          };

          const appendMedication = (medication) => {
            setTelestrokeNote((prev) => {
              const current = (prev.medications || '').trim();
              const next = current ? `${current}, ${medication}` : medication;
              return { ...prev, medications: next };
            });
          };


          const updateContacts = (contacts) => {
            updateSettings({ contacts });
          };


          const formatDateTimeDisplay = (value) => {
            if (!value) return '';
            const parsed = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(parsed.getTime())) return String(value);
            return parsed.toLocaleString('en-US', {
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });
          };

          const buildTransferDecisionText = (decision, reason = '') => {
            const age = telestrokeNote.age || '?';
            const sex = telestrokeNote.sex || '?';
            const nihss = telestrokeNote.nihss || nihssScore || '?';
            const reference = getReferenceTime();
            const onsetLabel = reference ? reference.label : 'LKW';
            const onsetTime = reference ? formatDateTimeDisplay(reference.time) : 'unknown';
            const decisionLabel = decision === 'accept' ? 'Transfer accepted' : 'Transfer declined';
            const detail = reason ? `Reason: ${reason}` : 'Reason: clinical criteria not met';
            return `${decisionLabel} for ${age}yo ${sex}, NIHSS ${nihss}. ${onsetLabel} ${onsetTime}. ${detail}.`;
          };

          const getHandoffSummaryFields = () => {
            const age = telestrokeNote.age || '--';
            const sex = telestrokeNote.sex || '--';
            const nihss = telestrokeNote.nihss || nihssScore || '--';
            const nihssDetails = telestrokeNote.nihssDetails || '';
            const diagnosis = telestrokeNote.diagnosis
              || (telestrokeNote.diagnosisCategory === 'ischemic'
                ? 'Suspected acute ischemic stroke'
                : telestrokeNote.diagnosisCategory === 'ich'
                  ? 'Intracerebral hemorrhage (ICH)'
                  : telestrokeNote.diagnosisCategory === 'mimic'
                    ? 'Stroke mimic'
                    : 'Diagnosis pending');
            const reference = getReferenceTime();
            const onsetLabel = reference ? reference.label : 'Onset';
            const onsetTime = reference ? formatDateTimeDisplay(reference.time) : 'Unknown';
            const timeFrom = calculateTimeFromLKW();
            const elapsed = timeFrom ? `${timeFrom.hours}h ${timeFrom.minutes}m` : 'Unknown';
            const imagingSummaryParts = [
              `CT: ${telestrokeNote.ctResults || 'pending'}`,
              `CTA: ${telestrokeNote.ctaResults || 'pending'}`
            ];
            {
              const ctpS = telestrokeNote.ctpStructured || {};
              const ctpBits = [];
              if (ctpS.coreVolume) ctpBits.push(`Core ${ctpS.coreVolume}mL`);
              if (ctpS.penumbraVolume) ctpBits.push(`Penumbra ${ctpS.penumbraVolume}mL`);
              if (telestrokeNote.ctpResults) ctpBits.push(telestrokeNote.ctpResults);
              if (ctpBits.length > 0) imagingSummaryParts.push(`CTP: ${ctpBits.join(', ')}`);
            }
            if (telestrokeNote.collateralGrade) imagingSummaryParts.push(`Collaterals: ${telestrokeNote.collateralGrade}`);
            const imagingSummary = imagingSummaryParts.join('; ');
            const tnkDose = telestrokeNote.weight ? calculateTNKDose(telestrokeNote.weight) : null;
            const tnkStatus = telestrokeNote.tnkRecommended
              ? `TNK recommended${tnkDose ? ` (${tnkDose.calculatedDose} mg)` : ''}`
              : 'TNK not recommended';
            const evtStatus = telestrokeNote.evtRecommended ? 'EVT recommended' : 'EVT not recommended';
            const disposition = telestrokeNote.disposition || '';
            const transferStatus = telestrokeNote.transferAccepted
              ? 'Transfer accepted'
              : telestrokeNote.transferRationale
                ? 'Transfer declined'
                : '';
            const transportDetails = telestrokeNote.transportMode
              ? `${telestrokeNote.transportMode}${telestrokeNote.transportEta ? ` ETA ${formatDateTimeDisplay(telestrokeNote.transportEta)}` : ''}`
              : '';
            const imagingShare = telestrokeNote.transferImagingShareMethod
              ? `${telestrokeNote.transferImagingShareMethod}${telestrokeNote.transferImagingShareLink ? ` (${telestrokeNote.transferImagingShareLink})` : ''}`
              : '';

            return {
              age,
              sex,
              nihss,
              nihssDetails,
              diagnosis,
              onsetLabel,
              onsetTime,
              elapsed,
              imagingSummary,
              tnkStatus,
              evtStatus,
              disposition,
              transferStatus,
              transportDetails,
              imagingShare
            };
          };

          const buildHandoffSummary = () => {
            const fields = getHandoffSummaryFields();
            const summaryLines = [
              'Handoff Summary',
              `Age/Sex: ${fields.age}${fields.sex ? ` ${fields.sex}` : ''}`,
              `Dx: ${fields.diagnosis}`,
              `${fields.onsetLabel}: ${fields.onsetTime}${fields.elapsed && fields.elapsed !== 'Unknown' ? ` (${fields.elapsed} elapsed)` : ''}`,
              `NIHSS: ${fields.nihss}${fields.nihssDetails ? ` (${fields.nihssDetails})` : ''}`,
              `Imaging: ${fields.imagingSummary}`,
              `Plan: ${fields.tnkStatus}; ${fields.evtStatus}`
            ];
            if (fields.disposition) summaryLines.push(`Disposition: ${fields.disposition}`);
            if (fields.transferStatus) summaryLines.push(fields.transferStatus);
            if (fields.transportDetails) summaryLines.push(`Transport: ${fields.transportDetails}`);
            if (fields.imagingShare) summaryLines.push(`Imaging share: ${fields.imagingShare}`);
            if (telestrokeNote.rationale) summaryLines.push(`Rationale: ${telestrokeNote.rationale}`);
            if (telestrokeNote.recommendationsText) summaryLines.push(`Recommendations: ${telestrokeNote.recommendationsText}`);
            return summaryLines.filter(Boolean).join('\n');
          };

          const getSafetyChecks = () => {
            const hasOnset = Boolean(getReferenceTime());
            const hasNihss = Boolean(telestrokeNote.nihss || nihssScore);
            const hasBP = Boolean(telestrokeNote.presentingBP);
            const hasGlucose = Boolean(telestrokeNote.glucose);
            const hasCT = Boolean(telestrokeNote.ctResults);
            const hasCTA = Boolean(telestrokeNote.ctaResults);
            const hasWeight = !telestrokeNote.tnkRecommended || Boolean(telestrokeNote.weight);
            const tnkChecklist = !telestrokeNote.tnkRecommended || telestrokeNote.tnkContraindicationReviewed;
            const consent = !telestrokeNote.tnkRecommended || telestrokeNote.tnkConsentDiscussed;

            return [
              { id: 'onset', label: 'Onset time documented', complete: hasOnset },
              { id: 'nihss', label: 'NIHSS documented', complete: hasNihss },
              { id: 'bp', label: 'BP documented', complete: hasBP },
              { id: 'glucose', label: 'Glucose documented', complete: hasGlucose },
              { id: 'ct', label: 'CT results documented', complete: hasCT },
              { id: 'cta', label: 'CTA results documented (if obtained)', complete: hasCTA },
              { id: 'weight', label: 'Weight documented (if TNK)', complete: hasWeight },
              { id: 'tnkChecklist', label: 'TNK contraindications reviewed', complete: tnkChecklist },
              { id: 'consent', label: 'TNK consent discussed', complete: consent }
            ];
          };


          const sanitizeTelestrokeNoteForStorage = (note) => {
            if (shouldPersistFreeText) return note;
            const allowedKeys = [
              'consultStartTime', 'callerName', 'callerRole', 'attendingPhysician',
              'callingSite', 'callingSiteOther',
              'alias', 'age', 'sex', 'weight', 'height', 'nihss', 'vesselOcclusion', 'diagnosisCategory',
              'toastClassification', 'secondaryPrevention',
              'lkwDate', 'lkwTime', 'lkwUnknown', 'discoveryDate', 'discoveryTime', 'ctDate', 'ctTime', 'ctaDate', 'ctaTime', 'tnkAdminTime',
              'presentingBP', 'heartRate', 'spO2', 'temperature', 'bpPreTNK', 'bpPreTNKTime', 'bpPhase', 'bpPostEVT',
              'glucose', 'plateletCount', 'inr', 'pt', 'ptt', 'creatinine', 'disablingDeficit',
              'tnkRecommended', 'evtRecommended', 'tnkContraindicationChecklist',
              'tnkContraindicationReviewed', 'tnkContraindicationReviewTime', 'tnkConsentDiscussed',
              'tnkConsentType', 'tnkConsentTime', 'tnkConsentWith',
              'patientFamilyConsent', 'presumedConsent', 'preTNKSafetyPause', 'tnkAutoBlocked', 'tnkAutoBlockReason',
              'postTnkNeuroChecksStarted', 'postTnkBpMonitoring', 'postTnkRepeatCTOrdered', 'postTnkAntiplateletHeld',
              'sichDetected', 'angioedemaDetected', 'reperfusionHemorrhage', 'clinicalDeterioration', 'complicationNotes',
              'ichBPManaged', 'ichReversalInitiated', 'ichNeurosurgeryConsulted', 'ichSeizureProphylaxis',
              'transferAccepted', 'transferReceivingFacility', 'transferImagingShared', 'transferLabsSent', 'transferIVAccess', 'transferBPStable', 'transferFamilyNotified',
              'transferRationale', 'disposition', 'codeStatus',
              'transferImagingShareMethod', 'transferImagingShareLink', 'transportMode', 'transportEta', 'transportNotes',
              'lastDOACType', 'lastDOACDose',
              'punctureTime',
              'dtnEdArrival', 'dtnStrokeAlert', 'dtnCtStarted', 'dtnCtRead',
              'dtnTnkOrdered', 'dtnTnkAdministered',
              'decisionLog',
              // Free-text clinical data (persisted for note generation)
              'symptoms', 'pmh', 'medications', 'rationale', 'allergies',
              // Structured clinical data
              'diagnosis', 'premorbidMRS', 'affectedSide', 'weightEstimated', 'contrastAllergy',
              'chiefComplaint', 'doorTime', 'needleTime', 'admitLocation',
              'wakeUpStrokeWorkflow', 'recommendationsText', 'consentKit',
              // SAH/CVT/TIA pathway fields
              'sahGrade', 'sahGradeScale', 'sahBPManaged', 'sahNimodipine', 'sahEVDPlaced', 'sahAneurysmSecured', 'sahNeurosurgeryConsulted', 'sahSeizureProphylaxis', 'fisherGrade',
              'sahAneurysmLocation', 'sahAneurysmSize', 'sahSecuringMethod', 'sahVasospasmMonitoring',
              'ichSurgicalCriteria', 'strokeTerritory', 'strokePhenotype',
              'familyCommunication', 'symptomTrajectory', 'symptomOnsetNIHSS', 'postTNKMonitoring',
              'aspectsRegions', 'pcAspectsRegions', 'ticiScore',
              'cvtAnticoagStarted', 'cvtAnticoagType', 'cvtIcpManaged', 'cvtSeizureManaged', 'cvtHematologyConsulted',
              'tiaWorkup', 'tiaWorkupReviewed',
              // Clinical pathway nested objects
              'cardiacWorkup', 'dissectionPathway', 'screeningTools', 'etiologyWorkup',
              'esusWorkup', 'doacTiming', 'hemorrhagicTransformation', 'angioedema',
              'ichAnticoagResumption', 'carotidManagement', 'cvtAnticoag',
              // Nursing/management
              'dysphagiaScreening', 'earlyMobilization', 'vteProphylaxis', 'feverManagement',
              'osmoticTherapy', 'nutritionalSupport',
              // Drug interactions and bridging
              'drugInteractions', 'anticoagBridging',
              // Special workups and assessments
              'youngAdultWorkup', 'drivingRestrictions', 'returnToWork',
              'sexualHealthCounseling', 'airTravelRestrictions',
              'spasticity', 'centralPain', 'fatigue', 'substanceScreening', 'hormonalRisk',
              'palliativeCare', 'fallsRisk', 'pregnancyStroke', 'activeCancer', 'sickleCellDisease', 'infectiveEndocarditis', 'decompressiveCraniectomy', 'rehabReferral',
              // Discharge
              'dischargeChecklist', 'dischargeChecklistReviewed', 'dischargeNIHSS', 'mrsAssessment',
              // Imaging and exam results
              'ctResults', 'ctaResults', 'ctpResults', 'ctpStructured', 'collateralGrade', 'earlyInfarctSigns', 'denseArterySign', 'ekgResults', 'nihssDetails',
              // Inline calculator state
              'ichVolumeCalc', 'andexanetCalc', 'crclCalc', 'enoxCalc'
            ];
            return allowedKeys.reduce((acc, key) => {
              if (note && Object.prototype.hasOwnProperty.call(note, key)) {
                acc[key] = note[key];
              }
              return acc;
            }, {});
          };

          const sanitizeStrokeCodeFormForStorage = (form) => {
            if (shouldPersistFreeText) return form;
            const allowedKeys = [
              'age', 'sex', 'lkw', 'lkw_date', 'nihss', 'aspects',
              'tnk', 'tnk_rec', 'evt_rec'
            ];
            return allowedKeys.reduce((acc, key) => {
              if (form && Object.prototype.hasOwnProperty.call(form, key)) {
                acc[key] = form[key];
              }
              return acc;
            }, {});
          };

          const generateAlias = () => {
            const adjectives = ['Swift', 'Calm', 'Brisk', 'Bright', 'Sable', 'Quiet', 'Sturdy', 'Clear'];
            const nouns = ['Falcon', 'Harbor', 'Quartz', 'Willow', 'Comet', 'Cedar', 'Nimbus', 'Aspen'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            const code = Math.floor(Math.random() * 90 + 10);
            return `${adj}-${noun}-${code}`;
          };

          const formatElapsed = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${String(secs).padStart(2, '0')}`;
          };

          const buildSparklinePath = (values, width = 120, height = 28) => {
            if (!values.length) return '';
            const max = Math.max(...values, 1);
            const step = width / Math.max(values.length - 1, 1);
            return values.map((value, index) => {
              const x = index * step;
              const y = height - (value / max) * height;
              return `${index === 0 ? 'M' : 'L'}${x},${y}`;
            }).join(' ');
          };

          const copyTimeoutRef = React.useRef(null);
          const copyToClipboard = (text, label) => {
            const onSuccess = () => {
              setCopiedText(label);
              if (copyTimeoutRef.current) clearTimeout(copyTimeoutRef.current);
              copyTimeoutRef.current = setTimeout(() => { setCopiedText(''); copyTimeoutRef.current = null; }, 2000);
              addToast(`${label} copied to clipboard`, 'success');
            };
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).then(onSuccess).catch(() => {
                // Fallback for clipboard permission denied
                copyFallback(text) ? onSuccess() : addToast('Clipboard unavailable — try again', 'error');
              });
            } else {
              // Fallback for insecure contexts (HTTP, some mobile browsers)
              copyFallback(text) ? onSuccess() : addToast('Clipboard unavailable — try again', 'error');
            }
          };
          const copyFallback = (text) => {
            try {
              const ta = document.createElement('textarea');
              ta.value = text;
              ta.style.cssText = 'position:fixed;left:-9999px;top:-9999px';
              document.body.appendChild(ta);
              ta.select();
              const ok = document.execCommand('copy');
              document.body.removeChild(ta);
              return ok;
            } catch (_) { return false; }
          };

          // Share document using Web Share API
          const shareDocument = async (title, url) => {
            const fullUrl = window.location.origin + window.location.pathname + url;
            if (navigator.share) {
              try {
                await navigator.share({
                  title: `Stroke Resource: ${title}`,
                  text: `Check out this stroke reference: ${title}`,
                  url: fullUrl
                });
              } catch (err) {
                if (err.name !== 'AbortError') {
                  // If share fails, fallback to copy
                  copyToClipboard(fullUrl, title);
                }
              }
            } else {
              // Fallback to copy if Web Share API not supported
              copyToClipboard(fullUrl, title);
            }
          };

          // Email document link
          const emailDocument = (title, url) => {
            const fullUrl = window.location.origin + window.location.pathname + url;
            const subject = encodeURIComponent(title);
            const body = encodeURIComponent(fullUrl);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
          };

          const exportToPDF = async () => {
            addToast('Generating PDF...', 'info');
            try {
              if (typeof html2pdf === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                document.head.appendChild(script);
                await new Promise((resolve, reject) => { script.onload = resolve; script.onerror = reject; });
              }
              const element = document.getElementById('root');
              const opt = {
                margin: 0.5,
                filename: `stroke-assessment-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
              };
              await html2pdf().set(opt).from(element).save();
              addToast('PDF exported successfully', 'success');
            } catch (err) {
              addToast('PDF export failed — try again', 'error');
            }
          };
          exportToPDFRef.current = exportToPDF;

          const handleShare = async () => {
            const shareData = {
              title: 'Stroke',
              text: 'Clinical decision support toolkit for stroke management',
              url: window.location.href
            };

            try {
              if (navigator.share) {
                await navigator.share(shareData);
              } else {
                copyToClipboard(window.location.href, 'Link');
              }
            } catch (err) {
              if (err.name !== 'AbortError') {
                copyToClipboard(window.location.href, 'Link');
              }
            }
          };


          // Generate follow-up brief for clinic handoff
          const generateFollowUpBrief = () => {
            const sp = telestrokeNote.secondaryPrevention || {};
            const cw = telestrokeNote.cardiacWorkup || {};
            const ew = telestrokeNote.etiologyWorkup || {};
            const pathway = getPathwayForDiagnosis(telestrokeNote.diagnosis);
            let brief = `FOLLOW-UP BRIEF — CLINIC HANDOFF\n`;
            brief += `${'='.repeat(40)}\n\n`;
            brief += `Patient: ${telestrokeNote.age || '***'} ${telestrokeNote.sex === 'M' ? 'M' : telestrokeNote.sex === 'F' ? 'F' : '***'}\n`;
            brief += `Diagnosis: ${telestrokeNote.diagnosis || '***'}\n`;
            brief += `NIHSS: ${telestrokeNote.nihss || nihssScore || 'N/A'}`;
            const fuGCS = calculateGCS(gcsItems);
            if (fuGCS > 0) brief += ` | GCS: ${fuGCS}`;
            brief += `\n`;
            if (telestrokeNote.weight) brief += `Weight: ${telestrokeNote.weight} kg${telestrokeNote.weightEstimated ? ' (estimated)' : ''}\n`;
            if (telestrokeNote.premorbidMRS != null && telestrokeNote.premorbidMRS !== '') brief += `Pre-mRS: ${telestrokeNote.premorbidMRS}\n`;
            if (telestrokeNote.toastClassification) {
              brief += `Etiology (TOAST): ${TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification}\n`;
            }
            if (telestrokeNote.allergies) brief += `Allergies: ${telestrokeNote.allergies}${telestrokeNote.contrastAllergy ? ' **CONTRAST ALLERGY**' : ''}\n`;
            else if (telestrokeNote.contrastAllergy) brief += `Allergies: **CONTRAST ALLERGY**\n`;
            if (telestrokeNote.medications) brief += `Medications: ${telestrokeNote.medications}\n`;
            {
              const fuLabs = [];
              if (telestrokeNote.plateletCount) fuLabs.push(`Plt ${telestrokeNote.plateletCount}K`);
              if (telestrokeNote.creatinine) fuLabs.push(`Cr ${telestrokeNote.creatinine}`);
              if (telestrokeNote.inr) fuLabs.push(`INR ${telestrokeNote.inr}`);
              if (telestrokeNote.pt) fuLabs.push(`PT ${telestrokeNote.pt}s`);
              if (telestrokeNote.ptt) fuLabs.push(`aPTT ${telestrokeNote.ptt}`);
              if (telestrokeNote.glucose) fuLabs.push(`Glucose ${telestrokeNote.glucose}`);
              if (fuLabs.length > 0) brief += `Labs: ${fuLabs.join(', ')}\n`;
            }
            brief += `\nACUTE COURSE:\n`;
            if (telestrokeNote.tnkRecommended) {
              const fuDose = telestrokeNote.weight ? calculateTNKDose(telestrokeNote.weight) : null;
              brief += `- TNK${fuDose ? ` ${fuDose.calculatedDose} mg` : ''} administered${telestrokeNote.tnkAdminTime ? ` at ${telestrokeNote.tnkAdminTime}` : ''}\n`;
            }
            if (telestrokeNote.evtRecommended) brief += `- EVT recommended/performed${telestrokeNote.ticiScore ? ` (mTICI ${telestrokeNote.ticiScore})` : ''}\n`;
            if (telestrokeNote.transferAccepted) brief += `- Transferred to ${telestrokeNote.transferReceivingFacility || 'comprehensive stroke center'}\n`;
            if (!telestrokeNote.tnkRecommended && !telestrokeNote.evtRecommended) brief += `- Medical management\n`;
            if (telestrokeNote.affectedSide) brief += `- Affected side: ${telestrokeNote.affectedSide}\n`;
            brief += `\nIMAGING:\n`;
            brief += `- CT Head: ${telestrokeNote.ctResults || 'N/A'}\n`;
            brief += `- CTA: ${telestrokeNote.ctaResults || 'N/A'}\n`;
            {
              const ctpS = telestrokeNote.ctpStructured || {};
              const ctpParts = [];
              if (ctpS.coreVolume) ctpParts.push(`Core: ${ctpS.coreVolume} mL`);
              if (ctpS.penumbraVolume) ctpParts.push(`Penumbra: ${ctpS.penumbraVolume} mL`);
              if (ctpS.coreVolume && ctpS.penumbraVolume) {
                const c = parseFloat(ctpS.coreVolume), p = parseFloat(ctpS.penumbraVolume);
                if (!isNaN(c) && !isNaN(p)) {
                  if (c > 0) {
                    const ratio = p / c;
                    ctpParts.push(`Mismatch ratio: ${isFinite(ratio) && ratio < 1000 ? ratio.toFixed(1) : '>999'}`);
                  } else if (p > 0) ctpParts.push(`Mismatch ratio: Favorable (core=0)`);
                }
              }
              if (telestrokeNote.ctpResults) ctpParts.push(telestrokeNote.ctpResults);
              if (ctpParts.length > 0) brief += `- CTP: ${ctpParts.join('; ')}\n`;
            }
            if (telestrokeNote.collateralGrade) brief += `- Collaterals: ${telestrokeNote.collateralGrade}\n`;
            const briefVessels = (telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None');
            if (briefVessels.length > 0) brief += `- Vessel occlusion: ${briefVessels.join(', ')}\n`;
            if (telestrokeNote.ekgResults) brief += `- EKG: ${telestrokeNote.ekgResults}\n`;
            // Wake-up stroke evaluation
            {
              const fuWus = telestrokeNote.wakeUpStrokeWorkflow || {};
              if (fuWus.isWakeUpStroke) {
                brief += `\nWAKE-UP STROKE:\n`;
                const fuDwi = fuWus.dwi || {};
                const fuFlair = fuWus.flair || {};
                if (fuWus.mriAvailable) {
                  brief += `- MRI guided: DWI ${fuDwi.positiveForLesion ? '+' : '-'} / FLAIR ${fuFlair.noMarkedHyperintensity ? 'no hyperintensity' : 'hyperintense'}\n`;
                  if (fuDwi.positiveForLesion && fuFlair.noMarkedHyperintensity && fuWus.ageEligible && fuWus.nihssEligible) brief += `- Met WAKE-UP criteria\n`;
                } else if (fuWus.mriAvailable === false) {
                  const fuExt = fuWus.extendCriteria || {};
                  const fuExtCount = [fuExt.nihss4to26, fuExt.premorbidMRSLt2, fuExt.ischemicCoreLte70, fuExt.mismatchRatioGte1_2, fuExt.timeWindow4_5to9h].filter(Boolean).length;
                  brief += `- CTP guided: EXTEND ${fuExtCount}/5 criteria met${fuExtCount === 5 ? ' — ELIGIBLE' : ''}\n`;
                }
              }
            }
            brief += `\nCARDIAC WORKUP:\n`;
            if (cw.ecgComplete) brief += `- ECG: completed\n`;
            if (cw.telemetryOrdered) brief += `- Telemetry: ordered\n`;
            if (cw.echoOrdered) brief += `- Echo: ordered\n`;
            if (cw.extendedMonitoringType) {
              const monitorLabels = { '30-day-monitor': '30-day ambulatory monitor', '14-day-patch': '14-day continuous patch', 'ilr': 'ILR', 'none-af-known': 'Not needed (AF known)', 'none-other': 'Not indicated' };
              brief += `- Extended monitoring: ${monitorLabels[cw.extendedMonitoringType] || cw.extendedMonitoringType}\n`;
            }
            if (cw.pfoEvaluation && cw.pfoEvaluation !== 'no-pfo') brief += `- PFO: ${cw.pfoEvaluation.replace(/-/g, ' ')}\n`;
            // Pending workup items
            if (ew.completedTests && Object.keys(ew.completedTests).length > 0) {
              const pending = Object.entries(ew.completedTests).filter(([k, v]) => !v).map(([k]) => k);
              if (pending.length > 0) {
                brief += `\nPENDING WORKUP:\n`;
                pending.forEach(k => brief += `- ${k.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase()).trim()}\n`);
              }
            }
            brief += `\nSECONDARY PREVENTION:\n`;
            if (sp.antiplateletRegimen) {
              let apLine = `- Antithrombotic: ${AP_LABELS[sp.antiplateletRegimen] || sp.antiplateletRegimen}`;
              if (sp.daptDuration) apLine += ` (${sp.daptDuration})`;
              if (sp.cyp2c19Tested && sp.cyp2c19Result) {
                const cypLabels = { 'normal-metabolizer': 'Normal', 'intermediate': 'Intermediate (consider ticagrelor)', 'poor-metabolizer': 'Poor/LOF (avoid clopidogrel)', 'rapid-metabolizer': 'Rapid', 'pending': 'Pending' };
                apLine += ` — CYP2C19: ${cypLabels[sp.cyp2c19Result] || sp.cyp2c19Result}`;
              }
              brief += apLine + '\n';
            }
            if (sp.statinDose) brief += `- Statin: ${sp.statinDose.replace(/-/g, ' ')}${sp.ezetimibeAdded ? ' + ezetimibe' : ''}${sp.pcsk9Added ? ' + PCSK9i' : ''}\n`;
            if (sp.bpTarget) brief += `- BP target: ${sp.bpTarget}${sp.bpMeds ? ` (on ${sp.bpMeds})` : ''}\n`;
            if (sp.diabetesManagement && sp.diabetesManagement !== 'no-diabetes') brief += `- Diabetes: ${sp.diabetesManagement.replace(/-/g, ' ')}\n`;
            if (sp.smokingStatus && sp.smokingStatus !== 'never') {
              let smokeLine = `- Smoking: ${sp.smokingStatus.replace(/-/g, ' ')}`;
              if (sp.smokingCessationRx) smokeLine += ` — ${sp.smokingCessationRx}`;
              brief += smokeLine + '\n';
            }
            if (sp.glp1ra && sp.glp1ra !== 'not-indicated') brief += `- GLP-1 RA: ${sp.glp1ra.replace(/-/g, ' ')}\n`;
            if (sp.sglt2i && sp.sglt2i !== 'not-indicated') brief += `- SGLT2i: ${sp.sglt2i.replace(/-/g, ' ')}\n`;
            const doac = telestrokeNote.doacTiming || {};
            if (doac.strokeSeverity || doac.doacAgent) {
              brief += `\nDOAC TIMING:\n`;
              if (doac.strokeSeverity) brief += `- Severity: ${doac.strokeSeverity} → ${doac.strokeSeverity === 'minor' ? 'start within 48h' : doac.strokeSeverity === 'moderate' ? 'start Day 3-5' : 'start Day 6-14'}\n`;
              if (doac.doacAgent) brief += `- Agent: ${doac.doacAgent.replace(/-/g, ' ')}\n`;
              if (doac.doacInitiationDay) brief += `- Planned initiation: ${doac.doacInitiationDay}\n`;
              if (doac.hemorrhagicTransformation) brief += `- HT present: repeat imaging before DOAC initiation\n`;
            }
            // Angioedema management detail
            if (telestrokeNote.angioedemaDetected || telestrokeNote.angioedema?.detected) {
              const ae = telestrokeNote.angioedema || {};
              brief += `\nANGIOEDEMA:\n`;
              let aeStr = `- Status: detected`;
              if (ae.severity) aeStr += ` (${ae.severity})`;
              if (ae.aceInhibitorUse) aeStr += ' — ACEi use';
              if (ae.intubated) aeStr += ' — INTUBATED';
              else if (ae.resolved) aeStr += ' — resolved';
              brief += aeStr + '\n';
            }
            // Non-TNK hemorrhagic transformation
            {
              const ht = telestrokeNote.hemorrhagicTransformation || {};
              if (ht.detected) {
                brief += `\nHEMORRHAGIC TRANSFORMATION:\n`;
                brief += `- Classification: ${ht.classification || 'unclassified'}${ht.symptomatic ? ' (SYMPTOMATIC)' : ''}\n`;
                if (ht.managementActions) brief += `- Management: ${ht.managementActions}\n`;
                if (ht.antithromboticHeld) brief += `- Antithrombotics held\n`;
                if (ht.reimagingPlanned) brief += `- Repeat imaging planned\n`;
              }
            }
            // Drug interaction alerts
            {
              const di = telestrokeNote.drugInteractions || {};
              const diItems = [];
              if (di.aedDoacInteraction) diItems.push(`AED-DOAC: ${di.aedType || 'enzyme-inducing AED'} (consider warfarin instead)`);
              if (di.statinInteraction) diItems.push(`Statin: ${di.statinInteractionDrug || 'interacting drug'} (dose adjustment needed)`);
              if (diItems.length > 0) {
                brief += `\nDRUG INTERACTIONS:\n`;
                diItems.forEach(i => brief += `- ${i}\n`);
              }
            }
            // Decompressive craniectomy consideration
            {
              const dcr = telestrokeNote.decompressiveCraniectomy || {};
              if (dcr.considered) {
                brief += `\nDECOMPRESSIVE CRANIECTOMY:\n`;
                brief += `- Being considered for malignant MCA infarction\n`;
                if (dcr.territorySize) brief += `- Territory: ${dcr.territorySize}\n`;
                if (dcr.timing) brief += `- Timing window: ${dcr.timing}\n`;
              }
            }
            // VTE prophylaxis
            {
              const vte = telestrokeNote.vteProphylaxis || {};
              if (vte.ipc || vte.pharmacologic) {
                brief += `\nVTE PROPHYLAXIS:\n`;
                if (vte.ipc) brief += `- IPC/SCDs in place\n`;
                if (vte.pharmacologic) brief += `- Pharmacologic: ${vte.pharmacologicAgent || 'ordered'}\n`;
              }
            }
            // Rehab referrals
            {
              const rr = telestrokeNote.rehabReferral || {};
              const rrItems = [];
              if (rr.pt) rrItems.push('PT');
              if (rr.ot) rrItems.push('OT');
              if (rr.slp) rrItems.push('SLP');
              if (rr.neuropsych) rrItems.push('Neuropsych');
              if (rr.socialWork) rrItems.push('Social work');
              if (rr.vocational) rrItems.push('Vocational rehab');
              if (rrItems.length > 0) brief += `\nREHAB REFERRALS: ${rrItems.join(', ')}\n`;
            }
            // Screening tools
            {
              const st = telestrokeNote.screeningTools || {};
              if (st.phq2Score || st.mocaScore || st.stopBangScore || st.seizureRisk) {
                brief += `\nSCREENING:\n`;
                if (st.phq2Score) brief += `- PHQ-2: ${st.phq2Score}/6 (${st.phq2Positive ? 'POSITIVE — consider full PHQ-9' : 'negative'})\n`;
                if (st.mocaScore) brief += `- MoCA: ${st.mocaScore}/30${st.mocaReferral ? ' — neuropsych referral' : ''}\n`;
                if (st.stopBangScore) brief += `- STOP-BANG: ${st.stopBangScore}/8 (${parseInt(st.stopBangScore, 10) >= 5 ? 'HIGH' : parseInt(st.stopBangScore, 10) >= 3 ? 'INTERMEDIATE' : 'low'} OSA risk)\n`;
                if (st.seizureRisk) brief += `- Seizure: ${st.seizureRisk.replace(/-/g, ' ')}\n`;
              }
            }
            // Fever management
            {
              const fever = telestrokeNote.feverManagement || {};
              if (fever.feverDetected || fever.feverProtocolInitiated) {
                brief += `\nFEVER MANAGEMENT:\n`;
                if (fever.maxTemp) brief += `- Max temp: ${fever.maxTemp}°C\n`;
                if (fever.feverProtocolInitiated) brief += `- FeSS bundle initiated\n`;
                if (fever.infectionWorkupSent) brief += `- Infection workup sent\n`;
                if (fever.escalationLevel) brief += `- Escalation: ${fever.escalationLevel.replace(/-/g, ' ')}\n`;
              }
            }
            // Osmotic therapy
            {
              const osm = telestrokeNote.osmoticTherapy || {};
              if (osm.agentUsed) {
                brief += `\nOSMOTIC THERAPY:\n`;
                brief += `- Agent: ${osm.agentUsed}${osm.indication ? ` for ${osm.indication.replace(/-/g, ' ')}` : ''}\n`;
                if (osm.sodiumTarget) brief += `- Na+ target: ${osm.sodiumTarget} mEq/L\n`;
                if (osm.serumOsmolality) brief += `- Serum osm: ${osm.serumOsmolality} mOsm/kg${parseFloat(osm.serumOsmolality) > 320 ? ' (>320 — hold mannitol)' : ''}\n`;
              }
            }
            // Nutritional support
            {
              const nutr = telestrokeNote.nutritionalSupport || {};
              if (nutr.feedingRoute) {
                brief += `\nNUTRITION: ${nutr.feedingRoute}`;
                if (nutr.pegConsiderationDay) brief += ` | PEG consideration day ${nutr.pegConsiderationDay}`;
                brief += '\n';
              }
            }
            // Palliative care / GOC
            {
              const pall = telestrokeNote.palliativeCare || {};
              if (pall.goalsOfCareDiscussed || pall.consultOrdered) {
                brief += `\nGOALS OF CARE:\n`;
                if (pall.goalsOfCareDiscussed) brief += `- GOC discussed${pall.goalsOfCareOutcome ? `: ${pall.goalsOfCareOutcome.replace(/-/g, ' ')}` : ''}\n`;
                if (pall.consultOrdered) brief += `- Palliative care consult ordered\n`;
              }
            }
            // Pathway-specific
            if (telestrokeNote.diagnosisCategory === 'cvt') {
              const fuCvtAc = telestrokeNote.cvtAnticoag || {};
              if (fuCvtAc.acutePhase || fuCvtAc.transitionAgent || fuCvtAc.duration) {
                brief += `\nCVT ANTICOAGULATION:\n`;
                if (fuCvtAc.acutePhase) brief += `- Acute: ${fuCvtAc.acutePhase.replace(/-/g, ' ')}\n`;
                if (fuCvtAc.transitionAgent) brief += `- Transition: ${fuCvtAc.transitionAgent}\n`;
                if (fuCvtAc.duration) brief += `- Duration: ${fuCvtAc.duration}\n`;
                if (fuCvtAc.apsStatus) brief += `- APS confirmed — warfarin mandatory\n`;
              }
            }
            {
              const fuCarotid = telestrokeNote.carotidManagement || {};
              if (fuCarotid.stenosisDegree) {
                brief += `\nCAROTID: ${fuCarotid.stenosisSide || ''} ${fuCarotid.stenosisDegree}% stenosis${fuCarotid.symptomatic ? ' (symptomatic)' : ''}`;
                if (fuCarotid.intervention) brief += ` → ${fuCarotid.intervention.replace(/-/g, ' ')}`;
                brief += '\n';
              }
            }
            {
              const fuEsus = telestrokeNote.esusWorkup || {};
              if (fuEsus.cardiacMonitoringType || fuEsus.afDetected || fuEsus.hypercoagWorkup) {
                brief += `\nESUS/CRYPTOGENIC:\n`;
                if (fuEsus.cardiacMonitoringType) brief += `- Monitoring: ${fuEsus.cardiacMonitoringType.replace(/-/g, ' ')}\n`;
                if (fuEsus.afDetected) brief += `- AF DETECTED\n`;
                if (fuEsus.hypercoagWorkup) brief += `- Hypercoag workup ordered\n`;
              }
            }
            {
              const fuDiss = telestrokeNote.dissectionPathway || {};
              if (fuDiss.antithromboticType || fuDiss.imagingFollowUp) {
                brief += `\nDISSECTION:\n`;
                if (fuDiss.antithromboticType) brief += `- Antithrombotic: ${fuDiss.antithromboticType.replace(/-/g, ' ')}\n`;
                if (fuDiss.imagingFollowUp) brief += `- Vascular imaging f/u: ${fuDiss.imagingFollowUp}\n`;
              }
            }
            {
              const fuIchAc = telestrokeNote.ichAnticoagResumption || {};
              if (fuIchAc.decision) {
                brief += `\nICH ANTICOAG RESUMPTION:\n`;
                brief += `- Decision: ${fuIchAc.decision.replace(/-/g, ' ')}\n`;
                if (fuIchAc.chadsVascScore) brief += `- CHA2DS2-VASc: ${fuIchAc.chadsVascScore}\n`;
                if (fuIchAc.laaoConsidered) brief += `- LAAO evaluation considered\n`;
              }
            }
            // mRS tracking
            {
              const mrs = telestrokeNote.mrsAssessment || {};
              const mrsEntries = Object.entries(mrs).filter(([k, v]) => v);
              if (mrsEntries.length > 0) {
                brief += `\nmRS TRACKING: ${mrsEntries.map(([k, v]) => `${k}: ${v}`).join(', ')}\n`;
              }
            }
            // Driving restrictions
            {
              const drv = telestrokeNote.drivingRestrictions || {};
              if (drv.counselingProvided) {
                brief += `\nDRIVING: restricted${drv.restrictionDuration ? ` x ${drv.restrictionDuration}` : ''}${drv.commercialDriver ? ' (COMMERCIAL — DMV notification)' : ''}\n`;
              }
            }
            // Falls risk
            {
              const falls = telestrokeNote.fallsRisk || {};
              if (falls.screenPerformed) {
                brief += `FALLS: ${falls.highRisk ? 'HIGH RISK' : 'standard'}${falls.preventionPlanInitiated ? ' — prevention plan' : ''}${falls.balanceProgramReferral ? ', balance program' : ''}\n`;
              }
            }
            // Anticoag bridging
            {
              const bridge = telestrokeNote.anticoagBridging || {};
              if (bridge.doacType) {
                brief += `\nPERIPROCEDURAL ANTICOAG: ${bridge.doacType}${bridge.crCl ? `, CrCl ${bridge.crCl}` : ''}${bridge.procedureRisk ? `, ${bridge.procedureRisk} bleed risk` : ''}\n`;
              }
            }
            brief += `\nFOLLOW-UP PLAN:\n`;
            const dc = telestrokeNote.dischargeChecklist || {};
            if (dc.followUpNeurology) brief += `- Neurology follow-up${dc.followUpNeurologyTimeframe ? ` (${dc.followUpNeurologyTimeframe})` : ''}\n`;
            if (dc.followUpPCP) brief += `- PCP follow-up${dc.followUpPCPTimeframe ? ` (${dc.followUpPCPTimeframe})` : ''}\n`;
            if (dc.followUpCardiology) brief += `- Cardiology follow-up\n`;
            if (sp.followUpTimeline) brief += `- Timeline: ${sp.followUpTimeline}\n`;
            if (telestrokeNote.recommendationsText) brief += `\nADDITIONAL RECOMMENDATIONS:\n${telestrokeNote.recommendationsText}\n`;
            return brief;
          };

          // Generate Pulsara summary (shared, deduplicated)
          const generatePulsaraSummary = () => {
            const age = telestrokeNote.age || "***";
            const sex = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '***';
            const pmh = telestrokeNote.pmh || "no PMH";
            const symptoms = telestrokeNote.symptoms || "***";
            const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : "[time]";
            const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : "[date]";
            const nihss = telestrokeNote.nihss || nihssScore || "[score]";
            const nihssDeficits = telestrokeNote.nihssDetails ? ` (${telestrokeNote.nihssDetails})` : "";
            const ctResults = telestrokeNote.ctResults || "[CT findings]";
            const ctaResults = telestrokeNote.ctaResults || "[CTA findings]";
            const ctpResults = telestrokeNote.ctpResults || "N/A";
            const aspectsStr = (aspectsScore != null && aspectsScore < 10) ? ` ASPECTS: ${aspectsScore}.` : "";
            const vesselArr = telestrokeNote.vesselOcclusion || [];
            const vesselStr = vesselArr.length > 0 && !vesselArr.includes('None')
              ? ` Vessel occlusion: ${vesselArr.join(', ')}.` : "";
            const tnkStatus = telestrokeNote.diagnosisCategory !== 'ischemic' ? `N/A (${telestrokeNote.diagnosisCategory === 'sah' ? 'SAH' : 'ICH'})` : telestrokeNote.tnkRecommended ? "Recommended" : "Not Recommended";
            const evtStatus = telestrokeNote.diagnosisCategory !== 'ischemic' ? `N/A (${telestrokeNote.diagnosisCategory === 'sah' ? 'SAH' : 'ICH'})` : telestrokeNote.evtRecommended ? "Recommended" : "Not Recommended";
            const rationale = telestrokeNote.rationale || "[rationale]";
            const site = telestrokeNote.callingSite ? `[${telestrokeNote.callingSite}] ` : '';
            // LKW unknown handling
            const lkwStr = telestrokeNote.lkwUnknown
              ? `Last known well: UNKNOWN (wake-up stroke). Discovery: ${telestrokeNote.discoveryTime || '[time]'} ${telestrokeNote.discoveryDate || '[date]'}`
              : `Last known well is ${lkw} ${lkwDate}`;
            // Early infarct signs
            let ctExtra = '';
            if (telestrokeNote.earlyInfarctSigns) ctExtra += ' Early infarct signs.';
            if (telestrokeNote.denseArterySign) ctExtra += ' Hyperdense artery sign.';
            // Complications
            let compStr = '';
            if (telestrokeNote.angioedemaDetected || telestrokeNote.angioedema?.detected) compStr += ' ANGIOEDEMA.';
            if ((telestrokeNote.hemorrhagicTransformation || {}).detected) compStr += ' HT.';
            if (telestrokeNote.sichDetected) compStr += ' sICH.';
            if ((telestrokeNote.decompressiveCraniectomy || {}).considered) compStr += ' Craniectomy considered.';
            // ICH volume
            let ichVolStr = '';
            if (telestrokeNote.diagnosisCategory === 'ich') {
              const pIchCalc = telestrokeNote.ichVolumeCalc || {};
              const pIchVol = calculateICHVolume(pIchCalc);
              if (pIchVol && pIchVol.volume) ichVolStr = ` ICH vol: ${pIchVol.volume} mL${pIchVol.isLarge ? ' (LARGE)' : ''}.`;
            }
            // Wake-up stroke
            let wusStr = '';
            const pWus = telestrokeNote.wakeUpStrokeWorkflow || {};
            if (pWus.isWakeUpStroke) {
              if (pWus.mriAvailable) {
                const pDwi = pWus.dwi || {};
                const pFlair = pWus.flair || {};
                const wakeUpMet = pDwi.positiveForLesion && pFlair.noMarkedHyperintensity && pWus.ageEligible && pWus.nihssEligible;
                wusStr = wakeUpMet ? ' WAKE-UP eligible.' : ' Wake-up eval in progress.';
              } else if (pWus.mriAvailable === false) {
                const pExt = pWus.extendCriteria || {};
                const extCount = [pExt.nihss4to26, pExt.premorbidMRSLt2, pExt.ischemicCoreLte70, pExt.mismatchRatioGte1_2, pExt.timeWindow4_5to9h].filter(Boolean).length;
                wusStr = extCount === 5 ? ' EXTEND eligible.' : ` EXTEND ${extCount}/5.`;
              }
            }
            // Weight, GCS, premorbid mRS
            const wtStr = telestrokeNote.weight ? ` Wt: ${telestrokeNote.weight}kg${telestrokeNote.weightEstimated ? '(est)' : ''}.` : '';
            const gcsVal = typeof calculateGCS === 'function' ? calculateGCS(gcsItems) : null;
            const gcsStr = gcsVal ? ` GCS: ${gcsVal}.` : '';
            const mrsStr = telestrokeNote.premorbidMRS ? ` Pre-mRS: ${telestrokeNote.premorbidMRS}.` : '';
            // Collateral grade
            const collatStr = telestrokeNote.collateralGrade ? ` Collaterals: ${telestrokeNote.collateralGrade}.` : '';
            // Structured CTP
            const pCtpS = telestrokeNote.ctpStructured || {};
            let ctpExtra = '';
            if (pCtpS.coreVolume || pCtpS.penumbraVolume) {
              const parts = [];
              if (pCtpS.coreVolume) parts.push(`Core: ${pCtpS.coreVolume}mL`);
              if (pCtpS.penumbraVolume) parts.push(`Penumbra: ${pCtpS.penumbraVolume}mL`);
              const c = parseFloat(pCtpS.coreVolume), p = parseFloat(pCtpS.penumbraVolume);
              if (!isNaN(c) && !isNaN(p) && c > 0) { const r = p/c; parts.push(`Ratio: ${isFinite(r) && r < 1000 ? r.toFixed(1) : '>999'}`); }
              ctpExtra = ` (${parts.join(', ')})`;
            }
            const territoryStr = telestrokeNote.strokeTerritory ? ` Territory: ${telestrokeNote.strokeTerritory}.` : '';
            const trajectoryStr = telestrokeNote.symptomTrajectory ? ` Trajectory: ${telestrokeNote.symptomTrajectory}.` : '';
            return `${site}${age} year old ${sex}${wtStr} with ${pmh} who presents with ${symptoms}. ${lkwStr}.${gcsStr}${mrsStr} NIHSS score: ${nihss}${nihssDeficits}. Head CT: ${ctResults}.${ctExtra}${aspectsStr}${ichVolStr}${vesselStr} CTA Head/Neck: ${ctaResults}. CTP: ${ctpResults}${ctpExtra}.${collatStr}${wusStr}${territoryStr}${trajectoryStr} TNK Treatment: ${tnkStatus}. EVT: ${evtStatus}.${compStr} Rationale: ${rationale}.`;
          };
          const generatePulsaraPreview = () => {
            const age = telestrokeNote.age || "***";
            const nihss = telestrokeNote.nihss || nihssScore || "[score]";
            const dx = telestrokeNote.diagnosis || '[Diagnosis]';
            const site = telestrokeNote.callingSite || '';
            return `${site ? `[${site}] ` : ''}${age}${telestrokeNote.sex || ''} NIHSS ${nihss} — ${dx}`;
          };

          // Generate telestroke documentation note
          const generateTelestrokeNote = () => {
            try {
            // Convert Date to local ISO string for datetime-local inputs (avoids UTC offset bug)
            const toLocalISO = (d) => {
              const yr = d.getFullYear();
              const mo = String(d.getMonth() + 1).padStart(2, '0');
              const dy = String(d.getDate()).padStart(2, '0');
              const hr = String(d.getHours()).padStart(2, '0');
              const mn = String(d.getMinutes()).padStart(2, '0');
              return `${yr}-${mo}-${dy}T${hr}:${mn}`;
            };

            const formatDate = (dateStr) => {
              if (!dateStr) return '';
              const date = new Date(dateStr);
              if (Number.isNaN(date.getTime())) return String(dateStr);
              return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear().toString().slice(-2)}`;
            };

            const formatTime = (timeStr) => {
              if (!timeStr) return '';
              const parts = timeStr.split(':');
              if (parts.length < 2) return String(timeStr);
              const hour = parseInt(parts[0], 10);
              const minutes = parts[1];
              if (isNaN(hour)) return String(timeStr);
              const ampm = hour >= 12 ? 'pm' : 'am';
              const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
              return `${displayHour}:${minutes} ${ampm}`;
            };

            // Template-specific note generation
            if (noteTemplate === 'transfer') {
              const transferConsultLabel = consultationType === 'telephone' ? 'Telephone Consult' : 'Video Telestroke';
              let note = `TRANSFER SUMMARY (${transferConsultLabel})\n${'='.repeat(40)}\n\n`;
              if (telestrokeNote.callingSite) note += `From: ${telestrokeNote.callingSite}\n`;
              if (telestrokeNote.callerName) note += `Caller: ${telestrokeNote.callerName}${telestrokeNote.callerRole ? ` (${telestrokeNote.callerRole})` : ''}\n`;
              note += `Patient: ${telestrokeNote.age || '___'} y/o ${telestrokeNote.sex || '___'}`;
              if (telestrokeNote.weight) note += ` | Wt: ${telestrokeNote.weight} kg${telestrokeNote.weightEstimated ? ' (estimated)' : ''}`;
              if (telestrokeNote.height) note += ` | Ht: ${telestrokeNote.height} cm`;
              note += `\n`;
              note += `Diagnosis: ${telestrokeNote.diagnosis || '___'}`;
              if (telestrokeNote.toastClassification) note += ` (${TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification})`;
              note += `\n`;
              if (telestrokeNote.lkwUnknown) {
                note += `LKW: UNKNOWN (wake-up stroke / unwitnessed)\n`;
                if (telestrokeNote.discoveryDate || telestrokeNote.discoveryTime) {
                  const disc = [formatDate(telestrokeNote.discoveryDate), formatTime(telestrokeNote.discoveryTime)].filter(Boolean).join(' ');
                  note += `Discovery time: ${disc} (used for window calculation)\n`;
                }
              } else {
                note += `LKW: ${[formatDate(telestrokeNote.lkwDate), formatTime(telestrokeNote.lkwTime)].filter(Boolean).join(' ') || '___'}\n`;
              }
              note += `NIHSS: ${telestrokeNote.nihss || nihssScore || 'N/A'}`;
              const transferGCS = calculateGCS(gcsItems);
              if (transferGCS > 0) note += ` | GCS: ${transferGCS}`;
              if (telestrokeNote.premorbidMRS) note += ` | Pre-mRS: ${telestrokeNote.premorbidMRS}`;
              note += `\n`;
              if (telestrokeNote.affectedSide) note += `Affected side: ${telestrokeNote.affectedSide}\n`;
              if (telestrokeNote.codeStatus) note += `Code status: ${telestrokeNote.codeStatus}\n`;
              if (telestrokeNote.admitLocation) note += `Disposition: ${telestrokeNote.admitLocation}\n`;
              note += `\n`;
              note += `HPI: ${telestrokeNote.symptoms || '___'}\n`;
              note += `PMH: ${telestrokeNote.pmh || '___'}\n`;
              note += `Medications: ${telestrokeNote.medications || '___'}\n`;
              if (telestrokeNote.allergies) note += `Allergies: ${telestrokeNote.allergies}\n`;
              if (telestrokeNote.contrastAllergy) note += `** CONTRAST ALLERGY **\n`;
              note += `\n`;
              const vitals = [`BP ${telestrokeNote.presentingBP || '___'}`];
              if (telestrokeNote.heartRate) vitals.push(`HR ${telestrokeNote.heartRate}`);
              if (telestrokeNote.spO2) vitals.push(`SpO2 ${telestrokeNote.spO2}%`);
              if (telestrokeNote.temperature) vitals.push(`Temp ${telestrokeNote.temperature}°F`);
              note += `Vitals: ${vitals.join(', ')}, Glucose ${telestrokeNote.glucose || '___'}\n`;
              note += `Labs: Plt ${telestrokeNote.plateletCount ? telestrokeNote.plateletCount + 'K' : '___'}, Cr ${telestrokeNote.creatinine || '___'}`;
              if (telestrokeNote.inr) note += `, INR ${telestrokeNote.inr}`;
              if (telestrokeNote.pt) note += `, PT ${telestrokeNote.pt}s`;
              if (telestrokeNote.ptt) note += `, aPTT ${telestrokeNote.ptt}`;
              note += `\n`;
              if (telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]) {
                const txAcInfo = ANTICOAGULANT_INFO[telestrokeNote.lastDOACType];
                note += `Anticoagulation: ${txAcInfo.name}`;
                if (telestrokeNote.lastDOACDose) {
                  const txDoseDate = new Date(telestrokeNote.lastDOACDose);
                  if (!Number.isNaN(txDoseDate.getTime())) note += ` (last dose: ${txDoseDate.toLocaleString()})`;
                }
                note += `\n`;
              }
              if (telestrokeNote.strokeTerritory) note += `Territory: ${telestrokeNote.strokeTerritory}${telestrokeNote.strokePhenotype ? ` (${telestrokeNote.strokePhenotype})` : ''}\n`;
              if (telestrokeNote.symptomTrajectory) note += `Trajectory: ${telestrokeNote.symptomTrajectory}\n`;
              note += `\n`;
              note += `Imaging:\n`;
              note += `- CT Head: ${telestrokeNote.ctResults || '___'}`;
              if (aspectsScore != null && aspectsScore < 10) note += ` (ASPECTS ${aspectsScore}/10)`;
              const pcAspectsArr = calculatePCAspects(pcAspectsRegions);
              const pcAspectsObj = (() => { const r = telestrokeNote.pcAspectsRegions || {}; return 10 - ((r.pons ? 2 : 0) + (r.midbrain ? 2 : 0) + (r.cerebL ? 1 : 0) + (r.cerebR ? 1 : 0) + (r.pcaL ? 1 : 0) + (r.pcaR ? 1 : 0) + (r.thalL ? 1 : 0) + (r.thalR ? 1 : 0)); })();
              const pcAspectsVal = pcAspectsArr < 10 ? pcAspectsArr : pcAspectsObj;
              if (pcAspectsVal >= 0 && pcAspectsVal < 10) note += ` (PC-ASPECTS ${pcAspectsVal}/10)`;
              if (telestrokeNote.earlyInfarctSigns) note += ` — early infarct signs present`;
              if (telestrokeNote.denseArterySign) note += ` — hyperdense artery sign`;
              note += `\n`;
              note += `- CTA: ${telestrokeNote.ctaResults || '___'}`;
              const transferVessels = (telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None');
              if (transferVessels.length > 0) note += ` — Occlusion: ${transferVessels.join(', ')}`;
              note += `\n`;
              {
                const ctpS = telestrokeNote.ctpStructured || {};
                const ctpParts = [];
                if (ctpS.coreVolume) ctpParts.push(`Core: ${ctpS.coreVolume} mL`);
                if (ctpS.penumbraVolume) ctpParts.push(`Penumbra (Tmax>6s): ${ctpS.penumbraVolume} mL`);
                if (ctpS.coreVolume && ctpS.penumbraVolume) {
                  const c = parseFloat(ctpS.coreVolume), p = parseFloat(ctpS.penumbraVolume);
                  if (!isNaN(c) && !isNaN(p)) {
                    if (c > 0) { const r = p/c; ctpParts.push(`Mismatch ratio: ${isFinite(r) && r < 1000 ? r.toFixed(1) : '>999'}`); }
                    else if (p > 0) ctpParts.push(`Mismatch ratio: Favorable (core=0)`);
                  }
                }
                if (telestrokeNote.ctpResults) ctpParts.push(telestrokeNote.ctpResults);
                if (ctpParts.length > 0) note += `- CTP: ${ctpParts.join('; ')}\n`;
              }
              if (telestrokeNote.collateralGrade) note += `- Collaterals: ${telestrokeNote.collateralGrade}\n`;
              if (telestrokeNote.ekgResults) note += `- EKG: ${telestrokeNote.ekgResults}\n`;
              // Cardiac workup summary
              {
                const cw = telestrokeNote.cardiacWorkup || {};
                const cwItems = [];
                if (cw.ecgComplete) cwItems.push('ECG completed');
                if (cw.telemetryOrdered) cwItems.push('telemetry ordered');
                if (cw.echoOrdered) cwItems.push('echo ordered');
                if (cw.extendedMonitoringType) cwItems.push(`extended monitoring: ${cw.extendedMonitoringType}`);
                if (cw.pfoEvaluation) cwItems.push(`PFO: ${cw.pfoEvaluation.replace(/-/g, ' ')}`);
                if (cwItems.length > 0) note += `- Cardiac workup: ${cwItems.join(', ')}\n`;
              }
              // Wake-up stroke evaluation
              const transferWus = telestrokeNote.wakeUpStrokeWorkflow || {};
              if (transferWus.isWakeUpStroke) {
                note += `\nWAKE-UP / EXTENDED WINDOW ASSESSMENT:\n`;
                note += `- MRI available: ${transferWus.mriAvailable ? 'Yes' : transferWus.mriAvailable === false ? 'No (CTP pathway)' : 'Not assessed'}\n`;
                if (transferWus.mriAvailable) {
                  const twDwi = transferWus.dwi || {};
                  const twFlair = transferWus.flair || {};
                  if (twDwi.positiveForLesion) note += `- DWI: Positive lesion${twDwi.lesionVolume ? ` (volume: ${twDwi.lesionVolume} mL)` : ''}\n`;
                  if (twFlair.noMarkedHyperintensity) note += `- FLAIR: No marked hyperintensity (DWI-FLAIR mismatch — favorable)\n`;
                  if (transferWus.ageEligible) note += `- Age: Eligible (18-80)\n`;
                  if (transferWus.nihssEligible) note += `- NIHSS: ≤25\n`;
                  if (twDwi.positiveForLesion && twFlair.noMarkedHyperintensity && transferWus.ageEligible && transferWus.nihssEligible) {
                    note += `- *** MEETS WAKE-UP TRIAL CRITERIA — Consider IV thrombolysis ***\n`;
                  }
                }
                if (transferWus.mriAvailable === false) {
                  const ext = transferWus.extendCriteria || {};
                  const extMet = [];
                  if (ext.nihss4to26) extMet.push('NIHSS 4-26');
                  if (ext.premorbidMRSLt2) extMet.push('pre-mRS <2');
                  if (ext.ischemicCoreLte70) extMet.push('core ≤70cc');
                  if (ext.mismatchRatioGte1_2) extMet.push('mismatch ≥1.2');
                  if (ext.timeWindow4_5to9h) extMet.push('4.5-9h window');
                  if (extMet.length > 0) note += `- EXTEND criteria: ${extMet.join(', ')}\n`;
                  if (extMet.length === 5) note += `- *** MEETS EXTEND CRITERIA — Consider IV thrombolysis ***\n`;
                }
              }
              note += `\nTreatment:\n`;
              if (telestrokeNote.tnkRecommended) {
                const transferDose = telestrokeNote.weight ? calculateTNKDose(telestrokeNote.weight) : null;
                note += `- TNK${transferDose ? ` ${transferDose.calculatedDose} mg` : ''} ${telestrokeNote.tnkAdminTime ? 'administered at ' + (formatTime(telestrokeNote.tnkAdminTime) || '___') : 'recommended (not yet administered)'}\n`;
                if (telestrokeNote.tnkContraindicationReviewed) {
                  note += `- Contraindication review: completed${telestrokeNote.tnkContraindicationReviewTime ? ` at ${telestrokeNote.tnkContraindicationReviewTime}` : ''}\n`;
                }
                if (telestrokeNote.tnkConsentDiscussed) {
                  note += `- Consent: ${telestrokeNote.tnkConsentType || '(type not specified)'} consent`;
                  if (telestrokeNote.tnkConsentWith) note += ` with ${telestrokeNote.tnkConsentWith}`;
                  if (telestrokeNote.tnkConsentTime) note += ` at ${telestrokeNote.tnkConsentTime}`;
                  note += `\n`;
                }
                if (telestrokeNote.disablingDeficit) {
                  note += `- DISABLING DEFICIT: TNK recommended despite NIHSS ${telestrokeNote.nihss || nihssScore || '___'} based on significant functional impairment\n`;
                }
              }
              if (telestrokeNote.evtRecommended) {
                note += `- EVT recommended\n`;
                if ((telestrokeNote.consentKit || {}).evtConsentDiscussed) {
                  const evtConType = (telestrokeNote.consentKit || {}).evtConsentType;
                  note += `- EVT consent: ${evtConType || '(type not specified)'}`;
                  if ((telestrokeNote.consentKit || {}).evtConsentTime) note += ` at ${telestrokeNote.consentKit.evtConsentTime}`;
                  note += `\n`;
                }
              }
              if (!telestrokeNote.tnkRecommended && !telestrokeNote.evtRecommended) note += `- Medical management\n`;
              if (telestrokeNote.dtnTnkAdministered && telestrokeNote.tnkRecommended) note += formatDTNForNote();
              else if (telestrokeNote.doorTime || telestrokeNote.needleTime) {
                const dtnParts = [];
                if (telestrokeNote.doorTime) dtnParts.push(`Door: ${telestrokeNote.doorTime}`);
                if (telestrokeNote.needleTime) dtnParts.push(`Needle: ${telestrokeNote.needleTime}`);
                if (telestrokeNote.doorTime && telestrokeNote.needleTime) {
                  const [dH, dM] = telestrokeNote.doorTime.split(':').map(Number);
                  const [nH, nM] = telestrokeNote.needleTime.split(':').map(Number);
                  if (!isNaN(dH) && !isNaN(dM) && !isNaN(nH) && !isNaN(nM)) {
                    let dtnMin = (nH * 60 + nM) - (dH * 60 + dM);
                    if (dtnMin < 0) dtnMin += 1440;
                    dtnParts.push(`DTN: ${dtnMin} min`);
                  }
                }
                note += `- ${dtnParts.join(' | ')}\n`;
              }
              const transferBp = bpPhaseTargets[telestrokeNote.bpPhase];
              if (transferBp) note += `- BP target: <${transferBp.systolic}/${transferBp.diastolic} (${transferBp.label})\n`;
              // DOAC timing protocol
              {
                const doac = telestrokeNote.doacTiming || {};
                if (doac.strokeSeverity || doac.doacAgent) {
                  note += `- DOAC plan: `;
                  const doacParts = [];
                  if (doac.doacAgent) doacParts.push(doac.doacAgent.replace(/-/g, ' '));
                  if (doac.strokeSeverity) doacParts.push(`severity ${doac.strokeSeverity} → ${doac.strokeSeverity === 'minor' ? 'start within 48h' : doac.strokeSeverity === 'moderate' ? 'start Day 3-5' : 'start Day 6-14'}`);
                  if (doac.doacInitiationDay) doacParts.push(`planned Day ${doac.doacInitiationDay}`);
                  if (doac.hemorrhagicTransformation) doacParts.push('HT present — repeat imaging before initiation');
                  note += doacParts.join('; ') + '\n';
                }
              }
              if (telestrokeNote.rationale) note += `- Clinical rationale: ${telestrokeNote.rationale}\n`;
              if (telestrokeNote.transferRationale) note += `\nTransfer rationale: ${telestrokeNote.transferRationale}\n`;
              if (telestrokeNote.transportMode || telestrokeNote.transportEta) {
                note += `${telestrokeNote.transferRationale ? '' : '\n'}Transport: ${telestrokeNote.transportMode || '___'}`;
                if (telestrokeNote.transportEta) note += ` | ETA: ${telestrokeNote.transportEta}`;
                note += '\n';
              }
              if (telestrokeNote.transportNotes) note += `Transport notes: ${telestrokeNote.transportNotes}\n`;
              // Transfer checklist status
              const txChecks = [];
              if (telestrokeNote.transferImagingShared) txChecks.push('imaging shared');
              if (telestrokeNote.transferLabsSent) txChecks.push('labs sent');
              if (telestrokeNote.transferIVAccess) txChecks.push('IV access confirmed');
              if (telestrokeNote.transferBPStable) txChecks.push('BP stable');
              if (telestrokeNote.transferFamilyNotified) txChecks.push('family notified');
              if (txChecks.length > 0) note += `Transfer readiness: ${txChecks.join(', ')}\n`;
              // Post-TNK Status
              if (telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime) {
                note += `\nPost-TNK Status:\n`;
                const postTnkComps = [];
                if (telestrokeNote.sichDetected) postTnkComps.push('sICH DETECTED');
                if (telestrokeNote.angioedemaDetected || telestrokeNote.angioedema?.detected) {
                  const ae = telestrokeNote.angioedema || {};
                  let aeStr = 'ANGIOEDEMA';
                  if (ae.severity) aeStr += ` (${ae.severity})`;
                  if (ae.aceInhibitorUse) aeStr += ' — ACEi use';
                  if (ae.intubated) aeStr += ' — INTUBATED';
                  else if (ae.resolved) aeStr += ' — resolved';
                  postTnkComps.push(aeStr);
                }
                if (telestrokeNote.clinicalDeterioration) postTnkComps.push('CLINICAL DETERIORATION');
                const ht = telestrokeNote.hemorrhagicTransformation || {};
                if (ht.detected) postTnkComps.push(`hemorrhagic transformation${ht.classification ? ` (${ht.classification}${ht.symptomatic ? ', symptomatic' : ''})` : ''}`);
                if (postTnkComps.length > 0) {
                  note += `- COMPLICATIONS: ${postTnkComps.join(', ')}\n`;
                } else {
                  note += `- No post-TNK complications at time of transfer\n`;
                }
                if (telestrokeNote.complicationNotes) note += `- Complication details: ${telestrokeNote.complicationNotes}\n`;
                note += `- Neuro checks q15 min x 2h, then q30 min x 6h, then q1h x 16h post-TNK\n`;
                note += `- Hold antithrombotics x 24h post-TNK\n`;
              }
              // Hemorrhagic transformation (non-TNK patients)
              if (!(telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime)) {
                const htNonTnk = telestrokeNote.hemorrhagicTransformation || {};
                if (htNonTnk.detected) {
                  note += `\nHemorrhagic Transformation:\n`;
                  note += `- Classification: ${htNonTnk.classification || 'unclassified'}${htNonTnk.symptomatic ? ' (SYMPTOMATIC)' : ''}\n`;
                  if (htNonTnk.managementActions) note += `- Management: ${htNonTnk.managementActions}\n`;
                  if (htNonTnk.antithromboticHeld) note += `- Antithrombotics held\n`;
                  if (htNonTnk.reimagingPlanned) note += `- Repeat imaging planned\n`;
                }
              }

              // ICH-specific data
              if (telestrokeNote.diagnosisCategory === 'ich') {
                let ichTransfer = '\nICH Management:\n';
                {
                  const ichCalc = telestrokeNote.ichVolumeCalc || {};
                  const ichVol = calculateICHVolume(ichCalc);
                  if (ichVol && ichVol.volume) ichTransfer += `- ICH volume (ABC/2): ${ichVol.volume} mL${ichVol.isLarge ? ' (LARGE)' : ''}\n`;
                }
                if (telestrokeNote.ichBPManaged) ichTransfer += '- BP managed (target SBP <140 per INTERACT3/AHA 2022)\n';
                if (telestrokeNote.ichReversalInitiated) ichTransfer += '- Anticoagulation reversal initiated\n';
                if (telestrokeNote.ichNeurosurgeryConsulted) ichTransfer += '- Neurosurgery consulted\n';
                if (telestrokeNote.ichSeizureProphylaxis) ichTransfer += '- Seizure prophylaxis ordered\n';
                const ichSurgTx = telestrokeNote.ichSurgicalCriteria || {};
                if (ichSurgTx.cerebellarGt15mL) ichTransfer += '- SURGICAL: Cerebellar ICH >15 mL\n';
                if (ichSurgTx.hydrocephalus) ichTransfer += '- SURGICAL: Obstructive hydrocephalus\n';
                if (ichSurgTx.midlineShift) ichTransfer += '- Midline shift / herniation risk\n';
                if (ichSurgTx.clinicalDeterioration) ichTransfer += '- Clinical deterioration\n';
                if (ichSurgTx.surgeryDecision) ichTransfer += `- Surgical decision: ${ichSurgTx.surgeryDecision}\n`;
                if (ichTransfer !== '\nICH Management:\n') note += ichTransfer;
              }
              // SAH-specific data
              const isDiagSAH = telestrokeNote.diagnosisCategory === 'sah';
              if (isDiagSAH) {
                note += `\nSAH Management:\n`;
                if (telestrokeNote.sahGrade) note += `- ${{'huntHess': 'Hunt & Hess Grade', 'wfns': 'WFNS Grade'}[telestrokeNote.sahGradeScale] || 'SAH Grade'}: ${telestrokeNote.sahGrade}\n`;
                if (telestrokeNote.fisherGrade) note += `- Modified Fisher Grade: ${telestrokeNote.fisherGrade}\n`;
                if (telestrokeNote.sahBPManaged) note += `- BP managed (SBP <160 pre-securing)\n`;
                if (telestrokeNote.sahNimodipine) note += `- Nimodipine: initiated\n`;
                if (telestrokeNote.sahEVDPlaced) note += `- EVD: placed\n`;
                if (telestrokeNote.sahAneurysmSecured) note += `- Aneurysm: secured\n`;
                if (telestrokeNote.sahNeurosurgeryConsulted) note += `- Neurosurgery: consulted\n`;
                if (telestrokeNote.sahSeizureProphylaxis) note += `- Seizure prophylaxis: initiated\n`;
                if (telestrokeNote.sahAneurysmLocation) note += `- Aneurysm location: ${telestrokeNote.sahAneurysmLocation}\n`;
                if (telestrokeNote.sahAneurysmSize) note += `- Aneurysm size: ${telestrokeNote.sahAneurysmSize} mm\n`;
                if (telestrokeNote.sahSecuringMethod) note += `- Securing method: ${telestrokeNote.sahSecuringMethod}\n`;
                const vmTx = telestrokeNote.sahVasospasmMonitoring || {};
                const vmTxItems = [];
                if (vmTx.tcdOrdered) vmTxItems.push('TCD monitoring');
                if (vmTx.neuroChecksQ1h) vmTxItems.push('neuro checks q1h');
                if (vmTx.sodiumMonitoring) vmTxItems.push('sodium q6-8h');
                if (vmTx.dciSuspected) vmTxItems.push('DCI suspected');
                if (vmTx.inducedHypertension) vmTxItems.push('induced hypertension initiated');
                if (vmTxItems.length) note += `- Vasospasm/DCI monitoring: ${vmTxItems.join(', ')}\n`;
                if (vmTx.notes) note += `- DCI notes: ${vmTx.notes}\n`;
              }
              // CVT-specific data
              if (telestrokeNote.diagnosisCategory === 'cvt') {
                let cvtTransfer = '\nCVT MANAGEMENT:\n';
                if (telestrokeNote.cvtAnticoagStarted) cvtTransfer += `- Anticoagulation initiated (${telestrokeNote.cvtAnticoagType || 'agent selected'})\n`;
                if (telestrokeNote.cvtIcpManaged) cvtTransfer += `- ICP management addressed\n`;
                if (telestrokeNote.cvtSeizureManaged) cvtTransfer += `- Seizure management addressed\n`;
                if (telestrokeNote.cvtHematologyConsulted) cvtTransfer += `- Hematology consulted for thrombophilia workup\n`;
                const cvtAc = telestrokeNote.cvtAnticoag || {};
                if (cvtAc.acutePhase) cvtTransfer += `- Acute phase: ${cvtAc.acutePhase.replace(/-/g, ' ')}\n`;
                if (cvtAc.transitionAgent) cvtTransfer += `- Transition agent: ${cvtAc.transitionAgent}\n`;
                if (cvtAc.duration) cvtTransfer += `- Duration: ${cvtAc.duration}\n`;
                if (cvtAc.apsStatus) cvtTransfer += `- APS confirmed — warfarin mandatory\n`;
                if (cvtTransfer !== '\nCVT MANAGEMENT:\n') note += cvtTransfer;
              }
              // TIA workup
              {
                const tiaW = telestrokeNote.tiaWorkup || {};
                const tiaItems = [];
                if (tiaW.mriDwi) tiaItems.push('MRI DWI');
                if (tiaW.ctaHeadNeck) tiaItems.push('CTA Head/Neck');
                if (tiaW.ecg12Lead) tiaItems.push('12-lead ECG');
                if (tiaW.telemetry) tiaItems.push('telemetry');
                if (tiaW.echo) tiaItems.push('echo');
                if (tiaW.labsCbc) tiaItems.push('CBC');
                if (tiaW.labsBmp) tiaItems.push('BMP');
                if (tiaW.labsA1c) tiaItems.push('HbA1c');
                if (tiaW.labsLipids) tiaItems.push('lipid panel');
                if (tiaW.labsTsh) tiaItems.push('TSH');
                if (tiaItems.length > 0) {
                  note += `\nTIA WORKUP:\n`;
                  note += `- Completed: ${tiaItems.join(', ')}\n`;
                  note += `- ${tiaItems.length}/${Object.keys(tiaW).length} items completed\n`;
                }
              }
              // Dissection pathway
              {
                const diss = telestrokeNote.dissectionPathway || {};
                if (diss.antithromboticType || diss.imagingFollowUp) {
                  note += `\nDISSECTION MANAGEMENT:\n`;
                  if (diss.antithromboticType) note += `- Antithrombotic: ${diss.antithromboticType.replace(/-/g, ' ')}\n`;
                  if (diss.imagingFollowUp) note += `- Vascular imaging follow-up: ${diss.imagingFollowUp}\n`;
                  note += `- Cervical manipulation avoidance counseled\n`;
                }
              }
              // Carotid management
              {
                const carotid = telestrokeNote.carotidManagement || {};
                if (carotid.stenosisDegree) {
                  note += `\nCAROTID: ${carotid.stenosisSide || ''} ${carotid.stenosisDegree}% stenosis${carotid.symptomatic ? ' (symptomatic)' : ' (asymptomatic)'}\n`;
                  if (carotid.intervention) note += `- Plan: ${carotid.intervention.replace(/-/g, ' ')}\n`;
                }
              }
              // ESUS/Cryptogenic workup
              {
                const esus = telestrokeNote.esusWorkup || {};
                if (esus.cardiacMonitoringType || esus.teePerformed || esus.hypercoagWorkup) {
                  note += `\nESUS/CRYPTOGENIC WORKUP:\n`;
                  if (esus.cardiacMonitoringType) note += `- Cardiac monitoring: ${esus.cardiacMonitoringType.replace(/-/g, ' ')}\n`;
                  if (esus.teePerformed) note += `- TEE: performed${esus.teeFindings ? ` — ${esus.teeFindings}` : ''}\n`;
                  if (esus.afDetected) note += `- AF DETECTED on monitoring\n`;
                  if (esus.hypercoagWorkup) note += `- Hypercoagulable workup ordered\n`;
                  if (esus.esusAntiplatelet) note += `- Antithrombotic: ${esus.esusAntiplatelet.replace(/-/g, ' ')}\n`;
                }
              }
              // ICH anticoagulation resumption
              {
                const ichAc = telestrokeNote.ichAnticoagResumption || {};
                if (ichAc.decision) {
                  note += `\nICH ANTICOAG RESUMPTION:\n`;
                  if (ichAc.ichLocation) note += `- Location: ${ichAc.ichLocation}\n`;
                  if (ichAc.caaFeatures) note += `- CAA features present\n`;
                  if (ichAc.chadsVascScore) note += `- CHA2DS2-VASc: ${ichAc.chadsVascScore}\n`;
                  if (ichAc.hasbledScore) note += `- HAS-BLED: ${ichAc.hasbledScore}\n`;
                  note += `- Decision: ${ichAc.decision.replace(/-/g, ' ')}\n`;
                  if (ichAc.rationale) note += `- Rationale: ${ichAc.rationale}\n`;
                  if (ichAc.laaoConsidered) note += `- LAAO evaluation considered\n`;
                }
              }
              // Young adult workup (age <50)
              {
                const ya = telestrokeNote.youngAdultWorkup || {};
                const age = parseInt(telestrokeNote.age, 10) || 0;
                const hasTier1 = ya.tier1Items && Object.values(ya.tier1Items).some(Boolean);
                const hasTier2 = ya.tier2Items && Object.values(ya.tier2Items).some(Boolean);
                const hasTier3 = ya.tier3Items && Object.values(ya.tier3Items).some(Boolean);
                if (age > 0 && age < 50 && (hasTier1 || hasTier2 || hasTier3)) {
                  note += `\nYOUNG ADULT STROKE WORKUP (Age ${age}):\n`;
                  if (hasTier1) {
                    const t1 = ya.tier1Items;
                    const done = [];
                    if (t1.ctaMra) done.push('CTA/MRA');
                    if (t1.tteBubble) done.push('TTE with bubble');
                    if (t1.ecg) done.push('ECG');
                    if (t1.telemetry) done.push('telemetry');
                    if (t1.drugScreen) done.push('urine drug screen');
                    if (t1.basicLabs) done.push('basic labs');
                    note += `- Tier 1: ${done.join(', ')}\n`;
                  }
                  if (hasTier2) {
                    const t2 = ya.tier2Items;
                    const done = [];
                    if (t2.tee) done.push('TEE');
                    if (t2.extendedMonitoring) done.push('extended cardiac monitoring');
                    if (t2.aplPanel) done.push('APL panel');
                    note += `- Tier 2: ${done.join(', ')}\n`;
                  }
                  if (hasTier3) {
                    const t3 = ya.tier3Items;
                    const done = [];
                    if (t3.rcvsWorkup) done.push('RCVS workup');
                    if (t3.thrombophilia) done.push('thrombophilia panel');
                    if (t3.fabry) done.push('Fabry screening');
                    if (t3.cadasil) done.push('CADASIL testing');
                    if (t3.vasculitis) done.push('vasculitis workup');
                    note += `- Tier 3: ${done.join(', ')}\n`;
                  }
                }
              }
              // Falls risk assessment
              {
                const fr = telestrokeNote.fallsRisk || {};
                if (fr.highRisk) {
                  note += `\n*** FALLS RISK: HIGH ***\n`;
                  note += `- ${fr.preventionPlanInitiated ? 'Prevention plan active' : 'Prevention plan NEEDED'}\n`;
                  note += `- Bed alarm, sitter, floor mat, supervised ambulation only\n`;
                  if (fr.balanceProgramReferral) note += `- PT/balance program referral placed\n`;
                }
              }
              // Driving restrictions
              {
                const dr = telestrokeNote.drivingRestrictions || {};
                if (dr.restrictionDuration || dr.counselingProvided) {
                  note += `\nDRIVING RESTRICTIONS:\n`;
                  if (dr.restrictionDuration) note += `- Period: ${dr.restrictionDuration}\n`;
                  if (dr.residualDeficits) note += `- Rationale: ${dr.residualDeficits}\n`;
                  if (dr.drivingEvalReferral) note += `- OT driving eval ordered — do NOT drive until cleared\n`;
                  if (dr.commercialDriver) note += `- Commercial driver — DOT medical certification required\n`;
                }
              }
              // Drug interaction alerts
              {
                const di = telestrokeNote.drugInteractions || {};
                const diItems = [];
                if (di.aedDoacInteraction) diItems.push(`AED-DOAC: ${di.aedType} (enzyme-inducing — consider warfarin instead)`);
                if (di.statinInteraction) diItems.push(`Statin: ${di.statinInteractionDrug} (dose adjustment needed)`);
                if (diItems.length > 0) note += `\nDRUG INTERACTIONS:\n${diItems.map(i => `- ${i}`).join('\n')}\n`;
              }
              // Decompressive craniectomy consideration
              {
                const dc = telestrokeNote.decompressiveCraniectomy || {};
                if (dc.considered) {
                  note += `\nDECOMPRESSIVE CRANIECTOMY:\n`;
                  note += `- Being considered for malignant MCA infarction\n`;
                  if (dc.territorySize) note += `- Territory: ${dc.territorySize}\n`;
                  if (dc.timing) note += `- Timing window: ${dc.timing}\n`;
                  note += `- Neurosurgery evaluation needed at receiving center\n`;
                }
              }
              // Nursing/safety alerts for receiving team
              const transferAlerts = [];
              const transferDysphagia = telestrokeNote.dysphagiaScreening || {};
              if (transferDysphagia.bedsideScreenResult === 'fail') transferAlerts.push('NPO — failed dysphagia screen');
              if (telestrokeNote.contrastAllergy) transferAlerts.push('Contrast allergy');
              if (telestrokeNote.pregnancyStroke) transferAlerts.push('PREGNANCY — consult OB');
              if (telestrokeNote.activeCancer) transferAlerts.push('ACTIVE CANCER — consider D-dimer, NBTE eval, oncology consult');
              if (telestrokeNote.sickleCellDisease) transferAlerts.push('SICKLE CELL DISEASE — urgent exchange transfusion, hematology consult');
              if (telestrokeNote.infectiveEndocarditis) transferAlerts.push('INFECTIVE ENDOCARDITIS — avoid anticoagulation, ID consult, blood cultures, TEE');
              const transferMeds = (telestrokeNote.medications || '').toLowerCase();
              if (/nsaid|ibuprofen|naproxen|meloxicam/.test(transferMeds)) transferAlerts.push('On NSAID — hold with antiplatelet/anticoagulation');
              if (transferAlerts.length > 0) {
                note += `\nALERTS: ${transferAlerts.join('; ')}\n`;
              }
              // VTE prophylaxis status
              {
                const txVte = telestrokeNote.vteProphylaxis || {};
                if (txVte.ipcApplied || txVte.pharmacoProphylaxis) {
                  const txVteItems = [];
                  if (txVte.ipcApplied) txVteItems.push('IPC/SCDs in place');
                  if (txVte.pharmacoProphylaxis) txVteItems.push(`pharmacologic: ${txVte.pharmacoProphylaxis}${txVte.enoxaparinDose ? ` ${txVte.enoxaparinDose}` : ''}`);
                  if (txVte.postTpaTimerStarted) txVteItems.push('post-TNK 24h hold in effect');
                  note += `VTE prophylaxis: ${txVteItems.join('; ')}\n`;
                } else if (telestrokeNote.tnkRecommended) {
                  note += `VTE prophylaxis: pharmacologic held (post-TNK 24h) — IPC/SCDs recommended\n`;
                }
              }
              // Nutritional/feeding status
              {
                const txNutr = telestrokeNote.nutritionalSupport || {};
                const txDysph = telestrokeNote.dysphagiaScreening || {};
                if (txDysph.bedsideScreenPerformed || txNutr.feedingRoute) {
                  let feedingLine = 'Feeding status: ';
                  if (txDysph.bedsideScreenResult === 'fail') feedingLine += 'NPO (failed swallow screen)';
                  else if (txDysph.bedsideScreenResult === 'pass') feedingLine += 'Cleared for PO';
                  else if (txDysph.npoStatus) feedingLine += 'NPO';
                  else feedingLine += 'Swallow evaluation pending';
                  if (txNutr.feedingRoute && txNutr.feedingRoute !== 'po') feedingLine += ` — ${txNutr.feedingRoute.toUpperCase()} in place`;
                  if (txDysph.slpConsultOrdered) feedingLine += ' — SLP consult ordered';
                  note += feedingLine + '\n';
                }
              }
              // Osmotic therapy (ICH/SAH)
              {
                const txOsm = telestrokeNote.osmoticTherapy || {};
                if (txOsm.agentUsed || txOsm.indication) {
                  note += `Osmotic therapy: ${txOsm.agentUsed || 'agent not specified'}`;
                  if (txOsm.sodiumTarget) note += ` — Na+ target: ${txOsm.sodiumTarget}`;
                  if (txOsm.correctionRate) note += ` — rate: ${txOsm.correctionRate}`;
                  if (txOsm.serumSodium) note += ` — current Na+: ${txOsm.serumSodium}`;
                  if (txOsm.serumOsmolality) note += ` — Osm: ${txOsm.serumOsmolality}`;
                  note += '\n';
                }
              }
              const txRecText = telestrokeNote.recommendationsText || '___';
              note += `\nRecommendations:\n${txRecText.length > 500 ? txRecText.substring(0, 500) + '\n[...see full consultation note for details]' : txRecText}\n`;
              // Family communication
              const txFc = telestrokeNote.familyCommunication || {};
              if (txFc.discussed) {
                note += `\nFamily Communication:\n`;
                note += `- Discussed with ${txFc.withWhom || 'family'}${txFc.time ? ` at ${txFc.time}` : ''}\n`;
                if (txFc.topicsDiscussed) note += `- Topics: ${txFc.topicsDiscussed}\n`;
              }
              note += `\nPENDING AT TRANSFER:\n`;
              note += `- Follow-up CT: ${telestrokeNote.tnkRecommended ? '24h post-TNK' : 'Per clinical indication'}\n`;
              if (telestrokeNote.evtRecommended) note += `- EVT evaluation at receiving hub\n`;
              note += `- Telestroke attending available for questions: [on-call stroke phone]\n`;
              return note;
            }

            if (noteTemplate === 'signout') {
              const signoutConsultLabel = consultationType === 'telephone' ? 'Telephone' : 'Video Telestroke';
              let note = `SIGNOUT / HANDOFF (${signoutConsultLabel})\n${'='.repeat(40)}\n\n`;
              if (telestrokeNote.callingSite) note += `Site: ${telestrokeNote.callingSite}\n`;
              note += `${telestrokeNote.age || '___'} y/o ${telestrokeNote.sex || '___'} — ${telestrokeNote.diagnosis || '___'}`;
              if (telestrokeNote.toastClassification) note += ` (${TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification})`;
              note += '\n';
              if (telestrokeNote.affectedSide) note += `Affected side: ${telestrokeNote.affectedSide}\n`;
              if (telestrokeNote.weight) note += `Weight: ${telestrokeNote.weight} kg\n`;
              note += `NIHSS: ${telestrokeNote.nihss || nihssScore || 'N/A'}`;
              const signoutGCS = calculateGCS(gcsItems);
              if (signoutGCS > 0) note += ` | GCS: ${signoutGCS}`;
              note += ` | LKW: ${telestrokeNote.lkwUnknown ? 'UNKNOWN (discovery-based)' : (formatTime(telestrokeNote.lkwTime) || '___')}\n`;
              if (telestrokeNote.codeStatus) note += `Code status: ${telestrokeNote.codeStatus}\n`;
              if (telestrokeNote.admitLocation) note += `Location: ${telestrokeNote.admitLocation}\n`;
              note += `\nBrief HPI: ${telestrokeNote.symptoms || '___'}\n\n`;
              let imagingLine = `Key imaging: CT ${telestrokeNote.ctResults || '___'}`;
              if (telestrokeNote.earlyInfarctSigns) imagingLine += ' (early infarct signs)';
              if (telestrokeNote.denseArterySign) imagingLine += ' (hyperdense artery)';
              imagingLine += `; CTA ${telestrokeNote.ctaResults || '___'}`;
              const signoutVessels = (telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None');
              if (signoutVessels.length > 0) imagingLine += ` (${signoutVessels.join(', ')})`;
              if (aspectsScore != null) imagingLine += ` | ASPECTS ${aspectsScore}/10`;
              const soPcAspectsArr = calculatePCAspects(pcAspectsRegions);
              const soPcAspectsObj = (() => { const r = telestrokeNote.pcAspectsRegions || {}; return 10 - ((r.pons ? 2 : 0) + (r.midbrain ? 2 : 0) + (r.cerebL ? 1 : 0) + (r.cerebR ? 1 : 0) + (r.pcaL ? 1 : 0) + (r.pcaR ? 1 : 0) + (r.thalL ? 1 : 0) + (r.thalR ? 1 : 0)); })();
              const soPcAspects = soPcAspectsArr < 10 ? soPcAspectsArr : soPcAspectsObj;
              if (soPcAspects >= 0 && soPcAspects < 10) imagingLine += ` | PC-ASPECTS ${soPcAspects}/10`;
              note += imagingLine + '\n';
              {
                const soCtpS = telestrokeNote.ctpStructured || {};
                if (soCtpS.coreVolume || soCtpS.penumbraVolume) {
                  const soCtp = [];
                  if (soCtpS.coreVolume) soCtp.push(`Core: ${soCtpS.coreVolume} mL`);
                  if (soCtpS.penumbraVolume) soCtp.push(`Penumbra: ${soCtpS.penumbraVolume} mL`);
                  if (soCtpS.coreVolume && soCtpS.penumbraVolume) {
                    const c = parseFloat(soCtpS.coreVolume), p = parseFloat(soCtpS.penumbraVolume);
                    if (!isNaN(c) && !isNaN(p) && c > 0) { const r = p/c; soCtp.push(`Ratio: ${isFinite(r) && r < 1000 ? r.toFixed(1) : '>999'}`); }
                  }
                  note += `CTP: ${soCtp.join('; ')}\n`;
                }
              }
              if (telestrokeNote.collateralGrade) note += `Collaterals: ${telestrokeNote.collateralGrade}\n`;
              if (telestrokeNote.ekgResults) note += `EKG: ${telestrokeNote.ekgResults}\n`;
              const signoutVitals = [`BP ${telestrokeNote.presentingBP || '___'}`];
              if (telestrokeNote.heartRate) signoutVitals.push(`HR ${telestrokeNote.heartRate}`);
              if (telestrokeNote.spO2) signoutVitals.push(`SpO2 ${telestrokeNote.spO2}%`);
              if (telestrokeNote.temperature) signoutVitals.push(`Temp ${telestrokeNote.temperature}°F`);
              if (telestrokeNote.glucose) signoutVitals.push(`Glucose ${telestrokeNote.glucose}`);
              note += `Vitals: ${signoutVitals.join(', ')}\n`;
              const signoutLabs = [];
              if (telestrokeNote.inr) signoutLabs.push(`INR ${telestrokeNote.inr}`);
              if (telestrokeNote.pt) signoutLabs.push(`PT ${telestrokeNote.pt}s`);
              if (telestrokeNote.ptt) signoutLabs.push(`aPTT ${telestrokeNote.ptt}`);
              if (telestrokeNote.plateletCount) signoutLabs.push(`Plt ${telestrokeNote.plateletCount}K`);
              if (telestrokeNote.creatinine) signoutLabs.push(`Cr ${telestrokeNote.creatinine}`);
              if (signoutLabs.length > 0) note += `Labs: ${signoutLabs.join(', ')}\n`;
              if (telestrokeNote.premorbidMRS != null && telestrokeNote.premorbidMRS !== '') note += `Pre-morbid mRS: ${telestrokeNote.premorbidMRS}\n`;
              if (telestrokeNote.strokeTerritory) note += `Territory: ${telestrokeNote.strokeTerritory}${telestrokeNote.strokePhenotype ? ` (${telestrokeNote.strokePhenotype})` : ''}\n`;
              if (telestrokeNote.symptomTrajectory) note += `Trajectory: ${telestrokeNote.symptomTrajectory}${telestrokeNote.symptomOnsetNIHSS ? ` (onset NIHSS ~${telestrokeNote.symptomOnsetNIHSS})` : ''}\n`;
              if (telestrokeNote.allergies) note += `Allergies: ${telestrokeNote.allergies}\n`;
              // Wake-up stroke evaluation (concise)
              {
                const snWus = telestrokeNote.wakeUpStrokeWorkflow || {};
                if (snWus.isWakeUpStroke) {
                  const snDwi = snWus.dwi || {};
                  const snFlair = snWus.flair || {};
                  if (snWus.mriAvailable) {
                    const wakeUpMet = snDwi.positiveForLesion && snFlair.noMarkedHyperintensity && snWus.ageEligible && snWus.nihssEligible;
                    note += `Wake-up stroke: MRI — DWI ${snDwi.positiveForLesion ? '+' : '-'}/FLAIR ${snFlair.noMarkedHyperintensity ? '-' : '+'}${wakeUpMet ? ' → WAKE-UP eligible' : ''}\n`;
                  } else if (snWus.mriAvailable === false) {
                    const snExt = snWus.extendCriteria || {};
                    const extCount = [snExt.nihss4to26, snExt.premorbidMRSLt2, snExt.ischemicCoreLte70, snExt.mismatchRatioGte1_2, snExt.timeWindow4_5to9h].filter(Boolean).length;
                    note += `Wake-up stroke: CTP pathway — EXTEND criteria ${extCount}/5 met${extCount === 5 ? ' → ELIGIBLE' : ''}\n`;
                  }
                }
              }
              note += '\n';
              note += `Treatment given:\n`;
              if (telestrokeNote.tnkRecommended) {
                const signoutDose = telestrokeNote.weight ? calculateTNKDose(telestrokeNote.weight) : null;
                note += `- TNK${signoutDose ? ` ${signoutDose.calculatedDose} mg` : ''} ${telestrokeNote.tnkAdminTime ? 'at ' + (formatTime(telestrokeNote.tnkAdminTime) || '___') : '(recommended, not yet administered)'}\n`;
                if (telestrokeNote.doorTime && telestrokeNote.needleTime) {
                  const [sdH, sdM] = telestrokeNote.doorTime.split(':').map(Number);
                  const [snH, snM] = telestrokeNote.needleTime.split(':').map(Number);
                  if (!isNaN(sdH) && !isNaN(sdM) && !isNaN(snH) && !isNaN(snM)) {
                    let snDtn = (snH * 60 + snM) - (sdH * 60 + sdM);
                    if (snDtn < 0) snDtn += 1440;
                    note += `  DTN: ${snDtn} min\n`;
                  }
                }
              }
              if (telestrokeNote.tnkRecommended && telestrokeNote.disablingDeficit) note += `  DISABLING DEFICIT — TNK despite NIHSS ${telestrokeNote.nihss || nihssScore || '___'}\n`;
              if (telestrokeNote.evtRecommended) note += `- EVT recommended/performed${telestrokeNote.ticiScore ? ` (mTICI ${telestrokeNote.ticiScore})` : ''}\n`;
              if (!telestrokeNote.tnkRecommended && !telestrokeNote.evtRecommended) note += `- Medical management\n`;
              // Anticoagulation status
              if (telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]) {
                const acInfo = ANTICOAGULANT_INFO[telestrokeNote.lastDOACType];
                note += `- Recent anticoagulant: ${acInfo.name}`;
                if (telestrokeNote.lastDOACDose) {
                  const snDoseDate = new Date(telestrokeNote.lastDOACDose);
                  if (!Number.isNaN(snDoseDate.getTime())) note += ` (last dose: ${snDoseDate.toLocaleString()})`;
                }
                note += `\n`;
              }
              // DOAC timing protocol
              {
                const snDoac = telestrokeNote.doacTiming || {};
                if (snDoac.strokeSeverity || snDoac.doacAgent) {
                  const dParts = [];
                  if (snDoac.doacAgent) dParts.push(snDoac.doacAgent.replace(/-/g, ' '));
                  if (snDoac.strokeSeverity) dParts.push(`severity ${snDoac.strokeSeverity} → ${snDoac.strokeSeverity === 'minor' ? 'start within 48h' : snDoac.strokeSeverity === 'moderate' ? 'start Day 3-5' : 'start Day 6-14'}`);
                  if (snDoac.doacInitiationDay) dParts.push(`planned Day ${snDoac.doacInitiationDay}`);
                  if (snDoac.hemorrhagicTransformation) dParts.push('HT — repeat imaging before initiation');
                  note += `- DOAC plan: ${dParts.join('; ')}\n`;
                }
              }
              // Cardiac workup
              {
                const snCw = telestrokeNote.cardiacWorkup || {};
                const cwParts = [];
                if (snCw.ecgComplete) cwParts.push('ECG done');
                if (snCw.telemetryOrdered) cwParts.push('telemetry ordered');
                if (snCw.echoOrdered) cwParts.push('echo ordered');
                if (snCw.extendedMonitoringType) cwParts.push(`extended: ${snCw.extendedMonitoringType}`);
                if (snCw.pfoEvaluation) cwParts.push(`PFO: ${snCw.pfoEvaluation.replace(/-/g, ' ')}`);
                if (cwParts.length > 0) note += `- Cardiac workup: ${cwParts.join(', ')}\n`;
              }
              // Complications
              const signoutComps = [];
              if (telestrokeNote.sichDetected) signoutComps.push('sICH');
              if (telestrokeNote.angioedemaDetected || telestrokeNote.angioedema?.detected) {
                const snAe = telestrokeNote.angioedema || {};
                let snAeStr = 'angioedema';
                if (snAe.severity) snAeStr += ` (${snAe.severity})`;
                if (snAe.intubated) snAeStr += ' — INTUBATED';
                else if (snAe.resolved) snAeStr += ' — resolved';
                signoutComps.push(snAeStr);
              }
              if (telestrokeNote.reperfusionHemorrhage) signoutComps.push('reperfusion hemorrhage');
              if (telestrokeNote.clinicalDeterioration) signoutComps.push('clinical deterioration');
              const htSignout = telestrokeNote.hemorrhagicTransformation || {};
              if (htSignout.detected) signoutComps.push(`HT${htSignout.classification ? ` (${htSignout.classification}${htSignout.symptomatic ? ', sxHT' : ''})` : ''}`);
              if (signoutComps.length > 0) note += `- Complications: ${signoutComps.join(', ')}\n`;
              if (htSignout.detected && (htSignout.antithromboticHeld || htSignout.reimagingPlanned)) {
                const htActions = [];
                if (htSignout.antithromboticHeld) htActions.push('antithrombotics held');
                if (htSignout.reimagingPlanned) htActions.push('repeat imaging planned');
                note += `- HT actions: ${htActions.join(', ')}\n`;
              }
              if (telestrokeNote.complicationNotes) note += `- Complication details: ${telestrokeNote.complicationNotes}\n`;
              // Post-TNK monitoring
              if (telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime) {
                const snPtm = telestrokeNote.postTNKMonitoring || {};
                const snPtmItems = [];
                if (snPtm.neuroChecksQ15min) snPtmItems.push('neuro checks q15min x2h');
                if (snPtm.bpChecksQ15min) snPtmItems.push('BP q15min x2h');
                if (snPtm.bleedingWatch) snPtmItems.push('bleeding precautions');
                if (snPtm.repeatImagingOrdered) snPtmItems.push('24h CT ordered');
                if (snPtm.cardiacMonitoring) snPtmItems.push('cardiac monitor');
                note += snPtmItems.length > 0
                  ? `- Post-TNK: ${snPtmItems.join(', ')}; hold antithrombotics x24h\n`
                  : `- Post-TNK: neuro checks q15min x2h, q30min x6h, q1h x16h; hold antithrombotics x24h\n`;
              }
              // ICH-specific (concise)
              if (telestrokeNote.diagnosisCategory === 'ich') {
                const snIchParts = [];
                {
                  const ichCalcSo = telestrokeNote.ichVolumeCalc || {};
                  const ichVolSo = calculateICHVolume(ichCalcSo);
                  if (ichVolSo && ichVolSo.volume) snIchParts.push(`vol ${ichVolSo.volume} mL${ichVolSo.isLarge ? ' (LARGE)' : ''}`);
                }
                if (telestrokeNote.ichBPManaged) snIchParts.push('BP managed');
                if (telestrokeNote.ichReversalInitiated) snIchParts.push('reversal initiated');
                if (telestrokeNote.ichNeurosurgeryConsulted) snIchParts.push('NSG consulted');
                if (telestrokeNote.ichSeizureProphylaxis) snIchParts.push('seizure ppx');
                const snIchSurg = telestrokeNote.ichSurgicalCriteria || {};
                if (snIchSurg.cerebellarGt15mL) snIchParts.push('cerebellar >15mL');
                if (snIchSurg.hydrocephalus) snIchParts.push('hydrocephalus');
                if (snIchSurg.surgeryDecision) snIchParts.push(`surgery: ${snIchSurg.surgeryDecision}`);
                if (snIchParts.length > 0) note += `- ICH: ${snIchParts.join(', ')}\n`;
              }
              // SAH-specific (concise)
              {
                const snIsSAH = telestrokeNote.diagnosisCategory === 'sah';
                if (snIsSAH) {
                  const snSahParts = [];
                  if (telestrokeNote.sahGrade) snSahParts.push(`Grade ${telestrokeNote.sahGrade}`);
                  if (telestrokeNote.fisherGrade) snSahParts.push(`Fisher ${telestrokeNote.fisherGrade}`);
                  if (telestrokeNote.sahBPManaged) snSahParts.push('BP managed');
                  if (telestrokeNote.sahNimodipine) snSahParts.push('nimodipine');
                  if (telestrokeNote.sahEVDPlaced) snSahParts.push('EVD');
                  if (telestrokeNote.sahAneurysmSecured) snSahParts.push('aneurysm secured');
                  if (telestrokeNote.sahAneurysmLocation) snSahParts.push(`aneurysm: ${telestrokeNote.sahAneurysmLocation}${telestrokeNote.sahAneurysmSize ? ` ${telestrokeNote.sahAneurysmSize}mm` : ''}`);
                  if (telestrokeNote.sahSecuringMethod) snSahParts.push(`securing: ${telestrokeNote.sahSecuringMethod}`);
                  const snVm = telestrokeNote.sahVasospasmMonitoring || {};
                  if (snVm.dciSuspected) snSahParts.push('DCI SUSPECTED');
                  if (snVm.inducedHypertension) snSahParts.push('induced HTN');
                  if (snVm.tcdOrdered) snSahParts.push('TCD monitoring');
                  if (snSahParts.length > 0) note += `- SAH: ${snSahParts.join(', ')}\n`;
                }
              }
              // Safety alerts
              {
                const snAlerts = [];
                const snDysph = telestrokeNote.dysphagiaScreening || {};
                if (snDysph.bedsideScreenResult === 'fail') snAlerts.push('NPO (failed dysphagia screen)');
                if (telestrokeNote.contrastAllergy) snAlerts.push('CONTRAST ALLERGY');
                if (snAlerts.length > 0) note += `- ALERTS: ${snAlerts.join('; ')}\n`;
              }
              // Drug interaction alerts
              {
                const snDi = telestrokeNote.drugInteractions || {};
                const snDiItems = [];
                if (snDi.aedDoacInteraction) snDiItems.push(`AED-DOAC: ${snDi.aedType} (enzyme-inducing — consider warfarin)`);
                if (snDi.statinInteraction) snDiItems.push(`Statin: ${snDi.statinInteractionDrug} (dose adjustment)`);
                if (snDiItems.length > 0) note += `- DRUG INTERACTIONS: ${snDiItems.join('; ')}\n`;
              }
              // Decompressive craniectomy
              {
                const snDc = telestrokeNote.decompressiveCraniectomy || {};
                if (snDc.considered) {
                  note += `- CRANIECTOMY UNDER CONSIDERATION`;
                  if (snDc.territorySize) note += ` — territory: ${snDc.territorySize}`;
                  if (snDc.timing) note += `, window: ${snDc.timing}`;
                  note += `\n`;
                }
              }
              // Pathway-specific (concise)
              if (telestrokeNote.diagnosisCategory === 'cvt') {
                const snCvtParts = [];
                if (telestrokeNote.cvtAnticoagStarted) snCvtParts.push(`anticoag (${telestrokeNote.cvtAnticoagType || '?'})`);
                if (telestrokeNote.cvtIcpManaged) snCvtParts.push('ICP managed');
                if (telestrokeNote.cvtSeizureManaged) snCvtParts.push('seizure managed');
                if (snCvtParts.length > 0) note += `- CVT: ${snCvtParts.join(', ')}\n`;
              }
              {
                const snTiaW = telestrokeNote.tiaWorkup || {};
                const snTiaCount = Object.values(snTiaW).filter(Boolean).length;
                if (snTiaCount > 0) note += `- TIA workup: ${snTiaCount}/${Object.keys(snTiaW).length} items completed\n`;
              }
              {
                const snDiss = telestrokeNote.dissectionPathway || {};
                if (snDiss.antithromboticType) note += `- Dissection: ${snDiss.antithromboticType.replace(/-/g, ' ')}${snDiss.imagingFollowUp ? `, f/u: ${snDiss.imagingFollowUp}` : ''}\n`;
              }
              {
                const snCarotid = telestrokeNote.carotidManagement || {};
                if (snCarotid.stenosisDegree) note += `- Carotid: ${snCarotid.stenosisSide || ''} ${snCarotid.stenosisDegree}% ${snCarotid.symptomatic ? '(sx)' : '(asx)'}${snCarotid.intervention ? ` → ${snCarotid.intervention.replace(/-/g, ' ')}` : ''}\n`;
              }
              {
                const snEsus = telestrokeNote.esusWorkup || {};
                const snEsusParts = [];
                if (snEsus.cardiacMonitoringType) snEsusParts.push(snEsus.cardiacMonitoringType.replace(/-/g, ' '));
                if (snEsus.teePerformed) snEsusParts.push('TEE done');
                if (snEsus.afDetected) snEsusParts.push('AF DETECTED');
                if (snEsus.hypercoagWorkup) snEsusParts.push('hypercoag workup');
                if (snEsusParts.length > 0) note += `- ESUS workup: ${snEsusParts.join(', ')}\n`;
              }
              {
                const snIchAc = telestrokeNote.ichAnticoagResumption || {};
                if (snIchAc.decision) note += `- ICH anticoag: ${snIchAc.decision.replace(/-/g, ' ')}${snIchAc.chadsVascScore ? ` (CHA2DS2-VASc ${snIchAc.chadsVascScore})` : ''}\n`;
              }
              // Special populations
              if (telestrokeNote.pregnancyStroke) note += `- PREGNANCY: OB/GYN co-management recommended\n`;
              if (telestrokeNote.activeCancer) note += `- ACTIVE CANCER: oncology co-management recommended\n`;
              if (telestrokeNote.sickleCellDisease) note += `- SICKLE CELL DISEASE: hematology co-management, exchange transfusion status\n`;
              if (telestrokeNote.infectiveEndocarditis) note += `- INFECTIVE ENDOCARDITIS: TNK contraindicated, infectious disease/cardiology co-management\n`;
              // BP target
              const signoutBpPhase = bpPhaseTargets[telestrokeNote.bpPhase];
              if (signoutBpPhase) note += `- BP target: <${signoutBpPhase.systolic}/${signoutBpPhase.diastolic} (${signoutBpPhase.label})\n`;
              const sp = telestrokeNote.secondaryPrevention || {};
              if (sp.antiplateletRegimen) {
                note += `- Antithrombotic: ${AP_LABELS_SHORT[sp.antiplateletRegimen] || sp.antiplateletRegimen}\n`;
              }
              if (sp.statinDose) { let soStatLine = `- Statin: ${sp.statinDose.replace(/-/g, ' ')}`; if (sp.ldlCurrent) soStatLine += ` (LDL ${sp.ldlCurrent})`; note += soStatLine + '\n'; }
              if (sp.cyp2c19Tested && sp.cyp2c19Result) note += `- CYP2C19: ${sp.cyp2c19Result.replace(/-/g, ' ')}\n`;
              // Consent
              if (telestrokeNote.tnkRecommended && telestrokeNote.tnkConsentDiscussed) {
                const consentType = telestrokeNote.tnkConsentType || '(type not specified)';
                const consentWith = telestrokeNote.tnkConsentWith || '';
                note += `- Consent: ${consentType}${consentWith ? ` with ${consentWith}` : ''}${telestrokeNote.tnkConsentTime ? ` at ${telestrokeNote.tnkConsentTime}` : ''}\n`;
              }
              // Family communication
              const snFc = telestrokeNote.familyCommunication || {};
              if (snFc.discussed) {
                note += `- Family: discussed with ${snFc.withWhom || 'family'}${snFc.time ? ` at ${snFc.time}` : ''}${snFc.topicsDiscussed ? ` — ${snFc.topicsDiscussed}` : ''}\n`;
              }
              if (telestrokeNote.disposition) note += `\nDisposition: ${telestrokeNote.disposition}\n`;
              note += `\nActive issues / To-do:\n`;
              const soRecText = telestrokeNote.recommendationsText || '- (none documented)';
              note += `${soRecText.length > 500 ? soRecText.substring(0, 500) + '\n[...see full consultation note]' : soRecText}\n`;
              return note;
            }

            if (noteTemplate === 'followup') {
              return generateFollowUpBrief();
            }

            if (noteTemplate === 'procedure') {
              let note = `EVT PROCEDURE NOTE\n${'='.repeat(40)}\n\n`;
              note += `Patient: ${telestrokeNote.age || '___'} y/o ${telestrokeNote.sex || '___'}`;
              if (telestrokeNote.weight) note += ` | ${telestrokeNote.weight} kg`;
              note += '\n';
              note += `Diagnosis: ${telestrokeNote.diagnosis || '___'}`;
              if (telestrokeNote.toastClassification) note += ` (${TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification})`;
              note += '\n';
              if (telestrokeNote.allergies) note += `Allergies: ${telestrokeNote.allergies}${telestrokeNote.contrastAllergy ? ' **CONTRAST ALLERGY**' : ''}\n`;
              else if (telestrokeNote.contrastAllergy) note += `Allergies: **CONTRAST ALLERGY**\n`;
              note += `NIHSS: ${telestrokeNote.nihss || nihssScore || 'N/A'}\n`;
              if (telestrokeNote.creatinine) note += `Cr: ${telestrokeNote.creatinine}`;
              if (telestrokeNote.creatinine && telestrokeNote.age && telestrokeNote.weight && telestrokeNote.sex) {
                const procCrcl = calculateCrCl(telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.height);
                if (procCrcl) note += ` (CrCl ${procCrcl.value} mL/min${procCrcl.adjBwValue ? `, AdjBW CrCl ${procCrcl.adjBwValue}` : ''})`;
              }
              if (telestrokeNote.creatinine) note += '\n';
              if (telestrokeNote.inr) note += `INR: ${telestrokeNote.inr}\n`;
              if (telestrokeNote.pt) note += `PT: ${telestrokeNote.pt}s\n`;
              if (telestrokeNote.plateletCount) note += `Plt: ${telestrokeNote.plateletCount}K\n`;
              if (telestrokeNote.glucose) note += `Glucose: ${telestrokeNote.glucose} mg/dL\n`;
              {
                const procVitals = [];
                if (telestrokeNote.presentingBP) procVitals.push(`BP ${telestrokeNote.presentingBP}`);
                if (telestrokeNote.heartRate) procVitals.push(`HR ${telestrokeNote.heartRate}`);
                if (telestrokeNote.spO2) procVitals.push(`SpO2 ${telestrokeNote.spO2}%`);
                if (telestrokeNote.temperature) procVitals.push(`T ${telestrokeNote.temperature}°F`);
                if (procVitals.length > 0) note += `Vitals: ${procVitals.join(', ')}\n`;
              }
              if (telestrokeNote.premorbidMRS != null) note += `Pre-morbid mRS: ${telestrokeNote.premorbidMRS}\n`;
              note += `ASPECTS: ${aspectsScore != null ? aspectsScore + '/10' : 'N/A'}\n`;
              note += `CT Head: ${telestrokeNote.ctResults || '___'}`;
              if (telestrokeNote.earlyInfarctSigns) note += ' (early infarct signs)';
              if (telestrokeNote.denseArterySign) note += ' (hyperdense artery sign)';
              note += '\n';
              if (telestrokeNote.collateralGrade) note += `Collaterals: ${telestrokeNote.collateralGrade}\n`;
              {
                const prCtp = telestrokeNote.ctpStructured || {};
                if (prCtp.coreVolume) {
                  let ctpLine = `CTP: Core ${prCtp.coreVolume} mL`;
                  if (prCtp.penumbraVolume) ctpLine += `, Penumbra ${prCtp.penumbraVolume} mL`;
                  const pc = parseFloat(prCtp.coreVolume), pp = parseFloat(prCtp.penumbraVolume);
                  if (!isNaN(pc) && !isNaN(pp) && pc > 0) { const ratio = pp / pc; ctpLine += `, Ratio ${isFinite(ratio) && ratio < 1000 ? ratio.toFixed(1) : '>999'}`; }
                  note += ctpLine + '\n';
                }
              }
              note += '\n';
              note += `INDICATION:\n`;
              note += `Acute ischemic stroke with large vessel occlusion (${(telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None').join(', ') || '___'}).\n`;
              note += `LKW: ${telestrokeNote.lkwUnknown ? 'Unknown — discovery-based timing' : [formatDate(telestrokeNote.lkwDate), formatTime(telestrokeNote.lkwTime)].filter(Boolean).join(' ') || '___'}\n`;
              if (telestrokeNote.lastDOACType && telestrokeNote.lastDOACType !== 'none') {
                const procDoacName = ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]?.name || telestrokeNote.lastDOACType;
                note += `Anticoagulation: ${procDoacName}`;
                if (telestrokeNote.lastDOACDose) note += ` (last dose: ${telestrokeNote.lastDOACDose})`;
                note += '\n';
              }
              if (telestrokeNote.tnkRecommended) {
                const procDose = telestrokeNote.weight ? calculateTNKDose(telestrokeNote.weight) : null;
                note += `IV TNK${procDose ? ` ${procDose.calculatedDose} mg` : ''} administered at ${formatTime(telestrokeNote.tnkAdminTime) || '___'}\n`;
              }
              note += `\nPROCEDURE DETAILS:\n`;
              note += `Operator: ${telestrokeNote.attendingPhysician || '___'}\n`;
              note += `Anesthesia: ___ (general / conscious sedation / local)\n`;
              note += `Procedure: Mechanical thrombectomy\n`;
              note += `Access: ___ (R/L femoral, R/L radial)\n`;
              note += `Guide catheter: ___\n`;
              note += `Technique: ___ (aspiration, stent retriever, combined)\n`;
              note += `Number of passes: ___\n`;
              {
                const procComps = [];
                const procHt = telestrokeNote.hemorrhagicTransformation || {};
                if (procHt.detected) procComps.push(`hemorrhagic transformation (PH type ${procHt.phType || '___'})`);
                if ((telestrokeNote.angioedema || {}).detected) procComps.push('angioedema');
                note += `Complications: ${procComps.length > 0 ? procComps.join(', ') : '___ (none, perforation, dissection, distal embolization)'}\n`;
              }
              note += `Groin puncture time: ${telestrokeNote.punctureTime || '___'}\n`;
              note += `Reperfusion time: ___\n`;
              note += `mTICI score: ${telestrokeNote.ticiScore || '___'}\n\n`;
              note += `POST-PROCEDURE:\n`;
              if (telestrokeNote.bpPostEVT) note += `- Post-EVT BP: ${telestrokeNote.bpPostEVT}\n`;
              const procBp = bpPhaseTargets['post-evt'];
              note += `- BP target: SBP <${procBp.systolic}/${procBp.diastolic} for 24h; avoid SBP <140 (Class III: Harm per BEST-II/ENCHANTED2)\n`;
              note += `- Neurovascular checks q15min x 2h, then q30min x 4h\n`;
              note += `- Groin site checks q15min x 4h\n`;
              note += `- Hold antiplatelets/anticoagulants x 24h\n`;
              note += `- Repeat CT at 24h\n`;
              note += `- Bedrest with HOB 30° x 6h post-sheath removal\n`;
              if (telestrokeNote.dischargeNIHSS) note += `\nPost-procedure NIHSS: ${telestrokeNote.dischargeNIHSS}\n`;
              return note;
            }

            if (noteTemplate === 'progress') {
              let note = `STROKE INPATIENT PROGRESS NOTE\n${'='.repeat(40)}\n\n`;
              note += `Date: ${new Date().toLocaleDateString()}\n`;
              note += `Hospital Day #: ___\n`;
              note += `Patient: ${telestrokeNote.age || '___'} y/o ${telestrokeNote.sex || '___'}\n`;
              note += `Diagnosis: ${telestrokeNote.diagnosis || '___'}\n`;
              if (telestrokeNote.affectedSide) note += `Affected side: ${telestrokeNote.affectedSide}\n`;
              if (telestrokeNote.strokeTerritory) note += `Territory: ${telestrokeNote.strokeTerritory}${telestrokeNote.strokePhenotype ? ` (${telestrokeNote.strokePhenotype})` : ''}\n`;
              if (telestrokeNote.symptomTrajectory) note += `Trajectory: ${telestrokeNote.symptomTrajectory}\n`;
              if (telestrokeNote.allergies) note += `Allergies: ${telestrokeNote.allergies}${telestrokeNote.contrastAllergy ? ' **CONTRAST ALLERGY**' : ''}\n`;
              note += '\n';
              note += `SUBJECTIVE:\n`;
              note += `Patient reports: ___\n`;
              note += `Pain: ___/10\n`;
              note += `New complaints: ___\n\n`;
              note += `OBJECTIVE:\n`;
              {
                const pnVitals = [];
                pnVitals.push(`T${telestrokeNote.temperature || '___'}`);
                pnVitals.push(`HR${telestrokeNote.heartRate || '___'}`);
                pnVitals.push(`BP${telestrokeNote.presentingBP || '___'}`);
                pnVitals.push(`RR___`);
                pnVitals.push(`SpO2${telestrokeNote.spO2 ? telestrokeNote.spO2 + '%' : '___'}`);
                note += `Vitals: ${pnVitals.join(' ')}\n`;
              }
              note += `I/O: ___\n`;
              note += `NIHSS: ${telestrokeNote.dischargeNIHSS || telestrokeNote.nihss || nihssScore || '___'} (admission: ${telestrokeNote.nihss || nihssScore || '___'})\n`;
              note += `Neuro exam: ___\n\n`;
              note += `LABS/IMAGING:\n`;
              note += `- CT Head: ${telestrokeNote.ctResults || '___'}`;
              if (telestrokeNote.earlyInfarctSigns) note += ' (early infarct signs)';
              if (telestrokeNote.denseArterySign) note += ' (hyperdense artery sign)';
              note += '\n';
              note += `- CTA: ${telestrokeNote.ctaResults || '___'}\n`;
              {
                const pnLabs = [];
                if (telestrokeNote.creatinine) pnLabs.push(`Cr ${telestrokeNote.creatinine}`);
                if (telestrokeNote.inr) pnLabs.push(`INR ${telestrokeNote.inr}`);
                if (telestrokeNote.pt) pnLabs.push(`PT ${telestrokeNote.pt}s`);
                if (telestrokeNote.ptt) pnLabs.push(`aPTT ${telestrokeNote.ptt}`);
                if (telestrokeNote.plateletCount) pnLabs.push(`Plt ${telestrokeNote.plateletCount}K`);
                if (telestrokeNote.glucose) pnLabs.push(`Gluc ${telestrokeNote.glucose}`);
                note += `- Labs: ${pnLabs.length > 0 ? pnLabs.join(', ') : '___'}\n`;
              }
              // Wake-up stroke evaluation
              {
                const prWus = telestrokeNote.wakeUpStrokeWorkflow || {};
                if (prWus.isWakeUpStroke) {
                  const prDwi = prWus.dwi || {};
                  const prFlair = prWus.flair || {};
                  if (prWus.mriAvailable) {
                    note += `- Wake-up stroke: DWI ${prDwi.positiveForLesion ? '+' : '-'} / FLAIR ${prFlair.noMarkedHyperintensity ? 'no hyperintensity' : 'hyperintense'}`;
                    if (prDwi.positiveForLesion && prFlair.noMarkedHyperintensity && prWus.ageEligible && prWus.nihssEligible) note += ` → WAKE-UP eligible`;
                    note += `\n`;
                  } else if (prWus.mriAvailable === false) {
                    const prExt = prWus.extendCriteria || {};
                    const prExtCount = [prExt.nihss4to26, prExt.premorbidMRSLt2, prExt.ischemicCoreLte70, prExt.mismatchRatioGte1_2, prExt.timeWindow4_5to9h].filter(Boolean).length;
                    note += `- Wake-up stroke: CTP — EXTEND ${prExtCount}/5 criteria met${prExtCount === 5 ? ' → ELIGIBLE' : ''}\n`;
                  }
                }
              }
              note += `\n`;
              note += `ASSESSMENT & PLAN:\n`;
              note += `1. Acute stroke management:\n`;
              if (telestrokeNote.tnkRecommended) {
                const prPtm = telestrokeNote.postTNKMonitoring || {};
                const prPtmItems = [];
                if (prPtm.neuroChecksQ15min) prPtmItems.push('neuro checks');
                if (prPtm.bpChecksQ15min) prPtmItems.push('BP monitoring');
                if (prPtm.repeatImagingOrdered) prPtmItems.push('24h CT ordered');
                if (prPtm.cardiacMonitoring) prPtmItems.push('cardiac monitoring');
                note += prPtmItems.length > 0
                  ? `   - Post-TNK: ${prPtmItems.join(', ')} — ongoing\n`
                  : `   - Post-TNK: monitoring complete / ongoing\n`;
              }
              if (telestrokeNote.evtRecommended) note += `   - Post-EVT: mTICI ${telestrokeNote.ticiScore || '___'}\n`;
              const progComps = [];
              if (telestrokeNote.sichDetected) progComps.push('sICH');
              if (telestrokeNote.angioedemaDetected || telestrokeNote.angioedema?.detected) {
                const prAe = telestrokeNote.angioedema || {};
                let prAeStr = 'angioedema';
                if (prAe.severity) prAeStr += ` (${prAe.severity})`;
                if (prAe.intubated) prAeStr += ' — INTUBATED';
                else if (prAe.resolved) prAeStr += ' — resolved';
                progComps.push(prAeStr);
              }
              if (telestrokeNote.reperfusionHemorrhage) progComps.push('reperfusion hemorrhage');
              if (telestrokeNote.clinicalDeterioration) progComps.push('clinical deterioration');
              const htProg = telestrokeNote.hemorrhagicTransformation || {};
              if (htProg.detected) progComps.push(`HT${htProg.classification ? ` (${htProg.classification}${htProg.symptomatic ? ', symptomatic' : ''})` : ''}`);
              if (progComps.length > 0) note += `   - Complications: ${progComps.join(', ')}\n`;
              if (htProg.detected && (htProg.antithromboticHeld || htProg.reimagingPlanned)) {
                const prHtActions = [];
                if (htProg.antithromboticHeld) prHtActions.push('antithrombotics held');
                if (htProg.reimagingPlanned) prHtActions.push('repeat imaging planned');
                note += `   - HT actions: ${prHtActions.join(', ')}\n`;
              }
              // Drug interaction alerts
              {
                const prDi = telestrokeNote.drugInteractions || {};
                const prDiItems = [];
                if (prDi.aedDoacInteraction) prDiItems.push(`AED-DOAC: ${prDi.aedType} (enzyme-inducing)`);
                if (prDi.statinInteraction) prDiItems.push(`Statin: ${prDi.statinInteractionDrug}`);
                if (prDiItems.length > 0) note += `   - Drug interactions: ${prDiItems.join('; ')}\n`;
              }
              // Decompressive craniectomy
              {
                const prDc = telestrokeNote.decompressiveCraniectomy || {};
                if (prDc.considered) {
                  note += `   - CRANIECTOMY under consideration`;
                  if (prDc.territorySize) note += ` (${prDc.territorySize})`;
                  if (prDc.timing) note += ` — window: ${prDc.timing}`;
                  note += `\n`;
                }
              }
              if (telestrokeNote.activeCancer) note += `   - ACTIVE CANCER\n`;
              if (telestrokeNote.sickleCellDisease) note += `   - SICKLE CELL DISEASE\n`;
              if (telestrokeNote.infectiveEndocarditis) note += `   - INFECTIVE ENDOCARDITIS\n`;
              const progBp = bpPhaseTargets[telestrokeNote.bpPhase];
              note += `   - BP goal: ${progBp ? `<${progBp.systolic}/${progBp.diastolic} (${progBp.label})` : '___'}\n`;
              note += `   - DVT prophylaxis: ___\n`;
              note += `   - Dysphagia screening: ${telestrokeNote.dysphagiaScreening?.bedsideScreenPerformed ? 'completed' : 'pending'}\n\n`;
              note += `2. Secondary prevention:\n`;
              const progSp = telestrokeNote.secondaryPrevention || {};
              if (progSp.antiplateletRegimen) note += `   - Antithrombotic: ${AP_LABELS_SHORT[progSp.antiplateletRegimen] || progSp.antiplateletRegimen}\n`;
              if (progSp.statinDose) { let statLine = `   - Statin: ${progSp.statinDose.replace(/-/g, ' ')}`; if (progSp.ldlCurrent) statLine += ` (LDL ${progSp.ldlCurrent} mg/dL)`; note += statLine + '\n'; } else if (progSp.statinDose !== undefined) { note += `   - Statin: ___\n`; }
              if (progSp.cyp2c19Tested && progSp.cyp2c19Result) note += `   - CYP2C19: ${progSp.cyp2c19Result} — ${progSp.cyp2c19Result === 'poor-metabolizer' || progSp.cyp2c19Result === 'intermediate-metabolizer' ? 'consider ticagrelor over clopidogrel' : 'standard clopidogrel dosing appropriate'}\n`;
              if (telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]) {
                const progAcInfo = ANTICOAGULANT_INFO[telestrokeNote.lastDOACType];
                note += `   - Pre-admission anticoagulant: ${progAcInfo.name}`;
                if (telestrokeNote.doacTiming?.doacInitiationDay) note += ` — planned initiation: ${telestrokeNote.doacTiming.doacInitiationDay}`;
                note += `\n`;
              }
              // Enhanced DOAC timing
              {
                const prDoac = telestrokeNote.doacTiming || {};
                if (prDoac.strokeSeverity || prDoac.doacAgent) {
                  const prDoacParts = [];
                  if (prDoac.doacAgent) prDoacParts.push(prDoac.doacAgent.replace(/-/g, ' '));
                  if (prDoac.strokeSeverity) prDoacParts.push(`severity ${prDoac.strokeSeverity} → ${prDoac.strokeSeverity === 'minor' ? 'start within 48h' : prDoac.strokeSeverity === 'moderate' ? 'Day 3-5' : 'Day 6-14'}`);
                  if (prDoac.hemorrhagicTransformation) prDoacParts.push('HT — repeat imaging first');
                  note += `   - DOAC plan: ${prDoacParts.join('; ')}\n`;
                }
              }
              // Enhanced cardiac workup
              {
                const prCw = telestrokeNote.cardiacWorkup || {};
                const prCwParts = [];
                if (prCw.ecgComplete) prCwParts.push('ECG done');
                if (prCw.telemetryOrdered) prCwParts.push('telemetry ordered');
                if (prCw.echoOrdered) prCwParts.push('echo ordered');
                if (prCw.extendedMonitoringType) prCwParts.push(`extended: ${prCw.extendedMonitoringType}`);
                else prCwParts.push('extended monitoring: pending');
                if (prCw.pfoEvaluation) prCwParts.push(`PFO: ${prCw.pfoEvaluation.replace(/-/g, ' ')}`);
                note += `   - Cardiac workup: ${prCwParts.join(', ')}\n\n`;
              }
              note += `3. Disposition planning:\n`;
              note += `   - Estimated discharge: ___\n`;
              note += `   - Disposition: ${telestrokeNote.disposition || '___'}\n`;
              if (telestrokeNote.codeStatus) note += `   - Code status: ${telestrokeNote.codeStatus}\n`;
              note += `   - Rehab needs: ___\n`;
              const prFc = telestrokeNote.familyCommunication || {};
              if (prFc.discussed) {
                note += `   - Family: discussed with ${prFc.withWhom || 'family'}${prFc.time ? ` at ${prFc.time}` : ''}${prFc.topicsDiscussed ? ` — ${prFc.topicsDiscussed}` : ''}\n`;
              }
              note += '\n';
              const progRecText2 = telestrokeNote.recommendationsText || '___';
              note += `RECOMMENDATIONS:\n${progRecText2.length > 500 ? progRecText2.substring(0, 500) + '\n[...see full consultation note]' : progRecText2}\n`;
              return note;
            }

            if (noteTemplate === 'patient-ed') {
              let note = `STROKE PATIENT EDUCATION\n${'='.repeat(40)}\n\n`;
              note += `Dear Patient / Family,\n\n`;
              note += `You have been diagnosed with: ${telestrokeNote.diagnosis || '___'}\n\n`;
              // Treatment history
              {
                const txItems = [];
                if (telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime) txItems.push('a clot-dissolving medication (tenecteplase/TNK) through your IV');
                if (telestrokeNote.evtRecommended) txItems.push('a catheter-based procedure to remove the blood clot (thrombectomy)');
                if (telestrokeNote.diagnosisCategory === 'ich') txItems.push('treatment for bleeding in the brain including blood pressure control and monitoring');
                if (txItems.length > 0) {
                  note += `YOUR TREATMENT:\n`;
                  note += `During your hospital stay, you received:\n`;
                  txItems.forEach(t => { note += `- ${t}\n`; });
                  note += '\n';
                }
              }
              note += `WHAT IS A STROKE?\n`;
              note += `A stroke happens when blood flow to part of the brain is blocked (ischemic stroke) or when a blood vessel in the brain bursts (hemorrhagic stroke). Without blood flow, brain cells begin to die.\n\n`;
              note += `WARNING SIGNS — BE FAST:\n`;
              note += `B — Balance: Sudden loss of balance\n`;
              note += `E — Eyes: Sudden vision changes\n`;
              note += `F — Face: Face drooping on one side\n`;
              note += `A — Arms: Arm weakness or numbness\n`;
              note += `S — Speech: Slurred or difficulty speaking\n`;
              note += `T — Time: Call 911 immediately!\n\n`;
              note += `YOUR MEDICATIONS:\n`;
              const sp = telestrokeNote.secondaryPrevention || {};
              if (sp.antiplateletRegimen) note += `- Blood thinner: ${AP_LABELS_SHORT[sp.antiplateletRegimen] || sp.antiplateletRegimen} — Take as prescribed, do NOT skip doses\n`;
              if (sp.statinDose) note += `- Cholesterol medication: ${sp.statinDose.replace(/-/g, ' ')} — Take daily\n`;
              if (sp.bpMeds) note += `- Blood pressure medication: ${sp.bpMeds}\n`;
              // Anticoagulation information
              {
                const edDoac = telestrokeNote.lastDOACType && telestrokeNote.lastDOACType !== 'none' ? (ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]?.name || telestrokeNote.lastDOACType) : null;
                const edDoacTiming = telestrokeNote.doacTiming || {};
                if (edDoac || (sp.antiplateletRegimen || '').includes('doac') || (sp.antiplateletRegimen || '').includes('anticoag')) {
                  note += `\nANTICOAGULATION (BLOOD THINNER):\n`;
                  if (edDoac) note += `- You are prescribed: ${edDoac}\n`;
                  note += `- This medication helps prevent blood clots and reduces your risk of another stroke\n`;
                  note += `- Take at the SAME TIME every day. Do NOT skip doses — even one missed dose increases stroke risk\n`;
                  note += `- Tell ALL your doctors and dentists that you take a blood thinner\n`;
                  note += `- Seek immediate medical attention if you experience unusual bleeding, blood in urine/stool, or severe bruising\n`;
                  if (edDoacTiming.restartDate) note += `- Restart date: ${edDoacTiming.restartDate}\n`;
                  note += '\n';
                }
              }
              // Patient-specific risk factors
              note += `\nYOUR RISK FACTORS:\n`;
              note += `Understanding and managing your personal risk factors is key to preventing another stroke:\n`;
              note += `- Control blood pressure (target: ${sp.bpTarget || '<130/80'}) — check daily at home\n`;
              if (sp.diabetesManagement && sp.diabetesManagement !== 'no-diabetes') note += `- Manage diabetes: take medications as directed, target A1c <7%\n`;
              if (sp.smokingStatus === 'current') note += `- STOP SMOKING — this is the most important change you can make. Ask your doctor about quit aids\n`;
              else note += `- Do not smoke or use tobacco\n`;
              note += `- Take medications as prescribed — do not stop without talking to your doctor\n`;
              if (sp.exercisePlan) {
                note += `- Exercise: ${sp.exercisePlan}${sp.exerciseMinPerWeek ? ` (goal: ${sp.exerciseMinPerWeek} min/week)` : ''}\n`;
              } else {
                note += `- Exercise regularly (at least 30 min/day, 5 days/week — walking counts!)\n`;
              }
              if (sp.dietPlan) {
                note += `- Diet: ${sp.dietPlan}\n`;
              } else {
                note += `- Eat a heart-healthy diet (low salt, plenty of fruits/vegetables, Mediterranean-style)\n`;
              }
              note += `- Limit alcohol (no more than 1 drink/day for women, 2 for men)\n`;
              if (telestrokeNote.weight) note += `- Maintain a healthy weight\n`;
              note += '\n';
              note += `WHEN TO CALL 911:\n`;
              note += `- Any new stroke symptoms (BE FAST)\n`;
              note += `- Severe headache\n`;
              note += `- Seizures\n`;
              note += `- Difficulty breathing\n\n`;
              // Driving restrictions
              const edDrv = telestrokeNote.drivingRestrictions || {};
              if (edDrv.counselingProvided) {
                note += `DRIVING:\n`;
                note += `- You must NOT drive for ${edDrv.restrictionDuration || 'a period determined by your doctor'}\n`;
                if (edDrv.commercialDriver) note += `- As a commercial driver, additional DMV reporting is required\n`;
                note += `- You will need clearance from your neurologist before driving again\n\n`;
              }
              // Rehab referrals
              const edRehab = telestrokeNote.rehabReferral || {};
              const edRehabItems = [];
              if (edRehab.pt) edRehabItems.push('Physical Therapy');
              if (edRehab.ot) edRehabItems.push('Occupational Therapy');
              if (edRehab.slp) edRehabItems.push('Speech-Language Therapy');
              if (edRehabItems.length > 0) {
                note += `YOUR REHABILITATION:\n`;
                edRehabItems.forEach(r => { note += `- ${r}: Attend all sessions as scheduled\n`; });
                note += '\n';
              }
              note += `FOLLOW-UP APPOINTMENTS:\n`;
              if (sp.followUpTimeline) note += `Recommended timeline: ${sp.followUpTimeline}\n`;
              const edIsTIA = (telestrokeNote.diagnosis || '').toLowerCase().includes('tia');
              const edIsICH = telestrokeNote.diagnosisCategory === 'ich';
              if (edIsTIA) {
                note += `- Stroke clinic: URGENT — within 24-72 hours\n`;
              } else if (edIsICH) {
                note += `- Neurology/Neurosurgery: 2-4 weeks\n`;
              } else {
                note += `- Stroke clinic: 1-2 weeks\n`;
              }
              note += `- Primary care: 1 week\n`;
              note += `- Rehabilitation therapy: as arranged\n`;
              if (telestrokeNote.cardiacWorkup?.extendedMonitoringType) note += `- Cardiology: heart monitoring follow-up (${telestrokeNote.cardiacWorkup.extendedMonitoringType})\n`;
              if (telestrokeNote.carotidManagement?.intervention) note += `- Vascular surgery: carotid procedure follow-up\n`;
              note += `\nBring this document and a list of ALL your medications to every appointment.\n`;
              note += `If you have any questions, call your doctor's office.\n`;
              return note;
            }

            if (noteTemplate === 'discharge') {
              let note = `STROKE DISCHARGE SUMMARY\n${'='.repeat(40)}\n\n`;
              note += `Patient: ${telestrokeNote.age || '___'} y/o ${telestrokeNote.sex || '___'}\n`;
              note += `Diagnosis: ${telestrokeNote.diagnosis || '___'}`;
              if (telestrokeNote.toastClassification) note += ` (${TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification})`;
              note += `\n`;
              note += `Admission Date: ${formatDate(telestrokeNote.lkwDate) || '___'}${telestrokeNote.lkwUnknown ? ' (LKW unknown — wake-up stroke)' : ' (LKW date)'}\n`;
              note += `Discharge Date: ___\n\n`;
              note += `HOSPITAL COURSE:\n`;
              note += `${telestrokeNote.symptoms || '___'}\n`;
              note += `Presenting NIHSS: ${telestrokeNote.nihss || nihssScore || 'N/A'}`;
              const dischGCS = calculateGCS(gcsItems);
              if (dischGCS > 0) note += ` | GCS: ${dischGCS}`;
              note += `\n`;
              note += `Premorbid mRS: ${telestrokeNote.premorbidMRS || 'N/A'}\n`;
              if (telestrokeNote.affectedSide) note += `Affected side: ${telestrokeNote.affectedSide}\n`;
              if (telestrokeNote.allergies) note += `Allergies: ${telestrokeNote.allergies}\n`;
              if (telestrokeNote.contrastAllergy) note += `** CONTRAST ALLERGY — relevant for follow-up vascular imaging **\n`;
              const dischVitals = [`BP ${telestrokeNote.presentingBP || '___'}`];
              if (telestrokeNote.heartRate) dischVitals.push(`HR ${telestrokeNote.heartRate}`);
              if (telestrokeNote.spO2) dischVitals.push(`SpO2 ${telestrokeNote.spO2}%`);
              if (telestrokeNote.temperature) dischVitals.push(`Temp ${telestrokeNote.temperature}°F`);
              if (telestrokeNote.glucose) dischVitals.push(`Glucose ${telestrokeNote.glucose}`);
              note += `Presenting Vitals: ${dischVitals.join(', ')}\n`;
              const dischLabs = [];
              if (telestrokeNote.creatinine) dischLabs.push(`Cr ${telestrokeNote.creatinine}`);
              if (telestrokeNote.inr) dischLabs.push(`INR ${telestrokeNote.inr}`);
              if (telestrokeNote.pt) dischLabs.push(`PT ${telestrokeNote.pt}s`);
              if (telestrokeNote.ptt) dischLabs.push(`PTT ${telestrokeNote.ptt}`);
              if (telestrokeNote.plateletCount) dischLabs.push(`Plt ${telestrokeNote.plateletCount}K`);
              if (dischLabs.length > 0) note += `Pertinent Labs: ${dischLabs.join(', ')}\n`;
              note += `\n`;
              note += `IMAGING:\n`;
              note += `- CT Head: ${telestrokeNote.ctResults || '___'}`;
              if (telestrokeNote.earlyInfarctSigns) note += ' (early infarct signs)';
              if (telestrokeNote.denseArterySign) note += ' (hyperdense artery sign)';
              note += '\n';
              if (aspectsScore !== null && aspectsScore !== undefined) note += `- ASPECTS: ${aspectsScore}/10\n`;
              note += `- CTA: ${telestrokeNote.ctaResults || '___'}`;
              const dischVessels = (telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None');
              if (dischVessels.length > 0) note += ` — Occlusion: ${dischVessels.join(', ')}`;
              note += `\n`;
              {
                const ctpS = telestrokeNote.ctpStructured || {};
                const ctpParts = [];
                if (ctpS.coreVolume) ctpParts.push(`Core: ${ctpS.coreVolume} mL`);
                if (ctpS.penumbraVolume) ctpParts.push(`Penumbra: ${ctpS.penumbraVolume} mL`);
                if (ctpS.coreVolume && ctpS.penumbraVolume) {
                  const c = parseFloat(ctpS.coreVolume), p = parseFloat(ctpS.penumbraVolume);
                  if (!isNaN(c) && !isNaN(p)) {
                    if (c > 0) { const r = p/c; ctpParts.push(`Ratio: ${isFinite(r) && r < 1000 ? r.toFixed(1) : '>999'}`); }
                    else if (p > 0) ctpParts.push(`Ratio: Favorable (core=0)`);
                  }
                }
                if (telestrokeNote.ctpResults) ctpParts.push(telestrokeNote.ctpResults);
                if (ctpParts.length > 0) note += `- CTP: ${ctpParts.join('; ')}\n`;
              }
              if (telestrokeNote.collateralGrade) note += `- Collaterals: ${telestrokeNote.collateralGrade}\n`;
              if (telestrokeNote.ekgResults) note += `- EKG: ${telestrokeNote.ekgResults}\n`;
              // Wake-up stroke evaluation
              {
                const dcWus = telestrokeNote.wakeUpStrokeWorkflow || {};
                if (dcWus.isWakeUpStroke) {
                  note += `\nWAKE-UP STROKE ASSESSMENT:\n`;
                  note += `- MRI available: ${dcWus.mriAvailable ? 'Yes' : dcWus.mriAvailable === false ? 'No (CTP pathway)' : 'Not assessed'}\n`;
                  if (dcWus.mriAvailable) {
                    const dcDwi = dcWus.dwi || {};
                    const dcFlair = dcWus.flair || {};
                    if (dcDwi.positiveForLesion) note += `- DWI: Positive lesion${dcDwi.lesionVolume ? ` (volume: ${dcDwi.lesionVolume} mL)` : ''}\n`;
                    if (dcFlair.noMarkedHyperintensity) note += `- FLAIR: No hyperintensity (DWI-FLAIR mismatch)\n`;
                    if (dcDwi.positiveForLesion && dcFlair.noMarkedHyperintensity && dcWus.ageEligible && dcWus.nihssEligible) {
                      note += `- Met WAKE-UP trial criteria → IV thrombolysis administered per protocol\n`;
                    }
                  } else if (dcWus.mriAvailable === false) {
                    const dcExt = dcWus.extendCriteria || {};
                    const dcExtMet = [];
                    if (dcExt.nihss4to26) dcExtMet.push('NIHSS 4-26');
                    if (dcExt.premorbidMRSLt2) dcExtMet.push('pre-mRS <2');
                    if (dcExt.ischemicCoreLte70) dcExtMet.push('core ≤70cc');
                    if (dcExt.mismatchRatioGte1_2) dcExtMet.push('mismatch ≥1.2');
                    if (dcExt.timeWindow4_5to9h) dcExtMet.push('4.5-9h');
                    if (dcExtMet.length > 0) note += `- EXTEND criteria: ${dcExtMet.join(', ')}\n`;
                    if (dcExtMet.length === 5) note += `- Met EXTEND criteria → IV thrombolysis administered per protocol\n`;
                  }
                }
              }
              note += '\n';
              note += `ACUTE TREATMENT:\n`;
              if (telestrokeNote.tnkRecommended) {
                const dischDose = telestrokeNote.weight ? calculateTNKDose(telestrokeNote.weight) : null;
                note += `- IV TNK ${dischDose ? dischDose.calculatedDose + ' mg' : ''} ${telestrokeNote.tnkAdminTime ? 'at ' + (formatTime(telestrokeNote.tnkAdminTime) || '___') : '(recommended, not yet administered)'}\n`;
                if (telestrokeNote.tnkContraindicationReviewed) note += `- Contraindication review completed${telestrokeNote.tnkContraindicationReviewTime ? ` at ${telestrokeNote.tnkContraindicationReviewTime}` : ''}\n`;
                if (telestrokeNote.disablingDeficit) note += `- DISABLING DEFICIT noted — TNK despite NIHSS ${telestrokeNote.nihss || nihssScore || '___'}\n`;
                if (telestrokeNote.dtnTnkAdministered) note += formatDTNForNote();
              }
              if (telestrokeNote.evtRecommended) note += `- Mechanical thrombectomy${telestrokeNote.ticiScore ? ` (mTICI ${telestrokeNote.ticiScore})` : ''}\n`;
              if (!telestrokeNote.tnkRecommended && !telestrokeNote.evtRecommended) note += `- Medical management\n`;
              // Post-treatment complications
              const dischComplications = [];
              if (telestrokeNote.sichDetected) dischComplications.push('symptomatic ICH (sICH)');
              if (telestrokeNote.angioedemaDetected || telestrokeNote.angioedema?.detected) {
                const dcAe = telestrokeNote.angioedema || {};
                let dcAeStr = 'orolingual angioedema';
                if (dcAe.severity) dcAeStr += ` (${dcAe.severity})`;
                if (dcAe.intubated) dcAeStr += ' — required intubation';
                else if (dcAe.resolved) dcAeStr += ' — resolved';
                dischComplications.push(dcAeStr);
              }
              if (telestrokeNote.reperfusionHemorrhage) dischComplications.push('reperfusion hemorrhage');
              if (telestrokeNote.clinicalDeterioration) dischComplications.push('clinical deterioration');
              const htDisch = telestrokeNote.hemorrhagicTransformation || {};
              if (htDisch.detected) dischComplications.push(`hemorrhagic transformation${htDisch.classification ? ` (ECASS ${htDisch.classification}${htDisch.symptomatic ? ', symptomatic' : ''})` : ''}`);
              if (dischComplications.length > 0) note += `- Complications: ${dischComplications.join(', ')}\n`;
              if (htDisch.detected && (htDisch.antithromboticHeld || htDisch.reimagingPlanned || htDisch.managementActions)) {
                if (htDisch.managementActions) note += `- HT management: ${htDisch.managementActions}\n`;
                if (htDisch.antithromboticHeld) note += `- Antithrombotics held due to HT\n`;
              }
              if (telestrokeNote.complicationNotes) note += `- Complication details: ${telestrokeNote.complicationNotes}\n`;
              if (telestrokeNote.pregnancyStroke) note += `- Pregnancy-associated stroke: OB/GYN co-management\n`;
              if (telestrokeNote.activeCancer) note += `- Active cancer: oncology co-management\n`;
              if (telestrokeNote.sickleCellDisease) note += `- Sickle cell disease: hematology co-management\n`;
              if (telestrokeNote.infectiveEndocarditis) note += `- Infective endocarditis: ID/cardiology co-management\n`;
              // Decompressive craniectomy
              {
                const dcCran = telestrokeNote.decompressiveCraniectomy || {};
                if (dcCran.considered) {
                  note += `- Decompressive craniectomy: considered`;
                  if (dcCran.territorySize) note += ` (${dcCran.territorySize})`;
                  note += `\n`;
                }
              }
              if (telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]) {
                note += `- Pre-admission anticoagulation: ${ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].name}\n`;
              }
              // ICH-specific data
              if (telestrokeNote.diagnosisCategory === 'ich') {
                let ichDisch = '\nICH MANAGEMENT:\n';
                {
                  const ichCalcD = telestrokeNote.ichVolumeCalc || {};
                  const ichVolD = calculateICHVolume(ichCalcD);
                  if (ichVolD && ichVolD.volume) ichDisch += `- ICH volume (ABC/2): ${ichVolD.volume} mL${ichVolD.isLarge ? ' (LARGE)' : ''}\n`;
                }
                if (telestrokeNote.ichBPManaged) ichDisch += '- BP managed (target SBP <140 per INTERACT3/AHA 2022)\n';
                if (telestrokeNote.ichReversalInitiated) ichDisch += '- Anticoagulation reversal initiated\n';
                if (telestrokeNote.ichNeurosurgeryConsulted) ichDisch += '- Neurosurgery consulted\n';
                if (telestrokeNote.ichSeizureProphylaxis) ichDisch += '- Seizure prophylaxis ordered\n';
                if (ichDisch !== '\nICH MANAGEMENT:\n') note += ichDisch;
              }
              // SAH-specific data
              const dischIsSAH = telestrokeNote.diagnosisCategory === 'sah';
              if (dischIsSAH) {
                note += '\nSAH MANAGEMENT:\n';
                if (telestrokeNote.sahGrade) note += `- ${{'huntHess': 'Hunt & Hess Grade', 'wfns': 'WFNS Grade'}[telestrokeNote.sahGradeScale] || 'SAH Grade'}: ${telestrokeNote.sahGrade}\n`;
                if (telestrokeNote.fisherGrade) note += `- Modified Fisher Grade: ${telestrokeNote.fisherGrade}\n`;
                if (telestrokeNote.sahBPManaged) note += `- BP managed (SBP <160 pre-securing)\n`;
                if (telestrokeNote.sahNimodipine) note += `- Nimodipine: initiated\n`;
                if (telestrokeNote.sahEVDPlaced) note += `- EVD: placed\n`;
                if (telestrokeNote.sahAneurysmSecured) note += `- Aneurysm: secured\n`;
                if (telestrokeNote.sahNeurosurgeryConsulted) note += `- Neurosurgery: consulted\n`;
                if (telestrokeNote.sahSeizureProphylaxis) note += `- Seizure prophylaxis: initiated\n`;
              }
              // CVT-specific data
              if (telestrokeNote.diagnosisCategory === 'cvt') {
                let cvtDisch = '\nCVT MANAGEMENT:\n';
                if (telestrokeNote.cvtAnticoagStarted) cvtDisch += `- Anticoagulation initiated (${telestrokeNote.cvtAnticoagType || 'agent selected'})\n`;
                if (telestrokeNote.cvtIcpManaged) cvtDisch += `- ICP management addressed\n`;
                if (telestrokeNote.cvtSeizureManaged) cvtDisch += `- Seizure management addressed\n`;
                if (telestrokeNote.cvtHematologyConsulted) cvtDisch += `- Hematology consulted for thrombophilia workup\n`;
                const dcCvtAc = telestrokeNote.cvtAnticoag || {};
                if (dcCvtAc.acutePhase) cvtDisch += `- Acute phase: ${dcCvtAc.acutePhase.replace(/-/g, ' ')}\n`;
                if (dcCvtAc.transitionAgent) cvtDisch += `- Transition agent: ${dcCvtAc.transitionAgent}\n`;
                if (dcCvtAc.duration) cvtDisch += `- Duration: ${dcCvtAc.duration}\n`;
                if (dcCvtAc.apsStatus) cvtDisch += `- APS confirmed — warfarin mandatory\n`;
                if (cvtDisch !== '\nCVT MANAGEMENT:\n') note += cvtDisch;
              }
              // TIA workup
              {
                const tiaWD = telestrokeNote.tiaWorkup || {};
                const tiaItemsD = [];
                if (tiaWD.mriDwi) tiaItemsD.push('MRI DWI');
                if (tiaWD.ctaHeadNeck) tiaItemsD.push('CTA Head/Neck');
                if (tiaWD.ecg12Lead) tiaItemsD.push('12-lead ECG');
                if (tiaWD.telemetry) tiaItemsD.push('telemetry');
                if (tiaWD.echo) tiaItemsD.push('echo');
                if (tiaWD.labsCbc) tiaItemsD.push('CBC');
                if (tiaWD.labsBmp) tiaItemsD.push('BMP');
                if (tiaWD.labsA1c) tiaItemsD.push('HbA1c');
                if (tiaWD.labsLipids) tiaItemsD.push('lipid panel');
                if (tiaWD.labsTsh) tiaItemsD.push('TSH');
                if (tiaItemsD.length > 0) {
                  note += `\nTIA WORKUP:\n`;
                  note += `- Completed: ${tiaItemsD.join(', ')}\n`;
                }
              }
              // Dissection pathway
              {
                const dissD = telestrokeNote.dissectionPathway || {};
                if (dissD.antithromboticType || dissD.imagingFollowUp) {
                  note += `\nDISSECTION MANAGEMENT:\n`;
                  if (dissD.antithromboticType) note += `- Antithrombotic: ${dissD.antithromboticType.replace(/-/g, ' ')}\n`;
                  if (dissD.imagingFollowUp) note += `- Vascular imaging follow-up: ${dissD.imagingFollowUp}\n`;
                }
              }
              // Carotid management
              {
                const carotidD = telestrokeNote.carotidManagement || {};
                if (carotidD.stenosisDegree) {
                  note += `\nCAROTID: ${carotidD.stenosisSide || ''} ${carotidD.stenosisDegree}% stenosis${carotidD.symptomatic ? ' (symptomatic)' : ' (asymptomatic)'}\n`;
                  if (carotidD.intervention) note += `- Plan: ${carotidD.intervention.replace(/-/g, ' ')}\n`;
                }
              }
              // ESUS/Cryptogenic workup
              {
                const esusD = telestrokeNote.esusWorkup || {};
                if (esusD.cardiacMonitoringType || esusD.teePerformed || esusD.hypercoagWorkup) {
                  note += `\nESUS/CRYPTOGENIC WORKUP:\n`;
                  if (esusD.cardiacMonitoringType) note += `- Cardiac monitoring: ${esusD.cardiacMonitoringType.replace(/-/g, ' ')}\n`;
                  if (esusD.teePerformed) note += `- TEE: performed${esusD.teeFindings ? ` — ${esusD.teeFindings}` : ''}\n`;
                  if (esusD.afDetected) note += `- AF DETECTED on monitoring\n`;
                  if (esusD.hypercoagWorkup) note += `- Hypercoagulable workup ordered\n`;
                  if (esusD.esusAntiplatelet) note += `- Antithrombotic: ${esusD.esusAntiplatelet.replace(/-/g, ' ')}\n`;
                }
              }
              // ICH anticoagulation resumption
              {
                const ichAcD = telestrokeNote.ichAnticoagResumption || {};
                if (ichAcD.decision) {
                  note += `\nICH ANTICOAG RESUMPTION:\n`;
                  if (ichAcD.ichLocation) note += `- Location: ${ichAcD.ichLocation}\n`;
                  if (ichAcD.caaFeatures) note += `- CAA features present\n`;
                  if (ichAcD.chadsVascScore) note += `- CHA2DS2-VASc: ${ichAcD.chadsVascScore}\n`;
                  if (ichAcD.hasbledScore) note += `- HAS-BLED: ${ichAcD.hasbledScore}\n`;
                  note += `- Decision: ${ichAcD.decision.replace(/-/g, ' ')}\n`;
                  if (ichAcD.rationale) note += `- Rationale: ${ichAcD.rationale}\n`;
                  if (ichAcD.laaoConsidered) note += `- LAAO evaluation considered\n`;
                }
              }
              note += '\n';
              note += `SECONDARY PREVENTION:\n`;
              const dischSp = telestrokeNote.secondaryPrevention || {};
              if (dischSp.antiplateletRegimen) {
                let apLine = `- Antithrombotic: ${AP_LABELS_SHORT[dischSp.antiplateletRegimen] || dischSp.antiplateletRegimen}`;
                if (dischSp.daptDuration) apLine += ` (DAPT ${dischSp.daptDuration})`;
                if (dischSp.cyp2c19Tested && dischSp.cyp2c19Result) {
                  const cypLabels = { 'normal': 'normal metabolizer', 'intermediate': 'intermediate metabolizer', 'poor-metabolizer': 'poor metabolizer (LOF)', 'ultra-rapid': 'ultra-rapid metabolizer' };
                  apLine += ` — CYP2C19: ${cypLabels[dischSp.cyp2c19Result] || dischSp.cyp2c19Result}`;
                } else if (dischSp.cyp2c19Tested) {
                  apLine += ' — CYP2C19: tested, result pending';
                }
                note += apLine + '\n';
              }
              if (dischSp.statinDose) {
                let statLine = `- Statin: ${dischSp.statinDose.replace(/-/g, ' ')}`;
                if (dischSp.ezetimibeAdded) statLine += ' + ezetimibe';
                if (dischSp.pcsk9Added) statLine += ' + PCSK9i';
                if (dischSp.ldlCurrent) statLine += ` (LDL ${dischSp.ldlCurrent} mg/dL)`;
                note += statLine + '\n';
              }
              if (dischSp.bpTarget) note += `- BP Target: ${dischSp.bpTarget}${dischSp.bpMeds ? ` (on ${dischSp.bpMeds})` : ''}\n`;
              if (dischSp.diabetesManagement && dischSp.diabetesManagement !== 'no-diabetes') note += `- Diabetes: ${dischSp.diabetesManagement.replace(/-/g, ' ')}\n`;
              if (dischSp.smokingStatus && dischSp.smokingStatus !== 'never') {
                note += `- Smoking: ${dischSp.smokingStatus.replace(/-/g, ' ')}${dischSp.smokingCessationRx ? ` — ${dischSp.smokingCessationRx}` : ''}\n`;
              }
              if (dischSp.glp1ra && dischSp.glp1ra !== 'not-indicated') note += `- GLP-1 RA: ${dischSp.glp1ra.replace(/-/g, ' ')}\n`;
              if (dischSp.sglt2i && dischSp.sglt2i !== 'not-indicated') note += `- SGLT2i: ${dischSp.sglt2i.replace(/-/g, ' ')}\n`;
              if (dischSp.exercisePlan) {
                let exLine = `- Exercise: ${dischSp.exercisePlan}`;
                if (dischSp.exerciseMinPerWeek) exLine += ` (${dischSp.exerciseMinPerWeek} min/week)`;
                note += exLine + '\n';
              }
              if (dischSp.dietPlan) note += `- Diet: ${dischSp.dietPlan}\n`;
              if (dischSp.followUpTimeline) note += `- Follow-up timeline: ${dischSp.followUpTimeline}\n`;
              // DOAC timing
              {
                const dcDoac = telestrokeNote.doacTiming || {};
                if (dcDoac.strokeSeverity || dcDoac.doacAgent) {
                  const dcDoacParts = [];
                  if (dcDoac.doacAgent) dcDoacParts.push(dcDoac.doacAgent.replace(/-/g, ' '));
                  if (dcDoac.strokeSeverity) dcDoacParts.push(`severity ${dcDoac.strokeSeverity}`);
                  if (dcDoac.doacInitiationDay) dcDoacParts.push(`planned Day ${dcDoac.doacInitiationDay}`);
                  note += `- DOAC plan: ${dcDoacParts.join('; ')}\n`;
                }
              }
              // Drug interaction alerts
              {
                const dcDi = telestrokeNote.drugInteractions || {};
                if (dcDi.aedDoacInteraction) note += `- Drug interaction: AED-DOAC (${dcDi.aedType}) — enzyme-inducing, consider warfarin\n`;
                if (dcDi.statinInteraction) note += `- Drug interaction: Statin (${dcDi.statinInteractionDrug}) — dose adjustment needed\n`;
              }
              // Full cardiac workup
              {
                const dcCw = telestrokeNote.cardiacWorkup || {};
                const dcCwParts = [];
                if (dcCw.ecgComplete) dcCwParts.push('ECG done');
                if (dcCw.telemetryOrdered) dcCwParts.push('telemetry');
                if (dcCw.echoOrdered) dcCwParts.push('echo ordered');
                if (dcCw.extendedMonitoringType) dcCwParts.push(`extended: ${dcCw.extendedMonitoringType}`);
                if (dcCw.pfoEvaluation) dcCwParts.push(`PFO: ${dcCw.pfoEvaluation.replace(/-/g, ' ')}`);
                if (dcCwParts.length > 0) note += `- Cardiac workup: ${dcCwParts.join(', ')}\n`;
              }
              note += '\n';
              // Dysphagia and VTE status
              const dysphagia = telestrokeNote.dysphagiaScreening || {};
              if (dysphagia.bedsideScreenPerformed) {
                note += `- Dysphagia screen: ${dysphagia.bedsideScreenResult || 'completed'}${dysphagia.bedsideScreenResult === 'fail' ? ' — NPO, SLP referral' : ''}\n`;
              }
              const vte = telestrokeNote.vteProphylaxis || {};
              if (vte.ipcApplied || vte.pharmacoProphylaxis) {
                const vteParts = [];
                if (vte.ipcApplied) vteParts.push('IPC');
                if (vte.pharmacoProphylaxis) vteParts.push(vte.pharmacoProphylaxis);
                note += `- VTE prophylaxis: ${vteParts.join(' + ')}\n`;
              }
              // Osmotic therapy (ICH/SAH)
              const osmo = telestrokeNote.osmoticTherapy || {};
              if (osmo.agentUsed) {
                note += `- Osmotic therapy: ${osmo.agentUsed}`;
                if (osmo.sodiumTarget) note += ` | Na+ target: ${osmo.sodiumTarget} mEq/L`;
                if (osmo.serumSodium) note += ` | Last Na+: ${osmo.serumSodium}`;
                if (osmo.serumOsmolality) note += ` | Osm: ${osmo.serumOsmolality}`;
                note += '\n';
              }
              // Nutritional support
              const nutri = telestrokeNote.nutritionalSupport || {};
              if (nutri.feedingRoute) {
                note += `- Nutrition: ${nutri.feedingRoute}`;
                if (nutri.ngPlacementDay) note += ` (NG day ${nutri.ngPlacementDay})`;
                if (nutri.pegConsiderationDay) note += ` | PEG consideration day ${nutri.pegConsiderationDay}`;
                if (nutri.nutritionConsultOrdered) note += ' | Nutrition consult ordered';
                note += '\n';
              }
              // Falls risk
              const falls = telestrokeNote.fallsRisk || {};
              if (falls.screenPerformed) {
                note += `- Falls risk: ${falls.highRisk ? 'HIGH RISK' : 'standard risk'}${falls.preventionPlanInitiated ? ' — prevention plan initiated' : ''}${falls.balanceProgramReferral ? ', balance program referral' : ''}\n`;
              }
              // Screening tools
              const dischSt = telestrokeNote.screeningTools || {};
              if (dischSt.phq2Score || dischSt.mocaScore || dischSt.stopBangScore || dischSt.seizureRisk) {
                note += `\nPOST-STROKE SCREENING:\n`;
                if (dischSt.phq2Score) note += `- PHQ-2: ${dischSt.phq2Score}/6 (${dischSt.phq2Positive ? 'POSITIVE — consider full PHQ-9' : 'negative'})\n`;
                if (dischSt.mocaScore) note += `- MoCA: ${dischSt.mocaScore}/30${dischSt.mocaReferral ? ' — neuropsych referral placed' : ''}\n`;
                if (dischSt.stopBangScore) note += `- STOP-BANG: ${dischSt.stopBangScore}/8 (${parseInt(dischSt.stopBangScore, 10) >= 5 ? 'HIGH risk' : parseInt(dischSt.stopBangScore, 10) >= 3 ? 'INTERMEDIATE risk' : 'low risk'} OSA)\n`;
                if (dischSt.seizureRisk) note += `- Seizure status: ${dischSt.seizureRisk.replace(/-/g, ' ')}\n`;
              }
              note += '\n';
              const dischMRS = (telestrokeNote.mrsAssessment || {}).discharge;
              note += `DISCHARGE NIHSS: ${telestrokeNote.dischargeNIHSS || nihssScore || '___'}${!telestrokeNote.dischargeNIHSS && nihssScore ? ' (admission — update before finalizing)' : ''}\n`;
              note += `DISCHARGE mRS: ${dischMRS || '___'}\n\n`;
              // Rehab referrals
              {
                const rehab = telestrokeNote.rehabReferral || {};
                const rehabItems = [];
                if (rehab.pt) rehabItems.push('PT');
                if (rehab.ot) rehabItems.push('OT');
                if (rehab.slp) rehabItems.push('SLP');
                if (rehab.neuropsych) rehabItems.push('neuropsych');
                if (rehab.socialWork) rehabItems.push('social work');
                if (rehab.vocationalRehab) rehabItems.push('vocational rehab');
                if (rehabItems.length > 0) note += `REHAB REFERRALS: ${rehabItems.join(', ')}\n\n`;
              }
              note += `DISPOSITION: ${telestrokeNote.disposition || '___'}\n`;
              note += `CODE STATUS: ${telestrokeNote.codeStatus || '___'}\n\n`;
              // Key results for discharge
              note += `KEY RESULTS:\n`;
              note += `- Echo (TTE/TEE): ___\n`;
              note += `- Carotid imaging: ___\n`;
              note += `- LDL: ___ mg/dL  (target <70)\n`;
              note += `- HbA1c: ___\n\n`;
              // Medication reconciliation
              note += `MEDICATION RECONCILIATION:\n`;
              note += `Home Medications: ${telestrokeNote.medications || '___'}\n`;
              note += `Discharge Medications & Changes:\n`;
              if (dischSp.antiplateletRegimen) note += `  - ${AP_LABELS_SHORT[dischSp.antiplateletRegimen] || dischSp.antiplateletRegimen} (NEW/CONTINUED)\n`;
              if (dischSp.statinDose) note += `  - ${dischSp.statinDose.replace(/-/g, ' ')} (NEW/CONTINUED)\n`;
              if (dischSp.bpMeds) note += `  - ${dischSp.bpMeds} (NEW/CONTINUED/ADJUSTED)\n`;
              if (telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]) {
                note += `  - ${ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].name}: HELD — restart per CATALYST timing\n`;
              }
              note += `  - [Review and reconcile all home medications]\n\n`;
              note += `FOLLOW-UP:\n`;
              const isTIA = (telestrokeNote.diagnosis || '').toLowerCase().includes('tia');
              if (isTIA) {
                note += `- URGENT Stroke/Neurology clinic: within 24-72 hours (TIA — high early recurrence risk)\n`;
              } else {
                note += `- Stroke/Neurology clinic: 1-2 weeks (review imaging, labs, secondary prevention)\n`;
              }
              note += `- PCP: 1 week (BP, statin titration, medication reconciliation)\n`;
              if (dcCw.extendedMonitoringType) note += `- Cardiology: cardiac monitoring review (${dcCw.extendedMonitoringType})\n`;
              if (telestrokeNote.evtRecommended) note += `- Neurovascular: vascular imaging follow-up 3-6 months\n`;
              if (telestrokeNote.diagnosisCategory === 'ischemic' && telestrokeNote.toastClassification === 'large-artery') note += `- Carotid duplex or CTA neck in 3-6 months\n`;
              const isDissection = (telestrokeNote.ctaResults || '').toLowerCase().includes('dissect') || (telestrokeNote.toastClassification || '') === 'other-determined';
              if (isDissection) note += `- Repeat CTA/MRA neck at 3 months and 6 months (dissection follow-up — assess for recanalization, persistent stenosis, or pseudoaneurysm)\n`;
              note += `\nFOLLOW-UP LABS:\n`;
              note += `- Fasting lipid panel at 4-6 weeks (target LDL <70 mg/dL per TST trial)\n`;
              if (dischSp.antiplateletRegimen && dischSp.antiplateletRegimen.includes('doac')) note += `- Renal function (Cr/eGFR) at 1-3 months for DOAC monitoring\n`;
              if (telestrokeNote.diagnosisCategory === 'ischemic') note += `- HbA1c at 3 months if diabetic or new diagnosis\n`;
              note += '\n';
              note += `PATIENT EDUCATION:\n`;
              note += `- Stroke warning signs (BE-FAST)\n`;
              note += `- Medication compliance\n`;
              note += `- When to call 911\n`;
              const driving = telestrokeNote.drivingRestrictions || {};
              if (driving.counselingProvided) {
                note += `- Driving: restricted${driving.restrictionDuration ? ` x ${driving.restrictionDuration}` : ' per state law'}${driving.commercialDriver ? ' (COMMERCIAL DRIVER — DMV notification required)' : ''}${driving.drivingEvalReferral ? ' — driving eval referral placed' : ''}\n`;
              } else {
                note += `- Driving restrictions per state law\n`;
              }
              note += '\n';
              note += `RED FLAGS — RETURN TO ED IMMEDIATELY IF:\n`;
              note += `- New or worsening weakness, numbness, or speech difficulty\n`;
              note += `- Sudden severe headache (worst headache of life)\n`;
              note += `- Vision loss or double vision\n`;
              note += `- Difficulty walking or loss of balance\n`;
              note += `- Chest pain, shortness of breath, or signs of bleeding\n`;
              note += `- Call 911 immediately — do NOT drive yourself\n\n`;
              // Goals of care / palliative care
              {
                const pall = telestrokeNote.palliativeCare || {};
                if (pall.goalsOfCareDiscussed || pall.consultOrdered) {
                  note += `GOALS OF CARE:\n`;
                  if (pall.goalsOfCareDiscussed) note += `- Goals of care discussion: completed${pall.goalsOfCareOutcome ? ` — ${pall.goalsOfCareOutcome.replace(/-/g, ' ')}` : ''}\n`;
                  if (pall.consultOrdered) note += `- Palliative care consult ordered\n`;
                  if (pall.dnrPostponementAlert) note += `- DNR/POLST status: reviewed\n`;
                  note += '\n';
                }
              }
              // Perioperative anticoag bridging (PAUSE protocol)
              {
                const bridge = telestrokeNote.anticoagBridging || {};
                if (bridge.bridgingNeeded || bridge.doacType) {
                  note += `PERIOPERATIVE ANTICOAGULATION (PAUSE PROTOCOL):\n`;
                  if (bridge.doacType) note += `- Agent: ${bridge.doacType}\n`;
                  if (bridge.crCl) note += `- CrCl: ${bridge.crCl} mL/min\n`;
                  if (bridge.procedureRisk) note += `- Procedure bleeding risk: ${bridge.procedureRisk}\n`;
                  if (bridge.holdDays) note += `- Hold: ${bridge.holdDays} days pre-procedure\n`;
                  if (bridge.resumeDay) note += `- Resume: Day ${bridge.resumeDay} post-procedure\n`;
                  if (bridge.warfarinBridgeIndication) note += `- Warfarin bridging: ${bridge.warfarinBridgeIndication}\n`;
                  note += '\n';
                }
              }
              const dischRecText = telestrokeNote.recommendationsText || '___';
              note += `RECOMMENDATIONS:\n${dischRecText.length > 500 ? dischRecText.substring(0, 500) + '\n[...see full consultation note]' : dischRecText}\n`;
              if (telestrokeNote.attendingPhysician) note += `\nAttending Physician: ${telestrokeNote.attendingPhysician}\n`;
              return note;
            }

            // Default: 'consult' — use the editable template
            let note = editableTemplate;

            // Replace all placeholders with actual values
            note = note.replace(/{chiefComplaint}/g, telestrokeNote.chiefComplaint || '');
            if (telestrokeNote.lkwUnknown) {
              note = note.replace(/{lkwDate}/g, 'UNKNOWN');
              note = note.replace(/{lkwTime}/g, '(wake-up stroke / unwitnessed)');
              if (telestrokeNote.discoveryDate || telestrokeNote.discoveryTime) {
                const disc = [formatDate(telestrokeNote.discoveryDate), formatTime(telestrokeNote.discoveryTime)].filter(Boolean).join(' ');
                note = note.replace(/Last known well \(date\/time\):([^\n]*)\n/, `Last known well (date/time):$1\nDiscovery date/time: ${disc} (used for window calculation)\n`);
              }
            } else {
              note = note.replace(/{lkwDate}/g, formatDate(telestrokeNote.lkwDate));
              note = note.replace(/{lkwTime}/g, formatTime(telestrokeNote.lkwTime));
            }
            note = note.replace(/{age}/g, telestrokeNote.age || '');
            note = note.replace(/{sex}/g, telestrokeNote.sex || '');
            // Conditional HPI demographics — avoid " year old" when age empty
            {
              const ageStr = telestrokeNote.age;
              const sexStr = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : telestrokeNote.sex || '';
              const demo = ageStr ? `${ageStr} year old ${sexStr}`.trim() : (sexStr || '___');
              note = note.replace(/{hpiDemographics}/g, demo);
            }
            note = note.replace(/{symptoms}/g, telestrokeNote.symptoms || '');
            note = note.replace(/{pmh}/g, telestrokeNote.pmh || '');
            note = note.replace(/{medications}/g, telestrokeNote.medications || '');
            note = note.replace(/{presentingBP}/g, telestrokeNote.presentingBP || '___');
            note = note.replace(/{heartRate}/g, telestrokeNote.heartRate || '___');
            note = note.replace(/{spO2}/g, telestrokeNote.spO2 || '___');
            note = note.replace(/{temperature}/g, telestrokeNote.temperature || '___');
            note = note.replace(/{bpPreTNK}/g, telestrokeNote.bpPreTNK || '___');
            note = note.replace(/{bpPreTNKTime}/g, formatTime(telestrokeNote.bpPreTNKTime));
            // Conditional BP pre-TNK line — avoid "BP X at " when time is empty
            {
              const bpVal = telestrokeNote.bpPreTNK;
              const bpTime = formatTime(telestrokeNote.bpPreTNKTime);
              const bpLine = bpVal ? `BP prior to TNK administration: ${bpVal}${bpTime ? ` at ${bpTime}` : ''}` : '';
              note = note.replace(/{bpPreTNKLine}/g, bpLine);
            }
            note = note.replace(/{glucose}/g, telestrokeNote.glucose || '___');
            note = note.replace(/{plateletCount}/g, telestrokeNote.plateletCount || '___');
            note = note.replace(/{plateletsCoags}/g, telestrokeNote.plateletCount || '___');
            note = note.replace(/{creatinine}/g, telestrokeNote.creatinine || '___');
            note = note.replace(/{nihss}/g, telestrokeNote.nihss || nihssScore || '');
            const gcsForNote = calculateGCS(gcsItems);
            note = note.replace(/{gcs}/g, gcsForNote > 0 ? `| GCS: ${gcsForNote} ` : '');
            note = note.replace(/{nihssDetails}/g, telestrokeNote.nihssDetails || '');
            note = note.replace(/{ctTime}/g, [formatDate(telestrokeNote.ctDate), formatTime(telestrokeNote.ctTime)].filter(Boolean).join(' '));
            {
              let ctRes = telestrokeNote.ctResults || '';
              if (telestrokeNote.earlyInfarctSigns) ctRes += (ctRes ? ' — ' : '') + 'early infarct signs present';
              if (telestrokeNote.denseArterySign) ctRes += (ctRes ? ' — ' : '') + 'hyperdense artery sign';
              note = note.replace(/{ctResults}/g, ctRes);
            }
            note = note.replace(/{ctaDate}/g, formatDate(telestrokeNote.ctaDate) || '');
            note = note.replace(/{ctaTime}/g, [formatDate(telestrokeNote.ctaDate), formatTime(telestrokeNote.ctaTime)].filter(Boolean).join(' '));
            note = note.replace(/{ctaResults}/g, telestrokeNote.ctaResults || '');
            note = note.replace(/{ekgResults}/g, telestrokeNote.ekgResults || '');
            const inrVal = telestrokeNote.inr || '';
            const pttVal = telestrokeNote.ptt || '';
            const inrPttStr = [inrVal ? `${inrVal}` : '', pttVal ? `aPTT ${pttVal}` : ''].filter(Boolean).join(', ');
            note = note.replace(/{inr}{ptt}/g, inrPttStr);
            note = note.replace(/{inr}/g, inrVal);
            note = note.replace(/{ptt}/g, pttVal ? `, aPTT ${pttVal}` : '');
            const aspectsStr = aspectsScore != null ? `ASPECTS ${aspectsScore}/10` : '';
            note = note.replace(/{aspects}/g, aspectsStr);
            const vesselStr = (telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None').join(', ');
            note = note.replace(/{vesselOcclusion}/g, vesselStr ? `Occlusion: ${vesselStr}` : '');
            {
              const ctpS = telestrokeNote.ctpStructured || {};
              const ctpParts = [];
              if (ctpS.coreVolume) ctpParts.push(`Core: ${ctpS.coreVolume} mL`);
              if (ctpS.penumbraVolume) ctpParts.push(`Penumbra (Tmax>6s): ${ctpS.penumbraVolume} mL`);
              if (ctpS.coreVolume && ctpS.penumbraVolume) {
                const c = parseFloat(ctpS.coreVolume), p = parseFloat(ctpS.penumbraVolume);
                if (!isNaN(c) && !isNaN(p)) {
                  if (c > 0) {
                    const ratio = p / c;
                    ctpParts.push(`Mismatch ratio: ${isFinite(ratio) && ratio < 1000 ? ratio.toFixed(1) : '>999'}`);
                  } else if (p > 0) ctpParts.push(`Mismatch ratio: Favorable (core=0)`);
                }
              }
              if (telestrokeNote.ctpResults) ctpParts.push(telestrokeNote.ctpResults);
              note = note.replace(/{ctpResults}/g, ctpParts.length > 0 ? ctpParts.join('; ') : 'N/A');
            }
            if (telestrokeNote.collateralGrade) {
              note = note.replace(/CTP:([^\n]*)\n/, `CTP:$1\nCollaterals: ${telestrokeNote.collateralGrade}\n`);
            }
            note = note.replace(/{diagnosis}/g, telestrokeNote.diagnosis || '');
            note = note.replace(/{tnkAdminTime}/g, formatTime(telestrokeNote.tnkAdminTime));
            note = note.replace(/{recommendationsText}/g, telestrokeNote.recommendationsText || '');
            // Strip TNK narrative block if TNK was not recommended (prevents false clinical statements)
            if (!telestrokeNote.tnkRecommended) {
              note = note.replace(/After ensuring that there were no evident contraindications.*?brief time-out\.\n?/s, '');
              note = note.replace(/BP prior to TNK administration:.*?\n/g, '');
            }
            // Add anticoagulation details into clinical body (before placeholder cleanup)
            if (telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]) {
              const acInfo = ANTICOAGULANT_INFO[telestrokeNote.lastDOACType];
              let acLine = `\nAnticoagulation: ${acInfo.name}`;
              if (telestrokeNote.lastDOACDose) {
                const cnDoseDate = new Date(telestrokeNote.lastDOACDose);
                if (!Number.isNaN(cnDoseDate.getTime())) acLine += ` (last dose: ${cnDoseDate.toLocaleString()})`;
              }
              note += acLine + '\n';
            }

            // Add allergies if not already in template body
            if (telestrokeNote.allergies || telestrokeNote.contrastAllergy) {
              let allergyLine = '\nAllergies: ';
              if (telestrokeNote.allergies) allergyLine += telestrokeNote.allergies;
              if (telestrokeNote.contrastAllergy) allergyLine += (telestrokeNote.allergies ? ' ' : '') + '**CONTRAST ALLERGY**';
              note += allergyLine + '\n';
            }

            // Replace unreplaced template placeholders with visible markers for clinical safety
            note = note.replace(/\{([a-zA-Z0-9_]+)\}/g, '[___]');

            // Add consultation type header
            const consultLabel = consultationType === 'telephone' ? 'TELEPHONE CONSULTATION NOTE' : 'TELESTROKE VIDEO CONSULTATION NOTE';
            note = `${consultLabel}\n${'='.repeat(40)}\n\n${note}`;

            // Add consultation metadata footer
            const metadataLines = [];
            if (telestrokeNote.callingSite) metadataLines.push(`Site: ${telestrokeNote.callingSite}${telestrokeNote.callingSiteOther ? ` (${telestrokeNote.callingSiteOther})` : ''}`);
            if (telestrokeNote.callerName) metadataLines.push(`Caller: ${telestrokeNote.callerName}${telestrokeNote.callerRole ? ` (${telestrokeNote.callerRole})` : ''}`);
            if (telestrokeNote.attendingPhysician) metadataLines.push(`Attending: ${telestrokeNote.attendingPhysician}`);
            if (telestrokeNote.consultStartTime) metadataLines.push(`Consult Time: ${telestrokeNote.consultStartTime}`);
            if (metadataLines.length > 0) {
              note += `\n${metadataLines.join('\n')}\n`;
            }

            // Add BP target for continuity
            const consultBp = bpPhaseTargets[telestrokeNote.bpPhase];
            if (consultBp) {
              note += `\nBP target: <${consultBp.systolic}/${consultBp.diastolic} (${consultBp.label})\n`;
            }

            // Add DTN metrics if TNK was administered
            if (telestrokeNote.dtnTnkAdministered && telestrokeNote.tnkRecommended) {
              note += formatDTNForNote();
            } else if (telestrokeNote.tnkRecommended && telestrokeNote.doorTime && telestrokeNote.needleTime) {
              const [cnDH, cnDM] = telestrokeNote.doorTime.split(':').map(Number);
              const [cnNH, cnNM] = telestrokeNote.needleTime.split(':').map(Number);
              if (!isNaN(cnDH) && !isNaN(cnDM) && !isNaN(cnNH) && !isNaN(cnNM)) {
                let cnDtn = (cnNH * 60 + cnNM) - (cnDH * 60 + cnDM);
                if (cnDtn < 0) cnDtn += 1440;
                note += `\nDoor-to-Needle: ${cnDtn} min (Door: ${telestrokeNote.doorTime}, Needle: ${telestrokeNote.needleTime})\n`;
              }
            }

            // Add contraindication review status if reviewed
            if (telestrokeNote.tnkContraindicationReviewed) {
              note += `\nThrombolysis Contraindication Review: Completed at ${telestrokeNote.tnkContraindicationReviewTime}. `;
              const checklist = telestrokeNote.tnkContraindicationChecklist || {};
              const absoluteKeys = [
                'currentICH',
                'largeInfarct',
                'intracranialTumor',
                'aorticDissection',
                'activeInternalBleeding',
                'giMalignancy',
                'sahPresentation',
                'infectiveEndocarditis',
                'severeUncontrolledHTN',
                'lowPlatelets',
                'warfarinElevatedINR',
                'recentHeparin',
                'unrupturedAneurysm10mm'
              ];
              const relativeKeys = [
                'recentStroke',
                'recentHeadTrauma',
                'recentIntracranialSurgery',
                'recentMajorSurgery',
                'recentGIGUBleeding',
                'recentArterialPuncture',
                'recentLumbarPuncture',
                'pregnancy',
                'seizureAtOnset',
                'lowGlucose',
                'highGlucose',
                'recentDOAC',
                'extensiveHypoattenuation',
                'intracranialAneurysm',
                'vascularMalformation',
                'priorICH',
                'lecanemab',
                'cerebralMicrobleeds',
                'abnormalCoagUnknown',
                'severeRenalFailure',
                'knownBleedingDiathesis',
                'recentMI',
                'acutePericarditis',
                'elevatedAPTT'
              ];
              const absoluteChecked = absoluteKeys.filter(k => checklist[k]);
              const relativeChecked = relativeKeys.filter(k => checklist[k]);
              if (absoluteChecked.length === 0 && relativeChecked.length === 0) {
                note += 'No absolute or relative contraindications identified.';
              } else if (absoluteChecked.length > 0) {
                note += `Absolute contraindication(s) identified: ${absoluteChecked.length}. TNK contraindicated.`;
              } else if (relativeChecked.length > 0) {
                note += `${relativeChecked.length} relative contraindication(s) identified. Clinical judgment applied.`;
              }
              note += '\n';
            }

            // Add EVT consent documentation
            if (telestrokeNote.evtRecommended && (telestrokeNote.consentKit || {}).evtConsentDiscussed) {
              note += `\nEVT Consent: Risks and benefits of mechanical thrombectomy discussed with patient/family.\n`;
              const evtType = (telestrokeNote.consentKit || {}).evtConsentType;
              if (evtType === 'informed-consent') note += '- Informed consent obtained.\n';
              else if (evtType === 'presumed') note += '- Presumed consent — patient unable, no surrogate available.\n';
              else if (evtType === 'surrogate') note += '- Surrogate/family consent obtained.\n';
              else if (evtType === 'declined') note += '- Patient/family declined after informed discussion.\n';
              // Supporting clinical data for EVT decision
              if (telestrokeNote.lkwUnknown) {
                note += `- LKW: Unknown (wake-up/unwitnessed)`;
                if (telestrokeNote.discoveryTime) note += ` — discovery ${telestrokeNote.discoveryTime}`;
                note += '\n';
              } else if (telestrokeNote.lkwTime) {
                note += `- LKW: ${formatTime(telestrokeNote.lkwTime)}\n`;
              }
              if (aspectsScore != null) note += `- ASPECTS: ${aspectsScore}/10\n`;
              const evtCtp = telestrokeNote.ctpStructured || {};
              if (evtCtp.coreVolume) {
                let ctpLine = `- CTP: Core ${evtCtp.coreVolume} mL`;
                if (evtCtp.penumbraVolume) ctpLine += `, Penumbra ${evtCtp.penumbraVolume} mL`;
                if (evtCtp.coreVolume && evtCtp.penumbraVolume) {
                  const c = parseFloat(evtCtp.coreVolume), p = parseFloat(evtCtp.penumbraVolume);
                  if (!isNaN(c) && !isNaN(p) && c > 0) { const r = p/c; ctpLine += `, Ratio ${isFinite(r) && r < 1000 ? r.toFixed(1) : '>999'}`; }
                }
                note += ctpLine + '\n';
              }
              const evtVessels = (telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None');
              if (evtVessels.length > 0) note += `- Vessel occlusion: ${evtVessels.join(', ')}\n`;
              if (telestrokeNote.collateralGrade) note += `- Collaterals: ${telestrokeNote.collateralGrade}\n`;
              if (telestrokeNote.lastDOACType && telestrokeNote.lastDOACType !== 'none') {
                note += `- Anticoagulation: ${ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]?.name || telestrokeNote.lastDOACType}\n`;
              }
              if (telestrokeNote.premorbidMRS != null) note += `- Pre-morbid mRS: ${telestrokeNote.premorbidMRS}\n`;
              if (telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime) note += `- TNK pre-treatment: administered at ${formatTime(telestrokeNote.tnkAdminTime)}\n`;
            }

            // Add TOAST classification and workup plan
            if (telestrokeNote.toastClassification) {

              note += `\nEtiologic Classification (TOAST): ${TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification}\n`;
            }

            // Wake-up stroke workflow documentation
            const wus = telestrokeNote.wakeUpStrokeWorkflow || {};
            if (wus.isWakeUpStroke) {
              note += `\nWAKE-UP STROKE EVALUATION:\n`;
              note += `- MRI available: ${wus.mriAvailable ? 'Yes' : wus.mriAvailable === false ? 'No (CTP pathway)' : 'Not assessed'}\n`;
              if (wus.mriAvailable) {
                const cwDwi = wus.dwi || {};
                const cwFlair = wus.flair || {};
                if (cwDwi.positiveForLesion) note += `- DWI: Positive lesion${cwDwi.lesionVolume ? ` (volume: ${cwDwi.lesionVolume} mL)` : ''}\n`;
                if (cwFlair.noMarkedHyperintensity) note += `- FLAIR: No marked hyperintensity (DWI-FLAIR mismatch — favorable)\n`;
                if (wus.ageEligible) note += `- Age: Eligible (18-80)\n`;
                if (wus.nihssEligible) note += `- NIHSS: ≤25\n`;
                if (cwDwi.positiveForLesion && cwFlair.noMarkedHyperintensity && wus.ageEligible && wus.nihssEligible) {
                  note += `- *** MEETS WAKE-UP TRIAL CRITERIA — Consider IV thrombolysis ***\n`;
                }
              }
              if (wus.mriAvailable === false) {
                const ext = wus.extendCriteria || {};
                const extMet = [];
                if (ext.nihss4to26) extMet.push('NIHSS 4-26');
                if (ext.premorbidMRSLt2) extMet.push('pre-mRS <2');
                if (ext.ischemicCoreLte70) extMet.push('core ≤70cc');
                if (ext.mismatchRatioGte1_2) extMet.push('mismatch ≥1.2');
                if (ext.timeWindow4_5to9h) extMet.push('4.5-9h window');
                if (extMet.length > 0) note += `- EXTEND criteria: ${extMet.join(', ')}\n`;
                if (extMet.length === 5) note += `- *** MEETS EXTEND CRITERIA — Consider IV thrombolysis ***\n`;
              }
            }

            // Treatment rationale
            if (telestrokeNote.rationale) {
              note += `\nClinical Rationale: ${telestrokeNote.rationale}\n`;
            }

            // Disabling deficit documentation
            if (telestrokeNote.disablingDeficit) {
              note += `\nDisabling deficit: Yes — thrombolysis pursued despite low NIHSS based on clinical assessment of disabling deficit.\n`;
            }

            // Affected side
            if (telestrokeNote.affectedSide) {
              note += `Laterality: ${telestrokeNote.affectedSide}-sided deficits\n`;
            }

            // Add etiology workup status
            const ew = telestrokeNote.etiologyWorkup || {};
            if (ew.completedTests && Object.keys(ew.completedTests).length > 0) {
              const completed = Object.entries(ew.completedTests).filter(([k, v]) => v).map(([k]) => k.replace(/([A-Z])/g, ' $1').trim());
              const pending = Object.entries(ew.completedTests).filter(([k, v]) => !v).map(([k]) => k.replace(/([A-Z])/g, ' $1').trim());
              if (completed.length > 0) note += `Workup completed: ${completed.join(', ')}\n`;
              if (pending.length > 0) note += `Workup pending: ${pending.join(', ')}\n`;
            }

            // Add TNK consent documentation
            if (telestrokeNote.tnkRecommended && telestrokeNote.tnkConsentDiscussed) {
              note += `\nTNK Consent: Risks and benefits of IV thrombolysis (including ~4% risk of sICH) discussed`;
              if (telestrokeNote.tnkConsentWith) note += ` with ${telestrokeNote.tnkConsentWith}`;
              if (telestrokeNote.tnkConsentTime) note += ` at ${telestrokeNote.tnkConsentTime}`;
              note += '. ';
              const ct = telestrokeNote.tnkConsentType;
              if (ct === 'informed') note += 'Informed consent obtained. ';
              else if (ct === 'surrogate') note += 'Surrogate/family consent obtained. ';
              else if (ct === 'presumed') note += 'Presumed consent — patient unable to consent, no surrogate available. ';
              else if (ct === 'declined') note += 'Patient/family declined after informed discussion. ';
              if (telestrokeNote.preTNKSafetyPause) note += 'Pre-TNK safety pause completed. ';
              note += '\n';
            }

            // Add thrombolysis contraindication review to note
            if (telestrokeNote.tnkRecommended && telestrokeNote.tnkContraindicationReviewed) {
              note += `\nTHROMBOLYSIS CONTRAINDICATION REVIEW:\n`;
              const noteInr = telestrokeNote.inr;
              const notePlt = telestrokeNote.plateletCount;
              const notePtt = telestrokeNote.ptt;
              const noteGluc = telestrokeNote.glucose;
              const inrOk = !noteInr || parseFloat(noteInr) <= 1.7;
              const pltOk = !notePlt || parseFloat(notePlt) >= 100;
              const apttOk = !notePtt || parseFloat(notePtt) <= 40;
              const glucOk = !noteGluc || parseFloat(noteGluc) >= 50;
              note += `- INR: ${noteInr || 'N/A'} (threshold ≤1.7) [${noteInr ? (inrOk ? 'CLEARED' : 'NOT CLEARED') : 'pending'}]\n`;
              note += `- Platelets: ${notePlt || 'N/A'}K (threshold ≥100K) [${notePlt ? (pltOk ? 'CLEARED' : 'NOT CLEARED') : 'pending'}]\n`;
              note += `- aPTT: ${notePtt || 'N/A'}s (threshold ≤40s) [${notePtt ? (apttOk ? 'CLEARED' : 'NOT CLEARED') : 'pending'}]\n`;
              note += `- Glucose: ${noteGluc || 'N/A'} mg/dL (threshold ≥50) [${noteGluc ? (glucOk ? 'CLEARED' : 'NOT CLEARED') : 'pending'}]\n`;
              note += `- BP pre-treatment: ${telestrokeNote.bpPreTNK || telestrokeNote.presentingBP || 'N/A'} (threshold <185/110)\n`;
              note += `- Anticoagulant: ${telestrokeNote.lastDOACType ? ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]?.name || telestrokeNote.lastDOACType : 'None reported'}\n`;
            }

            // Add vessel occlusion details
            const consultVessels = (telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None');
            if (consultVessels.length > 0) {
              note += `\nVessel Occlusion: ${consultVessels.join(', ')}\n`;
            }

            // Add ICH-specific details
            if (telestrokeNote.diagnosisCategory === 'ich') {
              let ichNote = '\nICH Management:\n';
              {
                const ichCalc = telestrokeNote.ichVolumeCalc || {};
                const ichVol = calculateICHVolume(ichCalc);
                if (ichVol && ichVol.volume) ichNote += `- ICH volume (ABC/2): ${ichVol.volume} mL${ichVol.isLarge ? ' (LARGE)' : ''}\n`;
              }
              if (telestrokeNote.ichBPManaged) ichNote += '- BP managed (target SBP <140 (Class IIa; avoid <130))\n';
              if (telestrokeNote.ichReversalInitiated) ichNote += '- Anticoagulation reversal initiated\n';
              if (telestrokeNote.ichNeurosurgeryConsulted) ichNote += '- Neurosurgery consulted\n';
              if (telestrokeNote.ichSeizureProphylaxis) ichNote += '- Seizure prophylaxis ordered\n';
              if (ichNote !== '\nICH Management:\n') note += ichNote;
            }

            // Add SAH-specific details
            if (telestrokeNote.diagnosisCategory === 'sah') {
              let sahNote = '\nSAH Management:\n';
              if (telestrokeNote.sahGrade) sahNote += `- ${{'huntHess': 'Hunt & Hess Grade', 'wfns': 'WFNS Grade'}[telestrokeNote.sahGradeScale] || 'SAH Grade'}: ${telestrokeNote.sahGrade}\n`;
              if (telestrokeNote.fisherGrade) sahNote += `- Modified Fisher Grade: ${telestrokeNote.fisherGrade}\n`;
              if (telestrokeNote.sahBPManaged) sahNote += `- BP managed (SBP <160 pre-securing)\n`;
              if (telestrokeNote.sahNimodipine) sahNote += `- Nimodipine 60 mg q4h started\n`;
              if (telestrokeNote.sahAneurysmSecured) sahNote += `- Aneurysm securing plan documented\n`;
              if (telestrokeNote.sahEVDPlaced) sahNote += `- EVD placed\n`;
              if (telestrokeNote.sahSeizureProphylaxis) sahNote += `- Seizure prophylaxis ordered\n`;
              if (telestrokeNote.sahAneurysmLocation) sahNote += `- Aneurysm: ${telestrokeNote.sahAneurysmLocation}${telestrokeNote.sahAneurysmSize ? `, ${telestrokeNote.sahAneurysmSize} mm` : ''}\n`;
              if (telestrokeNote.sahSecuringMethod) sahNote += `- Securing: ${telestrokeNote.sahSecuringMethod}\n`;
              const vmDc = telestrokeNote.sahVasospasmMonitoring || {};
              if (vmDc.dciSuspected) sahNote += `- DCI suspected during hospitalization\n`;
              if (vmDc.inducedHypertension) sahNote += `- Induced hypertension used for DCI rescue\n`;
              if (sahNote !== '\nSAH Management:\n') note += sahNote;
            }

            // Add post-thrombolysis complications
            if (telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime) {
              const complications = [];
              if (telestrokeNote.sichDetected) complications.push('symptomatic ICH');
              if (telestrokeNote.angioedemaDetected || telestrokeNote.angioedema?.detected) {
                const cnAe = telestrokeNote.angioedema || {};
                let cnAeStr = 'orolingual angioedema';
                if (cnAe.severity) cnAeStr += ` (${cnAe.severity})`;
                if (cnAe.aceInhibitorUse) cnAeStr += ' — ACEi use';
                if (cnAe.intubated) cnAeStr += ' — INTUBATED';
                else if (cnAe.resolved) cnAeStr += ' — resolved';
                complications.push(cnAeStr);
              }
              if (telestrokeNote.reperfusionHemorrhage) complications.push('reperfusion hemorrhage');
              if (telestrokeNote.clinicalDeterioration) complications.push('clinical deterioration');
              const cnHt = telestrokeNote.hemorrhagicTransformation || {};
              if (cnHt.detected) complications.push(`HT${cnHt.classification ? ` (${cnHt.classification}${cnHt.symptomatic ? ', symptomatic' : ''})` : ''}`);
              if (complications.length > 0) {
                note += `\nPost-Thrombolysis Complications: ${complications.join(', ')}`;
                if (cnHt.detected && cnHt.antithromboticHeld) note += '\nAntithrombotics held due to HT';
                if (telestrokeNote.complicationNotes) note += `\n${telestrokeNote.complicationNotes}`;
                note += '\n';
              } else {
                const monitored = [];
                if (telestrokeNote.postTnkNeuroChecksStarted) monitored.push('neuro checks');
                if (telestrokeNote.postTnkBpMonitoring) monitored.push('BP monitoring');
                if (telestrokeNote.postTnkAntiplateletHeld) monitored.push('antithrombotics held 24h');
                if (telestrokeNote.postTnkRepeatCTOrdered) monitored.push('repeat CT ordered');
                if (monitored.length > 0) note += `\nPost-TNK Monitoring: ${monitored.join(', ')}. No complications noted.\n`;
              }
            }

            // Non-TNK hemorrhagic transformation
            if (!(telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime)) {
              const cnHtNonTnk = telestrokeNote.hemorrhagicTransformation || {};
              if (cnHtNonTnk.detected) {
                note += `\nHemorrhagic Transformation: ${cnHtNonTnk.classification || 'unclassified'}${cnHtNonTnk.symptomatic ? ' (SYMPTOMATIC)' : ''}`;
                if (cnHtNonTnk.antithromboticHeld) note += ' — antithrombotics held';
                if (cnHtNonTnk.reimagingPlanned) note += ', repeat imaging planned';
                note += '\n';
              }
            }
            // Cardiac workup
            {
              const cnCw = telestrokeNote.cardiacWorkup || {};
              const cnCwParts = [];
              if (cnCw.ecgComplete) cnCwParts.push('ECG completed');
              if (cnCw.telemetryOrdered) cnCwParts.push('telemetry ordered');
              if (cnCw.echoOrdered) cnCwParts.push('echo ordered');
              if (cnCw.extendedMonitoringType) cnCwParts.push(`extended monitoring: ${cnCw.extendedMonitoringType}`);
              if (cnCw.pfoEvaluation) cnCwParts.push(`PFO: ${cnCw.pfoEvaluation.replace(/-/g, ' ')}${cnCw.pascalClassification ? ` (PASCAL: ${cnCw.pascalClassification})` : ''}`);
              if (cnCwParts.length > 0) note += `\nCardiac Workup: ${cnCwParts.join(', ')}\n`;
            }
            // Decompressive craniectomy
            {
              const cnDc = telestrokeNote.decompressiveCraniectomy || {};
              if (cnDc.considered) {
                note += `\nDecompressive Craniectomy: under consideration`;
                if (cnDc.territorySize) note += ` — territory: ${cnDc.territorySize}`;
                if (cnDc.timing) note += `, window: ${cnDc.timing}`;
                note += '\n';
              }
            }

            // CVT management
            if (telestrokeNote.diagnosisCategory === 'cvt') {
              let cnCvt = '\nCVT Management:\n';
              if (telestrokeNote.cvtAnticoagStarted) cnCvt += `- Anticoagulation initiated (${telestrokeNote.cvtAnticoagType || 'agent selected'})\n`;
              if (telestrokeNote.cvtIcpManaged) cnCvt += `- ICP management addressed\n`;
              if (telestrokeNote.cvtSeizureManaged) cnCvt += `- Seizure management addressed\n`;
              if (telestrokeNote.cvtHematologyConsulted) cnCvt += `- Hematology consulted for thrombophilia workup\n`;
              const cnCvtAc = telestrokeNote.cvtAnticoag || {};
              if (cnCvtAc.acutePhase) cnCvt += `- Acute phase: ${cnCvtAc.acutePhase.replace(/-/g, ' ')}\n`;
              if (cnCvtAc.transitionAgent) cnCvt += `- Transition agent: ${cnCvtAc.transitionAgent}\n`;
              if (cnCvtAc.duration) cnCvt += `- Duration: ${cnCvtAc.duration}\n`;
              if (cnCvtAc.apsStatus) cnCvt += `- APS confirmed — warfarin mandatory\n`;
              if (cnCvt !== '\nCVT Management:\n') note += cnCvt;
            }
            // TIA workup
            {
              const cnTiaW = telestrokeNote.tiaWorkup || {};
              const cnTiaItems = [];
              if (cnTiaW.mriDwi) cnTiaItems.push('MRI DWI');
              if (cnTiaW.ctaHeadNeck) cnTiaItems.push('CTA Head/Neck');
              if (cnTiaW.ecg12Lead) cnTiaItems.push('12-lead ECG');
              if (cnTiaW.telemetry) cnTiaItems.push('telemetry');
              if (cnTiaW.echo) cnTiaItems.push('echo');
              if (cnTiaW.labsCbc) cnTiaItems.push('CBC');
              if (cnTiaW.labsBmp) cnTiaItems.push('BMP');
              if (cnTiaW.labsA1c) cnTiaItems.push('HbA1c');
              if (cnTiaW.labsLipids) cnTiaItems.push('lipid panel');
              if (cnTiaW.labsTsh) cnTiaItems.push('TSH');
              if (cnTiaItems.length > 0) {
                note += `\nTIA Workup:\n`;
                note += `- Completed: ${cnTiaItems.join(', ')}\n`;
                note += `- ${cnTiaItems.length}/${Object.keys(cnTiaW).length} items completed\n`;
              }
            }
            // Dissection pathway
            {
              const cnDiss = telestrokeNote.dissectionPathway || {};
              if (cnDiss.antithromboticType || cnDiss.imagingFollowUp) {
                note += `\nDissection Management:\n`;
                if (cnDiss.antithromboticType) note += `- Antithrombotic: ${cnDiss.antithromboticType.replace(/-/g, ' ')}\n`;
                if (cnDiss.imagingFollowUp) note += `- Vascular imaging follow-up: ${cnDiss.imagingFollowUp}\n`;
                note += `- Cervical manipulation avoidance counseled\n`;
              }
            }
            // Carotid management
            {
              const cnCarotid = telestrokeNote.carotidManagement || {};
              if (cnCarotid.stenosisDegree) {
                note += `\nCarotid: ${cnCarotid.stenosisSide || ''} ${cnCarotid.stenosisDegree}% stenosis${cnCarotid.symptomatic ? ' (symptomatic)' : ' (asymptomatic)'}\n`;
                if (cnCarotid.intervention) note += `- Plan: ${cnCarotid.intervention.replace(/-/g, ' ')}\n`;
              }
            }
            // ESUS/Cryptogenic workup
            {
              const cnEsus = telestrokeNote.esusWorkup || {};
              if (cnEsus.cardiacMonitoringType || cnEsus.teePerformed || cnEsus.hypercoagWorkup) {
                note += `\nESUS/Cryptogenic Workup:\n`;
                if (cnEsus.cardiacMonitoringType) note += `- Cardiac monitoring: ${cnEsus.cardiacMonitoringType.replace(/-/g, ' ')}\n`;
                if (cnEsus.teePerformed) note += `- TEE: performed${cnEsus.teeFindings ? ` — ${cnEsus.teeFindings}` : ''}\n`;
                if (cnEsus.afDetected) note += `- AF DETECTED on monitoring\n`;
                if (cnEsus.hypercoagWorkup) note += `- Hypercoagulable workup ordered\n`;
                if (cnEsus.esusAntiplatelet) note += `- Antithrombotic: ${cnEsus.esusAntiplatelet.replace(/-/g, ' ')}\n`;
              }
            }
            // ICH anticoagulation resumption
            {
              const cnIchAc = telestrokeNote.ichAnticoagResumption || {};
              if (cnIchAc.decision) {
                note += `\nICH Anticoag Resumption:\n`;
                if (cnIchAc.ichLocation) note += `- Location: ${cnIchAc.ichLocation}\n`;
                if (cnIchAc.caaFeatures) note += `- CAA features present\n`;
                if (cnIchAc.chadsVascScore) note += `- CHA2DS2-VASc: ${cnIchAc.chadsVascScore}\n`;
                if (cnIchAc.hasbledScore) note += `- HAS-BLED: ${cnIchAc.hasbledScore}\n`;
                note += `- Decision: ${cnIchAc.decision.replace(/-/g, ' ')}\n`;
                if (cnIchAc.rationale) note += `- Rationale: ${cnIchAc.rationale}\n`;
                if (cnIchAc.laaoConsidered) note += `- LAAO evaluation considered\n`;
              }
            }

            // Add secondary prevention summary
            const sp = telestrokeNote.secondaryPrevention || {};
            const spItems = [];
            if (sp.antiplateletRegimen) {
              let apLine = `Antithrombotic: ${AP_LABELS[sp.antiplateletRegimen] || sp.antiplateletRegimen}`;
              if (sp.daptDuration) apLine += ` (${sp.daptDuration})`;
              if (sp.cyp2c19Tested && sp.cyp2c19Result) {
                const cypLabels = { 'normal-metabolizer': 'Normal', 'intermediate': 'Intermediate', 'poor-metabolizer': 'Poor (LOF)', 'rapid-metabolizer': 'Rapid/Ultra-rapid', 'pending': 'Pending' };
                apLine += ` — CYP2C19: ${cypLabels[sp.cyp2c19Result] || sp.cyp2c19Result}`;
              }
              spItems.push(apLine);
            }
            if (sp.statinDose) spItems.push(`Statin: ${sp.statinDose.replace(/-/g, ' ')}${sp.ezetimibeAdded ? ' + ezetimibe' : ''}${sp.pcsk9Added ? ' + PCSK9i' : ''}`);
            if (sp.bpTarget) spItems.push(`BP target: ${sp.bpTarget}${sp.bpMeds ? ` (${sp.bpMeds})` : ''}`);
            if (sp.diabetesManagement) spItems.push(`Diabetes: ${sp.diabetesManagement}`);
            if (sp.smokingStatus && sp.smokingStatus !== 'never') {
              let smokeLine = `Smoking: ${sp.smokingStatus}`;
              if (sp.smokingCessationRx) smokeLine += ` — ${sp.smokingCessationRx}`;
              spItems.push(smokeLine);
            }
            if (spItems.length > 0) {
              note += `\nSecondary Prevention:\n${spItems.map(i => `- ${i}`).join('\n')}\n`;
            }

            // DOAC timing protocol
            {
              const cnDoac = telestrokeNote.doacTiming || {};
              if (cnDoac.strokeSeverity || cnDoac.doacAgent) {
                const cnDoacParts = [];
                if (cnDoac.doacAgent) cnDoacParts.push(cnDoac.doacAgent.replace(/-/g, ' '));
                if (cnDoac.strokeSeverity) cnDoacParts.push(`severity ${cnDoac.strokeSeverity} → ${cnDoac.strokeSeverity === 'minor' ? 'start within 48h' : cnDoac.strokeSeverity === 'moderate' ? 'Day 3-5' : 'Day 6-14'}`);
                if (cnDoac.doacInitiationDay) cnDoacParts.push(`planned Day ${cnDoac.doacInitiationDay}`);
                if (cnDoac.hemorrhagicTransformation) cnDoacParts.push('HT — repeat imaging before initiation');
                note += `\nDOAC Timing: ${cnDoacParts.join('; ')}\n`;
              }
            }

            // Add drug interaction alerts
            const di = telestrokeNote.drugInteractions || {};
            const diItems = [];
            if (di.aedDoacInteraction) diItems.push(`AED-DOAC interaction: ${di.aedType} (enzyme-inducing — consider warfarin)`);
            if (di.statinInteraction) diItems.push(`Statin interaction: ${di.statinInteractionDrug} (dose adjustment needed)`);
            if (diItems.length > 0) {
              note += `\nDrug Interaction Alerts:\n${diItems.map(i => `- ${i}`).join('\n')}\n`;
            }

            // Special populations
            const consultSpecialPops = [];
            if (telestrokeNote.pregnancyStroke) consultSpecialPops.push('PREGNANCY — OB/GYN consultation recommended');
            if (telestrokeNote.activeCancer) consultSpecialPops.push('ACTIVE CANCER — oncology co-management');
            if (telestrokeNote.sickleCellDisease) consultSpecialPops.push('SICKLE CELL DISEASE — hematology co-management');
            if (telestrokeNote.infectiveEndocarditis) consultSpecialPops.push('INFECTIVE ENDOCARDITIS — TNK contraindicated, ID/cardiology co-management');
            if (consultSpecialPops.length > 0) {
              note += `\nSpecial Populations:\n${consultSpecialPops.map(s => `- ${s}`).join('\n')}\n`;
            }

            // Add disposition
            if (telestrokeNote.disposition || telestrokeNote.transferAccepted) {
              note += `\nDisposition: `;
              if (telestrokeNote.transferAccepted) {
                note += `Transfer to ${telestrokeNote.transferReceivingFacility || 'comprehensive stroke center'}`;
                if (telestrokeNote.transportMode) note += ` via ${telestrokeNote.transportMode}`;
                if (telestrokeNote.transportEta) note += ` (ETA: ${telestrokeNote.transportEta})`;
              } else {
                note += telestrokeNote.disposition || 'Pending';
              }
              note += '\n';
            }

            // VTE prophylaxis
            {
              const cnVte = telestrokeNote.vteProphylaxis || {};
              if (cnVte.ipc || cnVte.ipcApplied || cnVte.pharmacologic || cnVte.pharmacoProphylaxis) {
                const cnVteItems = [];
                if (cnVte.ipc || cnVte.ipcApplied) cnVteItems.push('IPC/SCDs in place');
                if (cnVte.pharmacologic || cnVte.pharmacoProphylaxis) cnVteItems.push(`pharmacologic: ${cnVte.pharmacologicAgent || cnVte.pharmacoProphylaxis || 'ordered'}`);
                note += `\nVTE Prophylaxis: ${cnVteItems.join(', ')}\n`;
              }
            }
            // Rehab referrals
            {
              const cnRr = telestrokeNote.rehabReferral || {};
              const cnRrItems = [];
              if (cnRr.pt) cnRrItems.push('PT');
              if (cnRr.ot) cnRrItems.push('OT');
              if (cnRr.slp) cnRrItems.push('SLP');
              if (cnRr.neuropsych) cnRrItems.push('neuropsych');
              if (cnRr.socialWork) cnRrItems.push('social work');
              if (cnRr.vocationalRehab) cnRrItems.push('vocational rehab');
              if (cnRrItems.length > 0) note += `Rehab Referrals: ${cnRrItems.join(', ')}\n`;
            }

            // Add discharge checklist summary
            const dc = telestrokeNote.dischargeChecklist || {};
            const dcItems = [];
            if (dc.followUpNeurology) dcItems.push(`Neurology follow-up${dc.followUpNeurologyTimeframe ? ` (${dc.followUpNeurologyTimeframe})` : ''}`);
            if (dc.followUpPCP) dcItems.push(`PCP follow-up${dc.followUpPCPTimeframe ? ` (${dc.followUpPCPTimeframe})` : ''}`);
            if (dc.followUpCardiology) dcItems.push('Cardiology follow-up');
            if (dc.imagingFollowUp) dcItems.push(`Imaging follow-up: ${dc.imagingFollowUp}`);
            if (dc.rehabilitationOrdered) dcItems.push(`Rehabilitation: ${dc.rehabilitationType || 'ordered'}`);
            if (dc.swallowScreened) dcItems.push(`Swallow screen: ${dc.swallowScreenResult || 'completed'}`);
            if (dc.dvtProphylaxis) dcItems.push(`DVT prophylaxis: ${dc.dvtProphylaxisType || 'initiated'}`);
            if (dc.repeatCT24h) dcItems.push('Repeat CT at 24h ordered');
            if (dc.mriOrdered) dcItems.push('MRI ordered');
            if (dc.patientEducation) dcItems.push('Patient/family education provided');
            if (dc.drivingRestrictions) dcItems.push('Driving restrictions counseled');
            if (dcItems.length > 0) {
              note += `\nDischarge Planning:\n${dcItems.map(i => `- ${i}`).join('\n')}\n`;
            }

            return note;
            } catch (err) {
              console.error('Error generating note:', err);
              return `[Error generating note: ${err.message}. Please try again or report this issue.]`;
            }
          };
          generateNoteRef.current = generateTelestrokeNote;
          copyToClipboardRef.current = copyToClipboard;

          const buildSmartNote = () => {
            const age = telestrokeNote.age || 'Unknown age';
            const sexRaw = telestrokeNote.sex;
            const sex = sexRaw === 'M' ? 'male' : sexRaw === 'F' ? 'female' : 'patient';
            const pmh = telestrokeNote.pmh || 'no significant PMH documented';
            const symptoms = telestrokeNote.symptoms || 'acute neurologic symptoms';
            const lkw = telestrokeNote.lkwDate && telestrokeNote.lkwTime
              ? `${telestrokeNote.lkwDate} ${telestrokeNote.lkwTime}`
              : 'unknown';
            const nihss = telestrokeNote.nihss || nihssScore || 'unknown';
            const ct = telestrokeNote.ctResults || 'CT pending';
            const cta = telestrokeNote.ctaResults || 'CTA pending';
            const inr = telestrokeNote.inr || '';
            const vessels = telestrokeNote.vesselOcclusion || [];
            const dx = telestrokeNote.diagnosisCategory || '';

            const sentences = [];
            if (telestrokeNote.callingSite) sentences.push(`[${telestrokeNote.callingSite}]`);
            sentences.push(`${age}-year-old ${sex} with ${pmh} presenting with ${symptoms}.`);
            sentences.push(`Last known well: ${lkw}. NIHSS ${nihss}.`);

            // Imaging with vessel occlusion
            let imagingLine = `Imaging: CT ${ct}. CTA ${cta}.`;
            if (vessels.length > 0 && !vessels.includes('None')) {
              imagingLine += ` Vessel occlusion: ${vessels.join(', ')}.`;
            }
            if (aspectsScore != null && aspectsScore < 10) {
              imagingLine += ` ASPECTS ${aspectsScore}/10.`;
            }
            sentences.push(imagingLine);

            // Diagnosis and TOAST
            if (dx === 'ich') {
              sentences.push('Diagnosis: Intracerebral hemorrhage.');
              const ichActions = [];
              if (telestrokeNote.ichBPManaged) ichActions.push('BP management initiated (target SBP <140 (Class IIa; avoid <130))');
              if (telestrokeNote.ichReversalInitiated) ichActions.push('anticoagulation reversal initiated');
              if (telestrokeNote.ichNeurosurgeryConsulted) ichActions.push('neurosurgery consulted');
              if (telestrokeNote.ichSeizureProphylaxis) ichActions.push('seizure prophylaxis ordered');
              if (ichActions.length > 0) {
                sentences.push(`ICH management: ${ichActions.join(', ')}.`);
              }
            } else {
              if (telestrokeNote.tnkRecommended) {
                const tnkTime = telestrokeNote.tnkAdminTime ? ` at ${telestrokeNote.tnkAdminTime}` : '';
                const tnkDoseInfo = telestrokeNote.weight ? calculateTNKDose(telestrokeNote.weight) : null;
                const doseStr = tnkDoseInfo ? ` (${tnkDoseInfo.calculatedDose} mg)` : '';
                sentences.push(`TNK recommended${doseStr}${tnkTime}.`);
              } else if (telestrokeNote.tnkAutoBlocked) {
                sentences.push(`TNK contraindicated: ${telestrokeNote.tnkAutoBlockReason || 'contraindication detected'}.`);
              } else {
                sentences.push('TNK not recommended based on current eligibility criteria.');
              }

              if (telestrokeNote.evtRecommended) {
                sentences.push('EVT recommended; transfer/activation initiated.');
              } else if (vessels.some(v => /ICA|M1|Basilar/i.test(v))) {
                sentences.push('LVO identified; EVT evaluation recommended.');
              }

              if (telestrokeNote.toastClassification) {
  
                sentences.push(`TOAST: ${TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification}.`);
              }
            }

            if (telestrokeNote.rationale) {
              sentences.push(`Rationale: ${telestrokeNote.rationale}.`);
            }

            // Secondary prevention
            const sp = telestrokeNote.secondaryPrevention || {};
            const spParts = [];
            if (sp.antiplateletRegimen) {
              let apText = AP_LABELS_SHORT[sp.antiplateletRegimen] || sp.antiplateletRegimen;
              if (sp.cyp2c19Result === 'poor-metabolizer') apText += ' (CYP2C19 LOF — consider ticagrelor)';
              spParts.push(apText);
            }
            if (sp.statinDose) spParts.push(`${sp.statinDose.replace(/-/g, ' ')} statin`);
            if (sp.bpTarget) spParts.push(`BP target ${sp.bpTarget}`);
            if (spParts.length > 0) {
              sentences.push(`Secondary prevention: ${spParts.join(', ')}.`);
            }

            // Disposition
            if (telestrokeNote.disposition) {
              sentences.push(`Disposition: ${telestrokeNote.disposition}.`);
            } else if (telestrokeNote.transferAccepted) {
              let dispo = `Transfer to ${telestrokeNote.transferReceivingFacility || 'comprehensive stroke center'}`;
              if (telestrokeNote.transportMode) dispo += ` via ${telestrokeNote.transportMode}`;
              sentences.push(`${dispo}.`);
            }

            return sentences.filter(Boolean).join(' ');
          };

          // Time calculation functions
          const getDiscoveryDateTime = () => {
            if (!telestrokeNote.discoveryDate || !telestrokeNote.discoveryTime) return null;
            const [year, month, day] = telestrokeNote.discoveryDate.split('-').map(Number);
            const [hours, minutes] = telestrokeNote.discoveryTime.split(':').map(Number);
            if (!year || !month || !day || Number.isNaN(hours) || Number.isNaN(minutes)) return null;
            return new Date(year, month - 1, day, hours, minutes);
          };

          const getReferenceTime = () => {
            if (telestrokeNote.lkwUnknown) {
              const discovery = getDiscoveryDateTime();
              if (!discovery) return null;
              return { time: discovery, label: 'Discovery' };
            }
            if (!lkwTime) return null;
            return { time: lkwTime, label: 'LKW' };
          };

          const calculateTimeFromLKW = () => {
            const reference = getReferenceTime();
            if (!reference) return null;
            const diffMs = currentTime - reference.time;
            if (diffMs < 0) {
              return { hours: 0, minutes: 0, total: 0, label: reference.label, futureWarning: true };
            }
            const diffHrs = diffMs / (1000 * 60 * 60);
            const diffMins = (diffMs / (1000 * 60)) % 60;
            return {
              hours: Math.floor(diffHrs),
              minutes: Math.floor(diffMins),
              total: diffHrs,
              label: reference.label
            };
          };

          const getWindowStatus = (timeFromLKW) => getWindowStatusFromTime(timeFromLKW);

          const getEvtEligibilityRecommendation = (inputs, timeFromLKW) => {
            const occlusion = inputs.occlusion;
            const aspects = inputs.aspects;
            const mrs = inputs.mrs;
            const nihss = parseInt(inputs.nihss, 10);
            const pcAspects = inputs.pcAspects;

            const resolveWindow = () => {
              if (inputs.timeWindow && inputs.timeWindow !== 'auto') return inputs.timeWindow;
              if (!timeFromLKW) return 'unknown';
              if (timeFromLKW.total <= 6) return '0-6';
              if (timeFromLKW.total <= 24) return '6-24';
              return '>24';
            };

            const window = resolveWindow();
            const result = { classOfRec: 'IDD', label: 'Insufficient data', color: 'slate', rationale: [] };

            if (window === 'unknown') {
              return { ...result, label: 'Set LKW or select time window', color: 'amber' };
            }

            if (occlusion === 'mvo-nondominant') {
              if (window === '0-6' || window === '6-24') {
                return { classOfRec: 'III (No benefit)', label: 'No EVT recommended', color: 'rose', rationale: ['Isolated non-dominant M2 or DVO'] };
              }
              return result;
            }

              if (occlusion === 'mvo-dominant') {
                if ((window === '0-6' || window === '6-24') && mrs === '0-1') {
                  return { classOfRec: 'IIb', label: 'EVT may be considered (select cases)', color: 'amber', rationale: ['Proximal/dominant M2 ≤1cm of bifurcation, salvageable tissue present, LKW ≤24h (local protocol)'] };
                }
                return result;
              }

            if (occlusion === 'basilar') {
              if ((window === '0-6' || window === '6-24') && pcAspects === '>=6') {
                if (mrs === '0-1' && !Number.isNaN(nihss)) {
                  if (nihss >= 10) {
                    return { classOfRec: 'I', label: 'EVT recommended', color: 'emerald', rationale: ['Basilar, PC-ASPECTS ≥6, NIHSS ≥10, mRS 0-1'] };
                  }
                  if (nihss >= 6) {
                    return { classOfRec: 'IIb', label: 'EVT may be considered', color: 'amber', rationale: ['Basilar, PC-ASPECTS ≥6, NIHSS 6-9, mRS 0-1'] };
                  }
                }
                if (mrs !== '0-1') {
                  return { classOfRec: 'IDD', label: 'Uncertain benefit', color: 'slate', rationale: ['mRS ≥2'] };
                }
              }
              return result;
            }

            if (occlusion === 'lvo') {
              if (window === '>24') return result;

              if (window === '0-6') {
                if (aspects === '6-10') {
                  if (mrs === '0-1') return { classOfRec: 'I', label: 'EVT recommended', color: 'emerald', rationale: ['ASPECTS 6-10, mRS 0-1'] };
                  if (mrs === '2') return { classOfRec: 'IIa', label: 'EVT reasonable', color: 'emerald', rationale: ['ASPECTS 6-10, pre-stroke mRS 2 (mild disability)'] };
                  if (mrs === '3-4') return { classOfRec: 'IIb', label: 'EVT may be considered', color: 'amber', rationale: ['ASPECTS 6-10, mRS 3-4'] };
                  return result;
                }
                if (aspects === '3-5') {
                  if (mrs === '0-1' && !isNaN(nihss) && nihss >= 6) return { classOfRec: 'I', label: 'EVT recommended', color: 'emerald', rationale: ['ASPECTS 3-5, mRS 0-1, NIHSS ≥6'] };
                  if (mrs === '0-1' && (isNaN(nihss) || nihss === 0)) return { classOfRec: 'IDD', label: 'Enter NIHSS to evaluate', color: 'amber', rationale: ['ASPECTS 3-5, mRS 0-1 — NIHSS ≥6 required for Class I recommendation'] };
                  if (mrs === '0-1' && nihss < 6) return { classOfRec: 'IIb', label: 'EVT may be considered', color: 'amber', rationale: ['ASPECTS 3-5, mRS 0-1, but NIHSS <6 — weaker evidence for large-core EVT with low NIHSS'] };
                  return result;
                }
                if (aspects === '0-2') {
                  if (mrs === '0-1') return { classOfRec: 'IIb', label: 'EVT may be considered (very select cases)', color: 'amber', rationale: ['ASPECTS 0-2, mRS 0-1 — consider CTP to evaluate if core ≤70-100cc (local protocol)'] };
                  return result;
                }
              }

              if (window === '6-24') {
                // Use encounter NIHSS for late-window check (DAWN requires ≥10, DEFUSE-3 requires ≥6)
                const lateNihss = !isNaN(nihss) && nihss > 0 ? nihss : parseInt(telestrokeNote.nihss || nihssScore, 10) || 0;
                if (aspects === '6-10' && mrs === '0-1') {
                  if (lateNihss >= 6) return { classOfRec: 'I', label: 'EVT recommended', color: 'emerald', rationale: [`ASPECTS 6-10, mRS 0-1, NIHSS ${lateNihss} ≥6 (DAWN/DEFUSE-3)`] };
                  if (lateNihss > 0 && lateNihss < 6) return { classOfRec: 'IIb', label: 'EVT may be considered (low NIHSS)', color: 'amber', rationale: [`Late window, ASPECTS 6-10, mRS 0-1, but NIHSS ${lateNihss} <6 — outside DAWN/DEFUSE-3 enrollment criteria`] };
                  return { classOfRec: 'IDD', label: 'Enter NIHSS', color: 'amber', rationale: ['ASPECTS 6-10, mRS 0-1 — NIHSS ≥6 required for late-window Class I (DAWN/DEFUSE-3)'] };
                }
                if (aspects === '3-5' && mrs === '0-1') {
                  return { classOfRec: 'I', label: 'EVT recommended', color: 'emerald', rationale: ['ASPECTS 3-5, mRS 0-1 — consider CTP: core ≤100cc + mismatch present (local protocol)'] };
                }
                if (aspects === '0-2') {
                  return { classOfRec: 'IDD', label: 'EVT benefit unclear', color: 'slate', rationale: ['ASPECTS 0-2 in late window — EVT benefit is unclear (local protocol)'] };
                }
                return result;
              }
            }

            return result;
          };

          const buildNursingFlowsheet = (baseTimeStr) => {
            if (!baseTimeStr) return [];
            const [hours, minutes] = baseTimeStr.split(':').map(Number);
            if (Number.isNaN(hours) || Number.isNaN(minutes)) return [];
            const baseMinutes = hours * 60 + minutes;
            const intervals = [
              { label: 'q15m', count: 4, step: 15 },
              { label: 'q30m', count: 4, step: 30 }
            ];
            const schedule = [];
            let offset = 0;
            intervals.forEach((block) => {
              for (let i = 0; i < block.count; i += 1) {
                offset += block.step;
                const totalMinutes = baseMinutes + offset;
                const hh = Math.floor((totalMinutes % 1440) / 60);
                const mm = totalMinutes % 60;
                schedule.push({
                  label: block.label,
                  time: `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')}`,
                  minutesFrom: offset
                });
              }
            });
            return schedule;
          };

          const CalculatorSync = () => {
            const patient = useGlobalPatient();
            useEffect(() => {
              if (!autoSyncCalculators || !patient) return;
              const age = parseInt(patient.age, 10);
              const isFemale = patient.sex === 'F';
              if (!Number.isNaN(age)) {
                setAbcd2Items(prev => (prev.age60 === (age >= 60) ? prev : { ...prev, age60: age >= 60 }));
                setIchScoreItems(prev => (prev.age80 === (age >= 80) ? prev : { ...prev, age80: age >= 80 }));
                setHasbledItems(prev => (prev.elderly === (age >= 65) ? prev : { ...prev, elderly: age >= 65 }));
                setChads2vascItems(prev => {
                  const age75 = age >= 75;
                  const age65 = age >= 65 && age < 75;
                  if (prev.age75 === age75 && prev.age65 === age65 && prev.female === isFemale) return prev;
                  return { ...prev, age75, age65, female: isFemale };
                });
                setRopeItems(prev => (prev.age === String(age) ? prev : { ...prev, age: String(age) }));
              }
              setRcvs2Items(prev => (prev.female === isFemale ? prev : { ...prev, female: isFemale }));
              // Sync standalone GCS → ICH Score GCS component
              const gcsTotal = calculateGCS(gcsItems);
              if (gcsTotal > 0) {
                const gcsCategory = gcsTotal <= 4 ? 'gcs34' : gcsTotal <= 12 ? 'gcs512' : '';
                setIchScoreItems(prev => (prev.gcs === gcsCategory ? prev : { ...prev, gcs: gcsCategory }));
              }

              // Sync calculator inputs from encounter once and keep them aligned
              setTelestrokeNote((prev) => {
                const incomingCrcl = {
                  age: patient.age || '',
                  weight: patient.weight || '',
                  sex: patient.sex || '',
                  cr: patient.creatinine || '',
                  height: patient.height || ''
                };
                const prevCrcl = prev.crclCalc || {};
                const mergedCrcl = { ...prevCrcl, ...incomingCrcl };

                const doacType = (prev.lastDOACType || '').toLowerCase();
                const andexType = doacType === 'apixaban' || doacType === 'rivaroxaban' ? doacType : (prev.andexanetCalc || {}).doacType || '';
                const prevAndex = prev.andexanetCalc || {};
                const mergedAndex = { ...prevAndex, doacType: andexType };

                const prevBridge = prev.anticoagBridging || {};
                const mergedBridge = {
                  ...prevBridge,
                  crCl: prevBridge.crCl || ''
                };

                const crclChanged = ['age', 'weight', 'sex', 'cr', 'height'].some((k) => String(prevCrcl[k] || '') !== String(mergedCrcl[k] || ''));
                const andexChanged = String(prevAndex.doacType || '') !== String(mergedAndex.doacType || '');

                if (!crclChanged && !andexChanged) return prev;
                return {
                  ...prev,
                  crclCalc: mergedCrcl,
                  andexanetCalc: mergedAndex,
                  anticoagBridging: mergedBridge
                };
              });
            }, [autoSyncCalculators, patient?.age, patient?.sex, patient?.weight, patient?.height, patient?.creatinine, gcsItems]);
            return null;
          };

          const CalculatorPatientSnapshot = () => {
            const patient = useGlobalPatient();
            if (!patient) return null;
            return (
              <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3 text-xs text-indigo-900 flex flex-wrap items-center gap-3">
                <span className="font-semibold">Patient snapshot</span>
                <span>Age: {patient.age || '--'}</span>
                <span>Sex: {patient.sex || '--'}</span>
                <span>Cr: {patient.creatinine || '--'}</span>
                <span>Dx: {patient.diagnosisCategory || patient.diagnosis || '--'}</span>
              </div>
            );
          };

          // =============================================
          // DATA CONSISTENCY SANITY CHECKS
          // =============================================
          const getSanityChecks = () => {
            const warnings = [];
            const n = telestrokeNote;

            // --- Out-of-range values ---
            const weight = parseFloat(n.weight);
            if (!isNaN(weight) && (weight < 20 || weight > 350)) {
              warnings.push({ id: 'weight-range', severity: 'error', msg: `Weight ${weight} kg is outside plausible range (20-350 kg)` });
            }
            const age = parseInt(n.age, 10);
            if (!isNaN(age) && (age < 0 || age > 120)) {
              warnings.push({ id: 'age-range', severity: 'error', msg: `Age ${age} is outside plausible range` });
            }
            const glucose = parseInt(n.glucose, 10);
            if (!isNaN(glucose) && (glucose < 10 || glucose > 1500)) {
              warnings.push({ id: 'glucose-range', severity: 'error', msg: `Glucose ${glucose} mg/dL is outside plausible range` });
            }
            const inr = parseFloat(n.inr);
            if (!isNaN(inr) && (inr < 0.5 || inr > 20)) {
              warnings.push({ id: 'inr-range', severity: 'warn', msg: `INR ${inr} is unusual — verify result` });
            }
            const platelets = parseInt(n.plateletCount, 10);
            if (platelets && platelets < 10) {
              warnings.push({ id: 'plt-low', severity: 'warn', msg: `Platelets ${platelets}K — critically low, verify result` });
            }
            const creatinine = parseFloat(n.creatinine);
            if (creatinine && creatinine > 15) {
              warnings.push({ id: 'cr-range', severity: 'warn', msg: `Creatinine ${creatinine} — unusually high, verify result` });
            }

            // Parse BP
            const bpStr = n.presentingBP || '';
            const bpMatch = bpStr.match(/(\d+)\s*\/\s*(\d+)/);
            if (bpMatch) {
              const sbp = parseInt(bpMatch[1], 10);
              const dbp = parseInt(bpMatch[2], 10);
              if (sbp < 50 || sbp > 300) warnings.push({ id: 'sbp-range', severity: 'error', msg: `SBP ${sbp} mmHg is outside plausible range` });
              if (dbp < 20 || dbp > 200) warnings.push({ id: 'dbp-range', severity: 'error', msg: `DBP ${dbp} mmHg is outside plausible range` });
              if (dbp >= sbp) warnings.push({ id: 'bp-inversion', severity: 'error', msg: `DBP (${dbp}) >= SBP (${sbp}) — check BP entry` });
            }

            // --- Time sequence checks ---
            const parseTs = (d, t) => {
              if (!d || !t) return null;
              const dt = new Date(`${d}T${t}`);
              return isNaN(dt.getTime()) ? null : dt;
            };
            const parseDT = (val) => val ? new Date(val) : null;

            const lkw = parseTs(n.lkwDate, n.lkwTime);
            const ctTime = parseTs(n.ctDate, n.ctTime);
            const ctaTime = parseTs(n.ctaDate, n.ctaTime);
            const arrival = parseDT(n.dtnEdArrival);
            const tnkTime = parseDT(n.tnkAdminTime);

            if (lkw && ctTime && ctTime < lkw) {
              warnings.push({ id: 'ct-before-lkw', severity: 'error', msg: 'CT time is before LKW — check timestamps' });
            }
            if (arrival && ctTime && ctTime < arrival) {
              warnings.push({ id: 'ct-before-arrival', severity: 'warn', msg: 'CT time is before arrival — verify if pre-transfer imaging' });
            }
            if (ctaTime && ctTime && ctaTime < ctTime) {
              warnings.push({ id: 'cta-before-ct', severity: 'warn', msg: 'CTA time is before CT time — verify imaging sequence' });
            }
            if (tnkTime && lkw) {
              const tnkHrs = (tnkTime - lkw) / (1000 * 60 * 60);
              if (tnkHrs > 4.5 && !(n.wakeUpStrokeWorkflow && n.wakeUpStrokeWorkflow.extendEligible)) {
                warnings.push({ id: 'tnk-outside-window', severity: 'error', msg: `TNK administered ${tnkHrs.toFixed(1)}h after LKW — outside standard 4.5h window (verify extended window eligibility)` });
              }
              if (tnkHrs < 0) {
                warnings.push({ id: 'tnk-before-lkw', severity: 'error', msg: 'TNK time is before LKW — check timestamps' });
              }
            }

            // --- Internal contradictions ---
            const hasLVO = (n.vesselOcclusion || []).some(v => /ICA|M1|basilar/i.test(v));
            if (n.tnkRecommended && n.diagnosisCategory === 'ich') {
              warnings.push({ id: 'tnk-ich', severity: 'error', msg: 'TNK recommended but diagnosis is ICH — thrombolysis is contraindicated in hemorrhagic stroke' });
            }
            if (n.tnkRecommended && n.diagnosisCategory === 'mimic') {
              warnings.push({ id: 'tnk-mimic', severity: 'error', msg: 'TNK recommended but diagnosis is stroke mimic — thrombolysis is contraindicated. Clear TNK recommendation.' });
            }
            if (n.evtRecommended && n.diagnosisCategory === 'mimic') {
              warnings.push({ id: 'evt-mimic', severity: 'error', msg: 'EVT recommended but diagnosis is stroke mimic — thrombectomy is not indicated. Clear EVT recommendation.' });
            }
            if (n.evtRecommended && !n.nihss && !nihssScore) {
              warnings.push({ id: 'evt-no-nihss', severity: 'error', msg: 'EVT recommended but NIHSS not documented — EVT eligibility requires NIHSS ≥6 per HERMES/MR CLEAN. Document NIHSS before transfer.' });
            }
            if (n.tnkRecommended && (!n.nihss || n.nihss === '')) {
              warnings.push({ id: 'tnk-no-nihss', severity: 'error', msg: 'TNK recommended but NIHSS not documented — all thrombolysis trials required NIHSS assessment. Enter NIHSS before proceeding.' });
            }
            if (n.tnkRecommended && parseInt(n.nihss, 10) === 0) {
              warnings.push({ id: 'tnk-nihss-zero', severity: 'error', msg: 'TNK recommended with NIHSS 0 — no neurological deficit documented. Verify clinical indication before proceeding.' });
            }
            // Basilar EVT: ATTENTION/BAOCHE required NIHSS ≥10
            {
              const hasBasilar = (n.vesselOcclusion || []).some(v => /basilar/i.test(v));
              const evtNihss = parseInt(n.nihss, 10) || nihssScore || 0;
              if (n.evtRecommended && hasBasilar && evtNihss > 0 && evtNihss < 10) {
                warnings.push({ id: 'basilar-evt-nihss', severity: 'error', msg: `EVT for basilar occlusion with NIHSS ${evtNihss} (<10) — ATTENTION/BAOCHE trials required NIHSS ≥10 for posterior circulation EVT eligibility. Do not proceed without confirming NIHSS ≥10.` });
              }
            }
            if (n.evtRecommended && !hasLVO && (n.vesselOcclusion || []).length === 0) {
              warnings.push({ id: 'evt-no-lvo', severity: 'warn', msg: 'EVT recommended but no vessel occlusion documented — verify CTA findings' });
            }
            if (hasLVO && !n.evtRecommended && n.diagnosisCategory === 'ischemic') {
              warnings.push({ id: 'lvo-no-evt', severity: 'warn', msg: 'LVO detected but EVT not recommended — document reason (e.g., late window without perfusion imaging, patient/family declined, contraindication).' });
            }
            // Future LKW detection + time window violations
            {
              const tf = calculateTimeFromLKW && calculateTimeFromLKW();
              if (tf && tf.futureWarning) {
                warnings.push({ id: 'future-lkw', severity: 'error', msg: `${tf.label} time is in the future — check date/time entry. Treatment windows cannot be calculated from a future reference time.` });
              }
              if (tf && !tf.futureWarning && tf.total > 24 && n.evtRecommended) {
                warnings.push({ id: 'evt-window-violation', severity: 'critical', msg: `EVT recommended ${tf.total.toFixed(1)}h from ${tf.label} — outside 24-hour guideline window. No anterior circulation EVT data beyond 24h. Verify basilar-specific eligibility (ATTENTION/BAOCHE) if applicable.` });
              }
              if (tf && !tf.futureWarning && tf.total > 4.5 && n.tnkRecommended && !n.wakeUpStrokeWorkflow?.isWakeUpStroke && !n.wakeUpStrokeWorkflow?.extendEligible) {
                warnings.push({ id: 'tnk-window-caution', severity: 'warn', msg: `TNK recommended ${tf.total.toFixed(1)}h from ${tf.label} — beyond standard 4.5h window. Verify extended-window eligibility (EXTEND, wake-up stroke protocol).` });
              }
            }
            // EVT platelet threshold
            {
              const evtPlt = parseInt(n.plateletCount, 10);
              if (n.evtRecommended && !isNaN(evtPlt) && evtPlt < 50) {
                warnings.push({ id: 'evt-low-platelets', severity: 'critical', msg: `EVT recommended with platelets ${evtPlt}K (<50K) — procedural bleeding risk. Platelet transfusion required before thrombectomy.` });
              }
            }
            if (n.tnkRecommended && inr > 1.7) {
              warnings.push({ id: 'tnk-inr', severity: 'error', msg: `TNK recommended with INR ${inr} — INR >1.7 is a contraindication` });
            }
            const pt = parseFloat(n.pt);
            if (n.tnkRecommended && !isNaN(pt) && pt > 15) {
              warnings.push({ id: 'tnk-pt', severity: 'error', msg: `TNK recommended with PT ${pt}s — PT >15s is a contraindication` });
            }
            if (n.tnkRecommended && platelets && platelets < 100) {
              warnings.push({ id: 'tnk-plt', severity: 'error', msg: `TNK recommended with platelets ${platelets}K — platelets <100K is a contraindication` });
            }
            const ptt = parseFloat(n.ptt);
            if (n.tnkRecommended && ptt && ptt > 40) {
              warnings.push({ id: 'tnk-ptt', severity: 'error', msg: `TNK recommended with aPTT ${ptt}s — aPTT >40s is a relative contraindication` });
            }
            if (glucose && glucose < 50 && n.tnkRecommended) {
              warnings.push({ id: 'tnk-glucose', severity: 'error', msg: `TNK recommended with glucose ${glucose} mg/dL (<50) — hypoglycemia is a contraindication to thrombolysis. Correct glucose to >100 mg/dL and reassess neurologic deficit before proceeding.` });
            } else if (glucose && glucose >= 50 && glucose <= 60 && n.tnkRecommended) {
              warnings.push({ id: 'tnk-glucose-borderline', severity: 'warn', msg: `TNK recommended with glucose ${glucose} mg/dL (50-60) — borderline hypoglycemia can mimic stroke symptoms. Recommend correcting to >100 mg/dL and reassessing deficit before thrombolysis.` });
            }
            if (glucose && glucose > 400 && n.tnkRecommended) {
              warnings.push({ id: 'tnk-hyperglycemia', severity: 'warn', msg: `TNK recommended with glucose ${glucose} mg/dL — severe hyperglycemia can mimic stroke and is associated with worse outcomes post-thrombolysis. Correct glucose; reassess if deficits improve.` });
            }

            // Heparin/LMWH + TNK bleeding risk
            if (n.tnkRecommended) {
              const meds = (n.medications || '').toLowerCase();
              const onUFH = meds.includes('heparin') && !meds.includes('enoxaparin') && !meds.includes('lovenox') && !meds.includes('dalteparin');
              const onLMWH = meds.includes('enoxaparin') || meds.includes('lovenox') || meds.includes('dalteparin');
              if (onUFH || onLMWH) {
                warnings.push({ id: 'heparin-tnk', severity: 'warn', msg: `TNK recommended on active ${onUFH ? 'heparin' : 'LMWH'} — increased bleeding risk. Verify aPTT and consider holding for thrombolytic window.` });
              }
            }

            // SAH + anticoagulation warning
            if (n.diagnosisCategory === 'sah' && (n.lastDOACType || n.lastDOACDose)) {
              const acName = n.lastDOACType && ANTICOAGULANT_INFO[n.lastDOACType] ? ANTICOAGULANT_INFO[n.lastDOACType].name : 'anticoagulant';
              warnings.push({ id: 'sah-anticoag', severity: 'error', msg: `SAH on ${acName} — initiate reversal per ICH anticoagulant reversal protocol` });
            }

            // GCS ≤8 airway alert
            const gcsTotal = calculateGCS(gcsItems);
            if (gcsTotal > 0 && gcsTotal <= 8) {
              warnings.push({ id: 'gcs-airway', severity: 'error', msg: `GCS ${gcsTotal} ≤8 — consider intubation for airway protection. RSI: prefer rocuronium 1.2 mg/kg (avoid succinylcholine — may raise ICP). Induction: propofol 1-2 mg/kg or etomidate 0.3 mg/kg.` });
            }

            // Triple therapy warning (DAPT + DOAC)
            const meds = (n.medications || '').toLowerCase();
            const hasAntiplatelet = meds.includes('aspirin') || meds.includes('clopidogrel') || meds.includes('ticagrelor') || meds.includes('prasugrel');
            const hasAnticoag = n.lastDOACType || meds.includes('warfarin') || meds.includes('coumadin') || meds.includes('heparin');
            const hasDAPT = [meds.includes('aspirin'), meds.includes('clopidogrel'), meds.includes('ticagrelor'), meds.includes('prasugrel')].filter(Boolean).length >= 2;
            if (hasDAPT && hasAnticoag) {
              warnings.push({ id: 'triple-therapy', severity: 'error', msg: 'Patient on DUAL antiplatelet + anticoagulant (triple therapy) — extreme bleeding risk. Coordinate with cardiology regarding de-escalation. Most patients should be reduced to single antiplatelet + anticoagulant.' });
            } else if (hasAntiplatelet && hasAnticoag) {
              warnings.push({ id: 'dual-antithrombotic', severity: 'warn', msg: 'Patient on antiplatelet + anticoagulant — increased bleeding risk. Verify indication for combination therapy.' });
            }

            // DAPT + TNK hemorrhage risk
            if (hasDAPT && n.tnkRecommended) {
              warnings.push({ id: 'dapt-tnk', severity: 'warn', msg: 'DAPT detected with TNK recommended — increased hemorrhage risk. Benefit usually outweighs risk for disabling stroke, but closely monitor for sICH.' });
            }

            // ACE inhibitor + TNK angioedema risk
            if (n.tnkRecommended && /lisinopril|enalapril|ramipril|captopril|benazepril|fosinopril|quinapril|perindopril|trandolapril|moexipril/.test(meds)) {
              warnings.push({ id: 'acei-tnk', severity: 'warn', msg: 'ACE inhibitor + TNK — 5x increased orolingual angioedema risk. Prepare: suction, nebulized epinephrine, IV dexamethasone, intubation equipment at bedside. Monitor tongue/lips q15min x 2h post-TNK.' });
            }

            // Edoxaban + CrCl >95 warning
            if (n.lastDOACType === 'edoxaban') {
              const edoCrCl = calculateCrCl(n.age, n.weight, n.sex, n.creatinine, n.height);
              if (edoCrCl && edoCrCl.value > 95) {
                warnings.push({ id: 'edoxaban-crcl-high', severity: 'error', msg: `Edoxaban with CrCl ${edoCrCl.value} mL/min (>95) — AVOID: reduced efficacy and increased stroke risk per ENGAGE AF-TIMI 48 and FDA labeling. Switch to alternative DOAC.` });
              }
            }

            // DOAC-specific CrCl contraindication checks
            {
              const doacCrCl = calculateCrCl(n.age, n.weight, n.sex, n.creatinine, n.height);
              if (doacCrCl) {
                if (n.lastDOACType === 'rivaroxaban') {
                  if (doacCrCl.value < 15) {
                    warnings.push({ id: 'rivaroxaban-crcl-contra', severity: 'error', msg: `Rivaroxaban with CrCl ${doacCrCl.value} mL/min (<15) — CONTRAINDICATED per FDA labeling. Switch to alternative agent or consult nephrology.` });
                  } else if (doacCrCl.value < 30) {
                    warnings.push({ id: 'rivaroxaban-crcl-reduce', severity: 'error', msg: `Rivaroxaban with CrCl ${doacCrCl.value} mL/min (15-29) — DOSE REDUCTION REQUIRED to 15 mg daily (FDA labeling). ROCKET-AF excluded CrCl <30; use with caution. Consider apixaban (better renal data) or warfarin.` });
                  }
                }
                if (n.lastDOACType === 'dabigatran') {
                  if (doacCrCl.value < 15) {
                    warnings.push({ id: 'dabigatran-crcl-contra', severity: 'error', msg: `Dabigatran with CrCl ${doacCrCl.value} mL/min (<15) — AVOID per FDA labeling (RE-LY excluded CrCl <30). No dosing recommendation available. Consider warfarin with INR monitoring or consult nephrology.` });
                  } else if (doacCrCl.value < 30) {
                    warnings.push({ id: 'dabigatran-crcl-caution', severity: 'warn', msg: `Dabigatran with CrCl ${doacCrCl.value} mL/min (15-29) — RE-LY excluded CrCl <30. FDA labeling: 75 mg BID only with concurrent P-gp inhibitor (dronedarone, ketoconazole). Consider switching to apixaban or warfarin.` });
                  }
                }
                if (n.lastDOACType === 'edoxaban' && doacCrCl.value > 95) {
                  warnings.push({ id: 'edoxaban-high-crcl', severity: 'warn', msg: `Edoxaban with CrCl ${doacCrCl.value} mL/min (>95) — REDUCED EFFICACY vs warfarin per ENGAGE AF-TIMI 48 and FDA labeling. Consider switching to warfarin (INR 2-3), apixaban, or rivaroxaban for stroke prevention in AF.` });
                }
              }
            }

            // Apixaban dose reduction prompt when age ≥80 but weight/creatinine unknown
            if (n.lastDOACType === 'apixaban') {
              const apixAge = parseFloat(n.age);
              const apixWt = parseFloat(n.weight);
              const apixCr = parseFloat(n.creatinine);
              if (!isNaN(apixAge) && apixAge >= 80 && (isNaN(apixWt) || isNaN(apixCr))) {
                warnings.push({ id: 'apixaban-age-dose-check', severity: 'warn', msg: `Apixaban in patient age ${apixAge} (≥80) — dose reduction to 2.5 mg BID required if ≥2 of 3 criteria met: age ≥80, weight ≤60 kg, Cr ≥1.5. Enter weight and creatinine to confirm appropriate dose (ARISTOTLE, FDA label).` });
              }
            }

            // Fondaparinux CrCl <30 contraindication
            if (/fondaparinux/.test(meds)) {
              const fondCrCl = calculateCrCl(n.age, n.weight, n.sex, n.creatinine, n.height);
              if (fondCrCl && fondCrCl.value < 30) {
                warnings.push({ id: 'fondaparinux-crcl-contra', severity: 'error', msg: `Fondaparinux on medication list with CrCl ${fondCrCl.value} mL/min (<30) — CONTRAINDICATED. Fondaparinux is renally eliminated; half-life increases to 72h with severe renal impairment. Use alternative VTE prophylaxis (UFH preferred if CrCl <30).` });
              }
            }

            // Ticagrelor + strong CYP3A4 inhibitor interaction
            if (/ticagrelor|brilinta/.test(meds) && /ketoconazole|itraconazole|clarithromycin|ritonavir|nelfinavir/.test(meds)) {
              warnings.push({ id: 'ticagrelor-cyp3a4', severity: 'error', msg: 'Ticagrelor + strong CYP3A4 inhibitor detected — CONTRAINDICATED per FDA labeling. Strong CYP3A4 inhibitors (ketoconazole, itraconazole, clarithromycin, ritonavir) substantially increase ticagrelor exposure and bleeding risk. Switch antiplatelet or discontinue interacting drug.' });
            }

            // Prasugrel safety warnings (FDA Black Box)
            if (/prasugrel|effient/.test(meds)) {
              const age = parseFloat(n.age);
              const wt = parseFloat(n.weight);
              if (!isNaN(age) && age >= 75) {
                warnings.push({ id: 'prasugrel-age75', severity: 'error', msg: `Prasugrel in patient age ${age} (≥75) — FDA BLACK BOX WARNING: generally not recommended due to increased fatal/intracranial bleeding risk, except in high-risk situations (diabetes, prior MI) where benefit may outweigh risk. Consider ticagrelor or clopidogrel alternative.` });
              }
              if (!isNaN(wt) && wt < 60) {
                warnings.push({ id: 'prasugrel-lowweight', severity: 'warn', msg: `Prasugrel with weight ${wt}kg (<60) — FDA WARNING: increased bleeding risk. Consider maintenance dose reduction to 5mg daily (TRITON-TIMI 38).` });
              }
              // Prasugrel is contraindicated with prior stroke/TIA — check PMH
              if (/prior.*(stroke|cva|tia)|h\/o.*(stroke|cva|tia)|(stroke|cva|tia).*history|s\/p.*(stroke|cva|tia)|cerebral infarct|ischemic stroke|hx of.*(stroke|tia)|previous.*(stroke|cva|tia)/.test((n.pmh || '').toLowerCase())) {
                warnings.push({ id: 'prasugrel-prior-stroke', severity: 'error', msg: 'Prasugrel with history of prior stroke/TIA — CONTRAINDICATED per FDA labeling (TRITON-TIMI 38: net clinical harm in prior CVA/TIA subgroup). Switch to ticagrelor or clopidogrel.' });
              }
            }

            // PPI-clopidogrel interaction (omeprazole/esomeprazole reduce CYP2C19 activation)
            if (/clopidogrel|plavix/.test(meds) && /omeprazole|esomeprazole|prilosec|nexium/.test(meds)) {
              warnings.push({ id: 'ppi-clopidogrel', severity: 'error', msg: 'Clopidogrel + omeprazole/esomeprazole — FDA WARNING: omeprazole/esomeprazole inhibit CYP2C19 and reduce clopidogrel active metabolite by ~45%. Switch PPI to pantoprazole (no significant CYP2C19 interaction) or consider alternative antiplatelet (ticagrelor). Famotidine (H2RA) is also a safe alternative for acid suppression.' });
            }

            // Pregnancy + TNK warning
            if (n.tnkRecommended && n.pregnancyStroke) {
              warnings.push({ id: 'tnk-pregnancy', severity: 'warn', msg: 'TNK recommended in pregnancy — weigh bleeding risk carefully, especially if postpartum or recent cesarean/neuraxial anesthesia' });
            }

            // EVT in pregnancy — obstetric precautions
            if (n.evtRecommended && n.pregnancyStroke) {
              warnings.push({ id: 'evt-pregnancy', severity: 'warn', msg: 'EVT in pregnancy — use pelvic lead shielding during angiography. Minimize fluoroscopy time. Coordinate with OB before and after procedure. Post-procedure fetal monitoring required. Iodinated contrast acceptable when benefit outweighs risk.' });
            }

            // Cardiac complication warning (troponin/EKG)
            const ekgLower = (n.ekgResults || '').toLowerCase();
            if (/stemi|st.?elevation|acute.?mi|st.?changes/.test(ekgLower)) {
              warnings.push({ id: 'cardiac-complication', severity: 'critical', msg: 'EKG suggests acute cardiac event — Differentiate: Type 2 MI (demand ischemia, most common in stroke), concurrent STEMI, or Takotsubo/neurogenic stunned myocardium. Cardiology consult. If concurrent ACS: heparin conflicts with post-TNK hold (24h) and post-ICH management. For Takotsubo: avoid catecholamines, consider milrinone if shock. Serial troponins, bedside echo.' });
            } else if (/takotsubo|stress.?cardio|wall.?motion|apical.?balloon/.test(ekgLower)) {
              warnings.push({ id: 'takotsubo-warning', severity: 'warn', msg: 'Takotsubo/neurogenic stunned myocardium suspected — common in large strokes and SAH. Bedside echo, serial troponins. Avoid catecholamines if cardiogenic shock (milrinone preferred). Usually self-resolving. Monitor for LV thrombus if severe wall motion abnormality.' });
            }

            // Cancer-associated stroke warnings
            if (n.activeCancer) {
              warnings.push({ id: 'cancer-stroke', severity: 'warn', msg: 'Active cancer — consider: D-dimer, blood cultures, TTE/TEE for marantic endocarditis (NBTE), chest CT. Multiterritory infarcts suggest cancer-related hypercoagulability. Secondary prevention: equipoise between anticoagulation (LMWH preferred) vs antiplatelet — discuss with oncology (AHA 2026 Cancer-Stroke Scientific Statement).' });
              if (n.tnkRecommended) {
                warnings.push({ id: 'cancer-tnk', severity: 'warn', msg: 'TNK in active cancer — check CBC/coagulation. Generally avoid IVT if known brain metastases. Thrombocytopenia (<100K) is a contraindication.' });
              }
            }

            // Sickle cell disease warnings
            if (n.sickleCellDisease) {
              warnings.push({ id: 'scd-stroke', severity: 'critical', msg: 'Sickle cell disease — URGENT: initiate exchange transfusion (target HbS <30%, Hgb ~10 g/dL). If exchange not immediately available, simple transfusion to Hgb 10. Contact transfusion medicine/hematology STAT. TNK is NOT contraindicated but do not delay exchange transfusion for TNK. Hydroxyurea + chronic transfusion for secondary prevention.' });
            }

            // Infective endocarditis warnings
            if (n.infectiveEndocarditis) {
              warnings.push({ id: 'endocarditis-stroke', severity: 'critical', msg: 'Infective endocarditis — AVOID anticoagulation (increases hemorrhagic transformation risk). Order: blood cultures x2, STAT TTE → TEE, CTA head/neck (mycotic aneurysm screen), ID consult. EVT is preferred for LVO (TNK is contraindicated). Monitor for hemorrhagic conversion.' });
            }

            // (duplicate tnk-nihss-zero removed — already checked above at line 10816)

            // Pediatric patient warning (age <18)
            if (!isNaN(age) && age < 18) {
              warnings.push({ id: 'pediatric-age', severity: 'critical', msg: `Age ${age} — PEDIATRIC patient. Standard adult stroke protocols may not apply. Consult pediatric neurology. TNK dosing, BP targets, and EVT criteria differ in children. Consider: moyamoya, sickle cell, cardiac, and metabolic etiologies.` });
            }

            // NIHSS ≥25 with late-window EVT consideration
            const nihss = parseInt(n.nihss, 10) || nihssScore || 0;
            if (!isNaN(nihss) && nihss >= 25 && n.evtRecommended) {
              const evtHrs = (tnkTime || ctTime) && lkw ? ((tnkTime || ctTime) - lkw) / (1000 * 60 * 60) : null;
              if (evtHrs && evtHrs > 6) {
                warnings.push({ id: 'nihss25-late-evt', severity: 'warn', msg: `NIHSS ${nihss} (≥25) in late window (${evtHrs.toFixed(1)}h) — very severe deficit with potential large core. Confirm ASPECTS ≥6 and favorable CTP mismatch. Higher risk of futile recanalization and sICH. Discuss prognosis and goals of care with family.` });
              }
            }

            // LVO identified but EVT not recommended — prompt documentation
            if (hasLVO && n.evtRecommended === false) {
              warnings.push({ id: 'lvo-no-evt', severity: 'warn', msg: 'LVO identified but EVT not pursued — document reason (e.g., ASPECTS <6, large core, premorbid mRS ≥3, goals of care, time window, access issues)' });
            }

            // DOAC + TNK without last dose timing documented
            if (n.tnkRecommended && n.lastDOACType && n.lastDOACType !== 'none' && n.lastDOACType !== 'warfarin' && n.lastDOACType !== 'heparin' && n.lastDOACType !== 'lmwh' && n.lastDOACType !== 'fondaparinux' && !n.lastDOACDose) {
              warnings.push({ id: 'doac-tnk-no-timing', severity: 'error', msg: `TNK recommended on ${ANTICOAGULANT_INFO[n.lastDOACType] ? ANTICOAGULANT_INFO[n.lastDOACType].name : n.lastDOACType} but last dose time not documented — DOAC half-life timing is critical for thrombolysis safety. Document last dose or check anti-Xa/dTT level.` });
            }

            // Post-TNK DOAC restart timing guidance
            if (n.tnkAdminTime && n.lastDOACType && ['apixaban', 'rivaroxaban', 'dabigatran', 'edoxaban'].includes(n.lastDOACType) && !(n.doacTiming || {}).doacInitiationDay) {
              const tnkNihss = parseInt(n.nihss, 10) || nihssScore || 0;
              const restartGuidance = tnkNihss < 8 ? 'mild (NIHSS <8): 48h post-TNK (after 24h TNK hold)' : tnkNihss <= 15 ? 'moderate (NIHSS 8-15): day 3-5 post-TNK' : 'severe (NIHSS ≥16): day 6-14 post-TNK';
              warnings.push({ id: 'post-tnk-doac-restart', severity: 'warn', msg: `Post-TNK DOAC restart timing not documented — ${restartGuidance}. Repeat imaging day 2-3 to rule out symptomatic hemorrhagic transformation before restarting. Set DOAC initiation day in DOAC Timing section. (CATALYST/ELAN)` });
            }

            // Weight missing for weight-based dosing (TNK or enoxaparin)
            if (n.tnkRecommended && !n.weight) {
              warnings.push({ id: 'tnk-no-weight', severity: 'error', msg: 'TNK recommended but weight not documented — TNK dosing is weight-based (0.25 mg/kg, max 25 mg). Obtain weight before administration.' });
            }

            // Discharge checklist core items incomplete
            {
              const dc = n.dischargeChecklist || {};
              const coreItems = [
                { key: 'antiplateletOrAnticoag', label: 'antithrombotic' },
                { key: 'statinPrescribed', label: 'statin' },
                { key: 'followUpNeurology', label: 'neurology f/u' },
                { key: 'followUpPCP', label: 'PCP f/u' },
                { key: 'patientEducation', label: 'patient education' }
              ];
              const missing = coreItems.filter(i => !dc[i.key]);
              if (n.dischargeChecklistReviewed && missing.length > 0) {
                warnings.push({ id: 'discharge-checklist-incomplete', severity: 'warn', msg: `Discharge checklist marked reviewed but ${missing.length} core item${missing.length > 1 ? 's' : ''} incomplete: ${missing.map(i => i.label).join(', ')}` });
              }
            }

            // TNK recommended but active internal bleeding documented
            if (n.tnkRecommended && n.tnkContraindicationChecklist?.activeInternalBleeding) {
              warnings.push({ id: 'tnk-active-bleeding', severity: 'error', msg: 'TNK recommended but active internal bleeding documented in contraindication checklist — this is an ABSOLUTE contraindication to thrombolysis.' });
            }

            // TNK + recent major surgery or head trauma
            if (n.tnkRecommended && (n.tnkContraindicationChecklist?.recentIntracranialSurgery || n.tnkContraindicationChecklist?.recentMajorSurgery)) {
              const surgTypes = [];
              if (n.tnkContraindicationChecklist.recentIntracranialSurgery) surgTypes.push('intracranial/intraspinal');
              if (n.tnkContraindicationChecklist.recentMajorSurgery) surgTypes.push('major extracranial');
              warnings.push({ id: 'tnk-recent-surgery', severity: 'error', msg: `TNK recommended but recent ${surgTypes.join(' & ')} surgery documented — relative contraindication within 14 days–3 months. Verify timing and clinical justification.` });
            }

            // EVT recommended but ASPECTS < 6 — outside standard eligibility
            if (n.evtRecommended && aspectsScore != null && aspectsScore < 6) {
              warnings.push({ id: 'evt-low-aspects', severity: 'error', msg: `EVT recommended but ASPECTS ${aspectsScore} (<6) — outside standard eligibility criteria (HERMES, MR CLEAN). Consider SELECT2/ANGEL-ASPECT criteria (ASPECTS 3-5 for mRS 0-1 patients with anterior LVO). Document rationale.` });
            }

            // EVT recommended but no recanalization result documented
            if (n.evtRecommended && !n.ticiScore) {
              warnings.push({ id: 'evt-no-tici', severity: 'warn', msg: 'EVT recommended but recanalization result (mTICI score) not documented — document post-procedure outcome.' });
            }
            // EVT recommended but pre-mRS not documented or >2
            if (n.evtRecommended) {
              const mrs = parseInt(n.premorbidMRS, 10);
              if (isNaN(mrs)) {
                warnings.push({ id: 'evt-no-mrs', severity: 'warn', msg: 'EVT recommended but pre-stroke mRS not documented — most EVT trials required mRS ≤2.' });
              } else if (mrs > 2) {
                warnings.push({ id: 'evt-high-mrs', severity: 'error', msg: `EVT recommended but pre-stroke mRS is ${mrs} (>2) — most EVT trials excluded mRS >2. Consider TESTED trial if mRS 3-4.` });
              }
            }

            // Hemorrhagic transformation detected but antithrombotics not held
            if (n.hemorrhagicTransformation?.detected && !n.hemorrhagicTransformation?.antithromboticHeld) {
              warnings.push({ id: 'ht-antithrombotics-not-held', severity: 'error', msg: 'Hemorrhagic transformation documented but antithrombotics not marked as held — verify medication management.' });
            }

            // SAH or ICH with anticoagulation but reversal not initiated
            if ((n.diagnosisCategory === 'sah' || n.diagnosisCategory === 'ich') && n.lastDOACType && !n.ichReversalInitiated) {
              warnings.push({ id: 'hemorrhage-no-reversal', severity: 'error', msg: `${n.diagnosisCategory === 'sah' ? 'SAH' : 'ICH'} with pre-admission ${n.lastDOACType} but anticoagulation reversal not initiated — urgent reversal required.` });
            }

            // CTP mismatch ratio < 1.0 — possible core/penumbra volume swap
            const ctpCore = parseFloat(n.ctpStructured?.coreVolume);
            const ctpPenumbra = parseFloat(n.ctpStructured?.penumbraVolume);
            if (!isNaN(ctpCore) && ctpCore > 0 && !isNaN(ctpPenumbra) && ctpPenumbra < ctpCore) {
              warnings.push({ id: 'ctp-mismatch-lt1', severity: 'warn', msg: `CTP penumbra (${ctpPenumbra}mL) < core (${ctpCore}mL) — mismatch ratio <1.0. Verify volumes are not swapped.` });
            }

            // Active bleeding + anticoagulation — hold restart
            if (n.tnkContraindicationChecklist?.activeInternalBleeding && n.lastDOACType && n.lastDOACType !== 'none') {
              const acName = ANTICOAGULANT_INFO[n.lastDOACType]?.name || n.lastDOACType;
              warnings.push({ id: 'doac-active-bleeding', severity: 'error', msg: `Active internal bleeding documented on patient with pre-admission ${acName} — hold anticoagulation restart. Manage active bleeding; consider reversal if not already initiated.` });
            }

            // SAH grading scale completeness
            if (n.diagnosisCategory === 'sah' && n.sahGrade && !n.sahGradeScale) {
              warnings.push({ id: 'sah-grade-no-scale', severity: 'warn', msg: 'SAH Grade documented but grading scale not specified — select Hunt-Hess, WFNS, or Modified Fisher scale for clarity.' });
            }

            // BP phase-diagnosis coherence
            if (n.diagnosisCategory === 'ich' && n.bpPhase && !['ich'].includes(n.bpPhase)) {
              warnings.push({ id: 'bp-phase-ich-mismatch', severity: 'warn', msg: `ICH diagnosis but BP phase set to '${n.bpPhase}' — ICH guideline recommends SBP <140 (INTERACT3/AHA 2022). Set BP phase to ICH.` });
            }
            if (n.diagnosisCategory === 'sah' && n.bpPhase && !['sah', 'sah-secured'].includes(n.bpPhase)) {
              warnings.push({ id: 'bp-phase-sah-mismatch', severity: 'warn', msg: `SAH diagnosis but BP phase set to '${n.bpPhase}' — SAH target is SBP <160 (pre-securing) or <140 (post-securing). Verify BP phase.` });
            }
            if (n.diagnosisCategory === 'ischemic' && ['ich', 'sah', 'sah-secured'].includes(n.bpPhase)) {
              warnings.push({ id: 'bp-phase-ischemic-mismatch', severity: 'warn', msg: `Ischemic stroke diagnosis but BP phase set to '${n.bpPhase}' (hemorrhage target). Use pre-TNK (185/110) or post-TNK/EVT (180/105) for ischemic stroke.` });
            }

            // Post-EVT BP <140 is Class III: Harm
            if (n.evtRecommended && n.bpPostEVT) {
              const bpMatch = n.bpPostEVT.match(/(\d+)/);
              const sbp = bpMatch ? parseInt(bpMatch[1], 10) : NaN;
              if (!isNaN(sbp) && sbp < 140) {
                warnings.push({ id: 'post-evt-bp-too-low', severity: 'error', msg: `Post-EVT SBP ${sbp} mmHg — SBP <140 after successful reperfusion is Class III: Harm (ENCHANTED2/MT, BEST-II 2024). SBP <130 associated with worse outcomes. Target SBP 140-180/105.` });
              }
            }

            return warnings;
          };

          // =============================================
          // ORDER BUNDLE QUICK COPY
          // =============================================
          const getOrderBundles = () => {
            const n = telestrokeNote;
            const cat = n.diagnosisCategory;
            const isIschemic = cat === 'ischemic' || cat === 'tia';
            const isICH = cat === 'ich';
            const isSAH = cat === 'sah';
            const meds = (n.medications || '').toLowerCase();
            const nihss = parseInt(n.nihss, 10) || nihssScore || 0;
            const weight = parseFloat(n.weight) || 0;
            const bundles = [];

            // BP Management - Pre-TNK
            if (n.tnkRecommended && !n.tnkAdminTime) {
              bundles.push({
                id: 'bp-pre-tnk',
                label: 'Pre-TNK BP Orders',
                icon: 'heart-pulse',
                color: 'red',
                orders: [
                  'Target BP <185/110 mmHg prior to and during TNK',
                  'Labetalol 10-20 mg IV push over 1-2 min; if BP not controlled, repeat 40-80 mg IV q10min (max 300 mg total)',
                  'If BP not controlled: Nicardipine 5 mg/hr IV, titrate by 2.5 mg/hr q5-15 min (max 15 mg/hr)',
                  'If BP cannot be maintained <185/110: HOLD thrombolysis',
                  `Current BP: ${n.presentingBP || '***'}`,
                  'Recheck BP q5 min during active titration'
                ]
              });
            }

            // BP Management - Post-TNK
            if (n.tnkAdminTime && isIschemic) {
              bundles.push({
                id: 'bp-post-tnk',
                label: 'Post-TNK BP Orders',
                icon: 'heart-pulse',
                color: 'red',
                orders: [
                  'Target BP <180/105 mmHg x 24 hours post-TNK',
                  'Nicardipine 5 mg/hr IV (titrate by 2.5 mg/hr q5-15 min, max 15 mg/hr)',
                  'Monitor BP q15 min x 2h, then q30 min x 6h, then q1h x 16h',
                  `TNK given at: ${n.tnkAdminTime}`,
                  'Neuro checks q15min x 2h, q30min x 6h, q1h x 16h (call for any change)',
                  'If hemorrhagic transformation suspected: STAT CT Head, hold antithrombotics'
                ]
              });
            }

            // Acute Labs
            if (isIschemic || isICH || isSAH) {
              const labOrders = [
                'CBC with differential',
                'BMP (glucose, creatinine, electrolytes)',
                'PT/INR, aPTT',
                'Troponin',
                'Type & Screen'
              ];
              if (isICH || isSAH) {
                labOrders.push('Fibrinogen level');
                labOrders.push('Thrombin time (TT)');
                labOrders.push('D-dimer');
                labOrders.push('Direct Xa Inhibitor screen (if DOAC suspected)');
              }
              if (isIschemic) {
                labOrders.push('Fasting lipid panel (can draw non-fasting acutely)');
                labOrders.push('HbA1c');
              }
              labOrders.push('TSH (if not recent)');
              labOrders.push('Urine drug screen (if clinical suspicion)');
              bundles.push({
                id: 'acute-labs',
                label: `Acute ${isICH ? 'ICH' : isSAH ? 'SAH' : 'AIS'} Labs`,
                icon: 'test-tubes',
                color: 'indigo',
                orders: labOrders
              });
            }

            // BP Management - ICH
            if (isICH) {
              bundles.push({
                id: 'bp-ich',
                label: 'ICH BP Orders',
                icon: 'heart-pulse',
                color: 'red',
                orders: [
                  'Target SBP <140 mmHg within 2h of onset (Class IIa, INTERACT2). Avoid SBP <130 (ATACH-2).',
                  'Nicardipine 5 mg/hr IV, titrate by 2.5 mg/hr q5-15 min (max 15 mg/hr)',
                  'Avoid SBP <130 mmHg (renal AKI risk)',
                  `Current BP: ${n.presentingBP || '***'}`,
                  'Maintain target for ≥24 hours',
                  'Recheck BP q15 min during active titration, then q1h once stable'
                ]
              });
            }

            // ICH Admission / Monitoring Orders
            if (isICH) {
              const ichAdmitOrders = [
                'Admit to Neuro ICU / Step-down with continuous monitoring',
                'Neuro checks q1h (NIHSS, GCS, pupils)',
                'HOB 30 degrees',
                'Repeat NCCT Head in 6 hours (assess for hematoma expansion)',
                'NPO until formal swallow screen',
                'Seizure precautions (avoid routine prophylactic ASMs unless cortical/lobar ICH with seizures)',
                'IPC/SCDs on admission for VTE prophylaxis',
                'Hold all antithrombotics — discuss restart timing at 48-72h if applicable',
                'Strict I/O, Foley catheter if ICU',
                'Bowel protocol: docusate 100 mg BID standing + senna 8.6 mg PRN (avoid Valsalva straining — may worsen hemorrhage/raise ICP)'
              ];
              const ichGcsVal = calculateGCS(gcsItems);
              if (nihss >= 10 || (ichGcsVal > 0 && ichGcsVal <= 12)) {
                ichAdmitOrders.push('Consider EEG monitoring if unexplained decline in consciousness');
                ichAdmitOrders.push('Neurosurgery consult for possible surgical evacuation (if eligible)');
              }
              bundles.push({
                id: 'ich-admit',
                label: 'ICH Admission Orders',
                icon: 'clipboard-list',
                color: 'red',
                orders: ichAdmitOrders
              });
            }

            // Anticoagulant Reversal — check structured dropdown first, then free-text
            const acType = n.lastDOACType || '';
            const onWarfarin = acType === 'warfarin' || meds.includes('warfarin') || meds.includes('coumadin');
            const onDabigatran = acType === 'dabigatran' || meds.includes('dabigatran') || meds.includes('pradaxa');
            const onXaI = ['apixaban', 'rivaroxaban', 'edoxaban'].includes(acType) || meds.includes('apixaban') || meds.includes('eliquis') || meds.includes('rivaroxaban') || meds.includes('xarelto');
            const onHeparin = meds.includes('heparin') && !meds.includes('enoxaparin') && !meds.includes('lovenox') && !meds.includes('dalteparin');
            const onLMWH = meds.includes('enoxaparin') || meds.includes('lovenox') || meds.includes('dalteparin') || meds.includes('tinzaparin');
            const onFondaparinux = acType === 'fondaparinux' || meds.includes('fondaparinux') || meds.includes('arixtra');
            if (isICH && (onWarfarin || onDabigatran || onXaI || onHeparin || onLMWH || onFondaparinux)) {
              const reversalOrders = [];
              if (onWarfarin) {
                const inrVal = parseFloat(inr);
                let inrTier = 'INR ≥2.0: 4F-PCC (COR 1/B)';
                if (!isNaN(inrVal)) {
                  if (inrVal >= 2.0) inrTier = `INR ${inrVal.toFixed(1)} ≥2.0 → 4F-PCC recommended (COR 1/B)`;
                  else if (inrVal >= 1.6) inrTier = `INR ${inrVal.toFixed(1)} (1.6-1.9) → 4F-PCC recommended (COR 2b/C)`;
                  else if (inrVal >= 1.3) inrTier = `INR ${inrVal.toFixed(1)} (1.3-1.5) → 4F-PCC 25 IU/kg may be considered (COR 2b/C): recommend if ICH expanding, volume >30 mL, or high-risk location`;
                  else inrTier = `INR ${inrVal.toFixed(1)} (<1.3) → PCC likely not needed; give Vitamin K`;
                }
                const pccRef = calculatePCCDose(telestrokeNote.weight, inr);
                const pccDoseNote = pccRef && pccRef.ahaDose ? ` [AHA weight-based: ${pccRef.ahaDose} units (${pccRef.iuPerKg} IU/kg)]` : '';
                reversalOrders.push(
                  'Vitamin K 10 mg IV',
                  `4F-PCC (Kcentra) 2000 units IV immediately (fixed-dose protocol)${pccDoseNote}`,
                  inrTier,
                  'Recheck PT/INR at 30 min and q6h x 24h post-PCC',
                  'If INR >1.5 after PCC: page Hematology, consider 500 units PCC or 2-4 units FFP',
                  'If INR >1.5 at 24h: repeat Vitamin K 10 mg IV',
                  'PCC contraindications: DIC, HIT (absolute); thrombotic event <6wk, prothrombotic condition (relative)'
                );
              } else if (onDabigatran) {
                reversalOrders.push(
                  'Assessment: STAT Thrombin Time (TT) — normal TT excludes significant dabigatran effect',
                  'If ingestion <2h: activated charcoal (oral)',
                  'Idarucizumab (Praxbind) 5g IV (2 x 2.5g, ≤15 min apart, each over 5-10 min)',
                  'If idarucizumab unavailable: 4F-PCC 2000 units IV',
                  'If renal failure: consider emergent dialysis (dabigatran 65% dialyzable)',
                  'REBOUND RISK: Idarucizumab t½ ~40 min; dabigatran levels may return within 24h. Recheck TT/dTT at 12h and 24h post-reversal. Consider anticoag restart timing 24-48h post-ICH if hemostasis achieved and indication (AF, VTE) is strong — discuss with Neurology/Hematology.'
                );
              } else if (onXaI) {
                reversalOrders.push(
                  'Assessment: STAT Direct Xa Inhibitor Screen — normal excludes significant anticoagulant effect',
                  'If ingestion <2h: activated charcoal (oral)',
                  '4F-PCC (Kcentra) 2000 units IV immediately (local protocol)',
                  'Recheck Direct Xa Inhibitor screen after PCC',
                  'Andexanet alfa may not be available at all centers — check local formulary. PCC is first-line.',
                  'If renal failure: consider emergent dialysis (rivaroxaban 33%, edoxaban 50% renal clearance; apixaban not dialyzable)',
                  'If PCC contraindicated: consult Hematology attending'
                );
              } else if (onHeparin) {
                reversalOrders.push(
                  'STOP heparin infusion immediately',
                  'Assessment: Anti-Xa level, aPTT',
                  'Protamine dosing: 1 mg per 100 units UFH infused in the PRECEDING 2-3 hours (max 50 mg/dose); if >3h since last dose, reduce to 0.5 mg/100 units — e.g., 1500 units/hr x 2h = 3000 units → protamine 30 mg IV over 10 min (COR 2a/C)',
                  'Recheck anti-Xa after infusion',
                  'If anti-Xa >0.1 → additional protamine 0.5 mg per 100 units, max cumulative 50 mg',
                  'If platelets <100K: send HIT antibodies, consult Hematology if positive'
                );
              } else if (onLMWH) {
                reversalOrders.push(
                  'Assessment: clinically significant hemorrhage (COR 2b/C)',
                  'Last dose <8h: Protamine 1 mg per 1 mg enoxaparin (max 50 mg)',
                  'Last dose 8-12h: Protamine 0.5 mg per 1 mg enoxaparin (max 50 mg)',
                  'Last dose >12h: likely unnecessary — check anti-Xa',
                  'Note: protamine only partially reverses LMWH (~60% anti-Xa neutralization)'
                );
              } else if (onFondaparinux) {
                reversalOrders.push(
                  'Assessment: STAT anti-Xa level (calibrated for fondaparinux)',
                  'NO SPECIFIC REVERSAL AGENT for fondaparinux (t½ 17-21 hours)',
                  'Supportive care + time is mainstay (drug is 100% renally cleared)',
                  '4F-PCC 50 IU/kg may partially correct coagulopathy — not reliably studied, consider as rescue therapy',
                  'rFVIIa (NovoSeven) 90 mcg/kg — off-label, consider only for life-threatening hemorrhage after Hematology consultation',
                  'If severe renal failure (CrCl <30): clearance significantly prolonged; consider dialysis consultation (fondaparinux ~40% renally cleared)',
                  'Protamine does NOT reverse fondaparinux',
                  'Consult Hematology for persistent hemorrhage despite supportive measures'
                );
              }
              // Additional blood product thresholds
              reversalOrders.push(
                '--- Additional Products (check labs) ---',
                'If fibrinogen <200 mg/dL → 2 pools cryoprecipitate (10 individual units)',
                'If platelets <50K → 2 units platelets; 50-100K → 1 unit platelets',
                'Antiplatelet agents: discontinue; platelet transfusion NOT recommended (PATCH, COR 3/B harm)'
              );
              // Monitoring
              reversalOrders.push(
                '--- Monitoring ---',
                'Recheck STAT Emergency Stroke Panel 15-30 min post-reversal',
                'Repeat PT/INR, CBC at 6h and 24h',
                'Repeat CT Head at 6h and 24h (sooner if deterioration)'
              );
              const reversalLabel = onWarfarin ? 'Warfarin' : onDabigatran ? 'Dabigatran' : onXaI ? 'Xa Inhibitor' : onHeparin ? 'Heparin' : onFondaparinux ? 'Fondaparinux' : 'LMWH';
              bundles.push({
                id: 'reversal',
                label: `Anticoag Reversal (${reversalLabel})`,
                icon: 'shield-alert',
                color: 'orange',
                orders: reversalOrders
              });
            }

            // VTE Prophylaxis
            if (isIschemic || isICH) {
              const vteOrders = ['Intermittent pneumatic compression (IPC) bilateral lower extremities — apply on admission'];
              if (isIschemic && n.tnkAdminTime) {
                vteOrders.push('Pharmacologic VTE prophylaxis: HOLD 24 hours post-lytic (local protocol)');
                vteOrders.push('After 24h + stable follow-up CT: Enoxaparin 40 mg SC daily (or Heparin 5000 units SC q8h if CrCl <30)');
              } else if (isIschemic) {
                vteOrders.push('Enoxaparin 40 mg SC daily (start within 24h if immobile)');
                vteOrders.push('If CrCl <30: Heparin 5000 units SC q8h');
              } else if (isICH) {
                vteOrders.push('Pharmacologic VTE prophylaxis: HOLD 48 hours after IPH onset (local protocol)');
                vteOrders.push('After 48h + hematoma stability on repeat CT: Enoxaparin 40 mg SC daily (or Heparin 5000 units SC q8h if CrCl <30)');
              }
              if (weight > 100) vteOrders.push(`Weight ${weight} kg — consider enoxaparin 40 mg SC q12h for BMI-based dosing`);
              bundles.push({
                id: 'vte',
                label: 'VTE Prophylaxis',
                icon: 'shield',
                color: 'teal',
                orders: vteOrders
              });
            }

            // DAPT Loading
            if (isIschemic && nihss <= 5 && !n.tnkRecommended && !n.evtRecommended) {
              const daptOrders = nihss <= 3 ? [
                  'Aspirin 325 mg PO x1 (loading dose)',
                  'Clopidogrel 300 mg PO x1 (loading dose)',
                  'Then: Aspirin 81 mg PO daily + Clopidogrel 75 mg daily x 21 days',
                  'After 21 days: transition to aspirin 81 mg monotherapy',
                  `NIHSS: ${nihss} — qualifies for DAPT (NIHSS ≤3, CHANCE/POINT)`,
                  'If CYP2C19 LOF carrier: Ticagrelor 180 mg load → 90 mg BID + ASA x 21 days (CHANCE-2)',
                  'Contraindication: active GI bleed, allergy, planned surgery'
                ] : [
                  'Consider: Ticagrelor 180 mg PO x1 + Aspirin 325 mg PO x1 (loading doses)',
                  'Then: Ticagrelor 90 mg PO BID + Aspirin 81 mg daily x 30 days (THALES, Class IIb)',
                  'After 30 days: transition to aspirin 81 mg monotherapy',
                  `NIHSS: ${nihss} — NIHSS 4-5 qualifies for ticagrelor-based DAPT (THALES)`,
                  'Alternative: Standard clopidogrel-based DAPT if ticagrelor contraindicated',
                  'Contraindication: active GI bleed, allergy, planned surgery, strong CYP3A4 inhibitors'
                ];
              bundles.push({
                id: 'dapt',
                label: nihss <= 3 ? 'DAPT Loading (CHANCE/POINT)' : 'DAPT Loading (THALES, NIHSS 4-5)',
                icon: 'pill',
                color: 'blue',
                orders: daptOrders
              });
            }

            // Osmotherapy - ICH or large ischemic with edema
            if (isICH || (isIschemic && nihss >= 15)) {
              const osmOrders = [];
              if (isICH) {
                osmOrders.push(
                  'Hypertonic saline 23.4% 30 mL IV over 15 min via central line (for acute herniation)',
                  'OR Hypertonic saline 3% 250 mL IV over 30 min (peripheral ok)',
                  'OR Mannitol 20% 1 g/kg IV over 20 min (peripheral ok)',
                  `${weight ? `Weight ${weight} kg → Mannitol ${Math.round(weight * 5)} mL of 20% (= ${weight} g)` : 'Weight needed for mannitol dosing'}`,
                  'Mannitol repeat dosing: 0.25-0.5 g/kg IV q4-6h PRN for ongoing ICP elevation (max ~2 g/kg/day). Hold if serum osmolality >320 or osmol gap >20.',
                  'Target Na+ 145-155 mEq/L for 3% NaCl; serum osmolality <320 for mannitol',
                  'Check BMP q6h (Na+, K+, osmolality), strict I/O'
                );
              } else {
                osmOrders.push(
                  'Consider osmotherapy if signs of herniation or progressive edema',
                  'Mannitol 20% 1 g/kg IV over 20 min (can give peripherally)',
                  `${weight ? `Weight ${weight} kg → Mannitol ${Math.round(weight * 5)} mL of 20% (= ${weight} g)` : 'Weight needed for dosing'}`,
                  'HOB 30 degrees, avoid hyperthermia, avoid hyponatremia'
                );
              }
              bundles.push({
                id: 'osmotherapy',
                label: 'Osmotherapy',
                icon: 'droplets',
                color: 'purple',
                orders: osmOrders
              });
            }

            // Acute Seizure Treatment Bundle
            if (isICH || isSAH || (isIschemic && nihss >= 10)) {
              bundles.push({
                id: 'seizure-treatment',
                label: 'Acute Seizure Treatment',
                icon: 'zap',
                color: 'amber',
                orders: [
                  'FIRST-LINE: Lorazepam 0.1 mg/kg IV (max 4 mg/dose), may repeat x1 in 5 min',
                  '  If no IV access: Midazolam 0.2 mg/kg IM (max 10 mg)',
                  'SECOND-LINE (if seizures persist >5 min after benzo):',
                  '  Levetiracetam 60 mg/kg IV (max 4500 mg) over 15 min',
                  '  OR Fosphenytoin 20 PE/kg IV (max 150 PE/min) — avoid in ICH if possible (hypotension risk)',
                  '  OR Valproate 40 mg/kg IV (max 4500 mg) over 10 min — avoid if liver disease/pregnancy',
                  'REFRACTORY STATUS (>30 min): Intubation required',
                  '  Midazolam: 0.2 mg/kg IV bolus, then 0.05-2 mg/kg/hr infusion (titrate to seizure suppression on EEG)',
                  '  OR Propofol: 1-2 mg/kg IV bolus, then 20-80 mcg/kg/min infusion (titrate to burst suppression on EEG)',
                  '  Target: burst suppression x 24-48h, then slowly wean over 24h with continuous EEG',
                  'Continuous EEG monitoring if: impaired consciousness, recurrent seizures, or post-status',
                  'Check glucose, electrolytes, AED levels. Treat fever aggressively.',
                  `${isICH ? 'ICH: Seizures may indicate hematoma expansion — STAT repeat CT' : isSAH ? 'SAH: Seizures may indicate rebleed — STAT repeat CT' : ''}`
                ]
              });
            }

            // Glucose Management Bundle
            {
              const glucose = parseFloat(n.glucose);
              if (glucose > 180 || n.tnkRecommended) {
                bundles.push({
                  id: 'glucose-mgmt',
                  label: 'Glucose Management',
                  icon: 'droplet',
                  color: 'yellow',
                  orders: [
                    'Target blood glucose 140-180 mg/dL (AHA/ASA 2026; SHINE trial: intensive insulin <130 was harmful)',
                    `${glucose ? `Current glucose: ${glucose} mg/dL` : 'Check POC glucose on arrival'}`,
                    'BG checks: q6h routine; q1h if on insulin infusion',
                    n.tnkRecommended ? 'Post-TNK: insulin drip preferred for tight control during monitoring period' : 'Sliding scale insulin for glucose >180 mg/dL',
                    'AVOID: D5W fluids, glucose-containing IV solutions',
                    'Treat hypoglycemia (<70 mg/dL): 25 mL D50W IV push, recheck in 15 min',
                    'Call MD if: glucose <70 or >300 mg/dL despite treatment',
                    'Transition to basal-bolus SC insulin when tolerating PO and clinically stable'
                  ]
                });
              }
            }

            // Post-EVT Groin/Access Site Care Orders
            if (telestrokeNote.evtRecommended) {
              bundles.push({
                id: 'post-evt-groin',
                label: 'Post-EVT Groin/Access Site Care',
                icon: 'activity',
                color: 'orange',
                orders: [
                  'Groin check q15 min x 2h, then q30 min x 4h, then q1h x 6h',
                  'Bed rest with HOB flat x 4-6h (or per closure device instructions)',
                  'Check distal pulses (dorsalis pedis, posterior tibial) with each groin check',
                  'If hematoma expanding: manual pressure x 15 min, call neurointerventional team',
                  'NPO until reassessed (in case re-intervention needed)',
                  'Mark access site with skin marker at time of arrival from angio suite'
                ]
              });
            }

            if (isSAH) {
              bundles.push({
                id: 'sah-bundle',
                label: 'SAH Admission Orders',
                icon: 'brain',
                color: 'pink',
                orders: [
                  'Nimodipine 60 mg PO/NG q4h x 21 days (reduce to 30 mg q2h if hypotension)',
                  'Target SBP <160 mmHg until aneurysm secured',
                  'Nicardipine 5 mg/hr IV (titrate to 15 mg/hr) for BP control',
                  'IV isotonic saline for euvolemia — avoid hypovolemia',
                  'Seizure prophylaxis (if cortical SAH, IVH, poor-grade HH 3-5, or seizure at onset): Levetiracetam 500-1000 mg IV/PO q12h x 3-7 days — avoid prolonged routine prophylaxis',
                  'Stool softener (docusate 100 mg BID) — avoid straining',
                  'Magnesium sulfate: Target Mg2+ ≥2.0 mg/dL (≥0.8 mmol/L). Check q12h. Replete aggressively — hypomagnesemia worsens vasospasm.',
                  'Neurosurgery/neurointerventional consult for aneurysm securing',
                  'Neuro checks q1h, strict I/O, HOB 30 degrees'
                ]
              });
            }

            // Nursing Communication Parameter Sheet
            if (isIschemic || isICH || isSAH) {
              const nursingOrders = [];
              const bpTarget = isICH ? 'SBP <140 mmHg (INTERACT2)' : isSAH ? 'SBP <160 until aneurysm secured' :
                n.tnkAdminTime ? 'SBP <180/105 x 24h post-lytic' : n.evtRecommended ? 'SBP <180, avoid <140 post-EVT' : 'SBP <220 (permissive HTN)';
              nursingOrders.push(`BP target: ${bpTarget}`);
              nursingOrders.push(`Neuro checks: ${n.tnkAdminTime ? 'q15min x 2h, q30min x 6h, q1h x 16h' : 'q1h'}`);
              nursingOrders.push('Diet: NPO until formal swallow screen/SLP eval');
              nursingOrders.push(`Activity: ${n.tnkAdminTime ? 'Bedrest HOB 30° x 24h post-lytic' : isSAH ? 'Bedrest HOB 30°, minimal stimulation' : 'Bedrest until stable neuro exam, then OOB with assist'}`);
              nursingOrders.push(`DVT prophylaxis: SCDs on admission. ${n.tnkAdminTime ? 'Hold SQ heparin 24h post-TNK' : isICH ? 'Hold SQ heparin 24-48h' : 'Start enoxaparin 40mg SC daily if immobile'}`);
              nursingOrders.push('IV: NS at 75 mL/hr (avoid D5W/hypotonic)');
              nursingOrders.push(`Call MD if: NIHSS increase ≥2 points, SBP ${isICH ? '>140 or <110' : '>185 or <100'}, glucose <70 or >250 mg/dL, new headache/vomiting, any bleeding, O2 <94%, temperature >38°C, urine output <0.5 mL/kg/hr`);
              bundles.push({
                id: 'nursing-params',
                label: 'Nursing Parameters Sheet',
                icon: 'clipboard-check',
                color: 'purple',
                orders: nursingOrders
              });
            }

            return bundles;
          };

          // Helper: format date as YYYY-MM-DD
          const formatDateLocal = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
          // Helper: format time as HH:MM
          const formatTimeLocal = (d) => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

          // Now button component for timestamp fields
          const NowButton = ({ onClick, label }) => (
            <button type="button" onClick={onClick} className="px-2 py-1 text-xs font-semibold text-blue-600 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 focus:ring-2 focus:ring-blue-500 transition-colors whitespace-nowrap min-h-[36px]" title={label || 'Set to current time'}>
              Now
            </button>
          );

          const resolveSectionCandidates = (id) => {
            if (id === 'patient-info-section') {
              if (consultationType === 'videoTelestroke') {
                return ['phone-patient-info-section', 'patient-info-section'];
              }
              return ['patient-info-section', 'phone-patient-info-section'];
            }
            return [id];
          };

          const scrollToSection = (id) => {
            const candidateIds = resolveSectionCandidates(id);
            const target = candidateIds
              .map((candidateId) => document.getElementById(candidateId))
              .find((candidateEl) => !!candidateEl);
            if (!target) return;
            const headerOffset = 160;
            const top = target.getBoundingClientRect().top + window.pageYOffset - headerOffset;
            window.scrollTo({ top: Math.max(0, top), behavior: 'smooth' });
            if (!target.hasAttribute('tabindex')) {
              target.setAttribute('tabindex', '-1');
            }
            target.focus({ preventScroll: true });
          };

          const jumpToEncounterField = (fieldName) => {
            const fieldTargets = {
              Age: { phase: 'phase-triage', section: 'patient-info-section', focusIds: ['input-age', 'phone-input-age'] },
              LKW: { phase: 'phase-triage', section: 'lkw-section', focusIds: ['lkw-time', 'lkw-date'] },
              Diagnosis: { phase: 'phase-decision', section: 'treatment-decision', focusIds: ['input-diagnosis'] },
              NIHSS: { phase: 'phase-triage', section: 'nihss-section', focusIds: ['input-nihss', 'phone-input-nihss'] },
              'CT Head': { phase: 'phase-triage', section: 'imaging-section', focusIds: ['input-ct-results', 'phone-input-ct-results'] },
              Disposition: { phase: 'phase-documentation', section: 'discharge-checklist-section', focusIds: ['input-disposition'] }
            };
            const target = fieldTargets[fieldName];
            if (!target) return;

            navigateTo('encounter');
            if (target.phase) setEncounterPhase(target.phase);

            requestAnimationFrame(() => {
              if (target.section) scrollToSection(target.section);
              window.setTimeout(() => {
                const focusEl = (target.focusIds || [])
                  .map((id) => document.getElementById(id))
                  .find((el) => !!el);
                if (!focusEl) return;
                focusEl.focus({ preventScroll: false });
                if (typeof focusEl.select === 'function') {
                  focusEl.select();
                }
                focusEl.classList.add('ring-2', 'ring-blue-400');
                window.setTimeout(() => {
                  focusEl.classList.remove('ring-2', 'ring-blue-400');
                }, 1200);
              }, 220);
            });
          };

          const jumpToNextRequiredEncounterField = () => {
            if (!encounterReadiness.nextField) return;
            jumpToEncounterField(encounterReadiness.nextField);
          };

          // Get guideline recommendations matching current patient data
          const getContextualRecommendations = () => {
            const timeFrom = calculateTimeFromLKW();
            const data = {
              telestrokeNote,
              nihssScore,
              aspectsScore,
              gcsScore: calculateGCS(gcsItems),
              timeFromLKW: timeFrom,
              ichScore: typeof calculateICHScore === 'function' ? calculateICHScore(ichScoreItems) : 0
            };
            return Object.values(GUIDELINE_RECOMMENDATIONS).filter(rec => {
              try { return rec.conditions(data); } catch (err) { console.warn(`Guideline condition failed for "${rec.id || 'unknown'}":`, err.message); return false; }
            });
          };

          // NIHSS validation
          const isNIHSSComplete = () => {
            return nihssItems.every(item => patientData[item.id] !== undefined && patientData[item.id] !== '');
          };

          const getIncompleteNIHSSItems = () => {
            return nihssItems.filter(item => !patientData[item.id]).map(item => item.name);
          };

          const getNIHSSInterpretation = (score) => {
            if (score === 0) return { severity: 'No stroke symptoms', color: 'green', guidance: 'Consider stroke mimics and alternative diagnoses' };
            if (score <= 4) return { severity: 'Minor stroke', color: 'yellow', guidance: 'Consider EVT if large vessel occlusion present despite low NIHSS' };
            if (score <= 15) return { severity: 'Moderate stroke', color: 'orange', guidance: 'Candidate for both thrombolysis and EVT if eligible' };
            if (score <= 20) return { severity: 'Moderate-severe stroke', color: 'red', guidance: 'Aggressive intervention warranted - high benefit potential' };
            return { severity: 'Severe stroke', color: 'red', guidance: 'All treatment options should be considered - high mortality risk without intervention' };
          };

          const applyNihssAllNormal = () => {
            const newData = {};
            nihssItems.forEach((item) => {
              const normalOption = item.options.find((opt) => opt.includes('(0)')) || item.options[0];
              newData[item.id] = normalOption;
            });
            setPatientData(newData);
            const newScore = calculateNIHSS(newData);
            setNihssScore(newScore);
            setTelestrokeNote(prev => ({ ...prev, nihss: newScore.toString() }));
          };

          // Treatment validation
          const validateTreatmentRecommendation = () => {
            const hasContraindications = strokeCodeForm.tnk && strokeCodeForm.tnk.length > 0;
            const tnkRecommended = strokeCodeForm.tnk_rec === 'Recommended';

            if (hasContraindications && tnkRecommended) {
              return {
                valid: false,
                message: `WARNING: TNK recommended but ${strokeCodeForm.tnk.length} contraindication(s) selected`,
                severity: 'error'
              };
            }

            if (!hasContraindications && strokeCodeForm.tnk_rec === 'Not Recommended') {
              return {
                valid: true,
                message: 'No contraindications selected. Confirm rationale for not recommending TNK.',
                severity: 'warning'
              };
            }

            return { valid: true, message: null, severity: null };
          };

          // Search function
          // Helper function to check if evidence section matches filter
          const evidenceSectionMatches = (sectionTitle, documentTitles) => {
            if (!evidenceFilter) return true;
            const filter = evidenceFilter.toLowerCase();
            if (sectionTitle.toLowerCase().includes(filter)) return true;
            return documentTitles.some(title => title.toLowerCase().includes(filter));
          };

          const fuzzyScore = (query, target) => {
            if (!query || !target) return 0;
            const q = query.toLowerCase();
            const t = target.toLowerCase();
            if (t === q) return 100;
            let score = 0;
            if (t.startsWith(q)) score += 40;
            if (t.includes(q)) score += 25;
            let ti = 0;
            for (let qi = 0; qi < q.length; qi += 1) {
              const idx = t.indexOf(q[qi], ti);
              if (idx === -1) continue;
              score += idx === ti ? 4 : 1;
              ti = idx + 1;
            }
            return score;
          };

          const rankText = (query, parts = []) => {
            return parts.reduce((sum, part) => sum + fuzzyScore(query, part), 0);
          };

          const guidelineQuickActions = [
            { id: 'tnk', label: 'TNK dosing', regex: /\b(tnk|tenecteplase)\b/i, target: { tab: 'encounter' } },
            { id: 'evt', label: 'EVT criteria', regex: /\b(evt|thrombectomy|endovascular)\b/i, target: { tab: 'management', subTab: 'ischemic' } },
            { id: 'ich', label: 'ICH protocol', regex: /\b(ich|intracerebral hemorrhage)\b/i, target: { tab: 'management', subTab: 'ich' } },
            { id: 'nihss', label: 'NIHSS', regex: /\bnihss\b/i, target: { tab: 'encounter' } },
            { id: 'aspects', label: 'ASPECTS', regex: /\baspects\b/i, target: { tab: 'encounter' } },
            { id: 'gcs', label: 'GCS', regex: /\b(gcs|glasgow)\b/i, target: { tab: 'management', subTab: 'calculators' } },
            { id: 'abcd2', label: 'ABCD²', regex: /\babcd2\b/i, target: { tab: 'management', subTab: 'calculators' } },
            { id: 'chads', label: 'CHA₂DS₂-VASc', regex: /\b(cha2ds2|chads)\b/i, target: { tab: 'management', subTab: 'calculators' } },
            { id: 'hasbled', label: 'HAS-BLED', regex: /\bhas[- ]?bled\b/i, target: { tab: 'management', subTab: 'calculators' } },
            { id: 'doac', label: 'DOAC timing', regex: /\b(apixaban|rivaroxaban|dabigatran|edoxaban|doac)\b/i, target: { tab: 'management', subTab: 'ischemic' } }
          ];

          const getGuidelineQuickActions = (text) => {
            if (!text) return [];
            const actions = [];
            guidelineQuickActions.forEach((action) => {
              if (action.regex.test(text)) actions.push(action);
            });
            return actions;
          };

          const guidelineLibraryGuidelineOptions = useMemo(() => {
            return GUIDELINE_LIBRARY_INDEX.map((guideline) => ({
              id: guideline.id,
              label: guideline.shortTitle || guideline.title
            }));
          }, []);

          const guidelineLibrarySectionOptions = useMemo(() => {
            const sections = new Set();
            const guidelines = guidelineLibraryGuideline
              ? GUIDELINE_LIBRARY_INDEX.filter((guideline) => guideline.id === guidelineLibraryGuideline)
              : GUIDELINE_LIBRARY_INDEX;
            guidelines.forEach((guideline) => {
              guideline.recommendations.forEach((rec) => {
                if (rec.section) sections.add(rec.section);
              });
            });
            return Array.from(sections).sort();
          }, [guidelineLibraryGuideline]);

          const guidelineLibraryClassOptions = useMemo(() => {
            const classSet = new Set();
            GUIDELINE_LIBRARY_INDEX.forEach((guideline) => {
              guideline.recommendations.forEach((rec) => {
                classSet.add(rec.classOfRec || 'Statement');
              });
            });
            const preferredOrder = ['I', 'IIa', 'IIb', 'III', 'Statement'];
            const ordered = preferredOrder.filter((item) => classSet.has(item));
            const remaining = Array.from(classSet).filter((item) => !preferredOrder.includes(item)).sort();
            return [...ordered, ...remaining];
          }, []);

          const filteredGuidelineLibrary = useMemo(() => {
            const query = guidelineLibraryQuery.trim().toLowerCase();
            const classPriority = { I: 0, IIa: 1, IIb: 2, III: 3, Statement: 4 };
            const getRecScore = (rec, guideline) => {
              if (!query) return 0;
              return rankText(query, [rec.text, rec.section, guideline.title, guideline.shortTitle || '']);
            };

            return GUIDELINE_LIBRARY_INDEX
              .filter((guideline) => !guidelineLibraryGuideline || guideline.id === guidelineLibraryGuideline)
              .map((guideline) => {
                const filteredRecs = guideline.recommendations
                  .map((rec) => ({ ...rec, _score: getRecScore(rec, guideline) }))
                  .filter((rec) => {
                    if (guidelineLibrarySection && rec.section !== guidelineLibrarySection) return false;
                    const recClass = rec.classOfRec || 'Statement';
                    if (guidelineLibraryClass && recClass !== guidelineLibraryClass) return false;
                    if (query && rec._score <= 0) return false;
                    return true;
                  })
                  .sort((a, b) => {
                    const classA = a.classOfRec || 'Statement';
                    const classB = b.classOfRec || 'Statement';
                    const rankA = classPriority[classA] ?? 5;
                    const rankB = classPriority[classB] ?? 5;
                    if (rankA !== rankB) return rankA - rankB;
                    return (b._score || 0) - (a._score || 0);
                  });
                return { ...guideline, recommendations: filteredRecs };
              })
              .filter((guideline) => guideline.recommendations.length > 0);
          }, [guidelineLibraryQuery, guidelineLibraryGuideline, guidelineLibrarySection, guidelineLibraryClass]);

          const guidelineLibraryResultsCount = useMemo(() => {
            return filteredGuidelineLibrary.reduce((sum, guideline) => sum + guideline.recommendations.length, 0);
          }, [filteredGuidelineLibrary]);

          const encounterReadiness = useMemo(() => {
            const trackedFields = [
              { name: 'Age', value: telestrokeNote.age },
              { name: 'Sex', value: telestrokeNote.sex },
              { name: 'LKW', value: lkwTime },
              { name: 'NIHSS', value: telestrokeNote.nihss || nihssScore },
              { name: 'CT Head', value: telestrokeNote.ctResults },
              { name: 'Diagnosis', value: telestrokeNote.diagnosis },
              { name: 'Disposition', value: telestrokeNote.disposition }
            ];
            const missing = trackedFields.filter((field) => !field.value);
            const required = missing.filter((field) => ['Age', 'LKW', 'Diagnosis'].includes(field.name));
            const recommended = missing.filter((field) => ['NIHSS', 'CT Head', 'Disposition'].includes(field.name));
            const completedCount = trackedFields.length - missing.length;
            const readinessPercent = Math.round((completedCount / trackedFields.length) * 100);
            const nextField = (required[0] || recommended[0] || null)?.name || null;
            return {
              trackedFields,
              missing,
              required,
              recommended,
              completedCount,
              readinessPercent,
              nextField
            };
          }, [
            telestrokeNote.age,
            telestrokeNote.sex,
            telestrokeNote.nihss,
            telestrokeNote.ctResults,
            telestrokeNote.diagnosis,
            telestrokeNote.disposition,
            lkwTime,
            nihssScore
          ]);

          const QUICK_SEARCH_COMMANDS = [
            { value: 'next required', label: 'next required', hint: 'Jump to highest-priority missing field' },
            { value: 'dx ischemic', label: 'dx ischemic', hint: 'Set diagnosis and pathway to ischemic stroke' },
            { value: 'nihss 12', label: 'nihss 12', hint: 'Set NIHSS and jump to triage exam' },
            { value: 'wt 80', label: 'wt 80', hint: 'Set patient weight for thrombolysis dosing' },
            { value: 'lkw now', label: 'lkw now', hint: 'Set LKW to current time' },
            { value: 'tab trials', label: 'tab trials', hint: 'Jump directly to active clinical trials' },
            { value: 'copy note', label: 'copy note', hint: 'Copy consult note to clipboard' },
            { value: 'new case', label: 'new case', hint: 'Reset encounter and start a fresh case' },
            { value: 'export pdf', label: 'export pdf', hint: 'Export current case snapshot as PDF' },
            { value: 'nct05948566', label: 'nct05948566', hint: 'Open trial card directly by NCT' }
          ];

          const parseLkwTimeCommand = (rawToken, baseDate = new Date()) => {
            const token = String(rawToken || '').trim().toLowerCase();
            if (!token || token === 'now') {
              return token === 'now' ? new Date() : null;
            }

            let hours = null;
            let minutes = null;

            const ampmMatch = token.match(/^(\d{1,2}):(\d{2})\s*([ap]m)$/i);
            if (ampmMatch) {
              hours = parseInt(ampmMatch[1], 10);
              minutes = parseInt(ampmMatch[2], 10);
              const meridiem = ampmMatch[3].toLowerCase();
              if (hours < 1 || hours > 12 || minutes < 0 || minutes > 59) return null;
              if (hours === 12) hours = 0;
              if (meridiem === 'pm') hours += 12;
            } else {
              const colonMatch = token.match(/^(\d{1,2}):(\d{2})$/);
              const compactMatch = token.match(/^(\d{3,4})$/);
              if (colonMatch) {
                hours = parseInt(colonMatch[1], 10);
                minutes = parseInt(colonMatch[2], 10);
              } else if (compactMatch) {
                const digits = compactMatch[1];
                if (digits.length === 3) {
                  hours = parseInt(digits[0], 10);
                  minutes = parseInt(digits.slice(1), 10);
                } else {
                  hours = parseInt(digits.slice(0, 2), 10);
                  minutes = parseInt(digits.slice(2), 10);
                }
              }
              if (hours === null || minutes === null || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
                return null;
              }
            }

            const nextTime = new Date(baseDate);
            nextTime.setHours(hours, minutes, 0, 0);
            return nextTime;
          };

          const performSearch = (query) => {
            if (!query || query.length < 2) {
              setSearchResults([]);
              setSearchActiveIndex(-1);
              return;
            }

            const results = [];
            const lowerQuery = query.toLowerCase();
            const scoreFor = (parts, boost = 0) => rankText(lowerQuery, parts) + boost;

            // Command-style shortcuts
            const nextFieldCommand = lowerQuery.match(/^(?:next(?:\s+(?:required|field|step))?|required)$/i);
            if (nextFieldCommand && encounterReadiness.nextField) {
              const targetField = encounterReadiness.nextField;
              results.push({
                type: 'Command',
                title: `Go to next missing field: ${targetField}`,
                description: 'Jumps to the highest-priority incomplete field',
                score: 995,
                action: () => jumpToEncounterField(targetField)
              });
            }
            const nihssCommand = lowerQuery.match(/^(?:nihss|set nihss)\s+(\d{1,2})$/i);
            if (nihssCommand) {
              const parsed = Math.max(0, Math.min(42, parseInt(nihssCommand[1], 10)));
              if (Number.isFinite(parsed)) {
                results.push({
                  type: 'Command',
                  title: `Set NIHSS to ${parsed}`,
                  description: 'Updates encounter NIHSS and jumps to triage',
                  score: 1000,
                  action: () => {
                    setNihssScore(parsed);
                    setTelestrokeNote((prev) => ({ ...prev, nihss: String(parsed) }));
                    navigateTo('encounter', { clearSearch: true });
                    setTimeout(() => scrollToSection('nihss-section'), 100);
                  }
                });
              }
            }
            const ageCommand = lowerQuery.match(/^(?:age|set age)\s+(\d{1,3})$/i);
            if (ageCommand) {
              const parsed = Math.max(0, Math.min(120, parseInt(ageCommand[1], 10)));
              if (Number.isFinite(parsed)) {
                results.push({
                  type: 'Command',
                  title: `Set age to ${parsed}`,
                  description: 'Updates patient age',
                  score: 950,
                  action: () => {
                    setTelestrokeNote((prev) => ({ ...prev, age: String(parsed) }));
                    navigateTo('encounter', { clearSearch: true });
                    setTimeout(() => scrollToSection('patient-info-section'), 100);
                  }
                });
              }
            }
            const weightCommand = lowerQuery.match(/^(?:weight|wt|set weight)\s+(\d{2,3})(?:\s*kg)?$/i);
            if (weightCommand) {
              const parsed = Math.max(20, Math.min(350, parseInt(weightCommand[1], 10)));
              if (Number.isFinite(parsed)) {
                results.push({
                  type: 'Command',
                  title: `Set weight to ${parsed} kg`,
                  description: 'Updates weight and TNK dose context',
                  score: 940,
                  action: () => {
                    setTelestrokeNote((prev) => ({ ...prev, weight: String(parsed) }));
                    navigateTo('encounter', { clearSearch: true });
                    setTimeout(() => scrollToSection('patient-info-section'), 100);
                  }
                });
              }
            }
            const lkwCommand = lowerQuery.match(/^(?:lkw|set lkw)\s+(.+)$/i);
            if (lkwCommand) {
              const literal = lkwCommand[1].trim();
              const isNowLiteral = literal.toLowerCase() === 'now';
              const parsedTime = parseLkwTimeCommand(literal, lkwTime || new Date());
              if (parsedTime) {
                results.push({
                  type: 'Command',
                  title: isNowLiteral
                    ? 'Set LKW to now'
                    : `Set LKW time to ${parsedTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`,
                  description: 'Updates last known well and jumps to timeline',
                  score: 960,
                  action: () => {
                    setLkwTime(isNowLiteral ? new Date() : parsedTime);
                    navigateTo('encounter', { clearSearch: true });
                    setTimeout(() => scrollToSection('lkw-section'), 100);
                  }
                });
              }
            }
            const diagnosisCommand = lowerQuery.match(/^(?:dx|diagnosis|set diagnosis|set dx)\s+(.+)$/i);
            if (diagnosisCommand) {
              const token = diagnosisCommand[1].trim();
              const diagnosisMappings = [
                { test: /\blvo\b/, diagnosis: 'Acute Ischemic Stroke - LVO', category: 'ischemic' },
                { test: /\bminor\b/, diagnosis: 'Minor Ischemic Stroke', category: 'ischemic' },
                { test: /\bischemic\b|\bais\b/, diagnosis: 'Acute Ischemic Stroke', category: 'ischemic' },
                { test: /\bich\b|\bintracerebral\b/, diagnosis: 'Intracerebral Hemorrhage (ICH)', category: 'ich' },
                { test: /\bsah\b|\bsubarachnoid\b/, diagnosis: 'Subarachnoid Hemorrhage (SAH)', category: 'sah' },
                { test: /\btia\b/, diagnosis: 'TIA', category: 'tia' },
                { test: /\bcvt\b|\bvenous thrombosis\b/, diagnosis: 'Cerebral Venous Thrombosis (CVT)', category: 'cvt' },
                { test: /\bmimic\b/, diagnosis: 'Stroke Mimic', category: '' }
              ];
              const mapping = diagnosisMappings.find((item) => item.test.test(token));
              if (mapping) {
                results.push({
                  type: 'Command',
                  title: `Set diagnosis: ${mapping.diagnosis}`,
                  description: 'Updates diagnosis and pathway routing',
                  score: 980,
                  action: () => {
                    setTelestrokeNote((prev) => {
                      const next = { ...prev, diagnosis: mapping.diagnosis, diagnosisCategory: mapping.category };
                      if ((mapping.category === 'ich' || mapping.category === 'sah') && prev.tnkRecommended) {
                        next.tnkRecommended = false;
                        next.tnkAutoBlocked = true;
                        next.tnkAutoBlockReason = `TNK auto-cleared: ${mapping.category.toUpperCase()} diagnosis (thrombolysis contraindicated)`;
                      }
                      if (mapping.category !== 'ischemic' && (prev.bpPhase === 'post-evt' || prev.bpPhase === 'post-tnk')) {
                        next.bpPhase = 'pre-tnk';
                      }
                      return next;
                    });
                    if (mapping.category === 'ich') setManagementSubTab('ich');
                    else if (mapping.category === 'sah') setManagementSubTab('sah');
                    else if (mapping.category === 'tia') setManagementSubTab('tia');
                    else if (mapping.category === 'ischemic') setManagementSubTab('ischemic');
                    else if (mapping.category === 'cvt') setManagementSubTab('cvt');
                    navigateTo('encounter', { clearSearch: true });
                    setTimeout(() => scrollToSection('treatment-decision'), 100);
                  }
                });
              }
            }
            const tabCommand = lowerQuery.match(/^(?:tab|go|open)\s+(dashboard|encounter|library|settings|trials|management)$/i);
            if (tabCommand) {
              const tabKey = tabCommand[1].toLowerCase();
              const tabLabelMap = {
                dashboard: 'Dashboard',
                encounter: 'Encounter',
                library: 'Library',
                settings: 'Settings',
                trials: 'Trials',
                management: 'Protocols & Tools'
              };
              results.push({
                type: 'Command',
                title: `Go to ${tabLabelMap[tabKey] || tabKey}`,
                description: 'Switches workspace context',
                score: 970,
                action: () => {
                  if (tabKey === 'trials') {
                    navigateTo('library', { clearSearch: true, subTab: 'trials' });
                  } else if (tabKey === 'management') {
                    navigateTo('library', { clearSearch: true, subTab: 'management' });
                  } else {
                    navigateTo(tabKey, { clearSearch: true });
                  }
                }
              });
            }
            const phaseCommand = lowerQuery.match(/^(?:phase|encounter phase|go phase)\s+(triage|decision|management|documentation)$/i);
            if (phaseCommand) {
              const phaseKey = phaseCommand[1].toLowerCase();
              const phaseMap = {
                triage: 'phase-triage',
                decision: 'phase-decision',
                management: 'phase-management',
                documentation: 'phase-documentation'
              };
              const phaseLabel = phaseKey.charAt(0).toUpperCase() + phaseKey.slice(1);
              if (phaseMap[phaseKey]) {
                results.push({
                  type: 'Command',
                  title: `Go to encounter ${phaseLabel}`,
                  description: 'Jumps to encounter phase navigation',
                  score: 965,
                  action: () => {
                    navigateTo('encounter', { clearSearch: true });
                    setEncounterPhase(phaseMap[phaseKey]);
                    requestAnimationFrame(() => {
                      setTimeout(() => scrollToSection(phaseMap[phaseKey]), 240);
                    });
                  }
                });
              }
            }
            const modeCommand = lowerQuery.match(/^(?:mode|set mode)\s+(video|telestroke|phone|telephone)$/i);
            if (modeCommand) {
              const modeKey = modeCommand[1].toLowerCase();
              const toVideo = modeKey === 'video' || modeKey === 'telestroke';
              results.push({
                type: 'Command',
                title: toVideo ? 'Switch to Video Telestroke mode' : 'Switch to Phone Consult mode',
                description: 'Sets consult mode and keeps you on Encounter',
                score: 955,
                action: () => {
                  setConsultationType(toVideo ? 'videoTelestroke' : 'telephone');
                  setClinicalContext(toVideo ? 'acute' : 'phone');
                  navigateTo('encounter', { clearSearch: true });
                }
              });
            }
            const newCaseCommand = lowerQuery.match(/^(?:new case|start new case|reset case)$/i);
            if (newCaseCommand) {
              results.push({
                type: 'Command',
                title: 'Start new case',
                description: 'Clears encounter state and resets workspace',
                score: 972,
                action: () => {
                  startNewPatient();
                  navigateTo('encounter', { clearSearch: true });
                }
              });
            }
            const exportPdfCommand = lowerQuery.match(/^(?:export pdf|save pdf|download pdf)$/i);
            if (exportPdfCommand) {
              results.push({
                type: 'Command',
                title: 'Export PDF',
                description: 'Downloads a PDF snapshot of the current case',
                score: 966,
                action: () => {
                  exportToPDF();
                  navigateTo('encounter', { clearSearch: true });
                }
              });
            }
            const copyNoteCommand = lowerQuery.match(/^(?:copy(?:\s+(?:consult|encounter))?\s+note|copy consult|copy consult note)$/i);
            if (copyNoteCommand) {
              results.push({
                type: 'Command',
                title: 'Copy consult note',
                description: 'Generates and copies the current consult note',
                score: 970,
                action: () => {
                  const note = generateTelestrokeNote();
                  copyToClipboard(note, 'Consult Note');
                  navigateTo('encounter', { clearSearch: true });
                }
              });
            }
            const recruitingOnlyCommand = lowerQuery.match(/^(?:recruiting only|trials recruiting|show recruiting trials)$/i);
            if (recruitingOnlyCommand) {
              results.push({
                type: 'Command',
                title: 'Show recruiting trials only',
                description: 'Switches Trials to recruiting-only filter',
                score: 968,
                action: () => {
                  setTrialsRecruitingOnly(true);
                  navigateTo('library', { clearSearch: true, subTab: 'trials' });
                }
              });
            }
            const showAllTrialsCommand = lowerQuery.match(/^(?:show all trials|all trials)$/i);
            if (showAllTrialsCommand) {
              results.push({
                type: 'Command',
                title: 'Show all trials',
                description: 'Clears recruiting-only trial filter',
                score: 967,
                action: () => {
                  setTrialsRecruitingOnly(false);
                  navigateTo('library', { clearSearch: true, subTab: 'trials' });
                }
              });
            }
            const openPathwayCommand = lowerQuery.match(/^(?:open pathway|pathway)$/i);
            if (openPathwayCommand) {
              const pathway = telestrokeNote.diagnosisCategory || getPathwayForDiagnosis(telestrokeNote.diagnosis || '');
              const pathwaySubTab = ['ischemic', 'ich', 'sah', 'tia', 'cvt'].includes(pathway) ? pathway : null;
              if (pathwaySubTab) {
                const pathwayLabelMap = {
                  ischemic: 'Ischemic pathway',
                  ich: 'Hemorrhagic ICH pathway',
                  sah: 'SAH pathway',
                  tia: 'TIA prevention pathway',
                  cvt: 'CVT pathway'
                };
                results.push({
                  type: 'Command',
                  title: `Open ${pathwayLabelMap[pathwaySubTab]}`,
                  description: 'Jump to pathway-specific protocols in Library',
                  score: 969,
                  action: () => {
                    navigateTo('library', { clearSearch: true, subTab: 'management' });
                    setManagementSubTab(pathwaySubTab);
                  }
                });
              }
            }
            if (lowerQuery === 'reversal' || lowerQuery === 'ich reversal') {
              results.push({
                type: 'Command',
                title: 'Open ICH reversal protocol',
                description: 'Jump to hemorrhage reversal workflow',
                score: 900,
                action: () => {
                  navigateTo('library', { subTab: 'management' });
                  setManagementSubTab('ich');
                }
              });
            }
            const nctCommand = lowerQuery.match(/^(?:nct[:\s-]*)?(nct\d{8})$/i);
            if (nctCommand) {
              const targetNct = nctCommand[1].toUpperCase();
              const trialConfigMatch = Object.entries(TRIAL_ELIGIBILITY_CONFIG).find(([, cfg]) => cfg && cfg.nct === targetNct);
              if (trialConfigMatch) {
                const [trialId, cfg] = trialConfigMatch;
                results.push({
                  type: 'Command',
                  title: `Open ${targetNct}`,
                  description: `${cfg.name} trial`,
                  score: 980,
                  action: () => navigateToTrial(trialId)
                });
              }
            }

            // Search in trials
            Object.entries(trialsData).forEach(([category, data]) => {
              if (data.hasSubsections) {
                Object.entries(data.subsections).forEach(([subKey, subsection]) => {
                  subsection.trials.forEach(trial => {
                    const score = scoreFor([trial.name, trial.description, trial.nct], 5);
                    if (score > 0) {
                      results.push({
                        type: 'Clinical Trial',
                        category: category,
                        title: trial.name,
                        description: trial.description.substring(0, 100) + '...',
                        score,
                        action: () => {
                          navigateToTrialCard(trial.name, category);
                        }
                      });
                    }
                  });
                });
              }
            });

            // Search trial criteria and eligibility text (inclusion/exclusion intent)
            Object.entries(TRIAL_ELIGIBILITY_CONFIG).forEach(([trialId, config]) => {
              const criterionPool = [
                ...(config?.lookingFor || []).map((text) => ({ label: 'Looking for', text })),
                ...(config?.keyCriteria || []).map((criterion) => ({ label: 'Eligibility', text: criterion.label })),
                ...(config?.exclusionFlags || []).map((criterion) => ({ label: 'Exclusion', text: criterion.label })),
                ...(config?.keyTakeaways || []).map((text) => ({ label: 'Key takeaway', text }))
              ];

              let bestMatch = null;
              criterionPool.forEach((criterion) => {
                const score = scoreFor([config.name, config.nct, criterion.label, criterion.text], 6);
                if (score > 0 && (!bestMatch || score > bestMatch.score)) {
                  bestMatch = { ...criterion, score };
                }
              });

              if (bestMatch) {
                results.push({
                  type: 'Trial Criteria',
                  category: config.category,
                  title: `${config.name} - ${bestMatch.label}`,
                  description: bestMatch.text,
                  score: bestMatch.score,
                  action: () => navigateToTrial(trialId)
                });
              }
            });

            // Search in management tools
            const searchableItems = [
              { name: 'NIHSS', keywords: ['nihss', 'stroke scale', 'neurological'], tab: 'encounter' },
              { name: 'ASPECTS', keywords: ['aspects', 'imaging', 'ct'], tab: 'encounter' },
              { name: 'TNK Eligibility', keywords: ['tnk', 'tenecteplase', 'thrombolysis', 'lytic'], tab: 'encounter' },
              { name: 'EVT Eligibility', keywords: ['evt', 'thrombectomy', 'mechanical', 'endovascular'], tab: 'encounter' },
              { name: 'ICH Management', keywords: ['ich', 'hemorrhage', 'bleeding', 'reversal'], tab: 'management', subTab: 'ich' },
              { name: 'GCS Score', keywords: ['gcs', 'glasgow', 'coma', 'consciousness'], tab: 'management', subTab: 'calculators' },
              { name: 'ICH Score', keywords: ['ich score', 'hemorrhage score', 'mortality'], tab: 'management', subTab: 'calculators' },
              { name: 'ABCD² Score', keywords: ['abcd', 'tia', 'transient'], tab: 'management', subTab: 'calculators' },
              { name: 'CHA₂DS₂-VASc', keywords: ['chads', 'afib', 'atrial fibrillation', 'anticoagulation'], tab: 'management', subTab: 'calculators' },
              { name: 'ROPE Score', keywords: ['rope', 'pfo', 'paradoxical'], tab: 'management', subTab: 'calculators' },
              { name: 'Modified Rankin Scale (mRS)', keywords: ['mrs', 'rankin', 'disability', 'outcome', 'functional status'], tab: 'management', subTab: 'calculators' },
              { name: 'Hunt and Hess Scale', keywords: ['hunt', 'hess', 'sah', 'subarachnoid', 'hemorrhage', 'grading'], tab: 'management', subTab: 'calculators' },
              { name: 'WFNS Scale', keywords: ['wfns', 'world federation', 'neurosurgical', 'sah', 'subarachnoid'], tab: 'management', subTab: 'calculators' },
              { name: 'HAS-BLED Score', keywords: ['hasbled', 'has-bled', 'bleeding', 'risk', 'anticoagulation'], tab: 'management', subTab: 'calculators' },
              { name: 'RCVS² Score', keywords: ['rcvs', 'rcvs2', 'vasoconstriction', 'thunderclap', 'headache'], tab: 'management', subTab: 'calculators' },
              { name: 'PHASES Score (Aneurysm)', keywords: ['phases', 'aneurysm', 'rupture', 'unruptured', 'uia'], tab: 'management', subTab: 'calculators' },
              { name: 'Blood Pressure Management', keywords: ['bp', 'blood pressure', 'labetalol', 'nicardipine'], tab: 'management', subTab: 'ischemic' },
              { name: 'SAH Management', keywords: ['sah', 'subarachnoid', 'aneurysm', 'nimodipine', 'vasospasm'], tab: 'management', subTab: 'sah' },
              { name: 'TIA Management', keywords: ['tia', 'transient ischemic', 'abcd2', 'dual antiplatelet'], tab: 'management', subTab: 'tia' },
              { name: 'CVT Management', keywords: ['cvt', 'cerebral venous', 'sinus thrombosis', 'venous'], tab: 'management', subTab: 'cvt' },
              { name: 'Seizure Management', keywords: ['seizure', 'epilepsy', 'levetiracetam', 'keppra', 'prophylaxis'], tab: 'management', subTab: 'ischemic' },
              { name: 'Dysphagia Screening', keywords: ['dysphagia', 'swallow', 'swallowing', 'aspiration', 'npo'], tab: 'encounter' },
              { name: 'Contraindication Checklist', keywords: ['contraindication', 'exclusion', 'tnk', 'thrombolysis', 'checklist'], tab: 'encounter' },
              { name: 'Door-to-Needle Timer', keywords: ['dtn', 'door to needle', 'time', 'timer', 'workflow'], tab: 'encounter' },
              { name: 'CrCl Calculator', keywords: ['crcl', 'creatinine clearance', 'cockcroft', 'gault', 'renal'], tab: 'management', subTab: 'calculators' },
              { name: 'Enoxaparin Dosing', keywords: ['enoxaparin', 'lovenox', 'lmwh', 'dvt', 'vte'], tab: 'management', subTab: 'calculators' },
              { name: 'Andexanet Dosing', keywords: ['andexanet', 'andexxa', 'reversal', 'factor xa'], tab: 'management', subTab: 'calculators' },
              { name: 'ICH Volume (ABC/2)', keywords: ['ich volume', 'abc', 'hematoma', 'volume'], tab: 'management', subTab: 'calculators' },
              { name: 'Contrast Allergy Protocol', keywords: ['contrast', 'allergy', 'premedication', 'ct angiography'], tab: 'management', subTab: 'ischemic' },
              { name: 'Posterior Circulation Stroke', keywords: ['posterior', 'basilar', 'vertebral', 'cerebellar', 'cannot miss', 'top of basilar', 'aica', 'wallenberg'], tab: 'management', subTab: 'ischemic' },
              { name: 'Transfer Checklist', keywords: ['transfer', 'spoke', 'hub', 'transport'], tab: 'encounter' },
              { name: 'Hemorrhagic Transformation', keywords: ['hemorrhagic transformation', 'sich', 'symptomatic ich', 'post-tnk bleeding', 'ecass'], tab: 'management', subTab: 'ischemic' },
              { name: 'Stroke Mimic Workup', keywords: ['mimic', 'mimic workup', 'differential', 'seizure', 'migraine', 'conversion', 'functional'], tab: 'encounter' },
              { name: 'Code Stroke Activation Criteria', keywords: ['code stroke', 'activation', 'alert', 'lvo alert', 'race scale', 'de-escalation', 'when to activate'], tab: 'management', subTab: 'references' },
              { name: 'Acute Deterioration', keywords: ['deterioration', 'worsening', 'decline', 'neuro change', 'acute change'], tab: 'management', subTab: 'ischemic' },
              { name: 'DOAC Reversal', keywords: ['doac reversal', 'pcc', 'kcentra', 'idarucizumab', 'praxbind', 'andexanet', 'xa inhibitor'], tab: 'management', subTab: 'ich' },
              { name: 'VTE Prophylaxis', keywords: ['vte', 'dvt', 'pe', 'prophylaxis', 'enoxaparin', 'heparin', 'scds', 'ipc'], tab: 'management', subTab: 'ischemic' },
              { name: 'Post-EVT Management', keywords: ['post evt', 'post thrombectomy', 'dect', 'reperfusion', 'tici'], tab: 'management', subTab: 'ischemic' },
              { name: 'Dissection Management', keywords: ['dissection', 'carotid dissection', 'vertebral dissection', 'cervical'], tab: 'management', subTab: 'ischemic' },
              { name: 'Depression Screening', keywords: ['depression', 'phq', 'phq-2', 'phq-9', 'ssri', 'mood'], tab: 'encounter' },
              { name: 'Alteplase (tPA) Dosing', keywords: ['alteplase', 'tpa', 'activase', 'thrombolysis dose', 'bolus infusion'], tab: 'management', subTab: 'calculators' },
              { name: 'Bridging IVT + EVT', keywords: ['bridging', 'ivt before evt', 'direct to evt', 'swift direct', 'mr clean no iv'], tab: 'management', subTab: 'ischemic' },
              { name: 'ARCADIA (Atrial Cardiopathy)', keywords: ['arcadia', 'atrial cardiopathy', 'esus', 'cryptogenic', 'p-wave'], tab: 'management', subTab: 'ischemic' },
              { name: 'LAA Closure After ICH', keywords: ['laao', 'stroke-close', 'watchman', 'left atrial appendage', 'ich af'], tab: 'management', subTab: 'ich' },
              { name: 'Triple Therapy Warning', keywords: ['triple therapy', 'dapt doac', 'dual antiplatelet anticoagulant'], tab: 'encounter' },
              { name: 'PCC Dose Calculator', keywords: ['pcc', 'kcentra', '4f-pcc', 'prothrombin complex', 'warfarin reversal'], tab: 'management', subTab: 'calculators' },
              { name: 'Post-EVT Groin Care', keywords: ['groin', 'access site', 'post thrombectomy groin', 'hematoma', 'pulse check'], tab: 'management', subTab: 'ischemic' },
              { name: 'Pregnancy + EVT', keywords: ['pregnancy evt', 'pregnant thrombectomy', 'obstetric stroke'], tab: 'management', subTab: 'ischemic' },
              { name: 'Stroke Chameleons', keywords: ['chameleon', 'missed stroke', 'vertigo stroke', 'confusional state', 'psychiatric stroke'], tab: 'management', subTab: 'references' },
              { name: 'Spinal Cord Stroke', keywords: ['spinal cord', 'anterior spinal artery', 'myelopathy', 'aortic dissection', 'paraplegia'], tab: 'management', subTab: 'references' },
              { name: 'CTP Interpretation Guide', keywords: ['ctp', 'perfusion', 'tmax', 'cbv', 'cbf', 'rapid', 'penumbra', 'core'], tab: 'management', subTab: 'references' },
              { name: 'FUNC Score', keywords: ['func', 'functional outcome', 'ich prognosis'], tab: 'management', subTab: 'calculators' },
              { name: 'COMPASS Trial', keywords: ['compass', 'rivaroxaban aspirin', 'dual pathway', 'polyvascular', 'pad cad'], tab: 'management', subTab: 'ischemic' },
              { name: 'Nursing Parameters', keywords: ['nursing', 'parameters', 'call md', 'neuro checks', 'nurse communication'], tab: 'management', subTab: 'ischemic' },
              { name: 'Collateral Assessment', keywords: ['collateral', 'tan score', 'asitn', 'multiphase cta'], tab: 'management', subTab: 'references' },
              { name: 'Cancer-Associated Stroke', keywords: ['cancer', 'malignancy', 'trousseau', 'nbte', 'marantic', 'tumor', 'oncology'], tab: 'management', subTab: 'ischemic' },
              { name: 'Sickle Cell Stroke', keywords: ['sickle cell', 'scd', 'exchange transfusion', 'hbs', 'hemoglobin s'], tab: 'management', subTab: 'ischemic' },
              { name: 'Infective Endocarditis', keywords: ['endocarditis', 'mycotic aneurysm', 'vegetation', 'ie stroke', 'blood cultures'], tab: 'management', subTab: 'ischemic' },
              { name: 'Acute Seizure Treatment', keywords: ['seizure', 'status epilepticus', 'lorazepam', 'levetiracetam', 'fosphenytoin', 'benzodiazepine'], tab: 'management', subTab: 'ischemic' },
              { name: 'Glucose Management', keywords: ['glucose', 'insulin', 'hyperglycemia', 'hypoglycemia', 'shine trial', 'blood sugar'], tab: 'management', subTab: 'ischemic' }
            ];

            searchableItems.forEach(item => {
              const score = scoreFor([item.name, ...(item.keywords || [])], item.priority || 0);
              if (score > 0) {
                results.push({
                  type: 'Tool/Protocol',
                  title: item.name,
                  description: `Go to ${item.name}`,
                  score,
                  action: () => {
                    navigateTo(item.tab, { clearSearch: true, subTab: item.subTab });
                  }
                });
              }
            });

            // Search in Evidence documents
            const evidenceDocuments = [
              { title: 'DAPT Minor Stroke-TIA Trials', section: 'Antiplatelet Therapy', keywords: ['dapt', 'antiplatelet', 'tia', 'minor stroke'] },
              { title: 'DAPT After Ischemic Stroke-TIA', section: 'Antiplatelet Therapy', keywords: ['dapt', 'antiplatelet', 'duration', 'ischemic stroke', 'tia', 'sammpris', 'chance', 'point', 'thales', 'inspires', 'icad'] },
              { title: 'Timing of Anticoagulation after AF-Related Stroke', section: 'Risk Factors', keywords: ['anticoagulation', 'atrial fibrillation', 'afib', 'timing'] },
              { title: 'Atrial Fibrillation & Secondary Stroke Prevention', section: 'Risk Factors', keywords: ['afib', 'atrial fibrillation', 'prevention'] },
              { title: 'AFib Stroke EPI519', section: 'Risk Factors', keywords: ['afib', 'atrial fibrillation', 'epidemiology', 'stroke', 'epi', 'epi519'] },
              { title: 'Diabetes and stroke', section: 'Risk Factors', keywords: ['diabetes', 'risk factor', 'dm'] },
              { title: 'Lipids and Cerebrovascular Disease', section: 'Risk Factors', keywords: ['lipids', 'cholesterol', 'statins', 'ldl'] },
              { title: 'WAKE-UP Trial', section: 'Thrombolytic Therapy', keywords: ['wake-up', 'thrombolysis', 'tpa', 'alteplase', 'mri'] },
              { title: 'Thrombolytic Therapy AIS 4.5-24h RCTs', section: 'Thrombolytic Therapy', keywords: ['thrombolysis', 'tpa', 'alteplase', 'rct', 'extended window', '4.5-24h'] },
              { title: 'Lacunar Stroke', section: 'Cerebral Small Vessel Disease', keywords: ['lacunar', 'small vessel', 'csvd'] },
              { title: 'Symptomatic Cervical Carotid Artery Stenosis', section: 'Large Artery Disease', keywords: ['carotid', 'stenosis', 'endarterectomy', 'cea', 'cas'] },
              { title: 'CREST-2 Trial', section: 'Large Artery Disease', keywords: ['crest', 'crest-2', 'carotid', 'stenting', 'endarterectomy', 'cea', 'cas', 'asymptomatic'] },
              { title: 'Differentiating Acute Confusional State (Delirium) from Aphasia', section: 'Exam', keywords: ['delirium', 'aphasia', 'confusion', 'exam'] },
              { title: 'Coma Exam', section: 'Exam', keywords: ['coma', 'exam', 'consciousness'] },
              { title: 'Large Core Anterior Circulation LVO EVT Trials', section: 'Endovascular Therapy', keywords: ['large core', 'lvo', 'thrombectomy', 'evt'] },
              { title: 'Basilar Artery Occlusion EVT Trials', section: 'Endovascular Therapy', keywords: ['basilar', 'posterior circulation', 'evt'] },
              { title: 'MeVO & Distal Vessel Occlusion EVT Trials', section: 'Endovascular Therapy', keywords: ['mevo', 'distal', 'medium vessel'] },
              { title: 'Unruptured Cerebral Aneurysms', section: 'Aneurysms & Vascular Malformations', keywords: ['aneurysm', 'unruptured', 'sah'] },
              { title: 'Interpretation of Clinical Trials', section: 'Critical Appraisal', keywords: ['ebm', 'clinical trials', 'evidence', 'statistics', 'critical appraisal'] },
              { title: 'CEBM Oxford Resources', section: 'Critical Appraisal', keywords: ['cebm', 'oxford', 'ebm', 'evidence-based medicine', 'critical appraisal', 'study designs', 'levels of evidence'] }
            ];

            evidenceDocuments.forEach(doc => {
              const score = scoreFor([doc.title, doc.section, ...(doc.keywords || [])], doc.priority || 0);
              if (score > 0) {
                results.push({
                  type: 'Evidence',
                  title: doc.title,
                  description: `${doc.section} section`,
                  score,
                  action: () => {
                    navigateTo('management', { clearSearch: true, subTab: 'references' });
                  }
                });
              }
            });

            const dedupedResults = [];
            const seenResultKeys = new Set();
            results
              .sort((a, b) => (b.score || 0) - (a.score || 0))
              .forEach((result) => {
                const key = `${String(result.type || '').toLowerCase()}::${String(result.title || '').toLowerCase()}`;
                if (!seenResultKeys.has(key)) {
                  seenResultKeys.add(key);
                  dedupedResults.push(result);
                }
              });
            const limitedResults = dedupedResults.slice(0, 15);
            setSearchResults(limitedResults);
            setSearchActiveIndex(limitedResults.length > 0 ? 0 : -1);
          };

          const CLEAR_UNDO_WINDOW_MS = 30000;

          const buildCaseSnapshot = () => ({
            telestrokeNote: { ...telestrokeNote },
            strokeCodeForm: { ...strokeCodeForm },
            patientData: { ...patientData },
            lkwTime: lkwTime ? lkwTime.toISOString() : null,
            nihssScore,
            aspectsScore,
            mrsScore,
            gcsItems: { ...gcsItems },
            ichScoreItems: { ...ichScoreItems },
            abcd2Items: { ...abcd2Items },
            chads2vascItems: { ...chads2vascItems },
            ropeItems: { ...ropeItems },
            huntHessGrade,
            wfnsGrade,
            hasbledItems: { ...hasbledItems },
            rcvs2Items: { ...rcvs2Items },
            phasesItems: { ...phasesItems },
            currentStep,
            completedSteps: Array.isArray(completedSteps) ? [...completedSteps] : [],
            aspectsRegionState: Array.isArray(aspectsRegionState)
              ? aspectsRegionState.map((item) => ({ ...item }))
              : [],
            pcAspectsRegions: Array.isArray(pcAspectsRegions)
              ? pcAspectsRegions.map((item) => ({ ...item }))
              : [],
            consultationType,
            currentPatientId,
            evtDecisionInputs: { ...evtDecisionInputs },
            doacProtocol,
            nursingFlowsheetChecks: { ...nursingFlowsheetChecks },
            weightUnit,
            trialEligibility: { ...trialEligibility },
            ichVolumeParams: { ...ichVolumeParams },
            shiftPatients: Array.isArray(shiftPatients) ? [...shiftPatients] : [],
            encounterPhase,
            noteTemplate,
            elapsedSeconds,
            autoSyncCalculators
          });

          const restoreCaseSnapshot = (snapshot) => {
            if (!snapshot) return;
            const defaults = getDefaultTelestrokeNote();
            const savedNote = snapshot.telestrokeNote;
            let note;
            if (!savedNote) {
              note = defaults;
            } else {
              note = { ...defaults };
              for (const key of Object.keys(savedNote)) {
                if (savedNote[key] !== undefined && savedNote[key] !== null) {
                  if (typeof defaults[key] === 'object' && defaults[key] !== null && !Array.isArray(defaults[key])
                      && typeof savedNote[key] === 'object' && !Array.isArray(savedNote[key])) {
                    note[key] = { ...defaults[key], ...savedNote[key] };
                    // Two-level deep merge: restore default sub-objects (e.g. wakeUpStrokeWorkflow.dwi)
                    for (const subKey of Object.keys(defaults[key])) {
                      if (typeof defaults[key][subKey] === 'object' && defaults[key][subKey] !== null && !Array.isArray(defaults[key][subKey])
                          && typeof note[key][subKey] === 'object' && note[key][subKey] !== null && !Array.isArray(note[key][subKey])) {
                        note[key][subKey] = { ...defaults[key][subKey], ...note[key][subKey] };
                      } else if (note[key][subKey] === undefined || note[key][subKey] === null) {
                        note[key][subKey] = defaults[key][subKey];
                      }
                    }
                  } else {
                    note[key] = savedNote[key];
                  }
                }
              }
            }
            setTelestrokeNote(note);
            setStrokeCodeForm(snapshot.strokeCodeForm || getDefaultStrokeCodeForm());
            setPatientData(snapshot.patientData || {});
            setLkwTime(safeParseDt(snapshot.lkwTime));
            setNihssScore(snapshot.nihssScore || 0);
            setAspectsScore(Number.isFinite(snapshot.aspectsScore) ? snapshot.aspectsScore : 10);
            setMrsScore(snapshot.mrsScore || '');
            setGcsItems(snapshot.gcsItems || { eye: '', verbal: '', motor: '' });
            setIchScoreItems(snapshot.ichScoreItems || { gcs: '', age80: false, volume30: false, ivh: false, infratentorial: false, lobar: false, preCogImpairment: false });
            setAbcd2Items(snapshot.abcd2Items || { age60: false, bp: false, unilateralWeakness: false, speechDisturbance: false, duration: '', diabetes: false });
            setChads2vascItems(snapshot.chads2vascItems || { chf: false, hypertension: false, age75: false, diabetes: false, strokeTia: false, vascular: false, age65: false, female: false });
            setRopeItems(snapshot.ropeItems || { noHypertension: false, noDiabetes: false, noStrokeTia: false, nonsmoker: false, cortical: false, age: '' });
            setHuntHessGrade(snapshot.huntHessGrade || '');
            setWfnsGrade(snapshot.wfnsGrade || '');
            setHasbledItems(snapshot.hasbledItems || { hypertension: false, renalDisease: false, liverDisease: false, stroke: false, bleeding: false, labileINR: false, elderly: false, drugs: false, alcohol: false });
            setRcvs2Items(snapshot.rcvs2Items || { recurrentTCH: false, carotidInvolvement: false, vasoconstrictiveTrigger: false, female: false, sah: false });
            setPhasesItems(snapshot.phasesItems || { population: 'north_american', hypertension: false, age70: false, size: '', earlierSAH: false, site: 'ica' });
            setCurrentStep(Number.isFinite(snapshot.currentStep) ? snapshot.currentStep : 0);
            setCompletedSteps(Array.isArray(snapshot.completedSteps) ? snapshot.completedSteps : []);
            setAspectsRegionState(Array.isArray(snapshot.aspectsRegionState) && snapshot.aspectsRegionState.length
              ? snapshot.aspectsRegionState
              : getDefaultAspectsRegionState());
            setPcAspectsRegions(Array.isArray(snapshot.pcAspectsRegions) && snapshot.pcAspectsRegions.length
              ? snapshot.pcAspectsRegions
              : getDefaultPcAspectsRegions());
            setConsultationType(snapshot.consultationType || settings.defaultConsultationType || 'telephone');
            setCurrentPatientId(snapshot.currentPatientId || null);
            setEvtDecisionInputs(snapshot.evtDecisionInputs || { population: 'adult', occlusion: 'lvo', timeWindow: 'auto', aspects: '6-10', mrs: '0-1', nihss: '', pcAspects: '>=6' });
            setDoacProtocol(snapshot.doacProtocol || 'catalyst');
            setNursingFlowsheetChecks(snapshot.nursingFlowsheetChecks || {});
            setWeightUnit(snapshot.weightUnit || 'kg');
            setTrialEligibility(snapshot.trialEligibility || {});
            setIchVolumeParams(snapshot.ichVolumeParams || { a: '', b: '', thicknessMm: '', numSlices: '' });
            setShiftPatients(Array.isArray(snapshot.shiftPatients) ? snapshot.shiftPatients : []);
            if (snapshot.encounterPhase) setEncounterPhase(snapshot.encounterPhase);
            if (snapshot.noteTemplate) setNoteTemplate(snapshot.noteTemplate);
            if (Number.isFinite(snapshot.elapsedSeconds)) setElapsedSeconds(snapshot.elapsedSeconds);
            if (snapshot.autoSyncCalculators !== undefined) setAutoSyncCalculators(snapshot.autoSyncCalculators);
            decisionStateRef.current = {
              tnkRecommended: note.tnkRecommended,
              evtRecommended: note.evtRecommended,
              transferAccepted: note.transferAccepted,
              tnkContraindicationReviewed: note.tnkContraindicationReviewed,
              tnkConsentDiscussed: note.tnkConsentDiscussed,
              tnkAdminTime: note.tnkAdminTime
            };
          };

          const resetCaseState = () => {
            // Cancel pending batch save to prevent stale data from being re-persisted
            if (batchSaveTimerRef.current) {
              clearTimeout(batchSaveTimerRef.current);
              batchSaveTimerRef.current = null;
            }
            pendingWritesRef.current = {};

            setPatientData({});
            setNihssScore(0);
            setAspectsScore(10);
            setLkwTime(new Date());
            setStrokeCodeForm(getDefaultStrokeCodeForm());
            setAspectsRegionState(getDefaultAspectsRegionState());
            setPcAspectsRegions(getDefaultPcAspectsRegions());
            setGcsItems({ eye: '', verbal: '', motor: '' });
            setMrsScore('');
            setIchScoreItems({ gcs: '', age80: false, volume30: false, ivh: false, infratentorial: false, lobar: false, preCogImpairment: false });
            setAbcd2Items({ age60: false, bp: false, unilateralWeakness: false, speechDisturbance: false, duration: '', diabetes: false });
            setChads2vascItems({ chf: false, hypertension: false, age75: false, diabetes: false, strokeTia: false, vascular: false, age65: false, female: false });
            setRopeItems({ noHypertension: false, noDiabetes: false, noStrokeTia: false, nonsmoker: false, cortical: false, age: '' });
            setHuntHessGrade('');
            setWfnsGrade('');
            setHasbledItems({ hypertension: false, renalDisease: false, liverDisease: false, stroke: false, bleeding: false, labileINR: false, elderly: false, drugs: false, alcohol: false });
            setRcvs2Items({ recurrentTCH: false, carotidInvolvement: false, vasoconstrictiveTrigger: false, female: false, sah: false });
            setPhasesItems({ population: 'north_american', hypertension: false, age70: false, size: '', earlierSAH: false, site: 'ica' });
            setCurrentStep(0);
            setCompletedSteps([]);
            setConsultationType(settings.defaultConsultationType || 'telephone');
            setTelestrokeNote(getDefaultTelestrokeNote());
            setEvtDecisionInputs({ population: 'adult', occlusion: 'lvo', timeWindow: 'auto', aspects: '6-10', mrs: '0-1', nihss: '', pcAspects: '>=6' });
            setDoacProtocol('catalyst');
            setNursingFlowsheetChecks({});
            setWeightUnit('kg');
            setTrialEligibility({});
            setEncounterPhase('phase-triage');
            setNoteTemplate('consult');
            setCalcDrawerOpen(false);
            setLastAlertPlayed(null);
            setAlertFlashing(false);
            setElapsedSeconds(0);
            setEditableTemplate(defaultTelestrokeTemplate);
            setCriticalAlerts([]);
            setDeidWarnings({});
            setIchVolumeParams({ a: '', b: '', thicknessMm: '', numSlices: '' });
            setPathwayCollapsed(true);
            setGuidelineRecsExpanded(false);
            setShiftPatients([]);
            setCurrentPatientId(null);
            setAutoSyncCalculators(true);
            decisionStateRef.current = { tnkRecommended: false, evtRecommended: false, transferAccepted: false, tnkContraindicationReviewed: false, tnkConsentDiscussed: false, tnkAdminTime: null };

            const keysToRemove = ['patientData', 'nihssScore', 'aspectsScore', 'gcsItems', 'mrsScore', 'ichScoreItems',
                                  'abcd2Items', 'chads2vascItems', 'ropeItems', 'huntHessGrade', 'wfnsGrade',
                                  'hasbledItems', 'rcvs2Items', 'phasesItems', 'strokeCodeForm', 'lkwTime',
                                  'currentStep', 'completedSteps', 'aspectsRegionState', 'pcAspectsRegions',
                                  'telestrokeNote', 'consultationType',
                                  'evtDecisionInputs', 'doacProtocol', 'nursingFlowsheetChecks',
                                  'ichVolumeParams', 'weightUnit', 'trialEligibility', 'encounterPhase', 'noteTemplate',
                                  'telestrokeTemplate', 'shiftPatients', 'currentPatientId',
                                  'autoSyncCalculators', 'activeTab',
                                  'thrombolysisAlertsMuted', 'encounterHistory'];
            keysToRemove.forEach((key) => removeKey(key));

            navigateTo('encounter');
            setSaveStatus('saved');
          };

          const clearCurrentCase = async (options = {}) => {
            const { generateNewId = false } = options;
            const confirmed = await showConfirm({
              title: 'Start New Case',
              message: 'Current inputs will be cleared. You can undo for 30 seconds.',
              confirmLabel: 'Clear Case',
              danger: true
            });
            if (!confirmed) return;
            saveEncounterToHistory();
            const snapshot = buildCaseSnapshot();
            resetCaseState();
            if (generateNewId) {
              setCurrentPatientId(generatePatientId());
            }

            setClearUndo({ snapshot, expiresAt: Date.now() + CLEAR_UNDO_WINDOW_MS });
            if (clearUndoTimeoutRef.current) {
              clearTimeout(clearUndoTimeoutRef.current);
            }
            clearUndoTimeoutRef.current = setTimeout(() => {
              setClearUndo(null);
            }, CLEAR_UNDO_WINDOW_MS);
            showNotice('Case cleared. Undo available for 30 seconds.', 'info');
          };

          const handleUndoClearCase = () => {
            if (!clearUndo || !clearUndo.snapshot) return;
            restoreCaseSnapshot(clearUndo.snapshot);
            setClearUndo(null);
            if (clearUndoTimeoutRef.current) {
              clearTimeout(clearUndoTimeoutRef.current);
              clearUndoTimeoutRef.current = null;
            }
            showNotice('Case restored.', 'success');
          };

          // Reset all data - New Patient
          const resetAllData = async () => {
            const confirmed = await showConfirm({
              title: 'Reset All Data',
              message: 'All current data will be cleared. This cannot be undone.',
              confirmLabel: 'Reset Everything',
              danger: true
            });
            if (!confirmed) return;
            saveEncounterToHistory();
            resetCaseState();
          };

          const handleClearLocalData = async () => {
            const confirmed = await showConfirm({
              title: 'Clear Local Data',
              message: 'This clears all locally stored app data on this device. This cannot be undone.',
              confirmLabel: 'Clear All Data',
              danger: true
            });
            if (!confirmed) return;

            clearAllAppStorage();
            resetAppStateToDefaults();
            navigateTo('encounter');
            showNotice('Local data cleared.', 'success');
          };

          const removeLegacyKeysAfterMigration = () => {
            LEGACY_KEYS.forEach((key) => {
              try {
                localStorage.removeItem(key);
              } catch (e) {
                console.warn('Failed to remove legacy key:', key, e);
              }
            });
            showNotice('Legacy keys removed.', 'success');
          };

          const importBackup = async (file) => {
            try {
              const data = await importJSON(file);
              const candidate = data.schemaVersion ? data : data.appData ? data.appData : null;
              if (!candidate) {
                showNotice('Backup import failed: invalid file.', 'error');
                return;
              }
              const merged = mergeAppData(getDefaultAppData(), candidate);
              const migrated = migrateAppData(merged);
              setAppData(migrated);
              showNotice('Backup imported.', 'success');
            } catch (e) {
              showNotice('Backup import failed.', 'error');
            }
          };

          // Workflow steps definition
          const workflowSteps = [
            { id: 'assessment', name: 'Initial Assessment', tab: 'workflow' },
            { id: 'nihss', name: 'NIHSS Score', tab: 'nihss' },
            { id: 'imaging', name: 'Imaging Review', tab: 'imaging' },
            { id: 'eligibility', name: 'Treatment Eligibility', tab: 'lytic' },
            { id: 'documentation', name: 'Documentation', tab: 'encounter' }
          ];

          // Save to local storage whenever state changes
          useEffect(() => {
            debouncedSave('activeTab', activeTab);
          }, [activeTab]);

          // Persist timer sidebar collapse state
          useEffect(() => {
            setKey('timerSidebarCollapsed', timerSidebarCollapsed, { skipLastUpdated: true });
          }, [timerSidebarCollapsed]);



          useEffect(() => {
            if (!('serviceWorker' in navigator)) return;
            navigator.serviceWorker.register('service-worker.js').catch((err) => {
              console.warn('Service worker registration failed:', err);
            });
          }, []);

          // Click-outside handler for search dropdown (replaces fragile setTimeout blur hack)
          useEffect(() => {
            const handleClickOutside = (e) => {
              if (searchContainerRef.current && !searchContainerRef.current.contains(e.target)) {
                setSearchOpen(false);
              }
            };
            if (searchOpen) {
              document.addEventListener('mousedown', handleClickOutside);
              return () => document.removeEventListener('mousedown', handleClickOutside);
            }
          }, [searchOpen]);

          // Mermaid initialization and strokeMermaidClick removed — algorithms now use JSX


          // decisionStateRef initialization removed — the effect at line ~12035 handles this with proper deps

          // Persist consultation type
          useEffect(() => {
            debouncedSave('consultationType', consultationType);
          }, [consultationType]);

          useEffect(() => {
            debouncedSave('patientData', patientData);
            const newScore = calculateNIHSS(patientData);
            if (newScore !== nihssScore) {
              setNihssScore(newScore);
            }
          }, [patientData]);

          // Consolidated calculator state persistence
          useEffect(() => {
            debouncedSave('nihssScore', nihssScore);
            debouncedSave('aspectsScore', aspectsScore);
            debouncedSave('gcsItems', gcsItems);
            debouncedSave('mrsScore', mrsScore);
            debouncedSave('ichScoreItems', ichScoreItems);
            debouncedSave('ichVolumeParams', ichVolumeParams);
            debouncedSave('abcd2Items', abcd2Items);
            debouncedSave('chads2vascItems', chads2vascItems);
            debouncedSave('ropeItems', ropeItems);
            debouncedSave('huntHessGrade', huntHessGrade);
            debouncedSave('wfnsGrade', wfnsGrade);
            debouncedSave('hasbledItems', hasbledItems);
            debouncedSave('rcvs2Items', rcvs2Items);
            debouncedSave('phasesItems', phasesItems);
            debouncedSave('autoSyncCalculators', autoSyncCalculators);
            debouncedSave('evtDecisionInputs', evtDecisionInputs);
            debouncedSave('doacProtocol', doacProtocol);
            debouncedSave('noteTemplate', noteTemplate);
            debouncedSave('weightUnit', weightUnit);
          }, [nihssScore, aspectsScore, gcsItems, mrsScore, ichScoreItems, ichVolumeParams, abcd2Items,
              chads2vascItems, ropeItems, huntHessGrade, wfnsGrade, hasbledItems,
              rcvs2Items, phasesItems, autoSyncCalculators, evtDecisionInputs, doacProtocol, noteTemplate, weightUnit]);

          useEffect(() => {
            debouncedSave('strokeCodeForm', sanitizeStrokeCodeFormForStorage(strokeCodeForm));
          }, [strokeCodeForm, settings.allowFreeTextStorage]);

          useEffect(() => {
            debouncedSave('aspectsRegionState', aspectsRegionState);
          }, [aspectsRegionState]);

          useEffect(() => {
            debouncedSave('pcAspectsRegions', pcAspectsRegions);
          }, [pcAspectsRegions]);

          useEffect(() => {
            debouncedSave('telestrokeNote', sanitizeTelestrokeNoteForStorage(telestrokeNote));
          }, [telestrokeNote, settings.allowFreeTextStorage]);

          useEffect(() => {
            const inrVal = parseFloat(telestrokeNote.inr);
            const ptVal = parseFloat(telestrokeNote.pt);
            const pltVal = parseInt(telestrokeNote.plateletCount, 10);
            const pttVal = parseFloat(telestrokeNote.ptt);
            const glucVal = parseFloat(telestrokeNote.glucose);
            const warfarinWithHighINR = (telestrokeNote.lastDOACType === 'warfarin' || telestrokeNote.lastDOACType === 'none' || !telestrokeNote.lastDOACType) && !Number.isNaN(inrVal) && inrVal > 1.7;
            const warfarinWithHighPT = telestrokeNote.lastDOACType === 'warfarin' && !Number.isNaN(ptVal) && ptVal > 15;
            const lowPlatelets = !Number.isNaN(pltVal) && pltVal < 100;
            const elevatedAPTT = !Number.isNaN(pttVal) && pttVal > 40;
            const lowGlucose = !Number.isNaN(glucVal) && glucVal < 50;
            const isICH = telestrokeNote.diagnosisCategory === 'ich' || telestrokeNote.diagnosisCategory === 'sah';
            // DOAC clearance-aware auto-block: only block if <97% cleared
            const doacType = telestrokeNote.lastDOACType;
            let recentDOAC = false;
            let doacClearanceNote = '';
            if (doacType && doacType !== 'warfarin' && doacType !== 'none') {
              const lastDose = telestrokeNote.lastDOACDose ? new Date(telestrokeNote.lastDOACDose) : null;
              if (lastDose && !Number.isNaN(lastDose.getTime())) {
                const hoursSince = (Date.now() - lastDose.getTime()) / (1000 * 60 * 60);
                if (hoursSince >= 0) {
                  const crcl = calculateCrCl(telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.height);
                  const crclVal = crcl ? crcl.value : null;
                  const halfLifeMap = { apixaban: crclVal && crclVal < 30 ? 15 : 10, rivaroxaban: crclVal && crclVal < 30 ? 13 : 9, dabigatran: crclVal && crclVal < 30 ? 28 : crclVal && crclVal < 50 ? 18 : 14, edoxaban: crclVal && crclVal < 30 ? 16 : 12 };
                  const estHalfLife = halfLifeMap[doacType] || 12;
                  const halfLives = hoursSince / estHalfLife;
                  const clearancePct = Math.min(99.9, (1 - Math.pow(0.5, halfLives)) * 100);
                  if (clearancePct < 97) {
                    recentDOAC = true;
                    doacClearanceNote = ` (~${clearancePct.toFixed(0)}% cleared)`;
                  }
                } else {
                  recentDOAC = true; // future date = can't calculate, block to be safe
                  doacClearanceNote = ' (dose time in future — verify)';
                }
              } else {
                recentDOAC = true; // no dose time entered, block to be safe
                doacClearanceNote = ' (last dose time unknown)';
              }
            }
            // Recent surgery auto-block
            const recentSurgery = !!(telestrokeNote.tnkContraindicationChecklist?.recentIntracranialSurgery || telestrokeNote.tnkContraindicationChecklist?.recentMajorSurgery);
            const hasIE = !!telestrokeNote.infectiveEndocarditis;
            const shouldBlock = warfarinWithHighINR || warfarinWithHighPT || lowPlatelets || elevatedAPTT || lowGlucose || isICH || recentDOAC || hasIE || recentSurgery;
            if (shouldBlock) {
              const reasons = [];
              if (warfarinWithHighINR) reasons.push(`INR ${inrVal.toFixed(1)} (>1.7)${telestrokeNote.lastDOACType === 'warfarin' ? ' — warfarin' : ' — elevated INR'}`);
              if (warfarinWithHighPT) reasons.push(`Warfarin with PT ${ptVal.toFixed(1)}s (>15s)`);
              if (lowPlatelets) reasons.push(`Platelets ${pltVal}K (<100K)`);
              if (elevatedAPTT) reasons.push(`aPTT ${pttVal}s (>40s)`);
              if (lowGlucose) reasons.push(`Glucose ${glucVal} mg/dL (<50) — correct and update to unblock`);
              if (isICH) reasons.push(telestrokeNote.diagnosisCategory === 'sah' ? 'SAH diagnosis' : 'ICH diagnosis');
              if (hasIE) reasons.push('Infective endocarditis (Class III: TNK contraindicated)');
              if (recentDOAC) {
                const doacName = ANTICOAGULANT_INFO[doacType]?.name || doacType;
                const dttNote = doacType === 'dabigatran' ? ' — check dTT/ECT; TNK may be given if dTT/ECT normal or aPTT <40s' : '';
                reasons.push(`Recent ${doacName}${doacClearanceNote}${dttNote}`);
              }
              if (recentSurgery) {
                const surgTypes = [];
                if (telestrokeNote.tnkContraindicationChecklist?.recentIntracranialSurgery) surgTypes.push('intracranial/intraspinal');
                if (telestrokeNote.tnkContraindicationChecklist?.recentMajorSurgery) surgTypes.push('major extracranial');
                reasons.push(`Recent ${surgTypes.join(' & ')} surgery`);
              }
              const reasonStr = reasons.join('; ');
              setTelestrokeNote(prev => {
                if (prev.tnkAutoBlocked && prev.tnkRecommended === false && prev.tnkAutoBlockReason === reasonStr) return prev;
                return { ...prev, tnkRecommended: false, tnkAutoBlocked: true, tnkAutoBlockReason: reasonStr };
              });
            } else {
              setTelestrokeNote(prev => prev.tnkAutoBlocked ? { ...prev, tnkAutoBlocked: false, tnkAutoBlockReason: '' } : prev);
            }
          }, [telestrokeNote.lastDOACType, telestrokeNote.lastDOACDose, telestrokeNote.inr, telestrokeNote.pt, telestrokeNote.plateletCount, telestrokeNote.ptt, telestrokeNote.glucose, telestrokeNote.diagnosisCategory, telestrokeNote.infectiveEndocarditis, telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.tnkContraindicationChecklist?.recentIntracranialSurgery, telestrokeNote.tnkContraindicationChecklist?.recentMajorSurgery]);

          useEffect(() => {
            const prev = decisionStateRef.current;
            if (!prev.tnkRecommended && telestrokeNote.tnkRecommended) {
              addDecisionLogEntry('TNK recommended');
            }
            if (!prev.evtRecommended && telestrokeNote.evtRecommended) {
              addDecisionLogEntry('EVT recommended');
            }
            if (!prev.transferAccepted && telestrokeNote.transferAccepted) {
              addDecisionLogEntry('Transfer accepted');
            }
            if (!prev.tnkContraindicationReviewed && telestrokeNote.tnkContraindicationReviewed) {
              addDecisionLogEntry('TNK contraindications reviewed', telestrokeNote.tnkContraindicationReviewTime || '');
            }
            if (!prev.tnkConsentDiscussed && telestrokeNote.tnkConsentDiscussed) {
              addDecisionLogEntry('TNK consent discussed');
            }
            if (prev.tnkAdminTime !== telestrokeNote.tnkAdminTime && telestrokeNote.tnkAdminTime) {
              addDecisionLogEntry('TNK administered', telestrokeNote.tnkAdminTime);
            }
            decisionStateRef.current = {
              tnkRecommended: telestrokeNote.tnkRecommended,
              evtRecommended: telestrokeNote.evtRecommended,
              transferAccepted: telestrokeNote.transferAccepted,
              tnkContraindicationReviewed: telestrokeNote.tnkContraindicationReviewed,
              tnkConsentDiscussed: telestrokeNote.tnkConsentDiscussed,
              tnkAdminTime: telestrokeNote.tnkAdminTime
            };
          }, [
            telestrokeNote.tnkRecommended,
            telestrokeNote.evtRecommended,
            telestrokeNote.transferAccepted,
            telestrokeNote.tnkContraindicationReviewed,
            telestrokeNote.tnkConsentDiscussed,
            telestrokeNote.tnkAdminTime
          ]);

          // Auto-switch trial category when diagnosis category changes
          useEffect(() => {
            const inferredTrialCategory = getTrialTabCategory(telestrokeNote.diagnosisCategory, telestrokeNote.diagnosis);
            if (!inferredTrialCategory) return;

            setTrialsCategory((prev) => {
              return prev === inferredTrialCategory ? prev : inferredTrialCategory;
            });
          }, [telestrokeNote.diagnosisCategory, telestrokeNote.diagnosis]);

          // Auto-set BP phase based on diagnosis and treatment context
          useEffect(() => {
            const cat = telestrokeNote.diagnosisCategory;
            if (cat === 'ich') {
              setTelestrokeNote(prev => prev.bpPhase === 'ich' ? prev : { ...prev, bpPhase: 'ich' });
            } else if (cat === 'sah') {
              setTelestrokeNote(prev => prev.bpPhase === 'sah' ? prev : { ...prev, bpPhase: 'sah' });
            } else if (cat === 'ischemic') {
              // Revert from ICH/SAH phase to pre-tnk default when switching to ischemic
              setTelestrokeNote(prev => (prev.bpPhase === 'ich' || prev.bpPhase === 'sah') ? { ...prev, bpPhase: 'pre-tnk' } : prev);
            }
          }, [telestrokeNote.diagnosisCategory]);

          // Auto-switch BP phase to post-TNK when TNK is administered
          useEffect(() => {
            if (telestrokeNote.tnkAdminTime) {
              setTelestrokeNote(prev => prev.bpPhase === 'pre-tnk' ? { ...prev, bpPhase: 'post-tnk' } : prev);
            }
          }, [telestrokeNote.tnkAdminTime]);

          // Auto-switch BP phase to post-EVT when EVT recommended (without TNK)
          useEffect(() => {
            if (telestrokeNote.evtRecommended && !telestrokeNote.tnkRecommended) {
              setTelestrokeNote(prev => prev.bpPhase === 'pre-tnk' ? { ...prev, bpPhase: 'post-evt' } : prev);
            }
          }, [telestrokeNote.evtRecommended, telestrokeNote.tnkRecommended]);

          useEffect(() => {
            debouncedSave('telestrokeTemplate', editableTemplate);
          }, [editableTemplate]);

          useEffect(() => {
            if (lkwTime) {
              debouncedSave('lkwTime', lkwTime.toISOString());
              // Sync Date state → telestrokeNote string fields for note templates
              const dateStr = `${lkwTime.getFullYear()}-${String(lkwTime.getMonth() + 1).padStart(2, '0')}-${String(lkwTime.getDate()).padStart(2, '0')}`;
              const timeStr = lkwTime.toTimeString().slice(0, 5);
              setTelestrokeNote(prev => {
                if (prev.lkwDate === dateStr && prev.lkwTime === timeStr) return prev;
                return { ...prev, lkwDate: dateStr, lkwTime: timeStr };
              });
            }
          }, [lkwTime]);

          useEffect(() => {
            debouncedSave('currentStep', currentStep);
          }, [currentStep]);

          useEffect(() => {
            debouncedSave('completedSteps', completedSteps);
          }, [completedSteps]);

          useEffect(() => {
            debouncedSave('shiftPatients', shiftPatients);
          }, [shiftPatients]);

          useEffect(() => {
            debouncedSave('currentPatientId', currentPatientId);
          }, [currentPatientId]);

          // Auto-populate Documentation form with Workflow data
          useEffect(() => {
            if (lkwTime) {
              const timeStr = lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
              const dateStr = lkwTime.toLocaleDateString('en-US');
              // Use local date format to avoid timezone issues
              const localDateStr = `${lkwTime.getFullYear()}-${String(lkwTime.getMonth() + 1).padStart(2, '0')}-${String(lkwTime.getDate()).padStart(2, '0')}`;
              setStrokeCodeForm(prev => ({
                ...prev,
                lkw: timeStr,
                lkw_date: localDateStr
              }));
            }
          }, [lkwTime]);

          useEffect(() => {
            if (nihssScore !== null && nihssScore !== undefined) {
              setStrokeCodeForm(prev => ({
                ...prev,
                nihss: nihssScore.toString()
              }));
            }
          }, [nihssScore]);

          useEffect(() => {
            if (aspectsScore !== null && aspectsScore !== undefined) {
              setStrokeCodeForm(prev => ({
                ...prev,
                aspects: aspectsScore.toString()
              }));
            }
          }, [aspectsScore]);

          // Update current time every 15 seconds (responsive during pre-LKW triage)
          useEffect(() => {
            const timer = setInterval(() => setCurrentTime(new Date()), 15000);
            return () => clearInterval(timer);
          }, []);

          // Flush pending saves on page unload/hide to prevent data loss
          useEffect(() => {
            const flushSave = () => {
              try {
                // Flush pending batched writes first
                if (Object.keys(pendingWritesRef.current).length > 0) {
                  const writes = { ...pendingWritesRef.current };
                  pendingWritesRef.current = {};
                  if (batchSaveTimerRef.current) clearTimeout(batchSaveTimerRef.current);
                  for (const [k, v] of Object.entries(writes)) {
                    saveWithExpiration(k, v);
                  }
                }
                // Then flush the latest telestrokeNote
                const data = sanitizeTelestrokeNoteForStorage(telestrokeNote);
                setKey('telestrokeNote', data);
              } catch (e) { /* best-effort */ }
            };
            const handleBeforeUnload = (e) => {
              flushSave();
            };
            const handleVisibilityChange = () => {
              if (document.visibilityState === 'hidden') flushSave();
            };
            window.addEventListener('beforeunload', handleBeforeUnload);
            document.addEventListener('visibilitychange', handleVisibilityChange);
            return () => {
              window.removeEventListener('beforeunload', handleBeforeUnload);
              document.removeEventListener('visibilitychange', handleVisibilityChange);
              // Flush any pending batched writes on cleanup
              if (batchSaveTimerRef.current) {
                clearTimeout(batchSaveTimerRef.current);
                batchSaveTimerRef.current = null;
              }
              const pendingWrites = { ...pendingWritesRef.current };
              pendingWritesRef.current = {};
              for (const [k, v] of Object.entries(pendingWrites)) {
                try { setKey(k, v); } catch (e) { if (e.name === 'QuotaExceededError' || e.code === 22) { addToast('Storage full — data may not be saved. Export your note or clear old data.', 'error'); } }
              }
            };
          }, [telestrokeNote]);

          // Storage quota exceeded listener
          React.useEffect(() => {
            const handleQuota = () => addToast('Storage full — data may not be saved. Export your note and clear old data via Settings > Clear All Data.', 'error');
            document.addEventListener('storage-quota-exceeded', handleQuota);
            return () => document.removeEventListener('storage-quota-exceeded', handleQuota);
          }, []);

          // ============================================================
          // THROMBOLYSIS WINDOW TIMER & AUDIBLE ALERTS
          // ============================================================

          // Web Audio API alert function — reuse single AudioContext to avoid browser limit
          const audioContextRef = useRef(null);
          const getAudioContext = () => {
            if (!audioContextRef.current || audioContextRef.current.state === 'closed') {
              audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContextRef.current.state === 'suspended') {
              audioContextRef.current.resume();
            }
            return audioContextRef.current;
          };

          const playAlertTone = (alertType) => {
            if (alertsMuted) return;

            try {
              const audioContext = getAudioContext();

              // Different tones for different alert types
              const toneConfigs = {
                'warning-30': { freq: 440, duration: 0.3, repeat: 2 },   // A4 - two beeps for 30 min warning
                'warning-15': { freq: 523, duration: 0.3, repeat: 3 },   // C5 - three beeps for 15 min warning
                'window-closed': { freq: 659, duration: 0.5, repeat: 4 } // E5 - four beeps for window closed
              };

              const config = toneConfigs[alertType] || toneConfigs['warning-30'];

              // Play repeating tones
              let currentTime = audioContext.currentTime;
              for (let i = 0; i < config.repeat; i++) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.frequency.setValueAtTime(config.freq, currentTime);
                osc.type = 'sine';

                gain.gain.setValueAtTime(0, currentTime);
                gain.gain.linearRampToValueAtTime(0.3, currentTime + 0.05);
                gain.gain.linearRampToValueAtTime(0.3, currentTime + config.duration - 0.1);
                gain.gain.linearRampToValueAtTime(0, currentTime + config.duration);

                osc.start(currentTime);
                osc.stop(currentTime + config.duration);

                currentTime += config.duration + 0.15; // Gap between beeps
              }
            } catch (e) {
              console.warn('Audio alert not supported:', e);
            }
          };

          // Toggle mute and persist to localStorage
          const toggleAlertMute = () => {
            const newMuted = !alertsMuted;
            setAlertsMuted(newMuted);
            setKey('thrombolysisAlertsMuted', newMuted, { skipLastUpdated: true });
          };

          // Second-level timer for elapsed time and alert checking
          // Runs on all tabs when LKW is set — timer strip + alerts must stay live
          useEffect(() => {
            if (!lkwTime) return;

            const checkAlertsAndUpdate = () => {
              const now = new Date();
              const diffMs = Math.max(0, now - lkwTime);
              const diffMinutes = diffMs / (1000 * 60);
              const remainingMinutes = (4.5 * 60) - diffMinutes; // Minutes until 4.5h window closes

              setElapsedSeconds(Math.floor(diffMs / 1000));
              setCurrentTime(now);

              // Only check alerts if tab is visible and LKW is set
              if (document.hidden || !lkwTime) return;

              // Check for alert thresholds (within 30 seconds of the threshold)
              const alertThresholds = [
                { id: 'warning-30', minutesRemaining: 30, played: false },
                { id: 'warning-15', minutesRemaining: 15, played: false },
                { id: 'window-closed', minutesRemaining: 0, played: false }
              ];

              for (const threshold of alertThresholds) {
                // Check if we're within 30 seconds of this threshold
                const diff = Math.abs(remainingMinutes - threshold.minutesRemaining);
                if (diff < 0.5 && lastAlertPlayedRef.current !== threshold.id && remainingMinutes >= -1) {
                  // Play alert and flash
                  lastAlertPlayedRef.current = threshold.id;
                  setLastAlertPlayed(threshold.id);
                  playAlertTone(threshold.id);
                  setAlertFlashing(true);

                  // Stop flashing after 10 seconds (clear previous timeout to prevent accumulation)
                  if (alertFlashTimeoutRef.current) clearTimeout(alertFlashTimeoutRef.current);
                  alertFlashTimeoutRef.current = setTimeout(() => setAlertFlashing(false), 10000);
                  break;
                }
              }
            };

            // Initial check
            checkAlertsAndUpdate();

            // Update every second for precise timing
            const timer = setInterval(checkAlertsAndUpdate, 1000);

            return () => {
              clearInterval(timer);
              if (alertFlashTimeoutRef.current) clearTimeout(alertFlashTimeoutRef.current);
            };
          }, [lkwTime, alertsMuted]);

          // Reset last alert when LKW changes
          useEffect(() => {
            lastAlertPlayedRef.current = null;
            setLastAlertPlayed(null);
            setAlertFlashing(false);
          }, [lkwTime]);

          // =================================================================
          // TRIAL ELIGIBILITY - Auto-update when form data changes
          // =================================================================
          useEffect(() => {
            const timeFromLKW = calculateTimeFromLKW();
            const hoursFromLKW = timeFromLKW ? timeFromLKW.total : null;

            const evaluationData = {
              telestrokeNote,
              strokeCodeForm,
              aspectsScore,
              nihssScore,
              mrsScore,
              gcsScore: calculateGCS(gcsItems),
              hoursFromLKW,
              lkwTime
            };

            const results = evaluateAllTrials(evaluationData);
            setTrialEligibility(prev => {
              const prevStr = JSON.stringify(prev);
              const nextStr = JSON.stringify(results);
              return prevStr === nextStr ? prev : results;
            });
          }, [telestrokeNote, strokeCodeForm, aspectsScore, nihssScore, mrsScore, gcsItems, lkwTime]);

          // Monitor scroll position for Part 6 (Treatment Decision) visibility

          // Monitor critical alerts
          useEffect(() => {
            const alerts = [];

            if (lkwTime) {
              const timeFromLKW = calculateTimeFromLKW();
              if (!timeFromLKW) return;

              const totalHours = timeFromLKW.total;
              const remainingToTNK = 4.5 - totalHours;
              const remainingToEVT = 6 - totalHours;

              // Alert if <30 min to TNK cutoff (4.5h)
              if (remainingToTNK > 0 && remainingToTNK <= 0.5) {
                const minsLeft = Math.floor(remainingToTNK * 60);
                alerts.push({
                  id: 'tnk-cutoff',
                  level: 'critical',
                  message: `URGENT: Only ${minsLeft} minutes left for TNK window!`,
                  action: 'TNK must be given before 4.5h from LKW'
                });
              }

              // Alert if <30 min to early EVT cutoff (6h)
              if (remainingToEVT > 0 && remainingToEVT <= 0.5 && totalHours > 4.5) {
                const minsLeft = Math.floor(remainingToEVT * 60);
                alerts.push({
                  id: 'evt-cutoff',
                  level: 'critical',
                  message: `URGENT: Only ${minsLeft} minutes left for early EVT window!`,
                  action: 'Consider EVT before 6h window requires perfusion imaging'
                });
              }
            }

            const timeAlertIds = ['tnk-cutoff', 'evt-cutoff'];
            setCriticalAlerts(prev => {
              const nonTimeAlerts = prev.filter(a => !timeAlertIds.includes(a.id));
              return [...alerts, ...nonTimeAlerts];
            });
          }, [currentTime, lkwTime]);

          // Multi-tab sync: warn if another tab modifies stroke data
          useEffect(() => {
            const handleStorageChange = (e) => {
              if (e.key && e.key.startsWith(STORAGE_PREFIX) && e.key.includes('telestrokeNote')) {
                setCriticalAlerts(prev => {
                  if (prev.some(a => a.id === 'multi-tab')) return prev;
                  return [...prev, {
                    id: 'multi-tab',
                    level: 'warning',
                    message: 'Another tab modified stroke data. Refresh to sync.',
                    action: 'Click browser refresh or press F5'
                  }];
                });
              }
            };
            window.addEventListener('storage', handleStorageChange);
            return () => window.removeEventListener('storage', handleStorageChange);
          }, []);

          // Perform search when query changes (debounced)
          useEffect(() => {
            const timer = setTimeout(() => {
              performSearch(searchQuery);
            }, 200);
            return () => clearTimeout(timer);
          }, [searchQuery]);

          // De-ID warning scan for free-text inputs
          useEffect(() => {
            if (!settings.deidMode) {
              setDeidWarnings({});
              return;
            }
            const fieldsToCheck = {
              'Chief complaint': telestrokeNote.chiefComplaint,
              'Symptoms': telestrokeNote.symptoms,
              'PMH': telestrokeNote.pmh,
              'Medications': telestrokeNote.medications,
              'CT results': telestrokeNote.ctResults,
              'CTA results': telestrokeNote.ctaResults,
              'EKG results': telestrokeNote.ekgResults,
              'Diagnosis': telestrokeNote.diagnosis,
              'Recommendations': telestrokeNote.recommendationsText,
              'Stroke code history': strokeCodeForm.hx,
              'Stroke code symptoms': strokeCodeForm.sx,
              'Stroke code deficits': strokeCodeForm.def,
              'Stroke code HCT': strokeCodeForm.hct,
              'Stroke code CTA': strokeCodeForm.cta,
              'Stroke code CTP': strokeCodeForm.ctp,
              'TNK rationale': strokeCodeForm.rec_reason
            };
            const nextWarnings = {};
            Object.entries(fieldsToCheck).forEach(([label, value]) => {
              const matches = getDeidWarnings(value);
              if (matches.length) {
                nextWarnings[label] = matches;
              }
            });
            setDeidWarnings(prev => {
              const prevStr = JSON.stringify(prev);
              const nextStr = JSON.stringify(nextWarnings);
              return prevStr === nextStr ? prev : nextWarnings;
            });
          }, [settings.deidMode,
            telestrokeNote.chiefComplaint, telestrokeNote.symptoms, telestrokeNote.pmh,
            telestrokeNote.medications, telestrokeNote.ctResults, telestrokeNote.ctaResults,
            telestrokeNote.ekgResults, telestrokeNote.diagnosis, telestrokeNote.recommendationsText,
            strokeCodeForm.hx, strokeCodeForm.sx, strokeCodeForm.def,
            strokeCodeForm.hct, strokeCodeForm.cta, strokeCodeForm.ctp, strokeCodeForm.rec_reason]);


          useEffect(() => {
            if (shiftBoards.length > 0) return;
            const boardId = generateId('board');
            updateAppData((prev) => ({
              ...prev,
              shiftBoards: [
                {
                  id: boardId,
                  name: 'Primary Board',
                  createdAt: toIsoString(),
                  updatedAt: toIsoString(),
                  archived: false,
                  patients: []
                }
              ],
              uiState: {
                ...prev.uiState,
                lastShiftBoardId: boardId
              }
            }));
          }, [shiftBoards.length]);

          useEffect(() => {
            if (clipboardPacks.find((pack) => pack.id === selectedPackId)) return;
            setSelectedPackId(clipboardPacks[0]?.id || 'telestroke-consult');
          }, [clipboardPacks, selectedPackId]);


          // Keep mobile bottom nav offset in sync so content isn't obscured
          useEffect(() => {
            const updateMobileNavOffset = () => {
              const nav = document.getElementById('mobile-bottom-nav');
              const actionBar = document.getElementById('action-bar');
              const height = nav ? nav.offsetHeight : 0;
              const actionHeight = actionBar ? actionBar.offsetHeight : 0;
              document.documentElement.style.setProperty('--mobile-nav-offset', `${height}px`);
              document.documentElement.style.setProperty('--mobile-action-offset', `${actionHeight}px`);
            };

            const scheduleUpdate = () => {
              window.requestAnimationFrame(updateMobileNavOffset);
            };

            scheduleUpdate();
            window.addEventListener('resize', scheduleUpdate);
            window.addEventListener('orientationchange', scheduleUpdate);

            return () => {
              window.removeEventListener('resize', scheduleUpdate);
              window.removeEventListener('orientationchange', scheduleUpdate);
            };
          }, []);

          // Load config bundle.
          // `config.example.json` is always loaded.
          // Optional local override is opt-in on localhost via `?localConfig=1` or `?config=local`.
          useEffect(() => {
            let cancelled = false;
            const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
            const params = new URLSearchParams(window.location.search);
            const useLocalOverride = isLocalhost && (params.get('localConfig') === '1' || params.get('config') === 'local');

            const applyConfigData = (data) => {
              if (typeof data !== 'object' || Array.isArray(data)) {
                throw new Error('Config format invalid');
              }
              const links = Array.isArray(data.institutionLinks) ? data.institutionLinks : [];
              const sanitizedLinks = links
                .filter((link) => link && typeof link === 'object')
                .map((link) => ({
                  label: String(link.label || '').trim(),
                  url: String(link.url || '').trim(),
                  note: String(link.note || '').trim()
                }))
                .filter((link) => link.url);
              const ttlOverride = typeof data.ttlHoursOverride === 'number' &&
                Number.isFinite(data.ttlHoursOverride) &&
                data.ttlHoursOverride > 0
                ? data.ttlHoursOverride
                : null;
              setAppConfig({ institutionLinks: sanitizedLinks, ttlHoursOverride: ttlOverride });
              if (ttlOverride) {
                setTtlHours(ttlOverride);
                setKey('ttlHoursOverride', ttlOverride, { skipLastUpdated: true });
              } else {
                removeKey('ttlHoursOverride');
                setTtlHours(DEFAULT_TTL_HOURS);
              }
              setConfigLoaded(true);
            };

            const loadConfig = async () => {
              try {
                const baseResponse = await fetch('config.example.json', { cache: 'no-store' });
                if (!baseResponse.ok) {
                  throw new Error('Base config fetch failed');
                }
                let mergedConfig = await baseResponse.json();

                if (useLocalOverride) {
                  try {
                    const localResponse = await fetch('config.local.json', { cache: 'no-store' });
                    if (localResponse.ok) {
                      const localConfig = await localResponse.json();
                      if (localConfig && typeof localConfig === 'object' && !Array.isArray(localConfig)) {
                        mergedConfig = {
                          ...mergedConfig,
                          ...localConfig,
                          institutionLinks: Array.isArray(localConfig.institutionLinks)
                            ? localConfig.institutionLinks
                            : mergedConfig.institutionLinks
                        };
                      }
                    }
                  } catch (localErr) {
                    console.warn('Optional local config load failed:', localErr);
                  }
                }

                if (cancelled) return;
                applyConfigData(mergedConfig);
              } catch (err) {
                if (cancelled) return;
                console.warn('Config load failed:', err);
                removeKey('ttlHoursOverride');
                setTtlHours(DEFAULT_TTL_HOURS);
                setConfigLoaded(true);
              }
            };

            loadConfig();

            return () => {
              cancelled = true;
            };
          }, []);

          // If storage expired on load, notify and reset visual state
          useEffect(() => {
            if (!storageExpired) return;
            resetAppStateToDefaults();
            navigateTo('encounter');
            showNotice('Stored data expired and was cleared.', 'warning', { timeoutMs: 6000 });
          }, []);

          // Apply TTL override once config is loaded
          useEffect(() => {
            if (storageExpired || !configLoaded) return;
            if (ttlHours === DEFAULT_TTL_HOURS) return;
            const expired = applyStorageExpiration(ttlHours);
            if (expired) {
              setStorageExpired(true);
              resetAppStateToDefaults();
              navigateTo('encounter');
              showNotice('Stored data expired and was cleared.', 'warning', { timeoutMs: 6000 });
            }
          }, [ttlHours, storageExpired, configLoaded]);

          // Initialize component, routing, and icons on mount
          useEffect(() => {
            createIcons({ icons });

            const resolveRoute = () => {
              if (storageExpired && !hasHandledExpiredRef.current) {
                hasHandledExpiredRef.current = true;
                setActiveTab('encounter');
                return;
              }
              const parsed = parseHashRoute(window.location.hash);
              if (parsed && VALID_TABS.includes(parsed.tab)) {
                if (parsed.tab === 'management' || parsed.tab === 'trials') {
                  setActiveTab('library');
                  setLibrarySection(parsed.tab === 'trials' ? 'trials' : 'management');
                } else {
                  setActiveTab(parsed.tab);
                }
                if (parsed.tab === 'library') {
                  setLibrarySection(LIBRARY_SECTIONS.includes(parsed.sub) ? parsed.sub : 'management');
                } else if (parsed.tab === 'management') {
                  const resolvedSubTab = normalizeManagementSubTab(parsed.sub) ||
                    normalizeManagementSubTab(appData.uiState.lastManagementSubTab) ||
                    'ich';
                  setManagementSubTab(resolvedSubTab);
                }
                return;
              }
              const savedTab = appData.uiState.lastActiveTab || getKey('activeTab', null);
              if (savedTab) {
                if (LEGACY_MANAGEMENT_TABS[savedTab]) {
                  setActiveTab('library');
                  setLibrarySection('management');
                  setManagementSubTab(LEGACY_MANAGEMENT_TABS[savedTab]);
                  return;
                }
                if (savedTab === 'management') {
                  setActiveTab('library');
                  setLibrarySection('management');
                  setManagementSubTab(normalizeManagementSubTab(appData.uiState.lastManagementSubTab) || 'ich');
                  return;
                }
                if (savedTab === 'trials') {
                  setActiveTab('library');
                  setLibrarySection('trials');
                  return;
                }
                if (VALID_TABS.includes(savedTab)) {
                  setActiveTab(savedTab);
                  return;
                }
              }
              setActiveTab('encounter');
            };

            resolveRoute();
            setRouteReady(true);

            requestAnimationFrame(() => {
              setIsMounted(true);
              createIcons({ icons });
            });

            window.addEventListener('hashchange', resolveRoute);
            return () => window.removeEventListener('hashchange', resolveRoute);
          }, []);

          // Keep hash in sync with the active view
          useEffect(() => {
            if (!routeReady) return;
            const hashSub = activeTab === 'library' ? librarySection : managementSubTab;
            const nextHash = buildHashRoute(activeTab, hashSub);
            if (window.location.hash !== nextHash) {
              window.location.hash = nextHash;
            }
          }, [activeTab, routeReady, managementSubTab, librarySection]);

          useEffect(() => {
            const shouldPersist = activeTab === 'management' || (activeTab === 'library' && librarySection === 'management');
            if (!shouldPersist) return;
            updateAppData((prev) => ({
              ...prev,
              uiState: {
                ...prev.uiState,
                lastManagementSubTab: managementSubTab
              }
            }));
          }, [activeTab, managementSubTab, librarySection]);

          useEffect(() => {
            if (activeTab !== 'library') return;
            updateAppData((prev) => ({
              ...prev,
              uiState: {
                ...prev.uiState,
                lastLibrarySection: librarySection
              }
            }));
          }, [activeTab, librarySection]);

          // Lock body scroll + focus trap when full-screen modals are open
          useEffect(() => {
            const anyModalOpen = !!protocolModal || showChangelog || showKeyboardHelp || calcDrawerOpen || !!confirmConfig;
            if (anyModalOpen) {
              const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
              document.body.style.overflow = 'hidden';
              document.body.style.paddingRight = `${scrollbarWidth}px`;
              // Focus trap: keep Tab within the open modal dialog
              const previouslyFocused = document.activeElement;
              const trapFocus = (e) => {
                if (e.key !== 'Tab') return;
                const modal = document.querySelector('[role="dialog"], [aria-modal="true"]');
                if (!modal) return;
                const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (focusable.length === 0) return;
                const first = focusable[0];
                const last = focusable[focusable.length - 1];
                if (e.shiftKey && document.activeElement === first) {
                  e.preventDefault();
                  last.focus();
                } else if (!e.shiftKey && document.activeElement === last) {
                  e.preventDefault();
                  first.focus();
                } else if (!modal.contains(document.activeElement)) {
                  e.preventDefault();
                  first.focus();
                }
              };
              document.addEventListener('keydown', trapFocus);
              // Auto-focus first focusable element in modal
              requestAnimationFrame(() => {
                const modal = document.querySelector('[role="dialog"], [aria-modal="true"]');
                if (modal) {
                  const first = modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                  if (first) first.focus();
                }
              });
              return () => {
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                document.removeEventListener('keydown', trapFocus);
                if (previouslyFocused && previouslyFocused.isConnected && typeof previouslyFocused.focus === 'function') previouslyFocused.focus();
              };
            }
          }, [protocolModal, showChangelog, showKeyboardHelp, calcDrawerOpen, confirmConfig, settingsMenuOpen]);

          // Reinitialize icons when tab/layout/modal content changes
          useEffect(() => {
            if (isMounted) {
              requestAnimationFrame(() => createIcons({ icons }));
            }
          }, [activeTab, isMounted, managementSubTab, encounterPhase, showKeyboardHelp, showChangelog, settingsMenuOpen, searchOpen, calcDrawerOpen, protocolModal, confirmConfig]);

          // Documentation generation functions
          const generateHPI = () => {
            const timeFromLKW = calculateTimeFromLKW();
            const timeElapsed = timeFromLKW ? `${timeFromLKW.hours}h ${timeFromLKW.minutes}m` : 'unknown';
            const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '__';
            const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : '__';
            const sexDisplay = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '__';
            const nihssDisplay = telestrokeNote.nihss || nihssScore || '__';

            return `HPI: ${telestrokeNote.age || '__'} year old ${sexDisplay} with PMH of ${telestrokeNote.pmh || '__'} presenting with ${telestrokeNote.symptoms || '__'} starting at ${lkw} on ${lkwDate} (${timeElapsed} ago). NIHSS ${nihssDisplay}.

IMAGING:
- Head CT: ${telestrokeNote.ctResults || 'pending'}
- CTA Head/Neck: ${telestrokeNote.ctaResults || 'pending'}
- CTP: ${telestrokeNote.ctpResults || 'pending'}
- ASPECTS: ${aspectsScore != null ? aspectsScore : '__'}

ASSESSMENT: ${telestrokeNote.diagnosis || 'Acute ischemic stroke'}, NIHSS ${nihssDisplay}
${telestrokeNote.tnkRecommended ? `\nTNK: Recommended` : '\nTNK: Not Recommended'}
${telestrokeNote.evtRecommended ? `EVT: Recommended` : 'EVT: Not Recommended'}`;
          };

          const generateAdmissionOrders = () => {
            const nihssDisplay = telestrokeNote.nihss || nihssScore || '__';
            const receivedTNK = !!telestrokeNote.tnkRecommended;
            const receivedEVT = !!telestrokeNote.evtRecommended;
            const diagCat = telestrokeNote.diagnosisCategory;
            const tnkDose = telestrokeNote.weight ? calculateTNKDose(telestrokeNote.weight) : null;

            const vitals = receivedTNK
              ? 'Neuro checks + BP q15min x 2h, then q30min x 6h, then q1h x 16h'
              : receivedEVT
              ? 'Neuro checks q1h x 24h; groin checks q15min x 4h, q30min x 4h, then q1h'
              : diagCat === 'ich'
              ? 'Neuro checks + VS q1h x 24h, then q2h'
              : diagCat === 'sah'
              ? 'Neuro checks q1h x 14 days; VS q1h'
              : 'Vital signs q1h x 24h, then q4h';

            const bpTarget = receivedTNK ? 'SBP <180, DBP <105 x 24h'
              : receivedEVT ? 'SBP <180, DBP <105 (avoid SBP <140)'
              : diagCat === 'ich' ? 'SBP <140 (Class IIa, INTERACT2; avoid <130 per ATACH-2)'
              : diagCat === 'sah' ? 'SBP <160 until aneurysm secured'
              : 'SBP <220, DBP <120 (if no thrombolysis)';

            const antiplatelet = receivedTNK
              ? `Aspirin 325mg LOAD then 81mg daily — HOLD x 24h post-TNK${tnkDose ? ` (TNK ${tnkDose.calculatedDose} mg given)` : ''}`
              : diagCat === 'ich' ? 'Hold antiplatelets — discuss restart timing with attending'
              : 'Aspirin 325mg LOAD, then 81mg daily';

            const dvt = receivedTNK
              ? 'DVT prophylaxis: SCDs now; SQ heparin at 24h post-lytic + stable follow-up CT'
              : diagCat === 'ich'
              ? 'DVT prophylaxis: IPC immediately; SQ heparin at 48h after IPH onset if hematoma stable on repeat CT'
              : diagCat === 'sah'
              ? 'DVT prophylaxis: SCDs until aneurysm secured, then SQ heparin'
              : 'DVT prophylaxis: SCDs on admission; enoxaparin 40mg SC daily';

            const callCriteria = receivedTNK
              ? `\nCALL CRITERIA (POST-TNK):
- NIHSS increase >=4 points
- New headache, acute hypertension, nausea/vomiting
- Orolingual swelling (angioedema)
- Any bleeding (groin, GI, GU, mucosal)
- SBP >180 or DBP >105 despite treatment`
              : '';

            return `ACUTE STROKE ADMISSION ORDERS:${diagCat === 'ich' ? ' (ICH)' : diagCat === 'sah' ? ' (SAH)' : receivedTNK ? ' (POST-TNK)' : ''}

1. Admit to ${diagCat === 'sah' || diagCat === 'ich' ? 'Neuro ICU' : 'Stroke Unit / Neuro ICU'}
2. ${vitals}
3. Continuous telemetry monitoring
4. NPO until swallow evaluation completed
5. IV fluids: NS at 75 mL/hr
6. BP target: ${bpTarget}
7. Blood glucose 140-180 mg/dL (avoid hypoglycemia <70)
8. HOB elevated 30 degrees
9. ${dvt}
10. ${antiplatelet}
11. Statin therapy: Atorvastatin 80mg daily${diagCat === 'ich' ? ' (consider holding acutely)' : ''}
12. ${diagCat === 'sah' ? 'Nimodipine 60mg PO/NG q4h x 21 days' : 'Neurology consultation'}
${diagCat === 'sah' ? '13. Seizure prophylaxis: Levetiracetam 500-1000mg IV/PO q12h x 3-7 days (if cortical SAH, IVH, poor-grade, or seizure at onset)\n14' : '13'}. Bowel protocol: docusate 100 mg BID + senna PRN (avoid Valsalva straining)
${diagCat === 'sah' ? '15' : '14'}. PT/OT/Speech evaluation
${diagCat === 'sah' ? '16' : '15'}. Fall precautions${diagCat === 'sah' ? '\n17. Neurosurgery consultation' : ''}

LABS:
- CBC, CMP, PT/INR, PTT
- Lipid panel, HbA1c
- Troponin, BNP${receivedTNK ? '\n- Repeat CBC, INR, fibrinogen at 24h post-TNK' : ''}${diagCat === 'ich' ? '\n- Repeat PT/INR if on anticoagulant' : ''}
- Consider: ESR, CRP if indicated

IMAGING:
- ${receivedTNK ? 'Repeat CT head at 24h post-TNK (or sooner if clinical decline)' : diagCat === 'ich' ? 'Repeat CT head at 6h and 24h (or sooner if decline)' : 'MRI brain with DWI if not already done'}
- ${diagCat === 'sah' ? 'CTA for aneurysm localization' : 'Carotid ultrasound'}
- Echocardiogram (TTE or TEE)
${callCriteria}
NIHSS: ${nihssDisplay} - reassess ${receivedTNK ? 'per neuro check schedule' : 'q4h x 24h, then daily'}`;
          };

          const topLinks = [
            { label: 'Stroke Clinic Pre-Visit Questionnaire', url: 'https://rkalani1.github.io/stroke-clinic-q/', note: 'Pre-visit checklist and initial screening' },
            { label: 'Regional Hospitals', url: 'https://rkalani1.github.io/telestroke-expansion-map/', note: 'Regional telestroke center coverage map' }
          ];
          const encounterQuickLinks = [
            { label: 'Telestroke Website', url: 'https://intranet.neurology.uw.edu/telestroke-provider-resources/' },
            { label: 'UW Medicine', url: 'https://access.uwmedicine.org/logon/LogonPoint/tmindex.html' },
            { label: 'OpenEvidence', url: 'https://www.openevidence.com' },
            { label: 'UpToDate', url: 'https://www.uptodate.com' }
          ];
          const userQuickLinks = Array.isArray(settings.quickLinks) ? settings.quickLinks : [];
          const quickLinks = [...encounterQuickLinks, ...userQuickLinks, ...appConfig.institutionLinks].reduce((acc, link) => {
            if (!link || !link.url) return acc;
            const normalizedUrl = String(link.url).trim();
            if (!normalizedUrl || acc.seen.has(normalizedUrl)) return acc;
            acc.seen.add(normalizedUrl);
            acc.items.push({
              label: String(link.label || 'Resource').trim() || 'Resource',
              url: normalizedUrl,
              note: link.note ? String(link.note).trim() : ''
            });
            return acc;
          }, { items: [], seen: new Set() }).items;
          const ttlDisplayHours = appConfig.ttlHoursOverride || DEFAULT_TTL_HOURS;
          const showDocumentActions = true;
          const showEncounterActionBar = activeTab === 'encounter' && !calcDrawerOpen && (telestrokeNote.age || nihssScore > 0 || telestrokeNote.diagnosis);
          const todayDate = new Date().toISOString().slice(0, 10);
          const hasLegacyKeys = LEGACY_KEYS.some((key) => {
            try {
              return localStorage.getItem(key) !== null;
            } catch {
              return false;
            }
          });
          const toolShortcuts = [
            { id: 'patient-info-section', label: 'Patient Info' },
            { id: 'lkw-section', label: 'LKW / Discovery' },
            { id: 'nihss-section', label: 'NIHSS' },
            { id: 'vitals-section', label: 'Vitals' },
            { id: 'treatment-decision', label: 'Treatment' },
            { id: 'sah-management-section', label: 'SAH Mgmt' },
            { id: 'cvt-management-section', label: 'CVT Mgmt' },
            { id: 'discharge-checklist-section', label: 'Discharge' },
            { id: 'recommendations-section', label: 'Recommendations' },
            { id: 'handoff-section', label: 'Handoff' },
          ];
          const roleOptions = [
            { value: 'consult', label: 'Consult' },
            { value: 'attending', label: 'Attending' },
            { value: 'ed', label: 'ED' },
            { value: 'icu', label: 'ICU' },
            { value: 'transfer', label: 'Transfer' }
          ];
          const timeFromLKW = calculateTimeFromLKW();
          const windowStatus = telestrokeNote.lkwUnknown
            ? { color: 'gray', message: timeFromLKW ? 'Discovery-based timing' : 'LKW unknown' }
            : getWindowStatus(timeFromLKW) || { color: 'gray', message: 'Set LKW time' };
          const windowToneClass = {
            green: 'bg-emerald-100 text-emerald-800 border-emerald-200',
            yellow: 'bg-amber-100 text-amber-800 border-amber-200',
            orange: 'bg-orange-100 text-orange-800 border-orange-200',
            red: 'bg-red-100 text-red-800 border-red-200',
            gray: 'bg-slate-100 text-slate-700 border-slate-200'
          }[windowStatus.color] || 'bg-slate-100 text-slate-700 border-slate-200';
          const onsetLabel = timeFromLKW?.label || (telestrokeNote.lkwUnknown ? 'Discovery' : 'LKW');
          const lkwDisplay = telestrokeNote.lkwUnknown
            ? (timeFromLKW ? `${telestrokeNote.discoveryDate || ''} ${telestrokeNote.discoveryTime || ''}`.trim() || 'Unknown' : 'Unknown')
            : lkwTime
              ? lkwTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
              : 'Not set';
          const lkwElapsed = timeFromLKW ? (timeFromLKW.futureWarning ? 'FUTURE' : `${timeFromLKW.hours}h ${timeFromLKW.minutes}m`) : null;
          const ageDisplay = telestrokeNote.age !== undefined && String(telestrokeNote.age).trim() !== ''
            ? String(telestrokeNote.age).trim()
            : '--';
          const weightDisplay = telestrokeNote.weight !== undefined && String(telestrokeNote.weight).trim() !== ''
            ? `${String(telestrokeNote.weight).trim()} kg`
            : '--';
          const nihssFromNote = telestrokeNote.nihss !== undefined && String(telestrokeNote.nihss).trim() !== ''
            ? String(telestrokeNote.nihss).trim()
            : '';
          const hasNihssInputs = nihssItems.some((item) => patientData[item.id] !== undefined && patientData[item.id] !== '');
          const nihssDisplay = nihssFromNote || (hasNihssInputs ? String(nihssScore) : '--');
          return (
            <div className="relative">
              <a href="#main-content" className="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-[100] focus:bg-blue-600 focus:text-white focus:px-4 focus:py-2 focus:rounded-lg focus:text-sm focus:font-medium">Skip to main content</a>
              {protocolModal && (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-slate-900/50 p-4" role="dialog" aria-modal="true" aria-labelledby="protocol-modal-title" onClick={() => setProtocolModal(null)}>
                  <div className="w-full max-w-lg bg-white rounded-xl shadow-xl border border-slate-200" onClick={(e) => e.stopPropagation()}>
                    <div className="flex items-center justify-between px-4 py-3 border-b border-slate-200">
                      <div>
                        <h3 id="protocol-modal-title" className="text-lg font-semibold text-slate-900">{protocolModal.title}</h3>
                        <p className="text-xs text-slate-500">{protocolModal.classOfRec}</p>
                      </div>
                      <button
                        type="button"
                        onClick={() => setProtocolModal(null)}
                        className="text-slate-500 hover:text-slate-700 min-h-[36px] min-w-[36px] flex items-center justify-center rounded-lg focus:ring-2 focus:ring-blue-500"
                        aria-label="Close protocol"
                      >
                        <i aria-hidden="true" data-lucide="x" className="w-5 h-5"></i>
                      </button>
                    </div>
                    <div className="p-4 space-y-3 text-sm text-slate-700">
                      <div>
                        <p className="font-semibold text-slate-800">Dosing</p>
                        <p>{protocolModal.dosing}</p>
                      </div>
                      {protocolModal.classOfRec && (
                        <div className="text-xs text-blue-700 bg-blue-50 border border-blue-200 rounded-lg p-2">
                          {protocolModal.classOfRec}
                        </div>
                      )}
                      {protocolModal.note && (
                        <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 text-xs text-slate-600">
                          {protocolModal.note}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
              <div className={`app-shell max-w-7xl mx-auto p-4 sm:p-8 overflow-x-hidden ${showEncounterActionBar ? 'pb-24 sm:pb-28' : ''}`} role="main">

              {/* Offline Indicator */}
              {!isOnline && (
                <div className="bg-amber-500 text-white px-4 py-2 text-center text-sm font-medium flex items-center justify-center gap-2 no-print" role="alert">
                  <i aria-hidden="true" data-lucide="wifi-off" className="w-4 h-4"></i>
                  <span>You are offline — changes are saved locally</span>
                </div>
              )}

              {/* Header — Simplified */}
              <div className={`mb-4 sm:mb-6 app-header ${focusMode ? 'hidden' : ''}`} role="banner">
                <div className="flex flex-col sm:flex-row justify-between items-start gap-3">
                  <div className="flex-1 w-full sm:w-auto">
                    <div className="flex items-center gap-3 justify-center sm:justify-start">
                      <h1 className="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-blue-900 to-indigo-800 bg-clip-text text-transparent">
                        Stroke
                      </h1>
                      <button
                        onClick={() => setShowKeyboardHelp(true)}
                        className="hidden sm:inline-flex text-xs text-slate-500 hover:text-blue-600 transition-colors px-1.5 py-0.5 border border-slate-200 rounded"
                        title="Keyboard shortcuts (?)"
                        aria-label="Keyboard shortcuts"
                      >
                        <i aria-hidden="true" data-lucide="keyboard" className="w-3 h-3"></i>
                      </button>
                    </div>
                    {topLinks.length > 0 && (
                      <div className="mt-1 flex flex-wrap items-center gap-1.5 justify-center sm:justify-start">
                        {topLinks.map((link) => (
                          <a
                            key={link.url}
                            href={link.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="flex items-center gap-1.5 px-2 py-1 text-xs text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-md transition-colors"
                          >
                            <i aria-hidden="true" data-lucide="external-link" className="w-3 h-3"></i>
                            <span>{link.label}</span>
                          </a>
                        ))}
                      </div>
                    )}
                  </div>
                  <div className="flex w-full flex-col items-center justify-center gap-2 sm:w-auto sm:items-end sm:justify-end">
                    <div className="relative w-full sm:w-auto" ref={searchContainerRef}>
                      <input
                        type="text"
                        placeholder="Search trials, tools, references..."
                        value={searchQuery}
                        onChange={(e) => {
                          setSearchQuery(e.target.value);
                          setSearchOpen(true);
                          setSearchContext('header');
                        }}
                        onFocus={() => {
                          setSearchOpen(true);
                          setSearchContext('header');
                          if (searchResults.length > 0 && searchActiveIndex < 0) {
                            setSearchActiveIndex(0);
                          }
                        }}
                        onKeyDown={(e) => {
                          if (e.key === 'Escape') {
                            e.preventDefault();
                            setSearchOpen(false);
                            setSearchQuery('');
                            setSearchActiveIndex(-1);
                            return;
                          }
                          if (!searchOpen || !searchResults.length) return;
                          const total = searchResults.length;
                          if (e.key === 'ArrowDown') {
                            e.preventDefault();
                            setSearchActiveIndex(prev => (prev + 1) % total);
                          } else if (e.key === 'ArrowUp') {
                            e.preventDefault();
                            setSearchActiveIndex(prev => (prev <= 0 ? total - 1 : prev - 1));
                          } else if (e.key === 'Enter') {
                            e.preventDefault();
                            const targetIndex = searchActiveIndex >= 0 && searchActiveIndex < total ? searchActiveIndex : 0;
                            const selected = searchResults[targetIndex];
                            if (selected && typeof selected.action === 'function') {
                              selected.action();
                              setSearchOpen(false);
                              setSearchQuery('');
                              setSearchActiveIndex(-1);
                            }
                          }
                        }}
                        role="combobox"
                        aria-expanded={searchOpen && searchResults.length > 0}
                        aria-controls="search-listbox"
                        aria-activedescendant={searchActiveIndex >= 0 ? `search-opt-${searchActiveIndex}` : undefined}
                        className="pl-8 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-48 md:w-64"
                        aria-label="Search trials, management tools, and references"
                      />
                      <i aria-hidden="true" data-lucide="search" className="w-4 h-4 absolute left-2 top-3 text-slate-500"></i>

                      {searchOpen && searchContext === 'header' && (
                        <div aria-live="polite" aria-atomic="true" className="sr-only">
                          {searchResults.length > 0 ? `${searchResults.length} results found` : searchQuery.length >= 2 ? 'No results found' : ''}
                        </div>
                      )}

                      {searchOpen && searchContext === 'header' && searchResults.length > 0 && (
                        <div id="search-listbox" role="listbox" aria-label="Search results" className="absolute top-12 left-0 right-0 sm:right-auto sm:w-96 bg-white shadow-lg rounded-lg border max-h-96 overflow-y-auto z-50">
                          {(() => {
                            let flatIdx = 0;
                            return Object.entries(searchResults.reduce((acc, result) => {
                              const key = result.type || 'Results';
                              if (!acc[key]) acc[key] = [];
                              acc[key].push(result);
                              return acc;
                            }, {})).map(([group, items]) => (
                              <div key={group} role="group" aria-label={group}>
                                <div className="px-3 py-1 text-xs uppercase tracking-wider text-slate-500 bg-slate-50 border-b" role="presentation">
                                  {group}
                                </div>
                                {items.map((result) => {
                                  const idx = flatIdx++;
                                  const isActive = idx === searchActiveIndex;
                                  return (
                                    <button
                                      role="option"
                                      id={`search-opt-${idx}`}
                                      key={`search-${idx}`}
                                      aria-selected={isActive}
                                      onClick={() => { result.action(); setSearchOpen(false); setSearchQuery(''); }}
                                      onMouseEnter={() => setSearchActiveIndex(idx)}
                                      className={`w-full text-left p-3 border-b transition-colors ${isActive ? 'bg-blue-100' : 'hover:bg-blue-50'}`}
                                    >
                                      <div className="flex items-start justify-between">
                                        <div className="flex-1">
                                          <p className="font-semibold text-sm">{result.title}</p>
                                          {result.description && (
                                            <p className="text-xs text-slate-600 mt-1">{result.description}</p>
                                          )}
                                        </div>
                                      </div>
                                    </button>
                                  );
                                })}
                              </div>
                            ));
                          })()}
                        </div>
                      )}

                      {searchOpen && searchContext === 'header' && searchQuery.trim().length >= 2 && searchResults.length === 0 && (
                        <div className="absolute top-12 left-0 right-0 sm:right-auto sm:w-96 bg-white shadow-lg rounded-lg border z-50 p-3">
                          <p className="text-sm font-semibold text-slate-700">No exact match found</p>
                          <p className="text-xs text-slate-500 mt-0.5 mb-2">Try one of these quick commands:</p>
                          <div className="space-y-1.5">
                            {(() => {
                              const normalizedQuery = searchQuery.trim().toLowerCase();
                              const quickMatches = QUICK_SEARCH_COMMANDS.filter((command) =>
                                command.value.toLowerCase().includes(normalizedQuery) ||
                                command.hint.toLowerCase().includes(normalizedQuery)
                              );
                              const suggestions = (quickMatches.length > 0 ? quickMatches : QUICK_SEARCH_COMMANDS).slice(0, 4);
                              return suggestions.map((command) => (
                                <button
                                  key={`no-results-${command.value}`}
                                  onClick={() => {
                                    setSearchQuery(command.value);
                                    setSearchOpen(true);
                                    setSearchContext('header');
                                  }}
                                  className="w-full text-left px-2.5 py-2 rounded-lg border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-colors"
                                >
                                  <p className="text-xs font-mono text-blue-700">{command.label}</p>
                                  <p className="text-xs text-slate-600 mt-0.5">{command.hint}</p>
                                </button>
                              ));
                            })()}
                          </div>
                        </div>
                      )}

                      {searchOpen && searchContext === 'header' && searchQuery.trim().length < 2 && (
                        <div className="absolute top-12 left-0 right-0 sm:right-auto sm:w-96 bg-white shadow-lg rounded-lg border z-50 p-3">
                          <p className="text-xs font-semibold uppercase tracking-wide text-slate-500 mb-2">Quick Commands</p>
                          <div className="space-y-1.5">
                            {QUICK_SEARCH_COMMANDS.map((command) => (
                              <button
                                key={command.value}
                                onClick={() => {
                                  setSearchQuery(command.value);
                                  setSearchOpen(true);
                                  setSearchContext('header');
                                }}
                                className="w-full text-left px-2.5 py-2 rounded-lg border border-slate-200 hover:border-blue-300 hover:bg-blue-50 transition-colors"
                              >
                                <p className="text-xs font-mono text-blue-700">{command.label}</p>
                                <p className="text-xs text-slate-600 mt-0.5">{command.hint}</p>
                              </button>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                    <div className="text-xs text-slate-500 flex items-center gap-1" role="status" aria-live="polite" title={saveStatus === 'saving' ? 'Saving...' : lastSaved ? `Saved ${new Date(lastSaved).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}` : 'Saved'}>
                      <i aria-hidden="true" data-lucide={saveStatus === 'saving' ? 'loader' : 'check-circle'} className={`w-3 h-3 ${saveStatus === 'saving' ? 'text-amber-500 animate-spin' : 'text-emerald-500'}`}></i>
                      <span className="hidden sm:inline">{saveStatus === 'saving' ? 'Saving' : 'Saved'}</span>
                    </div>

                    <div className="flex w-full flex-wrap items-center justify-center gap-2 sm:w-auto sm:justify-end">
                      <button
                        onClick={startNewPatient}
                        className="flex items-center gap-2 px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                        aria-label="Start new case"
                        title="Start a new case (clears current inputs)"
                      >
                        <i aria-hidden="true" data-lucide="user-plus" className="w-4 h-4"></i>
                        <span>New Case</span>
                      </button>

                      {/* Settings Menu */}
                      <div className="relative">
                        <button
                          id="settings-menu-trigger"
                          onClick={() => setSettingsMenuOpen((prev) => !prev)}
                          className="flex items-center gap-1.5 px-3 py-2.5 border border-slate-300 rounded-lg hover:bg-slate-100 transition-colors text-sm font-medium text-slate-600"
                          aria-expanded={settingsMenuOpen}
                          aria-haspopup="true"
                          aria-controls={settingsMenuOpen ? 'settings-menu' : undefined}
                          aria-label="Settings menu"
                        >
                          <i aria-hidden="true" data-lucide="settings" className="w-4 h-4"></i>
                          <span className="hidden sm:inline">More</span>
                        </button>
                        {settingsMenuOpen && (
                          <>
                            <div className="fixed inset-0 z-50" onClick={() => setSettingsMenuOpen(false)} role="presentation" aria-hidden="true"></div>
                            <div id="settings-menu" role="menu" aria-labelledby="settings-menu-trigger" className="absolute right-0 top-12 w-56 max-w-[calc(100vw-2rem)] bg-white border border-slate-200 rounded-xl shadow-lg z-50 py-1 overflow-hidden">
                              {showDocumentActions && (
                                <button
                                  role="menuitem"
                                  onClick={() => { exportToPDF(); setSettingsMenuOpen(false); }}
                                  className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-slate-50 text-sm text-slate-700 transition-colors"
                                >
                                  <i aria-hidden="true" data-lucide="download" className="w-4 h-4 text-slate-500"></i>
                                  Export to PDF
                                </button>
                              )}
                              {showDocumentActions && (
                                <button
                                  role="menuitem"
                                  onClick={() => { handleShare(); setSettingsMenuOpen(false); }}
                                  className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-slate-50 text-sm text-slate-700 transition-colors"
                                >
                                  <i aria-hidden="true" data-lucide="share-2" className="w-4 h-4 text-slate-500"></i>
                                  Share
                                </button>
                              )}
                              <div className="border-t border-slate-100 my-1"></div>
                              <button
                                role="menuitem"
                                onClick={() => { setFocusMode(prev => !prev); setSettingsMenuOpen(false); }}
                                className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-slate-50 text-sm text-slate-700 transition-colors"
                              >
                                <i aria-hidden="true" data-lucide={focusMode ? 'minimize-2' : 'maximize-2'} className="w-4 h-4 text-slate-500"></i>
                                {focusMode ? 'Exit Focus Mode' : 'Focus Mode'}
                              </button>
                              <button
                                role="menuitem"
                                onClick={() => { setShowChangelog(true); setSettingsMenuOpen(false); }}
                                className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-slate-50 text-sm text-slate-700 transition-colors"
                              >
                                <i aria-hidden="true" data-lucide="sparkles" className="w-4 h-4 text-slate-500"></i>
                                What's New
                              </button>
                              {encounterHistory.length > 0 && (
                                <button
                                  role="menuitem"
                                  onClick={() => { setSettingsMenuOpen(false); scrollToSection('encounter-history-section'); }}
                                  className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-slate-50 text-sm text-slate-700 transition-colors"
                                >
                                  <i aria-hidden="true" data-lucide="history" className="w-4 h-4 text-slate-500"></i>
                                  Recent Encounters ({encounterHistory.length})
                                </button>
                              )}
                              <div className="border-t border-slate-100 my-1" role="separator"></div>
                              <button
                                role="menuitem"
                                onClick={() => { handleClearLocalData(); setSettingsMenuOpen(false); }}
                                className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-red-50 text-sm text-red-600 transition-colors"
                              >
                                <i aria-hidden="true" data-lucide="trash-2" className="w-4 h-4"></i>
                                Clear all data
                              </button>
                            </div>
                          </>
                        )}
                      </div>
                    </div>

                    {/* Mobile actions removed - handled by settings menu */}
                  </div>
                </div>

                {notice && (
                  <div className={`mt-2 p-3 rounded-lg border text-sm flex items-center gap-2 ${
                    notice.type === 'success'
                      ? 'bg-emerald-100 border-emerald-400 text-emerald-700'
                      : notice.type === 'warning'
                      ? 'bg-amber-100 border-amber-400 text-amber-800'
                      : notice.type === 'error'
                      ? 'bg-red-100 border-red-400 text-red-700'
                      : 'bg-blue-100 border-blue-400 text-blue-700'
                  }`}>
                    <i
                      data-lucide={
                        notice.type === 'success'
                          ? 'check-circle'
                          : notice.type === 'warning'
                          ? 'alert-triangle'
                          : notice.type === 'error'
                          ? 'x-circle'
                          : 'info'
                      }
                      className="w-4 h-4"
                    ></i>
                    <span>{notice.message}</span>
                  </div>
                )}

                {clearUndo && (
                  <div className="mt-2 p-3 rounded-lg border border-blue-200 bg-blue-50 text-blue-900 text-sm flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                    <div className="flex items-center gap-2">
                      <i aria-hidden="true" data-lucide="rotate-ccw" className="w-4 h-4"></i>
                      <span>Case cleared. Undo available for 30 seconds.</span>
                    </div>
                    <button
                      type="button"
                      onClick={handleUndoClearCase}
                      className="px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700"
                    >
                      Undo
                    </button>
                  </div>
                )}

                {/* Success Notification */}
                {copiedText && (
                  <div className="mt-2 p-2 bg-emerald-100 border border-emerald-400 text-emerald-700 rounded-lg text-sm flex items-center gap-2">
                    <i aria-hidden="true" data-lucide="check" className="w-4 h-4"></i>
                    <span>{copiedText} copied to clipboard!</span>
                  </div>
                )}

                {Object.keys(deidWarnings).length > 0 && (
                  <div className="mt-2 p-2 bg-amber-50 border border-amber-200 text-amber-800 rounded-lg text-xs">
                    <div className="flex items-center gap-2 font-semibold">
                      <i aria-hidden="true" data-lucide="alert-triangle" className="w-4 h-4"></i>
                      <span>Possible identifiers detected</span>
                    </div>
                    <div className="mt-1">
                      {Object.entries(deidWarnings).slice(0, 4).map(([field, matches]) => (
                        <div key={field}>{field}: {matches.join(', ')}</div>
                      ))}
                      {Object.keys(deidWarnings).length > 4 && (
                        <div>More fields flagged...</div>
                      )}
                    </div>
                  </div>
                )}
              </div>

              {/* Case summary removed — patient summary strip in encounter tab is the single source */}

              {/* ===== PERSISTENT TIMER STRIP (visible across all tabs) ===== */}
              {(() => {
                const timeFromLKW = calculateTimeFromLKW();
                if (!timeFromLKW) return null;
                const totalHours = timeFromLKW.total;
                const tnkRemaining = 4.5 - totalHours;
                const tnkRemainingMin = Math.max(0, Math.floor(tnkRemaining * 60));
                const evtEarlyRemaining = 6 - totalHours;
                const elH = Math.floor(elapsedSeconds / 3600);
                const elM = Math.floor((elapsedSeconds % 3600) / 60);
                const elS = elapsedSeconds % 60;
                const timerBg = totalHours < 3 ? 'from-emerald-600 to-emerald-700' : totalHours < 4 ? 'from-amber-500 to-amber-600' : totalHours < 4.5 ? 'from-orange-500 to-orange-600' : 'from-red-600 to-red-700';
                return (
                  <div className={`mb-3 bg-gradient-to-r ${timerBg} rounded-xl px-4 py-2 text-white flex flex-wrap items-center justify-between gap-2 ${alertFlashing ? 'alert-flash' : ''}`} role="timer" aria-live="polite" aria-label="Stroke treatment window timer">
                    <div className="flex items-center gap-3">
                      <i aria-hidden="true" data-lucide="clock" className="w-4 h-4"></i>
                      <span className="font-mono font-bold text-lg">{elH}h {String(elM).padStart(2,'0')}m {String(elS).padStart(2,'0')}s</span>
                      <span className="text-xs opacity-80">from {timeFromLKW.label || 'LKW'}</span>
                    </div>
                    <div className="flex items-center gap-4 text-xs">
                      {tnkRemaining > 0 ? (
                        <span className={`font-semibold ${tnkRemainingMin <= 30 ? 'animate-pulse' : ''}`}>
                          TNK: {Math.floor(tnkRemainingMin/60)}h {tnkRemainingMin%60}m left
                        </span>
                      ) : (
                        <span className="opacity-90">TNK closed</span>
                      )}
                      {evtEarlyRemaining > 0 ? (
                        <span>EVT early: {Math.floor(evtEarlyRemaining)}h {Math.floor((evtEarlyRemaining%1)*60)}m</span>
                      ) : totalHours < 24 ? (
                        <span>EVT late window</span>
                      ) : null}
                    </div>
                    <div className="flex items-center gap-1">
                      <button onClick={toggleAlertMute} aria-pressed={alertsMuted} className="p-2 rounded-full hover:bg-white/20 transition-colors min-h-[36px] min-w-[36px] flex items-center justify-center" title={alertsMuted ? 'Unmute' : 'Mute'} aria-label={alertsMuted ? 'Unmute alerts' : 'Mute alerts'}>
                        <i aria-hidden="true" data-lucide={alertsMuted ? 'volume-x' : 'volume-2'} className="w-4 h-4"></i>
                      </button>
                      <button onClick={() => setFocusMode(prev => !prev)} aria-pressed={focusMode} className={`p-2 rounded-full hover:bg-white/20 transition-colors min-h-[36px] min-w-[36px] flex items-center justify-center ${focusMode ? 'bg-white/20' : ''}`} title={focusMode ? 'Exit focus mode' : 'Focus mode'} aria-label={focusMode ? 'Exit focus mode' : 'Enter focus mode'}>
                        <i aria-hidden="true" data-lucide={focusMode ? 'minimize-2' : 'maximize-2'} className="w-4 h-4"></i>
                      </button>
                    </div>
                  </div>
                );
              })()}

              {/* Critical Alerts Banner */}
              {criticalAlerts.length > 0 && (
                <div className="mb-4 space-y-2" role="alert" aria-live="assertive" aria-atomic="true">
                  {criticalAlerts.map(alert => (
                    <div
                      key={alert.id}
                      className={`p-4 rounded-lg border-2 flex items-start gap-3 ${
                        alert.level === 'critical'
                          ? 'bg-red-50 border-red-500'
                          : 'bg-amber-50 border-amber-500'
                      }`}
                    >
                      <i
                        data-lucide="alert-triangle"
                        className={`w-6 h-6 flex-shrink-0 ${
                          alert.level === 'critical' ? 'text-red-600' : 'text-amber-600'
                        }`}
                      ></i>
                      <div className="flex-1">
                        <p className={`font-bold text-lg ${
                          alert.level === 'critical' ? 'text-red-900' : 'text-amber-900'
                        }`}>
                          {alert.message}
                        </p>
                        <p className={`text-sm mt-1 ${
                          alert.level === 'critical' ? 'text-red-800' : 'text-amber-800'
                        }`}>
                          {alert.action}
                        </p>
                      </div>
                      {alert.level !== 'critical' && (
                        <button
                          onClick={() => setCriticalAlerts(prev => prev.filter(a => a.id !== alert.id))}
                          className="text-slate-500 hover:text-slate-700 flex-shrink-0 min-h-[36px] min-w-[36px] flex items-center justify-center"
                          aria-label="Dismiss alert"
                        >
                          <i aria-hidden="true" data-lucide="x" className="w-5 h-5"></i>
                        </button>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {/* Primary Navigation */}
              <div className="mb-4 sm:mb-6 sticky top-0 z-30 app-nav" role="navigation" aria-label="Main navigation">
                <nav className="flex justify-around gap-0 bg-white border border-slate-200 rounded-xl p-1" role="tablist" aria-label="Main sections" onKeyDown={(e) => {
                  const tabs = ['dashboard', 'encounter', 'library', 'settings'];
                  const currentIndex = tabs.indexOf(activeTab);
                  let nextIndex;
                  if (e.key === 'ArrowRight') { e.preventDefault(); nextIndex = (currentIndex + 1) % tabs.length; }
                  else if (e.key === 'ArrowLeft') { e.preventDefault(); nextIndex = (currentIndex - 1 + tabs.length) % tabs.length; }
                  else if (e.key === 'Home') { e.preventDefault(); nextIndex = 0; }
                  else if (e.key === 'End') { e.preventDefault(); nextIndex = tabs.length - 1; }
                  if (nextIndex !== undefined) { navigateTo(tabs[nextIndex]); const el = document.getElementById(`tab-${tabs[nextIndex]}`); if (el) el.focus(); }
                }}>
                  {[
                    { id: 'dashboard', name: 'Dashboard', icon: 'layout-dashboard' },
                    { id: 'encounter', name: 'Encounter', icon: 'activity' },
                    { id: 'library', name: 'Library', icon: 'library' },
                    { id: 'settings', name: 'Settings', icon: 'settings' }
                  ].map(tab => {
                    const isActive = activeTab === tab.id;
                    return (
                      <button
                        key={tab.id}
                        id={`tab-${tab.id}`}
                        onClick={() => {
                          navigateTo(tab.id);
                        }}
                        className={`tab-pill py-3 sm:py-2 px-4 text-sm flex items-center space-x-2 transition-all min-h-[44px] sm:min-h-0 ${isActive ? 'active' : 'inactive'}`}
                        role="tab"
                        aria-selected={isActive}
                        aria-controls={`tabpanel-${tab.id}`}
                        tabIndex={isActive ? 0 : -1}
                      >
                        <i aria-hidden="true" data-lucide={tab.icon} className="w-4 h-4"></i>
                        <span>{tab.name}</span>
                      </button>
                    );
                  })}
                </nav>
              </div>

              {/* Content */}
              <div id="main-content" className="space-y-6 sm:space-y-8" role="region" aria-label="Main content area">

                {activeTab === 'dashboard' && (
                  <div id="tabpanel-dashboard" role="tabpanel" aria-labelledby="tab-dashboard" className="space-y-4">
                    <div className="bg-white border border-slate-200 rounded-xl p-4">
                      <div className="flex items-center justify-between gap-3 flex-wrap">
                        <div>
                          <h2 className="text-xl font-semibold text-slate-900">Dashboard</h2>
                          <p className="text-sm text-slate-600">Rapid overview and case launch controls.</p>
                        </div>
                        <div className="flex items-center gap-2">
                          <button
                            type="button"
                            onClick={() => { startNewPatient(); navigateTo('encounter'); }}
                            className="px-3 py-2 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700"
                          >
                            New Case
                          </button>
                          <button
                            type="button"
                            onClick={() => navigateTo('encounter')}
                            className="px-3 py-2 rounded-lg border border-slate-300 text-slate-700 text-sm font-semibold hover:bg-slate-50"
                          >
                            Resume Encounter
                          </button>
                        </div>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                      <div className="bg-white border border-slate-200 rounded-xl p-4">
                        <p className="text-xs uppercase tracking-wide text-slate-500">Current Case</p>
                        <p className="text-sm font-semibold text-slate-900 mt-1">{(telestrokeNote.age || '--')}{telestrokeNote.sex || ''} • NIHSS {telestrokeNote.nihss || nihssScore || '--'}</p>
                        <p className="text-xs text-slate-600 mt-1">{telestrokeNote.diagnosis || 'Diagnosis pending'}</p>
                        <div className="mt-3 flex flex-wrap gap-2">
                          <button type="button" onClick={() => { navigateTo('encounter'); scrollToSection('phase-decision'); }} className="px-2.5 py-1.5 rounded border border-orange-200 bg-orange-50 text-orange-800 text-xs font-semibold hover:bg-orange-100">Go to Decision</button>
                          <button type="button" onClick={() => { navigateTo('encounter'); scrollToSection('recommendations-section'); }} className="px-2.5 py-1.5 rounded border border-blue-200 bg-blue-50 text-blue-800 text-xs font-semibold hover:bg-blue-100">Go to Documentation</button>
                        </div>
                      </div>
                      <div className="bg-white border border-slate-200 rounded-xl p-4">
                        <p className="text-xs uppercase tracking-wide text-slate-500">Shift List</p>
                        <p className="text-2xl font-bold text-slate-900 mt-1">{shiftPatients.length}</p>
                        <p className="text-xs text-slate-600 mt-1">Saved patient snapshots</p>
                        <button type="button" onClick={() => navigateTo('encounter')} className="mt-3 px-2.5 py-1.5 rounded border border-slate-300 text-slate-700 text-xs font-semibold hover:bg-slate-50">Open Encounter Workspace</button>
                      </div>
                      <div className="bg-white border border-slate-200 rounded-xl p-4">
                        <p className="text-xs uppercase tracking-wide text-slate-500">Library Access</p>
                        <p className="text-sm text-slate-700 mt-1">Trials, protocols, references, and calculators.</p>
                        <div className="mt-3 flex gap-2">
                          <button type="button" onClick={() => navigateTo('library', { subTab: 'management' })} className="px-2.5 py-1.5 rounded border border-indigo-200 bg-indigo-50 text-indigo-800 text-xs font-semibold hover:bg-indigo-100">Protocols</button>
                          <button type="button" onClick={() => navigateTo('library', { subTab: 'trials' })} className="px-2.5 py-1.5 rounded border border-indigo-200 bg-indigo-50 text-indigo-800 text-xs font-semibold hover:bg-indigo-100">Trials</button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* CONSOLIDATED ENCOUNTER TAB */}
                {activeTab === 'encounter' && (
                  <div key="encounter-tab" id="tabpanel-encounter" role="tabpanel" aria-labelledby="tab-encounter" className="space-y-4">

                    {/* ===== PATIENT SUMMARY STRIP ===== */}
                    {(telestrokeNote.age || nihssScore > 0 || telestrokeNote.diagnosis) && (
                      <div className="sticky top-14 z-20 bg-white/95 backdrop-blur-sm border border-slate-200 rounded-xl shadow-sm px-4 py-2.5">
                        <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm">
                          {telestrokeNote.age && (
                            <span className="font-medium text-slate-700">
                              {telestrokeNote.age}{telestrokeNote.sex ? telestrokeNote.sex : ''}
                            </span>
                          )}
                          {(nihssScore > 0 || telestrokeNote.nihss) && (
                            <span className="font-semibold text-slate-900">
                              NIHSS: {telestrokeNote.nihss || nihssScore}
                            </span>
                          )}
                          {lkwElapsed && (
                            <span className="text-slate-600">
                              <i aria-hidden="true" data-lucide="clock" className="w-3.5 h-3.5 inline mr-1"></i>
                              {onsetLabel}: {lkwElapsed}
                            </span>
                          )}
                          {telestrokeNote.diagnosis && (
                            <span className="font-medium text-slate-700">
                              Dx: {telestrokeNote.diagnosis}
                            </span>
                          )}
                          {windowStatus && windowStatus.color !== 'gray' && (
                            <span className={`text-xs font-semibold px-2 py-0.5 rounded-full border ${windowToneClass}`}>
                              {windowStatus.message}
                            </span>
                          )}
                        </div>
                      </div>
                    )}

                    {/* ===== STROKE TIMELINE STRIP — connected visual timeline ===== */}
                    {(lkwTime || telestrokeNote.dtnEdArrival || telestrokeNote.tnkAdminTime) && (
                      <div className="bg-white border border-slate-200 rounded-xl px-4 py-3 overflow-x-auto no-scrollbar">
                        <div className="flex items-start gap-0 text-xs min-w-0 sm:min-w-max relative">
                          {[
                            { label: 'LKW', target: 'lkw-section', time: lkwTime ? lkwTime.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'}) : null, dot: 'bg-blue-500', line: 'bg-blue-200' },
                            { label: 'Door', target: 'lkw-section', time: safeFormatTime(telestrokeNote.dtnEdArrival), dot: 'bg-purple-500', line: 'bg-purple-200' },
                            { label: 'Alert', target: 'phase-triage', time: safeFormatTime(telestrokeNote.dtnStrokeAlert), dot: 'bg-amber-500', line: 'bg-amber-200' },
                            { label: 'CT', target: 'phase-triage', time: safeFormatTime(telestrokeNote.dtnCtStarted), dot: 'bg-slate-500', line: 'bg-slate-200' },
                            { label: 'TNK', target: 'treatment-decision', time: telestrokeNote.tnkAdminTime || null, dot: 'bg-emerald-500', line: 'bg-emerald-200' },
                            { label: 'Puncture', target: 'phase-management', time: telestrokeNote.punctureTime || null, dot: 'bg-indigo-500', line: 'bg-indigo-200' }
                          ].filter(t => t.time).map((t, i, arr) => (
                            <React.Fragment key={t.label}>
                              <button
                                type="button"
                                onClick={() => scrollToSection(t.target)}
                                className="flex flex-col items-center min-w-[60px] rounded-lg px-1 py-0.5 hover:bg-slate-50 focus:ring-2 focus:ring-blue-500"
                                aria-label={`Jump to ${t.label} section`}
                              >
                                <div className={`w-3 h-3 rounded-full ${t.dot} ring-2 ring-white shadow-sm z-10`}></div>
                                <span className="font-semibold text-slate-700 mt-1">{t.label}</span>
                                <span className="font-mono text-slate-500">{t.time}</span>
                              </button>
                              {i < arr.length - 1 && (
                                <div className={`flex-1 h-0.5 ${t.line} self-center mt-1.5 min-w-[24px] -mx-1`} style={{marginTop: '5px'}}></div>
                              )}
                            </React.Fragment>
                          ))}
                          {(() => {
                            const metrics = calculateDTNMetrics();
                            if (metrics.doorToNeedle !== null) {
                              const b = getDTNBenchmark(metrics.doorToNeedle);
                              return <div className="ml-3 self-center"><span className={`px-2.5 py-1 rounded-full font-bold text-xs ${b.color === 'green' ? 'bg-emerald-500 text-white' : b.color === 'yellow' ? 'bg-amber-500 text-white' : 'bg-red-500 text-white'}`}>DTN {metrics.doorToNeedle}m ({b.label})</span></div>;
                            }
                            return null;
                          })()}
                        </div>
                      </div>
                    )}

                    {/* ===== CONSULTATION TYPE ===== */}
                    <div className="flex items-center gap-2 px-1">
                      <span className="text-xs font-medium text-slate-500 uppercase tracking-wide">Mode:</span>
                      <div className="flex gap-1">
                        {[
                          { id: 'acute', label: 'Video Telestroke', icon: 'zap' },
                          { id: 'phone', label: 'Phone Consult', icon: 'phone' }
                        ].map(ctx => (
                          <button
                            key={ctx.id}
                            onClick={() => {
                              setClinicalContext(ctx.id);
                              if (ctx.id === 'acute') setConsultationType('videoTelestroke');
                              else setConsultationType('telephone');
                            }}
                            className={`text-xs px-2.5 py-1.5 rounded-lg font-medium transition-all flex items-center gap-1 ${
                              clinicalContext === ctx.id
                                ? 'bg-blue-600 text-white shadow-sm'
                                : 'text-slate-500 hover:bg-slate-100'
                            }`}
                          >
                            <i aria-hidden="true" data-lucide={ctx.icon} className="w-3 h-3"></i>
                            {ctx.label}
                          </button>
                        ))}
                      </div>
                    </div>

                    {/* ===== MISSING FIELDS WARNING ===== */}
                    {(() => {
                      const {
                        trackedFields,
                        missing,
                        required: requiredFields,
                        recommended: recommendedFields,
                        completedCount,
                        readinessPercent,
                        nextField
                      } = encounterReadiness;
                      return missing.length > 0 && missing.length < trackedFields.length ? (
                        <div className="bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 text-sm space-y-2">
                          <div className="flex flex-wrap items-center justify-between gap-2">
                            <span className="text-xs font-semibold uppercase tracking-wide text-amber-800">
                              Case Readiness: {completedCount}/{trackedFields.length}
                            </span>
                            <div className="flex items-center gap-2">
                              <span className="text-xs text-amber-700">{readinessPercent}% complete</span>
                              {nextField && (
                                <button
                                  type="button"
                                  onClick={() => jumpToEncounterField(nextField)}
                                  className="px-2 py-0.5 rounded-full border border-amber-300 bg-white hover:bg-amber-100 text-amber-800 text-xs font-semibold"
                                >
                                  Next: {nextField}
                                </button>
                              )}
                            </div>
                          </div>
                          <div className="h-1.5 w-full rounded-full bg-amber-100 overflow-hidden">
                            <div className="h-full bg-amber-500 transition-all" style={{ width: `${readinessPercent}%` }}></div>
                          </div>
                          {requiredFields.length > 0 && (
                            <div className="flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="alert-circle" className="w-3.5 h-3.5 text-red-500 shrink-0"></i>
                              <div className="text-red-700 flex flex-wrap items-center gap-1.5">
                                <span className="font-semibold">Required:</span>
                                {requiredFields.map((field) => (
                                  <button
                                    key={`required-${field.name}`}
                                    type="button"
                                    onClick={() => jumpToEncounterField(field.name)}
                                    className="px-2 py-0.5 rounded-full border border-red-300 bg-white hover:bg-red-100 text-red-700 text-xs font-semibold"
                                  >
                                    {field.name}
                                  </button>
                                ))}
                              </div>
                            </div>
                          )}
                          {recommendedFields.length > 0 && (
                            <div className="flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="alert-triangle" className="w-3.5 h-3.5 text-amber-500 shrink-0"></i>
                              <div className="text-amber-700 flex flex-wrap items-center gap-1.5">
                                <span className="font-medium">Recommended:</span>
                                {recommendedFields.map((field) => (
                                  <button
                                    key={`recommended-${field.name}`}
                                    type="button"
                                    onClick={() => jumpToEncounterField(field.name)}
                                    className="px-2 py-0.5 rounded-full border border-amber-300 bg-white hover:bg-amber-100 text-amber-700 text-xs font-semibold"
                                  >
                                    {field.name}
                                  </button>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>
                      ) : null;
                    })()}

                    {(() => {
                      const pathway = telestrokeNote.diagnosisCategory || getPathwayForDiagnosis(telestrokeNote.diagnosis || '');
                      const pathwaySubTab = ['ischemic', 'ich', 'sah', 'tia', 'cvt'].includes(pathway) ? pathway : null;
                      if (!pathwaySubTab) return null;
                      const pathwayLabelMap = {
                        ischemic: 'Ischemic Pathway',
                        ich: 'Hemorrhagic (ICH) Pathway',
                        sah: 'SAH Pathway',
                        tia: 'TIA/Prevention Pathway',
                        cvt: 'CVT Pathway'
                      };
                      return (
                        <div className="bg-slate-50 border border-slate-200 rounded-xl p-3 flex flex-wrap items-center justify-between gap-2">
                          <div className="text-sm text-slate-700">
                            <span className="font-semibold">Condition pathway:</span> {pathwayLabelMap[pathwaySubTab]}
                          </div>
                          <button
                            type="button"
                            onClick={() => {
                              navigateTo('library', { subTab: 'management' });
                              setManagementSubTab(pathwaySubTab);
                            }}
                            className="px-3 py-1.5 rounded-lg bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800"
                          >
                            Open pathway
                          </button>
                        </div>
                      );
                    })()}

                    {/* ===== ENCOUNTER TEMPLATES (shown when no data entered yet) ===== */}
                    {!telestrokeNote.age && !nihssScore && !telestrokeNote.diagnosis && (
                      <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4">
                        <h3 className="text-sm font-semibold text-blue-900 mb-3 flex items-center gap-2">
                          <i aria-hidden="true" data-lucide="layout-grid" className="w-4 h-4"></i>
                          Quick Start Templates
                        </h3>
                        <div className="grid grid-cols-2 sm:grid-cols-5 gap-2">
                          {ENCOUNTER_TEMPLATES.map(tmpl => (
                            <button
                              key={tmpl.id}
                              onClick={() => {
                                if (tmpl.defaults && Object.keys(tmpl.defaults).length > 0) {
                                  setTelestrokeNote(prev => {
                                    const updated = { ...prev, ...tmpl.defaults };
                                    // Clear stale treatment flags when diagnosis category changes
                                    if (tmpl.defaults.diagnosisCategory && tmpl.defaults.diagnosisCategory !== prev.diagnosisCategory) {
                                      if (tmpl.defaults.diagnosisCategory !== 'ischemic') {
                                        updated.tnkRecommended = false;
                                        updated.evtRecommended = false;
                                      }
                                      if (tmpl.defaults.diagnosisCategory !== 'ich') {
                                        updated.ichReversalInitiated = false;
                                      }
                                    }
                                    return updated;
                                  });
                                  if (tmpl.defaults.diagnosisCategory === 'ich') {
                                    setManagementSubTab('ich');
                                  }
                                  addToast(`Template: ${tmpl.label}`, 'info');
                                }
                              }}
                              className="flex flex-col items-center gap-1.5 px-3 py-3 bg-white border border-blue-200 rounded-xl hover:bg-blue-50 hover:border-blue-400 transition-all text-center"
                            >
                              <i aria-hidden="true" data-lucide={tmpl.icon} className="w-5 h-5 text-blue-600"></i>
                              <span className="text-xs font-semibold text-slate-800">{tmpl.label}</span>
                              <span className="text-xs text-slate-500">{tmpl.description}</span>
                            </button>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* ===== ENCOUNTER HISTORY (collapsible) ===== */}
                    {encounterHistory.length > 0 && !telestrokeNote.age && (
                      <details id="encounter-history-section" className="bg-slate-50 border border-slate-200 rounded-xl">
                        <summary className="cursor-pointer px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-100 rounded-xl flex items-center gap-2">
                          <i aria-hidden="true" data-lucide="history" className="w-4 h-4 text-slate-500"></i>
                          Recent Encounters ({encounterHistory.length})
                        </summary>
                        <div className="px-4 pb-3 space-y-1.5">
                          {encounterHistory.slice(0, 10).map(enc => (
                            <div key={enc.id} className="flex items-center justify-between px-3 py-2 bg-white border border-slate-200 rounded-lg text-xs">
                              <div className="flex items-center gap-3">
                                <span className="text-slate-500">{new Date(enc.timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
                                <span className="font-semibold text-slate-800">{enc.age}{enc.sex || ''}</span>
                                <span className="text-slate-600">{enc.diagnosis}</span>
                                <span className="text-slate-500">NIHSS {enc.nihss}</span>
                              </div>
                              <div className="flex items-center gap-2">
                                <span className={`font-medium ${enc.tnk === 'Yes' ? 'text-emerald-600' : 'text-slate-500'}`}>TNK: {enc.tnk}</span>
                                <span className={`font-medium ${enc.evt === 'Yes' ? 'text-blue-600' : 'text-slate-500'}`}>EVT: {enc.evt}</span>
                              </div>
                            </div>
                          ))}
                        </div>
                      </details>
                    )}

                    {/* ===== TRIAGE SECTION ===== */}
                    <div id="phase-triage"></div>

                    {quickLinks.length > 0 && (
                      <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <div className="flex items-center justify-between mb-3">
                          <h3 className="text-sm font-semibold text-blue-900 uppercase tracking-wide">Quick Links</h3>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-3 flex-wrap">
                          {quickLinks.map((link, index) => (
                            <a
                              key={`${link.label}-${index}`}
                              href={link.url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="flex items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                            >
                              <i aria-hidden="true" data-lucide="external-link" className="w-5 h-5"></i>
                              <div className="flex flex-col">
                                <span>{link.label}</span>
                                {link.note && (
                                  <span className="text-xs text-blue-700">{link.note}</span>
                                )}
                              </div>
                            </a>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Calling Site Dropdown - Shared for all consult types */}
                    {(
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <label htmlFor="input-calling-site" className="block text-sm font-medium text-blue-900 mb-1">
                        <i aria-hidden="true" data-lucide="map-pin" className="w-4 h-4 inline mr-1"></i>
                        Calling Site
                      </label>
                      <select
                        id="input-calling-site"
                        value={telestrokeNote.callingSite}
                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, callingSite: v, callingSiteOther: v === 'Other' ? prev.callingSiteOther : ''})); }}
                        className="w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                      >
                        <option value="">-- Select Site --</option>
                        {CALLING_SITES.map(g => (
                          <optgroup key={g.group} label={g.group}>
                            {g.sites.map(s => <option key={s} value={s}>{s}</option>)}
                          </optgroup>
                        ))}
                        <option value="Other">Other (specify below)</option>
                      </select>
                      {telestrokeNote.callingSite === 'Other' && (
                        <input
                          type="text"
                          aria-label="Other calling site name"
                          value={telestrokeNote.callingSiteOther}
                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, callingSiteOther: v})); }}
                          className="w-full mt-2 px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                          placeholder="Enter site name..."
                        />
                      )}
                    </div>
                    )}

                    {/* Last Known Well Input - Show for Video Telestroke */}
                    {consultationType === 'videoTelestroke' && (
                    <div id="lkw-section" className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                      <div className="flex items-center justify-between mb-2">
                        <label className="block font-semibold text-blue-900">
                          <i aria-hidden="true" data-lucide="clock" className="w-4 h-4 inline mr-1"></i>
                          Last Known Well Time *
                        </label>
                        <button
                          type="button"
                          onClick={() => {
                            const now = new Date();
                            setLkwTime(now);
                          }}
                          className="text-xs font-semibold text-blue-700 hover:text-blue-900"
                        >
                          Use Now
                        </button>
                      </div>

                      {/* Separate Date and Time Inputs */}
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div className="min-w-0">
                          <div className="flex items-center justify-between mb-1">
                            <label htmlFor="lkw-date" className="block text-sm font-medium text-blue-900">Date</label>
                            <NowButton onClick={() => setLkwTime(new Date())} label="Set LKW to now" />
                          </div>
                          <input
                            id="lkw-date"
                            type="date"
                            value={lkwTime ? `${lkwTime.getFullYear()}-${String(lkwTime.getMonth() + 1).padStart(2, '0')}-${String(lkwTime.getDate()).padStart(2, '0')}` : ''}
                            onChange={(e) => {
                              if (e.target.value) {
                                // Parse as local date to avoid timezone issues
                                const [year, month, day] = e.target.value.split('-').map(Number);
                                const newDate = new Date(year, month - 1, day); // month is 0-indexed
                                if (lkwTime) {
                                  newDate.setHours(lkwTime.getHours(), lkwTime.getMinutes());
                                }
                                setLkwTime(newDate);
                              }
                            }}
                            max={`${currentTime.getFullYear()}-${String(currentTime.getMonth() + 1).padStart(2, '0')}-${String(currentTime.getDate()).padStart(2, '0')}`}
                            className="w-full px-2 sm:px-4 py-3 border border-blue-200 rounded-xl text-base sm:text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 max-w-full"
                            style={{boxSizing: 'border-box'}}
                          />
                        </div>
                        <div className="min-w-0">
                          <label htmlFor="lkw-time" className="block text-sm font-medium text-blue-900 mb-1">Time</label>
                          <input
                            id="lkw-time"
                            type="time"
                            value={lkwTime ? lkwTime.toTimeString().slice(0, 5) : ''}
                            onChange={(e) => {
                              if (e.target.value) {
                                const [hours, minutes] = e.target.value.split(':');
                                const newDate = lkwTime ? new Date(lkwTime) : new Date();
                                newDate.setHours(parseInt(hours, 10), parseInt(minutes, 10));
                                setLkwTime(newDate);
                              }
                            }}
                            className="w-full px-2 sm:px-4 py-3 border border-blue-200 rounded-xl text-base sm:text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 max-w-full"
                            style={{boxSizing: 'border-box'}}
                          />
                        </div>
                      </div>

                      {/* Wake-up Stroke / Unknown LKW Checkbox */}
                      <div className="mt-3">
                        <label className="flex items-center gap-2 cursor-pointer">
                          <input
                            type="checkbox"
                            checked={telestrokeNote.lkwUnknown}
                            onChange={(e) => {
                              const nextValue = e.target.checked;
                              setTelestrokeNote(prev => ({
                                ...prev,
                                lkwUnknown: nextValue,
                                wakeUpStrokeWorkflow: { ...(prev.wakeUpStrokeWorkflow || {}), isWakeUpStroke: nextValue },
                                discoveryDate: nextValue ? (prev.discoveryDate || new Date().toISOString().split('T')[0]) : prev.discoveryDate,
                                discoveryTime: nextValue ? (prev.discoveryTime || new Date().toTimeString().slice(0, 5)) : prev.discoveryTime
                              }));
                            }}
                            className="w-5 h-5 rounded border-2 border-purple-400 text-purple-600 focus:ring-purple-500"
                          />
                          <span className="font-semibold text-purple-800">Wake-up Stroke / Unknown LKW</span>
                        </label>
                      </div>

                      {telestrokeNote.lkwUnknown && (
                        <div className="mt-3 bg-purple-50 border border-purple-200 rounded-lg p-3">
                          <div className="flex items-center justify-between mb-2">
                            <span className="text-sm font-semibold text-purple-800">Discovery Time</span>
                            <button
                              onClick={() => setTelestrokeNote(prev => ({...prev,
                                discoveryDate: new Date().toISOString().split('T')[0],
                                discoveryTime: new Date().toTimeString().slice(0, 5)
                              }))}
                              className="text-xs font-semibold text-purple-700 hover:text-purple-900 min-h-[36px]"
                              type="button"
                              aria-label="Set discovery time to now"
                            >
                              Use Now
                            </button>
                          </div>
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <input
                              type="date"
                              aria-label="Discovery date"
                              value={telestrokeNote.discoveryDate}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, discoveryDate: v})); }}
                              className="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            />
                            <input
                              type="time"
                              aria-label="Discovery time"
                              value={telestrokeNote.discoveryTime}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, discoveryTime: v})); }}
                              className="w-full px-3 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            />
                          </div>
                          {timeFromLKW && (
                            <p className="text-xs text-purple-700 mt-2">
                              {timeFromLKW.hours}h {timeFromLKW.minutes}m from discovery
                            </p>
                          )}
                        </div>
                      )}

                      {/* Wake-up Stroke Decision Tree Panel */}
                      {telestrokeNote.lkwUnknown && (
                        <div className="mt-3 bg-purple-50 border border-purple-200 rounded-xl p-4 space-y-4">
                          <div className="flex items-center gap-2">
                            <span className="text-lg font-bold text-purple-900"><i aria-hidden="true" data-lucide="moon" className="w-5 h-5 inline mr-1"></i> Wake-up Stroke Evaluation</span>
                          </div>

                          {/* MRI Availability Decision Point */}
                          <div className="space-y-2">
                            <div className="font-semibold text-purple-800">Is MRI with DWI-FLAIR available?</div>
                            <div className="flex gap-2">
                              <button
                                onClick={() => setTelestrokeNote(prev => ({...prev,
                                  wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), mriAvailable: true}
                                }))}
                                className={`px-4 py-2 rounded-lg font-medium transition-all ${
                                  telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === true
                                    ? 'bg-purple-600 text-white'
                                    : 'bg-white border-2 border-purple-300 text-purple-700 hover:bg-purple-100'
                                }`}
                              >
                                Yes - MRI Available
                              </button>
                              <button
                                onClick={() => setTelestrokeNote(prev => ({...prev,
                                  wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), mriAvailable: false}
                                }))}
                                className={`px-4 py-2 rounded-lg font-medium transition-all ${
                                  telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === false
                                    ? 'bg-orange-600 text-white'
                                    : 'bg-white border-2 border-orange-300 text-orange-700 hover:bg-orange-100'
                                }`}
                              >
                                No - Use CTP
                              </button>
                            </div>
                          </div>

                          {/* WAKE-UP Trial Criteria (MRI-guided) */}
                          {telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === true && (
                            <div className="bg-white border border-purple-200 rounded-lg p-3 space-y-2">
                              <div className="font-bold text-purple-800 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="flask-conical" className="w-4 h-4 text-purple-600"></i>
                                <span>WAKE-UP Trial Criteria (MRI-guided)</span>
                                <a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1804355" target="_blank" rel="noopener noreferrer"
                                   className="text-xs text-purple-600 hover:underline">[NEJM 2018]</a>
                              </div>
                              <div className="grid gap-2 text-sm">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.dwi?.positiveForLesion}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {
                                        ...(prev.wakeUpStrokeWorkflow || {}),
                                        dwi: {...(prev.wakeUpStrokeWorkflow?.dwi || {}), positiveForLesion: e.target.checked}
                                      }
                                    }))}
                                    className="w-4 h-4 rounded border-purple-400 text-purple-600"
                                  />
                                  <span>DWI positive lesion visible</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.flair?.noMarkedHyperintensity}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {
                                        ...(prev.wakeUpStrokeWorkflow || {}),
                                        flair: {...(prev.wakeUpStrokeWorkflow?.flair || {}), noMarkedHyperintensity: e.target.checked}
                                      }
                                    }))}
                                    className="w-4 h-4 rounded border-purple-400 text-purple-600"
                                  />
                                  <span>No marked parenchymal hyperintensity on FLAIR</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.ageEligible}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), ageEligible: e.target.checked}
                                    }))}
                                    className="w-4 h-4 rounded border-purple-400 text-purple-600"
                                  />
                                  <span>Age 18-80 years</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.nihssEligible}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), nihssEligible: e.target.checked}
                                    }))}
                                    className="w-4 h-4 rounded border-purple-400 text-purple-600"
                                  />
                                  <span>NIHSS ≤25</span>
                                </label>
                              </div>
                              {/* Eligibility Summary */}
                              {telestrokeNote.wakeUpStrokeWorkflow?.dwi?.positiveForLesion &&
                               telestrokeNote.wakeUpStrokeWorkflow?.flair?.noMarkedHyperintensity &&
                               telestrokeNote.wakeUpStrokeWorkflow?.ageEligible &&
                               telestrokeNote.wakeUpStrokeWorkflow?.nihssEligible && (
                                <div role="alert" className="bg-emerald-100 border border-emerald-300 rounded-lg p-2 text-emerald-800 font-semibold text-sm flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="check-circle" className="w-4 h-4"></i>
                                  <span>Meets WAKE-UP criteria - Consider IV thrombolysis</span>
                                </div>
                              )}
                              {telestrokeNote.tnkAutoBlocked && (
                                <div className="text-xs text-red-700 bg-red-50 border border-red-200 rounded-lg p-2">
                                  TNK auto-disabled: {telestrokeNote.tnkAutoBlockReason || 'Contraindication detected'}. Override only with documented justification.
                                </div>
                              )}
                            </div>
                          )}

                          {/* EXTEND Trial Criteria (Perfusion-guided) */}
                          {telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === false && (
                            <div className="bg-white border border-orange-200 rounded-lg p-3 space-y-2">
                              <div className="font-bold text-orange-800 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="brain" className="w-4 h-4 text-orange-600"></i>
                                <span>EXTEND Trial Criteria (Perfusion Imaging)</span>
                                <a href="https://www.nejm.org/doi/full/10.1056/NEJMoa1813046" target="_blank" rel="noopener noreferrer"
                                   className="text-xs text-orange-600 hover:underline">[NEJM 2019]</a>
                              </div>
                              <div className="grid gap-2 text-sm">
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.nihss4to26}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {
                                        ...(prev.wakeUpStrokeWorkflow || {}),
                                        extendCriteria: {...(prev.wakeUpStrokeWorkflow?.extendCriteria || {}), nihss4to26: e.target.checked}
                                      }
                                    }))}
                                    className="w-4 h-4 rounded border-orange-400 text-orange-600"
                                  />
                                  <span>NIHSS 4-26</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.premorbidMRSLt2}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {
                                        ...(prev.wakeUpStrokeWorkflow || {}),
                                        extendCriteria: {...(prev.wakeUpStrokeWorkflow?.extendCriteria || {}), premorbidMRSLt2: e.target.checked}
                                      }
                                    }))}
                                    className="w-4 h-4 rounded border-orange-400 text-orange-600"
                                  />
                                  <span>Pre-morbid mRS &lt;2</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.ischemicCoreLte70}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {
                                        ...(prev.wakeUpStrokeWorkflow || {}),
                                        extendCriteria: {...(prev.wakeUpStrokeWorkflow?.extendCriteria || {}), ischemicCoreLte70: e.target.checked}
                                      }
                                    }))}
                                    className="w-4 h-4 rounded border-orange-400 text-orange-600"
                                  />
                                  <span>Ischemic core ≤70mL</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.mismatchRatioGte1_2}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {
                                        ...(prev.wakeUpStrokeWorkflow || {}),
                                        extendCriteria: {...(prev.wakeUpStrokeWorkflow?.extendCriteria || {}), mismatchRatioGte1_2: e.target.checked}
                                      }
                                    }))}
                                    className="w-4 h-4 rounded border-orange-400 text-orange-600"
                                  />
                                  <span>Mismatch ratio ≥1.2</span>
                                </label>
                                <label className="flex items-center gap-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.timeWindow4_5to9h}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      wakeUpStrokeWorkflow: {
                                        ...(prev.wakeUpStrokeWorkflow || {}),
                                        extendCriteria: {...(prev.wakeUpStrokeWorkflow?.extendCriteria || {}), timeWindow4_5to9h: e.target.checked}
                                      }
                                    }))}
                                    className="w-4 h-4 rounded border-orange-400 text-orange-600"
                                  />
                                  <span>Time 4.5-9 hours OR wake-up stroke</span>
                                </label>
                              </div>
                              {/* Eligibility Summary */}
                              {telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.nihss4to26 &&
                               telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.premorbidMRSLt2 &&
                               telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.ischemicCoreLte70 &&
                               telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.mismatchRatioGte1_2 &&
                               telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.timeWindow4_5to9h && (
                                <div className="bg-emerald-100 border border-emerald-300 rounded-lg p-2 text-emerald-800 font-semibold text-sm flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="check-circle" className="w-4 h-4"></i>
                                  <span>Meets EXTEND criteria - Consider IV thrombolysis</span>
                                </div>
                              )}
                            </div>
                          )}

                          {/* Imaging Recommendation Auto-suggest */}
                          {telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable !== null && (
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                              <div className="font-semibold text-blue-800 mb-2 flex items-center gap-1"><i aria-hidden="true" data-lucide="clipboard-list" className="w-4 h-4"></i> Suggested Imaging Recommendation:</div>
                              <div className="text-sm text-blue-900 bg-white rounded p-2 border border-blue-200">
                                {telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === true
                                  ? "Obtain MRI brain with DWI/FLAIR to assess for DWI-FLAIR mismatch (WAKE-UP trial criteria). If positive DWI lesion with no corresponding FLAIR hyperintensity, patient may be candidate for IV thrombolysis."
                                  : "Obtain CT Perfusion to assess for perfusion mismatch (EXTEND trial criteria). If ischemic core ≤70mL with mismatch ratio ≥1.2, patient may be candidate for IV thrombolysis in extended window."
                                }
                              </div>
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                    )}

                    {/* ============================================ */}
                    {/* TELEPHONE CONSULT - Enhanced Clinical Form  */}
                    {/* ============================================ */}
                    {consultationType === 'telephone' && (
                      <div className="space-y-4">

                        {/* Header with LKW Timer + Consult Duration */}
                        <div className="bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg p-4 shadow-lg">
                          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                              <h3 className="text-xl font-bold flex items-center gap-2"><i aria-hidden="true" data-lucide="phone" className="w-5 h-5"></i> Telephone Consult</h3>
                              {telestrokeNote.consultStartTime && (
                                <span className="text-xs opacity-80">Started {telestrokeNote.consultStartTime}</span>
                              )}
                            </div>
                            <div className="flex items-center gap-3">
                              {lkwTime && (
                                <div className="bg-white/20 rounded-lg px-4 py-2 text-center">
                                  <span className="text-2xl font-bold">
                                    {(() => {
                                      const tf = calculateTimeFromLKW();
                                      return tf ? `${tf.hours}h ${tf.minutes}m` : '--:--';
                                    })()}
                                  </span>
                                  <span className="text-sm ml-2 opacity-90">from LKW</span>
                                </div>
                              )}
                              {!telestrokeNote.consultStartTime && (
                                <button type="button" onClick={() => setTelestrokeNote(prev => ({...prev, consultStartTime: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'})}))}
                                  className="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-colors">
                                  Start Timer
                                </button>
                              )}
                            </div>
                          </div>
                        </div>

                        {/* Consultation Metadata */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                          <div>
                            <label htmlFor="input-caller-name" className="block text-xs font-medium text-slate-600 mb-1">Caller Name</label>
                            <input id="input-caller-name" type="text" value={telestrokeNote.callerName}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, callerName: v})); }}
                              placeholder="e.g., Dr. Smith"
                              className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500" />
                          </div>
                          <div>
                            <label htmlFor="input-caller-role" className="block text-xs font-medium text-slate-600 mb-1">Caller Role</label>
                            <select id="input-caller-role" value={telestrokeNote.callerRole}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, callerRole: v})); }}
                              className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500">
                              <option value="">--</option>
                              <option value="ED Physician">ED Physician</option>
                              <option value="ED NP/PA">ED NP/PA</option>
                              <option value="Hospitalist">Hospitalist</option>
                              <option value="Neurology Resident">Neurology Resident</option>
                              <option value="RN">RN</option>
                              <option value="Other">Other</option>
                            </select>
                          </div>
                          <div>
                            <label htmlFor="input-attending" className="block text-xs font-medium text-slate-600 mb-1">Attending</label>
                            <input id="input-attending" type="text" value={telestrokeNote.attendingPhysician}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, attendingPhysician: v})); }}
                              placeholder="Attending name"
                              className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500" />
                          </div>
                          <div>
                            <label htmlFor="input-consult-time" className="block text-xs font-medium text-slate-600 mb-1">Consult Time</label>
                            <input id="input-consult-time" type="time" value={telestrokeNote.consultStartTime || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, consultStartTime: v})); }}
                              className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500" />
                          </div>
                        </div>

                        {/* Section 1b: Last Known Well */}
                        <div id="lkw-section" className="bg-amber-50 border border-amber-200 rounded-xl p-4 shadow-md">
                          <div className="flex items-center justify-between mb-1">
                            <label className="block text-sm font-medium text-amber-900">
                              <i aria-hidden="true" data-lucide="clock" className="w-4 h-4 inline mr-1"></i>
                              Last Known Well
                            </label>
                            <NowButton onClick={() => setLkwTime(new Date())} label="Set LKW to now" />
                          </div>
                          <div className="grid grid-cols-2 gap-2">
                            <input
                              aria-label="Last known well date"
                              type="date"
                              value={lkwTime ? `${lkwTime.getFullYear()}-${String(lkwTime.getMonth() + 1).padStart(2, '0')}-${String(lkwTime.getDate()).padStart(2, '0')}` : ''}
                              onChange={(e) => {
                                if (e.target.value) {
                                  // Parse as local date to avoid timezone issues
                                  const [year, month, day] = e.target.value.split('-').map(Number);
                                  const newDate = new Date(year, month - 1, day); // month is 0-indexed
                                  if (lkwTime) {
                                    newDate.setHours(lkwTime.getHours(), lkwTime.getMinutes());
                                  }
                                  setLkwTime(newDate);
                                }
                              }}
                              max={`${currentTime.getFullYear()}-${String(currentTime.getMonth() + 1).padStart(2, '0')}-${String(currentTime.getDate()).padStart(2, '0')}`}
                              className="w-full px-2 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                            />
                            <input
                              aria-label="Last known well time"
                              type="time"
                              value={lkwTime ? lkwTime.toTimeString().slice(0, 5) : ''}
                              onChange={(e) => {
                                if (e.target.value) {
                                  const [hours, minutes] = e.target.value.split(':');
                                  const newDate = lkwTime ? new Date(lkwTime) : new Date();
                                  newDate.setHours(parseInt(hours, 10), parseInt(minutes, 10));
                                  setLkwTime(newDate);
                                }
                              }}
                              className="w-full px-2 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                            />
                          </div>
                          {strokeWindow?.timeFrom && (
                            <div className={`mt-3 rounded-lg border px-3 py-2 text-xs ${
                              strokeWindow.status?.color === 'green'
                                ? 'bg-emerald-50 border-emerald-200 text-emerald-800'
                                : strokeWindow.status?.color === 'yellow'
                                  ? 'bg-amber-50 border-amber-200 text-amber-800'
                                  : strokeWindow.status?.color === 'orange'
                                    ? 'bg-orange-50 border-orange-200 text-orange-800'
                                    : strokeWindow.status?.color === 'red'
                                      ? 'bg-red-50 border-red-200 text-red-800'
                                      : 'bg-slate-50 border-slate-200 text-slate-600'
                            }`}>
                              <div className="flex flex-wrap items-center justify-between gap-2">
                                <span className="font-semibold">{strokeWindow.status?.message || 'Treatment window'}</span>
                                <span>{strokeWindow.timeFrom.hours}h {strokeWindow.timeFrom.minutes}m since {strokeWindow.label}</span>
                              </div>
                            </div>
                          )}

                          {/* Wake-up Stroke / Unknown LKW */}
                          <div className="mt-3">
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={telestrokeNote.lkwUnknown}
                                onChange={(e) => {
                                  const nextValue = e.target.checked;
                                  setTelestrokeNote(prev => ({...prev,
                                    lkwUnknown: nextValue,
                                    wakeUpStrokeWorkflow: { ...(prev.wakeUpStrokeWorkflow || {}), isWakeUpStroke: nextValue },
                                    discoveryDate: nextValue ? (prev.discoveryDate || new Date().toISOString().split('T')[0]) : prev.discoveryDate,
                                    discoveryTime: nextValue ? (prev.discoveryTime || new Date().toTimeString().slice(0, 5)) : prev.discoveryTime
                                  }));
                                }}
                                className="w-4 h-4 rounded border-2 border-purple-400 text-purple-600 focus:ring-purple-500"
                              />
                              <span className="text-sm font-semibold text-purple-800">Wake-up Stroke / Unknown LKW</span>
                            </label>
                          </div>

                          {telestrokeNote.lkwUnknown && (
                            <div className="mt-2 bg-purple-50 border border-purple-200 rounded-lg p-3 space-y-3">
                              <div className="flex items-center justify-between">
                                <span className="text-sm font-semibold text-purple-800">Discovery Time</span>
                                <button
                                  onClick={() => setTelestrokeNote(prev => ({...prev,
                                    discoveryDate: new Date().toISOString().split('T')[0],
                                    discoveryTime: new Date().toTimeString().slice(0, 5)
                                  }))}
                                  className="text-xs font-semibold text-purple-700 hover:text-purple-900"
                                  type="button"
                                >
                                  Use Now
                                </button>
                              </div>
                              <div className="grid grid-cols-2 gap-2">
                                <input type="date" value={telestrokeNote.discoveryDate}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, discoveryDate: v})); }}
                                  className="w-full px-2 py-1.5 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm" />
                                <input type="time" value={telestrokeNote.discoveryTime}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, discoveryTime: v})); }}
                                  className="w-full px-2 py-1.5 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm" />
                              </div>

                              {/* MRI Availability Decision Point */}
                              <div className="space-y-2">
                                <div className="text-sm font-semibold text-purple-800">Is MRI with DWI-FLAIR available?</div>
                                <div className="flex gap-2">
                                  <button onClick={() => setTelestrokeNote(prev => ({...prev, wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), mriAvailable: true}}))}
                                    className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === true ? 'bg-purple-600 text-white' : 'bg-white border border-purple-300 text-purple-700 hover:bg-purple-100'}`}>
                                    Yes - MRI
                                  </button>
                                  <button onClick={() => setTelestrokeNote(prev => ({...prev, wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), mriAvailable: false}}))}
                                    className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === false ? 'bg-orange-600 text-white' : 'bg-white border border-orange-300 text-orange-700 hover:bg-orange-100'}`}>
                                    No - Use CTP
                                  </button>
                                </div>
                              </div>

                              {/* WAKE-UP Trial Criteria */}
                              {telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === true && (
                                <div className="bg-white border border-purple-200 rounded-lg p-2 space-y-1 text-sm">
                                  <div className="font-bold text-purple-800">WAKE-UP Trial Criteria</div>
                                  {[
                                    { key: 'dwi', label: 'DWI positive lesion', path: 'dwi.positiveForLesion' },
                                    { key: 'flair', label: 'No FLAIR hyperintensity', path: 'flair.noMarkedHyperintensity' },
                                    { key: 'age', label: 'Age 18-80', path: 'ageEligible' },
                                    { key: 'nihss', label: 'NIHSS ≤25', path: 'nihssEligible' }
                                  ].map(item => (
                                    <label key={item.key} className="flex items-center gap-2 cursor-pointer">
                                      <input type="checkbox"
                                        checked={item.path.includes('.') ? (telestrokeNote.wakeUpStrokeWorkflow?.[item.path.split('.')[0]] || {})[item.path.split('.')[1]] : telestrokeNote.wakeUpStrokeWorkflow?.[item.path]}
                                        onChange={(e) => {
                                          const checked = e.target.checked;
                                          if (item.path.includes('.')) {
                                            const [parent, child] = item.path.split('.');
                                            setTelestrokeNote(prev => ({...prev, wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), [parent]: {...(prev.wakeUpStrokeWorkflow?.[parent] || {}), [child]: checked}}}));
                                          } else {
                                            setTelestrokeNote(prev => ({...prev, wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), [item.path]: checked}}));
                                          }
                                        }}
                                        className="w-4 h-4 rounded border-purple-400 text-purple-600" />
                                      <span>{item.label}</span>
                                    </label>
                                  ))}
                                  {telestrokeNote.wakeUpStrokeWorkflow?.dwi?.positiveForLesion && telestrokeNote.wakeUpStrokeWorkflow?.flair?.noMarkedHyperintensity && telestrokeNote.wakeUpStrokeWorkflow?.ageEligible && telestrokeNote.wakeUpStrokeWorkflow?.nihssEligible && (
                                    <div className="bg-emerald-100 border border-emerald-300 rounded p-1.5 text-emerald-800 font-semibold text-xs">Meets WAKE-UP criteria - Consider IV thrombolysis</div>
                                  )}
                                </div>
                              )}

                              {/* EXTEND Trial Criteria */}
                              {telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable === false && (
                                <div className="bg-white border border-orange-200 rounded-lg p-2 space-y-1 text-sm">
                                  <div className="font-bold text-orange-800">EXTEND Trial Criteria</div>
                                  {[
                                    { key: 'nihss', label: 'NIHSS 4-26', field: 'nihss4to26' },
                                    { key: 'time', label: 'Time 4.5-9h or wake-up', field: 'timeWindow4_5to9h' },
                                    { key: 'mrs', label: 'Pre-morbid mRS <2', field: 'premorbidMRSLt2' },
                                    { key: 'core', label: 'Ischemic core ≤70mL', field: 'ischemicCoreLte70' },
                                    { key: 'mismatch', label: 'Mismatch ratio ≥1.2', field: 'mismatchRatioGte1_2' }
                                  ].map(item => (
                                    <label key={item.key} className="flex items-center gap-2 cursor-pointer">
                                      <input type="checkbox"
                                        checked={(telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria || {})[item.field]}
                                        onChange={(e) => { const checked = e.target.checked; const field = item.field; setTelestrokeNote(prev => ({...prev, wakeUpStrokeWorkflow: {...(prev.wakeUpStrokeWorkflow || {}), extendCriteria: {...(prev.wakeUpStrokeWorkflow?.extendCriteria || {}), [field]: checked}}})); }}
                                        className="w-4 h-4 rounded border-orange-400 text-orange-600" />
                                      <span>{item.label}</span>
                                    </label>
                                  ))}
                                  {telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.nihss4to26 && telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.premorbidMRSLt2 && telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.ischemicCoreLte70 && telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.mismatchRatioGte1_2 && telestrokeNote.wakeUpStrokeWorkflow?.extendCriteria?.timeWindow4_5to9h && (
                                    <div className="bg-emerald-100 border border-emerald-300 rounded p-1.5 text-emerald-800 font-semibold text-xs">Meets EXTEND criteria - Consider IV thrombolysis</div>
                                  )}
                                </div>
                              )}
                            </div>
                          )}
                        </div>

                        {/* Section 2: Patient Info + History */}
                        <div id="patient-info-section" className="bg-white border border-purple-200 rounded-xl p-4 shadow-md">
                          <h4 className="text-md font-bold text-purple-900 mb-3 flex items-center gap-2">
                            <i aria-hidden="true" data-lucide="user" className="w-4 h-4"></i>
                            Patient Info & History
                          </h4>

                          {/* Demographics Row */}
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                            <div>
                              <label htmlFor="input-age" className="block text-xs font-medium text-slate-600 mb-1">Age</label>
                              <input
                                id="input-age"
                                type="number"
                                min="0"
                                max="120"
                                value={telestrokeNote.age}
                                onChange={(e) => {
                                  const raw = e.target.value;
                                  if (raw === '') { setTelestrokeNote(prev => ({...prev, age: ''})); return; }
                                  const parsed = parseInt(raw, 10);
                                  if (isNaN(parsed)) return;
                                  const clamped = Math.max(0, Math.min(120, parsed));
                                  setTelestrokeNote(prev => ({...prev, age: String(clamped)}));
                                }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-sex" className="block text-xs font-medium text-slate-600 mb-1">Sex</label>
                              <select
                                id="input-sex"
                                value={telestrokeNote.sex}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, sex: v})); }}
                                className={'w-full px-2 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-purple-500 ' + (!telestrokeNote.sex ? 'border-amber-400 bg-amber-50' : 'border-slate-300')}
                              >
                                <option value="">--</option>
                                <option value="M">M</option>
                                <option value="F">F</option>
                              </select>
                            </div>
                            <div>
                              <div className="flex items-center justify-between mb-1">
                                <label htmlFor="input-weight" className="block text-xs font-medium text-slate-600">Weight</label>
                                <div className="flex bg-slate-100 rounded-md p-0.5">
                                  <button type="button" onClick={() => setWeightUnit('kg')}
                                    className={'px-2.5 py-1 text-sm rounded ' + (weightUnit === 'kg' ? 'bg-white shadow-sm font-semibold text-slate-900' : 'text-slate-500')}>kg</button>
                                  <button type="button" onClick={() => setWeightUnit('lbs')}
                                    className={'px-2.5 py-1 text-sm rounded ' + (weightUnit === 'lbs' ? 'bg-white shadow-sm font-semibold text-slate-900' : 'text-slate-500')}>lbs</button>
                                </div>
                              </div>
                              <input
                                id="input-weight"
                                type="number"
                                min={weightUnit === 'lbs' ? '44' : '20'} max={weightUnit === 'lbs' ? '770' : '350'}
                                value={weightUnit === 'lbs' && telestrokeNote.weight ? String(Math.round(parseFloat(telestrokeNote.weight) * 2.20462)) : telestrokeNote.weight}
                                onChange={(e) => {
                                  const val = e.target.value;
                                  if (weightUnit === 'lbs') {
                                    const parsed = parseFloat(val);
                                    setTelestrokeNote(prev => ({...prev, weight: val && !isNaN(parsed) && isFinite(parsed) ? String(Math.round(parsed / 2.20462)) : ''}));
                                  } else {
                                    setTelestrokeNote(prev => ({...prev, weight: val}));
                                  }
                                }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                placeholder={weightUnit}
                              />
                              {weightUnit === 'lbs' && telestrokeNote.weight && (
                                <p className="text-xs text-slate-500 mt-0.5">= {telestrokeNote.weight} kg</p>
                              )}
                              <label className="flex items-center gap-1.5 mt-1 cursor-pointer">
                                <input type="checkbox" checked={!!telestrokeNote.weightEstimated}
                                  onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, weightEstimated: c})); }}
                                  className="w-4 h-4" />
                                <span className={'text-xs ' + (telestrokeNote.weightEstimated ? 'text-amber-700 font-semibold' : 'text-slate-500')}>Estimated</span>
                              </label>
                            </div>
                            <div>
                              <label htmlFor="input-height" className="block text-xs font-medium text-slate-600 mb-1">Height (cm)</label>
                              <input
                                id="input-height"
                                type="number"
                                min="100" max="250" step="1"
                                value={telestrokeNote.height}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, height: v})); }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                placeholder="e.g. 170"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-creatinine" className="block text-xs font-medium text-slate-600 mb-1">Cr (mg/dL)</label>
                              <input
                                id="input-creatinine"
                                type="number"
                                step="0.1" min="0.1" max="20"
                                value={telestrokeNote.creatinine}
                                onChange={(e) => {
                                  const raw = e.target.value;
                                  if (raw === '') { setTelestrokeNote(prev => ({...prev, creatinine: ''})); return; }
                                  const parsed = parseFloat(raw);
                                  if (isNaN(parsed)) return;
                                  const clamped = Math.max(0.1, Math.min(20, parsed));
                                  setTelestrokeNote(prev => ({...prev, creatinine: String(clamped)}));
                                }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                placeholder="e.g. 1.2"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-premorbid-mrs" className="block text-xs font-medium text-slate-600 mb-1">Pre-stroke mRS</label>
                              <select
                                id="input-premorbid-mrs"
                                value={telestrokeNote.premorbidMRS}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, premorbidMRS: v})); }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                              >
                                <option value="">--</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                              </select>
                            </div>
                          </div>

                          {/* Auto-calculated CrCl Display */}
                          {(() => {
                            const crcl = calculateCrCl(telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.height);
                            if (!crcl) return null;
                            const colorClass = crcl.isLow ? 'bg-red-50 border-red-200 text-red-800' : crcl.isBorderline ? 'bg-amber-50 border-amber-200 text-amber-800' : 'bg-emerald-50 border-emerald-200 text-emerald-800';
                            return (
                              <div className={`mb-3 border rounded-lg p-2 text-sm ${colorClass}`} role="status" aria-live="polite">
                                <div className="flex items-center justify-between">
                                  <span className="font-medium">CrCl (Cockcroft-Gault): <span className="font-bold">{crcl.value} mL/min</span> — {crcl.label}</span>
                                  {crcl.isLow && <span className="text-xs font-semibold px-2 py-0.5 bg-red-200 rounded-full">Renal dose adjustment required</span>}
                                  {crcl.isBorderline && <span className="text-xs font-semibold px-2 py-0.5 bg-amber-200 rounded-full">Check DOAC dosing</span>}
                                </div>
                                {crcl.obesityWarning && <p className="text-xs mt-1 font-medium text-amber-800">{crcl.obesityWarning}</p>}
                              </div>
                            );
                          })()}

                          {/* TNK Dose Display */}
                          {telestrokeNote.weight && calculateTNKDose(telestrokeNote.weight) && (
                            <div className="mb-3 bg-orange-50 border border-orange-200 rounded-lg p-2 flex items-center justify-between text-sm">
                              <span className="text-orange-800 font-medium inline-flex items-center gap-1"><i aria-hidden="true" data-lucide="syringe" className="w-3.5 h-3.5"></i> TNK Dose: <span className="font-bold">{calculateTNKDose(telestrokeNote.weight).calculatedDose} mg</span></span>
                              <span className="text-xs text-orange-600">{calculateTNKDose(telestrokeNote.weight).volume}</span>
                            </div>
                          )}

                          {/* Presenting Symptoms & PMH */}
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                            <div>
                              <div className="flex items-center justify-between mb-1">
                                <label htmlFor="input-symptoms" className="block text-xs font-medium text-slate-600">Presenting Symptoms</label>
                              </div>
                              <textarea
                                id="input-symptoms"
                                value={telestrokeNote.symptoms}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, symptoms: v})); }}
                                rows="2"
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                              />
                            </div>
                            <div>
                              <div className="flex items-center justify-between mb-1">
                                <label htmlFor="input-pmh" className="block text-xs font-medium text-slate-600">Relevant PMH</label>
                              </div>
                              <textarea
                                id="input-pmh"
                                value={telestrokeNote.pmh}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, pmh: v})); }}
                                rows="2"
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                              />
                            </div>
                          </div>

                          {/* Medications */}
                          <div className="mb-3">
                            <label htmlFor="input-medications" className="block text-xs font-medium text-slate-600 mb-1">Medications</label>
                            <input
                              id="input-medications"
                              type="text"
                              value={telestrokeNote.medications}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, medications: v})); }}
                              className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                            />
                            <div className="flex flex-wrap gap-2 mt-2">
                              {['Aspirin', 'Clopidogrel', 'Warfarin', 'Apixaban'].map((med) => (
                                <button
                                  key={med}
                                  type="button"
                                  onClick={() => appendMedication(med)}
                                  className="px-3 py-1.5 text-xs font-semibold rounded-full border border-purple-200 text-purple-700 hover:bg-purple-50 min-h-[36px]"
                                >
                                  + {med}
                                </button>
                              ))}
                            </div>
                          </div>

                          {/* Anticoagulation Status */}
                          <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                            <span className="text-sm font-medium text-amber-800 inline-flex items-center gap-1"><i aria-hidden="true" data-lucide="pill" className="w-3.5 h-3.5"></i> Anticoagulation Status</span>
                            <div className="grid grid-cols-2 gap-3 mt-2">
                              <div>
                                <label htmlFor="input-anticoag-type" className="block text-xs text-slate-600 mb-1">Anticoagulant Type</label>
                                <select
                                  id="input-anticoag-type"
                                  value={telestrokeNote.lastDOACType}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, lastDOACType: v})); }}
                                  className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500"
                                >
                                  <option value="">None / Unknown</option>
                                  <option value="apixaban">Apixaban (Eliquis)</option>
                                  <option value="rivaroxaban">Rivaroxaban (Xarelto)</option>
                                  <option value="dabigatran">Dabigatran (Pradaxa)</option>
                                  <option value="edoxaban">Edoxaban (Savaysa)</option>
                                  <option value="warfarin">Warfarin (check INR)</option>
                                  <option value="heparin">Heparin UFH (check PTT)</option>
                                  <option value="lmwh">LMWH / Enoxaparin</option>
                                  <option value="fondaparinux">Fondaparinux (Arixtra)</option>
                                </select>
                              </div>
                              <div>
                                <label htmlFor="input-last-dose" className="block text-xs text-slate-600 mb-1">Last Dose</label>
                                <input
                                  id="input-last-dose"
                                  type="datetime-local"
                                  value={telestrokeNote.lastDOACDose}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, lastDOACDose: v})); }}
                                  className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-amber-500"
                                />
                                <div className="flex flex-wrap gap-2 mt-2">
                                  <button
                                    type="button"
                                    onClick={() => setTelestrokeNote(prev => ({...prev, lastDOACDose: toLocalISO(new Date())}))}
                                    className="px-3 py-1.5 text-xs font-semibold rounded-full border border-amber-200 text-amber-700 hover:bg-amber-50 min-h-[36px]"
                                  >
                                    Dose now
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const past = new Date(Date.now() - (49 * 60 * 60 * 1000));
                                      setTelestrokeNote(prev => ({...prev, lastDOACDose: toLocalISO(past)}));
                                    }}
                                    className="px-3 py-1.5 text-xs font-semibold rounded-full border border-amber-200 text-amber-700 hover:bg-amber-50 min-h-[36px]"
                                  >
                                    &gt;48h ago
                                  </button>
                                  <button
                                    type="button"
                                    onClick={() => setTelestrokeNote(prev => ({...prev, lastDOACDose: ''}))}
                                    className="px-3 py-1.5 text-xs font-semibold rounded-full border border-amber-200 text-amber-700 hover:bg-amber-50 min-h-[36px]"
                                  >
                                    Unknown
                                  </button>
                                </div>
                              </div>
                            </div>
                            {/* Show anticoagulant info if selected */}
                            {telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType] && (() => {
                              const info = ANTICOAGULANT_INFO[telestrokeNote.lastDOACType];
                              const hoursSince = (() => { if (!telestrokeNote.lastDOACDose) return null; const d = new Date(telestrokeNote.lastDOACDose); return Number.isNaN(d.getTime()) ? null : Math.max(0, (new Date() - d) / (1000 * 60 * 60)); })();
                              const crcl = calculateCrCl(telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.height);
                              const crclVal = crcl ? crcl.value : null;
                              // Estimate effective half-life based on renal function
                              // References: apixaban t½ 8-15h (severe renal), rivaroxaban 9-13h, dabigatran 14-28h
                              const halfLifeMap = {
                                apixaban: crclVal && crclVal < 30 ? 15 : 10,
                                rivaroxaban: crclVal && crclVal < 30 ? 13 : 9,
                                dabigatran: crclVal && crclVal < 30 ? 28 : crclVal && crclVal < 50 ? 18 : 14,
                                edoxaban: crclVal && crclVal < 30 ? 16 : 12,
                                warfarin: 40, heparin: 1.5, enoxaparin: crclVal && crclVal < 30 ? 7 : 4.5
                              };
                              const estHalfLife = halfLifeMap[telestrokeNote.lastDOACType] || 12;
                              const halfLives = hoursSince != null ? hoursSince / estHalfLife : null;
                              const clearancePct = halfLives != null ? Math.min(99.9, (1 - Math.pow(0.5, halfLives)) * 100) : null;
                              const missingCrCl = !crclVal && ['apixaban','rivaroxaban','dabigatran','enoxaparin'].includes(telestrokeNote.lastDOACType);
                              const clearanceColor = clearancePct === null ? 'bg-orange-50 border-orange-200' : clearancePct >= 97 ? 'bg-emerald-50 border-emerald-200' : clearancePct >= 87 ? 'bg-amber-50 border-amber-200' : 'bg-red-50 border-red-200';
                              return (
                              <div className={`mt-2 ${clearanceColor} border rounded p-2 text-xs space-y-1`}>
                                <div className="flex justify-between">
                                  <span className="font-medium">{info.name}</span>
                                  <span className="text-slate-600">t½: {info.halfLife}{crclVal && crclVal < 50 ? ' (prolonged — CrCl ' + Math.round(crclVal) + ')' : ''}</span>
                                </div>
                                {missingCrCl && (
                                  <div className="text-amber-700 font-medium flex items-center gap-1">
                                    <i aria-hidden="true" data-lucide="alert-triangle" className="w-3 h-3"></i>
                                    CrCl not available — using normal renal function estimate. Enter age, weight, sex, and creatinine for renal-adjusted clearance.
                                  </div>
                                )}
                                {hoursSince !== null && halfLives !== null ? (
                                  <div className="flex justify-between font-semibold">
                                    <span>{Math.floor(hoursSince)}h since last dose ({halfLives.toFixed(1)} half-lives)</span>
                                    <span>~{clearancePct !== null ? clearancePct.toFixed(0) : '?'}% cleared</span>
                                  </div>
                                ) : (
                                  <div className="text-amber-700 font-medium">Enter last dose time to calculate clearance estimate</div>
                                )}
                                <div className={`font-semibold ${clearancePct !== null && clearancePct >= 97 ? 'text-emerald-800' : clearancePct !== null && clearancePct >= 87 ? 'text-amber-800' : 'text-red-800'}`}>
                                  TNK: {info.thrombolysisThreshold}
                                  {clearancePct !== null && clearancePct >= 97 && ' — Likely safe, confirm with drug level'}
                                  {clearancePct !== null && clearancePct >= 87 && clearancePct < 97 && ' — Check drug-specific assay before TNK'}
                                  {clearancePct !== null && clearancePct < 87 && ' — Drug likely still active, TNK high risk'}
                                </div>
                                {hoursSince !== null && <div className="text-slate-700">{info.thrombolysisNote}</div>}
                              </div>
                              );
                            })()}
                            {telestrokeNote.tnkAutoBlocked && (
                              <div className="mt-2 text-xs text-red-700 bg-red-50 border border-red-200 rounded p-2">
                                TNK auto-disabled: {telestrokeNote.tnkAutoBlockReason || 'Contraindication detected'}. Override only with documented justification.
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Section 3: NIHSS */}
                        <div id="nihss-section" className="bg-white border border-red-200 rounded-xl p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h4 className="text-md font-bold text-red-900 flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="brain" className="w-4 h-4"></i>
                              NIHSS Examination
                            </h4>
                            <span className="text-2xl font-bold text-red-600">Score: {nihssScore}</span>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                              <label htmlFor="input-nihss" className="block text-xs text-slate-600 mb-1">NIHSS Score (0-42)</label>
                              <input
                                id="input-nihss"
                                type="number"
                                value={telestrokeNote.nihss}
                                onChange={(e) => {
                                  const raw = e.target.value;
                                  if (raw === '') { setTelestrokeNote(prev => ({...prev, nihss: ''})); setNihssScore(0); return; }
                                  const parsed = parseInt(raw, 10);
                                  if (isNaN(parsed)) return;
                                  const clamped = Math.max(0, Math.min(42, parsed));
                                  setTelestrokeNote(prev => ({...prev, nihss: String(clamped)}));
                                  setNihssScore(clamped);
                                }}
                                min="0"
                                max="42"
                                step="1"
                                className="w-full px-3 py-2 border border-slate-200 rounded-lg text-xl font-bold text-center focus:ring-2 focus:ring-red-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-nihss-details" className="block text-xs text-slate-600 mb-1">Neurologic Deficits</label>
                              <input
                                id="input-nihss-details"
                                type="text"
                                value={telestrokeNote.nihssDetails}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, nihssDetails: v})); }}
                                placeholder="e.g., R hemiparesis, aphasia, gaze deviation"
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500"
                              />
                            </div>
                          </div>

                          {/* NIHSS Severity */}
                          {nihssScore > 0 && (
                            <div className={`mt-2 p-2 rounded-lg text-center text-sm font-medium ${
                              nihssScore <= 4 ? 'bg-emerald-100 text-emerald-800' :
                              nihssScore <= 15 ? 'bg-amber-100 text-amber-800' :
                              nihssScore <= 20 ? 'bg-orange-100 text-orange-800' :
                              'bg-red-100 text-red-800'
                            }`}>
                              {nihssScore <= 4 ? 'Minor Stroke' :
                               nihssScore <= 15 ? 'Moderate Stroke' :
                               nihssScore <= 20 ? 'Moderate-Severe Stroke' :
                               'Severe Stroke'}
                            </div>
                          )}
                        </div>

                        {/* Section 4: Vitals & Labs */}
                        <div id="vitals-section" className="bg-white border border-emerald-200 rounded-xl p-4 shadow-md">
                          <h4 className="text-md font-bold text-emerald-900 mb-3 flex items-center gap-2">
                            <i aria-hidden="true" data-lucide="activity" className="w-4 h-4"></i>
                            Vitals & Labs
                          </h4>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                              <label htmlFor="input-bp" className="block text-xs text-slate-600 mb-1">BP</label>
                              <input
                                id="input-bp"
                                type="text"
                                value={telestrokeNote.presentingBP}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, presentingBP: v})); }}
                                placeholder="120/80"
                                className={`w-full px-2 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-green-500 ${(() => {
                                  const s = getBPThresholdStatus(telestrokeNote.presentingBP);
                                  if (s.status === 'too_high') return 'border-red-400 bg-red-50';
                                  if (s.status === 'borderline') return 'border-amber-400 bg-amber-50';
                                  if (s.status === 'ok') return 'border-emerald-400 bg-emerald-50';
                                  return 'border-slate-300';
                                })()}`}
                              />
                            </div>
                            <div>
                              <label htmlFor="input-hr" className="block text-xs text-slate-600 mb-1">HR</label>
                              <input id="input-hr" type="number" min="20" max="300"
                                value={telestrokeNote.heartRate}
                                onChange={(e) => {
                                  const raw = e.target.value;
                                  if (raw === '') { setTelestrokeNote(prev => ({...prev, heartRate: ''})); return; }
                                  const parsed = parseInt(raw, 10);
                                  if (isNaN(parsed)) return;
                                  const clamped = Math.max(20, Math.min(300, parsed));
                                  setTelestrokeNote(prev => ({...prev, heartRate: String(clamped)}));
                                }}
                                placeholder="bpm"
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-spo2" className="block text-xs text-slate-600 mb-1">SpO2</label>
                              <input id="input-spo2" type="number" min="50" max="100"
                                value={telestrokeNote.spO2}
                                onChange={(e) => {
                                  const raw = e.target.value;
                                  if (raw === '') { setTelestrokeNote(prev => ({...prev, spO2: ''})); return; }
                                  const parsed = parseInt(raw, 10);
                                  if (isNaN(parsed)) return;
                                  const clamped = Math.max(50, Math.min(100, parsed));
                                  setTelestrokeNote(prev => ({...prev, spO2: String(clamped)}));
                                }}
                                placeholder="%"
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-temp" className="block text-xs text-slate-600 mb-1">Temp</label>
                              <input id="input-temp" type="number" step="0.1" min="90" max="110"
                                value={telestrokeNote.temperature}
                                onChange={(e) => {
                                  const raw = e.target.value;
                                  if (raw === '') { setTelestrokeNote(prev => ({...prev, temperature: ''})); return; }
                                  const parsed = parseFloat(raw);
                                  if (isNaN(parsed)) return;
                                  const clamped = Math.max(90, Math.min(110, parsed));
                                  setTelestrokeNote(prev => ({...prev, temperature: String(clamped)}));
                                }}
                                placeholder="°F"
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-glucose" className="block text-xs text-slate-600 mb-1">Glucose</label>
                              <input
                                id="input-glucose"
                                type="number"
                                min="10" max="800"
                                value={telestrokeNote.glucose}
                                onChange={(e) => {
                                  const raw = e.target.value;
                                  if (raw === '') { setTelestrokeNote(prev => ({...prev, glucose: ''})); return; }
                                  const parsed = parseInt(raw, 10);
                                  if (isNaN(parsed)) return;
                                  const clamped = Math.max(10, Math.min(800, parsed));
                                  setTelestrokeNote(prev => ({...prev, glucose: String(clamped)}));
                                }}
                                placeholder="mg/dL"
                                aria-invalid={telestrokeNote.glucose && parseInt(telestrokeNote.glucose, 10) < 60 ? 'true' : undefined}
                                aria-describedby={telestrokeNote.glucose && parseInt(telestrokeNote.glucose, 10) < 60 ? 'glucose-error' : undefined}
                                className={`w-full px-2 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-green-500 ${(() => {
                                  const g = parseInt(telestrokeNote.glucose, 10);
                                  if (!telestrokeNote.glucose || isNaN(g)) return 'border-slate-300';
                                  if (g < 60) return 'border-red-400 bg-red-50';
                                  if (g > 400) return 'border-amber-400 bg-amber-50';
                                  return 'border-slate-300';
                                })()}`}
                              />
                              {telestrokeNote.glucose && parseInt(telestrokeNote.glucose, 10) < 60 && <p id="glucose-error" role="alert" className="text-xs text-red-600 font-semibold mt-0.5">WARNING: Hypoglycemia - stroke mimic?</p>}
                            </div>
                            <div>
                              <label htmlFor="input-inr" className="block text-xs text-slate-600 mb-1">INR</label>
                              <input
                                id="input-inr"
                                type="number"
                                step="0.1" min="0.5" max="15"
                                value={telestrokeNote.inr}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, inr: v})); }}
                                aria-invalid={telestrokeNote.inr && parseFloat(telestrokeNote.inr) > 1.7 ? 'true' : undefined}
                                aria-describedby={telestrokeNote.inr && parseFloat(telestrokeNote.inr) > 1.7 ? 'inr-error' : undefined}
                                className={`w-full px-2 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-green-500 ${(() => {
                                  const i = parseFloat(telestrokeNote.inr);
                                  if (!telestrokeNote.inr || isNaN(i)) return 'border-slate-300';
                                  if (i > 1.7) return 'border-red-400 bg-red-50';
                                  if (i > 1.5) return 'border-amber-400 bg-amber-50';
                                  return 'border-slate-300';
                                })()}`}
                              />
                              {telestrokeNote.inr && parseFloat(telestrokeNote.inr) > 1.7 && <p id="inr-error" role="alert" className="text-xs text-red-600 font-semibold mt-0.5">CONTRAINDICATED: TNK — INR &gt;1.7</p>}
                            </div>
                            <div>
                              <label htmlFor="input-pt" className="block text-xs text-slate-600 mb-1">PT</label>
                              <input
                                id="input-pt"
                                type="number"
                                step="0.1" min="5" max="120"
                                value={telestrokeNote.pt}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, pt: v})); }}
                                placeholder="seconds"
                                aria-invalid={telestrokeNote.pt && parseFloat(telestrokeNote.pt) > 15 ? 'true' : undefined}
                                aria-describedby={telestrokeNote.pt && parseFloat(telestrokeNote.pt) > 15 ? 'pt-error' : undefined}
                                className={`w-full px-2 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-green-500 ${(() => {
                                  const p = parseFloat(telestrokeNote.pt);
                                  if (!telestrokeNote.pt || isNaN(p)) return 'border-slate-300';
                                  if (p > 15) return 'border-red-400 bg-red-50';
                                  if (p > 13) return 'border-amber-400 bg-amber-50';
                                  return 'border-slate-300';
                                })()}`}
                              />
                              {telestrokeNote.pt && parseFloat(telestrokeNote.pt) > 15 && <p id="pt-error" role="alert" className="text-xs text-red-600 font-semibold mt-0.5">CONTRAINDICATED: TNK — PT &gt;15s</p>}
                            </div>
                            <div>
                              <label htmlFor="input-platelets" className="block text-xs text-slate-600 mb-1">Platelets</label>
                              <input
                                id="input-platelets"
                                type="number"
                                min="1" max="1500"
                                value={telestrokeNote.plateletCount}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, plateletCount: v})); }}
                                placeholder="K/uL"
                                aria-invalid={telestrokeNote.plateletCount && parseInt(telestrokeNote.plateletCount, 10) < 100 ? 'true' : undefined}
                                aria-describedby={telestrokeNote.plateletCount && parseInt(telestrokeNote.plateletCount, 10) < 100 ? 'platelets-error' : undefined}
                                className={`w-full px-2 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-green-500 ${(() => {
                                  const p = parseInt(telestrokeNote.plateletCount, 10);
                                  if (!telestrokeNote.plateletCount || isNaN(p)) return 'border-slate-300';
                                  if (p < 100) return 'border-red-400 bg-red-50';
                                  return 'border-slate-300';
                                })()}`}
                              />
                              {telestrokeNote.plateletCount && parseInt(telestrokeNote.plateletCount, 10) < 100 && <p id="platelets-error" role="alert" className="text-xs text-red-600 font-semibold mt-0.5">CONTRAINDICATED: TNK — Plt &lt;100K</p>}
                            </div>
                          </div>
                          {/* BP Threshold Alert */}
                          {(() => {
                            const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                            if (bpStatus.status === 'unknown') return null;
                            return (
                              <div className={`mt-2 border rounded-lg px-3 py-2 text-sm flex items-center justify-between ${bpStatus.badgeClass}`}>
                                <span className="font-medium">{bpStatus.icon} BP {telestrokeNote.presentingBP}: {bpStatus.message}</span>
                                {bpStatus.needsLowering && (
                                  <span className="text-xs font-semibold">Lower SBP by {bpStatus.sbpToLower > 0 ? `${bpStatus.sbpToLower}` : ''}{bpStatus.sbpToLower > 0 && bpStatus.dbpToLower > 0 ? ' / DBP by ' : ''}{bpStatus.dbpToLower > 0 ? `${bpStatus.dbpToLower}` : ''} mmHg</span>
                                )}
                              </div>
                            );
                          })()}
                          {/* Glucose Alert */}
                          {(() => {
                            const glu = parseInt(telestrokeNote.glucose, 10);
                            if (!glu) return null;
                            if (glu < 50) return <div className="mt-1 bg-red-50 border border-red-200 rounded-lg px-3 py-1.5 text-xs text-red-800 font-medium">Hypoglycemia ({glu} mg/dL) - Correct before attributing symptoms to stroke</div>;
                            if (glu > 400) return <div className="mt-1 bg-red-50 border border-red-200 rounded-lg px-3 py-1.5 text-xs text-red-800 font-medium">Severe hyperglycemia ({glu} mg/dL) - Insulin protocol, r/o DKA/HHS</div>;
                            if (glu > 180) return <div className="mt-1 bg-amber-50 border border-amber-200 rounded-lg px-3 py-1.5 text-xs text-amber-800 font-medium">Hyperglycemia ({glu} mg/dL) - Target &lt;180 mg/dL per AHA guidelines</div>;
                            return null;
                          })()}
                          {/* Platelet Alert */}
                          {(() => {
                            const plt = parseInt(telestrokeNote.plateletCount, 10);
                            if (!plt) return null;
                            if (plt < 100) return <div className="mt-1 bg-red-50 border border-red-200 rounded-lg px-3 py-1.5 text-xs text-red-800 font-medium">Plt {plt}K - TNK contraindicated if &lt;100K</div>;
                            return null;
                          })()}
                          {/* INR Alert */}
                          {(() => {
                            const inr = parseFloat(telestrokeNote.inr);
                            if (!inr) return null;
                            if (inr > 1.7) return <div className="mt-1 bg-red-50 border border-red-200 rounded-lg px-3 py-1.5 text-xs text-red-800 font-medium">INR {inr} - TNK contraindicated if &gt;1.7</div>;
                            if (inr > 1.5) return <div className="mt-1 bg-amber-50 border border-amber-200 rounded-lg px-3 py-1.5 text-xs text-amber-800 font-medium">INR {inr} - Elevated, use caution with TNK</div>;
                            return null;
                          })()}
                        </div>

                        {/* Section 5: Imaging */}
                        <div id="imaging-section" className="bg-white border border-blue-200 rounded-xl p-4 shadow-md">
                          <h4 className="text-md font-bold text-blue-900 mb-3 flex items-center gap-2">
                            <i aria-hidden="true" data-lucide="scan" className="w-4 h-4"></i>
                            Imaging Review
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                              <label htmlFor="input-ct-results" className="block text-xs text-slate-600 mb-1">CT Head</label>
                              <textarea
                                id="input-ct-results"
                                value={telestrokeNote.ctResults}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctResults: v})); }}
                                rows="2"
                                placeholder="No acute hemorrhage, early ischemic changes..."
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-cta-results" className="block text-xs text-slate-600 mb-1">CTA Head/Neck</label>
                              <textarea
                                id="input-cta-results"
                                value={telestrokeNote.ctaResults}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctaResults: v})); }}
                                rows="2"
                                placeholder="LVO location, vessel patency..."
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                          {/* ASPECTS + Vessel Occlusion Row */}
                          <div className="grid grid-cols-2 gap-3 mt-3">
                            <div>
                              <label className="block text-xs text-slate-600 mb-1">ASPECTS (0-10)</label>
                              <input
                                type="number"
                                value={aspectsScore}
                                onChange={(e) => setAspectsScore(parseInt(e.target.value, 10) || 0)}
                                min="0"
                                max="10"
                                step="1"
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="input-collateral-grade" className="block text-xs text-slate-600 mb-1">Collaterals (CTA)</label>
                              <select
                                id="input-collateral-grade"
                                value={telestrokeNote.collateralGrade || ''}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, collateralGrade: v})); }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="">-- Not assessed --</option>
                                <option value="good">Good (≥50% filling)</option>
                                <option value="moderate">Moderate (partial/delayed filling)</option>
                                <option value="poor">Poor/Absent</option>
                              </select>
                            </div>
                          </div>
                          {/* CTP Perfusion — Structured + Free Text */}
                          <div className="mt-2 bg-violet-50 border border-violet-200 rounded-lg p-2">
                            <p className="text-xs font-semibold text-violet-800 mb-1.5">CTP Perfusion (RAPID output)</p>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-2 mb-1.5">
                              <div>
                                <label htmlFor="input-ctp-core" className="block text-xs text-slate-600">Core (mL)</label>
                                <input id="input-ctp-core" type="number" min="0" step="1"
                                  value={(telestrokeNote.ctpStructured || {}).coreVolume || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctpStructured: {...(prev.ctpStructured || {}), coreVolume: v}})); }}
                                  placeholder="CBF<30%"
                                  className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                              </div>
                              <div>
                                <label htmlFor="input-ctp-penumbra" className="block text-xs text-slate-600">Penumbra (mL)</label>
                                <input id="input-ctp-penumbra" type="number" min="0" step="1"
                                  value={(telestrokeNote.ctpStructured || {}).penumbraVolume || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctpStructured: {...(prev.ctpStructured || {}), penumbraVolume: v}})); }}
                                  placeholder="Tmax>6s"
                                  className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                              </div>
                              <div>
                                <label htmlFor="input-ctp-mismatch" className="block text-xs text-slate-600">Mismatch Ratio</label>
                                <input id="input-ctp-mismatch" type="text" readOnly
                                  value={(() => {
                                    const c = parseFloat((telestrokeNote.ctpStructured || {}).coreVolume);
                                    const p = parseFloat((telestrokeNote.ctpStructured || {}).penumbraVolume);
                                    if (!isNaN(c) && !isNaN(p) && c > 0) { const r = p / c; return isFinite(r) && r < 1000 ? r.toFixed(1) : '>999'; }
                                    if (!isNaN(c) && c === 0 && !isNaN(p) && p > 0) return '∞';
                                    return '';
                                  })()}
                                  className="w-full px-2 py-1 border border-slate-200 rounded text-sm bg-slate-50 text-center font-medium" />
                              </div>
                            </div>
                            <input type="text" aria-label="Additional CTP perfusion notes" value={telestrokeNote.ctpResults}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctpResults: v})); }}
                              placeholder="Additional CTP notes..."
                              className="w-full px-2 py-1 border border-slate-300 rounded text-xs" />
                            {/* DAWN / DEFUSE-3 / EXTEND Auto-Comparison */}
                            {(() => {
                              const ctp = telestrokeNote.ctpStructured || {};
                              const core = parseFloat(ctp.coreVolume);
                              const penumbra = parseFloat(ctp.penumbraVolume);
                              if (isNaN(core) && isNaN(penumbra)) return null;
                              const mismatchVol = !isNaN(core) && !isNaN(penumbra) ? penumbra - core : NaN;
                              const mismatchRatio = !isNaN(core) && core > 0 && !isNaN(penumbra) ? penumbra / core : NaN;
                              const age = parseInt(telestrokeNote.age, 10) || 0;
                              const nihss = parseInt(telestrokeNote.nihss || nihssScore, 10) || 0;
                              const badges = [];
                              // DAWN criteria (6-24h)
                              if (!isNaN(core)) {
                                const dawnA = age >= 80 && nihss >= 10 && core < 21;
                                const dawnB = age < 80 && nihss >= 10 && core < 31;
                                const dawnC = age < 80 && nihss >= 20 && core >= 31 && core < 51;
                                const dawnEligible = dawnA || dawnB || dawnC;
                                badges.push({ label: 'DAWN', eligible: dawnEligible,
                                  detail: dawnEligible
                                    ? `Core ${core}mL — eligible (${dawnA ? 'Group A: age≥80, NIHSS≥10, core<21' : dawnB ? 'Group B: age<80, NIHSS≥10, core<31' : 'Group C: age<80, NIHSS≥20, core<51'})`
                                    : `Core ${core}mL — does not meet DAWN criteria for age ${age}/NIHSS ${nihss}`
                                });
                              }
                              // DEFUSE-3 criteria (6-16h)
                              if (!isNaN(core)) {
                                const defuseEligible = core < 70 && !isNaN(mismatchRatio) && mismatchRatio >= 1.8 && !isNaN(mismatchVol) && mismatchVol >= 15 && !isNaN(penumbra) && penumbra <= 180;
                                const reasons = [];
                                if (core >= 70) reasons.push(`core ${core}≥70`);
                                if (!isNaN(mismatchRatio) && mismatchRatio < 1.8) reasons.push(`ratio ${mismatchRatio.toFixed(1)}<1.8`);
                                if (!isNaN(mismatchVol) && mismatchVol < 15) reasons.push(`mismatch vol ${mismatchVol.toFixed(0)}<15`);
                                if (!isNaN(penumbra) && penumbra > 180) reasons.push(`penumbra ${penumbra}>180 (malignant profile)`);
                                badges.push({ label: 'DEFUSE-3', eligible: defuseEligible,
                                  detail: defuseEligible
                                    ? `Core ${core}mL, ratio ${isFinite(mismatchRatio) ? mismatchRatio.toFixed(1) : '?'}, mismatch ${mismatchVol.toFixed(0)}mL — imaging criteria met (note: DEFUSE-3 enrolled 6-16h only; DAWN extends to 24h)`
                                    : `Not met: ${reasons.join('; ') || 'insufficient data'}`
                                });
                              }
                              // EXTEND criteria (4.5-9h, wake-up stroke)
                              if (!isNaN(core)) {
                                const extendEligible = core <= 70 && !isNaN(mismatchRatio) && mismatchRatio >= 1.2 && !isNaN(mismatchVol) && mismatchVol >= 10;
                                badges.push({ label: 'EXTEND', eligible: extendEligible,
                                  detail: extendEligible
                                    ? `Core ${core}mL, ratio ${!isNaN(mismatchRatio) ? mismatchRatio.toFixed(1) : '?'} — eligible for extended thrombolysis`
                                    : `Not met: core ${core}${core > 70 ? '>70' : ''}${!isNaN(mismatchRatio) && mismatchRatio < 1.2 ? ', ratio<1.2' : ''}`
                                });
                              }
                              if (badges.length === 0) return null;
                              return (
                                <div className="mt-1.5 flex flex-wrap gap-1.5">
                                  {badges.map((b, i) => (
                                    <div key={i} className={`px-2 py-0.5 rounded text-xs font-medium border ${b.eligible ? 'bg-emerald-50 border-emerald-300 text-emerald-800' : 'bg-slate-50 border-slate-300 text-slate-600'}`} title={b.detail}>
                                      {b.eligible ? '✓' : '✗'} {b.label}
                                    </div>
                                  ))}
                                </div>
                              );
                            })()}
                          </div>
                          {/* ASPECTS Interpretation */}
                          {aspectsScore > 0 && (
                            <div className={`mt-2 rounded-lg border px-3 py-1.5 text-xs font-medium ${
                              aspectsScore >= 7 ? 'bg-emerald-50 border-emerald-200 text-emerald-800' :
                              aspectsScore >= 5 ? 'bg-amber-50 border-amber-200 text-amber-800' :
                              'bg-red-50 border-red-200 text-red-800'
                            }`}>
                              ASPECTS {aspectsScore}/10: {aspectsScore >= 7 ? 'Favorable for intervention' : aspectsScore >= 5 ? 'Intermediate - consider perfusion imaging' : 'Large established infarct - limited benefit from intervention'}
                            </div>
                          )}
                          {/* Vessel Occlusion Quick Select */}
                          <div className="mt-3 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                            <p className="text-xs font-semibold text-blue-800 mb-1">Vessel Occlusion</p>
                            <div className="flex flex-wrap gap-1.5">
                              {['ICA', 'M1', 'M2', 'M3', 'A1', 'A2', 'P1', 'P2', 'Basilar', 'None'].map(vessel => (
                                <button key={vessel} type="button"
                                  aria-pressed={(telestrokeNote.vesselOcclusion || []).includes(vessel)}
                                  aria-label={`${vessel} vessel occlusion`}
                                  onClick={() => {
                                    setTelestrokeNote(prev => {
                                      const current = prev.vesselOcclusion || [];
                                      const updated = current.includes(vessel) ? current.filter(v => v !== vessel) : [...current.filter(v => v !== 'None'), ...(vessel === 'None' ? [] : [vessel]), ...(vessel === 'None' ? ['None'] : [])];
                                      return {...prev, vesselOcclusion: vessel === 'None' ? ['None'] : updated.filter(v => v !== 'None')};
                                    });
                                  }}
                                  className={`px-3 py-1.5 text-xs rounded-full font-medium transition-colors min-h-[36px] ${
                                    (telestrokeNote.vesselOcclusion || []).includes(vessel) ? 'bg-blue-600 text-white' : 'bg-white border border-blue-200 text-blue-700 hover:bg-blue-100'
                                  }`}>
                                  {vessel}
                                </button>
                              ))}
                            </div>
                            {/* LVO alert for EVT */}
                            {(telestrokeNote.vesselOcclusion || []).some(v => ['ICA', 'M1', 'Basilar'].includes(v)) && (
                              <div className="mt-1.5 bg-emerald-50 border border-emerald-200 rounded px-2 py-1 text-xs text-emerald-800 font-medium">
                                Large vessel occlusion detected - Consider EVT evaluation
                              </div>
                            )}
                            {(telestrokeNote.vesselOcclusion || []).some(v => ['M2', 'M3', 'A1', 'A2', 'P1', 'P2'].includes(v)) && !(telestrokeNote.vesselOcclusion || []).some(v => ['ICA', 'M1', 'Basilar'].includes(v)) && (
                              <div className="mt-1.5 bg-amber-50 border border-amber-200 rounded px-2 py-1 text-xs text-amber-800 font-medium">
                                Medium vessel occlusion - EVT may be considered (emerging evidence)
                              </div>
                            )}
                          </div>
                          <div className="mt-3">
                            <label className="block text-xs text-slate-600 mb-1">Telemetry / EKG</label>
                            <input
                              type="text"
                              value={telestrokeNote.ekgResults}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ekgResults: v})); }}
                              placeholder="NSR, AF, STEMI, etc."
                              className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>


                        {/* ===== DECISION SECTION ===== */}
                        <div id="phase-decision"></div>

                        {/* Section 6: Treatment Decision */}
                        <div id="treatment-decision" ref={treatmentDecisionRef} className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm">
                          <h4 className="text-lg font-semibold text-slate-900 mb-3 flex items-center gap-2">
                            <i aria-hidden="true" data-lucide="stethoscope" className="w-5 h-5 text-blue-600"></i>
                            Diagnosis & Treatment Decision
                          </h4>
                          <div className="space-y-3">
                            <div>
                              <label htmlFor="input-diagnosis" className="block text-sm font-medium text-slate-700 mb-1">Suspected Diagnosis</label>
                              <select
                                id="input-diagnosis"
                                value={telestrokeNote.diagnosis}
                                onChange={(e) => {
                                  const newDx = e.target.value;
                                  const dxLower = newDx.toLowerCase();
                                  const category = dxLower.includes('ich') || dxLower.includes('intracerebral') ? 'ich'
                                    : dxLower.includes('sah') || dxLower.includes('subarachnoid') ? 'sah'
                                    : dxLower === 'tia' ? 'tia'
                                    : dxLower.includes('ischemic') || dxLower.includes('lvo') ? 'ischemic'
                                    : dxLower.includes('cvt') || dxLower.includes('venous thrombosis') ? 'cvt'
                                    : '';
                                  const diagUpdate = { diagnosis: newDx, diagnosisCategory: category };
                                  // Auto-clear TNK recommendation for hemorrhagic diagnoses (safety-critical)
                                  if ((category === 'ich' || category === 'sah') && telestrokeNote.tnkRecommended) {
                                    diagUpdate.tnkRecommended = false;
                                    diagUpdate.tnkAutoBlocked = true;
                                    diagUpdate.tnkAutoBlockReason = `TNK auto-cleared: ${category.toUpperCase()} diagnosis (thrombolysis contraindicated)`;
                                    addToast(`TNK recommendation cleared — ${category.toUpperCase()} diagnosis is a contraindication to thrombolysis`, 'error');
                                  }
                                  // Reset BP phase if switching away from ischemic/EVT
                                  if (category !== 'ischemic' && (telestrokeNote.bpPhase === 'post-evt' || telestrokeNote.bpPhase === 'post-tnk')) {
                                    diagUpdate.bpPhase = 'pre-tnk';
                                  }
                                  setTelestrokeNote(prev => ({...prev, ...diagUpdate}));
                                  // Auto-route management sub-tab
                                  if (category === 'ich') setManagementSubTab('ich');
                                  else if (category === 'sah') setManagementSubTab('sah');
                                  else if (category === 'tia') setManagementSubTab('tia');
                                  else if (category === 'ischemic') setManagementSubTab('ischemic');
                                  else if (category === 'cvt') setManagementSubTab('cvt');
                                  else setManagementSubTab('ischemic'); // default for mimic/other
                                }}
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                              >
                                <option value="">-- Select Diagnosis --</option>
                                <optgroup label="Ischemic Stroke">
                                  <option value="Acute Ischemic Stroke">Acute Ischemic Stroke</option>
                                  <option value="Acute Ischemic Stroke - LVO">Acute Ischemic Stroke - LVO</option>
                                  <option value="Minor Ischemic Stroke">Minor Ischemic Stroke</option>
                                  <option value="TIA">TIA</option>
                                </optgroup>
                                <optgroup label="Hemorrhagic">
                                  <option value="Intracerebral Hemorrhage (ICH)">Intracerebral Hemorrhage (ICH)</option>
                                  <option value="Subarachnoid Hemorrhage (SAH)">Subarachnoid Hemorrhage (SAH)</option>
                                </optgroup>
                                <optgroup label="Other">
                                  <option value="Cerebral Venous Thrombosis (CVT)">Cerebral Venous Thrombosis (CVT)</option>
                                  <option value="Cervical Artery Dissection">Cervical Artery Dissection</option>
                                  <option value="Stroke Mimic">Stroke Mimic</option>
                                  <option value="Other">Other</option>
                                </optgroup>
                              </select>
                            </div>

                            <div>
                              <label htmlFor="input-affected-side" className="block text-xs text-slate-600 mb-1">Affected Side</label>
                              <select
                                id="input-affected-side"
                                value={telestrokeNote.affectedSide || ''}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, affectedSide: v})); }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                              >
                                <option value="">-- Select --</option>
                                <option value="Left">Left</option>
                                <option value="Right">Right</option>
                                <option value="Bilateral">Bilateral</option>
                              </select>
                            </div>

                            {/* Stroke Territory & Phenotype */}
                            {(telestrokeNote.diagnosisCategory === 'ischemic' || telestrokeNote.diagnosisCategory === 'tia') && (
                              <div className="grid grid-cols-2 gap-3">
                                <div>
                                  <label htmlFor="input-stroke-territory" className="block text-xs text-slate-600 mb-1">Vascular Territory</label>
                                  <select id="input-stroke-territory" value={telestrokeNote.strokeTerritory || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, strokeTerritory: v})); }}
                                    className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
                                    <option value="">-- Territory --</option>
                                    <option value="MCA">MCA (middle cerebral artery)</option>
                                    <option value="ACA">ACA (anterior cerebral artery)</option>
                                    <option value="PCA">PCA (posterior cerebral artery)</option>
                                    <option value="basilar">Basilar artery</option>
                                    <option value="vertebral">Vertebral artery</option>
                                    <option value="cerebellar">Cerebellar (PICA/AICA/SCA)</option>
                                    <option value="lacunar">Lacunar / perforator</option>
                                    <option value="watershed">Watershed / border zone</option>
                                    <option value="multi">Multi-territory</option>
                                  </select>
                                </div>
                                <div>
                                  <label htmlFor="input-stroke-phenotype" className="block text-xs text-slate-600 mb-1">Stroke Phenotype</label>
                                  <select id="input-stroke-phenotype" value={telestrokeNote.strokePhenotype || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, strokePhenotype: v})); }}
                                    className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
                                    <option value="">-- Phenotype --</option>
                                    <option value="cortical-lvo">Cortical — large vessel occlusion</option>
                                    <option value="cortical-embolic">Cortical — embolic pattern</option>
                                    <option value="lacunar">Lacunar / small vessel</option>
                                    <option value="posterior">Posterior circulation</option>
                                    <option value="dissection">Arterial dissection</option>
                                    <option value="watershed">Hemodynamic / watershed</option>
                                    <option value="cardioembolic">Cardioembolic</option>
                                  </select>
                                </div>
                              </div>
                            )}
                            {['basilar', 'vertebral', 'cerebellar'].includes(telestrokeNote.strokeTerritory) && (
                              <div className="bg-blue-50 border border-blue-300 rounded-lg p-2 text-xs text-blue-800">
                                <strong>Posterior circulation:</strong> Consider pc-ASPECTS (if available), extended EVT window for basilar occlusion (BAOCHE/ATTENTION: up to 24h), and higher index of suspicion for missed diagnosis. Ataxia, vertigo, diplopia, and dysarthria without hemiparesis may be overlooked.
                              </div>
                            )}

                            {/* Symptom Trajectory */}
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <label htmlFor="input-symptom-trajectory" className="block text-xs text-slate-600 mb-1">Symptom Trajectory</label>
                                <select id="input-symptom-trajectory" value={telestrokeNote.symptomTrajectory || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, symptomTrajectory: v})); }}
                                  className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500">
                                  <option value="">-- Trajectory --</option>
                                  <option value="stable">Stable since onset</option>
                                  <option value="improving">Improving</option>
                                  <option value="fluctuating">Fluctuating</option>
                                  <option value="worsening">Worsening</option>
                                  <option value="resolved">Completely resolved</option>
                                </select>
                              </div>
                              <div>
                                <label htmlFor="input-onset-nihss" className="block text-xs text-slate-600 mb-1">Estimated Onset NIHSS</label>
                                <input id="input-onset-nihss" type="number" min="0" max="42"
                                  value={telestrokeNote.symptomOnsetNIHSS || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, symptomOnsetNIHSS: v})); }}
                                  placeholder="If different from current"
                                  className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500" />
                              </div>
                            </div>
                            {telestrokeNote.symptomTrajectory === 'worsening' && (
                              <div className="bg-red-50 border border-red-300 rounded-lg p-2 text-xs text-red-800">
                                <strong>Worsening symptoms:</strong> Consider repeat imaging to rule out hemorrhagic transformation, edema, or new infarction. If post-tPA/TNK, assess for sICH. If LVO, reassess EVT candidacy.
                              </div>
                            )}
                            {telestrokeNote.symptomTrajectory === 'resolved' && telestrokeNote.diagnosisCategory === 'ischemic' && (
                              <div className="bg-amber-50 border border-amber-300 rounded-lg p-2 text-xs text-amber-800">
                                <strong>Resolved symptoms with ischemic diagnosis:</strong> Consider TIA vs minor stroke. If DWI positive, this is a completed stroke despite resolution. ABCD2 score may help risk-stratify. Dual antiplatelet (DAPT) x21 days if minor stroke (NIHSS &le;3) or high-risk TIA.
                              </div>
                            )}

                            {telestrokeNote.diagnosisCategory === 'ischemic' && (
                            <div className="grid grid-cols-2 gap-3">
                              <label className="flex items-center gap-2 p-2 bg-emerald-50 border border-emerald-200 rounded-lg cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={telestrokeNote.tnkRecommended}
                                  onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, tnkRecommended: c})); }}
                                  disabled={telestrokeNote.tnkAutoBlocked}
                                  className="w-4 h-4 text-emerald-600 disabled:opacity-50"
                                  aria-label={telestrokeNote.tnkAutoBlocked ? 'TNK Recommended — disabled due to contraindication' : 'TNK Recommended'}
                                />
                                <span className={`text-sm font-medium ${telestrokeNote.tnkAutoBlocked ? 'text-slate-500 line-through' : 'text-emerald-800'}`}>TNK Recommended</span>
                              </label>
                              <label className="flex items-center gap-2 p-2 bg-blue-50 border border-blue-200 rounded-lg cursor-pointer">
                                <input
                                  type="checkbox"
                                  checked={telestrokeNote.evtRecommended}
                                  onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, evtRecommended: c})); }}
                                  className="w-4 h-4 text-blue-600"
                                />
                                <span className="text-sm font-medium text-blue-800">EVT Recommended</span>
                              </label>
                            </div>
                            )}
                            {/* Inline sICH Risk at TNK Decision Point */}
                            {telestrokeNote.tnkRecommended && (() => {
                              const glucose = parseInt(telestrokeNote.glucose, 10) || 0;
                              const nihss = parseInt(telestrokeNote.nihss || nihssScore, 10) || 0;
                              const age = parseInt(telestrokeNote.age, 10) || 0;
                              let sedanAuto = 0;
                              if (glucose > 144 && glucose <= 216) sedanAuto += 1;
                              else if (glucose > 216) sedanAuto += 2;
                              if (age > 75) sedanAuto += 1;
                              if (nihss >= 10) sedanAuto += 1;
                              if (telestrokeNote.earlyInfarctSigns) sedanAuto += 1;
                              if (telestrokeNote.denseArterySign) sedanAuto += 1;
                              const sedanRisk = sedanAuto === 0 ? '~1%' : sedanAuto === 1 ? '~3%' : sedanAuto === 2 ? '~5%' : sedanAuto === 3 ? '~9%' : sedanAuto === 4 ? '~16%' : '~28%+';
                              const span100 = age + nihss;
                              const span100Pos = span100 >= 100;
                              const riskLevel = sedanAuto >= 4 || span100Pos ? 'high' : sedanAuto >= 2 ? 'moderate' : 'low';
                              const colors = riskLevel === 'high' ? 'bg-red-50 border-red-300 text-red-800' : riskLevel === 'moderate' ? 'bg-amber-50 border-amber-300 text-amber-800' : 'bg-emerald-50 border-emerald-200 text-emerald-700';
                              return (
                                <div className={`mt-2 rounded-lg border px-3 py-2 ${colors}`}>
                                  <p className="text-xs font-semibold mb-1">sICH Risk Assessment</p>
                                  <div className="flex flex-wrap gap-3 text-xs">
                                    <span>SEDAN: {sedanAuto}/6 (est. sICH {sedanRisk})</span>
                                    <span className={span100Pos ? 'font-bold' : ''}>SPAN-100: {span100} {span100Pos ? '(≥100 — higher risk)' : '(<100)'}</span>
                                  </div>
                                  <div className="flex flex-wrap gap-2 mt-1">
                                    <label className="flex items-center gap-1 text-xs cursor-pointer">
                                      <input type="checkbox" checked={!!telestrokeNote.earlyInfarctSigns}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, earlyInfarctSigns: c})); }}
                                        className="w-4 h-4" />
                                      Early infarct signs on CT (+1)
                                    </label>
                                    <label className="flex items-center gap-1 text-xs cursor-pointer">
                                      <input type="checkbox" checked={!!telestrokeNote.denseArterySign}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, denseArterySign: c})); }}
                                        className="w-4 h-4" />
                                      Dense artery sign (+1)
                                    </label>
                                  </div>
                                </div>
                              );
                            })()}

                            {/* ICH Quick Management */}
                            {telestrokeNote.diagnosisCategory === 'ich' && (
                              <div className="bg-red-50 border-2 border-red-300 rounded-lg p-3 space-y-2">
                                <h5 className="text-sm font-bold text-red-800">ICH Management</h5>
                                <div className="grid grid-cols-2 gap-2">
                                  <label className="flex items-center gap-2 cursor-pointer text-sm">
                                    <input type="checkbox" checked={!!telestrokeNote.ichBPManaged}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, ichBPManaged: c})); }}
                                      className="w-4 h-4 text-red-600" />
                                    <span>BP managed (target SBP &lt;140)</span>
                                  </label>
                                  <label className="flex items-center gap-2 cursor-pointer text-sm">
                                    <input type="checkbox" checked={!!telestrokeNote.ichReversalInitiated}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, ichReversalInitiated: c})); }}
                                      className="w-4 h-4 text-red-600" />
                                    <span>Anticoag reversal initiated</span>
                                  </label>
                                  <label className="flex items-center gap-2 cursor-pointer text-sm">
                                    <input type="checkbox" checked={!!telestrokeNote.ichNeurosurgeryConsulted}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, ichNeurosurgeryConsulted: c})); }}
                                      className="w-4 h-4 text-red-600" />
                                    <span>Neurosurgery consulted</span>
                                  </label>
                                  <label className="flex items-center gap-2 cursor-pointer text-sm">
                                    <input type="checkbox" checked={!!telestrokeNote.ichSeizureProphylaxis}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, ichSeizureProphylaxis: c})); }}
                                      className="w-4 h-4 text-red-600" />
                                    <span>Seizure prophylaxis</span>
                                  </label>
                                </div>
                                <div className="text-xs text-red-700 bg-red-100 rounded p-1.5">
                                  TNK is contraindicated. Targets: SBP &lt;140 (Class IIa, INTERACT2; avoid &lt;130), reverse anticoagulation if applicable, repeat CT in 6h, ICU admission.
                                </div>

                                {/* ICH Surgical Decision Triggers */}
                                <div className="mt-3 bg-red-100 border border-red-300 rounded-lg p-3">
                                  <div className="text-sm font-semibold text-red-800 mb-2">Surgical Assessment</div>
                                  <div className="space-y-1.5">
                                    {[
                                      { key: 'cerebellarGt15mL', label: 'Cerebellar ICH >15 mL or >3 cm', detail: 'Class I indication for surgical evacuation if deteriorating' },
                                      { key: 'hydrocephalus', label: 'Obstructive hydrocephalus', detail: 'EVD placement indicated' },
                                      { key: 'midlineShift', label: 'Midline shift / herniation risk', detail: 'Consider decompressive craniectomy or evacuation' },
                                      { key: 'clinicalDeterioration', label: 'Clinical deterioration', detail: 'GCS drop >=2 points or pupil asymmetry — urgent neurosurgery' },
                                      { key: 'surgeryDiscussed', label: 'Surgery discussed with neurosurgery', detail: 'Document time and decision' }
                                    ].map(item => (
                                      <label key={item.key} className="flex items-start gap-2 cursor-pointer">
                                        <input type="checkbox"
                                          checked={!!(telestrokeNote.ichSurgicalCriteria || {})[item.key]}
                                          onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, ichSurgicalCriteria: {...(prev.ichSurgicalCriteria || {}), [k]: c}})); }}
                                          className="mt-0.5 w-4 h-4 text-red-600" />
                                        <div>
                                          <span className="text-sm font-medium text-slate-800">{item.label}</span>
                                          <span className="block text-xs text-slate-500">{item.detail}</span>
                                        </div>
                                      </label>
                                    ))}
                                    <select value={(telestrokeNote.ichSurgicalCriteria || {}).surgeryDecision || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichSurgicalCriteria: {...(prev.ichSurgicalCriteria || {}), surgeryDecision: v}})); }}
                                      aria-label="Surgical decision"
                                      className="w-full px-2 py-1.5 border border-slate-300 rounded text-sm mt-1">
                                      <option value="">-- Surgical decision --</option>
                                      <option value="evacuate">Surgical evacuation planned</option>
                                      <option value="evd">EVD placement only</option>
                                      <option value="mie">Minimally invasive evacuation (MIE)</option>
                                      <option value="observe">Observe with repeat imaging</option>
                                      <option value="comfort">Comfort measures — goals-of-care discussion</option>
                                      <option value="not-candidate">Not a surgical candidate</option>
                                    </select>
                                  </div>
                                  {((telestrokeNote.ichSurgicalCriteria || {}).cerebellarGt15mL || (telestrokeNote.ichSurgicalCriteria || {}).clinicalDeterioration) && !(telestrokeNote.ichSurgicalCriteria || {}).surgeryDiscussed && (
                                    <div className="mt-2 bg-red-200 border border-red-500 rounded p-2 text-xs text-red-900 font-bold">
                                      URGENT: Surgical criteria met — neurosurgery must be contacted immediately.
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* Stroke Mimic Decision Support */}
                            {telestrokeNote.diagnosis === 'Stroke Mimic' && (
                              <div className="bg-purple-50 border-2 border-purple-300 rounded-lg p-3 space-y-2">
                                <h5 className="text-sm font-bold text-purple-800">Stroke Mimic — Differential Diagnosis</h5>
                                <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-slate-700">
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">1.</span> Seizure / Todd's paralysis</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">2.</span> Hypoglycemia</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">3.</span> Migraine with aura</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">4.</span> Functional / conversion disorder</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">5.</span> Syncope / presyncope</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">6.</span> Toxic-metabolic encephalopathy</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">7.</span> Peripheral vertigo (BPPV, vestibular neuritis)</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">8.</span> Hypertensive encephalopathy / PRES</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">9.</span> CNS infection (meningitis, encephalitis)</div>
                                  <div className="flex items-start gap-1"><span className="text-purple-500 font-bold">10.</span> Brain tumor / mass lesion</div>
                                </div>
                                <div className="text-xs text-purple-900 bg-purple-100 rounded p-1.5 mt-1">
                                  <strong>Key checks:</strong> Fingerstick glucose, tox screen, EEG if seizure suspected, MRI DWI to exclude infarct, CBC/BMP/TSH. Consider HINTS exam for posterior fossa symptoms.
                                </div>
                              </div>
                            )}

                            {telestrokeNote.tnkRecommended && (
                              <div>
                                <label className="block text-xs text-slate-600 mb-1">TNK Admin Time</label>
                                <input
                                  type="time"
                                  value={telestrokeNote.tnkAdminTime || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, tnkAdminTime: v})); }}
                                  className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500"
                                />
                                {telestrokeNote.tnkAdminTime && (() => {
                                  const [h, m] = telestrokeNote.tnkAdminTime.split(':').map(Number);
                                  if (isNaN(h) || isNaN(m)) return null;
                                  const now = currentTime;
                                  const tnkDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m);
                                  const diffMin = Math.round((now - tnkDate) / 60000);
                                  if (isNaN(diffMin) || diffMin < 0 || diffMin > 1440) return null;
                                  const color = diffMin <= 60 ? 'text-emerald-700 bg-emerald-50' : diffMin <= 180 ? 'text-amber-700 bg-amber-50' : 'text-red-700 bg-red-50';
                                  return (
                                    <div className={`mt-1 px-2 py-1 rounded text-xs font-medium ${color}`}>
                                      {diffMin} min since TNK{diffMin >= 60 && diffMin < 180 ? ' — monitor for complications' : diffMin >= 180 ? ' — order repeat CT at 24h' : ''}
                                    </div>
                                  );
                                })()}
                              </div>
                            )}

                            <div>
                              <label htmlFor="input-rationale" className="block text-xs text-slate-600 mb-1">Rationale</label>
                              <textarea
                                id="input-rationale"
                                value={telestrokeNote.rationale}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, rationale: v})); }}
                                rows="2"
                                placeholder="Clinical rationale for treatment recommendation..."
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                              />
                            </div>

                            <div>
                              <label htmlFor="input-disposition" className="block text-xs text-slate-600 mb-1">Disposition</label>
                              <select
                                id="input-disposition"
                                value={telestrokeNote.disposition || ''}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, disposition: v})); }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                              >
                                <option value="">-- Select --</option>
                                <option value="Admit to Neuro ICU">Admit to Neuro ICU</option>
                                <option value="Admit to Stroke Unit">Admit to Stroke Unit</option>
                                <option value="Admit to Floor">Admit to Floor</option>
                                <option value="Transfer to CSC">Transfer to Comprehensive Stroke Center</option>
                                <option value="Transfer to PSC">Transfer to Primary Stroke Center</option>
                                <option value="Observation">Observation</option>
                                <option value="Discharge">Discharge</option>
                              </select>
                            </div>

                            <div>
                              <label htmlFor="input-code-status" className="block text-xs text-slate-600 mb-1">Code Status</label>
                              <select
                                id="input-code-status"
                                value={telestrokeNote.codeStatus || ''}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, codeStatus: v})); }}
                                className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                              >
                                <option value="">-- Select --</option>
                                <option value="Full Code">Full Code</option>
                                <option value="DNR/DNI">DNR/DNI</option>
                                <option value="DNR/Full treatment">DNR / Full treatment</option>
                                <option value="Comfort care">Comfort care</option>
                                <option value="Not yet discussed">Not yet discussed</option>
                              </select>
                            </div>

                            {/* Transfer Checklist */}
                            {(telestrokeNote.disposition === 'Transfer to CSC' || telestrokeNote.disposition === 'Transfer to PSC') && (
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 space-y-2">
                                <h5 className="text-sm font-semibold text-blue-800">Transfer Checklist</h5>
                                <div>
                                  <label htmlFor="input-transfer-facility" className="block text-xs text-slate-600 mb-0.5">Receiving Facility</label>
                                  <input id="input-transfer-facility" type="text" value={telestrokeNote.transferReceivingFacility || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, transferReceivingFacility: v})); }}
                                    placeholder="e.g., Regional Medical Center"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-xs" />
                                </div>
                                <div className="grid grid-cols-2 gap-1.5 text-sm">
                                  {[
                                    { key: 'transferAccepted', label: 'Accepting facility contacted' },
                                    { key: 'transferImagingShared', label: 'Imaging shared/sent' },
                                    { key: 'transferLabsSent', label: 'Labs and records sent' },
                                    { key: 'transferIVAccess', label: 'IV access confirmed' },
                                    { key: 'transferBPStable', label: 'BP stable for transport' },
                                    { key: 'transferFamilyNotified', label: 'Family notified' }
                                  ].map(item => (
                                    <label key={item.key} className="flex items-center gap-2 cursor-pointer">
                                      <input type="checkbox" checked={!!telestrokeNote[item.key]}
                                        onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, [k]: c})); }}
                                        className="w-4 h-4 text-blue-600" />
                                      <span>{item.label}</span>
                                    </label>
                                  ))}
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                  <div>
                                    <label htmlFor="input-transport-mode" className="block text-xs text-slate-600 mb-0.5">Transport Mode</label>
                                    <select id="input-transport-mode" value={telestrokeNote.transportMode || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, transportMode: v})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">--</option>
                                      <option value="Ground ambulance">Ground ambulance</option>
                                      <option value="Air transport">Air transport</option>
                                      <option value="Critical care transport">Critical care transport</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label htmlFor="input-transport-eta" className="block text-xs text-slate-600 mb-0.5">ETA</label>
                                    <input id="input-transport-eta" type="text" value={telestrokeNote.transportEta || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, transportEta: v})); }}
                                      placeholder="e.g., 45 min"
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs" />
                                  </div>
                                </div>
                              </div>
                            )}

                            {/* TOAST Quick-Select */}
                            {telestrokeNote.diagnosisCategory === 'ischemic' && (
                              <div className="bg-violet-50 border border-violet-200 rounded-lg p-3">
                                <h5 className="text-sm font-semibold text-violet-800 mb-2">Stroke Etiology (TOAST)</h5>
                                <div className="flex flex-wrap gap-1.5">
                                  {[
                                    { value: 'large-artery', label: 'Large Artery' },
                                    { value: 'cardioembolism', label: 'Cardioembolism' },
                                    { value: 'small-vessel', label: 'Lacunar' },
                                    { value: 'other-determined', label: 'Other' },
                                    { value: 'cryptogenic', label: 'Cryptogenic/ESUS' }
                                  ].map(item => (
                                    <button key={item.value} type="button"
                                      onClick={() => setTelestrokeNote(prev => ({...prev, toastClassification: prev.toastClassification === item.value ? '' : item.value}))}
                                      className={`px-2.5 py-1 text-xs rounded-full font-medium transition-colors ${
                                        telestrokeNote.toastClassification === item.value ? 'bg-violet-600 text-white' : 'bg-white border border-violet-200 text-violet-700 hover:bg-violet-100'
                                      }`}>
                                      {item.label}
                                    </button>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* Quick Secondary Prevention (for consult recommendations) */}
                            {telestrokeNote.diagnosisCategory === 'ischemic' && (
                              <details className="bg-emerald-50 border border-emerald-200 rounded-lg">
                                <summary className="p-3 text-sm font-semibold text-emerald-800 cursor-pointer flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="chevron-right" className="w-3.5 h-3.5"></i>
                                  Quick Secondary Prevention
                                </summary>
                                <div className="px-3 pb-3 space-y-2">
                                <div className="grid grid-cols-2 gap-2">
                                  <div>
                                    <label htmlFor="input-antithrombotic" className="block text-xs text-slate-600 mb-0.5">Antithrombotic</label>
                                    <select id="input-antithrombotic" value={(telestrokeNote.secondaryPrevention || {}).antiplateletRegimen || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), antiplateletRegimen: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">-- Select --</option>
                                      <option value="dapt-21">DAPT x 21d (minor stroke/TIA)</option>
                                      <option value="asa-mono">ASA 81-325 mg</option>
                                      <option value="clopidogrel-mono">Clopidogrel 75 mg</option>
                                      <option value="asa-er-dipyridamole">ASA/Dipyridamole</option>
                                      <option value="doac-af">DOAC for AF</option>
                                      <option value="anticoag-other">Anticoagulation (other)</option>
                                    </select>
                                    {(telestrokeNote.secondaryPrevention || {}).antiplateletRegimen === 'dapt-21' && (
                                      <select aria-label="DAPT duration" value={(telestrokeNote.secondaryPrevention || {}).daptDuration || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), daptDuration: v}})); }}
                                        className="w-full mt-1 px-2 py-1 border border-slate-300 rounded text-xs">
                                        <option value="">-- DAPT duration --</option>
                                        <option value="21 days">21 days (POINT/CHANCE)</option>
                                        <option value="30 days">30 days</option>
                                        <option value="90 days">90 days (CHANCE-2/THALES)</option>
                                      </select>
                                    )}
                                    {(() => {
                                      const sp = telestrokeNote.secondaryPrevention || {};
                                      const ap = sp.antiplateletRegimen || '';
                                      const cyp = sp.cyp2c19Result || '';
                                      const usesClopidogrel = ap === 'clopidogrel-mono' || ap === 'dapt-21';
                                      if (usesClopidogrel && cyp === 'poor-metabolizer') return (
                                        <div className="mt-1 p-1.5 bg-red-100 border border-red-300 rounded text-xs text-red-800">
                                          <strong>CYP2C19 LOF:</strong> Clopidogrel ineffective. Switch to ticagrelor + ASA (CHANCE-2).
                                        </div>
                                      );
                                      if (usesClopidogrel && cyp === 'intermediate') return (
                                        <div className="mt-1 p-1.5 bg-amber-100 border border-amber-300 rounded text-xs text-amber-800">
                                          <strong>CYP2C19 intermediate:</strong> Consider ticagrelor over clopidogrel (CHANCE-2).
                                        </div>
                                      );
                                      return null;
                                    })()}
                                  </div>
                                  <div>
                                    <label htmlFor="input-statin" className="block text-xs text-slate-600 mb-0.5">Statin</label>
                                    <select id="input-statin" value={(telestrokeNote.secondaryPrevention || {}).statinDose || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), statinDose: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">-- Select --</option>
                                      <option value="atorvastatin-80">Atorvastatin 80 mg (high intensity)</option>
                                      <option value="rosuvastatin-20">Rosuvastatin 20-40 mg (high intensity)</option>
                                      <option value="atorvastatin-40">Atorvastatin 40 mg (moderate)</option>
                                      <option value="already-on-statin">Already on statin - continue</option>
                                      <option value="statin-deferred">Statin deferred</option>
                                    </select>
                                  </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                  <div>
                                    <label htmlFor="input-bp-target" className="block text-xs text-slate-600 mb-0.5">BP Target</label>
                                    <select id="input-bp-target" value={(telestrokeNote.secondaryPrevention || {}).bpTarget || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), bpTarget: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">-- Select --</option>
                                      <option value="<130/80">&lt;130/80 (intensive, SPS3/ESPRIT)</option>
                                      <option value="<140/90">&lt;140/90 (standard)</option>
                                      <option value="permissive">Permissive (acute phase)</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label htmlFor="input-bp-meds" className="block text-xs text-slate-600 mb-0.5">BP Meds</label>
                                    <input id="input-bp-meds" type="text" value={(telestrokeNote.secondaryPrevention || {}).bpMeds || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), bpMeds: v}})); }}
                                      placeholder="e.g., Amlodipine 5mg"
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs" />
                                  </div>
                                </div>
                                </div>
                              </details>
                            )}
                          </div>
                        </div>

                        {/* Section 6b: Recommendations */}
                        <div className="bg-white border border-blue-200 rounded-xl p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h4 className="text-md font-bold text-blue-900 flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="clipboard-check" className="w-4 h-4"></i>
                              <label htmlFor="input-recommendations">Recommendations</label>
                            </h4>
                            <button
                              type="button"
                              onClick={() => {
                                const note = generateTelestrokeNote();
                                setTelestrokeNote(prev => ({...prev, recommendationsText: note}));
                              }}
                              className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-lg hover:bg-blue-700 transition-colors"
                            >
                              <i aria-hidden="true" data-lucide="file-text" className="w-3 h-3"></i>
                              Generate Auto-Note
                            </button>
                          </div>
                          <textarea
                            id="input-recommendations"
                            value={telestrokeNote.recommendationsText}
                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, recommendationsText: v})); }}
                            placeholder="Click 'Generate Auto-Note' or type recommendations..."
                            rows="5"
                            className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"
                          />
                        </div>

                        {/* Missing Fields Warning */}
                        {(() => {
                          const missing = [
                            !telestrokeNote.age && 'Age',
                            !lkwTime && !telestrokeNote.lkwUnknown && 'LKW',
                            !(telestrokeNote.nihss || nihssScore) && 'NIHSS',
                            !telestrokeNote.diagnosisCategory && 'Diagnosis',
                            !telestrokeNote.ctResults && 'CT Results',
                            !telestrokeNote.ctaResults && 'CTA Results',
                            !telestrokeNote.disposition && 'Disposition'
                          ].filter(Boolean);
                          const safetyGaps = [
                            !telestrokeNote.presentingBP && 'BP',
                            !telestrokeNote.glucose && 'Glucose',
                            telestrokeNote.tnkRecommended && !telestrokeNote.weight && 'Weight (TNK dosing)',
                            telestrokeNote.tnkRecommended && !telestrokeNote.tnkConsentDiscussed && 'TNK Consent',
                            !telestrokeNote.plateletCount && 'Platelets',
                          ].filter(Boolean);
                          if (missing.length === 0 && safetyGaps.length === 0) return null;
                          return (
                            <div className="space-y-1.5">
                              {missing.length > 0 && (
                                <div className="bg-amber-50 border border-amber-300 rounded-lg px-3 py-2 flex items-start gap-2">
                                  <i aria-hidden="true" data-lucide="alert-triangle" className="w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0"></i>
                                  <span className="text-xs text-amber-800">
                                    <span className="font-semibold">Incomplete:</span> {missing.join(', ')}
                                  </span>
                                </div>
                              )}
                              {safetyGaps.length > 0 && (
                                <div className="bg-red-50 border border-red-200 rounded-lg px-3 py-2 flex items-start gap-2">
                                  <i aria-hidden="true" data-lucide="shield-alert" className="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0"></i>
                                  <span className="text-xs text-red-700">
                                    <span className="font-semibold">Safety-critical:</span> {safetyGaps.join(', ')}
                                  </span>
                                </div>
                              )}
                            </div>
                          );
                        })()}

                        {/* Section 7: Output Buttons */}
                        <div className="bg-slate-50 border border-slate-200 rounded-lg p-4 shadow-md space-y-3">
                          <div className="flex items-center justify-between mb-3">
                            <h4 className="text-md font-bold text-slate-800">Copy Notes</h4>
                            <select value={noteTemplate} onChange={(e) => setNoteTemplate(e.target.value)}
                              aria-label="Note template"
                              className="text-xs border border-slate-300 rounded-lg px-2 py-1 focus:ring-2 focus:ring-blue-500">
                              <option value="consult">Consult Note</option>
                              <option value="transfer">Transfer Summary</option>
                              <option value="signout">Signout</option>
                              <option value="followup">Follow-up Brief</option>
                              <option value="discharge">Discharge Summary</option>
                              <option value="procedure">EVT Procedure Note</option>
                              <option value="progress">Inpatient Progress Note</option>
                              <option value="patient-ed">Patient Education</option>
                            </select>
                          </div>

                          {/* Pulsara Summary */}
                          <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                            <div className="flex items-center justify-between mb-2">
                              <span className="font-semibold text-indigo-800 text-sm">Pulsara Summary</span>
                              <button
                                onClick={() => { copyToClipboard(generatePulsaraSummary(), 'tel-pulsara'); }}
                                className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 transition-colors"
                              >
                                <i aria-hidden="true" data-lucide={copiedText === 'tel-pulsara' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                {copiedText === 'tel-pulsara' ? 'Copied!' : 'Copy Pulsara'}
                              </button>
                            </div>
                            <p className="text-xs text-slate-600 whitespace-pre-wrap">{generatePulsaraPreview()}</p>
                          </div>

                          {/* Smart Note */}
                          <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                            <div className="flex items-center justify-between mb-2">
                              <span className="font-semibold text-emerald-800 text-sm">Smart Note (Narrative)</span>
                              <button
                                onClick={() => {
                                  const note = buildSmartNote();
                                  copyToClipboard(note, 'smart-note');
                                }}
                                className="flex items-center gap-2 px-3 py-1.5 bg-emerald-600 text-white text-sm rounded-lg hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-500 transition-colors"
                              >
                                <i aria-hidden="true" data-lucide={copiedText === 'smart-note' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                {copiedText === 'smart-note' ? 'Copied!' : 'Copy Smart Note'}
                              </button>
                            </div>
                            <p className="text-xs text-slate-600 whitespace-pre-wrap">
                              {buildSmartNote()}
                            </p>
                          </div>

                          {/* Full Note Button (uses template system) */}
                          <button
                            onClick={() => {
                              const note = generateTelestrokeNote();
                              copyToClipboard(note, 'telephone-note');
                            }}
                            className="w-full px-4 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 focus:ring-2 focus:ring-amber-500 transition-colors font-medium flex items-center justify-center gap-2"
                          >
                            <i aria-hidden="true" data-lucide="copy" className="w-4 h-4"></i>
                            {copiedText === 'telephone-note' ? 'Copied!' : `Copy ${
                              noteTemplate === 'consult' ? 'Consult Note' : noteTemplate === 'transfer' ? 'Transfer Summary' : noteTemplate === 'signout' ? 'Signout' : noteTemplate === 'discharge' ? 'Discharge Summary' : noteTemplate === 'procedure' ? 'Procedure Note' : noteTemplate === 'progress' ? 'Progress Note' : noteTemplate === 'patient-ed' ? 'Patient Education' : 'Follow-up Brief'
                            }`}
                          </button>

                          {/* Share via Web Share API (mobile) */}
                          {typeof navigator !== 'undefined' && navigator.share && (
                            <button
                              onClick={async () => {
                                try {
                                  const note = generateTelestrokeNote();
                                  await navigator.share({ title: `Stroke Consult — ${telestrokeNote.diagnosis || 'Note'}`, text: note });
                                } catch (err) { /* user cancelled */ }
                              }}
                              className="w-full px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 focus:ring-2 focus:ring-blue-500 transition-colors font-medium flex items-center justify-center gap-2 text-sm"
                            >
                              <i aria-hidden="true" data-lucide="share-2" className="w-4 h-4"></i>
                              Share Note
                            </button>
                          )}

                          {/* Modular Copy: HPI / Exam-NIHSS / MDM-Plan */}
                          <div className="grid grid-cols-3 gap-2">
                            <button
                              onClick={() => {
                                const age = telestrokeNote.age || '***';
                                const sex = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '***';
                                let hpi = `HPI: ${age} year old ${sex}`;
                                if (telestrokeNote.pmh) hpi += ` with PMH of ${telestrokeNote.pmh}`;
                                hpi += ` presenting with ${telestrokeNote.symptoms || '***'}.\n`;
                                if (lkwTime) hpi += `Last known well: ${lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} on ${lkwTime.toLocaleDateString()}.\n`;
                                if (telestrokeNote.medications) hpi += `Medications: ${telestrokeNote.medications}\n`;
                                if (telestrokeNote.lastDOACType) {
                                  const hpiDoseDate = telestrokeNote.lastDOACDose ? new Date(telestrokeNote.lastDOACDose) : null;
                                  const hpiDoseStr = hpiDoseDate && !Number.isNaN(hpiDoseDate.getTime()) ? `, last dose: ${hpiDoseDate.toLocaleString()}` : '';
                                  hpi += `Anticoag: ${ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]?.name || telestrokeNote.lastDOACType}${hpiDoseStr}\n`;
                                }
                                copyToClipboard(hpi, 'tel-hpi');
                              }}
                              className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1 ${copiedText === 'tel-hpi' ? 'bg-emerald-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                            >
                              <i aria-hidden="true" data-lucide={copiedText === 'tel-hpi' ? 'check' : 'copy'} className="w-3 h-3"></i>
                              HPI Data
                            </button>
                            <button
                              onClick={() => {
                                let exam = `NIHSS: ${telestrokeNote.nihss || nihssScore || 'N/A'}`;
                                if (telestrokeNote.nihssDetails) exam += ` (${telestrokeNote.nihssDetails})`;
                                exam += `\nBP: ${telestrokeNote.presentingBP || 'N/A'}, Glucose: ${telestrokeNote.glucose || 'N/A'}, INR: ${telestrokeNote.inr || 'N/A'}, Plt: ${telestrokeNote.plateletCount || 'N/A'}`;
                                copyToClipboard(exam, 'tel-exam');
                              }}
                              className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1 ${copiedText === 'tel-exam' ? 'bg-emerald-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                            >
                              <i aria-hidden="true" data-lucide={copiedText === 'tel-exam' ? 'check' : 'copy'} className="w-3 h-3"></i>
                              Exam / NIHSS
                            </button>
                            <button
                              onClick={() => {
                                let mdm = `ASSESSMENT: ${telestrokeNote.diagnosis || '***'}\n\nPLAN:\n`;
                                mdm += `TNK: ${telestrokeNote.tnkRecommended ? 'RECOMMENDED' : 'Not recommended'}\n`;
                                mdm += `EVT: ${telestrokeNote.evtRecommended ? 'RECOMMENDED' : 'Not recommended'}\n`;
                                if (telestrokeNote.rationale) mdm += `Rationale: ${telestrokeNote.rationale}\n`;
                                if (telestrokeNote.disposition) mdm += `Disposition: ${telestrokeNote.disposition}\n`;
                                copyToClipboard(mdm, 'tel-mdm');
                              }}
                              className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1 ${copiedText === 'tel-mdm' ? 'bg-emerald-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                            >
                              <i aria-hidden="true" data-lucide={copiedText === 'tel-mdm' ? 'check' : 'copy'} className="w-3 h-3"></i>
                              MDM / Plan
                            </button>
                          </div>
                          {/* Follow-up Brief Copy Button */}
                          {(
                          <button
                            onClick={() => {
                              copyToClipboard(generateFollowUpBrief(), 'tel-followup');
                            }}
                            className={`w-full mt-2 px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1 ${copiedText === 'tel-followup' ? 'bg-emerald-600 text-white' : 'bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-300'}`}
                          >
                            <i aria-hidden="true" data-lucide={copiedText === 'tel-followup' ? 'check' : 'file-output'} className="w-3 h-3"></i>
                            {copiedText === 'tel-followup' ? 'Copied!' : 'Copy Follow-up Brief (Clinic Handoff)'}
                          </button>
                          )}
                        </div>
                      </div>
                    )}

                    {/* ============================================ */}
                    {/* FULL ENCOUNTER FORM - Video Telestroke & Consult */}
                    {/* ============================================ */}
                    {consultationType === 'videoTelestroke' && (
                    <>
                    {/* Two-Column Layout: Desktop/Tablet | Single Column: Mobile */}
                    <div className={`grid grid-cols-1 lg:grid-cols-3 gap-4`}>

                      {/* LEFT COLUMN - Data Entry (2/3 width on desktop) */}
                      <div className={`lg:col-span-2 space-y-4`}>

                        {/* Section 1: Patient Info */}
                        <div id="phone-patient-info-section" className="bg-white border border-blue-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-blue-900">1. Patient Info</h3>
                            <i aria-hidden="true" data-lucide="user" className="w-5 h-5 text-blue-600"></i>
                          </div>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                              <label htmlFor="phone-input-age" className="block text-sm font-medium text-slate-700 mb-1">Age</label>
                              <input
                                id="phone-input-age"
                                type="number"
                                min="0"
                                max="120"
                                value={telestrokeNote.age}
                                onChange={(e) => {
                                  const raw = e.target.value;
                                  if (raw === '') { setTelestrokeNote(prev => ({...prev, age: ''})); return; }
                                  const parsed = parseInt(raw, 10);
                                  if (isNaN(parsed)) return;
                                  const clamped = Math.max(0, Math.min(120, parsed));
                                  setTelestrokeNote(prev => ({...prev, age: String(clamped)}));
                                }}
                                className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 ${telestrokeNote.age && (parseInt(telestrokeNote.age, 10) < 0 || parseInt(telestrokeNote.age, 10) > 120) ? 'border-red-400 bg-red-50' : 'border-slate-300'}`}
                                placeholder="yrs"
                              />
                              {telestrokeNote.age && parseInt(telestrokeNote.age, 10) > 120 && <p className="text-xs text-red-600 mt-0.5">Check age value</p>}
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1">Sex</label>
                              <select
                                value={telestrokeNote.sex}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, sex: v})); }}
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="M">M</option>
                                <option value="F">F</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1">
                                Weight
                                <span className="ml-1 text-xs text-orange-600 font-normal">(TNK dosing)</span>
                              </label>
                              <div className="flex items-center">
                                <input
                                  type="number"
                                  value={telestrokeNote.weight}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, weight: v})); }}
                                  className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 ${telestrokeNote.weight && (parseFloat(telestrokeNote.weight) > 300 || parseFloat(telestrokeNote.weight) < 10) ? 'border-red-400 bg-red-50' : 'border-slate-300'}`}
                                  placeholder="kg"
                                  min="0" max="500"
                                />
                                <span className="ml-1 text-xs text-slate-500">kg</span>
                              </div>
                              <label className="flex items-center gap-1.5 mt-1 cursor-pointer">
                                <input type="checkbox" checked={!!telestrokeNote.weightEstimated}
                                  onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, weightEstimated: c})); }}
                                  className="w-4 h-4" />
                                <span className={'text-xs ' + (telestrokeNote.weightEstimated ? 'text-amber-700 font-semibold' : 'text-slate-500')}>Estimated weight</span>
                              </label>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-1">Height <span className="text-xs text-slate-500 font-normal">(cm)</span></label>
                              <input
                                type="number" min="100" max="250" step="1"
                                value={telestrokeNote.height}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, height: v})); }}
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="cm"
                              />
                            </div>
                            <div>
                              <label htmlFor="phone-input-premorbid-mrs" className="block text-sm font-medium text-slate-700 mb-1">
                                Pre-stroke mRS
                                <span className="ml-1 text-xs text-blue-600 font-normal">(trials)</span>
                              </label>
                              <select
                                id="phone-input-premorbid-mrs"
                                value={telestrokeNote.premorbidMRS}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, premorbidMRS: v})); }}
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="">Select...</option>
                                <option value="0">0 - No symptoms</option>
                                <option value="1">1 - No significant disability</option>
                                <option value="2">2 - Slight disability</option>
                                <option value="3">3 - Moderate disability</option>
                                <option value="4">4 - Moderately severe disability</option>
                                <option value="5">5 - Severe disability</option>
                              </select>
                            </div>
                          </div>
                          {/* Auto TNK Dose Display */}
                          {telestrokeNote.weight && calculateTNKDose(telestrokeNote.weight) && (
                            <div className="mt-2 bg-orange-50 border border-orange-200 rounded-lg p-2 flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <span className="text-orange-800 font-medium inline-flex items-center gap-1"><i aria-hidden="true" data-lucide="syringe" className="w-3.5 h-3.5"></i> TNK Dose:</span>
                                <span className="text-lg font-bold text-orange-700">{calculateTNKDose(telestrokeNote.weight).calculatedDose} mg</span>
                                <span className="text-sm text-orange-600">({calculateTNKDose(telestrokeNote.weight).volume})</span>
                              </div>
                              <span className="text-xs text-orange-500">0.25 mg/kg, max 25 mg</span>
                            </div>
                          )}
                          <div className="mt-3">
                            <label className="block text-sm font-medium text-slate-700 mb-1">Chief Complaint</label>
                            <input
                              type="text"
                              value={telestrokeNote.chiefComplaint}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, chiefComplaint: v})); }}
                              placeholder="e.g., sudden L-sided weakness, speech difficulty"
                              className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>

                        {/* Section 2: History & Medications */}
                        <div className="bg-white border border-purple-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-purple-900">2. History & Medications</h3>
                            <i aria-hidden="true" data-lucide="file-text" className="w-5 h-5 text-purple-600"></i>
                          </div>
                          <div className="space-y-3">
                            <div>
                              <label htmlFor="phone-input-symptoms" className="block text-sm font-medium text-slate-700 mb-1">Presenting Symptoms</label>
                              <textarea
                                id="phone-input-symptoms"
                                value={telestrokeNote.symptoms}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, symptoms: v})); }}
                                placeholder="e.g., R hemiparesis, aphasia, facial droop, dysarthria"
                                rows="2"
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="phone-input-pmh" className="block text-sm font-medium text-slate-700 mb-1">Relevant PMH</label>
                              <input
                                id="phone-input-pmh"
                                type="text"
                                value={telestrokeNote.pmh}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, pmh: v})); }}
                                placeholder="e.g., AFib, HTN, DM2, prior CVA, CAD"
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label htmlFor="phone-input-medications" className="block text-sm font-medium text-slate-700 mb-1">Medications</label>
                              <textarea
                                id="phone-input-medications"
                                value={telestrokeNote.medications}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, medications: v})); }}
                                placeholder="e.g., ASA 81mg, atorvastatin 40mg, lisinopril 10mg, apixaban 5mg BID"
                                rows="2"
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            {/* DOAC Status for thrombolysis eligibility */}
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 space-y-2">
                              <div className="flex items-center gap-2">
                                <span className="text-sm font-medium text-amber-800 inline-flex items-center gap-1"><i aria-hidden="true" data-lucide="pill" className="w-3.5 h-3.5"></i> Anticoagulation Status</span>
                              </div>
                              <div className="grid grid-cols-2 gap-3">
                                <div>
                                  <label htmlFor="phone-input-anticoag-type" className="block text-xs text-slate-600 mb-1">Anticoagulant Type</label>
                                  <select
                                    id="phone-input-anticoag-type"
                                    value={telestrokeNote.lastDOACType}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, lastDOACType: v})); }}
                                    className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  >
                                    <option value="">None / Unknown</option>
                                    <option value="apixaban">Apixaban (Eliquis)</option>
                                    <option value="rivaroxaban">Rivaroxaban (Xarelto)</option>
                                    <option value="dabigatran">Dabigatran (Pradaxa)</option>
                                    <option value="edoxaban">Edoxaban (Savaysa)</option>
                                    <option value="warfarin">Warfarin (check INR)</option>
                                    <option value="heparin">Heparin UFH (check PTT)</option>
                                    <option value="lmwh">LMWH / Enoxaparin</option>
                                    <option value="fondaparinux">Fondaparinux (Arixtra)</option>
                                  </select>
                                </div>
                                <div>
                                  <label className="block text-xs text-slate-600 mb-1">Last Dose (date/time)</label>
                                  <input
                                    type="datetime-local"
                                    value={telestrokeNote.lastDOACDose}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, lastDOACDose: v})); }}
                                    className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                              </div>
                              {/* Anticoagulant Info Panel - Shows when drug selected */}
                              {telestrokeNote.lastDOACType && ANTICOAGULANT_INFO[telestrokeNote.lastDOACType] && (
                                <div className="bg-orange-50 border border-orange-200 rounded-xl p-3 space-y-2">
                                  <div className="flex items-center justify-between">
                                    <span className="font-bold text-orange-800">
                                      {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].name}
                                    </span>
                                    <span className="text-xs bg-orange-200 text-orange-800 px-2 py-0.5 rounded-full">
                                      {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].class}
                                    </span>
                                  </div>

                                  {/* Key Info Grid */}
                                  <div className="grid grid-cols-2 gap-2 text-xs">
                                    <div className="bg-white rounded p-2 border border-orange-200">
                                      <div className="text-slate-500 mb-0.5">Half-Life</div>
                                      <div className="font-semibold text-slate-800">
                                        {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].halfLife}
                                      </div>
                                    </div>
                                    <div className="bg-white rounded p-2 border border-orange-200">
                                      <div className="text-slate-600 mb-0.5">tPA/TNK Threshold</div>
                                      <div className="font-semibold text-slate-800">
                                        {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].thrombolysisThreshold}
                                      </div>
                                    </div>
                                  </div>

                                  {/* Thrombolysis Note */}
                                  {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].thrombolysisNote && (
                                    <div className="text-xs text-orange-900 bg-orange-100 p-2 rounded flex items-start gap-1">
                                      <i aria-hidden="true" data-lucide="alert-triangle" className="w-4 h-4 text-amber-600"></i>
                                      <span>{ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].thrombolysisNote}</span>
                                    </div>
                                  )}

                                  {/* ICH Reversal - Collapsible */}
                                  <details className="group">
                                    <summary className="cursor-pointer text-sm font-semibold text-red-700 hover:text-red-900 flex items-center gap-1">
                                      <span className="group-open:rotate-90 transition-transform">▶</span>
                                      ICH Reversal Protocol
                                    </summary>
                                    <div className="mt-2 bg-red-50 border border-red-200 rounded-lg p-2 text-xs space-y-1">
                                      <div className="flex items-start gap-2">
                                        <span className="font-bold text-red-700 shrink-0">1st Line:</span>
                                        <span className="text-red-900 font-medium">
                                          {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.primary}
                                        </span>
                                      </div>
                                      {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.pccDosing && (
                                        <div className="flex items-start gap-2">
                                          <span className="font-bold text-red-700 shrink-0">PCC Dose:</span>
                                          <span className="text-red-800">
                                            {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.pccDosing}
                                          </span>
                                        </div>
                                      )}
                                      {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.alternative && (
                                        <div className="flex items-start gap-2">
                                          <span className="font-bold text-slate-600 shrink-0">Alt:</span>
                                          <span className="text-slate-700">
                                            {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.alternative}
                                          </span>
                                        </div>
                                      )}
                                      {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.maxDose && (
                                        <div className="text-slate-600 italic">
                                          {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.maxDose}
                                        </div>
                                      )}
                                      {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.note && (
                                        <div className="text-slate-600 italic mt-1 pt-1 border-t border-red-200">
                                          {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].ichReversal.note}
                                        </div>
                                      )}
                                    </div>
                                  </details>

                                  {/* Monitoring */}
                                  <div className="text-xs text-slate-600">
                                    <span className="font-medium">Monitor:</span> {ANTICOAGULANT_INFO[telestrokeNote.lastDOACType].monitoring}
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>

                        {/* Section 3: NIHSS Examination */}
                        <div id="nihss-section" className="bg-white border border-red-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-red-900">3. NIHSS Examination</h3>
                            <div className="flex items-center gap-2">
                              <span className="text-2xl font-bold text-red-600">Score: {nihssScore}</span>
                              <i aria-hidden="true" data-lucide="brain" className="w-5 h-5 text-red-600"></i>
                            </div>
                          </div>

                          {/* Quick NIHSS Entry */}
                          <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-3">
                            <div className="flex items-center justify-between mb-2">
                              <p className="text-sm font-medium text-slate-700">Quick Entry:</p>
                              <button
                                type="button"
                                onClick={applyNihssAllNormal}
                                className="text-xs font-semibold text-blue-700 hover:text-blue-900"
                              >
                                All normal (0)
                              </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                              <div>
                                <label htmlFor="phone-input-nihss" className="block text-xs text-slate-700 mb-1">NIHSS Score (0-42)</label>
                                <input
                                  id="phone-input-nihss"
                                  type="number"
                                  value={telestrokeNote.nihss}
                                  onChange={(e) => {
                                    const value = e.target.value;
                                    setTelestrokeNote(prev => ({...prev, nihss: value}));
                                    setNihssScore(parseInt(value, 10) || 0);
                                  }}
                                  min="0"
                                  max="42"
                                  className="w-full px-3 py-2 border border-slate-200 rounded-lg text-2xl font-bold text-center focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-700 mb-1">Neurologic Deficits</label>
                                <input
                                  type="text"
                                  value={telestrokeNote.nihssDetails}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, nihssDetails: v})); }}
                                  placeholder="e.g., R hemiparesis, aphasia"
                                  className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                            </div>

                            {/* NIHSS Severity Interpretation */}
                            {(telestrokeNote.nihss || nihssScore > 0) && (
                              <div role="status" aria-live="polite" className={`p-2 rounded-lg text-center text-sm font-medium ${
                                nihssScore === 0 ? 'bg-emerald-100 text-emerald-800' :
                                nihssScore <= 4 ? 'bg-blue-100 text-blue-800' :
                                nihssScore <= 15 ? 'bg-amber-100 text-amber-800' :
                                nihssScore <= 20 ? 'bg-orange-100 text-orange-800' :
                                'bg-red-100 text-red-800'
                              }`}>
                                {nihssScore === 0 ? '0 = No stroke symptoms' :
                                 nihssScore <= 4 ? `${nihssScore} = Minor stroke` :
                                 nihssScore <= 15 ? `${nihssScore} = Moderate stroke` :
                                 nihssScore <= 20 ? `${nihssScore} = Moderate-Severe stroke` :
                                 `${nihssScore} = Severe stroke`}
                                {nihssScore >= 6 && nihssScore <= 24 && ' | Consider TNK if within window'}
                                {nihssScore >= 6 && ' | Consider LVO screening'}
                              </div>
                            )}
                          </div>

                          {/* Full NIHSS Calculator (Collapsible) with keyboard auto-advance */}
                          <details className="bg-slate-50 border border-slate-200 rounded-lg">
                            <summary className="cursor-pointer p-3 font-semibold text-slate-800 hover:bg-slate-100 rounded-lg">
                              <i aria-hidden="true" data-lucide="chart-no-axes-column-increasing" className="w-4 h-4 inline"></i> Full NIHSS Calculator (Click to expand)
                            </summary>
                            <div className="p-4 space-y-3">
                              {isTraineeMode && (
                                <p className="text-xs text-slate-500 italic">Tip: Press number keys (0-4) to select score for focused item. Auto-advances to next item.</p>
                              )}
                              {nihssItems.map((item, itemIndex) => (
                                <div key={item.id} id={`nihss-item-${itemIndex}`} className={`bg-white p-3 rounded border transition-all ${patientData[item.id] ? 'border-emerald-300 bg-emerald-50/30' : ''}`}
                                  tabIndex={0}
                                  onKeyDown={(e) => {
                                    const key = parseInt(e.key, 10);
                                    if (!isNaN(key) && key >= 0 && key < item.options.length) {
                                      e.preventDefault();
                                      const option = item.options[key];
                                      const newData = { ...patientData, [item.id]: option };
                                      setPatientData(newData);
                                      const newScore = calculateNIHSS(newData);
                                      setNihssScore(newScore);
                                      setTelestrokeNote(prev => ({...prev, nihss: newScore.toString()}));
                                      // Auto-advance to next item
                                      if (itemIndex < nihssItems.length - 1) {
                                        setTimeout(() => {
                                          const next = document.getElementById(`nihss-item-${itemIndex + 1}`);
                                          if (next) { next.scrollIntoView({ behavior: 'smooth', block: 'center' }); next.focus(); }
                                        }, 150);
                                      }
                                    }
                                  }}
                                >
                                  <h4 className="font-semibold text-sm mb-2">{item.name} {patientData[item.id] && <span className="text-emerald-600 font-normal ml-1">({patientData[item.id].match(/\((\d+)\)/)?.[1] || '?'})</span>}</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-1">
                                    {item.options.map((option, optionIndex) => (
                                      <button key={optionIndex} type="button"
                                        className={`w-full text-left px-3 py-2 rounded border text-sm transition-colors ${patientData[item.id] === option ? 'bg-blue-600 text-white border-blue-600 font-medium' : 'bg-white border-slate-200 hover:bg-slate-50 active:bg-blue-50'}`}
                                        onClick={() => {
                                          const newData = { ...patientData, [item.id]: option };
                                          setPatientData(newData);
                                          const newScore = calculateNIHSS(newData);
                                          setNihssScore(newScore);
                                          setTelestrokeNote(prev => ({...prev, nihss: newScore.toString()}));
                                          if (itemIndex < nihssItems.length - 1) {
                                            setTimeout(() => {
                                              const next = document.getElementById(`nihss-item-${itemIndex + 1}`);
                                              if (next) { next.scrollIntoView({ behavior: 'smooth', block: 'center' }); next.focus(); }
                                            }, 150);
                                          }
                                        }}
                                      >
                                        <span className={patientData[item.id] === option ? 'text-white/70' : 'text-slate-500'}>[{optionIndex}]</span> {option}
                                      </button>
                                    ))}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </details>
                        </div>

                        {/* Section 4: Vitals & Labs */}
                        <div className="bg-white border border-emerald-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-emerald-900">4. Vitals & Labs</h3>
                            <i aria-hidden="true" data-lucide="activity" className="w-5 h-5 text-emerald-600"></i>
                          </div>
                          <div className="space-y-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              <div>
                                <label htmlFor="input-presenting-bp" className="block text-sm font-medium text-slate-700 mb-1">Presenting BP</label>
                                <div className="flex items-center gap-2">
                                  <input
                                    id="input-presenting-bp"
                                    type="text"
                                    value={telestrokeNote.presentingBP}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, presentingBP: v})); }}
                                    placeholder="185/110"
                                    className={`flex-1 px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                      (() => {
                                        const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                                        if (bpStatus.status === 'too_high') return 'border-red-400 bg-red-50';
                                        if (bpStatus.status === 'borderline') return 'border-amber-400 bg-amber-50';
                                        if (bpStatus.status === 'ok') return 'border-emerald-400 bg-emerald-50';
                                        return 'border-slate-300';
                                      })()
                                    }`}
                                  />
                                  {/* Inline BP Status Badge */}
                                  {(() => {
                                    const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                                    if (bpStatus.status === 'unknown') return null;
                                    return (
                                      <span className={`px-2 py-1 rounded text-xs font-bold border whitespace-nowrap ${bpStatus.badgeClass}`}>
                                        {bpStatus.icon} {bpStatus.message}
                                      </span>
                                    );
                                  })()}
                                </div>
                                {/* Quick BP Math - how much to lower */}
                                {(() => {
                                  const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                                  if (!bpStatus.needsLowering) return null;
                                  return (
                                    <div className="mt-1 px-2 py-1 bg-red-100 border border-red-300 rounded text-xs text-red-800 font-medium">
                                      Need to lower by {bpStatus.sbpToLower}/{bpStatus.dbpToLower} mmHg to reach 185/110
                                    </div>
                                  );
                                })()}
                                {(() => {
                                  const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                                  if (bpStatus.status !== 'too_high') return null;
                                  return (
                                    <div className="mt-2 px-2 py-1 bg-red-50 border border-red-200 rounded text-xs text-red-700">
                                      TNK should be held until BP is controlled below 185/110.
                                    </div>
                                  );
                                })()}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Current BP (prior to TNK, if applicable)</label>
                                <div className="flex items-center gap-2">
                                  <input
                                    type="text"
                                    value={telestrokeNote.bpPreTNK}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, bpPreTNK: v})); }}
                                    placeholder="185/110"
                                    className={`flex-1 px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                      (() => {
                                        const bpStatus = getBPThresholdStatus(telestrokeNote.bpPreTNK);
                                        if (bpStatus.status === 'too_high') return 'border-red-400 bg-red-50';
                                        if (bpStatus.status === 'borderline') return 'border-amber-400 bg-amber-50';
                                        if (bpStatus.status === 'ok') return 'border-emerald-400 bg-emerald-50';
                                        return 'border-slate-300';
                                      })()
                                    }`}
                                  />
                                  <input
                                    type="time"
                                    value={telestrokeNote.bpPreTNKTime}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, bpPreTNKTime: v})); }}
                                    className="w-24 px-2 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  />
                                  {/* Inline BP Status Badge for Pre-TNK BP */}
                                  {(() => {
                                    const bpStatus = getBPThresholdStatus(telestrokeNote.bpPreTNK);
                                    if (bpStatus.status === 'unknown') return null;
                                    return (
                                      <span className={`px-2 py-1 rounded text-xs font-bold border whitespace-nowrap ${bpStatus.badgeClass}`}>
                                        {bpStatus.icon} {bpStatus.message}
                                      </span>
                                    );
                                  })()}
                                </div>
                                {/* Quick BP Math for Pre-TNK BP */}
                                {(() => {
                                  const bpStatus = getBPThresholdStatus(telestrokeNote.bpPreTNK);
                                  if (!bpStatus.needsLowering) return null;
                                  return (
                                    <div className="mt-1 px-2 py-1 bg-red-100 border border-red-300 rounded text-xs text-red-800 font-medium">
                                      Need to lower by {bpStatus.sbpToLower}/{bpStatus.dbpToLower} mmHg to reach 185/110
                                    </div>
                                  );
                                })()}
                              </div>
                            </div>
                            {/* Post-TNK BP Target Reminder */}
                            {(telestrokeNote.tnkRecommended || telestrokeNote.dtnTnkAdministered) && (
                              <div className="mt-2 px-3 py-2 bg-blue-50 border-l-4 border-blue-500 rounded-r text-sm">
                                <span className="font-bold text-blue-800">Post-TNK Target:</span>
                                <span className="text-blue-700 ml-2">&lt;180/105 for 24 hours after thrombolysis</span>
                              </div>
                            )}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                              <div>
                                <label htmlFor="input-glucose" className="block text-sm font-medium text-slate-700 mb-1">Glucose</label>
                                <div className="flex items-center">
                                  <input
                                    id="input-glucose"
                                    type="number"
                                    value={telestrokeNote.glucose}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, glucose: v})); }}
                                    placeholder=""
                                    className={`w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                      (() => {
                                        const g = parseFloat(telestrokeNote.glucose);
                                        if (!g) return 'border-slate-300';
                                        if (g < 50) return 'border-red-400 bg-red-50';
                                        if (g > 400) return 'border-amber-400 bg-amber-50';
                                        return 'border-emerald-400 bg-emerald-50';
                                      })()
                                    }`}
                                    min="10" max="800"
                                  />
                                  <span className="ml-1 text-xs text-slate-500">mg/dL</span>
                                </div>
                                {(() => {
                                  const g = parseFloat(telestrokeNote.glucose);
                                  if (!g) return null;
                                  if (g < 50) return <p className="text-xs text-red-700 font-medium mt-0.5">Hypoglycemia — correct before TNK</p>;
                                  if (g > 400) return <p className="text-xs text-amber-700 font-medium mt-0.5">Severe hyperglycemia — correct, TNK still eligible</p>;
                                  return null;
                                })()}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">INR</label>
                                <input
                                  type="number"
                                  value={telestrokeNote.inr}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, inr: v})); }}
                                  placeholder=""
                                  className={`w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                    (() => {
                                      const i = parseFloat(telestrokeNote.inr);
                                      if (!i) return 'border-slate-300';
                                      if (i > 1.7) return 'border-red-400 bg-red-50';
                                      if (i > 1.5) return 'border-amber-400 bg-amber-50';
                                      return 'border-emerald-400 bg-emerald-50';
                                    })()
                                  }`}
                                  step="0.1"
                                  min="0.5" max="15"
                                />
                                {(() => {
                                  const i = parseFloat(telestrokeNote.inr);
                                  if (!i) return null;
                                  if (i > 1.7) return <p className="text-xs text-red-700 font-medium mt-0.5">TNK contraindicated (INR &gt;1.7)</p>;
                                  if (i > 1.5) return <p className="text-xs text-amber-700 font-medium mt-0.5">Borderline — verify with repeat</p>;
                                  return null;
                                })()}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Platelets</label>
                                <div className="flex items-center">
                                  <input
                                    type="number"
                                    value={telestrokeNote.plateletCount}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, plateletCount: v})); }}
                                    placeholder="K/μL"
                                    className={`w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                      (() => {
                                        const p = parseFloat(telestrokeNote.plateletCount);
                                        if (!p) return 'border-slate-300';
                                        if (p < 100) return 'border-red-400 bg-red-50';
                                        return 'border-emerald-400 bg-emerald-50';
                                      })()
                                    }`}
                                    min="1" max="1500"
                                  />
                                  <span className="ml-1 text-xs text-slate-500">K/μL</span>
                                </div>
                                {(() => {
                                  const p = parseFloat(telestrokeNote.plateletCount);
                                  if (p && p < 100) return <p className="text-xs text-red-700 font-medium mt-0.5">TNK contraindicated (&lt;100K)</p>;
                                  return null;
                                })()}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">aPTT</label>
                                <div className="flex items-center">
                                  <input
                                    type="number"
                                    value={telestrokeNote.ptt}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ptt: v})); }}
                                    placeholder=""
                                    aria-invalid={telestrokeNote.ptt && parseFloat(telestrokeNote.ptt) > 40 ? 'true' : undefined}
                                    aria-describedby={telestrokeNote.ptt && parseFloat(telestrokeNote.ptt) > 40 ? 'aptt-error' : undefined}
                                    className={`w-full px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                      (() => {
                                        const a = parseFloat(telestrokeNote.ptt);
                                        if (!a) return 'border-slate-300';
                                        if (a > 40) return 'border-red-400 bg-red-50';
                                        return 'border-emerald-400 bg-emerald-50';
                                      })()
                                    }`}
                                    min="10" max="200"
                                  />
                                  <span className="ml-1 text-xs text-slate-500">sec</span>
                                </div>
                                {(() => {
                                  const a = parseFloat(telestrokeNote.ptt);
                                  if (a && a > 40) return <p id="aptt-error" role="alert" className="text-xs text-red-700 font-medium mt-0.5">Elevated aPTT — TNK relative CI</p>;
                                  return null;
                                })()}
                              </div>
                            </div>

                          </div>
                        </div>

                        {/* Section 5: Imaging Review */}
                        <div id="imaging-section" className="bg-white border-2 border-indigo-300 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-indigo-900">5. Imaging Review</h3>
                            <i aria-hidden="true" data-lucide="image" className="w-5 h-5 text-indigo-600"></i>
                          </div>
                          <div className="mb-3 rounded-lg border border-indigo-200 bg-indigo-50 px-3 py-2 text-xs text-indigo-800">
                            Do <strong>not</strong> delay IV thrombolysis for CTA/CTP or routine labs unless there is a specific clinical concern
                            (e.g., anticoagulant use, coagulopathy, thrombocytopenia).
                          </div>
                          <div className="space-y-3">
                            {/* Non-contrast Head CT */}
                            <div className="bg-slate-50 p-3 rounded border">
                              <h4 className="font-semibold text-slate-700 mb-2">Non-contrast Head CT</h4>
                              <div className="grid grid-cols-2 gap-2 mb-2">
                                <input
                                  type="date"
                                  value={telestrokeNote.ctDate}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctDate: v})); }}
                                  className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                                <input
                                  type="time"
                                  value={telestrokeNote.ctTime}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctTime: v})); }}
                                  placeholder="Time reviewed"
                                  className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <div className="flex items-center justify-between mb-1">
                                <label htmlFor="phone-input-ct-results" className="text-xs font-medium text-slate-600">CT Results</label>
                              </div>
                              <textarea
                                id="phone-input-ct-results"
                                value={telestrokeNote.ctResults}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctResults: v})); }}
                                placeholder="e.g., No acute ICH, early ischemic changes L MCA territory"
                                rows="2"
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            {/* Quick ASPECTS Entry */}
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                              <div className="flex items-center justify-between mb-2">
                                <label className="text-sm font-medium text-blue-800">ASPECTS Score</label>
                                <span className="text-2xl font-bold text-blue-600">{aspectsScore}/10</span>
                              </div>

                              {/* Quick ASPECTS Buttons */}
                              <div className="flex flex-wrap gap-2 mb-2">
                                {[10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0].map(score => (
                                  <button
                                    key={score}
                                    onClick={() => {
                                      setAspectsScore(score);
                                      // Also update region state to reflect the score
                                      const newState = aspectsRegionState.map((r, idx) => ({
                                        ...r,
                                        checked: idx < score
                                      }));
                                      setAspectsRegionState(newState);
                                    }}
                                    className={`w-8 h-8 rounded-lg text-sm font-bold transition ${
                                      aspectsScore === score ? 'ring-2 ring-offset-1 ring-blue-500' : ''
                                    } ${
                                      score >= 7 ? 'bg-emerald-100 hover:bg-emerald-200 text-emerald-800' :
                                      score >= 6 ? 'bg-amber-100 hover:bg-amber-200 text-amber-800' :
                                      score >= 3 ? 'bg-orange-100 hover:bg-orange-200 text-orange-800' :
                                      'bg-red-100 hover:bg-red-200 text-red-800'
                                    }`}
                                  >
                                    {score}
                                  </button>
                                ))}
                              </div>

                              {/* ASPECTS Interpretation */}
                              <div className={`p-2 rounded-lg text-center text-xs font-medium ${
                                aspectsScore >= 7 ? 'bg-emerald-100 text-emerald-800' :
                                aspectsScore >= 6 ? 'bg-amber-100 text-amber-800' :
                                aspectsScore >= 3 ? 'bg-orange-100 text-orange-800' :
                                'bg-red-100 text-red-800'
                              }`}>
                                {aspectsScore >= 7 ? `ASPECTS ${aspectsScore} = Favorable for EVT (most trials)` :
                                 aspectsScore === 6 ? `ASPECTS 6 = Standard EVT candidate; late window if perfusion mismatch or good collaterals` :
                                 aspectsScore >= 3 ? `ASPECTS ${aspectsScore} = Large core — EVT recommended in many patients (SVIN 2025); consider age/mRS and higher sICH risk` :
                                 `ASPECTS ${aspectsScore} = Very large core (0-2). Early window EVT may be reasonable in select patients without significant mass effect; 6-24h benefit uncertain — discuss goals of care`}
                              </div>
                            </div>

                            {/* ASPECTS Calculator (Collapsible) */}
                            <details className="bg-blue-50 border border-blue-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg">
                                <i aria-hidden="true" data-lucide="grid-3x3" className="w-4 h-4 inline"></i> Full ASPECTS Calculator (Click to expand)
                              </summary>
                              <div className="p-4">
                                <div className="text-center mb-3">
                                  <span className="text-3xl font-bold text-blue-600">ASPECTS: {aspectsScore}</span>
                                </div>
                                <div className="space-y-2">
                                  {aspectsRegionState.map((region) => (
                                    <label key={region.id} className="flex items-center gap-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={region.checked}
                                        onChange={() => {
                                          const newState = aspectsRegionState.map(r =>
                                            r.id === region.id ? { ...r, checked: !r.checked } : r
                                          );
                                          setAspectsRegionState(newState);
                                          setAspectsScore(newState.filter(r => r.checked).length);
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className="text-sm">{region.name}</span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            </details>

                            {/* PC-ASPECTS Calculator (Collapsible) */}
                            <details className="bg-purple-50 border border-purple-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg">
                                <i aria-hidden="true" data-lucide="grid-3x3" className="w-4 h-4 inline"></i> PC-ASPECTS Calculator (Posterior Circulation)
                              </summary>
                              <div className="p-4">
                                <div className="flex justify-between items-center mb-3">
                                  <p className="text-sm text-slate-700">Start at 10 points, subtract points for affected regions:</p>
                                  <div className="text-center">
                                    <span className="text-3xl font-bold text-purple-600">PC-ASPECTS: {calculatePCAspects(pcAspectsRegions)}</span>
                                  </div>
                                </div>
                                <div className="space-y-2">
                                  {pcAspectsRegions.map((region, idx) => (
                                    <label key={region.id} className="flex items-center gap-2 p-2 hover:bg-purple-50 rounded cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={region.checked}
                                        onChange={(e) => {
                                          const newRegions = [...pcAspectsRegions];
                                          newRegions[idx].checked = e.target.checked;
                                          setPcAspectsRegions(newRegions);
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className="text-sm flex-1">{region.name}</span>
                                      <span className="text-xs font-semibold text-purple-900 bg-purple-100 px-2 py-1 rounded">
                                        {region.points} {region.points === 1 ? 'point' : 'points'}
                                      </span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            </details>

                            {/* CTA Head & Neck */}
                            <div className="bg-slate-50 p-3 rounded border">
                              <h4 className="font-semibold text-slate-700 mb-2">CTA Head & Neck</h4>
                              <div className="grid grid-cols-2 gap-2 mb-2">
                                <input
                                  type="date"
                                  value={telestrokeNote.ctaDate}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctaDate: v})); }}
                                  className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                                <input
                                  type="time"
                                  value={telestrokeNote.ctaTime}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctaTime: v})); }}
                                  placeholder="Time reviewed"
                                  className="px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <div className="flex items-center justify-between mb-1">
                                <label htmlFor="phone-input-cta-results" className="text-xs font-medium text-slate-600">CTA Results</label>
                              </div>
                              <textarea
                                id="phone-input-cta-results"
                                value={telestrokeNote.ctaResults}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctaResults: v})); }}
                                placeholder="e.g., L M1 occlusion, patent ICA bilaterally, good collaterals"
                                rows="3"
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />

                              {/* Vessel Occlusion Quick Select for Trial Eligibility */}
                              <div className="mt-3 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                                <p className="text-xs font-semibold text-blue-800 mb-2">
                                  <i aria-hidden="true" data-lucide="flask-conical" className="w-3 h-3 inline"></i> Vessel Occlusion <span className="font-normal">(for trial screening)</span>
                                </p>
                                <div className="flex flex-wrap gap-1.5">
                                  {['ICA', 'M1', 'M2', 'M3', 'M4', 'A1', 'A2', 'A3', 'P1', 'P2', 'P3', 'Basilar'].map(vessel => {
                                    const vesselNames = { ICA: 'Internal carotid artery', M1: 'MCA M1', M2: 'MCA M2', M3: 'MCA M3', M4: 'MCA M4', A1: 'ACA A1', A2: 'ACA A2', A3: 'ACA A3', P1: 'PCA P1', P2: 'PCA P2', P3: 'PCA P3', Basilar: 'Basilar artery' };
                                    const isChecked = (telestrokeNote.vesselOcclusion || []).includes(vessel);
                                    return (
                                    <label key={vessel} className="flex items-center gap-1.5 cursor-pointer py-1 px-1 min-h-[36px]">
                                      <input
                                        type="checkbox"
                                        aria-label={`${vesselNames[vessel] || vessel} occlusion`}
                                        checked={isChecked}
                                        onChange={(e) => {
                                          const current = telestrokeNote.vesselOcclusion || [];
                                          const updated = e.target.checked
                                            ? [...current, vessel]
                                            : current.filter(v => v !== vessel);
                                          setTelestrokeNote(prev => ({...prev, vesselOcclusion: updated}));
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className={`text-xs px-2 py-1 rounded ${
                                        isChecked
                                          ? 'bg-blue-600 text-white font-semibold'
                                          : 'bg-slate-200 text-slate-700'
                                      }`}>{vessel}</span>
                                    </label>
                                    );
                                  })}
                                  {(telestrokeNote.vesselOcclusion || []).length === 0 && (
                                    <span className="text-xs text-slate-500 italic">None selected</span>
                                  )}
                                </div>
                              </div>
                            </div>

                            {/* CT Perfusion */}
                            <div className="bg-slate-50 p-3 rounded border">
                              <h4 className="font-semibold text-slate-700 mb-2">CT Perfusion</h4>
                              <textarea
                                value={telestrokeNote.ctpResults}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ctpResults: v})); }}
                                placeholder=""
                                rows="3"
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            {/* Telemetry / EKG */}
                            <div className="bg-slate-50 p-3 rounded border">
                              <h4 className="font-semibold text-slate-700 mb-2">Telemetry / EKG</h4>
                              <input
                                type="text"
                                value={telestrokeNote.ekgResults}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ekgResults: v})); }}
                                placeholder="NSR, AF, STEMI, etc."
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Section 6: Treatment Decision */}
                        <div id="treatment-decision" ref={treatmentDecisionRef} className="bg-white border border-orange-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-orange-900">6. Treatment Decision</h3>
                            <i aria-hidden="true" data-lucide="zap" className="w-5 h-5 text-orange-600"></i>
                          </div>

                          {/* Auto Treatment Recommendation */}
                          {(() => {
                            const timeFromLKW = calculateTimeFromLKW();
                            const hoursFromLKW = timeFromLKW ? timeFromLKW.total : null;
                            const nihss = parseInt(telestrokeNote.nihss, 10) || nihssScore || 0;
                            const aspects = aspectsScore;
                            const age = parseInt(telestrokeNote.age, 10) || 0;
                            const contraindications = detectContraindications({ telestrokeNote });
                            const criticalContraindications = contraindications.filter(c => c.severity === 'critical');

                            // Determine TNK recommendation
                            let tnkRec = { eligible: false, reason: '', confidence: 'low' };
                            let evtRec = { eligible: false, reason: '', confidence: 'low' };

                            // TNK Logic
                            if (criticalContraindications.length > 0) {
                              tnkRec = { eligible: false, reason: 'Absolute contraindication(s) present', confidence: 'high' };
                            } else if (!hoursFromLKW) {
                              tnkRec = { eligible: false, reason: 'Set LKW time to evaluate', confidence: 'low' };
                            } else if (nihss <= 5 && !telestrokeNote.disablingDeficit) {
                              tnkRec = { eligible: false, reason: `NIHSS ${nihss} with non-disabling symptoms — IVT not recommended (Class III)`, confidence: 'medium' };
                            } else if (hoursFromLKW < 4.5) {
                              if (nihss >= 4 || telestrokeNote.nihssDetails || telestrokeNote.disablingDeficit) {
                                tnkRec = { eligible: true, reason: `Within 4.5h window, NIHSS ${nihss}`, confidence: 'high' };
                              }
                            } else if (hoursFromLKW > 4.5 && hoursFromLKW <= 9) {
                              tnkRec = { eligible: true, reason: `Extended window (${hoursFromLKW.toFixed(1)}h) — consider IVT if CTP/MR perfusion mismatch or DWI/FLAIR mismatch`, confidence: 'medium' };
                            } else if (hoursFromLKW > 9 && hoursFromLKW <= 24) {
                              tnkRec = { eligible: false, reason: 'Outside recommended IVT window (9-24h) — consider clinical trial (TIMELESS/SISTER)', confidence: 'medium' };
                            } else if (hoursFromLKW > 24) {
                              tnkRec = { eligible: false, reason: 'Outside all IVT windows (>24h)', confidence: 'high' };
                            }

                            // EVT Logic
                            if (!hoursFromLKW) {
                              evtRec = { eligible: false, reason: 'Set LKW time to evaluate', confidence: 'low' };
                            } else if (nihss >= 6 && hoursFromLKW <= 24) {
                              if (hoursFromLKW <= 6) {
                                if (aspects >= 6) {
                                  evtRec = { eligible: true, reason: `Early window, NIHSS ${nihss}, ASPECTS ${aspects}`, confidence: 'high' };
                                } else if (aspects >= 0 && aspects <= 5) {
                                  evtRec = { eligible: true, reason: `Early window large core (SVIN 2025): ASPECTS ${aspects}`, confidence: 'medium' };
                                }
                              } else if (hoursFromLKW > 6 && hoursFromLKW <= 24) {
                                if (aspects >= 6) {
                                  evtRec = { eligible: true, reason: `Late window eligible (DAWN/DEFUSE criteria likely met)`, confidence: 'medium' };
                                } else if (aspects >= 3 && aspects <= 5) {
                                  evtRec = { eligible: true, reason: `Late window large core (SVIN 2025): ASPECTS ${aspects}`, confidence: 'medium' };
                                } else if (aspects <= 2) {
                                  evtRec = { eligible: false, reason: `ASPECTS ${aspects} - late window benefit uncertain (SVIN IIb)`, confidence: 'medium' };
                                }
                              }
                            } else if (nihss < 6) {
                              evtRec = { eligible: false, reason: `NIHSS ${nihss} - consider if LVO present (STEP trial)`, confidence: 'medium' };
                            } else if (hoursFromLKW > 24) {
                              evtRec = { eligible: false, reason: 'Outside EVT window (>24h)', confidence: 'high' };
                            }

                            // Only show if we have some data to work with
                            if (!age && !nihss && !hoursFromLKW) return null;

                            return (
                              <div className="bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-xl p-4 mb-4">
                                <div className="flex items-center gap-2 mb-3">
                                  <span className="text-lg font-bold text-blue-900">Recommendation</span>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  {/* TNK Recommendation */}
                                  <div className={`p-3 rounded-lg border-2 ${
                                    tnkRec.eligible ? 'bg-emerald-100 border-emerald-400' :
                                    tnkRec.confidence === 'low' ? 'bg-slate-100 border-slate-300' :
                                    'bg-red-50 border-red-300'
                                  }`}>
                                    <div className="flex items-center justify-between mb-2">
                                      <span className="font-bold text-slate-800">TNK (Thrombolysis)</span>
                                      {tnkRec.eligible ? (
                                        <span className="px-2 py-1 bg-emerald-500 text-white text-xs font-bold rounded">CONSIDER</span>
                                      ) : tnkRec.confidence === 'low' ? (
                                        <span className="px-2 py-1 bg-slate-400 text-white text-xs font-bold rounded">PENDING</span>
                                      ) : (
                                        <span className="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded">NOT INDICATED</span>
                                      )}
                                    </div>
                                    <p className="text-sm text-slate-700">{tnkRec.reason}</p>
                                  </div>

                                  {/* EVT Recommendation */}
                                  <div className={`p-3 rounded-lg border-2 ${
                                    evtRec.eligible ? 'bg-blue-100 border-blue-400' :
                                    evtRec.confidence === 'low' ? 'bg-slate-100 border-slate-300' :
                                    'bg-red-50 border-red-300'
                                  }`}>
                                    <div className="flex items-center justify-between mb-2">
                                      <span className="font-bold text-slate-800">EVT (Thrombectomy)</span>
                                      {evtRec.eligible ? (
                                        <span className="px-2 py-1 bg-blue-500 text-white text-xs font-bold rounded">CONSIDER</span>
                                      ) : evtRec.confidence === 'low' ? (
                                        <span className="px-2 py-1 bg-slate-400 text-white text-xs font-bold rounded">PENDING</span>
                                      ) : (
                                        <span className="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded">NOT INDICATED</span>
                                      )}
                                    </div>
                                    <p className="text-sm text-slate-700">{evtRec.reason}</p>
                                  </div>
                                </div>

                                {/* Clinical Pearls — contextual evidence */}
                                {isTraineeMode && (
                                  <details className="mt-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <summary className="cursor-pointer px-3 py-2 text-xs font-semibold text-blue-800 hover:bg-blue-100 rounded-lg flex items-center gap-1.5">
                                      <i aria-hidden="true" data-lucide="lightbulb" className="w-3.5 h-3.5 text-blue-500"></i>
                                      Clinical Pearls
                                    </summary>
                                    <div className="px-3 pb-2 space-y-1.5 text-xs text-blue-800">
                                      {tnkRec.eligible && <p className="flex gap-1.5"><span className="shrink-0 text-blue-500">*</span>{CLINICAL_PEARLS.tnk}</p>}
                                      {evtRec.eligible && <p className="flex gap-1.5"><span className="shrink-0 text-blue-500">*</span>{CLINICAL_PEARLS.evt}</p>}
                                      <p className="flex gap-1.5"><span className="shrink-0 text-blue-500">*</span>{CLINICAL_PEARLS.aspects}</p>
                                    </div>
                                  </details>
                                )}

                              </div>
                            );
                          })()}

                          {/* Active Contraindication Alerts */}
                          {(() => {
                            const contraindications = detectContraindications({
                              telestrokeNote
                            });
                            if (contraindications.length === 0) return null;

                            const criticalAlerts = contraindications.filter(c => c.severity === 'critical');
                            const warningAlerts = contraindications.filter(c => c.severity === 'warning');
                            const infoAlerts = contraindications.filter(c => c.severity === 'info');

                            return (
                              <div className="mb-3 space-y-2">
                                {criticalAlerts.length > 0 && (
                                  <div className="bg-red-100 border-2 border-red-400 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-red-700 font-bold inline-flex items-center gap-1"><i aria-hidden="true" data-lucide="alert-circle" className="w-4 h-4"></i> CRITICAL CONTRAINDICATION{criticalAlerts.length > 1 ? 'S' : ''}</span>
                                    </div>
                                    <ul className="space-y-1">
                                      {criticalAlerts.map((alert, idx) => (
                                        <li key={idx} className="text-sm text-red-800 flex items-start gap-2">
                                          <span className="text-red-500">•</span>
                                          <span><strong>{alert.label}:</strong> {alert.message}</span>
                                        </li>
                                      ))}
                                    </ul>
                                  </div>
                                )}

                                {warningAlerts.length > 0 && (
                                  <div className="bg-amber-50 border-2 border-amber-400 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-amber-700 font-bold inline-flex items-center gap-1"><i aria-hidden="true" data-lucide="alert-triangle" className="w-4 h-4"></i> CAUTION{warningAlerts.length > 1 ? 'S' : ''}</span>
                                    </div>
                                    <ul className="space-y-1">
                                      {warningAlerts.map((alert, idx) => (
                                        <li key={idx} className="text-sm text-amber-800 flex items-start gap-2">
                                          <span className="text-amber-500">•</span>
                                          <span><strong>{alert.label}:</strong> {alert.message}</span>
                                        </li>
                                      ))}
                                    </ul>
                                  </div>
                                )}

                                {infoAlerts.length > 0 && (
                                  <div className="bg-blue-50 border border-blue-300 rounded-lg p-2">
                                    <ul className="space-y-1">
                                      {infoAlerts.map((alert, idx) => (
                                        <li key={idx} className="text-sm text-blue-800 flex items-start gap-2">
                                          <i aria-hidden="true" data-lucide="info" className="w-4 h-4 text-blue-500"></i>
                                          <span>{alert.message}</span>
                                        </li>
                                      ))}
                                    </ul>
                                  </div>
                                )}
                              </div>
                            );
                          })()}

                          <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                            <div className="flex items-center justify-between mb-2">
                              <h4 className="text-sm font-semibold text-slate-700">Decision Log</h4>
                              <button
                                type="button"
                                onClick={async () => {
                                  const label = await showConfirm({
                                    title: 'Add Decision Timestamp',
                                    input: true,
                                    inputLabel: 'Decision label',
                                    placeholder: 'e.g., TNK held, transfer declined',
                                    confirmLabel: 'Add'
                                  });
                                  if (!label) return;
                                  addDecisionLogEntry(String(label).trim());
                                }}
                                className="text-xs font-semibold text-blue-700 hover:text-blue-900"
                              >
                                Add timestamp
                              </button>
                            </div>
                            {(telestrokeNote.decisionLog || []).length > 0 ? (
                              <ul className="space-y-1 text-xs text-slate-700">
                                {telestrokeNote.decisionLog.slice(0, 6).map((entry) => (
                                  <li key={entry.id} className="flex items-center justify-between">
                                    <span className="font-medium">{entry.label}{entry.detail ? ` — ${entry.detail}` : ''}</span>
                                    <span className="text-slate-500">{entry.time}</span>
                                  </li>
                                ))}
                              </ul>
                            ) : (
                              <p className="text-xs text-slate-500">No decisions logged yet.</p>
                            )}
                          </div>

                          <div className="space-y-3">
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-2">Diagnosis</label>

                              {/* Diagnosis Category Selector */}
                              <div className="flex flex-wrap gap-2 mb-2">
                                {[
                                  { value: 'ischemic', label: 'Ischemic Stroke or TIA', color: 'blue', icon: 'activity' },
                                  { value: 'ich', label: 'Intracranial Hemorrhage', color: 'red', icon: 'alert-triangle' },
                                  { value: 'sah', label: 'SAH', color: 'purple', icon: 'zap' },
                                  { value: 'cvt', label: 'CVT', color: 'indigo', icon: 'git-branch' },
                                  { value: 'mimic', label: 'Stroke Mimic/Other', color: 'amber', icon: 'eye-off' }
                                ].map(option => {
                                  const isSelected = telestrokeNote.diagnosisCategory === option.value;
                                  const colorMap2 = {
                                    blue: 'bg-blue-500 text-white border-blue-500',
                                    red: 'bg-red-500 text-white border-red-500',
                                    purple: 'bg-purple-500 text-white border-purple-500',
                                    indigo: 'bg-indigo-500 text-white border-indigo-500',
                                    amber: 'bg-amber-500 text-white border-amber-500'
                                  };
                                  return (
                                    <button
                                      key={option.value}
                                      type="button"
                                      onClick={() => {
                                        const newCategory = option.value;
                                        let newDiagnosis = '';
                                        if (newCategory === 'ischemic') {
                                          newDiagnosis = 'Suspected acute ischemic stroke';
                                        } else if (newCategory === 'ich') {
                                          newDiagnosis = 'Intracerebral hemorrhage (ICH)';
                                        } else if (newCategory === 'sah') {
                                          newDiagnosis = 'Subarachnoid hemorrhage (SAH)';
                                        } else if (newCategory === 'cvt') {
                                          newDiagnosis = 'Cerebral venous thrombosis (CVT)';
                                        } else if (newCategory === 'mimic') {
                                          newDiagnosis = 'Stroke mimic';
                                        }
                                        setTelestrokeNote(prev => {
                                          const updated = {
                                            ...prev,
                                            diagnosisCategory: newCategory,
                                            diagnosis: newDiagnosis
                                          };
                                          // Clear stale treatment flags when diagnosis category changes
                                          if (newCategory !== prev.diagnosisCategory) {
                                            if (newCategory !== 'ischemic') {
                                              updated.tnkRecommended = false;
                                              updated.evtRecommended = false;
                                            }
                                            if (newCategory !== 'ich') {
                                              updated.ichReversalInitiated = false;
                                              updated.ichBPManaged = false;
                                              updated.ichNeurosurgeryConsulted = false;
                                              updated.ichSeizureProphylaxis = false;
                                              updated.ichSurgicalCriteria = { cerebellarGt15mL: false, hydrocephalus: false, midlineShift: false, clinicalDeterioration: false, surgeryDiscussed: false, surgeryDecision: '' };
                                            }
                                            if (newCategory !== 'sah') {
                                              updated.sahGrade = '';
                                              updated.sahGradeScale = '';
                                              updated.sahBPManaged = false;
                                              updated.sahNimodipine = false;
                                              updated.sahEVDPlaced = false;
                                              updated.sahAneurysmSecured = false;
                                              updated.sahNeurosurgeryConsulted = false;
                                              updated.sahSeizureProphylaxis = false;
                                              updated.fisherGrade = '';
                                              updated.sahAneurysmLocation = '';
                                              updated.sahAneurysmSize = '';
                                              updated.sahSecuringMethod = '';
                                              updated.sahVasospasmMonitoring = { tcdOrdered: false, neuroChecksQ1h: false, sodiumMonitoring: false, dciSuspected: false, inducedHypertension: false, notes: '' };
                                            }
                                            if (newCategory !== 'cvt') {
                                              updated.cvtAnticoagStarted = false;
                                              updated.cvtAnticoagType = '';
                                              updated.cvtIcpManaged = false;
                                              updated.cvtSeizureManaged = false;
                                              updated.cvtHematologyConsulted = false;
                                            }
                                          }
                                          return updated;
                                        });
                                      }}
                                      className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all border-2 ${
                                        isSelected
                                          ? (colorMap2[option.color] || 'bg-slate-500 text-white border-slate-500')
                                          : 'bg-white text-slate-700 border-slate-300 hover:border-slate-400'
                                      }`}
                                    >
                                      <i aria-hidden="true" data-lucide={option.icon} className="w-4 h-4"></i>
                                      {option.label}
                                    </button>
                                  );
                                })}
                              </div>

                              {/* Free text for Other or additional details */}
                              {telestrokeNote.diagnosisCategory === 'other' && (
                                <input
                                  type="text"
                                  value={telestrokeNote.diagnosis}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, diagnosis: v})); }}
                                  placeholder="Specify diagnosis..."
                                  className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              )}

                              {/* Show selected diagnosis */}
                              {telestrokeNote.diagnosisCategory && telestrokeNote.diagnosisCategory !== 'other' && (
                                <div className={`px-3 py-2 rounded-lg text-sm ${
                                  telestrokeNote.diagnosisCategory === 'ischemic' ? 'bg-blue-50 text-blue-800 border border-blue-200' :
                                  telestrokeNote.diagnosisCategory === 'ich' ? 'bg-red-50 text-red-800 border border-red-200' :
                                  telestrokeNote.diagnosisCategory === 'mimic' ? 'bg-amber-50 text-amber-800 border border-amber-200' :
                                  'bg-slate-50 text-slate-800 border border-slate-200'
                                }`}>
                                  <strong>Dx:</strong> {telestrokeNote.diagnosis}
                                </div>
                              )}

                              {/* Discordance Flags */}
                              {(() => {
                                const flags = [];
                                const nihss = parseInt(telestrokeNote.nihss, 10) || nihssScore || 0;
                                const hasLVO = (telestrokeNote.vesselOcclusion || []).some(v =>
                                  /ICA|M1|basilar/i.test(v)
                                );
                                const dx = (telestrokeNote.diagnosis || '').toLowerCase();
                                const isTIA = dx.includes('tia') || dx.includes('transient');
                                const timeFrom = calculateTimeFromLKW();

                                if (nihss === 0 && hasLVO) {
                                  flags.push({ key: 'nihss-lvo', color: 'red', text: 'NIHSS 0 with LVO — confirm occlusion status or consider rapidly improving symptoms' });
                                }
                                if (nihss >= 4 && isTIA) {
                                  flags.push({ key: 'nihss-tia', color: 'amber', text: `NIHSS ${nihss} with TIA diagnosis — consider reclassifying as acute ischemic stroke if deficits persist` });
                                }
                                if (timeFrom && timeFrom.total > 24 && telestrokeNote.wakeUpStrokeWorkflow && telestrokeNote.wakeUpStrokeWorkflow?.mriAvailable !== undefined) {
                                  flags.push({ key: 'lkw-wakeup', color: 'amber', text: 'LKW >24h with wake-up stroke evaluation — verify onset window estimate for treatment eligibility' });
                                }

                                return flags.length > 0 ? (
                                  <div className="space-y-1 mt-2">
                                    {flags.map(f => (
                                      <div key={f.key} className={`flex items-start gap-2 px-3 py-2 rounded-lg text-sm font-medium ${
                                        f.color === 'red' ? 'bg-red-50 text-red-800 border border-red-300' : 'bg-amber-50 text-amber-800 border border-amber-300'
                                      }`}>
                                        <i aria-hidden="true" data-lucide="alert-triangle" className="w-4 h-4 mt-0.5 flex-shrink-0"></i>
                                        <span>{f.text}</span>
                                      </div>
                                    ))}
                                  </div>
                                ) : null;
                              })()}

                              {/* Data Consistency Sanity Checks */}
                              {(() => {
                                const checks = getSanityChecks();
                                if (checks.length === 0) return null;
                                const errors = checks.filter(c => c.severity === 'error');
                                const warns = checks.filter(c => c.severity === 'warn');
                                return (
                                  <details className={`mt-2 border rounded-lg ${errors.length > 0 ? 'bg-red-50 border-red-300' : 'bg-amber-50 border-amber-300'}`} open={errors.length > 0}>
                                    <summary className={`cursor-pointer px-3 py-2 text-sm font-semibold flex items-center justify-between ${errors.length > 0 ? 'text-red-800' : 'text-amber-800'}`}>
                                      <span className="flex items-center gap-2">
                                        <i aria-hidden="true" data-lucide="shield-alert" className="w-4 h-4"></i>
                                        Data Consistency Check ({errors.length > 0 ? `${errors.length} error${errors.length > 1 ? 's' : ''}` : ''}{errors.length > 0 && warns.length > 0 ? ', ' : ''}{warns.length > 0 ? `${warns.length} warning${warns.length > 1 ? 's' : ''}` : ''})
                                      </span>
                                    </summary>
                                    <div className="px-3 pb-2 space-y-1">
                                      {checks.map(c => (
                                        <div key={c.id} className={`flex items-start gap-2 text-sm px-2 py-1 rounded ${c.severity === 'error' ? 'text-red-800 bg-red-100/60' : 'text-amber-800 bg-amber-100/60'}`}>
                                          <i aria-hidden="true" data-lucide={c.severity === 'error' ? 'x-circle' : 'alert-triangle'} className="w-3.5 h-3.5 mt-0.5 flex-shrink-0"></i>
                                          <span>{c.msg}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </details>
                                );
                              })()}

                              {/* Active Trials List - Show for Ischemic or ICH */}
                              {telestrokeNote.diagnosisCategory === 'ischemic' && (
                                <div className="mt-3 text-sm">
                                  <div className="font-medium text-slate-700 mb-1">Active Ischemic Stroke Trials:</div>
                                  <ul className="text-slate-600 space-y-0.5 ml-4">
                                    <li>• <strong>SISTER</strong> – Late thrombolysis (4.5-24h), no TNK/EVT</li>
                                    <li>• <strong>STEP-EVT</strong> – Mild LVO or medium/distal vessel occlusions</li>
                                    <li>• <strong>PICASSO</strong> – Tandem lesion (carotid + intracranial LVO)</li>
                                    <li>• <strong>TESTED</strong> – EVT in pre-existing disability (mRS 3-4)</li>
                                    <li>• <strong>VERIFY</strong> – TMS/MRI to predict motor recovery</li>
                                    <li>• <strong>DISCOVERY</strong> – Cognitive trajectories post-stroke</li>
                                    <li>• <strong>ESUS Imaging</strong> – Cardiac/vessel wall MRI for ESUS</li>
                                    <li>• <strong>MOCHA Imaging</strong> – Intracranial vessel-wall analysis for ICAD</li>
                                  </ul>
                                </div>
                              )}
                              {telestrokeNote.diagnosisCategory === 'ich' && (
                                <div className="mt-3 text-sm">
                                  <div className="font-medium text-slate-700 mb-1">Active ICH Trials:</div>
                                  <ul className="text-slate-600 space-y-0.5 ml-4">
                                    <li>• <strong>MINUTE</strong> – Intracerebral hemorrhage trial (NCT07260916)</li>
                                    <li>• <strong>SATURN</strong> – Statin continuation vs stop after lobar ICH</li>
                                    <li>• <strong>ASPIRE</strong> – Apixaban vs aspirin post-ICH with AF</li>
                                    <li>• <strong>cAPPricorn-1</strong> – Intrathecal mivelsiran for CAA</li>
                                    <li>• <strong>MIRROR Registry</strong> – Minimally invasive ICH evacuation</li>
                                    <li>• <strong>DISCOVERY</strong> – Cognitive trajectories post-ICH</li>
                                  </ul>
                                </div>
                              )}
                            </div>

                            {/* ICH Pathway Checkboxes */}
                            {telestrokeNote.diagnosisCategory === 'ich' && (
                              <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                                <h4 className="text-sm font-bold text-red-800 mb-2 uppercase tracking-wide">ICH Pathway Checklist</h4>
                                <div className="space-y-2">
                                  {[
                                    { field: 'ichBPManaged', label: 'BP managed (SBP <140 target)', detail: 'Class IIa, INTERACT2; avoid <130' },
                                    { field: 'ichReversalInitiated', label: 'Anticoag reversal ordered (if applicable)', detail: 'Skip if no anticoagulants', skipIf: !telestrokeNote.lastDOACType },
                                    { field: 'ichNeurosurgeryConsulted', label: 'Neurosurgery consulted/evaluated', detail: 'Surgical candidacy assessed' }
                                  ].filter(item => !item.skipIf).map(item => (
                                    <label key={item.field} className="flex items-start gap-2 cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={telestrokeNote[item.field] || false}
                                        onChange={(e) => { const v = e.target.checked; const f = item.field; setTelestrokeNote(prev => ({ ...prev, [f]: v })); }}
                                        className="mt-0.5 rounded border-red-300 text-red-600 focus:ring-red-500"
                                      />
                                      <div>
                                        <span className="text-sm font-medium text-red-900">{item.label}</span>
                                        <span className="text-xs text-red-600 block">{item.detail}</span>
                                      </div>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            )}

                            {/* Lytic Eligibility Criteria (Collapsible) — hidden in clinic */}
                            {(
                            <details className="bg-emerald-50 border border-emerald-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-emerald-800 hover:bg-emerald-100 rounded-lg">
                                TNK Eligibility Criteria (Click to expand)
                              </summary>
                              <div className="p-4 space-y-3 text-sm">
                                <div>
                                  <h4 className="font-semibold text-emerald-700 mb-2">Standard Window (&le;4.5h) — TNK 0.25 mg/kg IV bolus (max 25 mg):</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Diagnosis of ischemic stroke causing measurable neurologic deficit</li>
                                    <li>• Age ≥18 years</li>
                                    <li>• Onset of symptoms &lt;4.5 hours from LKW</li>
                                    <li>• Do NOT delay IVT for CTA/CTP or labs unless specific clinical concern exists</li>
                                    <li>• Class I, LOE A (AHA/ASA 2026)</li>
                                  </ul>
                                  <div className="mt-3 bg-amber-50 border border-amber-200 rounded-lg p-2 text-xs text-amber-800">
                                    IVT is <strong>not recommended</strong> for mild <em>non-disabling</em> symptoms (NIHSS 0-5). Treat if deficits are disabling (aphasia, hemianopsia, severe weakness).
                                  </div>
                                  <label className="mt-2 flex items-center gap-2 text-xs font-semibold text-amber-800 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={telestrokeNote.disablingDeficit}
                                      onChange={(e) => { const v = e.target.checked; setTelestrokeNote(prev => ({ ...prev, disablingDeficit: v })); }}
                                      className="w-4 h-4 rounded border-amber-400 text-amber-600 focus:ring-amber-500"
                                    />
                                    Deficit is disabling (override for NIHSS 0-5)
                                  </label>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-blue-700 mb-2">Extended Window (4.5-9h or wake-up) — mismatch imaging:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• IVT (TNK or alteplase) may be considered in 4.5-9h or wake-up stroke with mismatch imaging</li>
                                    <li>• Acceptable imaging: CT perfusion, MR perfusion, or DWI/FLAIR mismatch</li>
                                    <li>• Ischemic core &lt;70 mL with mismatch ratio &gt;1.2 (EXTEND-type criteria)</li>
                                    <li>• No hemorrhage on imaging</li>
                                    <li>• Class IIa, LOE B-R (EXTEND, WAKE-UP)</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-blue-700 mb-2">WAKE-UP Stroke:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• LKW unclear + NO LVO</li>
                                    <li>• MRI with DWI-FLAIR mismatch (DWI+, FLAIR-)</li>
                                    <li>• TNK 0.25 mg/kg IV bolus (max 25 mg)</li>
                                    <li>• Discuss lower certainty of benefit and hemorrhage risk</li>
                                  </ul>
                                </div>
                              </div>
                            </details>
                            )}

                            {/* ========== TNK CONTRAINDICATIONS (hidden in clinic) ========== */}
                            {(() => {
                              const checklist = telestrokeNote.tnkContraindicationChecklist || {};

                                const absoluteContraindications = [
                                  // Imaging Exclusions
                                  { id: 'currentICH', label: 'CT with evidence of hemorrhage', note: null },
                                  { id: 'largeInfarct', label: 'Ischemic injury >1/3 of MCA territory', note: null },
                                  { id: 'intracranialTumor', label: 'Intra-axial intracranial tumor', note: 'extra-axial not absolute' },
                                  { id: 'aorticDissection', label: 'Aortic arch dissection', note: null },
                                  // Clinical Exclusions
                                  { id: 'activeInternalBleeding', label: 'Active internal bleeding', note: null },
                                  { id: 'giMalignancy', label: 'GI malignancy', note: null },
                                  { id: 'sahPresentation', label: 'Clinical presentation suggestive of SAH', note: 'even if CT normal' },
                                  { id: 'infectiveEndocarditis', label: 'Presentation consistent with infective endocarditis', note: null },
                                  // Lab/Vital Exclusions
                                  { id: 'severeUncontrolledHTN', label: 'SBP >185 or DBP >110 mmHg', note: 'unresponsive to treatment' },
                                  { id: 'lowPlatelets', label: 'Platelet count <100,000', note: null },
                                  { id: 'warfarinElevatedINR', label: 'Warfarin use with PT >15s, INR >1.7, or aPTT >40s', note: null },
                                  { id: 'recentHeparin', label: 'Treatment-dose heparin/LMWH', note: '<24 hours' },
                                  { id: 'unrupturedAneurysm10mm', label: 'Unruptured unsecured intracranial aneurysm >10mm', note: 'per local protocol' }
                                ];

                                const relativeContraindications = [
                                  // Cautionary - Consider risks/benefits
                                  { id: 'priorICH', label: 'Prior known non-traumatic intracranial hemorrhage', note: null },
                                  { id: 'vascularMalformation', label: 'Intracranial vascular malformation', note: 'unless severe neuro sx' },
                                  { id: 'intracranialAneurysm', label: 'Intracranial aneurysm (<10mm or secured)', note: 'cautionary; >10mm unsecured is absolute exclusion above' },
                                  { id: 'knownBleedingDiathesis', label: 'Known bleeding diathesis', note: null },
                                  { id: 'pregnancy', label: 'Pregnancy', note: 'consult OB/GYN ASAP' },
                                  { id: 'recentStroke', label: 'Recent ischemic stroke', note: '<3 months (relative)' },
                                  { id: 'recentHeadTrauma', label: 'Recent severe head trauma', note: '14 days–3 months (relative)' },
                                  { id: 'recentIntracranialSurgery', label: 'Recent intracranial/intraspinal surgery', note: '14 days–3 months (relative)' },
                                  { id: 'recentMajorSurgery', label: 'Major extracranial surgery or trauma', note: '14 days–3 months (relative)' },
                                  { id: 'recentGIGUBleeding', label: 'Recent GI/urinary tract hemorrhage', note: '<21 days (relative)' },
                                  { id: 'recentMI', label: 'Acute or recent MI', note: '<3 months, depends on type' },
                                  { id: 'acutePericarditis', label: 'Acute pericarditis', note: null },
                                  { id: 'recentArterialPuncture', label: 'Recent arterial puncture at non-compressible site', note: '<7 days (relative)' },
                                  { id: 'recentLumbarPuncture', label: 'Recent lumbar puncture', note: '<7 days' },
                                  { id: 'seizureAtOnset', label: 'Seizure at onset with postictal deficits', note: 'consider stroke mimic' },
                                  { id: 'abnormalCoagUnknown', label: 'Abnormal aPTT, TT, or anti-Xa with unknown anticoagulant use', note: null },
                                  { id: 'cerebralMicrobleeds', label: 'Cerebral microbleeds >10 on prior MRI', note: 'increased ICH risk' },
                                  { id: 'lecanemab', label: 'Lecanemab or other Alzheimer medications', note: 'ARIA risk' },
                                  { id: 'extensiveHypoattenuation', label: 'Extensive clear hypoattenuation', note: 're-evaluate onset/benefit; not automatic exclusion' },
                                  { id: 'recentDOAC', label: 'Recent DOAC use', note: '<48h; consider drug level/reversal' },
                                  { id: 'lowGlucose', label: 'Blood glucose <50 mg/dL', note: 'correct and reassess deficits — auto-blocks TNK until corrected' },
                                  { id: 'highGlucose', label: 'Blood glucose >400 mg/dL', note: 'correct and reassess deficits' },
                                  { id: 'elevatedAPTT', label: 'aPTT >40 seconds', note: 'coagulopathy — confirm anticoagulant status' },
                                  { id: 'dualAntiplatelet', label: 'Dual antiplatelet therapy (DAPT)', note: 'increased hemorrhage risk with thrombolysis' },
                                  { id: 'aceInhibitor', label: 'ACE inhibitor use', note: '5x angioedema risk with TNK — prepare airway' },
                                { id: 'severeRenalFailure', label: 'Severe renal failure (Cr >3 or CrCl <25)', note: 'increased bleeding risk' }
                              ];

                              const autoDetected = {};
                              const glucoseVal = parseFloat(telestrokeNote.glucose);
                              if (!isNaN(glucoseVal) && glucoseVal < 50) autoDetected.lowGlucose = true;
                              if (!isNaN(glucoseVal) && glucoseVal > 400) autoDetected.highGlucose = true;
                              const inrVal = parseFloat(telestrokeNote.inr);
                              if (!isNaN(inrVal) && inrVal > 1.7) autoDetected.warfarinElevatedINR = true;
                              const pttVal = parseFloat(telestrokeNote.ptt);
                              if (!isNaN(pttVal) && pttVal > 40) autoDetected.elevatedAPTT = true;
                              const plateletsVal = parseFloat(telestrokeNote.plateletCount);
                              if (!isNaN(plateletsVal) && plateletsVal < 100) autoDetected.lowPlatelets = true;
                              const bpVal = telestrokeNote.presentingBP || '';
                              const bpMatchVal = bpVal.match(/(\d+)\s*\/\s*(\d+)/);
                              if (bpMatchVal && (parseInt(bpMatchVal[1], 10) > 185 || parseInt(bpMatchVal[2], 10) > 110)) autoDetected.severeUncontrolledHTN = true;
                              // DOAC detection
                              if (telestrokeNote.lastDOACType && telestrokeNote.lastDOACType !== '' && telestrokeNote.lastDOACType !== 'none' && telestrokeNote.lastDOACType !== 'warfarin' && telestrokeNote.lastDOACType !== 'heparin') {
                                if (telestrokeNote.lastDOACDose) {
                                  const doacDoseDate = new Date(telestrokeNote.lastDOACDose);
                                  const hoursSinceDOAC = Number.isNaN(doacDoseDate.getTime()) ? NaN : (new Date() - doacDoseDate) / (1000 * 60 * 60);
                                  if (!isNaN(hoursSinceDOAC) && hoursSinceDOAC < 48) autoDetected.recentDOAC = true;
                                  else if (isNaN(hoursSinceDOAC)) autoDetected.recentDOAC = true; // assume recent if date unparseable
                                } else { autoDetected.recentDOAC = true; }
                              }
                              // Heparin detection
                              if (telestrokeNote.lastDOACType === 'heparin') {
                                if (telestrokeNote.lastDOACDose) {
                                  const hepDoseDate = new Date(telestrokeNote.lastDOACDose);
                                  const hoursSinceHeparin = Number.isNaN(hepDoseDate.getTime()) ? NaN : (new Date() - hepDoseDate) / (1000 * 60 * 60);
                                  if (!isNaN(hoursSinceHeparin) && hoursSinceHeparin < 24) autoDetected.recentHeparin = true;
                                  else if (isNaN(hoursSinceHeparin)) autoDetected.recentHeparin = true; // assume recent if date unparseable
                                } else { autoDetected.recentHeparin = true; }
                              }
                              // Warfarin with elevated INR
                              if (telestrokeNote.lastDOACType === 'warfarin' && !isNaN(inrVal) && inrVal > 1.7) {
                                autoDetected.warfarinElevatedINR = true;
                              }
                              // Creatinine / severe renal failure
                              const crVal = parseFloat(telestrokeNote.creatinine);
                              const patCrCl = calculateCrCl(telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.height);
                              if ((!isNaN(crVal) && crVal > 3) || (patCrCl && patCrCl.value < 25)) {
                                autoDetected.severeRenalFailure = true;
                              }
                              // Pregnancy from pregnancy stroke flag
                              if (telestrokeNote.pregnancyStroke) {
                                autoDetected.pregnancy = true;
                              }
                              // Infective endocarditis — absolute TNK contraindication
                              if (telestrokeNote.infectiveEndocarditis) {
                                autoDetected.infectiveEndocarditis = true;
                              }
                              // Medication text scan for anticoagulants
                              const medsText = (telestrokeNote.medications || '').toLowerCase();
                              if (/warfarin|coumadin|jantoven/.test(medsText) && !isNaN(inrVal) && inrVal > 1.7) {
                                autoDetected.warfarinElevatedINR = true;
                              }
                              if (/apixaban|eliquis|rivaroxaban|xarelto|dabigatran|pradaxa|edoxaban|savaysa/.test(medsText)) {
                                autoDetected.recentDOAC = true;
                              }
                              if (/enoxaparin|lovenox|heparin/.test(medsText)) {
                                autoDetected.recentHeparin = true;
                              }
                              // ACE inhibitor angioedema risk
                              if (/lisinopril|enalapril|ramipril|captopril|benazepril|fosinopril|quinapril|perindopril|trandolapril|moexipril/.test(medsText)) {
                                autoDetected.aceInhibitor = true;
                              }
                              // Dual antiplatelet therapy
                              const daptAgents = [];
                              if (/aspirin|asa\b|ecotrin/.test(medsText)) daptAgents.push('aspirin');
                              if (/clopidogrel|plavix/.test(medsText)) daptAgents.push('clopidogrel');
                              if (/ticagrelor|brilinta/.test(medsText)) daptAgents.push('ticagrelor');
                              if (/prasugrel|effient/.test(medsText)) daptAgents.push('prasugrel');
                              if (daptAgents.length >= 2) {
                                autoDetected.dualAntiplatelet = true;
                              }

                              const absoluteChecked = absoluteContraindications.filter(c => checklist[c.id] || autoDetected[c.id]);
                              const relativeChecked = relativeContraindications.filter(c => checklist[c.id] || autoDetected[c.id]);

                              let badgeColor, badgeText, badgeIcon;
                              if (absoluteChecked.length > 0) { badgeColor = 'bg-red-500 text-white'; badgeText = 'Absolute CI (' + absoluteChecked.length + ')'; badgeIcon = 'X'; }
                              else if (relativeChecked.length > 0) { badgeColor = 'bg-amber-500 text-white'; badgeText = relativeChecked.length + ' relative'; badgeIcon = '!'; }
                              else if (telestrokeNote.tnkContraindicationReviewed) { badgeColor = 'bg-emerald-500 text-white'; badgeText = 'No contraindications'; badgeIcon = 'check'; }
                              else { badgeColor = 'bg-slate-400 text-white'; badgeText = 'Not reviewed'; badgeIcon = '?'; }

                              const updateChecklistItem = (id, value) => setTelestrokeNote(prev => ({...prev, tnkContraindicationChecklist: {...(prev.tnkContraindicationChecklist || {}), [id]: value}}));

                              const clearAllAndProceed = () => {
                                // Block if auto-detected absolute contraindications exist (including IE, ICH/SAH, etc.)
                                if (autoAbsolute.length > 0) {
                                  addToast('Cannot proceed — absolute contraindication(s) detected. TNK is contraindicated.', 'error');
                                  return;
                                }
                                // Use functional updater to check current tnkAutoBlocked (avoids stale closure)
                                setTelestrokeNote(prev => {
                                  if (prev.tnkAutoBlocked) {
                                    setTimeout(() => addToast('Cannot proceed — absolute contraindication(s) detected. TNK is contraindicated.', 'error'), 0);
                                    return prev;
                                  }
                                  return {...prev, tnkContraindicationReviewed: true, tnkContraindicationReviewTime: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), tnkRecommended: true};
                                });
                              };

                              // Auto-detected items for prominent banner
                              const autoDetectedItems = Object.keys(autoDetected);
                              const autoAbsolute = absoluteContraindications.filter(c => autoDetected[c.id]);
                              const autoRelative = relativeContraindications.filter(c => autoDetected[c.id]);

                              return (
                                <>
                                {autoAbsolute.length > 0 && (
                                  <div className="bg-red-100 border-2 border-red-400 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-1">
                                      <span className="bg-red-600 text-white px-2 py-0.5 rounded text-xs font-bold">AUTO-DETECTED</span>
                                      <span className="text-sm font-bold text-red-900">TNK Contraindication{autoAbsolute.length > 1 ? 's' : ''} Found From Patient Data</span>
                                    </div>
                                    <ul className="text-xs text-red-800 space-y-0.5 ml-2">
                                      {autoAbsolute.map(c => <li key={c.id}>&#10007; <strong>{c.label}</strong>{c.note ? ` (${c.note})` : ''}</li>)}
                                    </ul>
                                  </div>
                                )}
                                {autoAbsolute.length === 0 && autoRelative.length > 0 && (
                                  <div className="bg-amber-100 border-2 border-amber-400 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-1">
                                      <span className="bg-amber-500 text-white px-2 py-0.5 rounded text-xs font-bold">AUTO-DETECTED</span>
                                      <span className="text-sm font-bold text-amber-900">{autoRelative.length} Relative Contraindication{autoRelative.length > 1 ? 's' : ''} — Use Clinical Judgment</span>
                                    </div>
                                    <ul className="text-xs text-amber-800 space-y-0.5 ml-2">
                                      {autoRelative.map(c => <li key={c.id}>&#9888; {c.label}{c.note ? ` (${c.note})` : ''}</li>)}
                                    </ul>
                                  </div>
                                )}
                                <details id="tnk-contraindications" className="bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-xl">
                                  <summary className="cursor-pointer p-3 font-semibold text-orange-900 hover:bg-orange-100 rounded-lg flex items-center justify-between">
                                    <span>TNK Contraindications</span>
                                    <span className={'px-3 py-1 rounded-full text-xs font-bold ' + badgeColor}>
                                      {badgeIcon === 'check' && <span>&#10003; </span>}
                                      {badgeIcon === '!' && <span>&#9888; </span>}
                                      {badgeIcon === 'X' && <span>&#10007; </span>}
                                      {badgeText}
                                    </span>
                                  </summary>
                                  <div className="p-4 space-y-4">
                                    {absoluteChecked.length > 0 && (
                                      <div className="bg-red-50 border border-red-300 rounded-lg p-3 text-sm text-red-800">
                                        <strong>Absolute contraindications detected.</strong> TNK should not be given unless these are ruled out or overridden.
                                      </div>
                                    )}
                                    {telestrokeNote.tnkRecommended && absoluteChecked.length > 0 && (
                                      <div className="bg-red-100 border border-red-300 rounded-lg p-3 text-sm text-red-800">
                                        <strong>Warning:</strong> TNK is marked recommended while absolute contraindications are present.
                                      </div>
                                    )}
                                    <div className="flex flex-wrap items-center justify-between gap-2 bg-white border border-orange-200 rounded-lg px-3 py-2">
                                      <div className="text-sm text-orange-800">
                                        <strong>Review status:</strong>{' '}
                                        {telestrokeNote.tnkContraindicationReviewed
                                          ? `Reviewed at ${telestrokeNote.tnkContraindicationReviewTime || '—'}`
                                          : 'Not reviewed'}
                                      </div>
                                      <button
                                        type="button"
                                        onClick={() => setTelestrokeNote(prev => ({
                                          ...prev,
                                          tnkContraindicationReviewed: true,
                                          tnkContraindicationReviewTime: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                                        }))}
                                        className="px-3 py-1.5 bg-orange-600 text-white rounded-lg text-xs font-semibold hover:bg-orange-700"
                                      >
                                        Mark Reviewed
                                      </button>
                                    </div>
                                    <div className="bg-red-100 border border-red-300 rounded-lg p-3">
                                      <h4 className="font-bold text-red-800 mb-3 flex items-center gap-2">
                                        <span className="bg-red-600 text-white px-2 py-0.5 rounded text-xs">ABSOLUTE</span>
                                        Contraindications - TNK is contraindicated if ANY checked
                                      </h4>
                                      <div className="space-y-2">
                                        {absoluteContraindications.map(item => {
                                          const isAutoDetected = autoDetected[item.id];
                                          const isChecked = checklist[item.id] || isAutoDetected;
                                          return (
                                            <label key={item.id} className={'flex items-start gap-2 p-2 rounded cursor-pointer transition ' + (isChecked ? 'bg-red-200' : 'hover:bg-red-50')}>
                                              <input type="checkbox" checked={isChecked} onChange={(e) => updateChecklistItem(item.id, e.target.checked)} className="w-4 h-4 mt-0.5 accent-red-600" />
                                              <div className="flex-1">
                                                <span className={'text-sm ' + (isChecked ? 'text-red-900 font-semibold' : 'text-slate-800')}>{item.label}</span>
                                                {item.note && <span className="text-xs text-red-600 ml-1">({item.note})</span>}
                                                {isAutoDetected && <span className="ml-2 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded">Auto-detected</span>}
                                              </div>
                                            </label>
                                          );
                                        })}
                                      </div>
                                    </div>
                                    <div className="bg-amber-50 border border-amber-300 rounded-lg p-3">
                                      <h4 className="font-bold text-amber-800 mb-3 flex items-center gap-2">
                                        <span className="bg-amber-500 text-white px-2 py-0.5 rounded text-xs">RELATIVE</span>
                                        Contraindications - Use clinical judgment
                                      </h4>
                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        {relativeContraindications.map(item => {
                                          const isAutoDetected = autoDetected[item.id];
                                          const isChecked = checklist[item.id] || isAutoDetected;
                                          return (
                                            <label key={item.id} className={'flex items-start gap-2 p-2 rounded cursor-pointer transition ' + (isChecked ? 'bg-amber-200' : 'hover:bg-amber-100')}>
                                              <input type="checkbox" checked={isChecked} onChange={(e) => updateChecklistItem(item.id, e.target.checked)} className="w-4 h-4 mt-0.5 accent-amber-600" />
                                              <div className="flex-1">
                                                <span className={'text-sm ' + (isChecked ? 'text-amber-900 font-semibold' : 'text-slate-800')}>{item.label}</span>
                                                {item.note && <span className="text-xs text-amber-600 block">({item.note})</span>}
                                                {isAutoDetected && <span className="ml-2 text-xs bg-amber-500 text-white px-1.5 py-0.5 rounded">Auto-detected</span>}
                                              </div>
                                            </label>
                                          );
                                        })}
                                      </div>
                                    </div>
                                    <div className="flex items-center justify-between pt-2 border-t border-orange-200">
                                      <div className="text-sm text-slate-600">
                                        {telestrokeNote.tnkContraindicationReviewed && <span className="text-emerald-700">Reviewed at {telestrokeNote.tnkContraindicationReviewTime}</span>}
                                      </div>
                                      <div className="flex gap-2">
                                        {absoluteChecked.length === 0 && (
                                          <button onClick={clearAllAndProceed} className="px-4 py-2 bg-emerald-600 text-white rounded-lg font-semibold hover:bg-emerald-700 transition flex items-center gap-2">
                                            <span>&#10003;</span> All reviewed - Proceed with TNK
                                          </button>
                                        )}
                                        {absoluteChecked.length > 0 && (
                                          <div className="px-4 py-2 bg-red-100 text-red-800 rounded-lg font-semibold border border-red-300">
                                            &#10007; TNK Contraindicated - {absoluteChecked.length} absolute CI{absoluteChecked.length > 1 ? 's' : ''}
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                  </div>
                                </details>
                                </>
                              );
                            })()}

                            <label className="flex items-center gap-2 text-sm font-medium text-slate-700">
                              <input
                                type="checkbox"
                                checked={telestrokeNote.tnkRecommended}
                                onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, tnkRecommended: c})); }}
                                className="w-4 h-4"
                              />
                              TNK Recommended
                            </label>

                            {telestrokeNote.tnkRecommended && (
                              <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 space-y-3">
                                {/* TNK Dosing Calculator */}
                                <div className="bg-white border border-emerald-300 rounded-lg p-3 space-y-2">
                                  <div className="flex items-center justify-between">
                                    <span className="text-sm font-semibold text-emerald-800 inline-flex items-center gap-1"><i aria-hidden="true" data-lucide="syringe" className="w-3.5 h-3.5"></i> TNK Dosing Calculator</span>
                                    <span className="text-xs text-slate-500">0.25 mg/kg, max 25 mg</span>
                                  </div>

                                  <div className="flex items-center gap-3">
                                    <label className="text-sm text-slate-700">Weight:</label>
                                    <input
                                      type="number"
                                      value={telestrokeNote.weight}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, weight: v})); }}
                                      placeholder="kg"
                                      className="w-20 px-2 py-1 border border-slate-300 rounded text-sm"
                                      min="0"
                                      step="0.1"
                                    />
                                    <span className="text-xs text-slate-500">kg</span>
                                  </div>

                                  {(() => {
                                    const doseCalc = calculateTNKDose(telestrokeNote.weight);
                                    if (!doseCalc) {
                                      return (
                                        <div className="text-sm text-amber-600 bg-amber-50 px-3 py-2 rounded-lg border border-amber-200">
                                          <i aria-hidden="true" data-lucide="alert-triangle" className="w-3.5 h-3.5 inline"></i> Enter patient weight to calculate TNK dose
                                        </div>
                                      );
                                    }
                                    // Calculate volume: TNK is 50mg/10mL = 5mg/mL, so volume = dose/5
                                    const volumeMl = (parseFloat(doseCalc.calculatedDose) / 5).toFixed(1);
                                    return (
                                      <div className={`rounded-xl shadow-lg overflow-hidden ${doseCalc.isMaxDose ? 'ring-2 ring-amber-400' : 'ring-2 ring-green-400'}`}>
                                        {/* Header */}
                                        <div className={`px-4 py-2 ${doseCalc.isMaxDose ? 'bg-gradient-to-r from-amber-500 to-amber-600' : 'bg-gradient-to-r from-green-500 to-emerald-600'}`}>
                                          <div className="flex items-center justify-between">
                                            <span className="text-white font-bold text-lg flex items-center gap-2">
                                              <i aria-hidden="true" data-lucide="syringe" className="w-6 h-6 text-white"></i>
                                              TNK DOSING
                                            </span>
                                            {doseCalc.isMaxDose && (
                                              <span className="bg-white/20 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">
                                                MAX DOSE
                                              </span>
                                            )}
                                          </div>
                                        </div>
                                        {/* Dose Display */}
                                        <div className={`px-4 py-4 ${doseCalc.isMaxDose ? 'bg-gradient-to-br from-amber-50 to-amber-100' : 'bg-gradient-to-br from-green-50 to-emerald-100'}`}>
                                          <div className="grid grid-cols-3 gap-3 text-center">
                                            <div className={`p-3 rounded-lg ${doseCalc.isMaxDose ? 'bg-amber-200/50' : 'bg-emerald-200/50'}`}>
                                              <div className="text-3xl font-black text-slate-900">{doseCalc.calculatedDose}</div>
                                              <div className="text-sm font-medium text-slate-600">mg</div>
                                            </div>
                                            <div className={`p-3 rounded-lg ${doseCalc.isMaxDose ? 'bg-amber-200/50' : 'bg-emerald-200/50'}`}>
                                              <div className="text-3xl font-black text-slate-900">{volumeMl}</div>
                                              <div className="text-sm font-medium text-slate-600">mL</div>
                                            </div>
                                            <div className={`p-3 rounded-lg ${doseCalc.isMaxDose ? 'bg-amber-200/50' : 'bg-emerald-200/50'}`}>
                                              <div className="text-3xl font-black text-slate-900">{doseCalc.weightKg}</div>
                                              <div className="text-sm font-medium text-slate-600">kg</div>
                                            </div>
                                          </div>
                                          <div className="text-xs text-slate-500 text-center mt-2">
                                            {doseCalc.weightKg} kg × 0.25 mg/kg = {(doseCalc.weightKg * 0.25).toFixed(1)} mg
                                            {doseCalc.isMaxDose && ' → capped at 25 mg max'}
                                          </div>
                                          <div className="text-xs text-slate-500 text-center mt-1">
                                            Reconstitute: 50mg vial + 10mL sterile water = 5 mg/mL
                                          </div>
                                          {telestrokeNote.weightEstimated && (
                                            <div className="mt-2 px-3 py-2 bg-red-100 border border-red-300 rounded-lg text-center">
                                              <span className="text-sm font-bold text-red-800">
                                                <i aria-hidden="true" data-lucide="alert-triangle" className="w-4 h-4 inline mr-1"></i>
                                                WEIGHT IS ESTIMATED — Confirm actual weight before administering TNK
                                              </span>
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                    );
                                  })()}
                                </div>

                                <label className="flex items-center gap-2 text-sm font-medium text-slate-700">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.tnkConsentDiscussed}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, tnkConsentDiscussed: c})); }}
                                    className="w-4 h-4"
                                  />
                                  Risks/benefits discussed with patient and family
                                </label>
                                {telestrokeNote.tnkConsentDiscussed && (
                                  <div className="bg-white border border-purple-200 rounded-lg p-3 space-y-2">
                                    <p className="text-sm text-slate-700">
                                      We recommend a medication called Tenecteplase (TNK), which is a "clot-buster" drug. TNK reduces the risk of being disabled; people who get TNK have an improved chance of recovering without disability than people who don't get the medication. All medications have risks – the main risk is bleeding, up to 4% of people develop bleeding in the brain that leads to new symptoms. Very rarely, people have an allergic reaction. The potential benefits are thought to be higher than the potential risks and we recommend TNK is administered. Time is very important here - the sooner the treatment is started, the higher the likelihood of benefit.
                                    </p>

                                    <div className="mt-3 space-y-2">
                                      <div>
                                        <label htmlFor="input-consent-type" className="block text-xs font-medium text-slate-600 mb-1">Consent type</label>
                                        <select
                                          id="input-consent-type"
                                          value={telestrokeNote.tnkConsentType || ''}
                                          onChange={(e) => {
                                            const val = e.target.value;
                                            setTelestrokeNote(prev => ({...prev,
                                              tnkConsentType: val,
                                              patientFamilyConsent: val === 'informed' || val === 'surrogate',
                                              presumedConsent: val === 'presumed',
                                              tnkConsentTime: prev.tnkConsentTime || new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
                                            }));
                                          }}
                                          className="w-full px-2 py-1.5 border border-purple-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500"
                                        >
                                          <option value="">-- Select --</option>
                                          <option value="informed">Informed consent (patient)</option>
                                          <option value="surrogate">Surrogate/family consent</option>
                                          <option value="presumed">Presumed consent (no surrogate available)</option>
                                          <option value="declined">Patient/family declined</option>
                                        </select>
                                      </div>
                                      <div className="grid grid-cols-2 gap-2">
                                        <div>
                                          <label htmlFor="input-consent-time" className="block text-xs font-medium text-slate-600 mb-1">Consent time</label>
                                          <input id="input-consent-time" type="time" value={telestrokeNote.tnkConsentTime || ''}
                                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, tnkConsentTime: v})); }}
                                            className="w-full px-2 py-1.5 border border-purple-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500" />
                                        </div>
                                        <div>
                                          <label htmlFor="input-consent-with" className="block text-xs font-medium text-slate-600 mb-1">Discussed with</label>
                                          <input id="input-consent-with" type="text" value={telestrokeNote.tnkConsentWith || ''}
                                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, tnkConsentWith: v})); }}
                                            placeholder="Patient, wife, son..."
                                            className="w-full px-2 py-1.5 border border-purple-200 rounded-lg text-sm focus:ring-2 focus:ring-purple-500" />
                                        </div>
                                      </div>
                                      <label className="flex items-center gap-2 text-sm font-medium text-slate-700">
                                        <input
                                          type="checkbox"
                                          checked={telestrokeNote.preTNKSafetyPause}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, preTNKSafetyPause: c})); }}
                                          className="w-4 h-4"
                                        />
                                        Pre-TNK safety pause completed
                                      </label>
                                    </div>
                                  </div>
                                )}
                                <div>
                                  <label className="block text-sm font-medium text-slate-700 mb-1">TNK Administration Time</label>
                                  <input
                                    type="time"
                                    value={telestrokeNote.tnkAdminTime}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, tnkAdminTime: v})); }}
                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                              </div>
                            )}

                            {/* ========== EVT CONSENT COMMUNICATION KIT ========== */}
                            {telestrokeNote.evtRecommended && (
                              <div className="bg-orange-50 border border-orange-200 rounded-xl p-4 space-y-3">
                                <h4 className="font-bold text-orange-900 flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="message-circle" className="w-4 h-4"></i>
                                  EVT Consent Communication Kit
                                </h4>
                                <div className="bg-white border border-orange-200 rounded-lg p-3 text-sm text-slate-700 space-y-2">
                                  <p>We recommend a procedure called <strong>mechanical thrombectomy</strong> (clot retrieval). A catheter is threaded from the groin artery up to the blocked blood vessel in the brain to physically remove the clot. This has been shown in multiple clinical trials to significantly improve outcomes — roughly <strong>1 in 3-4 patients</strong> treated with thrombectomy achieve functional independence who would not have otherwise.</p>
                                  <p>The main risks include bleeding in the brain (~5-6%), vessel perforation or dissection, and complications from anesthesia. In rare cases, the clot can move to a new location. Despite these risks, the potential benefit significantly outweighs the risks when thrombectomy is indicated.</p>
                                  <p className="text-xs text-slate-500 italic">Adapted from: AHA/ASA 2026 Early Management Guidelines; MR CLEAN, ESCAPE, EXTEND-IA, SWIFT PRIME, REVASCAT trials</p>
                                </div>
                                <div className="space-y-2">
                                  <label className="flex items-center gap-2 text-sm font-medium text-slate-700">
                                    <input type="checkbox" checked={!!(telestrokeNote.consentKit || {}).evtConsentDiscussed}
                                      onChange={(e) => { const c = e.target.checked; const now = c ? new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: false}) : ''; setTelestrokeNote(prev => ({...prev, consentKit: {...(prev.consentKit || {}), evtConsentDiscussed: c, evtConsentTime: c ? now : ''}})); }}
                                      className="w-4 h-4" />
                                    EVT risks/benefits discussed with patient/family
                                  </label>
                                  <div className="flex gap-2">
                                    <select value={(telestrokeNote.consentKit || {}).evtConsentType || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, consentKit: {...(prev.consentKit || {}), evtConsentType: v}})); }}
                                      aria-label="EVT consent status"
                                      className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                      <option value="">-- Consent status --</option>
                                      <option value="informed-consent">Informed consent obtained</option>
                                      <option value="presumed">Presumed consent (patient unable, no surrogate available)</option>
                                      <option value="surrogate">Surrogate/family consent obtained</option>
                                      <option value="declined">Patient/family declined EVT</option>
                                    </select>
                                    <input type="time" value={(telestrokeNote.consentKit || {}).evtConsentTime || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, consentKit: {...(prev.consentKit || {}), evtConsentTime: v}})); }}
                                      className="w-28 px-2 py-2 border border-slate-300 rounded-lg text-sm" />
                                  </div>
                                </div>
                                <button onClick={() => {
                                  const cdLkw = telestrokeNote.lkwUnknown ? 'Unknown (wake-up/unwitnessed)' + (telestrokeNote.discoveryTime ? ` — discovery ${telestrokeNote.discoveryTime}` : '') : telestrokeNote.lkwTime ? formatTime(telestrokeNote.lkwTime) : '***';
                                  const cdAspects = aspectsScore != null ? `${aspectsScore}/10` : null;
                                  const cdCtp = telestrokeNote.ctpStructured || {};
                                  let cdCtpStr = '';
                                  if (cdCtp.coreVolume) {
                                    cdCtpStr = `Core ${cdCtp.coreVolume} mL`;
                                    if (cdCtp.penumbraVolume) cdCtpStr += `, Penumbra ${cdCtp.penumbraVolume} mL`;
                                    const cc = parseFloat(cdCtp.coreVolume), cp = parseFloat(cdCtp.penumbraVolume);
                                    if (!isNaN(cc) && !isNaN(cp) && cc > 0) cdCtpStr += `, Ratio ${(cp/cc).toFixed(1)}`;
                                  }
                                  const cdCollat = telestrokeNote.collateralGrade || null;
                                  const cdAnticoag = telestrokeNote.lastDOACType && telestrokeNote.lastDOACType !== 'none' ? `on ${ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]?.name || telestrokeNote.lastDOACType}` : null;
                                  const cdTnk = telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime ? `IV TNK administered at ${formatTime(telestrokeNote.tnkAdminTime)}` : null;
                                  const cdMrs = telestrokeNote.premorbidMRS != null ? telestrokeNote.premorbidMRS : null;
                                  let cdClinical = '';
                                  cdClinical += `\nLKW: ${cdLkw}`;
                                  if (cdAspects) cdClinical += `\nASPECTS: ${cdAspects}`;
                                  if (cdCtpStr) cdClinical += `\nCTP: ${cdCtpStr}`;
                                  if (cdCollat) cdClinical += `\nCollaterals: ${cdCollat}`;
                                  if (cdAnticoag) cdClinical += `\nAnticoagulation: ${cdAnticoag}`;
                                  if (cdTnk) cdClinical += `\n${cdTnk}`;
                                  if (cdMrs != null) cdClinical += `\nPre-morbid mRS: ${cdMrs}`;
                                  const consentDoc = `EVT CONSENT DOCUMENTATION:\nMechanical thrombectomy was recommended for ${telestrokeNote.age || '***'} ${telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '***'} patient with ${telestrokeNote.diagnosis || 'acute ischemic stroke'} (NIHSS ${telestrokeNote.nihss || nihssScore || '***'}, vessel occlusion: ${(telestrokeNote.vesselOcclusion || []).filter(v => v !== 'None').join(', ') || '***'}).${cdClinical}\nRisks discussed: intracranial hemorrhage (~5-6%), vessel injury, anesthesia complications, and the possibility that the procedure may not be successful.\nBenefits discussed: significantly improved chance of functional independence (NNT 3-4 based on pivotal trials).\nAlternatives discussed: medical management alone (associated with worse outcomes in setting of LVO).\nConsent: ${(telestrokeNote.consentKit || {}).evtConsentType === 'informed-consent' ? 'Informed consent obtained from patient/family' : (telestrokeNote.consentKit || {}).evtConsentType === 'presumed' ? 'Presumed consent — patient unable to provide consent, no surrogate available, treatment in best interest' : (telestrokeNote.consentKit || {}).evtConsentType === 'surrogate' ? 'Consent obtained from surrogate/family member' : (telestrokeNote.consentKit || {}).evtConsentType === 'declined' ? 'Patient/family declined after informed discussion' : '***'}`;
                                  copyToClipboard(consentDoc, 'evt-consent');
                                }}
                                  className={`w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 ${copiedText === 'evt-consent' ? 'bg-emerald-600 text-white' : 'bg-orange-600 text-white hover:bg-orange-700'}`}>
                                  <i aria-hidden="true" data-lucide={copiedText === 'evt-consent' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                  {copiedText === 'evt-consent' ? 'Copied!' : 'Copy EVT Consent Documentation'}
                                </button>
                              </div>
                            )}

                            {/* ========== TRANSFER CONSENT COMMUNICATION KIT ========== */}
                            {telestrokeNote.transferAccepted && (
                              <div className="bg-sky-50 border-2 border-sky-300 rounded-lg p-4 space-y-3">
                                <h4 className="font-bold text-sky-900 flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="ambulance" className="w-4 h-4"></i>
                                  Transfer Communication Kit
                                </h4>
                                <div className="bg-white border border-sky-200 rounded-lg p-3 text-sm text-slate-700 space-y-2">
                                  <p>We recommend <strong>transferring to a comprehensive stroke center</strong> for a higher level of care. This facility can provide specialized treatments — such as clot-retrieval procedures (thrombectomy), neurosurgical intervention, or neurointensive care — that are not available here.</p>
                                  <p>Transfer is time-sensitive. The sooner the patient arrives at the receiving facility, the better the chances for a good outcome. During transport, the patient will be monitored and any treatments already started will continue.</p>
                                </div>
                                <label className="flex items-center gap-2 text-sm font-medium text-slate-700">
                                  <input type="checkbox" checked={!!(telestrokeNote.consentKit || {}).transferConsentDiscussed}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, consentKit: {...(prev.consentKit || {}), transferConsentDiscussed: c}})); }}
                                    className="w-4 h-4" />
                                  Transfer rationale discussed with patient/family
                                </label>
                                <button onClick={() => {
                                  const transferDoc = `TNK CONSENT DOCUMENTATION:\nTenecteplase was recommended for ${telestrokeNote.age || '***'} ${telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '***'} patient with ${telestrokeNote.diagnosis || 'acute ischemic stroke'}.\nTreatment window: within 4.5 hours of LKW (or mismatch imaging criteria for extended window).\nRisks discussed: symptomatic intracranial hemorrhage (up to 4%), allergic reaction (rare).\nBenefits discussed: improved chance of recovery without disability; earlier treatment provides greater benefit.\nAlternatives discussed: no thrombolytic treatment (associated with higher risk of disability).\nConsent: ${telestrokeNote.patientFamilyConsent ? 'Patient/family consent obtained' : telestrokeNote.presumedConsent ? 'Presumed consent — treatment in best interest' : '***'}\n\nTRANSFER DOCUMENTATION:\nPatient being transferred to comprehensive stroke center for ${telestrokeNote.evtRecommended ? 'mechanical thrombectomy evaluation and ' : ''}higher level of care.\nTransfer rationale: ${telestrokeNote.transferRationale || '***'}\nTransfer consent: ${(telestrokeNote.consentKit || {}).transferConsentDiscussed ? 'Discussed with patient/family' : 'Pending discussion'}`;
                                  copyToClipboard(transferDoc, 'transfer-consent');
                                }}
                                  className={`w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 ${copiedText === 'transfer-consent' ? 'bg-emerald-600 text-white' : 'bg-sky-600 text-white hover:bg-sky-700'}`}>
                                  <i aria-hidden="true" data-lucide={copiedText === 'transfer-consent' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                  {copiedText === 'transfer-consent' ? 'Copied!' : 'Copy Consent + Transfer Documentation'}
                                </button>
                              </div>
                            )}

                            {/* TNK-Only Consent Doc Copy (when TNK but no EVT/transfer) */}
                            {telestrokeNote.tnkRecommended && telestrokeNote.tnkConsentDiscussed && !telestrokeNote.evtRecommended && !telestrokeNote.transferAccepted && (
                              <button onClick={() => {
                                const tnkDoc = `TNK CONSENT DOCUMENTATION:\nTenecteplase was recommended for ${telestrokeNote.age || '***'} ${telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '***'} patient with ${telestrokeNote.diagnosis || 'acute ischemic stroke'} (NIHSS ${telestrokeNote.nihss || nihssScore || '***'}).\nTreatment window: within 4.5 hours of LKW (or mismatch imaging criteria for extended window).\nRisks discussed: symptomatic intracranial hemorrhage (up to 4%), allergic reaction (rare).\nBenefits discussed: improved chance of recovery without disability; earlier treatment provides greater benefit.\nAlternatives discussed: no thrombolytic treatment (associated with higher risk of disability).\nConsent: ${telestrokeNote.patientFamilyConsent ? 'Patient/family consent obtained' : telestrokeNote.presumedConsent ? 'Presumed consent — treatment in best interest' : '***'}`;
                                copyToClipboard(tnkDoc, 'tnk-consent');
                              }}
                                className={`w-full px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 ${copiedText === 'tnk-consent' ? 'bg-emerald-600 text-white' : 'bg-purple-600 text-white hover:bg-purple-700'}`}>
                                <i aria-hidden="true" data-lucide={copiedText === 'tnk-consent' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                {copiedText === 'tnk-consent' ? 'Copied!' : 'Copy TNK Consent Documentation'}
                              </button>
                            )}

                            {/* ===== POST-THROMBOLYSIS MONITORING ===== */}
                            {telestrokeNote.tnkRecommended && telestrokeNote.tnkAdminTime && (
                              <div className="bg-rose-50 border-2 border-rose-300 rounded-xl p-4 space-y-3">
                                <h4 className="font-bold text-rose-900 flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="heart-pulse" className="w-4 h-4"></i>
                                  Post-Thrombolysis Monitoring
                                </h4>
                                <p className="text-xs text-rose-700">Monitor for complications. Neuro checks + BP q15min x 2h, then q30min x 6h, then q1h x 16h. Avoid anticoagulants/antiplatelets x 24h. Repeat CT at 24h or if clinical deterioration.</p>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                  {[
                                    { field: 'postTnkNeuroChecksStarted', label: 'Neuro checks q15m initiated' },
                                    { field: 'postTnkBpMonitoring', label: 'BP monitoring (target <180/105)' },
                                    { field: 'postTnkRepeatCTOrdered', label: 'Repeat CT Head ordered (24h or PRN)' },
                                    { field: 'postTnkAntiplateletHeld', label: 'Antiplatelets/anticoagulants held x 24h' }
                                  ].map(item => (
                                    <label key={item.field} className="flex items-center gap-2 p-2 bg-white border border-rose-200 rounded-lg cursor-pointer text-sm">
                                      <input
                                        type="checkbox"
                                        checked={telestrokeNote[item.field] || false}
                                        onChange={(e) => { const f = item.field, c = e.target.checked; setTelestrokeNote(prev => ({...prev, [f]: c})); }}
                                        className="w-4 h-4 text-rose-600"
                                      />
                                      <span className="text-rose-800">{item.label}</span>
                                    </label>
                                  ))}
                                </div>
                                <details className="bg-white border border-rose-200 rounded-lg">
                                  <summary className="cursor-pointer p-2 text-sm font-semibold text-rose-800 hover:bg-rose-50 rounded-lg">
                                    Complication Documentation
                                  </summary>
                                  <div className="p-3 space-y-2">
                                    {[
                                      { field: 'sichDetected', label: 'Symptomatic ICH (sICH)' },
                                      { field: 'angioedemaDetected', label: 'Orolingual angioedema' },
                                      { field: 'reperfusionHemorrhage', label: 'Reperfusion hemorrhage' },
                                      { field: 'clinicalDeterioration', label: 'Clinical deterioration (NIHSS increase ≥4)' }
                                    ].map(item => (
                                      <label key={item.field} className="flex items-center gap-2 text-sm">
                                        <input
                                          type="checkbox"
                                          checked={telestrokeNote[item.field] || false}
                                          onChange={(e) => { const f = item.field, c = e.target.checked; setTelestrokeNote(prev => ({...prev, [f]: c})); }}
                                          className="w-4 h-4 text-red-600"
                                        />
                                        <span className="text-slate-700">{item.label}</span>
                                      </label>
                                    ))}
                                    {(telestrokeNote.sichDetected || telestrokeNote.clinicalDeterioration) && (
                                      <textarea
                                        aria-label="Complication documentation notes"
                                        value={telestrokeNote.complicationNotes || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, complicationNotes: v})); }}
                                        placeholder="Describe complication, timing, and management taken..."
                                        rows="2"
                                        className="w-full px-3 py-2 border border-red-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500"
                                      />
                                    )}
                                  </div>
                                </details>
                              </div>
                            )}

                            {/* ===== POST-EVT MONITORING ===== */}
                            {telestrokeNote.evtRecommended && (
                              <div className="bg-orange-50 border-2 border-orange-300 rounded-xl p-4 space-y-3">
                                <h4 className="font-bold text-orange-900 flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="activity" className="w-4 h-4"></i>
                                  Post-EVT Monitoring & Orders
                                </h4>
                                <p className="text-xs text-orange-700">Post-thrombectomy monitoring checklist. BP target: SBP &lt;180/105, avoid SBP &lt;140 (Class III: Harm per BEST-II/ENCHANTED2). Neuro checks q15min x 2h, q30min x 6h, q1h thereafter.</p>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                  {[
                                    { field: 'postEvtBpConfirmed', label: 'BP target confirmed (<180, avoid <140)' },
                                    { field: 'postEvtNeuroChecks', label: 'Neuro checks q15min x 2h initiated' },
                                    { field: 'postEvtGroinCheck', label: 'Groin/access site check protocol initiated' },
                                    { field: 'postEvtImagingOrdered', label: '24h NCHCT or DECT ordered' },
                                    { field: 'postEvtAntiplateletTiming', label: 'Antiplatelet timing confirmed (24h post-TNK if given)' },
                                    { field: 'postEvtIcuBed', label: 'ICU/step-down bed arranged' }
                                  ].map(item => (
                                    <label key={item.field} className="flex items-center gap-2 p-2 bg-white border border-orange-200 rounded-lg cursor-pointer text-sm">
                                      <input
                                        type="checkbox"
                                        checked={telestrokeNote[item.field] || false}
                                        onChange={(e) => { const f = item.field, c = e.target.checked; setTelestrokeNote(prev => ({...prev, [f]: c})); }}
                                        className="w-4 h-4 text-orange-600"
                                      />
                                      <span className="text-orange-800">{item.label}</span>
                                    </label>
                                  ))}
                                </div>
                                <div className="space-y-2">
                                  <label htmlFor="input-tici-score" className="text-sm font-medium text-orange-800">tICI Score:</label>
                                  <select id="input-tici-score" value={telestrokeNote.ticiScore || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ticiScore: v})); }}
                                    className="w-full px-3 py-2 border border-orange-300 rounded-lg text-sm">
                                    <option value="">-- Select tICI grade --</option>
                                    <option value="0">0 — No perfusion</option>
                                    <option value="1">1 — Penetration, no distal filling</option>
                                    <option value="2a">2a — Partial filling (&lt;50% territory)</option>
                                    <option value="2b">2b — Partial filling (≥50% territory)</option>
                                    <option value="2c">2c — Near-complete perfusion (slow flow)</option>
                                    <option value="3">3 — Complete perfusion</option>
                                  </select>
                                </div>
                                <details className="bg-white border border-orange-200 rounded-lg">
                                  <summary className="cursor-pointer p-2 text-sm font-semibold text-orange-800 hover:bg-orange-50 rounded-lg">
                                    Post-EVT Complication Watch
                                  </summary>
                                  <div className="p-3 space-y-2 text-xs text-slate-700">
                                    <p><strong>Reperfusion hemorrhage:</strong> Any neuro decline → stat NCHCT. Hold antithrombotics until hemorrhage ruled out.</p>
                                    <p><strong>Groin complications:</strong> Check access site q15min x 2h, q30min x 4h. Watch for expanding hematoma, retroperitoneal bleed (back/flank pain, tachycardia, Hgb drop).</p>
                                    <p><strong>Contrast nephropathy:</strong> IV hydration, monitor Cr at 24-48h if baseline CKD or diabetic nephropathy.</p>
                                    <p><strong>Reocclusion:</strong> ~5-10% rate. If neuro worsening, consider repeat CTA and possible re-intervention.</p>
                                    <p><strong>DECT interpretation (if ordered):</strong> Contrast staining = hyperdense on conventional CT but absent on virtual non-contrast (VNC) reconstruction → benign BBB disruption, antithrombotics may start earlier. True hemorrhage = hyperdense on BOTH conventional and VNC → hold antithrombotics, manage as hemorrhagic transformation. Mixed pattern → treat as hemorrhage.</p>
                                  </div>
                                </details>
                              </div>
                            )}

                            {/* ===== MANAGEMENT SECTION ===== */}
                            <div id="phase-management"></div>

                            {/* EVT Eligibility (Collapsible — hidden in clinic) */}
                            {<details className="bg-blue-50 border border-blue-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg">
                                <i aria-hidden="true" data-lucide="wrench" className="w-4 h-4 inline"></i> EVT Eligibility Criteria (Click to expand)
                              </summary>
                              <div className="p-4 space-y-3 text-sm">
                                <div>
                                  <h4 className="font-semibold text-blue-700 mb-2">Basilar Artery Occlusion:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Last known well ≤24 hours</li>
                                    <li>• NIHSS score ≥10</li>
                                    <li>• pc-ASPECTS ≥6</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-emerald-700 mb-2">Anterior Circulation Large Vessel Occlusion:</h4>
                                  <p className="text-xs text-slate-600 mb-2">local protocol + SVIN 2025 large-core guidance (baseline mRS 0-1, age 18-80).</p>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                                    <div className="bg-white p-2 rounded border">
                                      <p className="font-semibold text-emerald-700 text-xs mb-1">Early Window (0-6h):</p>
                                      <ul className="space-y-1 ml-2 text-xs">
                                        <li>• <strong>ASPECTS 3-10:</strong> Generally eligible for EVT</li>
                                        <li>• <strong>ASPECTS 0-2:</strong> Consider in very select cases; consider CTP to evaluate if estimated core volume ≤70-100cc</li>
                                      </ul>
                                    </div>
                                    <div className="bg-white p-2 rounded border">
                                      <p className="font-semibold text-purple-700 text-xs mb-1">Late Window (6-24h):</p>
                                      <ul className="space-y-1 ml-2 text-xs">
                                        <li>• <strong>ASPECTS 6-10:</strong> Generally eligible for EVT</li>
                                        <li>• <strong>ASPECTS 3-5:</strong> Generally eligible; consider CTP to evaluate if estimated core volume ≤100cc + mismatch present</li>
                                        <li>• <strong>ASPECTS 0-2:</strong> EVT benefit is unclear</li>
                                      </ul>
                                    </div>
                                  </div>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-orange-700 mb-2">Medium Vessel Occlusion:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Consider in select cases of proximal or dominant M2 segment MCA occlusion within ≤1cm of bifurcation in horizontal segment when there is evidence of salvageable tissue + last known well is ≤24 hours</li>
                                    <li>• Not recommended for M2-M4 MCA, ACA, and PCA occlusions</li>
                                  </ul>
                                </div>
                              </div>
                            </details>}

                            <label className="flex items-center gap-2 text-sm font-medium text-slate-700">
                              <input
                                type="checkbox"
                                checked={telestrokeNote.evtRecommended}
                                onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, evtRecommended: c})); }}
                                className="w-4 h-4"
                              />
                              EVT Recommended
                            </label>

                            <div>
                              <div className="flex flex-wrap items-center justify-between gap-2 mb-1">
                                <label className="block text-sm font-medium text-slate-700">Rationale for Recommendation</label>
                              </div>
                              <textarea
                                value={telestrokeNote.rationale}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, rationale: v})); }}
                                placeholder=""
                                rows="3"
                                className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Guideline Recommendations Panel */}
                        {(() => {
                          const recs = getContextualRecommendations();
                          if (recs.length === 0) return null;

                          // Group by category
                          const grouped = {};
                          recs.forEach(rec => {
                            if (!grouped[rec.category]) grouped[rec.category] = [];
                            grouped[rec.category].push(rec);
                          });

                          const classColors = GUIDELINE_CLASS_COLORS;

                          return (
                            <div className="bg-white border-2 border-indigo-300 rounded-lg shadow-md">
                              <details open={guidelineRecsExpanded} onToggle={(e) => setGuidelineRecsExpanded(e.target.open)}>
                                <summary className="cursor-pointer p-4 font-semibold text-indigo-900 hover:bg-indigo-50 rounded-lg flex items-center justify-between">
                                  <span className="flex items-center gap-2">
                                    <i aria-hidden="true" data-lucide="book-open" className="w-5 h-5 text-indigo-600"></i>
                                    Guideline Recommendations ({recs.length})
                                  </span>
                                  <span className="text-xs text-indigo-500 font-normal">Evidence-based, auto-matched to patient data</span>
                                </summary>
                                <div className="p-4 pt-0 space-y-4">
                                  {Object.entries(grouped).map(([category, catRecs]) => (
                                    <div key={category}>
                                      <h4 className="text-sm font-bold text-indigo-800 uppercase tracking-wide mb-2 border-b border-indigo-100 pb-1">{category}</h4>
                                      <div className="space-y-2">
                                        {catRecs.map(rec => (
                                          <div key={rec.id} className="bg-indigo-50/50 border border-indigo-100 rounded-lg p-3">
                                            <div className="flex items-start gap-2">
                                              <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-xs font-bold shrink-0 ${classColors[rec.classOfRec] || 'bg-slate-500 text-white'}`}>
                                                {rec.classOfRec}/{rec.levelOfEvidence}
                                              </span>
                                              <div className="flex-1 min-w-0">
                                                <p className="text-sm font-semibold text-slate-900">{rec.title}</p>
                                                <p className="text-sm text-slate-700 mt-0.5">{rec.recommendation}</p>
                                                {rec.medications && rec.medications.length > 0 && (
                                                  <div className="mt-1.5 flex flex-wrap gap-1">
                                                    {rec.medications.map((med, i) => (
                                                      <span key={i} className="inline-block px-2 py-0.5 bg-white border border-indigo-200 rounded text-xs text-indigo-800">{med}</span>
                                                    ))}
                                                  </div>
                                                )}
                                                {rec.caveats && (
                                                  <p className="text-xs text-amber-700 mt-1 italic">{rec.caveats}</p>
                                                )}
                                                <p className="text-xs text-slate-500 mt-1">
                                                  {rec.guideline}
                                                  {(() => {
                                                    const url = rec.sourceUrl || getGuidelineUrl(rec.guideline);
                                                    if (!url) return null;
                                                    return (
                                                      <a href={url} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-0.5 ml-1.5 text-indigo-600 hover:text-indigo-800 font-medium" title={'View: ' + rec.guideline}>
                                                        <i aria-hidden="true" data-lucide="external-link" className="w-3 h-3"></i>
                                                        <span>Source</span>
                                                      </a>
                                                    );
                                                  })()}
                                                </p>
                                              </div>
                                            </div>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </details>
                            </div>
                          );
                        })()}

                        {/* Trial Eligibility Auto-Matcher */}
                        {(() => {
                          const allTrialIds = Object.keys(TRIAL_ELIGIBILITY_CONFIG);
                          if (allTrialIds.length === 0) return null;
                          const activeTrialCategory = getTrialTabCategory(telestrokeNote.diagnosisCategory, telestrokeNote.diagnosis) || trialsCategory;

                          // Use the pre-computed trialEligibility state (updated by useEffect)
                          const results = Object.values(trialEligibility)
                            .filter(Boolean)
                            .filter((trial) => trial.category === activeTrialCategory);
                          if (results.length === 0) return null;

                          const eligible = results.filter(r => r.status === 'eligible');
                          const needsInfo = results.filter(r => r.status === 'needs_info');
                          const notEligible = results.filter(r => r.status === 'not_eligible');

                          // Sort: eligible first, then needs_info, then not_eligible
                          const sorted = [...eligible, ...needsInfo, ...notEligible];

                          const hasMatches = eligible.length > 0 || needsInfo.length > 0;

                          return (
                            <details className={'border-2 rounded-lg ' + (eligible.length > 0 ? 'bg-emerald-50 border-emerald-300' : needsInfo.length > 0 ? 'bg-purple-50 border-purple-300' : 'bg-slate-50 border-slate-300')} open={hasMatches}>
                              <summary className="cursor-pointer p-3 font-semibold hover:bg-opacity-70 rounded-lg flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="flask-conical" className="w-5 h-5 text-purple-600"></i>
                                  <span className={eligible.length > 0 ? 'text-emerald-900' : 'text-purple-900'}>Trial Eligibility Auto-Matcher</span>
                                </div>
                                <div className="flex items-center gap-2">
                                  {eligible.length > 0 && <span className="px-2 py-0.5 bg-emerald-600 text-white rounded-full text-xs font-bold">{eligible.length} eligible</span>}
                                  {needsInfo.length > 0 && <span className="px-2 py-0.5 bg-amber-500 text-white rounded-full text-xs font-bold">{needsInfo.length} needs info</span>}
                                  {notEligible.length > 0 && <span className="px-2 py-0.5 bg-slate-400 text-white rounded-full text-xs font-bold">{notEligible.length} not eligible</span>}
                                </div>
                              </summary>
                              <div className="p-3 space-y-2">
                                <p className="text-xs text-slate-600 mb-2">Auto-compared against patient data (age, NIHSS, LKW, imaging, diagnosis). Criteria update in real-time as you enter data.</p>
                                {sorted.map(trial => {
                                  const config = TRIAL_ELIGIBILITY_CONFIG[trial.trialId];
                                  if (!config) return null;
                                  const statusColor = trial.status === 'eligible' ? 'border-emerald-400 bg-emerald-50' : trial.status === 'needs_info' ? 'border-amber-400 bg-amber-50' : 'border-slate-300 bg-slate-50';
                                  const statusBadge = trial.status === 'eligible' ? 'bg-emerald-600 text-white' : trial.status === 'needs_info' ? 'bg-amber-500 text-white' : 'bg-slate-400 text-white';
                                  const statusLabel = trial.status === 'eligible' ? '\u2713 Eligible' : trial.status === 'needs_info' ? '? Needs Info' : '\u2717 Not Eligible';
                                  const unknownCriteria = trial.criteria.filter(c => c.status === 'unknown');
                                  const metCriteria = trial.criteria.filter(c => c.status === 'met');
                                  const notMetCriteria = trial.criteria.filter(c => c.status === 'not_met');

                                  return (
                                    <details key={trial.trialId} className={'border rounded-lg ' + statusColor} open={trial.status === 'eligible' || trial.status === 'needs_info'}>
                                      <summary className="cursor-pointer px-3 py-2 flex items-center justify-between text-sm">
                                        <div className="flex items-center gap-2 min-w-0">
                                          <span className={'px-2 py-0.5 rounded text-xs font-bold whitespace-nowrap ' + statusBadge}>{statusLabel}</span>
                                          <span className="font-semibold truncate">{config.name}</span>
                                          <span className="text-xs text-slate-500 hidden sm:inline">({config.nct})</span>
                                        </div>
                                        <span className="text-xs text-slate-500 whitespace-nowrap ml-2">{metCriteria.length}/{trial.criteria.length} met</span>
                                      </summary>
                                      <div className="px-3 pb-3 space-y-2">
                                        <p className="text-xs text-slate-700 italic">{config.quickDescription}</p>

                                        {/* Key takeaways */}
                                        {config.keyTakeaways && config.keyTakeaways.length > 0 && (
                                          <div className="bg-white/70 border border-slate-200 rounded px-2.5 py-1.5 space-y-0.5">
                                            {config.keyTakeaways.map((t, i) => (
                                              <p key={i} className="text-xs text-slate-700 flex gap-1.5">
                                                <span className="text-blue-500 mt-px shrink-0">&#8227;</span>
                                                <span>{t}</span>
                                              </p>
                                            ))}
                                          </div>
                                        )}

                                        {/* Criteria checklist */}
                                        <div className="space-y-1">
                                          {trial.criteria.map(c => (
                                            <div key={c.id} className="flex items-center gap-2 text-xs">
                                              {c.status === 'met' && <span className="text-emerald-600 font-bold w-4 text-center">&#10003;</span>}
                                              {c.status === 'not_met' && <span className="text-red-600 font-bold w-4 text-center">&#10007;</span>}
                                              {c.status === 'unknown' && <span className="text-slate-500 font-bold w-4 text-center">&#9679;</span>}
                                              <span className={c.status === 'met' ? 'text-emerald-800' : c.status === 'not_met' ? 'text-red-800 line-through' : 'text-slate-600'}>
                                                {c.label}{c.required ? '' : ' (optional)'}
                                              </span>
                                            </div>
                                          ))}
                                        </div>

                                        {/* Exclusion flags */}
                                        {trial.exclusions.length > 0 && (
                                          <div className="bg-red-50 border border-red-200 rounded px-2 py-1">
                                            <span className="text-xs font-bold text-red-700">Exclusion triggered:</span>
                                            {trial.exclusions.map(e => (
                                              <span key={e.id} className="text-xs text-red-700 ml-1">&#10007; {e.label}</span>
                                            ))}
                                          </div>
                                        )}

                                        {/* Missing data hint */}
                                        {unknownCriteria.length > 0 && (
                                          <div className="bg-amber-50 border border-amber-200 rounded px-2 py-1.5">
                                            <span className="text-xs font-semibold text-amber-800">Missing data to determine eligibility:</span>
                                            <div className="flex flex-wrap gap-1 mt-1">
                                              {unknownCriteria.map(c => (
                                                <span key={c.id} className="text-xs bg-amber-200 text-amber-900 px-1.5 py-0.5 rounded">{c.label}</span>
                                              ))}
                                            </div>
                                          </div>
                                        )}

                                        {/* Actions */}
                                        <div className="flex gap-2 pt-1">
                                          <button type="button" onClick={() => navigateToTrial(trial.trialId)} className="text-xs font-semibold text-purple-700 hover:text-purple-900 underline">
                                            View full trial details →
                                          </button>
                                        </div>
                                      </div>
                                    </details>
                                  );
                                })}

                                {/* Looking For summary for eligible trials */}
                                {eligible.length > 0 && (
                                  <div className="bg-emerald-100 border border-emerald-300 rounded-lg p-2 mt-2">
                                    <p className="text-xs font-bold text-emerald-800 mb-1">&#10003; Patient may qualify for {eligible.length} trial{eligible.length > 1 ? 's' : ''} — consider discussing enrollment</p>
                                    {eligible.map(t => (
                                      <p key={t.trialId} className="text-xs text-emerald-700">&#8226; <strong>{t.trialName}:</strong> {t.quickDescription}</p>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </details>
                          );
                        })()}

                        {/* SAH Management Section - Only show for SAH diagnosis */}
                        {(telestrokeNote.diagnosisCategory === 'sah' || (telestrokeNote.diagnosis || '').toLowerCase().includes('sah') || (telestrokeNote.diagnosis || '').toLowerCase().includes('subarachnoid')) && (
                          <div id="sah-management-section" className="bg-white border border-purple-200 rounded-xl p-4 shadow-md">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-lg font-bold text-purple-900 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="zap" className="w-5 h-5"></i>
                                SAH Management (2023 AHA/ASA)
                              </h3>
                            </div>

                            <div className="space-y-3">
                              {/* SAH Grade */}
                              <div className="grid grid-cols-2 gap-3">
                                <div>
                                  <label htmlFor="input-sah-scale" className="block text-xs font-medium text-slate-600 mb-1">Grading Scale</label>
                                  <select
                                    id="input-sah-scale"
                                    value={telestrokeNote.sahGradeScale || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, sahGradeScale: v})); }}
                                    className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm"
                                  >
                                    <option value="">-- Select --</option>
                                    <option value="huntHess">Hunt & Hess</option>
                                    <option value="wfns">WFNS</option>
                                  </select>
                                </div>
                                <div>
                                  <label htmlFor="input-sah-grade" className="block text-xs font-medium text-slate-600 mb-1">Grade</label>
                                  <select
                                    id="input-sah-grade"
                                    value={telestrokeNote.sahGrade || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, sahGrade: v})); }}
                                    className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm"
                                  >
                                    <option value="">-- Select --</option>
                                    {telestrokeNote.sahGradeScale === 'huntHess' ? (
                                      <>
                                        <option value="1">Grade 1 - Asymptomatic or mild headache</option>
                                        <option value="2">Grade 2 - Moderate to severe headache, nuchal rigidity</option>
                                        <option value="3">Grade 3 - Drowsy, confused, mild focal deficit</option>
                                        <option value="4">Grade 4 - Stupor, moderate to severe hemiparesis</option>
                                        <option value="5">Grade 5 - Deep coma, decerebrate posturing</option>
                                      </>
                                    ) : telestrokeNote.sahGradeScale === 'wfns' ? (
                                      <>
                                        <option value="1">Grade I - GCS 15, no motor deficit</option>
                                        <option value="2">Grade II - GCS 13-14, no motor deficit</option>
                                        <option value="3">Grade III - GCS 13-14, with motor deficit</option>
                                        <option value="4">Grade IV - GCS 7-12</option>
                                        <option value="5">Grade V - GCS 3-6</option>
                                      </>
                                    ) : (
                                      <>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                      </>
                                    )}
                                  </select>
                                </div>
                              </div>

                              {/* SAH Grade Warning */}
                              {parseInt(telestrokeNote.sahGrade, 10) >= 4 && (
                                <div className="bg-red-50 border border-red-300 rounded-lg p-2 text-sm text-red-800">
                                  <strong>Poor-grade SAH (Grade {telestrokeNote.sahGrade}):</strong> Consider EVD placement, ICU admission, and early goals-of-care discussion. Avoid premature limitations of care.
                                </div>
                              )}

                              {/* SAH Management Checklist */}
                              <div className="bg-purple-50 rounded-lg p-3">
                                <div className="text-sm font-semibold text-purple-800 mb-2">SAH ICU Bundle</div>
                                <div className="space-y-2">
                                  {[
                                    { key: 'sahBPManaged', label: 'BP managed (SBP <160 pre-securing)', detail: 'Nicardipine or labetalol IV' },
                                    { key: 'sahNimodipine', label: 'Nimodipine started (60 mg q4h x 21d)', detail: 'Class I, LOE A for DCI prevention' },
                                    { key: 'sahEVDPlaced', label: 'EVD placed (if hydrocephalus/poor-grade)', detail: 'For acute hydrocephalus or HH 3-5' },
                                    { key: 'sahNeurosurgeryConsulted', label: 'Neurosurgery consulted', detail: 'For aneurysm securing strategy' },
                                    { key: 'sahAneurysmSecured', label: 'Aneurysm securing plan documented', detail: 'Clip vs coil within 24h' },
                                    { key: 'sahSeizureProphylaxis', label: 'Seizure prophylaxis addressed', detail: 'Short-term (3-7d) levetiracetam if indicated' }
                                  ].map(item => (
                                    <label key={item.key} className="flex items-start gap-2 cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={!!telestrokeNote[item.key]}
                                        onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, [k]: c})); }}
                                        className="mt-0.5 rounded border-purple-300 text-purple-600"
                                      />
                                      <div>
                                        <span className="text-sm font-medium text-slate-800">{item.label}</span>
                                        <span className="block text-xs text-slate-500">{item.detail}</span>
                                      </div>
                                    </label>
                                  ))}
                                </div>
                              </div>

                              {/* Aneurysm Characteristics */}
                              <div className="bg-purple-50 rounded-lg p-3">
                                <div className="text-sm font-semibold text-purple-800 mb-2">Aneurysm Characteristics</div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                  <div>
                                    <label htmlFor="input-sah-aneurysm-loc" className="block text-xs text-slate-600 mb-1">Location</label>
                                    <select id="input-sah-aneurysm-loc" value={telestrokeNote.sahAneurysmLocation || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, sahAneurysmLocation: v})); }}
                                      className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm">
                                      <option value="">-- Location --</option>
                                      <option value="AComm">AComm (anterior communicating)</option>
                                      <option value="PComm">PComm (posterior communicating)</option>
                                      <option value="MCA">MCA bifurcation</option>
                                      <option value="ICA">ICA (internal carotid)</option>
                                      <option value="basilar-tip">Basilar tip</option>
                                      <option value="PICA">PICA</option>
                                      <option value="SCA">SCA</option>
                                      <option value="pericallosal">Pericallosal</option>
                                      <option value="ophthalmic">Ophthalmic</option>
                                      <option value="other">Other</option>
                                      <option value="unknown">Not yet identified</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label htmlFor="input-sah-aneurysm-size" className="block text-xs text-slate-600 mb-1">Size (mm)</label>
                                    <input id="input-sah-aneurysm-size" type="number" min="0" step="0.5"
                                      value={telestrokeNote.sahAneurysmSize || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, sahAneurysmSize: v})); }}
                                      placeholder="mm"
                                      className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm" />
                                  </div>
                                  <div>
                                    <label htmlFor="input-sah-securing" className="block text-xs text-slate-600 mb-1">Securing Plan</label>
                                    <select id="input-sah-securing" value={telestrokeNote.sahSecuringMethod || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, sahSecuringMethod: v})); }}
                                      className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm">
                                      <option value="">-- Method --</option>
                                      <option value="coiling">Endovascular coiling</option>
                                      <option value="clipping">Surgical clipping</option>
                                      <option value="flow-diverter">Flow diverter</option>
                                      <option value="hybrid">Hybrid approach</option>
                                      <option value="conservative">Conservative (not amenable)</option>
                                      <option value="pending">Pending neurosurgery/IR decision</option>
                                    </select>
                                  </div>
                                </div>
                                {telestrokeNote.sahAneurysmLocation && ['basilar-tip', 'PICA', 'SCA'].includes(telestrokeNote.sahAneurysmLocation) && (
                                  <div className="mt-2 bg-red-50 border border-red-300 rounded p-2 text-xs text-red-800">
                                    <strong>Posterior circulation aneurysm:</strong> Higher rebleeding risk pre-securing. Prioritize early securing within 24h. Monitor closely for brainstem compression.
                                  </div>
                                )}
                                {parseFloat(telestrokeNote.sahAneurysmSize) >= 25 && (
                                  <div className="mt-2 bg-amber-50 border border-amber-300 rounded p-2 text-xs text-amber-800">
                                    <strong>Giant aneurysm ({telestrokeNote.sahAneurysmSize} mm):</strong> Higher procedural complexity. Consider flow diverter or hybrid approach. Multidisciplinary planning recommended.
                                  </div>
                                )}
                              </div>

                              {/* Vasospasm / DCI Monitoring Protocol */}
                              <div className="bg-amber-50 rounded-lg p-3">
                                <div className="text-sm font-semibold text-amber-800 mb-2">Vasospasm / DCI Monitoring (Days 4-14)</div>
                                <div className="space-y-2">
                                  {[
                                    { key: 'tcdOrdered', label: 'TCD ultrasound ordered/scheduled', detail: 'Daily TCD days 3-14; MCA velocity >120 cm/s concerning, >200 cm/s = severe vasospasm' },
                                    { key: 'neuroChecksQ1h', label: 'Neuro checks q1h ordered', detail: 'New deficit, confusion, or decreased consciousness may signal DCI' },
                                    { key: 'sodiumMonitoring', label: 'Sodium monitoring (q6-8h)', detail: 'SIADH vs cerebral salt wasting — both cause hyponatremia; treatment differs' },
                                    { key: 'dciSuspected', label: 'DCI suspected', detail: 'New focal deficit or decreased consciousness not explained by hydrocephalus, rebleeding, or metabolic cause' },
                                    { key: 'inducedHypertension', label: 'Induced hypertension initiated', detail: 'SBP 160-200 with phenylephrine/norepinephrine for symptomatic DCI after aneurysm secured' }
                                  ].map(item => (
                                    <label key={item.key} className="flex items-start gap-2 cursor-pointer">
                                      <input type="checkbox"
                                        checked={!!(telestrokeNote.sahVasospasmMonitoring || {})[item.key]}
                                        onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, sahVasospasmMonitoring: {...(prev.sahVasospasmMonitoring || {}), [k]: c}})); }}
                                        className="mt-0.5 rounded border-amber-300 text-amber-600" />
                                      <div>
                                        <span className="text-sm font-medium text-slate-800">{item.label}</span>
                                        <span className="block text-xs text-slate-500">{item.detail}</span>
                                      </div>
                                    </label>
                                  ))}
                                  <input type="text" aria-label="Vasospasm monitoring notes"
                                    value={(telestrokeNote.sahVasospasmMonitoring || {}).notes || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, sahVasospasmMonitoring: {...(prev.sahVasospasmMonitoring || {}), notes: v}})); }}
                                    placeholder="Additional vasospasm/DCI notes..."
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-xs mt-1" />
                                </div>
                                {!!(telestrokeNote.sahVasospasmMonitoring || {}).dciSuspected && !telestrokeNote.sahAneurysmSecured && (
                                  <div className="mt-2 bg-red-100 border border-red-400 rounded p-2 text-xs text-red-900 font-medium">
                                    Caution: Induced hypertension for DCI is contraindicated until aneurysm is secured (rebleeding risk).
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        )}

                        {/* CVT Management Section - Only show for CVT diagnosis */}
                        {(telestrokeNote.diagnosisCategory === 'cvt' || (telestrokeNote.diagnosis || '').toLowerCase().includes('cvt') || (telestrokeNote.diagnosis || '').toLowerCase().includes('venous thrombosis') || (telestrokeNote.diagnosis || '').toLowerCase().includes('cerebral venous')) && (
                          <div id="cvt-management-section" className="bg-white border-2 border-indigo-300 rounded-lg p-4 shadow-md">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-lg font-bold text-indigo-900 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="git-branch" className="w-5 h-5"></i>
                                CVT Management (2024 AHA)
                              </h3>
                            </div>

                            <div className="space-y-3">
                              {/* CVT Anticoagulation */}
                              <div className="bg-indigo-50 rounded-lg p-3">
                                <div className="text-sm font-semibold text-indigo-800 mb-2">CVT Treatment Checklist</div>
                                <div className="space-y-2">
                                  <label className="flex items-start gap-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={!!telestrokeNote.cvtAnticoagStarted}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtAnticoagStarted: c})); }}
                                      className="mt-0.5 rounded border-indigo-300 text-indigo-600"
                                    />
                                    <div>
                                      <span className="text-sm font-medium text-slate-800">Anticoagulation initiated</span>
                                      <span className="block text-xs text-slate-500">LMWH or UFH, even with hemorrhagic infarction (Class I)</span>
                                    </div>
                                  </label>

                                  {telestrokeNote.cvtAnticoagStarted && (
                                    <div className="ml-6">
                                      <select
                                        value={telestrokeNote.cvtAnticoagType || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, cvtAnticoagType: v})); }}
                                        className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm"
                                      >
                                        <option value="">-- Select agent --</option>
                                        <option value="enoxaparin">Enoxaparin 1 mg/kg SC q12h</option>
                                        <option value="enoxaparin-daily">Enoxaparin 1.5 mg/kg SC daily</option>
                                        <option value="ufh">UFH weight-based (aPTT 60-80s)</option>
                                        <option value="other">Other</option>
                                      </select>
                                    </div>
                                  )}

                                  <label className="flex items-start gap-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={!!telestrokeNote.cvtIcpManaged}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtIcpManaged: c})); }}
                                      className="mt-0.5 rounded border-indigo-300 text-indigo-600"
                                    />
                                    <div>
                                      <span className="text-sm font-medium text-slate-800">ICP assessment/management</span>
                                      <span className="block text-xs text-slate-500">HOB 30°, acetazolamide if needed, LP drainage for visual impairment</span>
                                    </div>
                                  </label>

                                  <label className="flex items-start gap-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={!!telestrokeNote.cvtSeizureManaged}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtSeizureManaged: c})); }}
                                      className="mt-0.5 rounded border-indigo-300 text-indigo-600"
                                    />
                                    <div>
                                      <span className="text-sm font-medium text-slate-800">Seizure management addressed</span>
                                      <span className="block text-xs text-slate-500">Treat acute seizures with levetiracetam; routine prophylaxis NOT recommended (AHA/ASA). EEG if supratentorial lesion with altered consciousness.</span>
                                    </div>
                                  </label>

                                  <label className="flex items-start gap-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={!!telestrokeNote.cvtHematologyConsulted}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtHematologyConsulted: c})); }}
                                      className="mt-0.5 rounded border-indigo-300 text-indigo-600"
                                    />
                                    <div>
                                      <span className="text-sm font-medium text-slate-800">Hematology consult / thrombophilia workup</span>
                                      <span className="block text-xs text-slate-500">Factor V Leiden, prothrombin mutation, protein C/S, APLA</span>
                                    </div>
                                  </label>
                                </div>
                              </div>

                              {/* CVT Long-term Plan Note */}
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-2 text-xs text-blue-800">
                                <strong>Long-term plan:</strong> Transition to VKA (INR 2-3) for 3-12 months. DOAC may be considered for mild provoked CVT per ACTION-CVT data. Indefinite anticoagulation if recurrent VTE or severe thrombophilia.
                              </div>
                            </div>
                          </div>
                        )}

                        {/* ========== TIA WORKUP CHECKLIST ========== */}
                        {getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'tia' && (
                          <div className="bg-white border border-orange-200 rounded-xl p-4 shadow-md">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-lg font-bold text-orange-900 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="clipboard-check" className="w-5 h-5"></i>
                                TIA Rapid Workup Checklist
                              </h3>
                              <div className="flex items-center gap-2">
                                <span className="text-xs text-orange-600 font-medium">
                                  {Object.values(telestrokeNote.tiaWorkup || {}).filter(Boolean).length}/{Object.keys(telestrokeNote.tiaWorkup || {}).length} complete
                                </span>
                                <button
                                  type="button"
                                  onClick={() => setTelestrokeNote(prev => ({...prev, tiaWorkupReviewed: !prev.tiaWorkupReviewed}))}
                                  className={`text-xs px-2 py-1 rounded-lg font-medium ${telestrokeNote.tiaWorkupReviewed ? 'bg-emerald-500 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                >
                                  {telestrokeNote.tiaWorkupReviewed ? 'Reviewed' : 'Mark Reviewed'}
                                </button>
                              </div>
                            </div>
                            <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-3 text-sm text-orange-800">
                              <strong>Admit ALL TIAs</strong> for urgent inpatient workup (Class I, LOE B-NR). Do not use ABCD2 score for disposition decisions.
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
                              {[
                                { key: 'mriDwi', label: 'MRI Brain with DWI', category: 'Imaging' },
                                { key: 'ctaHeadNeck', label: 'CTA Head & Neck (or MRA)', category: 'Imaging' },
                                { key: 'ecg12Lead', label: '12-Lead ECG', category: 'Cardiac' },
                                { key: 'telemetry', label: 'Continuous telemetry monitoring', category: 'Cardiac' },
                                { key: 'echo', label: 'Echocardiography (TTE +/- bubble)', category: 'Cardiac' },
                                { key: 'labsCbc', label: 'CBC with differential', category: 'Labs' },
                                { key: 'labsBmp', label: 'BMP + glucose', category: 'Labs' },
                                { key: 'labsA1c', label: 'HbA1c', category: 'Labs' },
                                { key: 'labsLipids', label: 'Fasting lipid panel', category: 'Labs' },
                                { key: 'labsTsh', label: 'TSH', category: 'Labs' }
                              ].map(item => (
                                <label key={item.key} className="flex items-center gap-2 py-1 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={!!(telestrokeNote.tiaWorkup || {})[item.key]}
                                    onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                      tiaWorkup: { ...(prev.tiaWorkup || {}), [item.key]: e.target.checked }
                                    }))}
                                    className="rounded border-orange-300 text-orange-600"
                                  />
                                  <span className="text-sm text-slate-700">{item.label}</span>
                                </label>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* ========== TOAST CLASSIFICATION ========== */}
                        {(getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' || getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'tia') && (
                          <div className="bg-white border-2 border-violet-300 rounded-lg p-4 shadow-md">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-lg font-bold text-violet-900 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="layers" className="w-5 h-5"></i>
                                TOAST Etiologic Classification
                              </h3>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                              {[
                                { value: 'large-artery', label: 'Large Artery Atherosclerosis', desc: 'Carotid/intracranial stenosis >=50%, or plaque with ulceration' },
                                { value: 'cardioembolism', label: 'Cardioembolism', desc: 'AF, PFO, valvular disease, LV thrombus, endocarditis' },
                                { value: 'small-vessel', label: 'Small Vessel Occlusion (Lacunar)', desc: 'Subcortical infarct <15mm, classic lacunar syndrome' },
                                { value: 'other-determined', label: 'Other Determined Etiology', desc: 'Dissection, vasculitis, hypercoagulable, sickle cell, etc.' },
                                { value: 'cryptogenic', label: 'Cryptogenic / ESUS', desc: 'No cause found despite complete evaluation, or >1 competing cause' }
                              ].map(item => (
                                <button key={item.value} type="button"
                                  className={`w-full text-left p-2 rounded border transition-colors ${telestrokeNote.toastClassification === item.value ? 'bg-violet-600 text-white border-violet-600' : 'hover:bg-violet-50 border-slate-200 active:bg-violet-100'}`}
                                  onClick={() => setTelestrokeNote(prev => ({...prev, toastClassification: item.value}))}
                                >
                                  <span className="text-sm font-semibold">{item.label}</span>
                                  <p className={`text-xs ${telestrokeNote.toastClassification === item.value ? 'text-violet-200' : 'text-slate-500'}`}>{item.desc}</p>
                                </button>
                              ))}
                            </div>
                          </div>
                        )}

                        {/* ========== CARDIAC WORKUP DECISION TREE ========== */}
                        {(getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' || getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'tia' || telestrokeNote.toastClassification === 'cardioembolism' || telestrokeNote.toastClassification === 'cryptogenic') && telestrokeNote.diagnosis && (
                          <div className="bg-white border-2 border-pink-300 rounded-lg p-4 shadow-md">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-lg font-bold text-pink-900 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="heart" className="w-5 h-5"></i>
                                Cardiac Workup
                              </h3>
                            </div>
                            <div className="space-y-3">
                              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <label className="flex items-center gap-2 p-2 bg-pink-50 rounded border border-pink-200">
                                  <input type="checkbox" checked={!!(telestrokeNote.cardiacWorkup || {}).ecgComplete}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cardiacWorkup: {...(prev.cardiacWorkup || {}), ecgComplete: c}})); }}
                                    className="text-pink-600" />
                                  <span className="text-sm">12-Lead ECG</span>
                                </label>
                                <label className="flex items-center gap-2 p-2 bg-pink-50 rounded border border-pink-200">
                                  <input type="checkbox" checked={!!(telestrokeNote.cardiacWorkup || {}).telemetryOrdered}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cardiacWorkup: {...(prev.cardiacWorkup || {}), telemetryOrdered: c}})); }}
                                    className="text-pink-600" />
                                  <span className="text-sm">Inpatient Telemetry</span>
                                </label>
                                <label className="flex items-center gap-2 p-2 bg-pink-50 rounded border border-pink-200">
                                  <input type="checkbox" checked={!!(telestrokeNote.cardiacWorkup || {}).echoOrdered}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cardiacWorkup: {...(prev.cardiacWorkup || {}), echoOrdered: c}})); }}
                                    className="text-pink-600" />
                                  <span className="text-sm">Echo (TTE +/- Bubble)</span>
                                </label>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Extended Cardiac Monitoring (post-discharge)</label>
                                <select
                                  value={(telestrokeNote.cardiacWorkup || {}).extendedMonitoringType || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, cardiacWorkup: {...(prev.cardiacWorkup || {}), extendedMonitoringType: v, extendedMonitoring: v ? 'ordered' : ''}})); }}
                                  className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500"
                                >
                                  <option value="">-- Select monitoring plan --</option>
                                  <option value="30-day-monitor">30-Day Ambulatory Monitor (Preferred)</option>
                                  <option value="14-day-patch">14-Day Continuous Patch (if 30-day unavailable)</option>
                                  <option value="ilr">Implantable Loop Recorder (select cases)</option>
                                  <option value="none-af-known">Not needed — AF already documented</option>
                                  <option value="none-other">Not indicated (clear etiology identified)</option>
                                </select>
                                <p className="text-xs text-slate-500 mt-1">Hierarchy: 30-day monitor preferred; 14-day patch if unavailable; ILR in select cases with high suspicion and negative ambulatory monitoring.</p>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">PFO Evaluation</label>
                                <select
                                  value={(telestrokeNote.cardiacWorkup || {}).pfoEvaluation || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, cardiacWorkup: {...(prev.cardiacWorkup || {}), pfoEvaluation: v}})); }}
                                  className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500"
                                >
                                  <option value="">-- Select PFO status --</option>
                                  <option value="no-pfo">No PFO detected</option>
                                  <option value="pfo-no-closure">PFO present — closure not indicated</option>
                                  <option value="pfo-closure-candidate">PFO present — closure candidate (PASCAL: probable/definite)</option>
                                  <option value="pfo-further-eval">PFO present — needs further evaluation</option>
                                </select>
                              </div>
                              {(telestrokeNote.cardiacWorkup || {}).pfoEvaluation === 'pfo-closure-candidate' && (
                                <div className="bg-pink-50 border border-pink-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-pink-800 mb-2">PASCAL Classification for PFO Closure</h4>
                                  <select
                                    value={(telestrokeNote.cardiacWorkup || {}).pascalClassification || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, cardiacWorkup: {...(prev.cardiacWorkup || {}), pascalClassification: v}})); }}
                                    className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500"
                                  >
                                    <option value="">-- Select PASCAL grade --</option>
                                    <option value="definite">Definite — High probability PFO-attributable stroke (closure recommended)</option>
                                    <option value="probable">Probable — Moderate probability (closure reasonable)</option>
                                    <option value="possible">Possible — Low probability (closure uncertain benefit)</option>
                                    <option value="unlikely">Unlikely — Very low probability (closure not recommended)</option>
                                  </select>
                                  {(() => {
                                    const rope = calculateROPEScore(ropeItems);
                                    if (rope === 0) return null;
                                    const current = (telestrokeNote.cardiacWorkup || {}).pascalClassification;
                                    if (current) return null;
                                    // Simplified PASCAL estimate — RoPE only (PFO anatomy not yet assessed)
                                    // Full PASCAL requires shunt grade + ASA: RoPE≥7 + high-risk PFO = definite
                                    const suggested = rope >= 7 ? 'probable' : rope >= 4 ? 'possible' : 'possible';
                                    return (
                                      <div className="mt-1 p-1.5 bg-pink-50 border border-pink-200 rounded text-xs text-pink-700">
                                        <p className="font-medium">RoPE {rope} preliminary estimate: {suggested}</p>
                                        <p className="text-pink-500 mt-0.5">Note: Full PASCAL requires PFO anatomy (shunt size, ASA). High-risk PFO + RoPE ≥7 = definite. Adjust after TEE.</p>
                                        <button type="button" onClick={() => setTelestrokeNote(prev => ({...prev, cardiacWorkup: {...(prev.cardiacWorkup || {}), pascalClassification: suggested}}))}
                                          className="mt-1 text-pink-600 hover:text-pink-800 underline font-medium">
                                          Apply "{suggested}" as starting point
                                        </button>
                                      </div>
                                    );
                                  })()}
                                  <p className="text-xs text-slate-500 mt-1">PASCAL integrates: PFO anatomy (shunt size, ASA), age, clot/DVT source, Alternative etiologies, Lacunar vs cortical pattern. Closure recommended for definite/probable in patients age 18-60.</p>
                                </div>
                              )}
                              {telestrokeNote.toastClassification === 'large-artery' && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm">
                                  <h4 className="font-semibold text-blue-800 mb-1">sICAS Management (AAN 2022)</h4>
                                  <ul className="space-y-1 ml-4 text-blue-700">
                                    <li>• Severe symptomatic intracranial stenosis (70-99%): DAPT x 90 days, then ASA 325 mg</li>
                                    <li>• High-intensity statin with LDL target &lt;70 mg/dL</li>
                                    <li>• SBP target &lt;140/90 (ideally &lt;130/80)</li>
                                    <li>• Do NOT offer intracranial stenting as initial treatment (Class III)</li>
                                  </ul>
                                </div>
                              )}
                            </div>
                          </div>
                        )}

                        {/* ========== ETIOLOGY WORKUP PLANNER ========== */}
                        {telestrokeNote.toastClassification && (getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' || getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'tia') && (
                          <div className="bg-white border border-blue-200 rounded-xl p-4 shadow-md">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-lg font-bold text-blue-900 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="clipboard-list" className="w-5 h-5"></i>
                                Etiology Workup Planner
                              </h3>
                              <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-medium">
                                Based on: {TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification}
                              </span>
                            </div>
                            {(() => {
                              const toast = telestrokeNote.toastClassification;
                              const ew = telestrokeNote.etiologyWorkup || {};
                              const completed = ew.completedTests || {};
                              const workupTests = {
                                'large-artery': [
                                  { key: 'ctaHeadNeck', label: 'CTA Head/Neck (or MRA)', reason: 'Assess degree of stenosis, plaque morphology' },
                                  { key: 'carotidDuplex', label: 'Carotid Duplex Ultrasound', reason: 'Confirm stenosis degree if CTA equivocal' },
                                  { key: 'mriDwi', label: 'MRI Brain (DWI/FLAIR)', reason: 'Characterize infarct pattern, exclude mimics' },
                                  { key: 'lipidPanel', label: 'Fasting Lipid Panel', reason: 'Guide statin therapy intensity' },
                                  { key: 'hba1c', label: 'HbA1c', reason: 'Screen for diabetes as atherosclerotic risk factor' },
                                  { key: 'ecg', label: '12-Lead ECG', reason: 'Rule out concurrent AF' },
                                  { key: 'echo', label: 'Echocardiogram (TTE)', reason: 'Exclude concurrent cardiac source' },
                                  { key: 'vesselWallMri', label: 'Vessel Wall MRI (if intracranial)', reason: 'Characterize intracranial plaque (enhancement, remodeling)' }
                                ],
                                'cardioembolism': [
                                  { key: 'ecg', label: '12-Lead ECG', reason: 'Document AF, flutter, or other arrhythmia' },
                                  { key: 'telemetry', label: 'Inpatient Telemetry', reason: 'Continuous rhythm monitoring during admission' },
                                  { key: 'echoTte', label: 'TTE with Bubble Study', reason: 'Evaluate for thrombus, PFO, valvular disease' },
                                  { key: 'echoTee', label: 'TEE (if TTE non-diagnostic)', reason: 'Better sensitivity for LA thrombus, PFO, atrial septal aneurysm' },
                                  { key: 'extendedMonitor', label: 'Extended Cardiac Monitoring (30-day)', reason: 'Detect paroxysmal AF if not documented on ECG/telemetry' },
                                  { key: 'mriDwi', label: 'MRI Brain (DWI/FLAIR)', reason: 'Infarct pattern — multiterritory suggests cardioembolic' },
                                  { key: 'ctaHeadNeck', label: 'CTA Head/Neck', reason: 'Exclude concurrent large-artery disease' }
                                ],
                                'small-vessel': [
                                  { key: 'mriDwi', label: 'MRI Brain (DWI/FLAIR/SWI)', reason: 'Confirm subcortical lacunar infarct <15mm, assess WMH burden' },
                                  { key: 'lipidPanel', label: 'Fasting Lipid Panel', reason: 'Optimize risk factors' },
                                  { key: 'hba1c', label: 'HbA1c', reason: 'Diabetes screening — major SVD risk factor' },
                                  { key: 'bpMonitoring', label: 'Ambulatory BP Monitoring', reason: 'Assess for nocturnal non-dipping, guide intensive BP management' },
                                  { key: 'ecg', label: '12-Lead ECG', reason: 'Rule out AF' },
                                  { key: 'ctaHeadNeck', label: 'CTA Head/Neck', reason: 'Exclude concurrent large-artery disease' }
                                ],
                                'other-determined': [
                                  { key: 'mriDwi', label: 'MRI Brain (DWI/FLAIR)', reason: 'Characterize infarct pattern' },
                                  { key: 'mraNeck', label: 'MRA Neck with fat sat (or CTA)', reason: 'Evaluate for dissection (intramural hematoma)' },
                                  { key: 'vesselWallMri', label: 'Vessel Wall MRI', reason: 'Assess for vasculitis, dissection, Moyamoya, reversible vasoconstriction' },
                                  { key: 'hypercoagPanel', label: 'Hypercoagulability Panel', reason: 'Factor V Leiden, prothrombin mutation, antiphospholipid Abs, protein C/S, antithrombin III' },
                                  { key: 'esrCrp', label: 'ESR, CRP, ANA', reason: 'Screen for inflammatory/autoimmune vasculopathy' },
                                  { key: 'ecg', label: '12-Lead ECG', reason: 'Rule out concurrent cardiac source' }
                                ],
                                'cryptogenic': [
                                  { key: 'mriDwi', label: 'MRI Brain (DWI/FLAIR)', reason: 'Infarct pattern may suggest etiology (embolic vs lacunar)' },
                                  { key: 'ctaHeadNeck', label: 'CTA Head/Neck', reason: 'Exclude large-artery disease, dissection' },
                                  { key: 'echoTte', label: 'TTE with Bubble Study', reason: 'Screen for PFO, cardiac source' },
                                  { key: 'echoTee', label: 'TEE (if PFO suspected or age <60)', reason: 'Better PFO characterization, atrial septal aneurysm' },
                                  { key: 'extendedMonitor', label: 'Extended Cardiac Monitoring (30-day)', reason: 'Detect occult paroxysmal AF — yield ~12-15% at 30 days' },
                                  { key: 'hypercoagPanel', label: 'Hypercoagulability Panel', reason: 'Especially if age <55 or recurrent events' },
                                  { key: 'lipidPanel', label: 'Fasting Lipid Panel', reason: 'Complete risk factor assessment' },
                                  { key: 'hba1c', label: 'HbA1c', reason: 'Screen for undiagnosed diabetes' }
                                ]
                              };
                              const tests = workupTests[toast] || [];
                              const completedCount = tests.filter(t => completed[t.key]).length;
                              return (
                                <div className="space-y-2">
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="text-sm text-slate-600">Progress: {completedCount}/{tests.length} tests</span>
                                    <div className="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
                                      <div className="h-full bg-blue-500 rounded-full transition-all" style={{ width: `${tests.length > 0 ? (completedCount / tests.length) * 100 : 0}%` }}></div>
                                    </div>
                                  </div>
                                  {tests.map(test => (
                                    <label key={test.key} className={`flex items-start gap-2 p-2 rounded border transition cursor-pointer ${completed[test.key] ? 'bg-blue-50 border-blue-300' : 'bg-white border-slate-200 hover:bg-slate-50'}`}>
                                      <input type="checkbox" checked={!!completed[test.key]}
                                        onChange={(e) => { const k = test.key, c = e.target.checked; setTelestrokeNote(prev => { const ew2 = prev.etiologyWorkup || {}; return {...prev, etiologyWorkup: {...ew2, completedTests: {...(ew2.completedTests || {}), [k]: c}}}; }); }}
                                        className="mt-0.5 text-blue-600" />
                                      <div className="flex-1 min-w-0">
                                        <span className={`text-sm font-medium ${completed[test.key] ? 'text-blue-800 line-through' : 'text-slate-800'}`}>{test.label}</span>
                                        <p className="text-xs text-slate-500">{test.reason}</p>
                                      </div>
                                    </label>
                                  ))}
                                  <button onClick={() => {
                                    const workupText = `ETIOLOGY WORKUP PLAN (${toast === 'large-artery' ? 'Large Artery Atherosclerosis' : toast === 'cardioembolism' ? 'Cardioembolism' : toast === 'small-vessel' ? 'Small Vessel' : toast === 'other-determined' ? 'Other Determined' : 'Cryptogenic/ESUS'}):\n` +
                                      tests.map(t => `${completed[t.key] ? '[x]' : '[ ]'} ${t.label} — ${t.reason}`).join('\n');
                                    copyToClipboard(workupText, 'workup-plan');
                                  }}
                                    className={`w-full mt-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 ${copiedText === 'workup-plan' ? 'bg-emerald-600 text-white' : 'bg-blue-600 text-white hover:bg-blue-700'}`}>
                                    <i aria-hidden="true" data-lucide={copiedText === 'workup-plan' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                    {copiedText === 'workup-plan' ? 'Copied!' : 'Copy Workup Plan'}
                                  </button>
                                </div>
                              );
                            })()}
                          </div>
                        )}

                        {/* ========== CERVICAL ARTERY DISSECTION PATHWAY ========== */}
                        {getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'dissection' && (
                          <div className="bg-white border border-red-200 rounded-xl p-4 shadow-md">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-lg font-bold text-red-900 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="git-branch" className="w-5 h-5"></i>
                                Cervical Artery Dissection Pathway
                              </h3>
                            </div>
                            <div className="space-y-3">
                              <div className="bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-800">
                                <strong>Key:</strong> Cervical dissection is NOT a contraindication to IV TNK if within treatment window. Antithrombotic therapy (antiplatelet or anticoagulation) is indicated; neither is proven superior (CADISS).
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Antithrombotic Selection</label>
                                <select
                                  value={(telestrokeNote.dissectionPathway || {}).antithromboticType || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, dissectionPathway: {...(prev.dissectionPathway || {}), antithromboticType: v, antithromboticStarted: !!v}})); }}
                                  className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500"
                                >
                                  <option value="">-- Select antithrombotic --</option>
                                  <option value="antiplatelet-asa">Antiplatelet: ASA 81-325 mg daily</option>
                                  <option value="antiplatelet-dapt">Antiplatelet: DAPT (ASA + clopidogrel)</option>
                                  <option value="anticoag-heparin">Anticoagulation: Heparin bridge to warfarin</option>
                                  <option value="anticoag-doac">Anticoagulation: DOAC (off-label)</option>
                                </select>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Vascular Imaging Follow-Up Plan</label>
                                <select
                                  value={(telestrokeNote.dissectionPathway || {}).imagingFollowUp || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, dissectionPathway: {...(prev.dissectionPathway || {}), imagingFollowUp: v}})); }}
                                  className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-red-500"
                                >
                                  <option value="">-- Select follow-up plan --</option>
                                  <option value="3-month">Repeat CTA/MRA at 3 months</option>
                                  <option value="6-month">Repeat CTA/MRA at 6 months</option>
                                  <option value="3-and-6-month">Repeat at 3 and 6 months</option>
                                </select>
                                <p className="text-xs text-slate-500 mt-1">Most dissections heal in 3-6 months. If recanalized, consider switching anticoagulation to antiplatelet. Persistent pseudoaneurysm may warrant continued treatment.</p>
                              </div>
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm">
                                <h4 className="font-semibold text-amber-800 mb-1">Dissection Counseling Points</h4>
                                <ul className="space-y-1 ml-4 text-amber-700">
                                  <li>• Avoid cervical manipulation (chiropractic) during healing</li>
                                  <li>• Avoid heavy lifting/straining for 4-6 weeks</li>
                                  <li>• Report any new headache, neck pain, or neurological symptoms immediately</li>
                                  <li>• Duration of antithrombotic therapy: typically 3-6 months, reassess with imaging</li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* ========== SCREENING TOOLS ========== */}
                        {telestrokeNote.diagnosis && getPathwayForDiagnosis(telestrokeNote.diagnosis) !== 'mimic' && (
                          <details className="bg-white border border-blue-200 rounded-xl shadow-md">
                            <summary className="cursor-pointer p-4 font-semibold text-blue-900 hover:bg-blue-50 rounded-lg flex items-center justify-between">
                              <span className="flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="scan" className="w-5 h-5 text-blue-600"></i>
                                Post-Stroke Screening Tools
                              </span>
                              <span className="text-xs text-blue-500 font-normal">PHQ-2, MoCA, STOP-BANG, Seizure Risk</span>
                            </summary>
                            <div className="p-4 pt-0 space-y-4">
                              {/* PHQ-2 Depression Screening */}
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 className="font-semibold text-blue-800 mb-2">PHQ-2 Depression Screening</h4>
                                <p className="text-xs text-slate-600 mb-2">Over the past 2 weeks, how often has the patient been bothered by:</p>
                                <div className="space-y-2">
                                  <div>
                                    <label className="text-sm text-slate-700">1. Little interest or pleasure in doing things?</label>
                                    <select
                                      value={(telestrokeNote.screeningTools || {}).phq2_q1 || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => { const st = {...(prev.screeningTools || {}), phq2_q1: v}; const score = (parseInt(st.phq2_q1, 10) || 0) + (parseInt(st.phq2_q2, 10) || 0); st.phq2Score = score.toString(); st.phq2Positive = score >= 3; return {...prev, screeningTools: st}; }); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm mt-1"
                                    >
                                      <option value="">Select</option>
                                      <option value="0">Not at all (0)</option>
                                      <option value="1">Several days (1)</option>
                                      <option value="2">More than half the days (2)</option>
                                      <option value="3">Nearly every day (3)</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label className="text-sm text-slate-700">2. Feeling down, depressed, or hopeless?</label>
                                    <select
                                      value={(telestrokeNote.screeningTools || {}).phq2_q2 || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => { const st = {...(prev.screeningTools || {}), phq2_q2: v}; const score = (parseInt(st.phq2_q1, 10) || 0) + (parseInt(st.phq2_q2, 10) || 0); st.phq2Score = score.toString(); st.phq2Positive = score >= 3; return {...prev, screeningTools: st}; }); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm mt-1"
                                    >
                                      <option value="">Select</option>
                                      <option value="0">Not at all (0)</option>
                                      <option value="1">Several days (1)</option>
                                      <option value="2">More than half the days (2)</option>
                                      <option value="3">Nearly every day (3)</option>
                                    </select>
                                  </div>
                                </div>
                                {(telestrokeNote.screeningTools || {}).phq2Score && (
                                  <div className={`mt-2 p-2 rounded text-sm font-medium ${(telestrokeNote.screeningTools || {}).phq2Positive ? 'bg-red-100 text-red-800' : 'bg-emerald-100 text-emerald-800'}`}>
                                    PHQ-2 Score: {(telestrokeNote.screeningTools || {}).phq2Score}/6
                                    {(telestrokeNote.screeningTools || {}).phq2Positive ? ' — POSITIVE: Proceed to PHQ-9, consider referral' : ' — Negative screen'}
                                  </div>
                                )}
                                {(telestrokeNote.screeningTools || {}).phq2Positive && (
                                  <div className="mt-3 bg-red-50 border border-red-200 rounded-lg p-3">
                                    <h5 className="font-semibold text-red-800 text-sm mb-2">Post-Stroke Depression Care Plan</h5>
                                    <div className="text-xs text-slate-700 space-y-1">
                                      <p><strong>1. Full PHQ-9:</strong> Complete 9-item questionnaire to quantify severity (5-9 mild, 10-14 moderate, 15-19 moderately severe, 20-27 severe).</p>
                                      <p><strong>2. First-line therapy:</strong> Psychotherapy (CBT, behavioral activation) and structured exercise program. Class I evidence for mild-moderate PSD.</p>
                                      <p><strong>3. SSRI pharmacotherapy:</strong> For moderate-severe PSD (PHQ-9 ≥10). Sertraline or escitalopram preferred. NOT for functional motor recovery (FOCUS, AFFINITY, EFFECTS trials — Class III: No Benefit).</p>
                                      <p><strong>4. Monitoring:</strong> Check BMP at 2 weeks (SIADH/hyponatremia risk with SSRIs). Repeat PHQ-9 at 4-6 weeks. Assess for suicidality.</p>
                                      <p><strong>5. Follow-up schedule:</strong> Screen at discharge, 1 month, 3 months, 6 months, 12 months post-stroke.</p>
                                      <p><strong>6. Referral:</strong> Psychiatry if suicidal ideation, bipolar features, or refractory to initial treatment. Neuropsychology for cognitive-emotional overlap.</p>
                                    </div>
                                  </div>
                                )}
                              </div>

                              {/* MoCA Reference */}
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <h4 className="font-semibold text-purple-800 mb-2">MoCA Cognitive Screening</h4>
                                <div className="flex items-center gap-3">
                                  <div className="flex-1">
                                    <label className="text-sm text-slate-700">MoCA Score (0-30):</label>
                                    <input
                                      type="number"
                                      min="0" max="30"
                                      value={(telestrokeNote.screeningTools || {}).mocaScore || ''}
                                      onChange={(e) => {
                                        const v = e.target.value;
                                        setTelestrokeNote(prev => {
                                          const st = {...(prev.screeningTools || {}), mocaScore: v};
                                          return {...prev, screeningTools: st};
                                        });
                                      }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm mt-1"
                                      placeholder="Enter score"
                                    />
                                  </div>
                                  <label className="flex items-center gap-2 mt-4">
                                    <input type="checkbox"
                                      checked={!!(telestrokeNote.screeningTools || {}).mocaReferral}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, screeningTools: {...(prev.screeningTools || {}), mocaReferral: c}})); }}
                                      className="text-purple-600" />
                                    <span className="text-sm">Neuropsych referral</span>
                                  </label>
                                </div>
                                {parseInt((telestrokeNote.screeningTools || {}).mocaScore, 10) > 0 && (
                                  <div className={`mt-2 p-2 rounded text-sm ${parseInt((telestrokeNote.screeningTools || {}).mocaScore, 10) >= 26 ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800'}`}>
                                    {parseInt((telestrokeNote.screeningTools || {}).mocaScore, 10) >= 26 ? 'Normal cognition (>=26)' : `Below normal (${(telestrokeNote.screeningTools || {}).mocaScore}/30) — consider neuropsych referral`}
                                  </div>
                                )}
                                <p className="text-xs text-slate-500 mt-1">Administer MoCA at follow-up (not acute phase). Add 1 point if education &le;12 years. <a href="https://mocatest.org" target="_blank" rel="noopener noreferrer" className="text-purple-600 underline">mocatest.org</a></p>
                              </div>

                              {/* STOP-BANG OSA Screening */}
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 className="font-semibold text-blue-800 mb-2">STOP-BANG OSA Screening</h4>
                                <div className="grid grid-cols-2 gap-1">
                                  {[
                                    { key: 'sb_snoring', label: 'Snoring (loud)' },
                                    { key: 'sb_tired', label: 'Tired/sleepy during day' },
                                    { key: 'sb_observed', label: 'Observed apneas' },
                                    { key: 'sb_pressure', label: 'Treated for high BP' },
                                    { key: 'sb_bmi', label: 'BMI > 35' },
                                    { key: 'sb_age', label: 'Age > 50' },
                                    { key: 'sb_neck', label: 'Neck circumference > 40cm' },
                                    { key: 'sb_gender', label: 'Male gender' }
                                  ].map(item => (
                                    <label key={item.key} className="flex items-center gap-2 py-0.5">
                                      <input type="checkbox"
                                        checked={!!(telestrokeNote.screeningTools || {})[item.key]}
                                        onChange={(e) => {
                                          const k = item.key, c = e.target.checked;
                                          setTelestrokeNote(prev => {
                                            const st = {...(prev.screeningTools || {}), [k]: c};
                                            const score = ['sb_snoring','sb_tired','sb_observed','sb_pressure','sb_bmi','sb_age','sb_neck','sb_gender'].filter(sk => st[sk]).length;
                                            st.stopBangScore = score.toString();
                                            st.stopBangPositive = score >= 3;
                                            return {...prev, screeningTools: st};
                                          });
                                        }}
                                        className="text-blue-600" />
                                      <span className="text-xs text-slate-700">{item.label}</span>
                                    </label>
                                  ))}
                                </div>
                                {(telestrokeNote.screeningTools || {}).stopBangScore && (
                                  <div className={`mt-2 p-2 rounded text-sm font-medium ${parseInt((telestrokeNote.screeningTools || {}).stopBangScore, 10) >= 5 ? 'bg-red-100 text-red-800' : parseInt((telestrokeNote.screeningTools || {}).stopBangScore, 10) >= 3 ? 'bg-amber-100 text-amber-800' : 'bg-emerald-100 text-emerald-800'}`}>
                                    STOP-BANG: {(telestrokeNote.screeningTools || {}).stopBangScore}/8
                                    {parseInt((telestrokeNote.screeningTools || {}).stopBangScore, 10) >= 5 ? ' — HIGH risk OSA: order sleep study' : parseInt((telestrokeNote.screeningTools || {}).stopBangScore, 10) >= 3 ? ' — INTERMEDIATE risk: consider sleep study' : ' — Low risk'}
                                  </div>
                                )}
                              </div>

                              {/* Post-Stroke Seizure Risk */}
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <h4 className="font-semibold text-amber-800 mb-2">Post-Stroke Seizure Management</h4>
                                <select
                                  value={(telestrokeNote.screeningTools || {}).seizureRisk || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, screeningTools: {...(prev.screeningTools || {}), seizureRisk: v}})); }}
                                  className="w-full px-2 py-1 border border-slate-300 rounded text-sm"
                                >
                                  <option value="">-- Seizure status --</option>
                                  <option value="no-seizure">No seizure activity</option>
                                  <option value="acute-seizure">Acute symptomatic seizure (within 7 days)</option>
                                  <option value="late-seizure">Late seizure (after 7 days)</option>
                                  <option value="status-epilepticus">Status epilepticus</option>
                                </select>
                                <div className="text-xs text-slate-600 mt-2 space-y-1">
                                  <p>• <strong>Acute symptomatic seizure:</strong> Short-term ASM (7 days for ICH; case-by-case for ischemic). No routine prophylaxis.</p>
                                  <p>• <strong>Late seizure (&gt;7 days):</strong> Start ASM; risk of recurrence is high (~70%). Levetiracetam or lacosamide preferred.</p>
                                  <p>• <strong>Routine prophylactic ASM:</strong> NOT recommended (Class III) for ischemic stroke. May consider 7-day prophylaxis for lobar ICH (Class IIb).</p>
                                </div>
                              </div>
                            </div>
                          </details>
                        )}

                        {/* ========== SECONDARY PREVENTION DASHBOARD ========== */}
                        {telestrokeNote.diagnosis && getPathwayForDiagnosis(telestrokeNote.diagnosis) !== 'mimic' && (
                          <details className="bg-white border border-emerald-200 rounded-xl shadow-md">
                            <summary className="cursor-pointer p-4 font-semibold text-emerald-900 hover:bg-emerald-50 rounded-lg flex items-center justify-between">
                              <span className="flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="shield" className="w-5 h-5 text-emerald-600"></i>
                                Secondary Prevention Dashboard
                              </span>
                              <span className="text-xs text-emerald-500 font-normal">BP, LDL, Diabetes, Smoking, Exercise, Diet</span>
                            </summary>
                            <div className="p-4 pt-0 space-y-4">
                              {/* BP Management */}
                              <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                <h4 className="font-semibold text-red-800 mb-2">Blood Pressure Target</h4>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                  <div>
                                    <label htmlFor="input-bp-meds-mgmt" className="text-xs text-slate-600">Current BP Meds</label>
                                    <input id="input-bp-meds-mgmt" type="text" value={(telestrokeNote.secondaryPrevention || {}).bpMeds || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), bpMeds: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="e.g., lisinopril 10mg, amlodipine 5mg" />
                                  </div>
                                  <div>
                                    <label htmlFor="input-bp-target-mgmt" className="text-xs text-slate-600">Target</label>
                                    <select id="input-bp-target-mgmt" value={(telestrokeNote.secondaryPrevention || {}).bpTarget || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), bpTarget: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                      <option value="">Select</option>
                                      <option value="<130/80">&lt;130/80 (standard, Class I)</option>
                                      <option value="<120/80">&lt;120/80 (intensive — SPS3, RESPECT-ESUS subgroup)</option>
                                      <option value="<140/90">&lt;140/90 (if tolerability concern)</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label className="flex items-center gap-1 text-xs mt-4">
                                      <input type="checkbox" checked={!!(telestrokeNote.secondaryPrevention || {}).bpIntensiveCandidate}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), bpIntensiveCandidate: c}})); }} />
                                      Intensive BP candidate (lacunar/small vessel)
                                    </label>
                                  </div>
                                </div>
                              </div>

                              {/* LDL Ladder */}
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <h4 className="font-semibold text-amber-800 mb-2">LDL Target: &lt;55 mg/dL optimal, &lt;70 minimum (TST, SPARCL)</h4>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                  <div>
                                    <label className="text-xs text-slate-600">Current LDL</label>
                                    <input type="number" min="10" max="500" value={(telestrokeNote.secondaryPrevention || {}).ldlCurrent || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), ldlCurrent: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="mg/dL" />
                                  </div>
                                  <div>
                                    <label className="text-xs text-slate-600">Statin</label>
                                    <select value={(telestrokeNote.secondaryPrevention || {}).statinDose || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), statinDose: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                      <option value="">Select statin</option>
                                      <option value="atorvastatin-80">Atorvastatin 80mg</option>
                                      <option value="atorvastatin-40">Atorvastatin 40mg</option>
                                      <option value="rosuvastatin-20">Rosuvastatin 20mg</option>
                                      <option value="rosuvastatin-40">Rosuvastatin 40mg</option>
                                    </select>
                                  </div>
                                  <div className="flex flex-col gap-1">
                                    <label className="flex items-center gap-1 text-xs">
                                      <input type="checkbox" checked={!!(telestrokeNote.secondaryPrevention || {}).ezetimibeAdded}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), ezetimibeAdded: c}})); }} />
                                      + Ezetimibe 10mg
                                    </label>
                                    <label className="flex items-center gap-1 text-xs">
                                      <input type="checkbox" checked={!!(telestrokeNote.secondaryPrevention || {}).pcsk9Added}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), pcsk9Added: c}})); }} />
                                      + PCSK9i (evolocumab/alirocumab)
                                    </label>
                                    <label className="flex items-center gap-1 text-xs">
                                      <input type="checkbox" checked={!!(telestrokeNote.secondaryPrevention || {}).inclisiranConsidered}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), inclisiranConsidered: c}})); }} />
                                      + Inclisiran (siRNA, q6mo injection)
                                    </label>
                                  </div>
                                </div>
                                <p className="text-xs text-slate-500 mt-1">Ladder: High-intensity statin → add ezetimibe → add PCSK9i or inclisiran. TST trial: LDL &lt;70 reduced recurrent stroke by 22%. FOURIER subanalysis supports LDL &lt;40 in high-risk ASCVD.</p>
                              </div>

                              {/* Antiplatelet Selection */}
                              <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                <h4 className="font-semibold text-emerald-800 mb-2">Antiplatelet / Antithrombotic Selection</h4>
                                <select value={(telestrokeNote.secondaryPrevention || {}).antiplateletRegimen || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), antiplateletRegimen: v}})); }}
                                  aria-label="Antiplatelet regimen"
                                  className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                  <option value="">-- Select regimen --</option>
                                  <option value="dapt-21">DAPT x 21d: ASA + clopidogrel (NIHSS &le;3, CHANCE/POINT)</option>
                                  <option value="dapt-ticagrelor-30">DAPT x 30d: ASA + ticagrelor (NIHSS &le;5, THALES)</option>
                                  <option value="dapt-cyp2c19">DAPT x 21d: ASA + ticagrelor (CYP2C19 LOF, CHANCE-2)</option>
                                  <option value="asa-mono">ASA 81-325 mg monotherapy</option>
                                  <option value="clopidogrel-mono">Clopidogrel 75 mg monotherapy</option>
                                  <option value="asa-er-dipyridamole">ASA/ER-Dipyridamole (Aggrenox)</option>
                                  <option value="doac-af">DOAC for AF (per CATALYST timing)</option>
                                  <option value="anticoag-other">Anticoagulation (other indication)</option>
                                </select>
                                {((telestrokeNote.secondaryPrevention || {}).antiplateletRegimen || '').startsWith('dapt') && (
                                  <select value={(telestrokeNote.secondaryPrevention || {}).daptDuration || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), daptDuration: v}})); }}
                                    className="w-full mt-2 px-2 py-1 border border-slate-300 rounded text-sm">
                                    <option value="">-- DAPT duration --</option>
                                    <option value="21 days">21 days (POINT/CHANCE)</option>
                                    <option value="30 days">30 days (THALES)</option>
                                    <option value="90 days">90 days (CHANCE-2)</option>
                                  </select>
                                )}
                              </div>

                              {/* Diabetes, Smoking, Exercise, Diet */}
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-orange-800 mb-2 text-sm">Diabetes</h4>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).diabetesManagement || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), diabetesManagement: v}})); }}
                                    aria-label="Diabetes management"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                    <option value="">Select</option>
                                    <option value="no-diabetes">No diabetes</option>
                                    <option value="well-controlled">Diabetes — well controlled (A1c &lt;7%)</option>
                                    <option value="needs-optimization">Diabetes — needs optimization</option>
                                    <option value="new-diagnosis">New diabetes diagnosis</option>
                                  </select>
                                </div>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-blue-800 mb-2 text-sm">Smoking</h4>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).smokingStatus || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), smokingStatus: v}})); }}
                                    aria-label="Smoking status"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                    <option value="">Select</option>
                                    <option value="never">Never smoker</option>
                                    <option value="former">Former smoker</option>
                                    <option value="current">Current smoker — cessation counseled</option>
                                    <option value="current-rx">Current smoker — pharmacotherapy started</option>
                                  </select>
                                </div>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-blue-800 mb-2 text-sm">Exercise</h4>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).exercisePlan || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), exercisePlan: v}})); }}
                                    aria-label="Exercise plan"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                    <option value="">Select</option>
                                    <option value="active">Already physically active (&ge;150 min/wk)</option>
                                    <option value="counseled">Exercise counseling provided (target 150 min/wk)</option>
                                    <option value="limited">Limited by disability — PT/OT referral</option>
                                  </select>
                                  <div className="mt-1">
                                    <label className="text-xs text-slate-500">Current min/week:</label>
                                    <input type="number" value={(telestrokeNote.secondaryPrevention || {}).exerciseMinPerWeek || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), exerciseMinPerWeek: v}})); }}
                                      className="w-20 ml-1 px-2 py-1.5 border border-slate-300 rounded text-xs" placeholder="0" />
                                  </div>
                                </div>
                                <div className="bg-lime-50 border border-lime-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-lime-800 mb-2 text-sm">Diet</h4>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).dietPlan || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), dietPlan: v}})); }}
                                    aria-label="Diet plan"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                    <option value="">Select</option>
                                    <option value="mediterranean">Mediterranean diet (Class I — PREDIMED, 2024 AHA upgrade)</option>
                                    <option value="dash">DASH diet</option>
                                    <option value="sodium-restriction">Sodium restriction (&lt;2.3g/day)</option>
                                    <option value="dietitian">Dietitian referral placed</option>
                                  </select>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).dietAdherence || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), dietAdherence: v}})); }}
                                    aria-label="Diet adherence"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-xs mt-1">
                                    <option value="">Adherence</option>
                                    <option value="good">Good adherence</option>
                                    <option value="partial">Partial adherence</option>
                                    <option value="poor">Poor adherence — reinforce counseling</option>
                                  </select>
                                </div>
                              </div>

                              {/* GLP-1 RA, SGLT2i, Colchicine, CYP2C19 */}
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div className="bg-violet-50 border border-violet-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-violet-800 mb-2 text-sm">GLP-1 Receptor Agonist</h4>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).glp1ra || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), glp1ra: v}})); }}
                                    aria-label="GLP-1 receptor agonist"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                    <option value="">Select</option>
                                    <option value="semaglutide-2.4">Semaglutide 2.4 mg SC weekly</option>
                                    <option value="semaglutide-1.0">Semaglutide 1.0 mg SC weekly</option>
                                    <option value="liraglutide">Liraglutide 1.8 mg SC daily</option>
                                    <option value="dulaglutide">Dulaglutide 1.5 mg SC weekly</option>
                                    <option value="not-indicated">Not indicated</option>
                                  </select>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).glp1raIndication || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), glp1raIndication: v}})); }}
                                    aria-label="GLP-1 RA indication"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-xs mt-1">
                                    <option value="">Indication</option>
                                    <option value="overweight-ascvd">Overweight/obesity + ASCVD (SELECT trial)</option>
                                    <option value="t2dm">T2DM (SUSTAIN-6, SOUL)</option>
                                    <option value="both">Both obesity + T2DM</option>
                                  </select>
                                  <p className="text-xs text-slate-500 mt-1">SELECT: semaglutide 2.4mg reduced MACE 20% in overweight/obese patients with ASCVD (HR 0.80). SOUL: stroke reduction with oral semaglutide in T2DM.</p>
                                </div>
                                <div className="bg-sky-50 border border-sky-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-sky-800 mb-2 text-sm">SGLT2 Inhibitor</h4>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).sglt2i || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), sglt2i: v}})); }}
                                    aria-label="SGLT2 inhibitor"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                    <option value="">Select</option>
                                    <option value="empagliflozin">Empagliflozin 10mg daily</option>
                                    <option value="dapagliflozin">Dapagliflozin 10mg daily</option>
                                    <option value="sotagliflozin">Sotagliflozin 200mg daily</option>
                                    <option value="not-indicated">Not indicated</option>
                                  </select>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).sglt2iIndication || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), sglt2iIndication: v}})); }}
                                    aria-label="SGLT2i indication"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-xs mt-1">
                                    <option value="">Indication</option>
                                    <option value="hf">Heart failure (HFrEF or HFpEF)</option>
                                    <option value="ckd">CKD (eGFR 20-60)</option>
                                    <option value="t2dm-ascvd">T2DM + ASCVD</option>
                                    <option value="sotagliflozin-af-hf-dm">Sotagliflozin for AF + HF + DM (SCORED/SOLOIST)</option>
                                  </select>
                                  <p className="text-xs text-slate-500 mt-1">SGLT2i primarily for cardiorenal protection; not direct stroke prevention. Sotagliflozin exception: reduced stroke in DM + HF.</p>
                                </div>
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-red-800 mb-2 text-sm">Colchicine</h4>
                                  <label className="flex items-center gap-2 mb-1">
                                    <input type="checkbox" checked={!!(telestrokeNote.secondaryPrevention || {}).colchicineConsidered}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), colchicineConsidered: c}})); }} />
                                    <span className="text-sm">Colchicine 0.5 mg daily considered</span>
                                  </label>
                                  <select value={(telestrokeNote.secondaryPrevention || {}).colchicineIndication || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), colchicineIndication: v}})); }}
                                    aria-label="Colchicine indication"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                    <option value="">Indication</option>
                                    <option value="atherosclerotic-stroke">Atherosclerotic stroke with hsCRP elevation</option>
                                    <option value="recurrent-ascvd">Recurrent ASCVD events</option>
                                    <option value="not-indicated">Not indicated</option>
                                  </select>
                                  <p className="text-xs text-slate-500 mt-1">CONVINCE: reduced recurrent vascular events post-stroke. CHANCE-3: colchicine + DAPT for minor stroke/TIA. Avoid if eGFR &lt;30.</p>
                                </div>
                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-amber-800 mb-2 text-sm">CYP2C19 Pharmacogenomics</h4>
                                  <label className="flex items-center gap-2 mb-1">
                                    <input type="checkbox" checked={!!(telestrokeNote.secondaryPrevention || {}).cyp2c19Tested}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), cyp2c19Tested: c}})); }} />
                                    <span className="text-sm">CYP2C19 genotyping ordered/available</span>
                                  </label>
                                  {(telestrokeNote.secondaryPrevention || {}).cyp2c19Tested && (
                                    <select value={(telestrokeNote.secondaryPrevention || {}).cyp2c19Result || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), cyp2c19Result: v}})); }}
                                      aria-label="CYP2C19 result"
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">Result</option>
                                      <option value="normal-metabolizer">Normal metabolizer (*1/*1) — clopidogrel OK</option>
                                      <option value="intermediate">Intermediate metabolizer (*1/*2, *1/*3)</option>
                                      <option value="poor-metabolizer">Poor metabolizer (*2/*2, *2/*3, *3/*3) — avoid clopidogrel</option>
                                      <option value="rapid-metabolizer">Rapid/ultra-rapid metabolizer</option>
                                      <option value="pending">Result pending</option>
                                    </select>
                                  )}
                                  {(telestrokeNote.secondaryPrevention || {}).cyp2c19Result === 'poor-metabolizer' && (
                                    <div className="mt-1 p-1 bg-red-100 rounded text-xs text-red-700">
                                      CYP2C19 LOF: Switch to ticagrelor 90mg BID or prasugrel 10mg daily (CHANCE-2: ticagrelor + ASA superior to clopidogrel + ASA in LOF carriers).
                                    </div>
                                  )}
                                  {(telestrokeNote.secondaryPrevention || {}).cyp2c19Result === 'intermediate' && (
                                    <div className="mt-1 p-1 bg-amber-100 rounded text-xs text-amber-700">
                                      Intermediate metabolizer: Consider ticagrelor 90mg BID. CHANCE-2 showed benefit in both intermediate and poor metabolizers.
                                    </div>
                                  )}
                                </div>
                              </div>

                              {/* Drug Interaction Alerts */}
                              <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                                <h4 className="font-semibold text-red-800 mb-2">Drug Interaction Safety Panel</h4>
                                <div className="space-y-3">
                                  {/* AED-DOAC Interaction */}
                                  <div className="bg-white border border-red-200 rounded p-2">
                                    <h5 className="text-xs font-semibold text-red-700 mb-1">AED–DOAC Interaction Check</h5>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                      <div>
                                        <label className="text-xs text-slate-600">Antiepileptic Drug</label>
                                        <select value={(telestrokeNote.drugInteractions || {}).aedType || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, drugInteractions: {...(prev.drugInteractions || {}), aedType: v, aedDoacInteraction: ['phenytoin','carbamazepine','phenobarbital'].includes(v)}})); }}
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                          <option value="">None / Select</option>
                                          <option value="levetiracetam">Levetiracetam (no interaction)</option>
                                          <option value="lacosamide">Lacosamide (no interaction)</option>
                                          <option value="valproate">Valproate (minimal)</option>
                                          <option value="phenytoin">Phenytoin (STRONG CYP3A4/P-gp inducer)</option>
                                          <option value="carbamazepine">Carbamazepine (STRONG CYP3A4/P-gp inducer)</option>
                                          <option value="phenobarbital">Phenobarbital (STRONG CYP3A4 inducer)</option>
                                          <option value="oxcarbazepine">Oxcarbazepine (moderate inducer)</option>
                                        </select>
                                      </div>
                                      <div>
                                        <label className="flex items-center gap-1 text-xs mt-3">
                                          <input type="checkbox" checked={!!(telestrokeNote.drugInteractions || {}).doacDoseAppropriate}
                                            onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, drugInteractions: {...(prev.drugInteractions || {}), doacDoseAppropriate: c}})); }} />
                                          DOAC dose verified appropriate
                                        </label>
                                      </div>
                                    </div>
                                    {(telestrokeNote.drugInteractions || {}).aedDoacInteraction && (
                                      <div className="mt-1 p-2 bg-red-100 border border-red-300 rounded text-xs text-red-800">
                                        <strong>WARNING:</strong> Enzyme-inducing AED significantly reduces DOAC levels. Consider: (1) Switch AED to non-inducing agent, (2) Use warfarin with INR monitoring instead, or (3) Check drug levels if available. <em>EHRA 2021 Practical Guide.</em>
                                      </div>
                                    )}
                                  </div>

                                  {/* Statin Interaction */}
                                  <div className="bg-white border border-amber-200 rounded p-2">
                                    <h5 className="text-xs font-semibold text-amber-700 mb-1">Statin Interaction Check</h5>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                      <div>
                                        <label className="text-xs text-slate-600">Interacting Drug</label>
                                        <select value={(telestrokeNote.drugInteractions || {}).statinInteractionDrug || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, drugInteractions: {...(prev.drugInteractions || {}), statinInteractionDrug: v, statinInteraction: !!v}})); }}
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                          <option value="">None</option>
                                          <option value="diltiazem">Diltiazem (CYP3A4 inhibitor)</option>
                                          <option value="verapamil">Verapamil (CYP3A4 inhibitor)</option>
                                          <option value="amiodarone">Amiodarone (CYP3A4 inhibitor)</option>
                                          <option value="cyclosporine">Cyclosporine</option>
                                          <option value="clarithromycin">Clarithromycin (CYP3A4 inhibitor)</option>
                                          <option value="fluconazole">Fluconazole (CYP2C9 inhibitor)</option>
                                        </select>
                                      </div>
                                    </div>
                                    {(telestrokeNote.drugInteractions || {}).statinInteraction && (
                                      <div className="mt-1 p-2 bg-amber-100 rounded text-xs text-amber-800">
                                        <strong>Statin dose adjustment needed:</strong> With CYP3A4 inhibitors, limit simvastatin to 20mg, atorvastatin to 40mg. Consider rosuvastatin (minimal CYP3A4 metabolism). Monitor for myopathy.
                                      </div>
                                    )}
                                  </div>

                                  {/* DOAC Dose Reduction Criteria — Dynamic Renal Safety Engine */}
                                  {(() => {
                                    const patientCrCl = calculateCrCl(telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.height);
                                    const crclVal = patientCrCl ? patientCrCl.value : null;
                                    const patientAge = parseFloat(telestrokeNote.age) || 0;
                                    const patientWt = parseFloat(telestrokeNote.weight) || 0;
                                    const patientCr = parseFloat(telestrokeNote.creatinine) || 0;
                                    const selectedDoac = (telestrokeNote.drugInteractions || {}).doacDoseReductionCriteria || '';

                                    // Apixaban: count dose-reduction criteria (age ≥80, wt ≤60kg, Cr ≥1.5)
                                    const apixReductionCount = (patientAge >= 80 ? 1 : 0) + (patientWt > 0 && patientWt <= 60 ? 1 : 0) + (patientCr >= 1.5 ? 1 : 0);
                                    const apixNeedsReduction = apixReductionCount >= 2;

                                    return (
                                      <div className="bg-white border border-blue-200 rounded p-2">
                                        <h5 className="text-xs font-semibold text-blue-700 mb-1">DOAC Dose Reduction Checker {crclVal !== null && <span className="font-normal text-slate-500">(Patient CrCl: {crclVal} mL/min)</span>}</h5>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                          <div>
                                            <label className="text-xs text-slate-600">DOAC Agent</label>
                                            <select value={selectedDoac}
                                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, drugInteractions: {...(prev.drugInteractions || {}), doacDoseReductionCriteria: v}})); }}
                                              className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                              <option value="">Select DOAC</option>
                                              <option value="apixaban">Apixaban</option>
                                              <option value="rivaroxaban">Rivaroxaban</option>
                                              <option value="dabigatran">Dabigatran</option>
                                              <option value="edoxaban">Edoxaban</option>
                                            </select>
                                          </div>
                                        </div>
                                        {selectedDoac === 'apixaban' && (
                                          <div className={`mt-1 p-2 rounded text-xs ${apixNeedsReduction ? 'bg-red-100 border border-red-300 text-red-800' : 'bg-emerald-50 border border-emerald-200 text-emerald-800'}`}>
                                            {apixNeedsReduction ? (
                                              <><strong>DOSE REDUCTION REQUIRED:</strong> Apixaban <strong>2.5mg BID</strong>. Patient meets ≥2 of 3 criteria: {patientAge >= 80 ? 'age ≥80' : ''}{patientWt > 0 && patientWt <= 60 ? `${patientAge >= 80 ? ', ' : ''}wt ≤60kg` : ''}{patientCr >= 1.5 ? `${(patientAge >= 80 || (patientWt > 0 && patientWt <= 60)) ? ', ' : ''}Cr ≥1.5` : ''} ({apixReductionCount}/3 criteria met). ARISTOTLE.</>
                                            ) : patientAge > 0 || patientWt > 0 || patientCr > 0 ? (
                                              <><strong>Standard dose: Apixaban 5mg BID.</strong> Patient has {apixReductionCount}/3 reduction criteria{apixReductionCount === 1 ? ' — do NOT reduce for single criterion' : ''}. (ARISTOTLE)</>
                                            ) : (
                                              <>Apixaban 2.5mg BID if ≥2 of: age ≥80, weight ≤60kg, Cr ≥1.5. <strong>Do NOT reduce dose for single criterion</strong> (ARISTOTLE).</>
                                            )}
                                            {!patientWt && <p className="text-amber-600 text-xs mt-1">Weight not entered — cannot fully assess dose reduction criteria.</p>}
                                            {patientCr > 2.0 && <p className="text-amber-600 text-xs mt-1">Cr {patientCr} — verify this is baseline creatinine, not AKI.</p>}
                                          </div>
                                        )}
                                        {selectedDoac === 'rivaroxaban' && (
                                          <div className={`mt-1 p-2 rounded text-xs ${crclVal !== null && crclVal < 15 ? 'bg-red-100 border border-red-300 text-red-800' : crclVal !== null && crclVal <= 50 ? 'bg-amber-100 border border-amber-200 text-amber-800' : 'bg-emerald-50 border border-emerald-200 text-emerald-800'}`}>
                                            {crclVal !== null && crclVal < 15 ? (
                                              <><strong>AVOID:</strong> Rivaroxaban contraindicated with CrCl &lt;15 mL/min (patient: {crclVal}).</>
                                            ) : crclVal !== null && crclVal <= 50 ? (
                                              <><strong>DOSE REDUCTION:</strong> Rivaroxaban <strong>15mg daily</strong> (CrCl {crclVal} mL/min, range 15-50). Take with evening meal. (ROCKET-AF)</>
                                            ) : crclVal !== null ? (
                                              <><strong>Standard dose: Rivaroxaban 20mg daily</strong> with evening meal (CrCl {crclVal} mL/min). (ROCKET-AF)</>
                                            ) : (
                                              <>Rivaroxaban 15mg daily if CrCl 15-50. Avoid if CrCl &lt;15. Take with evening meal (ROCKET-AF).</>
                                            )}
                                          </div>
                                        )}
                                        {selectedDoac === 'dabigatran' && (
                                          <div className={`mt-1 p-2 rounded text-xs ${crclVal !== null && crclVal < 15 ? 'bg-red-100 border border-red-300 text-red-800' : crclVal !== null && crclVal < 30 ? 'bg-amber-100 border border-amber-200 text-amber-800' : 'bg-emerald-50 border border-emerald-200 text-emerald-800'}`}>
                                            {crclVal !== null && crclVal < 15 ? (
                                              <><strong>AVOID:</strong> Dabigatran not recommended with CrCl &lt;15 mL/min (patient: {crclVal}).</>
                                            ) : crclVal !== null && crclVal < 30 ? (
                                              <><strong>DOSE REDUCTION:</strong> Dabigatran <strong>75mg BID</strong> (CrCl {crclVal} mL/min). Idarucizumab available for reversal. (RE-LY, RE-VERSE AD)</>
                                            ) : crclVal !== null && crclVal < 50 ? (
                                              <><strong>Consider reduced dose:</strong> Dabigatran <strong>75mg BID</strong> per FDA labeling for CrCl 30-49 with concomitant P-gp inhibitor (dronedarone, ketoconazole) or high bleed risk; otherwise <strong>150mg BID</strong> (CrCl {crclVal} mL/min). (RE-LY)</>
                                            ) : crclVal !== null ? (
                                              <><strong>Standard dose: Dabigatran 150mg BID</strong> (CrCl {crclVal} mL/min). Reduce to 75mg BID if concomitant P-gp inhibitor (dronedarone, ketoconazole). (RE-LY)</>
                                            ) : (
                                              <>Dabigatran 75mg BID if CrCl 15-30, or CrCl 30-50 with P-gp inhibitor (dronedarone, ketoconazole). Avoid if CrCl &lt;15. Idarucizumab for reversal (RE-LY, RE-VERSE AD).</>
                                            )}
                                          </div>
                                        )}
                                        {selectedDoac === 'edoxaban' && (() => {
                                          const edoxWeightReduce = patientWt > 0 && patientWt <= 60;
                                          const edoxNeedsReduction = (crclVal !== null && crclVal <= 50) || edoxWeightReduce;
                                          const edoxAvoid = crclVal !== null && (crclVal > 95 || crclVal < 15);
                                          return (
                                          <div className={`mt-1 p-2 rounded text-xs ${edoxAvoid ? 'bg-red-100 border border-red-300 text-red-800' : edoxNeedsReduction ? 'bg-amber-100 border border-amber-200 text-amber-800' : 'bg-emerald-50 border border-emerald-200 text-emerald-800'}`}>
                                            {crclVal !== null && crclVal > 95 ? (
                                              <><strong>AVOID:</strong> Edoxaban has <strong>reduced efficacy</strong> with CrCl &gt;95 mL/min (patient: {crclVal}). Use alternative DOAC. (ENGAGE AF-TIMI 48)</>
                                            ) : crclVal !== null && crclVal < 15 ? (
                                              <><strong>AVOID:</strong> Edoxaban not recommended with CrCl &lt;15 mL/min (patient: {crclVal}).</>
                                            ) : crclVal !== null && crclVal <= 50 ? (
                                              <><strong>DOSE REDUCTION:</strong> Edoxaban <strong>30mg daily</strong> (CrCl {crclVal} mL/min{edoxWeightReduce ? `, wt ${patientWt}kg ≤60` : ''}). {!edoxWeightReduce ? 'Also reduce if wt ≤60kg or concomitant P-gp inhibitor. ' : ''}(ENGAGE AF-TIMI 48)</>
                                            ) : edoxWeightReduce ? (
                                              <><strong>DOSE REDUCTION:</strong> Edoxaban <strong>30mg daily</strong> — weight {patientWt}kg ≤60kg requires dose reduction regardless of CrCl{crclVal !== null ? ` (CrCl ${crclVal})` : ''}. Also reduce for concomitant P-gp inhibitor (verapamil, dronedarone, ketoconazole, erythromycin, cyclosporine). (ENGAGE AF-TIMI 48)</>
                                            ) : crclVal !== null ? (
                                              <><strong>Standard dose: Edoxaban 60mg daily</strong> (CrCl {crclVal} mL/min). Reduce to 30mg if wt ≤60kg or concomitant P-gp inhibitor (verapamil, dronedarone, ketoconazole, erythromycin, cyclosporine). (ENGAGE AF-TIMI 48)</>
                                            ) : (
                                              <>Edoxaban 30mg daily if CrCl 15-50 or weight ≤60kg or concomitant P-gp inhibitor (verapamil, dronedarone, ketoconazole, erythromycin, cyclosporine). Avoid if CrCl &gt;95 (reduced efficacy, ENGAGE AF-TIMI 48).</>
                                            )}
                                          </div>
                                          );
                                        })()}
                                      </div>
                                    );
                                  })()}
                                </div>
                              </div>

                              {/* DAPT Duration Guidance */}
                              <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                <h4 className="font-semibold text-orange-800 mb-2 text-sm">DAPT Duration</h4>
                                <div className="text-xs text-slate-700 space-y-1">
                                  <p><strong>NIHSS ≤3:</strong> DAPT (ASA + clopidogrel) x 21 days, then monotherapy (CHANCE/POINT, Class I).</p>
                                  <p><strong>NIHSS 4-5:</strong> ASA + ticagrelor x 30 days may be considered (THALES, Class IIb).</p>
                                  <p><strong>CYP2C19 LOF carrier (NIHSS ≤3):</strong> ASA + ticagrelor x 21 days, then ticagrelor monotherapy (CHANCE-2, Class IIb).</p>
                                  <p className="text-red-600 font-medium">Class III (Harm): DAPT beyond 90 days increases bleeding risk without benefit (MATCH).</p>
                                  <p><strong>ICAD-specific:</strong> ASA 325mg + clopidogrel 75mg x 90 days, then ASA 325mg monotherapy (SAMMPRIS).</p>
                                </div>
                              </div>

                              <div className="bg-white border border-slate-200 rounded-lg p-3">
                                <h4 className="font-semibold text-slate-800 mb-2 text-sm">DAPT Duration Trial-Matching Figure</h4>
                                <img
                                  src="documents/antiplatelet/DAPT%20After%20Ischemic%20Stroke-TIA.jpeg"
                                  alt="DAPT duration after ischemic stroke/TIA trial-matching summary"
                                  className="w-full h-auto rounded border border-slate-200"
                                  loading="lazy"
                                />
                              </div>

                              {/* Anticoagulant Bridging - PAUSE Protocol */}
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <h4 className="font-semibold text-purple-800 mb-2 text-sm">Anticoagulant Bridging (PAUSE Protocol)</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div>
                                    <label className="text-xs text-slate-600">DOAC Type</label>
                                    <select value={(telestrokeNote.anticoagBridging || {}).doacType || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, anticoagBridging: {...(prev.anticoagBridging || {}), doacType: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">Select</option>
                                      <option value="apixaban">Apixaban</option>
                                      <option value="rivaroxaban">Rivaroxaban</option>
                                      <option value="dabigatran">Dabigatran</option>
                                      <option value="edoxaban">Edoxaban</option>
                                      <option value="warfarin">Warfarin (see bridging below)</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label className="text-xs text-slate-600">CrCl (mL/min)</label>
                                    <input type="number" value={(telestrokeNote.anticoagBridging || {}).crCl || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, anticoagBridging: {...(prev.anticoagBridging || {}), crCl: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs" placeholder="mL/min" />
                                  </div>
                                  <div>
                                    <label className="text-xs text-slate-600">Procedure Risk</label>
                                    <select value={(telestrokeNote.anticoagBridging || {}).procedureRisk || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, anticoagBridging: {...(prev.anticoagBridging || {}), procedureRisk: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">Select</option>
                                      <option value="low">Low bleed risk</option>
                                      <option value="high">High bleed risk</option>
                                    </select>
                                  </div>
                                  <div>
                                    <label className="flex items-center gap-1 text-xs mt-3">
                                      <input type="checkbox" checked={!!(telestrokeNote.anticoagBridging || {}).warfarinBridgeIndication}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, anticoagBridging: {...(prev.anticoagBridging || {}), warfarinBridgeIndication: c}})); }} />
                                      Warfarin bridging indicated (mechanical valve / APS only)
                                    </label>
                                  </div>
                                </div>
                                {(telestrokeNote.anticoagBridging || {}).doacType && (telestrokeNote.anticoagBridging || {}).doacType !== 'warfarin' && (
                                  <div className="mt-2 p-2 bg-purple-100 rounded text-xs text-purple-800">
                                    <strong>PAUSE Protocol:</strong> DOACs — NO heparin bridging needed (Class I, LOE A). Hold {(telestrokeNote.anticoagBridging || {}).procedureRisk === 'high' ? '2-3 days' : '1-2 days'} pre-procedure{(telestrokeNote.anticoagBridging || {}).crCl && parseInt((telestrokeNote.anticoagBridging || {}).crCl, 10) < 50 && (telestrokeNote.anticoagBridging || {}).doacType === 'dabigatran' ? ' (extend to 4-5 days for dabigatran with CrCl <50)' : ''}. Resume 24-48h post-procedure (24h low risk, 48-72h high risk). BRIDGE trial: bridging with LMWH for warfarin increases bleeding without reducing thromboembolism.
                                  </div>
                                )}
                                {(telestrokeNote.anticoagBridging || {}).doacType === 'warfarin' && (
                                  <div className="mt-2 p-2 bg-amber-100 rounded text-xs text-amber-800">
                                    <strong>Warfarin periprocedural:</strong> Hold 5 days pre-procedure (target INR &lt;1.5). Bridge with LMWH ONLY if: mechanical mitral valve, mechanical aortic valve with additional risk factors, or antiphospholipid syndrome (Class I). For AF alone, do NOT bridge (BRIDGE trial).
                                  </div>
                                )}
                              </div>

                              {/* Statin After ICH & Pioglitazone */}
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 className="font-semibold text-blue-800 mb-2 text-sm">Additional Considerations</h4>
                                <div className="text-xs text-slate-700 space-y-2">
                                  <div className="p-2 bg-white border border-blue-100 rounded">
                                    <strong>Statin After ICH:</strong> AHA 2022 ICH guidelines — statins may be continued or started for patients with compelling cardiovascular indication (Class IIb, LOE B-NR). Avoid in lobar ICH with probable CAA unless strong ASCVD indication.
                                  </div>
                                  <div className="p-2 bg-white border border-blue-100 rounded">
                                    <strong>Pioglitazone (IRIS trial):</strong> For non-diabetic patients with insulin resistance (HOMA-IR &gt;3.0) and ischemic stroke/TIA, pioglitazone 15-45mg reduces recurrent stroke/MI (HR 0.76, NNT ~17 over 5y). Monitor weight, edema, fracture risk. Contraindicated in HF, bladder cancer. <em>Class IIa, LOE B-R.</em>
                                  </div>
                                </div>
                              </div>

                              {/* Follow-Up Timeline */}
                              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                <h4 className="font-semibold text-slate-800 mb-2">Follow-Up Timeline</h4>
                                <select value={(telestrokeNote.secondaryPrevention || {}).followUpTimeline || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, secondaryPrevention: {...(prev.secondaryPrevention || {}), followUpTimeline: v}})); }}
                                  aria-label="Follow-up timeline"
                                  className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                  <option value="">-- Select follow-up plan --</option>
                                  <option value="24-72h">24-72 hours (TIA, high recurrence risk, ABCD2 ≥4)</option>
                                  <option value="1-2wk">1-2 weeks (high risk, post-TNK, carotid surgery)</option>
                                  <option value="3mo">3 months (standard)</option>
                                  <option value="6mo">6 months</option>
                                  <option value="12mo">12 months</option>
                                  <option value="custom">Custom (specify in notes)</option>
                                </select>
                                <div className="text-xs text-slate-500 mt-1">
                                  Recommended schedule: 1-2 wk post-discharge, then 3 mo, 6 mo, 12 mo. Adjust based on severity and risk factors.
                                </div>
                              </div>
                            </div>
                          </details>
                        )}

                        {/* ========== ACUTE CARE PROTOCOLS ========== */}
                        {telestrokeNote.diagnosis && (getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' || getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ich') && (
                          <details className="bg-white border border-orange-200 rounded-xl shadow-md">
                            <summary className="cursor-pointer p-4 font-semibold text-orange-900 hover:bg-orange-50 rounded-lg flex items-center justify-between">
                              <span className="flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="clipboard-list" className="w-5 h-5 text-orange-600"></i>
                                Acute Care Protocols
                              </span>
                              <span className="text-xs text-orange-500 font-normal">HT, Angioedema, Dysphagia, Mobilization, Hyperglycemia, DOAC Timing, Carotid, ESUS, ICH Anticoag</span>
                            </summary>
                            <div className="p-4 pt-0 space-y-4">
                              {/* Hemorrhagic Transformation */}
                              {getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-red-800 mb-2">Hemorrhagic Transformation (HT) Monitoring</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                      <label className="flex items-center gap-2 mb-2">
                                        <input type="checkbox" checked={!!(telestrokeNote.hemorrhagicTransformation || {}).detected}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, hemorrhagicTransformation: {...(prev.hemorrhagicTransformation || {}), detected: c}})); }} />
                                        <span className="text-sm font-medium">HT detected on imaging</span>
                                      </label>
                                      {(telestrokeNote.hemorrhagicTransformation || {}).detected && (
                                        <div className="space-y-2 ml-6">
                                          <select aria-label="ECASS hemorrhagic transformation classification" value={(telestrokeNote.hemorrhagicTransformation || {}).classification || ''}
                                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, hemorrhagicTransformation: {...(prev.hemorrhagicTransformation || {}), classification: v}})); }}
                                            className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                            <option value="">ECASS Classification</option>
                                            <option value="HI-1">HI-1: Small petechiae along margin</option>
                                            <option value="HI-2">HI-2: Confluent petechiae, no mass effect</option>
                                            <option value="PH-1">PH-1: Hematoma &le;30% infarct, mild mass effect</option>
                                            <option value="PH-2">PH-2: Hematoma &gt;30% infarct, significant mass effect</option>
                                          </select>
                                          <label className="flex items-center gap-2">
                                            <input type="checkbox" checked={!!(telestrokeNote.hemorrhagicTransformation || {}).symptomatic}
                                              onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, hemorrhagicTransformation: {...(prev.hemorrhagicTransformation || {}), symptomatic: c}})); }} />
                                            <span className="text-xs text-red-700 font-medium">Symptomatic (sICH): NIHSS increase &ge;4 points</span>
                                          </label>
                                        </div>
                                      )}
                                    </div>
                                    <div>
                                      {(telestrokeNote.hemorrhagicTransformation || {}).detected && (
                                        <div className="space-y-2">
                                          <div className="text-xs text-slate-700 space-y-1">
                                            {((telestrokeNote.hemorrhagicTransformation || {}).classification || '').startsWith('HI') && (
                                              <p className="text-emerald-700">HI-1/2: Generally benign. May continue antiplatelets. Repeat imaging in 24h.</p>
                                            )}
                                            {(telestrokeNote.hemorrhagicTransformation || {}).classification === 'PH-1' && (
                                              <p className="text-amber-700">PH-1: Hold antithrombotics 24-48h. Repeat CT. Consider reversal if post-TNK and symptomatic.</p>
                                            )}
                                            {(telestrokeNote.hemorrhagicTransformation || {}).classification === 'PH-2' && (
                                              <p className="text-red-700">PH-2: Hold all antithrombotics. STAT labs (fibrinogen, platelets, INR). If post-TNK: cryoprecipitate 10U + TXA 1g. Neurosurgery consult.</p>
                                            )}
                                          </div>
                                          <label className="flex items-center gap-2">
                                            <input type="checkbox" checked={!!(telestrokeNote.hemorrhagicTransformation || {}).antithromboticHeld}
                                              onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, hemorrhagicTransformation: {...(prev.hemorrhagicTransformation || {}), antithromboticHeld: c}})); }} />
                                            <span className="text-xs">Antithrombotics held</span>
                                          </label>
                                          <label className="flex items-center gap-2">
                                            <input type="checkbox" checked={!!(telestrokeNote.hemorrhagicTransformation || {}).reimagingPlanned}
                                              onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, hemorrhagicTransformation: {...(prev.hemorrhagicTransformation || {}), reimagingPlanned: c}})); }} />
                                            <span className="text-xs">Repeat imaging planned</span>
                                          </label>
                                          <label className="block text-xs font-medium mt-2">Management Actions:</label>
                                          <textarea
                                            value={(telestrokeNote.hemorrhagicTransformation || {}).managementActions || ''}
                                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, hemorrhagicTransformation: {...(prev.hemorrhagicTransformation || {}), managementActions: v}})); }}
                                            placeholder="e.g., Cryoprecipitate 10U, TXA 1g IV, neurosurgery consulted..."
                                            className="w-full px-2 py-1 border border-slate-300 rounded text-xs h-16"
                                            aria-label="Hemorrhagic transformation management actions"
                                          />
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Post-TNK Orolingual Angioedema Protocol */}
                              {getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' && (telestrokeNote.tnkRecommended || telestrokeNote.tnkAdminTime) && (
                                <div className={'border rounded-lg p-3 ' + ((telestrokeNote.angioedema || {}).detected ? 'bg-red-50 border-red-300' : 'bg-orange-50 border-orange-200')}>
                                  <div className="flex items-center justify-between mb-2">
                                    <h4 className="font-semibold text-orange-800 flex items-center gap-2">
                                      Post-TNK Angioedema Protocol
                                      {(telestrokeNote.medications || '').toLowerCase().match(/lisinopril|enalapril|ramipril|captopril|benazepril|fosinopril|perindopril|quinapril|trandolapril|ace.?i/) && (
                                        <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-bold">ACEi detected — 5x risk</span>
                                      )}
                                    </h4>
                                    <span className="text-xs text-slate-500">Incidence: 1-5% post-thrombolysis</span>
                                  </div>

                                  <label className="flex items-center gap-2 mb-2">
                                    <input type="checkbox" checked={!!(telestrokeNote.angioedema || {}).detected}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, angioedema: {...(prev.angioedema || {}), detected: c}})); }}
                                      className="w-4 h-4" />
                                    <span className="text-sm font-medium text-red-800">Angioedema detected</span>
                                  </label>

                                  {(telestrokeNote.angioedema || {}).detected ? (
                                    <div className="space-y-3">
                                      <div className="flex gap-3 items-center">
                                        <label className="text-xs font-medium text-slate-700">Onset time:</label>
                                        <input type="time" value={(telestrokeNote.angioedema || {}).onsetTime || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, angioedema: {...(prev.angioedema || {}), onsetTime: v}})); }}
                                          className="px-2 py-1 border border-slate-300 rounded text-sm" />
                                        <select value={(telestrokeNote.angioedema || {}).severity || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, angioedema: {...(prev.angioedema || {}), severity: v}})); }}
                                          className="px-2 py-1 border border-slate-300 rounded text-sm">
                                          <option value="">Severity</option>
                                          <option value="mild">Mild — lip/facial swelling only</option>
                                          <option value="moderate">Moderate — tongue swelling, no airway compromise</option>
                                          <option value="severe">Severe — tongue/floor of mouth, airway compromise</option>
                                        </select>
                                      </div>

                                      {/* Stepwise Management Algorithm */}
                                      <div className="bg-white border border-red-200 rounded-lg p-3">
                                        <p className="text-xs font-bold text-red-800 mb-2">Stepwise Management (execute in order):</p>
                                        <div className="space-y-2">
                                          {[
                                            { id: 'stopTnk', step: 1, label: 'Stop TNK if still infusing + Hold ACE inhibitor', detail: 'Discontinue immediately. ACEi increases bradykinin — primary mediator.' },
                                            { id: 'steroids', step: 2, label: 'Methylprednisolone 125 mg IV + Diphenhydramine 50 mg IV + Famotidine 20 mg IV', detail: 'Standard antihistamine/steroid protocol. Onset 15-30 min.' },
                                            { id: 'epinephrine', step: 3, label: 'Epinephrine 0.3 mg IM (1:1000) if progressing', detail: 'For moderate-severe or any airway compromise. May repeat q5-15 min.' },
                                            { id: 'icatibant', step: 4, label: 'Icatibant 30 mg SC OR C1 esterase inhibitor 20 U/kg IV', detail: 'Bradykinin B2 receptor antagonist. For refractory angioedema not responding to steps 1-3. Consider early if ACEi-related mechanism suspected.' },
                                            { id: 'airway', step: 5, label: 'Prepare for intubation — call anesthesia/ENT', detail: 'Fiberoptic intubation preferred. Surgical airway backup if tongue/floor of mouth massive. Do NOT delay if stridor or desaturation.' }
                                          ].map(item => {
                                            const steps = (telestrokeNote.angioedema || {}).stepsTaken || {};
                                            const isChecked = !!steps[item.id];
                                            const severity = (telestrokeNote.angioedema || {}).severity;
                                            const isRecommended = item.step <= 2 || (severity === 'moderate' && item.step <= 3) || severity === 'severe';
                                            return (
                                              <div key={item.id} className={'flex items-start gap-2 p-2 rounded ' + (isChecked ? 'bg-emerald-50' : isRecommended ? 'bg-red-50' : 'bg-slate-50')}>
                                                <input type="checkbox" checked={isChecked}
                                                  onChange={(e) => { const id = item.id, c = e.target.checked; setTelestrokeNote(prev => ({...prev, angioedema: {...(prev.angioedema || {}), stepsTaken: {...((prev.angioedema || {}).stepsTaken || {}), [id]: c}}})); }}
                                                  className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                                <div className="min-w-0">
                                                  <div className="flex items-center gap-2">
                                                    <span className="text-xs font-bold text-slate-500">Step {item.step}</span>
                                                    <span className={'text-sm font-medium ' + (isChecked ? 'text-emerald-800 line-through' : 'text-slate-900')}>{item.label}</span>
                                                  </div>
                                                  <p className="text-xs text-slate-600 mt-0.5">{item.detail}</p>
                                                </div>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      </div>

                                      <div className="flex gap-4">
                                        <label className="flex items-center gap-2">
                                          <input type="checkbox" checked={!!(telestrokeNote.angioedema || {}).intubated}
                                            onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, angioedema: {...(prev.angioedema || {}), intubated: c}})); }} />
                                          <span className="text-xs font-medium text-red-700">Patient intubated</span>
                                        </label>
                                        <label className="flex items-center gap-2">
                                          <input type="checkbox" checked={!!(telestrokeNote.angioedema || {}).resolved}
                                            onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, angioedema: {...(prev.angioedema || {}), resolved: c}})); }} />
                                          <span className="text-xs font-medium text-emerald-700">Angioedema resolved</span>
                                        </label>
                                      </div>

                                      <label className="flex items-center gap-2">
                                        <input type="checkbox" checked={!!(telestrokeNote.angioedema || {}).aceInhibitorUse}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, angioedema: {...(prev.angioedema || {}), aceInhibitorUse: c}})); }} />
                                        <span className="text-xs">Patient was on ACE inhibitor (permanently discontinue)</span>
                                      </label>
                                    </div>
                                  ) : (
                                    <div className="text-xs text-slate-600 space-y-1">
                                      <p><strong>Monitor for:</strong> Lip, tongue, or oropharyngeal swelling within 2 hours of TNK. Higher risk with ACE inhibitor use (5x), anterior circulation infarcts involving insular cortex.</p>
                                      <p><strong>If detected:</strong> Check the box above to activate the stepwise management protocol.</p>
                                    </div>
                                  )}
                                </div>
                              )}

                              {/* Dysphagia Screening */}
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 className="font-semibold text-blue-800 mb-2">Dysphagia Screening Protocol</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="space-y-2">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.dysphagiaScreening || {}).bedsideScreenPerformed}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, dysphagiaScreening: {...(prev.dysphagiaScreening || {}), bedsideScreenPerformed: c}})); }} />
                                      <span className="text-sm">Bedside swallow screen performed</span>
                                    </label>
                                    {(telestrokeNote.dysphagiaScreening || {}).bedsideScreenPerformed && (
                                      <select value={(telestrokeNote.dysphagiaScreening || {}).bedsideScreenResult || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, dysphagiaScreening: {...(prev.dysphagiaScreening || {}), bedsideScreenResult: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm ml-6">
                                        <option value="">Result</option>
                                        <option value="pass">Pass — regular diet</option>
                                        <option value="fail">Fail — NPO, SLP consult</option>
                                        <option value="modified">Modified diet recommended</option>
                                      </select>
                                    )}
                                  </div>
                                  <div className="space-y-2">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.dysphagiaScreening || {}).npoStatus}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, dysphagiaScreening: {...(prev.dysphagiaScreening || {}), npoStatus: c}})); }} />
                                      <span className="text-sm">NPO until screened</span>
                                    </label>
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.dysphagiaScreening || {}).slpConsultOrdered}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, dysphagiaScreening: {...(prev.dysphagiaScreening || {}), slpConsultOrdered: c}})); }} />
                                      <span className="text-sm">SLP consult ordered</span>
                                    </label>
                                    <select value={(telestrokeNote.dysphagiaScreening || {}).instrumentalAssessment || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, dysphagiaScreening: {...(prev.dysphagiaScreening || {}), instrumentalAssessment: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">Instrumental assessment</option>
                                      <option value="vfss">VFSS (modified barium swallow)</option>
                                      <option value="fees">FEES (fiberoptic endoscopic evaluation)</option>
                                      <option value="not-needed">Not needed</option>
                                    </select>
                                  </div>
                                </div>
                                <p className="text-xs text-slate-500 mt-1">Class I: All stroke patients must have dysphagia screening before oral intake. Failed screen → NPO + SLP within 24h. Aspiration pneumonia risk increases 3x without screening.</p>
                              </div>

                              {/* Early Mobilization */}
                              <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                <h4 className="font-semibold text-emerald-800 mb-2">Early Mobilization (AVERT-Informed)</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div>
                                    <select value={(telestrokeNote.earlyMobilization || {}).timingDecision || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, earlyMobilization: {...(prev.earlyMobilization || {}), timingDecision: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                      <option value="">Mobilization timing</option>
                                      <option value="24-48h">24-48h post-onset (recommended)</option>
                                      <option value="deferred">Deferred &gt;48h (severe stroke, hemodynamic instability)</option>
                                      <option value="contraindicated">Contraindicated (active ICH expansion, unstable)</option>
                                    </select>
                                  </div>
                                  <div className="space-y-1">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.earlyMobilization || {}).mobilizationStarted}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, earlyMobilization: {...(prev.earlyMobilization || {}), mobilizationStarted: c}})); }} />
                                      <span className="text-sm">Mobilization initiated</span>
                                    </label>
                                    <select value={(telestrokeNote.earlyMobilization || {}).sessionFrequency || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, earlyMobilization: {...(prev.earlyMobilization || {}), sessionFrequency: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">Session frequency</option>
                                      <option value="short-frequent">Short, frequent sessions (AVERT protocol)</option>
                                      <option value="standard-pt">Standard PT schedule</option>
                                      <option value="intensive">Intensive rehab (&ge;3h/day)</option>
                                    </select>
                                  </div>
                                </div>
                                <p className="text-xs text-slate-500 mt-1">AVERT: Very early mobilization (&lt;24h) is harmful (Class III). Graduated approach starting 24-48h preferred. Short, frequent sessions better than prolonged single sessions.</p>
                              </div>

                              {/* Hyperglycemia Management */}
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <h4 className="font-semibold text-amber-800 mb-2">Acute Hyperglycemia Management</h4>
                                <div className="text-sm text-slate-700 space-y-1">
                                  <p><strong>Target glucose: 140-180 mg/dL</strong> (Class I, LOE A)</p>
                                  <p className="text-red-700 font-semibold">Intensive glucose control (80-130 mg/dL) is CLASS III: HARM</p>
                                  <p>• Treat glucose &gt;180 mg/dL with insulin</p>
                                  <p>• Avoid hypoglycemia (&lt;60 mg/dL) — associated with worse outcomes</p>
                                  <p>• Continuous glucose monitoring may be considered</p>
                                  <p className="text-xs text-slate-500 italic">SHINE trial, AHA/ASA 2019 + 2026 update</p>
                                </div>
                              </div>

                              {/* DOAC Timing Algorithm (Interactive) */}
                              {getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' && (
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-purple-800 mb-2">DOAC Timing Algorithm (AF-Stroke)</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div className="space-y-2">
                                      <select value={(telestrokeNote.doacTiming || {}).strokeSeverity || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, doacTiming: {...(prev.doacTiming || {}), strokeSeverity: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                        <option value="">Stroke severity</option>
                                        <option value="minor">Minor (NIHSS &lt;8, small infarct)</option>
                                        <option value="moderate">Moderate (NIHSS 8-15)</option>
                                        <option value="severe">Severe (NIHSS &gt;15 or large infarct)</option>
                                      </select>
                                      <label className="flex items-center gap-2">
                                        <input type="checkbox" checked={!!(telestrokeNote.doacTiming || {}).hemorrhagicTransformation}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, doacTiming: {...(prev.doacTiming || {}), hemorrhagicTransformation: c}})); }} />
                                        <span className="text-xs">Hemorrhagic transformation present</span>
                                      </label>
                                      <select value={(telestrokeNote.doacTiming || {}).doacAgent || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, doacTiming: {...(prev.doacTiming || {}), doacAgent: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                        <option value="">DOAC agent</option>
                                        <option value="apixaban">Apixaban 5mg BID</option>
                                        <option value="apixaban-reduced">Apixaban 2.5mg BID (dose reduction criteria met)</option>
                                        <option value="rivaroxaban">Rivaroxaban 20mg daily</option>
                                        <option value="rivaroxaban-reduced">Rivaroxaban 15mg daily (CrCl 15-50)</option>
                                        <option value="dabigatran">Dabigatran 150mg BID</option>
                                        <option value="edoxaban">Edoxaban 60mg daily</option>
                                      </select>
                                    </div>
                                    <div>
                                      {(telestrokeNote.doacTiming || {}).strokeSeverity && (
                                        <div className={`p-2 rounded border text-sm ${
                                          (telestrokeNote.doacTiming || {}).hemorrhagicTransformation ? 'bg-red-100 border-red-300' :
                                          (telestrokeNote.doacTiming || {}).strokeSeverity === 'minor' ? 'bg-emerald-100 border-emerald-300' :
                                          (telestrokeNote.doacTiming || {}).strokeSeverity === 'moderate' ? 'bg-amber-100 border-amber-300' :
                                          'bg-red-100 border-red-300'
                                        }`}>
                                          <p className="font-semibold mb-1">
                                            {(telestrokeNote.doacTiming || {}).hemorrhagicTransformation ? 'Delay DOAC — repeat imaging first' :
                                             (telestrokeNote.doacTiming || {}).strokeSeverity === 'minor' ? 'Start DOAC within 48 hours' :
                                             (telestrokeNote.doacTiming || {}).strokeSeverity === 'moderate' ? 'Start DOAC Day 3-5' :
                                             'Start DOAC Day 6-14'}
                                          </p>
                                          <p className="text-xs text-slate-600">CATALYST meta-analysis (ELAN, OPTIMAS, TIMING, START). Early initiation is safe and non-inferior to delayed.</p>
                                          {(telestrokeNote.doacTiming || {}).hemorrhagicTransformation && (
                                            <p className="text-xs text-red-700 mt-1">HT present: Repeat CT before DOAC initiation. If PH-2, delay until stable and consult.</p>
                                          )}
                                        </div>
                                      )}
                                      <input type="text" value={(telestrokeNote.doacTiming || {}).doacInitiationDay || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, doacTiming: {...(prev.doacTiming || {}), doacInitiationDay: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-xs mt-2" placeholder="Planned initiation day (e.g., Day 3)" />
                                    </div>
                                  </div>
                                </div>
                              )}

                              {/* Carotid Management */}
                              {getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' && (
                                <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-indigo-800 mb-2">Carotid Stenosis Management</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                      <label className="text-xs text-slate-600">Side</label>
                                      <select value={(telestrokeNote.carotidManagement || {}).stenosisSide || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, carotidManagement: {...(prev.carotidManagement || {}), stenosisSide: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                        <option value="">Select</option>
                                        <option value="left">Left</option>
                                        <option value="right">Right</option>
                                        <option value="bilateral">Bilateral</option>
                                      </select>
                                    </div>
                                    <div>
                                      <label className="text-xs text-slate-600">Degree of Stenosis</label>
                                      <select value={(telestrokeNote.carotidManagement || {}).stenosisDegree || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, carotidManagement: {...(prev.carotidManagement || {}), stenosisDegree: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                        <option value="">Select</option>
                                        <option value="<50">&lt;50% (mild)</option>
                                        <option value="50-69">50-69% (moderate)</option>
                                        <option value="70-99">70-99% (severe)</option>
                                        <option value="occlusion">Complete occlusion</option>
                                      </select>
                                    </div>
                                    <div>
                                      <label className="flex items-center gap-2 mt-4">
                                        <input type="checkbox" checked={!!(telestrokeNote.carotidManagement || {}).symptomatic}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, carotidManagement: {...(prev.carotidManagement || {}), symptomatic: c}})); }} />
                                        <span className="text-sm">Symptomatic (ipsilateral to stroke)</span>
                                      </label>
                                    </div>
                                  </div>
                                  {(telestrokeNote.carotidManagement || {}).stenosisDegree && (
                                    <div className="mt-2">
                                      <select value={(telestrokeNote.carotidManagement || {}).intervention || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, carotidManagement: {...(prev.carotidManagement || {}), intervention: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                        <option value="">Intervention plan</option>
                                        <option value="cea">CEA (within 2 weeks if symptomatic &ge;50%)</option>
                                        <option value="cas">CAS (if high surgical risk)</option>
                                        <option value="tcar">TCAR (transcarotid artery revascularization)</option>
                                        <option value="medical-only">Medical management only</option>
                                      </select>
                                      {(telestrokeNote.carotidManagement || {}).symptomatic && ((telestrokeNote.carotidManagement || {}).stenosisDegree === '50-69' || (telestrokeNote.carotidManagement || {}).stenosisDegree === '70-99') && (
                                        <div className="mt-1 p-2 bg-emerald-100 rounded text-xs text-emerald-800">
                                          <strong>Symptomatic {(telestrokeNote.carotidManagement || {}).stenosisDegree}%:</strong> Timing depends on stroke severity — TIA/minor stroke (NIHSS 0-5): CEA within 48h-7 days for maximal benefit (Express/SOS-TIA). Moderate stroke (NIHSS 6-15): CEA at 2-4 weeks after stabilization. Large infarct (&gt;1/3 MCA): delay 4-6 weeks (risk of hyperperfusion syndrome). NNT = 5 for ≥70%.
                                        </div>
                                      )}
                                      {!(telestrokeNote.carotidManagement || {}).symptomatic && ((telestrokeNote.carotidManagement || {}).stenosisDegree === '70-99') && (
                                        <div className="mt-1 p-2 bg-amber-100 rounded text-xs text-amber-800">
                                          <strong>Asymptomatic &ge;70%:</strong> CREST-2 showed CEA + medical NOT superior to medical management alone. Optimize medical therapy first (high-intensity statin, BP control, antiplatelet).
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>
                              )}

                              {/* ESUS / Cryptogenic Workup */}
                              {getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ischemic' && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-blue-800 mb-2">ESUS / Cryptogenic Stroke Workup</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div className="space-y-2">
                                      <select value={(telestrokeNote.esusWorkup || {}).cardiacMonitoringType || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, esusWorkup: {...(prev.esusWorkup || {}), cardiacMonitoringType: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                        <option value="">Cardiac monitoring plan</option>
                                        <option value="30-day-monitor">30-day ambulatory monitor (preferred)</option>
                                        <option value="14-day-patch">14-day continuous patch</option>
                                        <option value="ilr">Implantable loop recorder</option>
                                        <option value="telemetry-only">Inpatient telemetry only</option>
                                      </select>
                                      <label className="flex items-center gap-2">
                                        <input type="checkbox" checked={!!(telestrokeNote.esusWorkup || {}).teePerformed}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, esusWorkup: {...(prev.esusWorkup || {}), teePerformed: c}})); }} />
                                        <span className="text-sm">TEE performed/ordered</span>
                                      </label>
                                      {(telestrokeNote.esusWorkup || {}).teePerformed && (
                                        <input type="text" value={(telestrokeNote.esusWorkup || {}).teeFindings || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, esusWorkup: {...(prev.esusWorkup || {}), teeFindings: v}})); }}
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-xs" placeholder="TEE findings (PFO, ASA, valve, LAA thrombus)" />
                                      )}
                                    </div>
                                    <div className="space-y-2">
                                      <label className="flex items-center gap-2">
                                        <input type="checkbox" checked={!!(telestrokeNote.esusWorkup || {}).afDetected}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, esusWorkup: {...(prev.esusWorkup || {}), afDetected: c}})); }} />
                                        <span className="text-sm">AF detected on monitoring</span>
                                      </label>
                                      <label className="flex items-center gap-2">
                                        <input type="checkbox" checked={!!(telestrokeNote.esusWorkup || {}).hypercoagWorkup}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, esusWorkup: {...(prev.esusWorkup || {}), hypercoagWorkup: c}})); }} />
                                        <span className="text-sm">Hypercoagulable workup ordered</span>
                                      </label>
                                      <select value={(telestrokeNote.esusWorkup || {}).esusAntiplatelet || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, esusWorkup: {...(prev.esusWorkup || {}), esusAntiplatelet: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                        <option value="">ESUS antithrombotic</option>
                                        <option value="antiplatelet">Antiplatelet (NAVIGATE-ESUS, RE-SPECT ESUS: no DOAC benefit)</option>
                                        <option value="doac-af-found">DOAC — AF discovered on monitoring</option>
                                      </select>
                                    </div>
                                  </div>
                                  <p className="text-xs text-slate-500 mt-1">ACC 2024 ECDP: Extended cardiac monitoring is reasonable for all cryptogenic stroke. PER-DIEM trial supports early prolonged monitoring. NAVIGATE-ESUS and RE-SPECT ESUS showed no benefit of DOAC over antiplatelet for ESUS without AF.</p>
                                </div>
                              )}

                              {/* ICH Anticoagulation Resumption */}
                              {getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'ich' && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-red-800 mb-2">ICH: Anticoagulation Resumption Decision</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div className="space-y-2">
                                      <select aria-label="ICH location for anticoag resumption decision" value={(telestrokeNote.ichAnticoagResumption || {}).ichLocation || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichAnticoagResumption: {...(prev.ichAnticoagResumption || {}), ichLocation: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                        <option value="">ICH location</option>
                                        <option value="deep">Deep (basal ganglia, thalamus, pons)</option>
                                        <option value="lobar">Lobar</option>
                                        <option value="cerebellar">Cerebellar</option>
                                        <option value="brainstem">Brainstem</option>
                                      </select>
                                      <label className="flex items-center gap-2">
                                        <input type="checkbox" checked={!!(telestrokeNote.ichAnticoagResumption || {}).caaFeatures}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, ichAnticoagResumption: {...(prev.ichAnticoagResumption || {}), caaFeatures: c}})); }} />
                                        <span className="text-sm text-red-700">CAA features on MRI (cortical siderosis, multiple lobar microbleeds)</span>
                                      </label>
                                      <div className="grid grid-cols-2 gap-2">
                                        <div>
                                          <label className="text-xs text-slate-600">CHA2DS2-VASc</label>
                                          <input type="number" value={(telestrokeNote.ichAnticoagResumption || {}).chadsVascScore || ''}
                                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichAnticoagResumption: {...(prev.ichAnticoagResumption || {}), chadsVascScore: v}})); }}
                                            className="w-full px-2 py-1 border border-slate-300 rounded text-sm" min="0" max="9" />
                                        </div>
                                        <div>
                                          <label className="text-xs text-slate-600">HAS-BLED</label>
                                          <input type="number" value={(telestrokeNote.ichAnticoagResumption || {}).hasbledScore || ''}
                                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichAnticoagResumption: {...(prev.ichAnticoagResumption || {}), hasbledScore: v}})); }}
                                            className="w-full px-2 py-1 border border-slate-300 rounded text-sm" min="0" max="9" />
                                        </div>
                                      </div>
                                    </div>
                                    <div className="space-y-2">
                                      <select aria-label="Anticoagulation resumption decision" value={(telestrokeNote.ichAnticoagResumption || {}).decision || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichAnticoagResumption: {...(prev.ichAnticoagResumption || {}), decision: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                        <option value="">Decision</option>
                                        <option value="resume-doac">Resume DOAC (after 4-8 weeks)</option>
                                        <option value="resume-doac-early">Resume DOAC early (high CHA2DS2-VASc, deep ICH)</option>
                                        <option value="laao">LAAO (Watchman) referral — high bleed risk</option>
                                        <option value="no-anticoag">No anticoagulation — high recurrent ICH risk</option>
                                        <option value="defer">Defer decision — multidisciplinary discussion</option>
                                      </select>
                                      <label className="flex items-center gap-2">
                                        <input type="checkbox" checked={!!(telestrokeNote.ichAnticoagResumption || {}).laaoConsidered}
                                          onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, ichAnticoagResumption: {...(prev.ichAnticoagResumption || {}), laaoConsidered: c}})); }} />
                                        <span className="text-sm">LAAO evaluation considered</span>
                                      </label>
                                      <textarea aria-label="Anticoagulation resumption rationale" value={(telestrokeNote.ichAnticoagResumption || {}).rationale || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichAnticoagResumption: {...(prev.ichAnticoagResumption || {}), rationale: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-xs" rows="2" placeholder="Rationale for decision..." />
                                      {(telestrokeNote.ichAnticoagResumption || {}).caaFeatures && (
                                        <div className="p-1 bg-red-100 rounded text-xs text-red-700">
                                          CAA + AF: High risk of both recurrent ICH and stroke. LAAO may be preferred. PRESTIGE-AF: DOAC had higher ICH recurrence in CAA patients.
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                  <p className="text-xs text-slate-500 mt-1">PRESTIGE-AF, SoSTART, APACHE-AF: Resuming OAC after ICH may be reasonable in selected patients (Class IIb). Deep ICH with high CHA2DS2-VASc favors resumption. Lobar ICH with CAA features favors LAAO or no anticoagulation.</p>
                                </div>
                              )}
                              {/* VTE Prophylaxis */}
                              <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                                <h4 className="font-semibold text-indigo-800 mb-2">VTE Prophylaxis Protocol</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="space-y-2">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.vteProphylaxis || {}).ipcApplied}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, vteProphylaxis: {...(prev.vteProphylaxis || {}), ipcApplied: c}})); }} />
                                      <span className="text-sm font-medium">IPC applied at admission (Class I, LOE A)</span>
                                    </label>
                                    <select value={(telestrokeNote.vteProphylaxis || {}).pharmacoProphylaxis || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, vteProphylaxis: {...(prev.vteProphylaxis || {}), pharmacoProphylaxis: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                      <option value="">Pharmacologic prophylaxis</option>
                                      <option value="enoxaparin-40">Enoxaparin 40mg SC daily (preferred — PREVAIL)</option>
                                      <option value="enoxaparin-30">Enoxaparin 30mg SC daily (CrCl &lt;30)</option>
                                      <option value="ufh-5000">UFH 5000u SC q8-12h (alternative)</option>
                                      <option value="held-post-tpa">Held — post-thrombolysis (24h wait + CT clear)</option>
                                      <option value="held-post-ich">Held — post-ICH (24-48h + hematoma stability)</option>
                                      <option value="contraindicated">Contraindicated</option>
                                    </select>
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.vteProphylaxis || {}).antiXaMonitoring}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, vteProphylaxis: {...(prev.vteProphylaxis || {}), antiXaMonitoring: c}})); }} />
                                      <span className="text-xs">Anti-Xa monitoring (BMI &gt;40 or CrCl &lt;30)</span>
                                    </label>
                                  </div>
                                  <div className="text-xs text-slate-700 space-y-1">
                                    <p className="font-semibold text-red-700">TED hose alone are NOT effective (Class III)</p>
                                    <p>• IPC immediately for all immobile stroke patients (CLOTS 3)</p>
                                    <p>• Post-tPA: no enoxaparin for 24h + CT clear</p>
                                    <p>• Post-ICH: enoxaparin safe at 24-48h after hematoma stability</p>
                                    <p>• Duration: 10-14 days or until independently mobile</p>
                                    <p>• Combined IPC + LMWH for highest-risk patients (prior VTE, malignancy)</p>
                                  </div>
                                </div>
                              </div>

                              {/* Fever Management */}
                              <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                <h4 className="font-semibold text-orange-800 mb-2">Fever Management Protocol (FeSS Bundle)</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="space-y-2">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.feverManagement || {}).feverDetected}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, feverManagement: {...(prev.feverManagement || {}), feverDetected: c}})); }} />
                                      <span className="text-sm">Fever detected (&gt;37.5C)</span>
                                    </label>
                                    {(telestrokeNote.feverManagement || {}).feverDetected && (
                                      <div className="space-y-2 ml-4">
                                        <label className="flex items-center gap-2">
                                          <input type="checkbox" checked={!!(telestrokeNote.feverManagement || {}).infectionWorkupSent}
                                            onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, feverManagement: {...(prev.feverManagement || {}), infectionWorkupSent: c}})); }} />
                                          <span className="text-xs">Infection workup sent (blood cx, UA, CXR)</span>
                                        </label>
                                        <select value={(telestrokeNote.feverManagement || {}).escalationLevel || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, feverManagement: {...(prev.feverManagement || {}), escalationLevel: v}})); }}
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                          <option value="">Escalation level</option>
                                          <option value="acetaminophen">1. Acetaminophen 650-1000mg q6h</option>
                                          <option value="surface-cooling">2. Surface cooling + counter-warming</option>
                                          <option value="iv-mag">3. IV magnesium 2g bolus</option>
                                          <option value="buspirone">4. Buspirone 30mg q8h</option>
                                          <option value="meperidine">5. Meperidine 25-50mg IV q4-6h PRN</option>
                                          <option value="sedation">6. Sedation (intubated patients)</option>
                                        </select>
                                        <div>
                                          <label className="text-xs text-slate-600">BSAS score (0-3)</label>
                                          <select value={(telestrokeNote.feverManagement || {}).bsasScore || ''}
                                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, feverManagement: {...(prev.feverManagement || {}), bsasScore: v}})); }}
                                            className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                            <option value="">BSAS</option>
                                            <option value="0">0 — No shivering</option>
                                            <option value="1">1 — Mild (neck/thorax only)</option>
                                            <option value="2">2 — Moderate (upper extremities)</option>
                                            <option value="3">3 — Severe (whole body/sustained)</option>
                                          </select>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                  <div className="text-xs text-slate-700 space-y-1">
                                    <p className="font-semibold">FeSS Bundle (QASC: 16% reduction in death/dependency):</p>
                                    <p>• <strong>Fe</strong>ver: target 36.0-37.5C, temp q4h, treat within 1h</p>
                                    <p>• <strong>S</strong>ugar: target 140-180 mg/dL (see Hyperglycemia section)</p>
                                    <p>• <strong>S</strong>wallowing: mandatory dysphagia screen before oral intake</p>
                                    <p className="text-red-700 font-semibold mt-1">Avoid NSAIDs in stroke (bleeding risk, renal, antiplatelet interference)</p>
                                    <p>• Acetaminophen is first-line antipyretic</p>
                                  </div>
                                </div>
                              </div>

                              {/* Osmotic Therapy + Na Correction Rate Safety Calculator */}
                              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 space-y-3">
                                <h4 className="font-semibold text-slate-800 mb-2">Osmotic Therapy &amp; Sodium Correction Safety</h4>

                                {/* Agent & Indication Row */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="space-y-2">
                                    <select value={(telestrokeNote.osmoticTherapy || {}).agentUsed || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), agentUsed: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                      <option value="">Agent</option>
                                      <option value="mannitol-20">Mannitol 20% (0.5-1 g/kg bolus)</option>
                                      <option value="hts-3">HTS 3% (250 mL or 5 mL/kg bolus)</option>
                                      <option value="hts-23.4">HTS 23.4% (30 mL via central line — herniation)</option>
                                      <option value="none">No osmotic therapy</option>
                                    </select>
                                    <select value={(telestrokeNote.osmoticTherapy || {}).indication || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), indication: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">Indication</option>
                                      <option value="cerebral-edema">Cerebral edema</option>
                                      <option value="herniation">Impending/active herniation</option>
                                      <option value="icp-elevation">ICP elevation</option>
                                    </select>
                                  </div>
                                  <div className="text-xs text-slate-700 space-y-1">
                                    <p><strong>Mannitol:</strong> hold if osmolality &gt;320 or gap &gt;20; BMP q6h</p>
                                    <p><strong>HTS 3%:</strong> Na q4-6h; target 145-155; max 8-10 mEq/L/24h</p>
                                    <p><strong>HTS preferred</strong> if renal insufficiency (mannitol accumulates)</p>
                                    <p><strong>HTS 23.4%:</strong> central line only; for refractory herniation</p>
                                  </div>
                                </div>

                                {/* Sodium Correction Rate Calculator */}
                                {((telestrokeNote.osmoticTherapy || {}).agentUsed || '').includes('hts') && (
                                  <div className="bg-white border border-indigo-200 rounded-lg p-3 space-y-3">
                                    <div className="flex items-center gap-2">
                                      <span className="text-sm font-bold text-indigo-800">Na+ Correction Rate Calculator</span>
                                      <span className="text-xs text-slate-700">ODS/CPM Safety Monitor</span>
                                    </div>

                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                      <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-0.5">Baseline Na+ (mEq/L)</label>
                                        <div className="flex items-center gap-1">
                                          <input type="number" step="0.1" min="100" max="180"
                                            value={(telestrokeNote.osmoticTherapy || {}).baselineNa || ''}
                                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), baselineNa: v}})); }}
                                            placeholder="e.g. 138"
                                            className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                        </div>
                                      </div>
                                      <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-0.5">Baseline Time</label>
                                        <input type="time"
                                          value={(telestrokeNote.osmoticTherapy || {}).baselineNaTime || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), baselineNaTime: v}})); }}
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                      </div>
                                      <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-0.5">Repeat Na+ (mEq/L)</label>
                                        <input type="number" step="0.1" min="100" max="180"
                                          value={(telestrokeNote.osmoticTherapy || {}).repeatNa || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), repeatNa: v}})); }}
                                          placeholder="e.g. 148"
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                      </div>
                                      <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-0.5">Repeat Time</label>
                                        <input type="time"
                                          value={(telestrokeNote.osmoticTherapy || {}).repeatNaTime || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), repeatNaTime: v}})); }}
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                      </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-2">
                                      <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-0.5">Na+ Target (mEq/L)</label>
                                        <input type="number" step="1"
                                          value={(telestrokeNote.osmoticTherapy || {}).sodiumTarget || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), sodiumTarget: v}})); }}
                                          placeholder="e.g. 150"
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                      </div>
                                      <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-0.5">Serum Osmolality (mOsm/kg)</label>
                                        <input type="number" step="1"
                                          value={(telestrokeNote.osmoticTherapy || {}).serumOsmolality || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), serumOsmolality: v}})); }}
                                          placeholder="e.g. 295"
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                      </div>
                                    </div>

                                    {/* Correction Rate Output */}
                                    {(() => {
                                      const osm = telestrokeNote.osmoticTherapy || {};
                                      const baseNa = parseFloat(osm.baselineNa);
                                      const repNa = parseFloat(osm.repeatNa);
                                      const baseT = osm.baselineNaTime;
                                      const repT = osm.repeatNaTime;
                                      const target = parseFloat(osm.sodiumTarget);
                                      const osmVal = parseFloat(osm.serumOsmolality);

                                      if (isNaN(baseNa) || isNaN(repNa) || !baseT || !repT) return (
                                        <p className="text-xs text-slate-500 italic">Enter baseline and repeat Na+ values with times to calculate correction rate.</p>
                                      );

                                      // Calculate hours between measurements
                                      const [bH, bM] = baseT.split(':').map(Number);
                                      const [rH, rM] = repT.split(':').map(Number);
                                      if (isNaN(bH) || isNaN(bM) || isNaN(rH) || isNaN(rM)) return <p className="text-xs text-slate-500 italic">Enter valid times to calculate correction rate.</p>;
                                      let hoursElapsed = (rH + rM / 60) - (bH + bM / 60);
                                      if (hoursElapsed < 0) hoursElapsed += 24; // crossed midnight
                                      if (hoursElapsed < 0.1) return <p className="text-xs text-red-600">Times too close — check entries.</p>;

                                      const naDelta = repNa - baseNa;
                                      const ratePerHour = naDelta / hoursElapsed;
                                      const projected24h = ratePerHour * 24;

                                      // ODS risk thresholds
                                      const isRapid = Math.abs(projected24h) > 10;
                                      const isDangerous = Math.abs(projected24h) > 12;
                                      const isSlow = Math.abs(projected24h) < 4 && naDelta > 0;
                                      const osmHigh = !isNaN(osmVal) && osmVal > 320;

                                      // Hours remaining to reach target at current rate
                                      const hoursToTarget = (!isNaN(target) && ratePerHour > 0 && target > repNa) ? ((target - repNa) / ratePerHour) : null;

                                      return (
                                        <div className="space-y-2">
                                          <div className={'rounded-lg p-3 ' + (isDangerous ? 'bg-red-100 border-2 border-red-400' : isRapid ? 'bg-amber-100 border-2 border-amber-400' : 'bg-emerald-100 border border-emerald-300')}>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                                              <div>
                                                <p className="text-xs text-slate-600">Change</p>
                                                <p className="text-lg font-bold">{naDelta > 0 ? '+' : ''}{naDelta.toFixed(1)} mEq/L</p>
                                                <p className="text-xs text-slate-500">in {hoursElapsed.toFixed(1)}h</p>
                                              </div>
                                              <div>
                                                <p className="text-xs text-slate-600">Rate</p>
                                                <p className="text-lg font-bold">{ratePerHour > 0 ? '+' : ''}{ratePerHour.toFixed(2)} mEq/L/h</p>
                                              </div>
                                              <div>
                                                <p className="text-xs text-slate-600">Projected 24h</p>
                                                <p className={'text-lg font-bold ' + (isDangerous ? 'text-red-700' : isRapid ? 'text-amber-700' : 'text-emerald-700')}>
                                                  {projected24h > 0 ? '+' : ''}{projected24h.toFixed(1)} mEq/L
                                                </p>
                                              </div>
                                              <div>
                                                <p className="text-xs text-slate-600">Current Na+</p>
                                                <p className="text-lg font-bold">{repNa} mEq/L</p>
                                                {!isNaN(target) && <p className="text-xs text-slate-500">Target: {target}</p>}
                                              </div>
                                            </div>

                                            {/* Safety Alerts */}
                                            {isDangerous && (
                                              <div className="mt-2 p-2 bg-red-200 rounded text-sm text-red-900 font-bold text-center animate-pulse">
                                                &#9888; ODS/CPM RISK: Projected correction &gt;12 mEq/L/24h — SLOW or STOP infusion. Consider DDAVP 2 mcg IV q8h to re-lower Na+.
                                              </div>
                                            )}
                                            {isRapid && !isDangerous && (
                                              <div className="mt-2 p-2 bg-amber-200 rounded text-sm text-amber-900 font-semibold text-center">
                                                &#9888; Approaching ODS threshold (&gt;10 mEq/L/24h). Reduce HTS rate. Recheck Na+ in 2h. Max safe: 8 mEq/L/24h preferred.
                                              </div>
                                            )}
                                            {isSlow && (
                                              <div className="mt-2 p-2 bg-blue-100 rounded text-xs text-blue-800 text-center">
                                                Correction rate slow (&lt;4 mEq/L/24h). Consider increasing infusion rate if clinically indicated.
                                              </div>
                                            )}
                                          </div>

                                          {hoursToTarget !== null && (
                                            <p className="text-xs text-indigo-700 text-center">At current rate, target of {target} mEq/L reached in ~{hoursToTarget.toFixed(1)} hours ({(hoursToTarget / 24).toFixed(1)} days)</p>
                                          )}

                                          {osmHigh && (
                                            <div className="bg-amber-50 border border-amber-300 rounded px-2 py-1 text-xs text-amber-800 text-center">
                                              &#9888; Serum osmolality {osmVal} mOsm/kg (&gt;320) — hold Mannitol. HTS may continue with caution.
                                            </div>
                                          )}

                                          {/* Safe correction guide */}
                                          <div className="bg-slate-50 rounded p-2 text-xs text-slate-700">
                                            <p className="font-semibold mb-1">Safe Correction Limits (NCS/AAN):</p>
                                            <div className="grid grid-cols-3 gap-2 text-center">
                                              <div className="bg-emerald-50 rounded p-1">
                                                <p className="font-bold text-emerald-800">&le;8 mEq/L</p>
                                                <p>per 24h (preferred)</p>
                                              </div>
                                              <div className="bg-amber-50 rounded p-1">
                                                <p className="font-bold text-amber-800">8-10 mEq/L</p>
                                                <p>per 24h (acceptable)</p>
                                              </div>
                                              <div className="bg-red-50 rounded p-1">
                                                <p className="font-bold text-red-800">&gt;10 mEq/L</p>
                                                <p>per 24h (ODS risk)</p>
                                              </div>
                                            </div>
                                            <p className="mt-1 text-slate-700">If overcorrected: DDAVP 2 mcg IV q8h + D5W infusion to re-lower Na+. Target reversal to &le;8 mEq/L/24h from baseline.</p>
                                          </div>
                                        </div>
                                      );
                                    })()}
                                  </div>
                                )}

                                {/* Mannitol Osmolality Safety */}
                                {(telestrokeNote.osmoticTherapy || {}).agentUsed === 'mannitol-20' && (
                                  <div className="bg-white border border-amber-200 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-sm font-bold text-amber-800">Mannitol Safety Monitoring</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                      <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-0.5">Serum Osmolality (mOsm/kg)</label>
                                        <input type="number" step="1"
                                          value={(telestrokeNote.osmoticTherapy || {}).serumOsmolality || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), serumOsmolality: v}})); }}
                                          placeholder="e.g. 295"
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                      </div>
                                      <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-0.5">Osmol Gap (calculated - measured)</label>
                                        <input type="number" step="1"
                                          value={(telestrokeNote.osmoticTherapy || {}).mannitolOsmGap || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, osmoticTherapy: {...(prev.osmoticTherapy || {}), mannitolOsmGap: v}})); }}
                                          placeholder="e.g. 10"
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                      </div>
                                    </div>
                                    {(() => {
                                      const osmVal = parseFloat((telestrokeNote.osmoticTherapy || {}).serumOsmolality);
                                      const gapVal = parseFloat((telestrokeNote.osmoticTherapy || {}).mannitolOsmGap);
                                      if (isNaN(osmVal) && isNaN(gapVal)) return <p className="text-xs text-slate-500 mt-1">Enter osmolality and gap to assess safety. Check q6h with BMP.</p>;
                                      return (
                                        <div className="mt-2 space-y-1">
                                          {!isNaN(osmVal) && osmVal > 320 && (
                                            <div className="bg-red-100 border border-red-300 rounded px-2 py-1 text-xs text-red-800 font-bold">
                                              &#9888; Osmolality {osmVal} &gt;320 — HOLD mannitol. Risk of renal injury.
                                            </div>
                                          )}
                                          {!isNaN(osmVal) && osmVal <= 320 && osmVal > 300 && (
                                            <div className="bg-amber-50 border border-amber-200 rounded px-2 py-1 text-xs text-amber-700">
                                              Osmolality {osmVal} — approaching limit. Recheck in 4-6h.
                                            </div>
                                          )}
                                          {!isNaN(osmVal) && osmVal <= 300 && (
                                            <div className="bg-emerald-50 border border-emerald-200 rounded px-2 py-1 text-xs text-emerald-700">
                                              Osmolality {osmVal} — safe to continue mannitol.
                                            </div>
                                          )}
                                          {!isNaN(gapVal) && gapVal > 20 && (
                                            <div className="bg-red-100 border border-red-300 rounded px-2 py-1 text-xs text-red-800 font-bold">
                                              &#9888; Osmol gap {gapVal} &gt;20 — mannitol accumulation. HOLD and reassess.
                                            </div>
                                          )}
                                        </div>
                                      );
                                    })()}
                                  </div>
                                )}
                              </div>

                              {/* Nutritional Support */}
                              <div className="bg-lime-50 border border-lime-200 rounded-lg p-3">
                                <h4 className="font-semibold text-lime-800 mb-2">Nutritional Support Pathway</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="space-y-2">
                                    <select value={(telestrokeNote.nutritionalSupport || {}).feedingRoute || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, nutritionalSupport: {...(prev.nutritionalSupport || {}), feedingRoute: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                      <option value="">Feeding route</option>
                                      <option value="oral-regular">Oral — regular diet</option>
                                      <option value="oral-modified">Oral — modified texture</option>
                                      <option value="ngt">NG tube</option>
                                      <option value="npo-pending">NPO — pending swallow evaluation</option>
                                      <option value="peg">PEG tube</option>
                                    </select>
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.nutritionalSupport || {}).nutritionConsultOrdered}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, nutritionalSupport: {...(prev.nutritionalSupport || {}), nutritionConsultOrdered: c}})); }} />
                                      <span className="text-xs">Nutrition consult ordered</span>
                                    </label>
                                  </div>
                                  <div className="text-xs text-slate-700 space-y-1">
                                    <p>• Failed swallow: NG within 24-48h; SLP within 72h</p>
                                    <p>• <strong>PEG at day 14-21</strong> if dysphagia persists (FOOD trial: early PEG worse)</p>
                                    <p>• Target: 25-30 kcal/kg/day, protein 1.0-1.5 g/kg/day</p>
                                    <p>• Start enteral nutrition within 24-48h</p>
                                    <p>• Antithrombotics can continue during PEG (ASGE 2024)</p>
                                  </div>
                                </div>
                              </div>

                              {/* Palliative Care / Goals of Care */}
                              <div className="bg-slate-50 border border-slate-300 rounded-lg p-3">
                                <h4 className="font-semibold text-slate-800 mb-2">Palliative Care &amp; Goals of Care</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="space-y-2">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.palliativeCare || {}).goalsOfCareDiscussed}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, palliativeCare: {...(prev.palliativeCare || {}), goalsOfCareDiscussed: c}})); }} />
                                      <span className="text-sm">Goals-of-care conversation held</span>
                                    </label>
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.palliativeCare || {}).consultOrdered}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, palliativeCare: {...(prev.palliativeCare || {}), consultOrdered: c}})); }} />
                                      <span className="text-sm">Palliative care consult ordered</span>
                                    </label>
                                    <select value={(telestrokeNote.palliativeCare || {}).goalsOfCareOutcome || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, palliativeCare: {...(prev.palliativeCare || {}), goalsOfCareOutcome: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                      <option value="">Outcome</option>
                                      <option value="full-code">Full code — aggressive care</option>
                                      <option value="limited-intervention">Limited intervention (no intubation)</option>
                                      <option value="comfort-focused">Comfort-focused care</option>
                                    </select>
                                  </div>
                                  <div className="text-xs text-slate-700 space-y-1">
                                    <p className="text-red-700 font-semibold">Postpone new DNR until hospital day 2</p>
                                    <p>• Triggers: high NIHSS (&ge;20), large ICH, failed EVT</p>
                                    <p>• ICH score must NOT limit treatment</p>
                                    <p>• Full aggressive care x 24-48h minimum for ICH</p>
                                    <p>• Structured GOC at: craniectomy decision, failed recanalization, transitions</p>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </details>
                        )}

                        {/* ========== FOLLOW-UP CLINIC TOOLS ========== */}
                        {telestrokeNote.diagnosis && getPathwayForDiagnosis(telestrokeNote.diagnosis) !== 'mimic' && (
                          <details className="bg-white border-2 border-violet-300 rounded-lg shadow-md">
                            <summary className="cursor-pointer p-4 font-semibold text-violet-900 hover:bg-violet-50 rounded-lg flex items-center justify-between">
                              <span className="flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="calendar" className="w-5 h-5 text-violet-600"></i>
                                Follow-Up Clinic Tools
                              </span>
                              <span className="text-xs text-violet-500 font-normal">mRS, Driving, RTW, Spasticity, Pain, Fatigue, Alcohol, Travel</span>
                            </summary>
                            <div className="p-4 pt-0 space-y-4">
                              {/* Structured mRS */}
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 className="font-semibold text-blue-800 mb-2">Modified Rankin Scale (mRS) Tracking</h4>
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-2">
                                  {[
                                    { key: 'discharge', label: 'Discharge' },
                                    { key: 'day30', label: '30 days' },
                                    { key: 'day90', label: '90 days' },
                                    { key: 'month6', label: '6 months' },
                                    { key: 'month12', label: '12 months' }
                                  ].map(tp => (
                                    <div key={tp.key}>
                                      <label className="text-xs text-slate-600">{tp.label}</label>
                                      <select value={(telestrokeNote.mrsAssessment || {})[tp.key] || ''}
                                        onChange={(e) => { const k = tp.key, v = e.target.value; setTelestrokeNote(prev => ({...prev, mrsAssessment: {...(prev.mrsAssessment || {}), [k]: v}})); }}
                                        className="w-full px-1 py-1 border border-slate-300 rounded text-xs">
                                        <option value="">--</option>
                                        <option value="0">0 — No symptoms</option>
                                        <option value="1">1 — No significant disability</option>
                                        <option value="2">2 — Slight disability</option>
                                        <option value="3">3 — Moderate disability</option>
                                        <option value="4">4 — Moderately severe</option>
                                        <option value="5">5 — Severe disability</option>
                                        <option value="6">6 — Dead</option>
                                      </select>
                                    </div>
                                  ))}
                                </div>
                              </div>

                              {/* Driving Restrictions */}
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <h4 className="font-semibold text-amber-800 mb-2">Driving Restrictions</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="space-y-2">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.drivingRestrictions || {}).counselingProvided}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, drivingRestrictions: {...(prev.drivingRestrictions || {}), counselingProvided: c}})); }} />
                                      <span className="text-sm">Driving cessation counseling provided</span>
                                    </label>
                                    <select value={(telestrokeNote.drivingRestrictions || {}).restrictionDuration || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, drivingRestrictions: {...(prev.drivingRestrictions || {}), restrictionDuration: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                                      <option value="">Restriction period</option>
                                      <option value="1-month">1 month minimum (stroke/single TIA)</option>
                                      <option value="3-months">3 months (multiple TIAs, commercial driver)</option>
                                      <option value="6-months">6 months (severe stroke with residual deficits)</option>
                                      <option value="1-year">1 year (commercial — FMCSA)</option>
                                      <option value="indefinite">Indefinite (unresolved deficits)</option>
                                    </select>
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.drivingRestrictions || {}).drivingEvalReferral}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, drivingRestrictions: {...(prev.drivingRestrictions || {}), drivingEvalReferral: c}})); }} />
                                      <span className="text-xs">Driving evaluation referral (cognitive/visual/on-road)</span>
                                    </label>
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.drivingRestrictions || {}).commercialDriver}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, drivingRestrictions: {...(prev.drivingRestrictions || {}), commercialDriver: c}})); }} />
                                      <span className="text-xs">Commercial driver (CDL — FMCSA 1-year min)</span>
                                    </label>
                                  </div>
                                  <div className="text-xs text-slate-700 space-y-1">
                                    <p>• Acute symptomatic seizure within 24h does NOT trigger epilepsy driving rules</p>
                                    <p>• Refer for formal evaluation if: visual field defect, cognitive deficit, limb impairment</p>
                                    <p>• US: varies by state (no uniform federal standard for private vehicles)</p>
                                    <p>• Document counseling in note for medicolegal purposes</p>
                                  </div>
                                </div>
                              </div>

                              {/* Return to Work */}
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 className="font-semibold text-blue-800 mb-2">Return to Work</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="space-y-2">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.returnToWork || {}).workingAge}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, returnToWork: {...(prev.returnToWork || {}), workingAge: c}})); }} />
                                      <span className="text-sm">Working-age patient</span>
                                    </label>
                                    {(telestrokeNote.returnToWork || {}).workingAge && (
                                      <div className="space-y-2">
                                        <select value={(telestrokeNote.returnToWork || {}).expectedTimeline || ''}
                                          onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, returnToWork: {...(prev.returnToWork || {}), expectedTimeline: v}})); }}
                                          className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                          <option value="">Expected timeline</option>
                                          <option value="2-4-weeks">2-4 weeks (TIA/minor stroke)</option>
                                          <option value="2-6-months">2-6 months (moderate stroke)</option>
                                          <option value="6-12-months">6-12+ months (severe stroke)</option>
                                          <option value="unable">Unable to return</option>
                                        </select>
                                        <label className="flex items-center gap-2">
                                          <input type="checkbox" checked={!!(telestrokeNote.returnToWork || {}).vocationalRehabReferral}
                                            onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, returnToWork: {...(prev.returnToWork || {}), vocationalRehabReferral: c}})); }} />
                                          <span className="text-xs">Vocational rehab / OT referral for RTW</span>
                                        </label>
                                        <label className="flex items-center gap-2">
                                          <input type="checkbox" checked={!!(telestrokeNote.returnToWork || {}).phasedReturnPlan}
                                            onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, returnToWork: {...(prev.returnToWork || {}), phasedReturnPlan: c}})); }} />
                                          <span className="text-xs">Phased return plan recommended</span>
                                        </label>
                                      </div>
                                    )}
                                  </div>
                                  <div className="text-xs text-slate-700 space-y-1">
                                    <p>• Address at every follow-up visit (&lt;50% of working-age survivors return)</p>
                                    <p>• Top barriers: fatigue, cognitive deficits, emotional changes</p>
                                    <p>• RETAKE trial: structured OT + vocational rehab improves outcomes</p>
                                  </div>
                                </div>
                              </div>

                              {/* Spasticity, Pain, Fatigue */}
                              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-red-800 mb-2 text-sm">Spasticity</h4>
                                  <label className="flex items-center gap-2 mb-1">
                                    <input type="checkbox" checked={!!(telestrokeNote.spasticity || {}).screenPerformed}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, spasticity: {...(prev.spasticity || {}), screenPerformed: c}})); }} />
                                    <span className="text-xs">Screened (Modified Ashworth)</span>
                                  </label>
                                  <select value={(telestrokeNote.spasticity || {}).treatment || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, spasticity: {...(prev.spasticity || {}), treatment: v}})); }}
                                    className="w-full px-1 py-1 border border-slate-300 rounded text-xs">
                                    <option value="">Treatment</option>
                                    <option value="none">No spasticity</option>
                                    <option value="stretching">Stretching/ROM program</option>
                                    <option value="botox">Botox referral (Class I, LOE A)</option>
                                    <option value="oral-meds">Oral agents (baclofen/tizanidine)</option>
                                    <option value="itb">ITB pump evaluation</option>
                                  </select>
                                </div>
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-purple-800 mb-2 text-sm">Central Pain (CPSP)</h4>
                                  <label className="flex items-center gap-2 mb-1">
                                    <input type="checkbox" checked={!!(telestrokeNote.centralPain || {}).painPresent}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, centralPain: {...(prev.centralPain || {}), painPresent: c}})); }} />
                                    <span className="text-xs">CPSP present (burning/shooting)</span>
                                  </label>
                                  <select value={(telestrokeNote.centralPain || {}).treatment || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, centralPain: {...(prev.centralPain || {}), treatment: v}})); }}
                                    className="w-full px-1 py-1 border border-slate-300 rounded text-xs">
                                    <option value="">Treatment</option>
                                    <option value="amitriptyline">Amitriptyline 75mg/day (1st line)</option>
                                    <option value="lamotrigine">Lamotrigine (central pain-specific)</option>
                                    <option value="gabapentin">Gabapentin/pregabalin</option>
                                    <option value="duloxetine">Duloxetine</option>
                                  </select>
                                  <p className="text-xs text-red-600 mt-1">No opioids for CPSP</p>
                                </div>
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-blue-800 mb-2 text-sm">Post-Stroke Fatigue</h4>
                                  <label className="flex items-center gap-2 mb-1">
                                    <input type="checkbox" checked={!!(telestrokeNote.fatigue || {}).fatiguePresent}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, fatigue: {...(prev.fatigue || {}), fatiguePresent: c}})); }} />
                                    <span className="text-xs">Fatigue present (screen separately from depression)</span>
                                  </label>
                                  <select value={(telestrokeNote.fatigue || {}).management || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, fatigue: {...(prev.fatigue || {}), management: v}})); }}
                                    className="w-full px-1 py-1 border border-slate-300 rounded text-xs">
                                    <option value="">Management</option>
                                    <option value="energy-conservation">Energy conservation strategies</option>
                                    <option value="graded-exercise">Graded exercise program</option>
                                    <option value="sleep-hygiene">Sleep hygiene optimization</option>
                                    <option value="treat-comorbid">Treat comorbid (OSA, depression, pain)</option>
                                  </select>
                                </div>
                              </div>

                              {/* Alcohol, Substance, Hormonal, Sexual Health, Air Travel */}
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-orange-800 mb-2 text-sm">Alcohol &amp; Substance Screening</h4>
                                  <div className="space-y-1">
                                    <div className="flex items-center gap-2">
                                      <label className="text-xs text-slate-600">AUDIT-C:</label>
                                      <input type="number" min="0" max="12" value={(telestrokeNote.substanceScreening || {}).alcoholAuditC || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, substanceScreening: {...(prev.substanceScreening || {}), alcoholAuditC: v}})); }}
                                        className="w-16 px-2 py-1.5 border border-slate-300 rounded text-xs" placeholder="/12" />
                                      {parseInt((telestrokeNote.substanceScreening || {}).alcoholAuditC, 10) >= 4 && (
                                        <span className="text-xs text-red-600 font-semibold">POSITIVE — brief intervention</span>
                                      )}
                                    </div>
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.substanceScreening || {}).substanceUseScreen}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, substanceScreening: {...(prev.substanceScreening || {}), substanceUseScreen: c}})); }} />
                                      <span className="text-xs">Substance use screened (cocaine, amphetamines, cannabis)</span>
                                    </label>
                                  </div>
                                </div>
                                <div className="bg-pink-50 border border-pink-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-pink-800 mb-2 text-sm">Hormonal Risk Assessment</h4>
                                  <div className="space-y-1">
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.hormonalRisk || {}).combinedOCPUse}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, hormonalRisk: {...(prev.hormonalRisk || {}), combinedOCPUse: c}})); }} />
                                      <span className="text-xs">On combined OCP</span>
                                    </label>
                                    {(telestrokeNote.hormonalRisk || {}).combinedOCPUse && (
                                      <p className="text-xs text-red-600 ml-5">Discontinue combined OCP. Switch to progestin-only or nonhormonal (esp. if migraine with aura — Class I).</p>
                                    )}
                                    <label className="flex items-center gap-2">
                                      <input type="checkbox" checked={!!(telestrokeNote.hormonalRisk || {}).hrtUse}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, hormonalRisk: {...(prev.hormonalRisk || {}), hrtUse: c}})); }} />
                                      <span className="text-xs">On oral estrogen HRT</span>
                                    </label>
                                    {(telestrokeNote.hormonalRisk || {}).hrtUse && (
                                      <p className="text-xs text-red-600 ml-5">Oral estrogen HRT increases stroke risk (Class III Harm if age &ge;60 or &gt;10yr post-menopause). Consider transdermal.</p>
                                    )}
                                  </div>
                                </div>
                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-emerald-800 mb-2 text-sm">Sexual Activity Counseling</h4>
                                  <label className="flex items-center gap-2 mb-1">
                                    <input type="checkbox" checked={!!(telestrokeNote.sexualHealthCounseling || {}).discussed}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, sexualHealthCounseling: {...(prev.sexualHealthCounseling || {}), discussed: c}})); }} />
                                    <span className="text-xs">Sexual health discussed</span>
                                  </label>
                                  <p className="text-xs text-slate-600">Safe when BP controlled + tolerates moderate activity (climb 1-2 flights stairs). Typically 2-4 weeks post minor stroke. Review meds causing dysfunction (beta-blockers, SSRIs, thiazides).</p>
                                </div>
                                <div className="bg-sky-50 border border-sky-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-sky-800 mb-2 text-sm">Air Travel Restrictions</h4>
                                  <select value={(telestrokeNote.airTravelRestrictions || {}).restrictionDuration || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, airTravelRestrictions: {...(prev.airTravelRestrictions || {}), restrictionDuration: v}})); }}
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                    <option value="">Restriction</option>
                                    <option value="1-2-weeks">1-2 weeks (TIA)</option>
                                    <option value="2-weeks">2 weeks min (minor ischemic stroke)</option>
                                    <option value="1-3-months">1-3 months (major ischemic stroke)</option>
                                    <option value="6-8-weeks">6-8 weeks (ICH)</option>
                                    <option value="1-week-post-crani">1 week min post-craniotomy (trapped air risk)</option>
                                  </select>
                                  <p className="text-xs text-slate-600 mt-1">Flights &gt;4h: compression stockings, ambulate q1-2h, hydrate, avoid alcohol. Supplemental O2 if SpO2 &lt;95%.</p>
                                </div>
                              </div>

                              {/* Falls Risk */}
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <h4 className="font-semibold text-amber-800 mb-2 text-sm">Falls Risk</h4>
                                <div className="flex flex-wrap gap-3">
                                  <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={!!(telestrokeNote.fallsRisk || {}).screenPerformed}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, fallsRisk: {...(prev.fallsRisk || {}), screenPerformed: c}})); }} />
                                    <span className="text-xs">Falls risk screened</span>
                                  </label>
                                  <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={!!(telestrokeNote.fallsRisk || {}).highRisk}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, fallsRisk: {...(prev.fallsRisk || {}), highRisk: c}})); }} />
                                    <span className="text-xs font-semibold text-red-600">HIGH RISK</span>
                                  </label>
                                  <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={!!(telestrokeNote.fallsRisk || {}).preventionPlanInitiated}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, fallsRisk: {...(prev.fallsRisk || {}), preventionPlanInitiated: c}})); }} />
                                    <span className="text-xs">Prevention plan initiated</span>
                                  </label>
                                  <label className="flex items-center gap-2">
                                    <input type="checkbox" checked={!!(telestrokeNote.fallsRisk || {}).balanceProgramReferral}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, fallsRisk: {...(prev.fallsRisk || {}), balanceProgramReferral: c}})); }} />
                                    <span className="text-xs">Balance/exercise program referral (Class I)</span>
                                  </label>
                                </div>
                              </div>

                              {/* Young Adult Workup */}
                              {parseInt(telestrokeNote.age, 10) > 0 && parseInt(telestrokeNote.age, 10) <= 50 && (
                                <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-indigo-800 mb-2">Young Adult Stroke Workup (Age &le;50)</h4>
                                  <div className="space-y-3">
                                    <div>
                                      <p className="text-xs font-semibold text-indigo-700 mb-1">Tier 1 — All patients:</p>
                                      <div className="grid grid-cols-2 md:grid-cols-3 gap-1">
                                        {[
                                          { key: 'ctaMra', label: 'CTA/MRA head+neck' },
                                          { key: 'tteBubble', label: 'TTE with bubble study' },
                                          { key: 'ecg', label: 'ECG' },
                                          { key: 'telemetry', label: 'Telemetry >=24h' },
                                          { key: 'drugScreen', label: 'Urine drug screen' },
                                          { key: 'basicLabs', label: 'Basic labs (CBC, BMP, A1c, lipids)' }
                                        ].map(item => (
                                          <label key={item.key} className="flex items-center gap-1">
                                            <input type="checkbox"
                                              checked={!!((telestrokeNote.youngAdultWorkup || {}).tier1Items || {})[item.key]}
                                              onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, youngAdultWorkup: {...(prev.youngAdultWorkup || {}), tier1Items: {...((prev.youngAdultWorkup || {}).tier1Items || {}), [k]: c}}})); }} />
                                            <span className="text-xs">{item.label}</span>
                                          </label>
                                        ))}
                                      </div>
                                    </div>
                                    <div>
                                      <p className="text-xs font-semibold text-indigo-700 mb-1">Tier 2 — If cryptogenic after Tier 1:</p>
                                      <div className="grid grid-cols-2 md:grid-cols-3 gap-1">
                                        {[
                                          { key: 'tee', label: 'TEE' },
                                          { key: 'extendedMonitoring', label: 'Extended cardiac monitoring (>=14d)' },
                                          { key: 'aplPanel', label: 'Antiphospholipid antibody panel' }
                                        ].map(item => (
                                          <label key={item.key} className="flex items-center gap-1">
                                            <input type="checkbox"
                                              checked={!!((telestrokeNote.youngAdultWorkup || {}).tier2Items || {})[item.key]}
                                              onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, youngAdultWorkup: {...(prev.youngAdultWorkup || {}), tier2Items: {...((prev.youngAdultWorkup || {}).tier2Items || {}), [k]: c}}})); }} />
                                            <span className="text-xs">{item.label}</span>
                                          </label>
                                        ))}
                                      </div>
                                    </div>
                                    <div>
                                      <p className="text-xs font-semibold text-indigo-700 mb-1">Tier 3 — Suspicion-driven:</p>
                                      <div className="grid grid-cols-2 md:grid-cols-3 gap-1">
                                        {[
                                          { key: 'rcvsWorkup', label: 'RCVS workup' },
                                          { key: 'thrombophilia', label: 'Thrombophilia panel (only if PFO/VTE)' },
                                          { key: 'fabry', label: 'Fabry disease (alpha-gal A)' },
                                          { key: 'cadasil', label: 'CADASIL (NOTCH3)' },
                                          { key: 'vasculitis', label: 'Vasculitis workup (ESR, CRP, ANA)' }
                                        ].map(item => (
                                          <label key={item.key} className="flex items-center gap-1">
                                            <input type="checkbox"
                                              checked={!!((telestrokeNote.youngAdultWorkup || {}).tier3Items || {})[item.key]}
                                              onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, youngAdultWorkup: {...(prev.youngAdultWorkup || {}), tier3Items: {...((prev.youngAdultWorkup || {}).tier3Items || {}), [k]: c}}})); }} />
                                            <span className="text-xs">{item.label}</span>
                                          </label>
                                        ))}
                                      </div>
                                    </div>
                                    <p className="text-xs text-slate-500">Do NOT routinely test inherited thrombophilias for arterial stroke (Class III). Test only if PFO with suspected paradoxical embolism, VTE history, or family hx. Cervical artery dissection is #1 cause of stroke in young adults.</p>
                                  </div>
                                </div>
                              )}
                            </div>
                          </details>
                        )}

                        {/* ========== SPECIAL POPULATIONS ========== */}
                        {telestrokeNote.diagnosis && getPathwayForDiagnosis(telestrokeNote.diagnosis) !== 'mimic' && (
                          <details className="bg-white border border-amber-200 rounded-xl shadow-md">
                            <summary className="cursor-pointer p-4 font-semibold text-amber-900 hover:bg-amber-50 rounded-lg flex items-center justify-between">
                              <span className="flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="users" className="w-5 h-5 text-amber-600"></i>
                                Special Populations &amp; Rehab
                              </span>
                              <span className="text-xs text-amber-500 font-normal">Pregnancy, Craniectomy, Rehab Referral</span>
                            </summary>
                            <div className="p-4 pt-0 space-y-4">
                              {/* Stroke in Pregnancy */}
                              <div className="bg-pink-50 border border-pink-200 rounded-lg p-3">
                                <h4 className="font-semibold text-pink-800 mb-2">Stroke in Pregnancy (AHA 2026)</h4>
                                <label className="flex items-center gap-2 mb-2">
                                  <input type="checkbox" checked={!!telestrokeNote.pregnancyStroke}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, pregnancyStroke: c})); }}
                                    className="text-pink-600" />
                                  <span className="text-sm font-medium">Patient is pregnant or postpartum</span>
                                </label>
                                {telestrokeNote.pregnancyStroke && (
                                  <div className="text-xs text-pink-700 space-y-1 ml-6">
                                    <p>• TNK is a <strong>relative</strong> contraindication — weigh benefit vs risk, consult OB/GYN</p>
                                    <p>• EVT is preferred for LVO (no systemic thrombolytic exposure)</p>
                                    <p>• ASA 81 mg is safe in pregnancy</p>
                                    <p>• Avoid warfarin in first trimester; LMWH preferred</p>
                                    <p>• Consider preeclampsia/eclampsia, RCVS, and CVT in differential</p>
                                  </div>
                                )}
                              </div>

                              {/* Cancer-Associated Stroke */}
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <h4 className="font-semibold text-amber-800 mb-2">Cancer-Associated Stroke</h4>
                                <label className="flex items-center gap-2 mb-2">
                                  <input type="checkbox" checked={!!telestrokeNote.activeCancer}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, activeCancer: c})); }}
                                    className="text-amber-600" />
                                  <span className="text-sm font-medium">Patient has active malignancy</span>
                                </label>
                                {telestrokeNote.activeCancer && (
                                  <div className="text-xs text-amber-700 space-y-1 ml-6">
                                    <p>• <strong>Extended workup:</strong> D-dimer, fibrinogen, blood smear, blood cultures if febrile, TTE→TEE (NBTE), body CT</p>
                                    <p>• <strong>TNK:</strong> Use standard criteria. Avoid if brain metastases or platelets &lt;100K</p>
                                    <p>• <strong>Mechanism:</strong> Multiterritory infarcts + elevated D-dimer → suspect Trousseau syndrome (cancer hypercoagulability)</p>
                                    <p>• <strong>Secondary prevention:</strong> Cancer-related mechanism → LMWH preferred (enoxaparin 1 mg/kg BID). Conventional mechanism → standard antiplatelet</p>
                                    <p>• <strong>Consults:</strong> Oncology for shared decision-making. Goals of care central.</p>
                                  </div>
                                )}
                              </div>

                              {/* Sickle Cell Disease */}
                              <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                <h4 className="font-semibold text-red-800 mb-2">Sickle Cell Disease Stroke</h4>
                                <label className="flex items-center gap-2 mb-2">
                                  <input type="checkbox" checked={!!telestrokeNote.sickleCellDisease}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, sickleCellDisease: c})); }}
                                    className="text-red-600" />
                                  <span className="text-sm font-medium">Patient has sickle cell disease</span>
                                </label>
                                {telestrokeNote.sickleCellDisease && (
                                  <div className="text-xs text-red-700 space-y-1 ml-6">
                                    <p className="font-bold">⚠ URGENT: Initiate exchange transfusion</p>
                                    <p>• Target: HbS &lt;30%, total Hgb ~10 g/dL (avoid &gt;10 — hyperviscosity)</p>
                                    <p>• If exchange unavailable: simple transfusion to Hgb 10 as bridge</p>
                                    <p>• TNK is NOT contraindicated — but do not delay exchange transfusion</p>
                                    <p>• Contact transfusion medicine/hematology STAT</p>
                                    <p>• Secondary prevention: chronic exchange transfusion + hydroxyurea</p>
                                  </div>
                                )}
                              </div>

                              {/* Infective Endocarditis */}
                              <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                <h4 className="font-semibold text-orange-800 mb-2">Infective Endocarditis</h4>
                                <label className="flex items-center gap-2 mb-2">
                                  <input type="checkbox" checked={!!telestrokeNote.infectiveEndocarditis}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, infectiveEndocarditis: c})); }}
                                    className="text-orange-600" />
                                  <span className="text-sm font-medium">Suspected infective endocarditis</span>
                                </label>
                                {telestrokeNote.infectiveEndocarditis && (
                                  <div className="text-xs text-orange-700 space-y-1 ml-6">
                                    <p className="font-bold">⚠ TNK is CONTRAINDICATED. AVOID anticoagulation.</p>
                                    <p>• <strong>EVT preferred</strong> for LVO with disabling deficits</p>
                                    <p>• Blood cultures x3 (separate sites) before antibiotics</p>
                                    <p>• STAT TTE → TEE (vegetations, abscess)</p>
                                    <p>• CTA head/neck: screen for mycotic aneurysms</p>
                                    <p>• Consults: ID (antibiotics 4-6 weeks IV), cardiac surgery</p>
                                    <p>• Exception: mechanical prosthetic valve — continue anticoagulation</p>
                                  </div>
                                )}
                              </div>

                              {/* Decompressive Craniectomy */}
                              <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                <h4 className="font-semibold text-red-800 mb-2">Decompressive Craniectomy Decision Support</h4>
                                <label className="flex items-center gap-2 mb-2">
                                  <input type="checkbox" checked={!!(telestrokeNote.decompressiveCraniectomy || {}).considered}
                                    onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, decompressiveCraniectomy: {...(prev.decompressiveCraniectomy || {}), considered: c}})); }}
                                    className="text-red-600" />
                                  <span className="text-sm font-medium">Malignant MCA infarction — craniectomy being considered</span>
                                </label>
                                {(telestrokeNote.decompressiveCraniectomy || {}).considered && (
                                  <div className="space-y-2 ml-6">
                                    <div className="text-xs text-red-700 space-y-1">
                                      <p><strong>DECIMAL/DESTINY/HAMLET criteria:</strong></p>
                                      <p>• Age 18-60: strong benefit (NNT ~2 for survival, ~4 for mRS 0-3)</p>
                                      <p>• Age &gt;60 (DESTINY II): survival benefit but higher rate of severe disability</p>
                                      <p>• NIHSS &gt;15, infarct &gt;50% MCA territory on imaging</p>
                                      <p>• Surgery within 48 hours of symptom onset (ideally &lt;24h)</p>
                                      <p>• <strong>Goals-of-care discussion is critical</strong> — discuss functional outcomes</p>
                                    </div>
                                    <div className="bg-blue-50 border border-blue-200 rounded p-2 mt-2">
                                      <p className="text-xs font-semibold text-blue-800 mb-1">Cerebellar Infarction / Hemorrhage:</p>
                                      <div className="text-xs text-blue-700 space-y-0.5">
                                        <p>• Suboccipital decompressive craniectomy for cerebellar swelling with brainstem compression (Class I, LOE B-NR)</p>
                                        <p>• EVD for acute obstructive hydrocephalus</p>
                                        <p>• Imaging: posterior fossa CT/MRI, assess 4th ventricle compression</p>
                                        <p>• Earlier surgery (&lt;24h) associated with better outcomes</p>
                                      </div>
                                    </div>
                                    <select
                                      value={(telestrokeNote.decompressiveCraniectomy || {}).timing || ''}
                                      onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, decompressiveCraniectomy: {...(prev.decompressiveCraniectomy || {}), timing: v}})); }}
                                      className="w-full px-2 py-1 border border-slate-300 rounded text-sm mt-2">
                                      <option value="">-- Decision --</option>
                                      <option value="proceeding-supra">Proceeding — supratentorial craniectomy</option>
                                      <option value="proceeding-posterior">Proceeding — suboccipital decompression</option>
                                      <option value="monitoring">Close monitoring — may proceed if deterioration</option>
                                      <option value="not-candidate">Not a candidate (age, goals-of-care, timing)</option>
                                    </select>
                                  </div>
                                )}
                              </div>

                              {/* Decompressive Craniectomy — DESTINY II Consent Data */}
                              {(telestrokeNote.decompressiveCraniectomy || {}).considered && (
                                <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-slate-800 mb-2 text-sm">DESTINY II Outcomes Data (Age &gt;60) — For Shared Decision-Making</h4>
                                  <div className="text-xs text-slate-700 space-y-1">
                                    <div className="grid grid-cols-2 gap-2">
                                      <div className="bg-white p-2 rounded border">
                                        <p className="font-semibold">With Surgery:</p>
                                        <p>• 6-mo survival: 63%</p>
                                        <p>• mRS 0-3: 6%</p>
                                        <p>• mRS 4: 32%</p>
                                        <p>• mRS 5: 25%</p>
                                      </div>
                                      <div className="bg-white p-2 rounded border">
                                        <p className="font-semibold">Without Surgery:</p>
                                        <p>• 6-mo survival: 24%</p>
                                        <p>• mRS 0-3: 3%</p>
                                        <p>• mRS 4: 15%</p>
                                        <p>• mRS 5: 6%</p>
                                      </div>
                                    </div>
                                    <p className="text-amber-700 font-medium mt-1">Surgery improves survival but most survivors have moderate-to-severe disability. Discuss functional outcomes and patient values prior to consent.</p>
                                  </div>
                                </div>
                              )}

                              {/* CVT Anticoagulation Phases */}
                              {(getPathwayForDiagnosis(telestrokeNote.diagnosis) === 'cvt' || telestrokeNote.diagnosis === 'cvt') && (
                                <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                                  <h4 className="font-semibold text-indigo-800 mb-2">CVT Anticoagulation Phases (CSBP 2024)</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                      <label className="text-xs text-slate-600">Acute Phase (0-14 days)</label>
                                      <select value={(telestrokeNote.cvtAnticoag || {}).acutePhase || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, cvtAnticoag: {...(prev.cvtAnticoag || {}), acutePhase: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                        <option value="">Select</option>
                                        <option value="ufh-infusion">UFH infusion (if HIT concern or surgery likely)</option>
                                        <option value="lmwh">LMWH (preferred — enoxaparin 1mg/kg BID)</option>
                                      </select>
                                    </div>
                                    <div>
                                      <label className="text-xs text-slate-600">Transition Agent</label>
                                      <select value={(telestrokeNote.cvtAnticoag || {}).transitionAgent || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, cvtAnticoag: {...(prev.cvtAnticoag || {}), transitionAgent: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                        <option value="">Select</option>
                                        <option value="warfarin">Warfarin INR 2-3 (MANDATORY for APS)</option>
                                        <option value="doac">DOAC (non-APS, after acute phase stabilization)</option>
                                      </select>
                                    </div>
                                    <div>
                                      <label className="text-xs text-slate-600">Duration</label>
                                      <select value={(telestrokeNote.cvtAnticoag || {}).duration || ''}
                                        onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, cvtAnticoag: {...(prev.cvtAnticoag || {}), duration: v}})); }}
                                        className="w-full px-2 py-1 border border-slate-300 rounded text-xs">
                                        <option value="">Select</option>
                                        <option value="3-6mo">3-6 months (provoked — OCP, pregnancy, surgery)</option>
                                        <option value="6-12mo">6-12 months (unprovoked)</option>
                                        <option value="indefinite">Indefinite (recurrent VTE, APS, severe thrombophilia)</option>
                                      </select>
                                    </div>
                                  </div>
                                  <div className="mt-2 grid grid-cols-2 gap-2">
                                    <label className="flex items-center gap-1 text-xs">
                                      <input type="checkbox" checked={!!(telestrokeNote.cvtAnticoag || {}).apsStatus}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtAnticoag: {...(prev.cvtAnticoag || {}), apsStatus: c}})); }} />
                                      APS confirmed/suspected (use WARFARIN only, DOACs contraindicated)
                                    </label>
                                    <label className="flex items-center gap-1 text-xs">
                                      <input type="checkbox" checked={!!(telestrokeNote.cvtAnticoag || {}).etiologyProvoked}
                                        onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtAnticoag: {...(prev.cvtAnticoag || {}), etiologyProvoked: c}})); }} />
                                      Provoked etiology identified
                                    </label>
                                  </div>
                                  {(telestrokeNote.cvtAnticoag || {}).apsStatus && (telestrokeNote.cvtAnticoag || {}).transitionAgent === 'doac' && (
                                    <div className="mt-1 p-2 bg-red-100 border border-red-300 rounded text-xs text-red-800">
                                      <strong>CONTRAINDICATED:</strong> DOACs are inferior to warfarin in APS (TRAPS trial, ASTRO-APS). Switch to warfarin INR 2-3.
                                    </div>
                                  )}
                                </div>
                              )}

                              {/* Rehabilitation Intensity Prescription */}
                              <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <h4 className="font-semibold text-blue-800 mb-2">Rehabilitation Intensity Prescription (ESO/CSBP 2024)</h4>
                                <div className="text-xs text-slate-700 space-y-1">
                                  <p><strong>Recommended intensity:</strong> Minimum 3 hours/day, 5 days/week of active task-specific therapy (Class I, LOE A — AVERT, CSBP 2024).</p>
                                  <p><strong>Early mobilization:</strong> Begin within 24-48h post-stroke. Avoid very early high-dose mobilization within 24h (AVERT — increased odds of poor outcome at 3 months).</p>
                                  <p><strong>Aphasia referral:</strong> Refer to SLP within 30 days. RELEASE: higher-intensity aphasia therapy (8+ hours/week) is associated with greater improvement.</p>
                                </div>
                                <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                                  <label className="flex items-center gap-1 text-xs">
                                    <input type="checkbox"
                                      checked={!!(telestrokeNote.rehabReferral || {}).intensityPrescribed}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, rehabReferral: {...(prev.rehabReferral || {}), intensityPrescribed: c}})); }} />
                                    3h/day × 5d/wk rehab intensity prescribed
                                  </label>
                                  <label className="flex items-center gap-1 text-xs">
                                    <input type="checkbox"
                                      checked={!!(telestrokeNote.rehabReferral || {}).aphasiaReferral30d}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, rehabReferral: {...(prev.rehabReferral || {}), aphasiaReferral30d: c}})); }} />
                                    Aphasia SLP referral within 30 days
                                  </label>
                                </div>
                              </div>

                              {/* VCI / Cognitive Screening */}
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <h4 className="font-semibold text-purple-800 mb-2 text-sm">Vascular Cognitive Impairment (VCI) Screening</h4>
                                <div className="text-xs text-slate-700 space-y-1 mb-2">
                                  <p><strong>Screen at:</strong> Pre-discharge, 3 months, and 12 months (AHA/ASA 2021 VCI Scientific Statement).</p>
                                  <p><strong>Tools:</strong> MoCA (primary — sensitive for executive/attention), NINDS-CSN 5-min protocol, or Addenbrooke's Cognitive Exam (ACE-III).</p>
                                  <p><strong>Triggers for expanded testing:</strong> MoCA &lt;22, patient/family cognitive concerns, multiple vascular risk factors, strategic infarct location (thalamic, angular gyrus, caudate).</p>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                  <label className="flex items-center gap-1 text-xs">
                                    <input type="checkbox"
                                      checked={!!(telestrokeNote.rehabReferral || {}).cognitiveScreenDischarge}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, rehabReferral: {...(prev.rehabReferral || {}), cognitiveScreenDischarge: c}})); }} />
                                    Screened at discharge
                                  </label>
                                  <label className="flex items-center gap-1 text-xs">
                                    <input type="checkbox"
                                      checked={!!(telestrokeNote.rehabReferral || {}).cognitiveScreen3mo}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, rehabReferral: {...(prev.rehabReferral || {}), cognitiveScreen3mo: c}})); }} />
                                    Screened at 3 months
                                  </label>
                                  <label className="flex items-center gap-1 text-xs">
                                    <input type="checkbox"
                                      checked={!!(telestrokeNote.rehabReferral || {}).neuropsychReferral}
                                      onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, rehabReferral: {...(prev.rehabReferral || {}), neuropsychReferral: c}})); }} />
                                    Neuropsych referral placed
                                  </label>
                                </div>
                              </div>

                              {/* Caregiver Training Checklist */}
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <h4 className="font-semibold text-amber-800 mb-2 text-sm">Caregiver Training Checklist</h4>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                  {[
                                    { key: 'strokeSigns', label: 'Stroke warning signs (BE-FAST)' },
                                    { key: 'medicationAdmin', label: 'Medication administration' },
                                    { key: 'bpMonitoring', label: 'Home BP monitoring' },
                                    { key: 'safeTransfers', label: 'Safe transfers & fall prevention' },
                                    { key: 'dysphagiaDiet', label: 'Modified diet / swallowing precautions' },
                                    { key: 'emergencyPlan', label: 'When to call 911' }
                                  ].map(item => (
                                    <label key={item.key} className="flex items-center gap-2">
                                      <input type="checkbox"
                                        checked={!!(telestrokeNote.rehabReferral || {})[`caregiver_${item.key}`]}
                                        onChange={(e) => { const k = `caregiver_${item.key}`, c = e.target.checked; setTelestrokeNote(prev => ({...prev, rehabReferral: {...(prev.rehabReferral || {}), [k]: c}})); }}
                                        className="text-amber-600" />
                                      <span className="text-xs text-slate-700">{item.label}</span>
                                    </label>
                                  ))}
                                </div>
                              </div>

                              {/* Rehab Referral Checklist */}
                              <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                <h4 className="font-semibold text-emerald-800 mb-2">Rehabilitation Referral Checklist</h4>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                  {[
                                    { key: 'pt', label: 'Physical Therapy (PT)' },
                                    { key: 'ot', label: 'Occupational Therapy (OT)' },
                                    { key: 'slp', label: 'Speech-Language Pathology (SLP)' },
                                    { key: 'neuropsych', label: 'Neuropsychology' },
                                    { key: 'socialWork', label: 'Social Work / Case Mgmt' },
                                    { key: 'vocationalRehab', label: 'Vocational Rehabilitation' }
                                  ].map(item => (
                                    <label key={item.key} className="flex items-center gap-2">
                                      <input type="checkbox"
                                        checked={!!(telestrokeNote.rehabReferral || {})[item.key]}
                                        onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, rehabReferral: {...(prev.rehabReferral || {}), [k]: c}})); }}
                                        className="text-emerald-600" />
                                      <span className="text-xs text-slate-700">{item.label}</span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            </div>
                          </details>
                        )}

                        {/* ===== DOCUMENTATION SECTION ===== */}
                        <div id="phase-documentation"></div>

                        {/* Discharge Checklist - Show when recommendations or disposition is being addressed */}
                        {telestrokeNote.diagnosis && (
                          <div id="discharge-checklist-section" className="bg-white border border-emerald-200 rounded-xl p-4 shadow-sm">
                            <div className="flex items-center justify-between mb-3">
                              <h3 className="text-lg font-bold text-emerald-900 flex items-center gap-2">
                                <i aria-hidden="true" data-lucide="clipboard-list" className="w-5 h-5"></i>
                                Discharge Checklist
                              </h3>
                              <div className="flex items-center gap-2">
                                {(() => {
                                  const dc = telestrokeNote.dischargeChecklist || {};
                                  const boolKeys = Object.entries(dc).filter(([k, v]) => typeof v === 'boolean');
                                  const total = boolKeys.length;
                                  const checked = boolKeys.filter(([k, v]) => v).length;
                                  return (
                                    <span className={`text-xs font-semibold px-2 py-0.5 rounded-full ${checked === total ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800'}`}>
                                      {checked}/{total}
                                    </span>
                                  );
                                })()}
                                <button
                                  type="button"
                                  onClick={() => setTelestrokeNote(prev => ({...prev, dischargeChecklistReviewed: !prev.dischargeChecklistReviewed}))}
                                  className={`text-xs px-2 py-1 rounded-lg font-medium ${telestrokeNote.dischargeChecklistReviewed ? 'bg-emerald-500 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                                >
                                  {telestrokeNote.dischargeChecklistReviewed ? 'Reviewed' : 'Mark Reviewed'}
                                </button>
                              </div>
                            </div>

                            <div className="flex items-center gap-3 mb-3 p-2 bg-emerald-50 rounded-lg">
                              <label className="text-sm font-medium text-emerald-800 whitespace-nowrap">Discharge NIHSS:</label>
                              <input type="number" min="0" max="42" step="1"
                                value={telestrokeNote.dischargeNIHSS}
                                onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, dischargeNIHSS: v})); }}
                                placeholder={nihssScore ? `${nihssScore} (admission)` : '___'}
                                className="w-20 px-2 py-1 border rounded text-sm text-center" />
                              {!telestrokeNote.dischargeNIHSS && nihssScore > 0 && (
                                <span className="text-xs text-amber-600">Defaults to admission NIHSS — update before finalizing</span>
                              )}
                            </div>

                            <div className="space-y-3">
                              {[
                                { heading: 'Medications', items: [
                                  { key: 'antiplateletOrAnticoag', label: 'Antiplatelet or anticoagulation prescribed' },
                                  { key: 'statinPrescribed', label: 'High-intensity statin prescribed' },
                                  { key: 'bpMedOptimized', label: 'BP medications optimized (target <130/80)' },
                                  { key: 'diabetesManaged', label: 'Diabetes management addressed' }
                                ]},
                                { heading: 'Safety & Monitoring', items: [
                                  { key: 'swallowScreened', label: 'Dysphagia screening completed', hasDetail: 'swallowScreenResult', detailPlaceholder: 'Result: passed / failed / modified diet' },
                                  { key: 'dvtProphylaxis', label: 'DVT prophylaxis ordered', hasDetail: 'dvtProphylaxisType', detailPlaceholder: 'Type: SCDs / enoxaparin / heparin' },
                                  { key: 'repeatCT24h', label: 'Repeat CT Head ordered (24h)' },
                                  { key: 'mriOrdered', label: 'MRI Brain ordered' }
                                ]},
                                { heading: 'Follow-up', items: [
                                  { key: 'followUpNeurology', label: 'Neurology follow-up', hasDetail: 'followUpNeurologyTimeframe', detailPlaceholder: 'Timeframe: 2 weeks / 1 month / 3 months' },
                                  { key: 'followUpPCP', label: 'PCP follow-up', hasDetail: 'followUpPCPTimeframe', detailPlaceholder: 'Timeframe: 1 week / 2 weeks' },
                                  { key: 'followUpCardiology', label: 'Cardiology follow-up (if indicated)' }
                                ]},
                                { heading: 'Rehabilitation & Education', items: [
                                  { key: 'rehabilitationOrdered', label: 'Rehabilitation ordered', hasDetail: 'rehabilitationType', detailPlaceholder: 'Type: acute rehab / SNF / home PT/OT/ST' },
                                  { key: 'patientEducation', label: 'Stroke education provided' },
                                  { key: 'drivingRestrictions', label: 'Driving restrictions discussed' },
                                  { key: 'smokingCessation', label: 'Smoking cessation counseled' },
                                  { key: 'dietCounseling', label: 'Diet counseling (Mediterranean/DASH)' },
                                  { key: 'exerciseCounseling', label: 'Exercise counseling (150 min/wk)' }
                                ]}
                              ].map(group => (
                                <div key={group.heading}>
                                  <h5 className="text-xs font-semibold text-emerald-700 uppercase tracking-wide mb-1">{group.heading}</h5>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1">
                                    {group.items.map(item => (
                                      <div key={item.key}>
                                        <label className="flex items-center gap-2 py-1 cursor-pointer">
                                          <input
                                            type="checkbox"
                                            checked={!!(telestrokeNote.dischargeChecklist || {})[item.key]}
                                            onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                              dischargeChecklist: {
                                                ...(prev.dischargeChecklist || {}),
                                                [item.key]: e.target.checked
                                              }
                                            }))}
                                            className="rounded border-emerald-300 text-emerald-600"
                                          />
                                          <span className="text-sm text-slate-700">{item.label}</span>
                                        </label>
                                        {item.hasDetail && (telestrokeNote.dischargeChecklist || {})[item.key] && (
                                          <input
                                            type="text"
                                            value={(telestrokeNote.dischargeChecklist || {})[item.hasDetail] || ''}
                                            onChange={(e) => setTelestrokeNote(prev => ({...prev,
                                              dischargeChecklist: {
                                                ...(prev.dischargeChecklist || {}),
                                                [item.hasDetail]: e.target.value
                                              }
                                            }))}
                                            placeholder={item.detailPlaceholder}
                                            className="ml-6 w-[calc(100%-1.5rem)] px-2 py-1 border border-emerald-200 rounded text-xs focus:ring-1 focus:ring-emerald-500 mb-1"
                                          />
                                        )}
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              ))}
                            </div>

                            <div className="mt-2 text-xs text-slate-500 italic">
                              Based on AHA/ASA Secondary Stroke Prevention 2021 &amp; Systemic Complications of Acute Stroke 2024 guidelines
                            </div>
                          </div>
                        )}

                        {/* Post-TNK Monitoring Protocol */}
                        {telestrokeNote.tnkRecommended && telestrokeNote.diagnosisCategory === 'ischemic' && (
                          <div className="bg-white border-2 border-emerald-300 rounded-xl p-4 shadow-md">
                            <h3 className="text-md font-bold text-emerald-900 mb-2 flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="activity" className="w-4 h-4"></i>
                              Post-Thrombolytic Monitoring Protocol
                            </h3>
                            <div className="space-y-2">
                              {[
                                { key: 'neuroChecksQ15min', label: 'Neuro checks q15min x 2h, then q30min x 6h, then q1h x 16h', detail: 'Document NIHSS at 2h and 24h post-TNK' },
                                { key: 'bpChecksQ15min', label: 'BP checks q15min x 2h (target <180/105)', detail: 'Nicardipine or labetalol IV if exceeded' },
                                { key: 'bleedingWatch', label: 'Bleeding precautions initiated', detail: 'No arterial punctures, NG tubes, or Foley for 24h if possible. Hold anticoag/antiplatelet 24h.' },
                                { key: 'repeatImagingOrdered', label: 'Repeat imaging ordered (CT at 24h)', detail: 'Before starting anticoagulation or antiplatelet therapy' },
                                { key: 'cardiacMonitoring', label: 'Continuous cardiac monitoring', detail: 'Assess for reperfusion arrhythmias, troponin at baseline and 6h' }
                              ].map(item => (
                                <label key={item.key} className="flex items-start gap-2 cursor-pointer">
                                  <input type="checkbox"
                                    checked={!!(telestrokeNote.postTNKMonitoring || {})[item.key]}
                                    onChange={(e) => { const k = item.key, c = e.target.checked; setTelestrokeNote(prev => ({...prev, postTNKMonitoring: {...(prev.postTNKMonitoring || {}), [k]: c}})); }}
                                    className="mt-0.5 w-4 h-4 text-emerald-600" />
                                  <div>
                                    <span className="text-sm font-medium text-slate-800">{item.label}</span>
                                    <span className="block text-xs text-slate-500">{item.detail}</span>
                                  </div>
                                </label>
                              ))}
                            </div>
                            {/* sICH Risk Estimation */}
                            {(() => {
                              let sichRisk = 0;
                              const age = parseInt(telestrokeNote.age, 10);
                              const nihss = parseInt(telestrokeNote.nihss || nihssScore, 10);
                              const glucose = parseFloat(telestrokeNote.glucose);
                              if (age >= 80) sichRisk++;
                              if (nihss >= 20) sichRisk++;
                              if (glucose > 400) sichRisk++;
                              if ((telestrokeNote.pmh || '').toLowerCase().includes('diabet')) sichRisk++;
                              if (aspectsScore != null && aspectsScore <= 4) sichRisk++;
                              const label = sichRisk >= 3 ? 'High' : sichRisk >= 1 ? 'Moderate' : 'Low';
                              const color = sichRisk >= 3 ? 'bg-red-50 border-red-300 text-red-800' : sichRisk >= 1 ? 'bg-amber-50 border-amber-300 text-amber-800' : 'bg-emerald-50 border-emerald-300 text-emerald-800';
                              return (
                                <div className={`mt-3 border rounded-lg p-2 text-xs ${color}`}>
                                  <strong>sICH Risk Estimate: {label}</strong> ({sichRisk}/5 factors: age &ge;80, NIHSS &ge;20, glucose &gt;400, diabetes, ASPECTS &le;4)
                                  {sichRisk >= 3 && <span className="block mt-1">Consider intensive monitoring and early goals-of-care discussion if sICH occurs.</span>}
                                </div>
                              );
                            })()}
                          </div>
                        )}

                        {/* Family / Caregiver Communication Log */}
                        <div className="bg-white border border-slate-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                          <h3 className="text-md font-bold text-slate-800 mb-2 flex items-center gap-2">
                            <i aria-hidden="true" data-lucide="users" className="w-4 h-4"></i>
                            Family Communication
                          </h3>
                          <div className="space-y-2">
                            <label className="flex items-center gap-2 cursor-pointer">
                              <input type="checkbox"
                                checked={!!(telestrokeNote.familyCommunication || {}).discussed}
                                onChange={(e) => { const c = e.target.checked; const now = c ? new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit', hour12: false}) : ''; setTelestrokeNote(prev => ({...prev, familyCommunication: {...(prev.familyCommunication || {}), discussed: c, time: c ? now : (prev.familyCommunication || {}).time}})); }}
                                className="w-4 h-4 text-slate-600" />
                              <span className="text-sm font-medium text-slate-700">Family/surrogate discussion completed</span>
                            </label>
                            {!!(telestrokeNote.familyCommunication || {}).discussed && (
                              <div className="grid grid-cols-2 gap-2 ml-6">
                                <div>
                                  <label htmlFor="input-family-whom" className="block text-xs text-slate-600 mb-1">Discussed with</label>
                                  <input id="input-family-whom" type="text"
                                    value={(telestrokeNote.familyCommunication || {}).withWhom || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, familyCommunication: {...(prev.familyCommunication || {}), withWhom: v}})); }}
                                    placeholder="e.g., spouse, daughter (POA)"
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                </div>
                                <div>
                                  <label htmlFor="input-family-time" className="block text-xs text-slate-600 mb-1">Time</label>
                                  <input id="input-family-time" type="time"
                                    value={(telestrokeNote.familyCommunication || {}).time || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, familyCommunication: {...(prev.familyCommunication || {}), time: v}})); }}
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                </div>
                                <div className="col-span-2">
                                  <label htmlFor="input-family-topics" className="block text-xs text-slate-600 mb-1">Topics discussed</label>
                                  <input id="input-family-topics" type="text"
                                    value={(telestrokeNote.familyCommunication || {}).topicsDiscussed || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, familyCommunication: {...(prev.familyCommunication || {}), topicsDiscussed: v}})); }}
                                    placeholder="Diagnosis, prognosis, treatment plan, goals of care..."
                                    className="w-full px-2 py-1 border border-slate-300 rounded text-sm" />
                                </div>
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Section 7: Recommendations */}
                        <div id="recommendations-section" className="bg-white border border-blue-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-blue-900">7. Recommendations</h3>
                            <i aria-hidden="true" data-lucide="clipboard-check" className="w-5 h-5 text-blue-600"></i>
                          </div>

                          {/* Auto-Note Generation Button */}
                          <div className="mb-3">
                            <button
                              type="button"
                              onClick={() => {
                                const recs = getContextualRecommendations();
                                const pathwayType = getPathwayForDiagnosis(telestrokeNote.diagnosis);
                                const age = telestrokeNote.age || '***';
                                const sex = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '***';
                                const dx = telestrokeNote.diagnosis || '[Diagnosis]';
                                const nihss = telestrokeNote.nihss || nihssScore || '';
                                const bp = telestrokeNote.presentingBP || '';
                                const ct = telestrokeNote.ctResults || '';
                                const cta = telestrokeNote.ctaResults || '';

                                let note = '';

                                // Header
                                note += `TELESTROKE CONSULTATION NOTE\n`;
                                note += `Date: ${new Date().toLocaleDateString()}\n\n`;

                                // HPI
                                note += `HPI: ${age} year old ${sex}`;
                                if (telestrokeNote.pmh) note += ` with PMH of ${telestrokeNote.pmh}`;
                                note += ` presenting with ${telestrokeNote.symptoms || '***'}.\n`;
                                if (lkwTime) {
                                  note += `Last known well: ${lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} on ${lkwTime.toLocaleDateString()}.\n`;
                                }
                                note += '\n';

                                // Exam
                                note += `EXAMINATION:\n`;
                                if (nihss) note += `NIHSS: ${nihss}`;
                                if (telestrokeNote.nihssDetails) note += ` (${telestrokeNote.nihssDetails})`;
                                if (nihss) note += '\n';
                                if (bp) note += `Presenting BP: ${bp}\n`;
                                if (telestrokeNote.affectedSide) note += `Affected side: ${telestrokeNote.affectedSide}\n`;
                                if (telestrokeNote.strokeTerritory) note += `Vascular territory: ${telestrokeNote.strokeTerritory}\n`;
                                if (telestrokeNote.strokePhenotype) note += `Stroke phenotype: ${telestrokeNote.strokePhenotype}\n`;
                                if (telestrokeNote.symptomTrajectory) note += `Symptom trajectory: ${telestrokeNote.symptomTrajectory}\n`;
                                if (telestrokeNote.symptomOnsetNIHSS) note += `Estimated onset NIHSS: ${telestrokeNote.symptomOnsetNIHSS}\n`;
                                note += '\n';

                                // Imaging
                                note += `IMAGING:\n`;
                                if (ct) note += `Head CT: ${ct}\n`;
                                if (cta) note += `CTA Head/Neck: ${cta}\n`;
                                if (telestrokeNote.ctpResults) note += `CTP: ${telestrokeNote.ctpResults}\n`;
                                if (aspectsScore != null) note += `ASPECTS: ${aspectsScore}\n`;
                                note += '\n';

                                // Assessment
                                note += `ASSESSMENT: ${dx}\n\n`;

                                // Pathway-specific summary
                                if (pathwayType === 'ischemic') {
                                  note += `PLAN:\n`;
                                  if (telestrokeNote.tnkRecommended) {
                                    note += `- TNK 0.25 mg/kg IV bolus (max 25 mg) recommended and administered`;
                                    if (telestrokeNote.weight) note += ` (weight: ${telestrokeNote.weight} kg${telestrokeNote.weightEstimated ? ' — ESTIMATED' : ''})`;

                                    if (telestrokeNote.tnkAdminTime) note += ` at ${telestrokeNote.tnkAdminTime}`;
                                    note += `.\n`;
                                  } else {
                                    note += `- IV TNK: Not recommended.\n`;
                                  }
                                  if (telestrokeNote.evtRecommended) {
                                    note += `- EVT: Recommended. Transfer to ${telestrokeNote.transferReceivingFacility || 'EVT-capable center'}.\n`;
                                  }
                                } else if (pathwayType === 'ich') {
                                  note += `PLAN:\n`;
                                  if (telestrokeNote.ichBPManaged) note += `- BP management initiated (target SBP <140 (Class IIa; avoid <130)).\n`;
                                  if (telestrokeNote.ichReversalInitiated) note += `- Anticoagulation reversal ordered.\n`;
                                  if (telestrokeNote.ichNeurosurgeryConsulted) note += `- Neurosurgery consulted.\n`;
                                  const ichSurg = telestrokeNote.ichSurgicalCriteria || {};
                                  if (ichSurg.surgeryDecision) note += `- Surgical decision: ${ichSurg.surgeryDecision}.\n`;
                                  if (ichSurg.cerebellarGt15mL) note += `- Cerebellar ICH >15 mL identified.\n`;
                                  if (ichSurg.hydrocephalus) note += `- Obstructive hydrocephalus present.\n`;
                                } else if (pathwayType === 'sah') {
                                  note += `PLAN:\n`;
                                  if (telestrokeNote.sahGrade) note += `- SAH Grade: ${telestrokeNote.sahGrade} (${telestrokeNote.sahGradeScale === 'huntHess' ? 'Hunt & Hess' : telestrokeNote.sahGradeScale === 'wfns' ? 'WFNS' : 'scale not specified'})\n`;
                                  if (telestrokeNote.sahBPManaged) note += `- BP management initiated (target SBP <160 pre-securing).\n`;
                                  if (telestrokeNote.sahNimodipine) note += `- Nimodipine 60 mg q4h started for DCI prevention.\n`;
                                  if (telestrokeNote.sahEVDPlaced) note += `- EVD placed for hydrocephalus management.\n`;
                                  if (telestrokeNote.sahNeurosurgeryConsulted) note += `- Neurosurgery consulted for aneurysm securing.\n`;
                                  if (telestrokeNote.sahAneurysmSecured) note += `- Aneurysm securing plan documented.\n`;
                                  if (telestrokeNote.sahAneurysmLocation) note += `- Aneurysm: ${telestrokeNote.sahAneurysmLocation}${telestrokeNote.sahAneurysmSize ? `, ${telestrokeNote.sahAneurysmSize} mm` : ''}\n`;
                                  if (telestrokeNote.sahSecuringMethod) note += `- Securing plan: ${telestrokeNote.sahSecuringMethod}\n`;
                                  const vmC = telestrokeNote.sahVasospasmMonitoring || {};
                                  const vmCItems = [];
                                  if (vmC.tcdOrdered) vmCItems.push('TCD monitoring');
                                  if (vmC.neuroChecksQ1h) vmCItems.push('neuro checks q1h');
                                  if (vmC.sodiumMonitoring) vmCItems.push('sodium q6-8h');
                                  if (vmC.dciSuspected) vmCItems.push('DCI suspected');
                                  if (vmC.inducedHypertension) vmCItems.push('induced hypertension');
                                  if (vmCItems.length) note += `- DCI monitoring: ${vmCItems.join(', ')}.\n`;
                                  if (vmC.notes) note += `- DCI notes: ${vmC.notes}\n`;
                                } else if (pathwayType === 'cvt') {
                                  note += `PLAN:\n`;
                                  if (telestrokeNote.cvtAnticoagStarted) note += `- Anticoagulation initiated (${telestrokeNote.cvtAnticoagType || 'agent selected'}).\n`;
                                  if (telestrokeNote.cvtIcpManaged) note += `- ICP management addressed.\n`;
                                  if (telestrokeNote.cvtSeizureManaged) note += `- Seizure management addressed.\n`;
                                  if (telestrokeNote.cvtHematologyConsulted) note += `- Hematology consulted for thrombophilia workup.\n`;
                                } else if (pathwayType === 'tia') {
                                  note += `PLAN:\n`;
                                  note += `- Admit for urgent inpatient TIA workup (Class I, LOE B-NR).\n`;
                                  const tiaW = telestrokeNote.tiaWorkup || {};
                                  const tiaComplete = Object.values(tiaW).filter(Boolean).length;
                                  const tiaTotal = Object.keys(tiaW).length;
                                  note += `- TIA workup: ${tiaComplete}/${tiaTotal} items completed.\n`;
                                  if (tiaW.mriDwi) note += `- MRI DWI obtained.\n`;
                                  if (tiaW.ctaHeadNeck) note += `- CTA Head/Neck obtained.\n`;
                                } else if (pathwayType === 'dissection') {
                                  note += `PLAN:\n`;
                                  const diss = telestrokeNote.dissectionPathway || {};
                                  if (diss.antithromboticType) note += `- Antithrombotic therapy: ${diss.antithromboticType.replace(/-/g, ' ')}.\n`;
                                  if (diss.imagingFollowUp) note += `- Vascular imaging follow-up: ${diss.imagingFollowUp}.\n`;
                                  note += `- Cervical manipulation avoidance counseled.\n`;
                                }

                                // TOAST Classification
                                if (telestrokeNote.toastClassification) {
                    
                                  note += `\nETIOLOGIC CLASSIFICATION (TOAST): ${TOAST_LABELS[telestrokeNote.toastClassification] || telestrokeNote.toastClassification}\n`;
                                }

                                // Cardiac Workup
                                const cw = telestrokeNote.cardiacWorkup || {};
                                if (cw.ecgComplete || cw.telemetryOrdered || cw.echoOrdered || cw.extendedMonitoringType) {
                                  note += `\nCARDIAC WORKUP:\n`;
                                  if (cw.ecgComplete) note += `- 12-Lead ECG completed.\n`;
                                  if (cw.telemetryOrdered) note += `- Inpatient telemetry ordered.\n`;
                                  if (cw.echoOrdered) note += `- Echo ordered.\n`;
                                  if (cw.extendedMonitoringType) {
                                    const monLabels = { '30-day-monitor': '30-day ambulatory monitor', '14-day-patch': '14-day continuous patch', 'ilr': 'Implantable loop recorder', 'none-af-known': 'Not needed (AF known)', 'none-other': 'Not indicated' };
                                    note += `- Extended monitoring: ${monLabels[cw.extendedMonitoringType] || cw.extendedMonitoringType}.\n`;
                                  }
                                  if (cw.pfoEvaluation) note += `- PFO evaluation: ${cw.pfoEvaluation.replace(/-/g, ' ')}.\n`;
                                  if (cw.pascalClassification) note += `- PASCAL classification: ${cw.pascalClassification}.\n`;
                                }

                                // Screening Tools
                                const st = telestrokeNote.screeningTools || {};
                                if (st.phq2Score || st.mocaScore || st.stopBangScore || st.seizureRisk) {
                                  note += `\nSCREENING:\n`;
                                  if (st.phq2Score) note += `- PHQ-2: ${st.phq2Score}/6 (${st.phq2Positive ? 'POSITIVE' : 'negative'}).\n`;
                                  if (st.mocaScore) note += `- MoCA: ${st.mocaScore}/30${st.mocaReferral ? ' — neuropsych referral placed' : ''}.\n`;
                                  if (st.stopBangScore) note += `- STOP-BANG: ${st.stopBangScore}/8 (${parseInt(st.stopBangScore, 10) >= 5 ? 'HIGH risk' : parseInt(st.stopBangScore, 10) >= 3 ? 'INTERMEDIATE risk' : 'low risk'} OSA).\n`;
                                  if (st.seizureRisk) note += `- Seizure status: ${st.seizureRisk.replace(/-/g, ' ')}.\n`;
                                }

                                // Acute Care Protocols
                                const ht = telestrokeNote.hemorrhagicTransformation || {};
                                if (ht.detected) {
                                  note += `\nHEMORRHAGIC TRANSFORMATION:\n`;
                                  if (ht.classification) note += `- ECASS classification: ${ht.classification}.\n`;
                                  if (ht.symptomatic) note += `- Symptomatic ICH (sICH).\n`;
                                  if (ht.antithromboticHeld) note += `- Antithrombotics held.\n`;
                                  if (ht.reimagingPlanned) note += `- Repeat imaging planned.\n`;
                                }
                                const dysph = telestrokeNote.dysphagiaScreening || {};
                                if (dysph.bedsideScreenPerformed || dysph.npoStatus || dysph.slpConsultOrdered) {
                                  note += `\nDYSPHAGIA:\n`;
                                  if (dysph.bedsideScreenPerformed) note += `- Bedside swallow screen: ${dysph.bedsideScreenResult || 'performed'}.\n`;
                                  if (dysph.npoStatus) note += `- NPO status.\n`;
                                  if (dysph.slpConsultOrdered) note += `- SLP consult ordered.\n`;
                                  if (dysph.instrumentalAssessment && dysph.instrumentalAssessment !== 'not-needed') note += `- Instrumental assessment: ${dysph.instrumentalAssessment.toUpperCase()}.\n`;
                                }
                                const mob = telestrokeNote.earlyMobilization || {};
                                if (mob.timingDecision) {
                                  note += `\nMOBILIZATION: ${mob.timingDecision.replace(/-/g, ' ')}${mob.mobilizationStarted ? ' — initiated' : ''}.\n`;
                                }
                                const doac = telestrokeNote.doacTiming || {};
                                if (doac.strokeSeverity || doac.doacAgent) {
                                  note += `\nDOAC TIMING:\n`;
                                  if (doac.strokeSeverity) note += `- Severity: ${doac.strokeSeverity}. Recommended: ${doac.strokeSeverity === 'minor' ? 'within 48h' : doac.strokeSeverity === 'moderate' ? 'Day 3-5' : 'Day 6-14'}.\n`;
                                  if (doac.doacAgent) note += `- Agent: ${doac.doacAgent.replace(/-/g, ' ')}.\n`;
                                  if (doac.doacInitiationDay) note += `- Planned initiation: ${doac.doacInitiationDay}.\n`;
                                  if (doac.hemorrhagicTransformation) note += `- Note: HT present — repeat imaging before DOAC.\n`;
                                }
                                const carotid = telestrokeNote.carotidManagement || {};
                                if (carotid.stenosisDegree) {
                                  note += `\nCAROTID: ${carotid.stenosisSide || ''} ${carotid.stenosisDegree}% stenosis${carotid.symptomatic ? ' (symptomatic)' : ' (asymptomatic)'}.\n`;
                                  if (carotid.intervention) note += `- Plan: ${carotid.intervention.replace(/-/g, ' ')}.\n`;
                                }
                                const esus = telestrokeNote.esusWorkup || {};
                                if (esus.cardiacMonitoringType || esus.teePerformed || esus.hypercoagWorkup) {
                                  note += `\nESUS/CRYPTOGENIC WORKUP:\n`;
                                  if (esus.cardiacMonitoringType) note += `- Cardiac monitoring: ${esus.cardiacMonitoringType.replace(/-/g, ' ')}.\n`;
                                  if (esus.teePerformed) note += `- TEE: performed${esus.teeFindings ? ` — ${esus.teeFindings}` : ''}.\n`;
                                  if (esus.afDetected) note += `- AF DETECTED on monitoring.\n`;
                                  if (esus.hypercoagWorkup) note += `- Hypercoagulable workup ordered.\n`;
                                  if (esus.esusAntiplatelet) note += `- Antithrombotic: ${esus.esusAntiplatelet.replace(/-/g, ' ')}.\n`;
                                }
                                const ichAc = telestrokeNote.ichAnticoagResumption || {};
                                if (ichAc.decision) {
                                  note += `\nICH ANTICOAG RESUMPTION:\n`;
                                  if (ichAc.ichLocation) note += `- Location: ${ichAc.ichLocation}.\n`;
                                  if (ichAc.caaFeatures) note += `- CAA features present.\n`;
                                  if (ichAc.chadsVascScore) note += `- CHA2DS2-VASc: ${ichAc.chadsVascScore}.\n`;
                                  if (ichAc.hasbledScore) note += `- HAS-BLED: ${ichAc.hasbledScore}.\n`;
                                  note += `- Decision: ${ichAc.decision.replace(/-/g, ' ')}.\n`;
                                  if (ichAc.rationale) note += `- Rationale: ${ichAc.rationale}.\n`;
                                  if (ichAc.laaoConsidered) note += `- LAAO evaluation considered.\n`;
                                }

                                // Secondary Prevention
                                const sp = telestrokeNote.secondaryPrevention || {};
                                if (sp.statinDose || sp.antiplateletRegimen || sp.bpTarget) {
                                  note += `\nSECONDARY PREVENTION:\n`;
                                  if (sp.antiplateletRegimen) note += `- Antithrombotic: ${sp.antiplateletRegimen.replace(/-/g, ' ')}.\n`;
                                  if (sp.statinDose) note += `- Statin: ${sp.statinDose.replace(/-/g, ' ')}${sp.ezetimibeAdded ? ' + ezetimibe' : ''}${sp.pcsk9Added ? ' + PCSK9i' : ''}${sp.inclisiranConsidered ? ' + inclisiran' : ''}${sp.ldlCurrent ? ` (LDL ${sp.ldlCurrent} mg/dL)` : ''}.\n`;
                                  if (sp.bpTarget) note += `- BP target: ${sp.bpTarget}${sp.bpIntensiveCandidate ? ' (intensive candidate)' : ''}.\n`;
                                  if (sp.diabetesManagement) note += `- Diabetes: ${sp.diabetesManagement.replace(/-/g, ' ')}.\n`;
                                  if (sp.glp1ra && sp.glp1ra !== 'not-indicated') note += `- GLP-1 RA: ${sp.glp1ra.replace(/-/g, ' ')}${sp.glp1raIndication ? ` (${sp.glp1raIndication.replace(/-/g, ' ')})` : ''}.\n`;
                                  if (sp.sglt2i && sp.sglt2i !== 'not-indicated') note += `- SGLT2i: ${sp.sglt2i}${sp.sglt2iIndication ? ` (${sp.sglt2iIndication.replace(/-/g, ' ')})` : ''}.\n`;
                                  if (sp.colchicineConsidered) note += `- Colchicine 0.5 mg daily${sp.colchicineIndication ? ` — ${sp.colchicineIndication.replace(/-/g, ' ')}` : ''}.\n`;
                                  if (sp.cyp2c19Tested) note += `- CYP2C19: ${sp.cyp2c19Result ? sp.cyp2c19Result.replace(/-/g, ' ') : 'tested, result pending'}.\n`;
                                  if (sp.smokingStatus) note += `- Smoking: ${sp.smokingStatus}.\n`;
                                  if (sp.exercisePlan) note += `- Exercise: ${sp.exercisePlan}${sp.exerciseMinPerWeek ? ` (${sp.exerciseMinPerWeek} min/wk)` : ''}.\n`;
                                  if (sp.dietPlan) note += `- Diet: ${sp.dietPlan}${sp.dietAdherence ? ` — adherence: ${sp.dietAdherence}` : ''}.\n`;
                                  if (sp.followUpTimeline) note += `- Follow-up: ${sp.followUpTimeline}.\n`;
                                }

                                // VTE Prophylaxis
                                const vte = telestrokeNote.vteProphylaxis || {};
                                if (vte.ipcApplied || vte.pharmacoProphylaxis) {
                                  note += `\nVTE PROPHYLAXIS:\n`;
                                  if (vte.ipcApplied) note += `- IPC applied on admission.\n`;
                                  if (vte.pharmacoProphylaxis) note += `- Pharmacologic: ${vte.pharmacoProphylaxis}${vte.enoxaparinDose ? ` ${vte.enoxaparinDose}` : ''}.\n`;
                                  if (vte.hematoStabilityConfirmed) note += `- Hemostatic stability confirmed.\n`;
                                }

                                // Post-TNK Angioedema
                                const angio = telestrokeNote.angioedema || {};
                                if (angio.detected) {
                                  note += `\nPOST-TNK ANGIOEDEMA:\n`;
                                  if (angio.severity) note += `- Severity: ${angio.severity}.\n`;
                                  if (angio.onsetTime) note += `- Onset: ${angio.onsetTime}.\n`;
                                  if (angio.aceInhibitorUse) note += `- ACE inhibitor use: Yes (discontinued).\n`;
                                  const steps = angio.stepsTaken || {};
                                  const stepLabels = { stopTnk: 'TNK stopped + ACEi held', steroids: 'Methylprednisolone/Diphenhydramine/Famotidine given', epinephrine: 'Epinephrine 0.3 mg IM administered', icatibant: 'Icatibant 30 mg SC or C1 esterase inhibitor given', airway: 'Airway intervention/intubation' };
                                  const doneSteps = Object.entries(steps).filter(([k, v]) => v).map(([k]) => stepLabels[k] || k);
                                  if (doneSteps.length > 0) { doneSteps.forEach(s => { note += `- ${s}.\n`; }); }
                                  if (angio.intubated) note += `- Patient intubated for airway protection.\n`;
                                  if (angio.resolved) note += `- Angioedema resolved.\n`;
                                }

                                // Fever Management
                                const fever = telestrokeNote.feverManagement || {};
                                if (fever.feverDetected || fever.feverProtocolInitiated) {
                                  note += `\nFEVER MANAGEMENT:\n`;
                                  if (fever.maxTemp) note += `- Max temp: ${fever.maxTemp}°C.\n`;
                                  if (fever.feverProtocolInitiated) note += `- FeSS bundle initiated.\n`;
                                  if (fever.bsasScore) note += `- BSAS score: ${fever.bsasScore}.\n`;
                                  if (fever.infectionWorkupSent) note += `- Infection workup sent.\n`;
                                  if (fever.escalationLevel) note += `- Escalation: ${fever.escalationLevel.replace(/-/g, ' ')}.\n`;
                                }

                                // Osmotic Therapy
                                const osm = telestrokeNote.osmoticTherapy || {};
                                if (osm.agentUsed) {
                                  note += `\nOSMOTIC THERAPY:\n`;
                                  note += `- Agent: ${osm.agentUsed}${osm.indication ? ` for ${osm.indication.replace(/-/g, ' ')}` : ''}.\n`;
                                  if (osm.baselineNa) note += `- Baseline Na+: ${osm.baselineNa} mEq/L${osm.baselineNaTime ? ` at ${osm.baselineNaTime}` : ''}.\n`;
                                  if (osm.repeatNa) note += `- Repeat Na+: ${osm.repeatNa} mEq/L${osm.repeatNaTime ? ` at ${osm.repeatNaTime}` : ''}.\n`;
                                  if (osm.baselineNa && osm.repeatNa && osm.baselineNaTime && osm.repeatNaTime) {
                                    const bNa = parseFloat(osm.baselineNa);
                                    const rNa = parseFloat(osm.repeatNa);
                                    const [bHn, bMn] = osm.baselineNaTime.split(':').map(Number);
                                    const [rHn, rMn] = osm.repeatNaTime.split(':').map(Number);
                                    if (!isNaN(bHn) && !isNaN(bMn) && !isNaN(rHn) && !isNaN(rMn)) {
                                    let hrsE = (rHn + rMn / 60) - (bHn + bMn / 60);
                                    if (hrsE <= 0) hrsE += 24;
                                    if (hrsE > 0.1 && !isNaN(bNa) && !isNaN(rNa)) {
                                      const delta = rNa - bNa;
                                      const proj24 = (delta / hrsE) * 24;
                                      note += `- Na+ correction: ${delta > 0 ? '+' : ''}${delta.toFixed(1)} mEq/L in ${hrsE.toFixed(1)}h (projected 24h: ${proj24 > 0 ? '+' : ''}${proj24.toFixed(1)} mEq/L).`;
                                      if (Math.abs(proj24) > 10) note += ` WARNING: EXCEEDS SAFE LIMIT (>10 mEq/L/24h).`;
                                      note += '\n';
                                    }
                                    }
                                  }
                                  if (osm.sodiumTarget) note += `- Na+ target: ${osm.sodiumTarget} mEq/L.\n`;
                                  if (osm.serumOsmolality) note += `- Serum osmolality: ${osm.serumOsmolality} mOsm/kg${parseFloat(osm.serumOsmolality) > 320 ? ' (>320 — hold mannitol)' : ''}.\n`;
                                  if (osm.mannitolOsmGap && parseFloat(osm.mannitolOsmGap) > 20) note += `- Osmol gap: ${osm.mannitolOsmGap} (>20 — mannitol accumulation).\n`;
                                }

                                // Nutritional Support
                                const nutr = telestrokeNote.nutritionalSupport || {};
                                if (nutr.feedingRoute) {
                                  note += `\nNUTRITION: Route: ${nutr.feedingRoute}.\n`;
                                  if (nutr.ngPlacementDay) note += `- NG placed day ${nutr.ngPlacementDay}.\n`;
                                  if (nutr.pegConsiderationDay) note += `- PEG consideration day ${nutr.pegConsiderationDay}.\n`;
                                  if (nutr.nutritionConsultOrdered) note += `- Nutrition consult ordered.\n`;
                                }

                                // Palliative Care
                                const pall = telestrokeNote.palliativeCare || {};
                                if (pall.goalsOfCareDiscussed || pall.consultOrdered) {
                                  note += `\nPALLIATIVE CARE / GOALS OF CARE:\n`;
                                  if (pall.goalsOfCareDiscussed) note += `- GOC discussed${pall.goalsOfCareOutcome ? `: ${pall.goalsOfCareOutcome.replace(/-/g, ' ')}` : ''}.\n`;
                                  if (pall.consultOrdered) note += `- Palliative care consult ordered.\n`;
                                  if (pall.dnrPostponementAlert) note += `- Note: DNR orders deferred per guideline (full care x 24-48h for ICH).\n`;
                                }

                                // Drug Interactions
                                const di = telestrokeNote.drugInteractions || {};
                                if (di.aedDoacInteraction || di.statinInteraction || di.doacDoseReductionCriteria) {
                                  note += `\nDRUG INTERACTION ALERTS:\n`;
                                  if (di.aedDoacInteraction) note += `- WARNING: ${di.aedType} reduces DOAC efficacy — consider warfarin or AED switch.\n`;
                                  if (di.statinInteraction) note += `- Statin interaction with ${di.statinInteractionDrug} — dose adjustment may be needed.\n`;
                                  if (di.doacDoseReductionCriteria) note += `- DOAC (${di.doacDoseReductionCriteria}) — dose reduction criteria reviewed.\n`;
                                }

                                // Anticoag Bridging
                                const bridge = telestrokeNote.anticoagBridging || {};
                                if (bridge.doacType) {
                                  note += `\nPERIPROCEDURAL ANTICOAG (PAUSE): ${bridge.doacType}${bridge.crCl ? `, CrCl ${bridge.crCl}` : ''}${bridge.procedureRisk ? `, ${bridge.procedureRisk} bleed risk` : ''}.\n`;
                                  if (bridge.warfarinBridgeIndication) note += `- Heparin bridging indicated (mechanical valve/APS).\n`;
                                }

                                // CVT Anticoagulation
                                const cvt = telestrokeNote.cvtAnticoag || {};
                                if (cvt.acutePhase || cvt.transitionAgent) {
                                  note += `\nCVT ANTICOAGULATION:\n`;
                                  if (cvt.acutePhase) note += `- Acute: ${cvt.acutePhase.replace(/-/g, ' ')}.\n`;
                                  if (cvt.transitionAgent) note += `- Transition: ${cvt.transitionAgent}.\n`;
                                  if (cvt.duration) note += `- Duration: ${cvt.duration}.\n`;
                                  if (cvt.apsStatus) note += `- APS confirmed — warfarin mandatory.\n`;
                                }

                                // mRS Tracking
                                const mrs = telestrokeNote.mrsAssessment || {};
                                const mrsEntries = Object.entries(mrs).filter(([k, v]) => v);
                                if (mrsEntries.length > 0) {
                                  note += `\nmRS TRACKING: ${mrsEntries.map(([k, v]) => `${k}: ${v}`).join(', ')}.\n`;
                                }

                                // Driving
                                const drv = telestrokeNote.drivingRestrictions || {};
                                if (drv.counselingProvided) {
                                  note += `\nDRIVING: Cessation counseling provided${drv.restrictionDuration ? `, restriction: ${drv.restrictionDuration}` : ''}${drv.commercialDriver ? ' (commercial driver — DMV notification)' : ''}.\n`;
                                }

                                // Return to Work
                                const rtw = telestrokeNote.returnToWork || {};
                                if (rtw.priorOccupation || rtw.vocationalRehabReferral) {
                                  note += `\nRETURN TO WORK:${rtw.priorOccupation ? ` Prior occupation: ${rtw.priorOccupation}.` : ''}${rtw.vocationalRehabReferral ? ' Vocational rehab referred.' : ''}${rtw.phasedReturnPlan ? ' Phased return plan discussed.' : ''}\n`;
                                }

                                // Spasticity / Pain / Fatigue
                                const spast = telestrokeNote.spasticity || {};
                                const cpain = telestrokeNote.centralPain || {};
                                const fatg = telestrokeNote.fatigue || {};
                                if (spast.screenPerformed || cpain.screenPerformed || fatg.screenPerformed) {
                                  note += `\nPOST-STROKE SCREENING:\n`;
                                  if (spast.screenPerformed) note += `- Spasticity: ${spast.ashworthScore ? `Ashworth ${spast.ashworthScore}` : 'screened'}${spast.botoxReferral ? ', botox referral placed' : ''}.\n`;
                                  if (cpain.screenPerformed) note += `- Central pain: ${cpain.painPresent ? `present (${cpain.painType || 'type unspecified'})${cpain.treatment ? `, Rx: ${cpain.treatment}` : ''}` : 'not present'}.\n`;
                                  if (fatg.screenPerformed) note += `- Fatigue: ${fatg.fatiguePresent ? `present, severity: ${fatg.severity || 'unrated'}` : 'not present'}.\n`;
                                }

                                // Substance / Hormonal
                                const sub = telestrokeNote.substanceScreening || {};
                                if (sub.alcoholAuditC || sub.substanceUseScreen) {
                                  note += `\nSUBSTANCE SCREENING:${sub.alcoholAuditC ? ` AUDIT-C: ${sub.alcoholAuditC}${parseInt(sub.alcoholAuditC, 10) >= 4 ? ' (POSITIVE)' : ''}.` : ''}${sub.alcoholCounseling ? ' Brief intervention provided.' : ''}${sub.substanceUseScreen ? ` Substances: ${sub.substancesIdentified || 'screened'}.` : ''}\n`;
                                }
                                const horm = telestrokeNote.hormonalRisk || {};
                                if (horm.combinedOCPUse || horm.hrtUse || horm.migraineWithAura) {
                                  note += `HORMONAL RISK:${horm.combinedOCPUse ? ' Combined OCP use — discontinue (Class III).' : ''}${horm.hrtUse ? ' HRT use — review risk/benefit.' : ''}${horm.migraineWithAura ? ' Migraine with aura — avoid estrogen-containing contraceptives.' : ''}${horm.counselingProvided ? ' Counseling provided.' : ''}\n`;
                                }

                                // Falls Risk
                                const falls = telestrokeNote.fallsRisk || {};
                                if (falls.screenPerformed) {
                                  note += `FALLS RISK: Screened${falls.highRisk ? ' — HIGH RISK' : ''}${falls.preventionPlanInitiated ? ', prevention plan initiated' : ''}${falls.balanceProgramReferral ? ', balance program referred' : ''}.\n`;
                                }

                                // Young Adult Workup
                                const ya = telestrokeNote.youngAdultWorkup || {};
                                if (ya.tier1Complete || ya.tier2Complete) {
                                  note += `\nYOUNG ADULT WORKUP:\n`;
                                  if (ya.tier1Complete) note += `- Tier 1 complete (CTA/MRA, TTE+bubble, ECG, telemetry, tox screen, basic labs).\n`;
                                  if (ya.tier2Complete) note += `- Tier 2 complete (TEE, extended monitoring, APL panel).\n`;
                                  const t3 = ya.tier3Items || {};
                                  const t3done = Object.entries(t3).filter(([k, v]) => v).map(([k]) => k.replace(/([A-Z])/g, ' $1').trim());
                                  if (t3done.length > 0) note += `- Tier 3: ${t3done.join(', ')}.\n`;
                                }

                                // Special Populations
                                if (telestrokeNote.pregnancyStroke) note += `\nSPECIAL: Pregnant/postpartum patient — see pregnancy-specific management above.\n`;
                                if (telestrokeNote.activeCancer) note += `SPECIAL: Active cancer — extended workup ordered (D-dimer, TEE, body CT). Secondary prevention tailored to mechanism.\n`;
                                if (telestrokeNote.sickleCellDisease) note += `SPECIAL: Sickle cell disease — exchange transfusion initiated (target HbS <30%, Hgb ~10). Hematology consulted.\n`;
                                if (telestrokeNote.infectiveEndocarditis) note += `SPECIAL: Infective endocarditis — TNK contraindicated, anticoagulation avoided. Blood cultures, TEE, mycotic aneurysm screen ordered. ID consulted.\n`;
                                if ((telestrokeNote.decompressiveCraniectomy || {}).considered) note += `DECOMPRESSIVE CRANIECTOMY: ${(telestrokeNote.decompressiveCraniectomy || {}).timing || 'being considered'}.\n`;
                                const rehab = telestrokeNote.rehabReferral || {};
                                const rehabItems = Object.entries(rehab).filter(([k, v]) => v && typeof v === 'boolean');
                                if (rehabItems.length > 0) {
                                  note += `\nREHAB: ${rehabItems.map(([k]) => k.replace(/([A-Z])/g, ' $1').replace(/caregiver_/g, 'Caregiver: ').trim()).join(', ')}.\n`;
                                }

                                // Guideline-based recommendations
                                if (recs.length > 0) {
                                  note += `\nGUIDELINE-BASED RECOMMENDATIONS:\n`;
                                  recs.forEach(rec => {
                                    note += `- ${rec.title}: ${rec.recommendation} [Class ${rec.classOfRec}, LOE ${rec.levelOfEvidence}] (${rec.guideline})\n`;
                                  });
                                }

                                // Disposition
                                if (telestrokeNote.disposition) {
                                  note += `\nDISPOSITION: ${telestrokeNote.disposition}\n`;
                                }
                                if (telestrokeNote.admitLocation) {
                                  note += `Admit to: ${telestrokeNote.admitLocation}\n`;
                                }

                                // Discharge checklist summary
                                const dc = telestrokeNote.dischargeChecklist || {};
                                const dcChecked = Object.entries(dc).filter(([k, v]) => v);
                                if (dcChecked.length > 0) {
                                  note += `\nDISCHARGE CHECKLIST ITEMS COMPLETED:\n`;
                                  const dcLabels = {
                                    antiplateletOrAnticoag: 'Antiplatelet/anticoagulation prescribed',
                                    statinPrescribed: `High-intensity statin prescribed${(telestrokeNote.secondaryPrevention || {}).statinDose ? ` (${(telestrokeNote.secondaryPrevention.statinDose || '').replace('-', ' ')})` : ''}`,
                                    bpMedOptimized: 'BP medications optimized',
                                    diabetesManaged: 'Diabetes management addressed',
                                    smokingCessation: 'Smoking cessation counseled',
                                    dietCounseling: 'Diet counseling provided',
                                    exerciseCounseling: 'Exercise counseling provided',
                                    followUpNeurology: 'Neurology follow-up scheduled',
                                    followUpPCP: 'PCP follow-up scheduled',
                                    rehabilitationOrdered: 'Rehabilitation ordered',
                                    patientEducation: 'Stroke education provided',
                                    drivingRestrictions: 'Driving restrictions discussed'
                                  };
                                  dcChecked.forEach(([key]) => {
                                    note += `- ${dcLabels[key] || key}\n`;
                                  });
                                }

                                // Trial eligibility auto-match
                                const trialResults2 = Object.values(trialEligibility).filter(Boolean);
                                const eligibleTrials2 = trialResults2.filter(t => t.status === 'eligible');
                                const needsInfoTrials2 = trialResults2.filter(t => t.status === 'needs_info');
                                if (eligibleTrials2.length > 0 || needsInfoTrials2.length > 0) {
                                  note += `\nCLINICAL TRIAL ELIGIBILITY:\n`;
                                  eligibleTrials2.forEach(t => {
                                    const cfg = TRIAL_ELIGIBILITY_CONFIG[t.trialId];
                                    note += `- ELIGIBLE: ${t.trialName} (${cfg?.nct || ''}) — ${t.quickDescription}. Criteria met: ${t.metCount}/${t.criteria.length}.\n`;
                                  });
                                  needsInfoTrials2.forEach(t => {
                                    const cfg = TRIAL_ELIGIBILITY_CONFIG[t.trialId];
                                    const missing = t.criteria.filter(c => c.status === 'unknown').map(c => c.label).join(', ');
                                    note += `- NEEDS INFO: ${t.trialName} (${cfg?.nct || ''}) — missing: ${missing}.\n`;
                                  });
                                }

                                // Post-TNK monitoring
                                const ptm = telestrokeNote.postTNKMonitoring || {};
                                const ptmItems = [];
                                if (ptm.neuroChecksQ15min) ptmItems.push('neuro checks q15min x 2h');
                                if (ptm.bpChecksQ15min) ptmItems.push('BP checks q15min x 2h');
                                if (ptm.bleedingWatch) ptmItems.push('bleeding precautions');
                                if (ptm.repeatImagingOrdered) ptmItems.push('repeat CT at 24h ordered');
                                if (ptm.cardiacMonitoring) ptmItems.push('continuous cardiac monitoring');
                                if (ptmItems.length) note += `\nPOST-THROMBOLYTIC MONITORING:\n- ${ptmItems.join('\n- ')}\n`;

                                // Family communication
                                const fc = telestrokeNote.familyCommunication || {};
                                if (fc.discussed) {
                                  note += `\nFAMILY COMMUNICATION:\n`;
                                  note += `- Discussion with ${fc.withWhom || 'family/surrogate'}`;
                                  if (fc.time) note += ` at ${fc.time}`;
                                  note += `.\n`;
                                  if (fc.topicsDiscussed) note += `- Topics: ${fc.topicsDiscussed}\n`;
                                }

                                setTelestrokeNote(prev => ({...prev, recommendationsText: note}));
                              }}
                              className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors"
                            >
                              <i aria-hidden="true" data-lucide="file-text" className="w-4 h-4"></i>
                              Generate Auto-Note
                            </button>
                            <span className="text-xs text-slate-500 ml-2">Populates note from patient data + guideline citations</span>
                          </div>

                          <div>
                            <div className="flex items-center justify-between mb-1">
                              <span className="text-sm font-medium text-slate-700">Recommendation Summary</span>
                            </div>
                            <textarea
                              value={telestrokeNote.recommendationsText}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, recommendationsText: v})); }}
                              placeholder=""
                              rows="6"
                              className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>

                        {/* Pulsara Summary */}
                        <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3 mt-4">
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-semibold text-indigo-800 text-sm">Pulsara Summary</span>
                            <button
                              onClick={() => { copyToClipboard(generatePulsaraSummary(), 'tel-pulsara'); }}
                              className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 transition-colors"
                            >
                              <i aria-hidden="true" data-lucide={copiedText === 'tel-pulsara' ? 'check' : 'copy'} className="w-4 h-4"></i>
                              {copiedText === 'tel-pulsara' ? 'Copied!' : 'Copy Pulsara'}
                            </button>
                          </div>
                          <p className="text-xs text-slate-600 whitespace-pre-wrap">{generatePulsaraPreview()}</p>
                        </div>

                        {/* Telestroke Section */}
                        <div className="bg-slate-50 border border-slate-300 rounded-lg p-4 mt-4">
                          <h3 className="text-lg font-semibold text-slate-800 mb-4">Telestroke</h3>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            {/* OSH Transfer */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-slate-700 mb-2">Transfer</h4>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                  <label htmlFor="input-transport-mode" className="block text-xs font-medium text-slate-600 mb-1">Transport mode</label>
                                  <select
                                    id="input-transport-mode"
                                    value={telestrokeNote.transportMode || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({ ...prev, transportMode: v })); }}
                                    className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  >
                                    <option value="">-- Select --</option>
                                    <option value="Ground">Ground</option>
                                    <option value="Air">Air</option>
                                    <option value="Private">Private</option>
                                    <option value="Pending">Pending</option>
                                  </select>
                                </div>
                                <div>
                                  <label htmlFor="input-transport-eta" className="block text-xs font-medium text-slate-600 mb-1">ETA (time)</label>
                                  <input
                                    id="input-transport-eta"
                                    type="datetime-local"
                                    value={telestrokeNote.transportEta || ''}
                                    onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({ ...prev, transportEta: v })); }}
                                    className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                              </div>
                              <div className="mt-3">
                                <label htmlFor="input-transport-notes" className="block text-xs font-medium text-slate-600 mb-1">Transport notes</label>
                                <textarea
                                  id="input-transport-notes"
                                  value={telestrokeNote.transportNotes || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({ ...prev, transportNotes: v })); }}
                                  rows="2"
                                  className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  placeholder="Air/ground contact, staging, or special considerations"
                                />
                              </div>
                              <div className="mt-3">
                                <label htmlFor="input-transfer-rationale" className="block text-xs font-medium text-slate-600 mb-1">Transfer decision note</label>
                                <textarea
                                  id="input-transfer-rationale"
                                  value={telestrokeNote.transferRationale || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({ ...prev, transferRationale: v })); }}
                                  rows="3"
                                  className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  placeholder="Auto-generate or type the transfer decision note..."
                                />
                              </div>
                              <div className="mt-2 flex flex-wrap gap-2">
                                <button
                                  type="button"
                                  onClick={async () => {
                                    const reason = await showConfirm({
                                      title: 'Accept Transfer',
                                      input: true,
                                      inputType: 'textarea',
                                      inputLabel: 'Reason for accepting (optional)',
                                      placeholder: 'e.g., LVO confirmed, EVT candidate',
                                      confirmLabel: 'Accept Transfer'
                                    });
                                    if (reason === null) return;
                                    const note = buildTransferDecisionText('accept', reason || '');
                                    setTelestrokeNote(prev => ({ ...prev, transferAccepted: true, transferRationale: note }));
                                    copyToClipboard(note, 'transfer-accept');
                                  }}
                                  className="px-3 py-2 bg-emerald-600 text-white rounded-lg text-xs font-semibold hover:bg-emerald-700"
                                >
                                  {copiedText === 'transfer-accept' ? 'Copied!' : 'Accept + copy'}
                                </button>
                                <button
                                  type="button"
                                  onClick={async () => {
                                    const reason = await showConfirm({
                                      title: 'Decline Transfer',
                                      input: true,
                                      inputType: 'textarea',
                                      inputLabel: 'Reason for declining',
                                      placeholder: 'e.g., Not EVT candidate, ASPECTS too low',
                                      confirmLabel: 'Decline Transfer',
                                      required: true,
                                      danger: true
                                    });
                                    if (!reason) return;
                                    const note = buildTransferDecisionText('decline', String(reason));
                                    setTelestrokeNote(prev => ({ ...prev, transferAccepted: false, transferRationale: note }));
                                    copyToClipboard(note, 'transfer-decline');
                                  }}
                                  className="px-3 py-2 bg-red-600 text-white rounded-lg text-xs font-semibold hover:bg-red-700"
                                >
                                  {copiedText === 'transfer-decline' ? 'Copied!' : 'Decline + copy'}
                                </button>
                              </div>
                            </div>

                            {/* TNK risk/benefit discussion documentation */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-slate-700 mb-2">TNK risk/benefit discussion documentation:</h4>
                              <p className="text-sm">After ensuring that there were no evident contraindications, TNK administration was recommended. Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the OSH provider and patient/family prior to initiating treatment.</p>
                            </div>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Post-IV TNK/tPA recommendations */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-slate-700 mb-2">Post-IV TNK/tPA recommendations:</h4>
                              <ul className="text-sm space-y-1">
                                <li>• Admit to ICU</li>
                                <li>• Neuro checks + BP q15min x 2h, then q30min x 6h, then q1h x 16h</li>
                                <li>• NO antithrombotics/anticoagulants for 24 hours after thrombolysis</li>
                                <li>• Avoid IV aspirin within 90 minutes of IVT start</li>
                                <li>• Maintain BP&lt;180/105 for 24 hours after thrombolysis</li>
                                <li>• NCCT 24 hours post-thrombolysis</li>
                                <li>• MRI Brain with diffusion weighted imaging</li>
                                <li>• EKG/telemetry</li>
                                <li>• Transthoracic echocardiogram</li>
                                <li>• Fasting lipid panel, HgA1c</li>
                                <li>• PT/OT/SLP evaluations</li>
                                <li>• SCDs for DVT ppx</li>
                                <li>• Inpatient neurology consultation for further diagnostic evaluation and management</li>
                              </ul>
                            </div>

                            {/* MT risk/benefit discussion */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-slate-700 mb-2">MT risk/benefit discussion:</h4>
                              <p className="text-sm">Given the presence of a large vascular occlusion, disabling neurological symptoms, and no evident contraindications - the patient will be transferred to the hub for mechanical thrombectomy consideration. Potential benefits, potential risks, and alternatives to treatment were discussed with the OSH provider and patient/family; the neuro-IR team at the hub will obtain informed consent from the patient/family.</p>
                            </div>
                          </div>
                        </div>

                        {/* Telestroke Note - Epic */}
                        <div className="bg-slate-50 border border-slate-200 rounded-lg p-4 shadow-md mt-4">
                          <div className="flex items-center justify-between mb-3">
                            <h4 className="font-bold text-slate-800 flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="file-text" className="w-5 h-5"></i>
                              Telestroke Note - Epic
                            </h4>
                            <div className="flex gap-2 flex-wrap">
                              <button
                                onClick={() => {
                                  const note = generateTelestrokeNote();
                                  copyToClipboard(note, 'encounter-note');
                                }}
                                className="flex items-center gap-2 px-3 py-2 bg-emerald-600 text-white text-sm rounded-lg hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-500 transition-colors"
                              >
                                <i aria-hidden="true" data-lucide={copiedText === 'encounter-note' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                {copiedText === 'encounter-note' ? 'Copied!' : 'Copy Full Note'}
                              </button>
                            </div>
                          </div>

                          <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3 mb-3">
                            <div className="flex items-center justify-between mb-2">
                              <span className="font-semibold text-emerald-800 text-sm">Smart Note (Narrative)</span>
                              <button
                                onClick={() => {
                                  const note = buildSmartNote();
                                  copyToClipboard(note, 'smart-note-encounter');
                                }}
                                className="flex items-center gap-2 px-3 py-1.5 bg-emerald-600 text-white text-sm rounded-lg hover:bg-emerald-700 focus:ring-2 focus:ring-emerald-500 transition-colors"
                              >
                                <i aria-hidden="true" data-lucide={copiedText === 'smart-note-encounter' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                {copiedText === 'smart-note-encounter' ? 'Copied!' : 'Copy Smart Note'}
                              </button>
                            </div>
                            <p className="text-xs text-slate-600 whitespace-pre-wrap">
                              {buildSmartNote()}
                            </p>
                          </div>

                          {/* Modular Copy: HPI / Exam-NIHSS / MDM-Plan */}
                          <div className="grid grid-cols-3 gap-2 mb-3">
                            <button
                              onClick={() => {
                                const age = telestrokeNote.age || '***';
                                const sex = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '***';
                                let hpi = `HPI: ${age} year old ${sex}`;
                                if (telestrokeNote.pmh) hpi += ` with PMH of ${telestrokeNote.pmh}`;
                                hpi += ` presenting with ${telestrokeNote.symptoms || '***'}.\n`;
                                if (lkwTime) hpi += `Last known well: ${lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} on ${lkwTime.toLocaleDateString()}.\n`;
                                if (telestrokeNote.medications) hpi += `Medications: ${telestrokeNote.medications}\n`;
                                if (telestrokeNote.lastDOACType) {
                                  const vidDoseDate = telestrokeNote.lastDOACDose ? new Date(telestrokeNote.lastDOACDose) : null;
                                  const vidDoseStr = vidDoseDate && !Number.isNaN(vidDoseDate.getTime()) ? `, last dose: ${vidDoseDate.toLocaleString()}` : '';
                                  hpi += `Anticoag: ${ANTICOAGULANT_INFO[telestrokeNote.lastDOACType]?.name || telestrokeNote.lastDOACType}${vidDoseStr}\n`;
                                }
                                copyToClipboard(hpi, 'vid-hpi');
                              }}
                              className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1 focus:ring-2 focus:ring-blue-500 ${copiedText === 'vid-hpi' ? 'bg-emerald-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                            >
                              <i aria-hidden="true" data-lucide={copiedText === 'vid-hpi' ? 'check' : 'copy'} className="w-3 h-3"></i>
                              HPI Data
                            </button>
                            <button
                              onClick={() => {
                                let exam = `NIHSS: ${telestrokeNote.nihss || nihssScore || 'N/A'}`;
                                if (telestrokeNote.nihssDetails) exam += ` (${telestrokeNote.nihssDetails})`;
                                exam += `\n\nVITALS:\nBP: ${telestrokeNote.presentingBP || 'N/A'}\nGlucose: ${telestrokeNote.glucose || 'N/A'}\nINR: ${telestrokeNote.inr || 'N/A'}\nPlt: ${telestrokeNote.plateletCount || 'N/A'}`;
                                exam += `\n\nIMAGING:\nCT Head: ${telestrokeNote.ctResults || 'N/A'}\nCTA: ${telestrokeNote.ctaResults || 'N/A'}`;
                                if (telestrokeNote.ctpResults) exam += `\nCTP: ${telestrokeNote.ctpResults}`;
                                if (aspectsScore != null) exam += `\nASPECTS: ${aspectsScore}`;
                                copyToClipboard(exam, 'vid-exam');
                              }}
                              className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1 focus:ring-2 focus:ring-blue-500 ${copiedText === 'vid-exam' ? 'bg-emerald-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                            >
                              <i aria-hidden="true" data-lucide={copiedText === 'vid-exam' ? 'check' : 'copy'} className="w-3 h-3"></i>
                              Exam / NIHSS
                            </button>
                            <button
                              onClick={() => {
                                let mdm = `ASSESSMENT: ${telestrokeNote.diagnosis || '***'}\n\nPLAN:\n`;
                                mdm += `TNK: ${telestrokeNote.tnkRecommended ? 'RECOMMENDED' : 'Not recommended'}\n`;
                                mdm += `EVT: ${telestrokeNote.evtRecommended ? 'RECOMMENDED' : 'Not recommended'}\n`;
                                if (telestrokeNote.rationale) mdm += `Rationale: ${telestrokeNote.rationale}\n`;
                                if (telestrokeNote.disposition) mdm += `Disposition: ${telestrokeNote.disposition}\n`;
                                if (telestrokeNote.recommendationsText) mdm += `\n${telestrokeNote.recommendationsText}`;
                                copyToClipboard(mdm, 'vid-mdm');
                              }}
                              className={`px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1 focus:ring-2 focus:ring-blue-500 ${copiedText === 'vid-mdm' ? 'bg-emerald-600 text-white' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'}`}
                            >
                              <i aria-hidden="true" data-lucide={copiedText === 'vid-mdm' ? 'check' : 'copy'} className="w-3 h-3"></i>
                              MDM / Plan
                            </button>
                          </div>
                          {/* Follow-up Brief Copy Button */}
                          {(
                          <button
                            onClick={() => {
                              copyToClipboard(generateFollowUpBrief(), 'vid-followup');
                            }}
                            className={`w-full mb-3 px-3 py-2 rounded-lg text-xs font-medium transition-colors flex items-center justify-center gap-1 focus:ring-2 focus:ring-blue-500 ${copiedText === 'vid-followup' ? 'bg-emerald-600 text-white' : 'bg-blue-100 text-blue-800 hover:bg-blue-200 border border-blue-300'}`}
                          >
                            <i aria-hidden="true" data-lucide={copiedText === 'vid-followup' ? 'check' : 'file-output'} className="w-3 h-3"></i>
                            {copiedText === 'vid-followup' ? 'Copied!' : 'Copy Follow-up Brief (Clinic Handoff)'}
                          </button>
                          )}

                          <div className="flex items-center gap-2 mb-3">
                            <label className="text-xs font-medium text-slate-500 uppercase tracking-wide">Template:</label>
                            <select
                              value={noteTemplate}
                              onChange={(e) => setNoteTemplate(e.target.value)}
                              className="text-sm border border-slate-300 rounded-lg px-2 py-1.5 focus:ring-2 focus:ring-blue-500"
                            >
                              <option value="consult">Acute Consult</option>
                              <option value="transfer">Transfer Summary</option>
                              <option value="signout">Signout</option>
                              <option value="followup">Clinic Follow-up</option>
                              <option value="discharge">Discharge Summary</option>
                              <option value="procedure">EVT Procedure Note</option>
                              <option value="progress">Progress Note</option>
                              <option value="patient-ed">Patient Education</option>
                            </select>
                          </div>

                          <div className="bg-white p-3 rounded border border-slate-200 max-h-96 overflow-y-auto">
                            <pre className="whitespace-pre-wrap text-xs text-slate-800 font-mono">
                              {generateTelestrokeNote()}
                            </pre>
                          </div>
                        </div>

                      </div>

                      {/* RIGHT COLUMN - Live Preview & Tools (1/3 width on desktop, full width on mobile) */}
                      <div className={`lg:col-span-1 space-y-4`}>

                        {(() => {
                          const cues = [];
                          const ageVal = parseInt(telestrokeNote.age, 10);
                          const nihssVal = parseInt(telestrokeNote.nihss || nihssScore, 10);
                          const tf = calculateTimeFromLKW();
                          const hoursFromLkw = tf ? tf.total : null;
                          const dxPath = getPathwayForDiagnosis(telestrokeNote.diagnosis || telestrokeNote.diagnosisCategory || '');

                          if (!Number.isNaN(ageVal) && ageVal >= 80) {
                            cues.push({
                              tone: 'guideline',
                              title: 'Age >80',
                              text: 'Confirm pre-stroke baseline function and large-core selection constraints before EVT recommendations.'
                            });
                          }
                          if (!Number.isNaN(nihssVal) && nihssVal <= 5 && (telestrokeNote.vesselOcclusion || []).some(v => ['ICA', 'M1', 'M2'].includes(v))) {
                            cues.push({
                              tone: 'guideline',
                              title: 'Low NIHSS with LVO',
                              text: 'Re-check disabling deficits and EVT candidacy pathway; low NIHSS does not always equal low-risk.'
                            });
                          }
                          if (hoursFromLkw !== null && hoursFromLkw > 4.5 && hoursFromLkw <= 9) {
                            cues.push({
                              tone: 'info',
                              title: 'Extended lysis window',
                              text: 'Mismatch imaging criteria should be explicitly documented before thrombolysis recommendation.'
                            });
                          }
                          if (dxPath === 'ich') {
                            cues.push({
                              tone: 'safety',
                              title: 'ICH pathway',
                              text: 'Prioritize reversal sequence, BP control, and surgical trigger screening before documentation.'
                            });
                          }
                          if ((telestrokeNote.lastDOACType || '') && (telestrokeNote.lastDOACType || '') !== 'none') {
                            cues.push({
                              tone: 'safety',
                              title: 'Anticoagulant present',
                              text: 'Ensure last-dose timing and coagulation assay status are captured before final lytic decision.'
                            });
                          }

                          if (cues.length === 0) return null;
                          const palette = {
                            safety: 'bg-red-50 border-red-200 text-red-900',
                            guideline: 'bg-blue-50 border-blue-200 text-blue-900',
                            info: 'bg-slate-50 border-slate-200 text-slate-800'
                          };

                          return (
                            <div className="bg-white border border-slate-200 rounded-lg p-3">
                              <h4 className="text-sm font-semibold text-slate-900 mb-2">Clinical Assistant</h4>
                              <div className="space-y-2">
                                {cues.slice(0, 3).map((cue, idx) => (
                                  <div key={`${cue.title}-${idx}`} className={`rounded-lg border px-2.5 py-2 text-xs ${palette[cue.tone] || palette.info}`}>
                                    <p className="font-semibold">{cue.title}</p>
                                    <p className="mt-0.5">{cue.text}</p>
                                  </div>
                                ))}
                              </div>
                            </div>
                          );
                        })()}

                        {/* Treatment Window Countdown - Enhanced with Elapsed Timer & Audible Alerts */}
                        {(() => {
                          const timeFromLKW = calculateTimeFromLKW();
                          if (!timeFromLKW) return null;

                          const totalHours = timeFromLKW.total;
                          const totalMinutes = totalHours * 60;
                          const tnkRemaining = 4.5 - totalHours;
                          const tnkRemainingMinutes = tnkRemaining * 60;
                          const evtEarlyRemaining = 6 - totalHours;
                          const evtLateRemaining = 24 - totalHours;

                          // Calculate elapsed time with seconds precision
                          const elapsedHours = Math.floor(elapsedSeconds / 3600);
                          const elapsedMins = Math.floor((elapsedSeconds % 3600) / 60);
                          const elapsedSecs = elapsedSeconds % 60;

                          // Determine color based on elapsed time
                          const getElapsedColor = () => {
                            if (totalHours < 3) return 'from-green-500 to-green-600';
                            if (totalHours < 4) return 'from-yellow-500 to-yellow-600';
                            if (totalHours < 4.5) return 'from-orange-500 to-orange-600';
                            return 'from-red-600 to-red-700';
                          };

                          const getTextColor = () => {
                            if (totalHours < 3) return 'text-emerald-100';
                            if (totalHours < 4) return 'text-amber-100';
                            if (totalHours < 4.5) return 'text-orange-100';
                            return 'text-red-100';
                          };

                          return (
                            <div className={`bg-white rounded-lg shadow-lg border-2 ${
                              alertFlashing ? 'border-red-500 alert-flash' : 'border-blue-400'
                            } lg:sticky lg:top-40 z-30 transition-all duration-300 ${
                              timerSidebarCollapsed ? 'p-2' : 'p-4'
                            }`}>

                              {/* Header with Collapse Toggle and Mute Toggle */}
                              <div className={`flex items-center justify-between ${timerSidebarCollapsed ? '' : 'mb-3'}`}>
                                <button
                                  onClick={() => setTimerSidebarCollapsed(!timerSidebarCollapsed)}
                                  className="font-bold text-lg text-blue-900 flex items-center gap-2 hover:text-blue-700 transition-colors"
                                  title={timerSidebarCollapsed ? 'Expand timer' : 'Collapse timer'}
                                  aria-label={timerSidebarCollapsed ? 'Expand treatment timer' : 'Collapse treatment timer'}
                                >
                                  <i aria-hidden="true" data-lucide={timerSidebarCollapsed ? 'chevron-right' : 'chevron-down'} className="w-4 h-4"></i>
                                  <i aria-hidden="true" data-lucide="clock" className="w-5 h-5"></i>
                                  {timerSidebarCollapsed ? (
                                    <span className="text-sm font-mono">
                                      {elapsedHours}h {elapsedMins.toString().padStart(2, '0')}m
                                    </span>
                                  ) : (
                                    <span>Treatment Windows</span>
                                  )}
                                </button>
                                <div className="flex items-center gap-1">
                                  <button
                                    onClick={toggleAlertMute}
                                    className={`p-2 rounded-full transition-colors ${
                                      alertsMuted
                                        ? 'bg-slate-200 text-slate-500 hover:bg-slate-300'
                                        : 'bg-blue-100 text-blue-600 hover:bg-blue-200'
                                    }`}
                                    title={alertsMuted ? 'Unmute alerts' : 'Mute alerts'}
                                    aria-label={alertsMuted ? 'Unmute alerts' : 'Mute alerts'}
                                  >
                                    {alertsMuted ? (
                                      <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="m11 5-6 6h-4v6h4l6 6v-18z"></path>
                                        <line x1="23" y1="9" x2="17" y2="15"></line>
                                        <line x1="17" y1="9" x2="23" y2="15"></line>
                                      </svg>
                                    ) : (
                                      <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                                      </svg>
                                    )}
                                  </button>
                                </div>
                              </div>

                              {/* Collapsible Content */}
                              {!timerSidebarCollapsed && (
                                <>
                              {/* ============================================ */}
                              {/* PROMINENT ELAPSED TIMER FROM LKW             */}
                              {/* ============================================ */}
                              <div className={`bg-gradient-to-r ${getElapsedColor()} rounded-xl p-4 mb-4 text-white shadow-md ${
                                totalHours >= 4 && totalHours < 4.5 ? 'urgent-pulse' : ''
                              }`}>
                                <div className="text-center">
                                  {(() => {
                                    const onsetLabel = timeFromLKW?.label || 'LKW';
                                    const discoveryTime = getDiscoveryDateTime();
                                    const onsetTimeDisplay = telestrokeNote.lkwUnknown
                                      ? (discoveryTime ? discoveryTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '--:--')
                                      : (lkwTime ? new Date(lkwTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '--:--');
                                    return (
                                      <>
                                        <p className={`text-xs font-medium ${getTextColor()} opacity-90 uppercase tracking-wide`}>
                                          Time Elapsed from {onsetLabel}
                                        </p>
                                        <div className="text-4xl font-mono font-bold mt-1 tracking-tight">
                                          {elapsedHours}h {elapsedMins.toString().padStart(2, '0')}m {elapsedSecs.toString().padStart(2, '0')}s
                                        </div>
                                        <p className={`text-xs mt-1 ${getTextColor()} opacity-90`}>
                                          {onsetLabel}: {onsetTimeDisplay}
                                        </p>
                                      </>
                                    );
                                  })()}
                                </div>

                                {/* Countdown to TNK window closure */}
                                {tnkRemaining > 0 && (
                                  <div className={`mt-3 pt-3 border-t border-white/30 text-center ${
                                    tnkRemainingMinutes <= 30 ? 'urgent-pulse' : ''
                                  }`}>
                                    <p className="text-xs opacity-80 uppercase tracking-wide">TNK Window Closes In</p>
                                    <div className={`text-2xl font-bold ${
                                      tnkRemainingMinutes <= 15 ? 'text-amber-200' : 'text-white'
                                    }`}>
                                      {Math.floor(tnkRemainingMinutes / 60)}h {Math.floor(tnkRemainingMinutes % 60)}m
                                    </div>
                                    {tnkRemainingMinutes <= 30 && (
                                      <p className="text-xs text-amber-200 font-semibold mt-1 animate-pulse">
                                        {tnkRemainingMinutes <= 15 ? 'CRITICAL - Less than 15 min remaining!' : 'Less than 30 min remaining'}
                                      </p>
                                    )}
                                  </div>
                                )}

                                {/* Window closed message */}
                                {tnkRemaining <= 0 && (
                                  <div className="mt-3 pt-3 border-t border-white/30 text-center">
                                    <p className="text-lg font-bold text-white/90">TNK Window Closed</p>
                                    <p className="text-xs text-white/70">
                                      {Math.abs(Math.floor(tnkRemainingMinutes / 60))}h {Math.abs(Math.floor(tnkRemainingMinutes % 60))}m ago
                                    </p>
                                  </div>
                                )}
                              </div>

                              <div className="space-y-3">
                                {/* TNK Window */}
                                <div className={`p-3 rounded-lg border-2 ${
                                  tnkRemaining > 1 ? 'bg-emerald-50 border-emerald-500' :
                                  tnkRemaining > 0 ? 'bg-amber-50 border-amber-500' :
                                  'bg-slate-50 border-slate-400'
                                } ${tnkRemaining > 0 && tnkRemaining < 0.5 ? 'animate-pulse' : ''}`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                      <span className="font-semibold text-sm">
                                        {tnkRemaining > 0 ? 'TNK (Thrombolysis)' : 'TNK Closed'}
                                      </span>
                                    </div>
                                    {tnkRemaining > 0 && (
                                      <span className={`font-bold text-lg ${
                                        tnkRemaining < 0.5 ? 'text-red-600' : tnkRemaining < 1 ? 'text-amber-600' : 'text-emerald-600'
                                      }`}>
                                        {Math.floor(tnkRemaining)}h {Math.floor((tnkRemaining % 1) * 60)}m left
                                      </span>
                                    )}
                                    {tnkRemaining <= 0 && (
                                      <span className="text-slate-600 text-xs font-semibold">
                                        -{Math.floor(Math.abs(tnkRemaining))}h {Math.floor((Math.abs(tnkRemaining) % 1) * 60)}m
                                      </span>
                                    )}
                                  </div>
                                  {/* Progress Bar */}
                                  <div className="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                                    <div
                                      className={`h-2 rounded-full transition-all ${
                                        tnkRemaining > 1 ? 'bg-emerald-500' :
                                        tnkRemaining > 0 ? 'bg-amber-500' :
                                        'bg-slate-400'
                                      }`}
                                      style={{ width: `${Math.max(0, Math.min(100, (totalHours / 4.5) * 100))}%` }}
                                    ></div>
                                  </div>
                                  <p className="text-xs mt-1 text-slate-600">0-4.5h from LKW</p>
                                </div>

                                {/* Early EVT Window (0-6h) */}
                                <div className={`p-3 rounded-lg border-2 ${
                                  evtEarlyRemaining > 1 ? 'bg-blue-50 border-blue-500' :
                                  evtEarlyRemaining > 0 ? 'bg-amber-50 border-amber-500' :
                                  'bg-slate-50 border-slate-400'
                                } ${evtEarlyRemaining > 0 && evtEarlyRemaining < 0.5 ? 'animate-pulse' : ''}`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                      <span className="font-semibold text-sm">
                                        {evtEarlyRemaining > 0 ? 'EVT (Early Window)' : 'Early EVT Closed'}
                                      </span>
                                    </div>
                                    {evtEarlyRemaining > 0 && (
                                      <span className={`font-bold text-lg ${
                                        evtEarlyRemaining < 0.5 ? 'text-red-600' : evtEarlyRemaining < 1 ? 'text-amber-600' : 'text-blue-600'
                                      }`}>
                                        {Math.floor(evtEarlyRemaining)}h {Math.floor((evtEarlyRemaining % 1) * 60)}m left
                                      </span>
                                    )}
                                    {evtEarlyRemaining <= 0 && (
                                      <span className="text-slate-600 text-xs font-semibold">
                                        -{Math.floor(Math.abs(evtEarlyRemaining))}h {Math.floor((Math.abs(evtEarlyRemaining) % 1) * 60)}m
                                      </span>
                                    )}
                                  </div>
                                  {/* Progress Bar */}
                                  <div className="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                                    <div
                                      className={`h-2 rounded-full transition-all ${
                                        evtEarlyRemaining > 1 ? 'bg-blue-500' :
                                        evtEarlyRemaining > 0 ? 'bg-amber-500' :
                                        'bg-slate-400'
                                      }`}
                                      style={{ width: `${Math.max(0, Math.min(100, (totalHours / 6) * 100))}%` }}
                                    ></div>
                                  </div>
                                  <p className="text-xs mt-1 text-slate-600">0-6h from LKW</p>
                                </div>

                                {/* Late EVT Window (6-24h) */}
                                {totalHours >= 6 && (
                                  <div className={`p-3 rounded-lg border-2 ${
                                    evtLateRemaining > 0 ? 'bg-purple-50 border-purple-500' : 'bg-slate-50 border-slate-400'
                                  }`}>
                                    <div className="flex items-center justify-between mb-2">
                                      <div className="flex items-center gap-2">
                                        <span className="font-semibold text-sm">
                                          {evtLateRemaining > 0 ? 'EVT (Extended Window)' : 'All Windows Closed'}
                                        </span>
                                      </div>
                                      {evtLateRemaining > 0 && (
                                        <span className="font-bold text-lg text-purple-600">
                                          {Math.floor(evtLateRemaining)}h {Math.floor((evtLateRemaining % 1) * 60)}m left
                                        </span>
                                      )}
                                      {evtLateRemaining <= 0 && (
                                        <span className="text-slate-600 text-xs font-semibold">All closed</span>
                                      )}
                                    </div>
                                    {/* Progress Bar */}
                                    <div className="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                                      <div
                                        className={`h-2 rounded-full transition-all ${
                                          evtLateRemaining > 0 ? 'bg-purple-500' : 'bg-slate-400'
                                        }`}
                                        style={{ width: `${Math.max(0, Math.min(100, (totalHours / 24) * 100))}%` }}
                                      ></div>
                                    </div>
                                    <p className="text-xs mt-1 text-slate-600">6-24h (perfusion imaging required)</p>
                                  </div>
                                )}
                              </div>

                              {/* Alert status indicator */}
                              <div className="mt-3 pt-3 border-t border-slate-200 flex items-center justify-between text-xs text-slate-500">
                                <span>
                                  Alerts: {alertsMuted ? 'Muted' : 'Active'}
                                  {!alertsMuted && tnkRemaining > 0 && tnkRemaining < 0.5 && ' (30m, 15m, 0m)'}
                                </span>
                                {lastAlertPlayed && (
                                  <span className="text-orange-600 font-medium">
                                    Last: {lastAlertPlayed === 'warning-30' ? '30m warning' :
                                           lastAlertPlayed === 'warning-15' ? '15m warning' :
                                           'Window closed'}
                                  </span>
                                )}
                              </div>
                                </>
                              )}
                            </div>
                          );
                        })()}

                        {/* Active trial snapshot (uses the same trial source as Library > Trials) */}
                        {(() => {
                          const trialCategory = getTrialTabCategory(telestrokeNote.diagnosisCategory, telestrokeNote.diagnosis);
                          if (!trialCategory) return null;
                          const categoryData = trialsData[trialCategory];
                          if (!categoryData) return null;
                          const categoryTrials = categoryData.hasSubsections
                            ? Object.values(categoryData.subsections).reduce((acc, subsection) => acc.concat(subsection.trials || []), [])
                            : (categoryData.trials || []);
                          if (!categoryTrials.length) return null;

                          const trialStatusByNct = Object.values(trialEligibility || {}).reduce((acc, result) => {
                            if (result && result.nct) acc[result.nct] = result.status;
                            return acc;
                          }, {});
                          const statusTone = {
                            eligible: 'bg-emerald-100 text-emerald-800 border-emerald-200',
                            needs_info: 'bg-amber-100 text-amber-800 border-amber-200',
                            not_eligible: 'bg-slate-100 text-slate-700 border-slate-200',
                            pending: 'bg-indigo-50 text-indigo-700 border-indigo-200'
                          };
                          const statusLabel = {
                            eligible: 'Eligible',
                            needs_info: 'Needs Info',
                            not_eligible: 'Not Eligible',
                            pending: 'Review'
                          };

                          return (
                            <details className="bg-white border border-indigo-200 rounded-lg shadow-sm" open>
                              <summary className="cursor-pointer px-3 py-2.5 font-semibold text-indigo-900 hover:bg-indigo-50 rounded-lg flex items-center justify-between">
                                <span className="flex items-center gap-2">
                                  <i aria-hidden="true" data-lucide="flask-conical" className="w-4 h-4 text-indigo-600"></i>
                                  Active Trials ({trialCategory === 'ich' ? 'ICH' : 'Ischemic'})
                                </span>
                                <button
                                  type="button"
                                  onClick={(e) => {
                                    e.preventDefault();
                                    navigateTo('library', { subTab: 'trials' });
                                    setTrialsCategory(trialCategory);
                                  }}
                                  className="text-xs font-semibold text-indigo-700 hover:text-indigo-900 underline"
                                >
                                  Open full library
                                </button>
                              </summary>
                              <div className="px-3 pb-3 space-y-2">
                                {categoryTrials.slice(0, 6).map((trial) => {
                                  const status = trialStatusByNct[trial.nct] || 'pending';
                                  return (
                                    <div key={trial.nct || trial.name} className="border border-slate-200 rounded-lg p-2.5 bg-slate-50">
                                      <div className="flex items-center justify-between gap-2">
                                        <p className="text-sm font-semibold text-slate-900">{trial.name}</p>
                                        <span className={`px-2 py-0.5 rounded-full text-[11px] font-semibold border ${statusTone[status] || statusTone.not_eligible}`}>
                                          {statusLabel[status] || 'Not Eligible'}
                                        </span>
                                      </div>
                                      <p className="text-xs text-slate-600 mt-1">{trial.description}</p>
                                      {trial.nct && (
                                        <p className="text-[11px] text-slate-500 mt-1">{trial.nct}</p>
                                      )}
                                    </div>
                                  );
                                })}
                              </div>
                            </details>
                          );
                        })()}


                        {/* ============================================ */}
                        {/* SMART PHRASE LIBRARY                        */}
                        {/* Quick-copy documentation templates          */}
                        {/* Only visible when scrolled to Part 6        */}
                        {/* ============================================ */}

                      </div>


                    </div>
                    </>
                    )}
                    {(
                    <div id="handoff-section" className="bg-white border-2 border-slate-200 rounded-lg p-4 shadow-sm">
                      <div className="flex flex-wrap items-center justify-between gap-3 mb-3">
                        <div>
                          <p className="text-xs uppercase tracking-wide text-slate-500 font-semibold">Handoff Summary</p>
                        </div>
                        <button
                          type="button"
                          onClick={() => {
                            const summary = buildHandoffSummary();
                            copyToClipboard(summary, 'handoff-summary');
                          }}
                          className="px-3 py-2 bg-slate-900 text-white rounded-lg text-xs font-semibold hover:bg-slate-800"
                        >
                          {copiedText === 'handoff-summary' ? 'Copied!' : 'Copy handoff'}
                        </button>
                      </div>
                      {(() => {
                        const fields = getHandoffSummaryFields();
                        const cards = [
                          { label: 'Dx', value: fields.diagnosis },
                          { label: 'Age/Sex', value: `${fields.age} ${fields.sex}`.trim() },
                          { label: fields.onsetLabel, value: `${fields.onsetTime}${fields.elapsed && fields.elapsed !== 'Unknown' ? ` (${fields.elapsed})` : ''}` },
                          { label: 'NIHSS', value: `${fields.nihss}${fields.nihssDetails ? ` (${fields.nihssDetails})` : ''}` },
                          { label: 'Imaging', value: fields.imagingSummary },
                          { label: 'Plan', value: `${fields.tnkStatus}; ${fields.evtStatus}` }
                        ];
                        if (fields.disposition) {
                          cards.push({ label: 'Disposition', value: fields.disposition });
                        }
                        if (fields.transferStatus || fields.transportDetails) {
                          const transferValue = [
                            fields.transferStatus,
                            fields.transportDetails ? `Transport: ${fields.transportDetails}` : ''
                          ].filter(Boolean).join(' | ');
                          cards.push({ label: 'Transfer', value: transferValue });
                        }
                        if (fields.imagingShare) {
                          cards.push({ label: 'Imaging share', value: fields.imagingShare });
                        }
                        return (
                          <>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                              {cards.map((card) => (
                                <div key={card.label} className="rounded-lg border border-slate-200 bg-slate-50 px-3 py-2">
                                  <p className="text-xs uppercase tracking-wide text-slate-500">{card.label}</p>
                                  <p className="text-sm font-semibold text-slate-900">{card.value || '--'}</p>
                                </div>
                              ))}
                            </div>
                            <details className="mt-3 bg-slate-50 border border-slate-200 rounded-lg">
                              <summary className="cursor-pointer px-3 py-2 text-xs font-semibold text-slate-700">Full handoff text</summary>
                              <div className="px-3 pb-3">
                                <pre className="whitespace-pre-wrap text-xs text-slate-700">{buildHandoffSummary()}</pre>
                              </div>
                            </details>
                          </>
                        );
                      })()}
                    </div>
                    )}

                    {telestrokeNote.diagnosisCategory === 'mimic' && (
                      <details className="bg-white border border-slate-200 rounded-lg">
                        <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between">
                          <span>Stroke mimic FAQ</span>
                          <span className="text-xs text-slate-500">Quick differentiators</span>
                        </summary>
                        <div className="p-4 space-y-3 text-sm text-slate-700">
                          {[
                            { q: 'When should I suspect a mimic?', a: 'Rapidly resolving deficits, inconsistent exam, or normal imaging despite severe symptoms.' },
                            { q: 'Seizure vs stroke?', a: 'Consider Todd paralysis if witnessed seizure, postictal confusion, or EEG support.' },
                            { q: 'Migraine vs stroke?', a: 'Positive visual/aura symptoms and headache history favor migraine; deficits often march.' },
                            { q: 'Metabolic causes?', a: 'Check glucose, electrolytes, and intoxication if symptoms are diffuse or fluctuating.' },
                            { q: 'Functional symptoms?', a: 'Look for incongruent weakness patterns, Hoover sign, or variability with distraction.' }
                          ].map((item) => (
                            <div key={item.q} className="border border-slate-200 rounded-lg p-3 bg-slate-50">
                              <p className="font-semibold text-slate-800">{item.q}</p>
                              <p className="mt-1">{item.a}</p>
                            </div>
                          ))}
                        </div>
                      </details>
                    )}

                  </div>
                )}


                {activeTab === 'settings' && (
                  <div id="tabpanel-settings" role="tabpanel" aria-labelledby="tab-settings" className="space-y-4">
                    <div className="bg-white border border-slate-200 rounded-xl p-4">
                      <h2 className="text-xl font-semibold text-slate-900">Settings</h2>
                      <p className="text-sm text-slate-600 mt-1">User preferences and workflow controls.</p>
                    </div>

                    <div className="bg-white border border-slate-200 rounded-xl p-4 space-y-4">
                      <div>
                        <p className="text-sm font-semibold text-slate-900 mb-2">User Mode</p>
                        <div className="flex flex-wrap gap-2">
                          {[
                            { id: 'senior', label: 'Senior Rapid', note: 'Minimal prompts, action-first layout' },
                            { id: 'trainee', label: 'Trainee Guided', note: 'Show coaching tips and teaching prompts' }
                          ].map((mode) => (
                            <button
                              key={mode.id}
                              type="button"
                              onClick={() => updateSettings({ workflowPersona: mode.id })}
                              className={`px-3 py-2 rounded-lg text-sm font-semibold border ${
                                userPersona === mode.id
                                  ? 'bg-blue-600 text-white border-blue-600'
                                  : 'bg-slate-50 text-slate-700 border-slate-200 hover:bg-slate-100'
                              }`}
                            >
                              {mode.label}
                            </button>
                          ))}
                        </div>
                        <p className="text-xs text-slate-500 mt-1">
                          {userPersona === 'trainee' ? 'Trainee mode is active.' : 'Senior rapid mode is active.'}
                        </p>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <label className="flex items-center justify-between gap-3 border border-slate-200 rounded-lg px-3 py-2">
                          <span className="text-sm text-slate-700">Focus Mode</span>
                          <input type="checkbox" checked={focusMode} onChange={(e) => setFocusMode(e.target.checked)} />
                        </label>
                        <label className="flex items-center justify-between gap-3 border border-slate-200 rounded-lg px-3 py-2">
                          <span className="text-sm text-slate-700">De-ID Scanning</span>
                          <input type="checkbox" checked={settings.deidMode} onChange={(e) => updateSettings({ deidMode: e.target.checked })} />
                        </label>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                          <label className="text-xs font-semibold uppercase tracking-wide text-slate-500">Default Consult Type</label>
                          <select
                            value={settings.defaultConsultationType || 'videoTelestroke'}
                            onChange={(e) => updateSettings({ defaultConsultationType: e.target.value })}
                            className="mt-1 w-full px-3 py-2 border border-slate-300 rounded-lg"
                          >
                            <option value="videoTelestroke">Video Telestroke</option>
                            <option value="telephone">Telephone</option>
                          </select>
                        </div>
                        <div className="flex items-end gap-2">
                          <button type="button" onClick={exportToPDF} className="px-3 py-2 rounded-lg border border-slate-300 text-slate-700 text-sm font-semibold hover:bg-slate-50">Export PDF</button>
                          <button type="button" onClick={handleClearLocalData} className="px-3 py-2 rounded-lg border border-red-300 text-red-700 text-sm font-semibold hover:bg-red-50">Clear Local Data</button>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {activeTab === 'library' && (
                  <div className="bg-white border border-slate-200 rounded-xl p-3">
                    <div className="flex items-center justify-between gap-3 flex-wrap">
                      <div>
                        <h2 className="text-lg font-semibold text-slate-900">Library</h2>
                        <p className="text-xs text-slate-600">Unified protocols, calculators, references, and trial index.</p>
                      </div>
                      <div className="flex items-center gap-2">
                        <button
                          type="button"
                          onClick={() => setLibrarySection('management')}
                          className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${librarySection === 'management' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}
                        >
                          Protocols & Tools
                        </button>
                        <button
                          type="button"
                          onClick={() => setLibrarySection('trials')}
                          className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${librarySection === 'trials' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}
                        >
                          Trials
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Management Combined Tab (Ischemic, ICH, Calculators, References) */}
                {(activeTab === 'management' || (activeTab === 'library' && librarySection === 'management')) && (
                  <ErrorBoundary>
                  <div id="tabpanel-management" role="tabpanel" aria-labelledby="tab-library" className="space-y-6">
                    {/* ===== QUICK PATIENT SUMMARY CARD ===== */}
                    {(telestrokeNote.age || nihssScore > 0 || telestrokeNote.diagnosis) && (
                      <div className="bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 rounded-xl px-4 py-3">
                        <div className="flex flex-wrap items-center gap-x-5 gap-y-1 text-sm">
                          {telestrokeNote.age && <span className="font-semibold text-slate-800">{telestrokeNote.age}{telestrokeNote.sex || ''}</span>}
                          {(nihssScore > 0 || telestrokeNote.nihss) && <span className="font-bold text-slate-900">NIHSS {telestrokeNote.nihss || nihssScore}</span>}
                          {telestrokeNote.diagnosis && <span className="text-slate-700">Dx: {telestrokeNote.diagnosis}</span>}
                          {telestrokeNote.presentingBP && <span className="text-slate-600">BP: {telestrokeNote.presentingBP}</span>}
                          {telestrokeNote.glucose && <span className="text-slate-600">Gluc: {telestrokeNote.glucose}</span>}
                          {telestrokeNote.inr && <span className="text-slate-600">INR: {telestrokeNote.inr}</span>}
                          {telestrokeNote.plateletCount && <span className="text-slate-600">Plt: {telestrokeNote.plateletCount}K</span>}
                          {telestrokeNote.tnkRecommended !== undefined && (
                            <span className={`font-semibold ${telestrokeNote.tnkRecommended ? 'text-emerald-700' : 'text-slate-500'}`}>
                              TNK: {telestrokeNote.tnkRecommended ? 'Yes' : 'No'}
                            </span>
                          )}
                          {telestrokeNote.evtRecommended !== undefined && (
                            <span className={`font-semibold ${telestrokeNote.evtRecommended ? 'text-blue-700' : 'text-slate-500'}`}>
                              EVT: {telestrokeNote.evtRecommended ? 'Yes' : 'No'}
                            </span>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Contextual guidance based on diagnosis */}
                    {!telestrokeNote.diagnosisCategory && (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg px-4 py-3 flex items-start gap-3">
                        <i aria-hidden="true" data-lucide="info" className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"></i>
                        <div className="text-sm text-blue-800">
                          <strong>No diagnosis set.</strong> Set a working diagnosis on the Encounter tab to activate pathway-specific management recommendations and auto-populate relevant protocols.
                        </div>
                      </div>
                    )}
                    {telestrokeNote.diagnosisCategory === 'ischemic' && managementSubTab === 'ich' && (
                      <div className="bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 text-sm text-blue-800 flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="arrow-right" className="w-4 h-4"></i>
                        Current diagnosis is <strong>ischemic stroke</strong> — the <button onClick={() => setManagementSubTab('ischemic')} className="underline font-semibold hover:text-blue-900">Ischemic Stroke</button> tab may be more relevant.
                      </div>
                    )}
                    {telestrokeNote.diagnosisCategory === 'ich' && managementSubTab === 'ischemic' && (
                      <div className="bg-red-50 border border-red-200 rounded-lg px-4 py-2 text-sm text-red-800 flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="arrow-right" className="w-4 h-4"></i>
                        Current diagnosis is <strong>ICH</strong> — the <button onClick={() => setManagementSubTab('ich')} className="underline font-semibold hover:text-red-900">ICH Management</button> tab may be more relevant.
                      </div>
                    )}
                    <div className="bg-white border border-slate-200 rounded-xl p-2 flex flex-wrap gap-2" role="tablist" aria-label="Management sub-sections" onKeyDown={(e) => {
                      const subTabs = ['ich', 'ischemic', 'sah', 'tia', 'cvt', 'calculators', 'references'];
                      const ci = subTabs.indexOf(managementSubTab);
                      let ni;
                      if (e.key === 'ArrowRight') { e.preventDefault(); ni = (ci + 1) % subTabs.length; }
                      else if (e.key === 'ArrowLeft') { e.preventDefault(); ni = (ci - 1 + subTabs.length) % subTabs.length; }
                      else if (e.key === 'Home') { e.preventDefault(); ni = 0; }
                      else if (e.key === 'End') { e.preventDefault(); ni = subTabs.length - 1; }
                      if (ni !== undefined) { setManagementSubTab(subTabs[ni]); const el = document.getElementById(`mgmt-tab-${subTabs[ni]}`); if (el) el.focus(); }
                    }}>
                      {[
                        { id: 'ich', label: 'ICH', icon: 'alert-triangle' },
                        { id: 'ischemic', label: 'Ischemic', icon: 'activity' },
                        { id: 'sah', label: 'SAH', icon: 'zap' },
                        { id: 'tia', label: 'TIA', icon: 'clock' },
                        { id: 'cvt', label: 'CVT', icon: 'git-branch' },
                        { id: 'calculators', label: 'Calculators', icon: 'calculator' },
                        { id: 'references', label: 'References', icon: 'book-open' }
                      ].map((tab) => {
                        const isActive = managementSubTab === tab.id;
                        return (
                          <button
                            key={tab.id}
                            id={`mgmt-tab-${tab.id}`}
                            onClick={() => setManagementSubTab(tab.id)}
                            className={`flex items-center gap-2 px-3 py-2.5 sm:py-2 rounded-lg text-sm font-medium transition-colors min-h-[44px] sm:min-h-0 ${
                              isActive ? 'bg-blue-600 text-white' : 'bg-slate-50 text-slate-700 hover:bg-slate-100'
                            }`}
                            role="tab"
                            aria-selected={isActive}
                            aria-controls={`mgmt-tabpanel-${tab.id}`}
                            aria-label={`${tab.label} management tab`}
                            tabIndex={isActive ? 0 : -1}
                          >
                            <i aria-hidden="true" data-lucide={tab.icon} className="w-4 h-4"></i>
                            <span>{tab.label}</span>
                          </button>
                        );
                      })}
                    </div>

                    {/* Order Bundle Quick Copy */}
                    {(() => {
                      const bundles = getOrderBundles();
                      if (bundles.length === 0) return null;
                      const colorMap = {
                        red: 'bg-red-50 border-red-200 text-red-900',
                        orange: 'bg-orange-50 border-orange-200 text-orange-900',
                        teal: 'bg-blue-50 border-blue-200 text-blue-900',
                        blue: 'bg-blue-50 border-blue-200 text-blue-900',
                        purple: 'bg-purple-50 border-purple-200 text-purple-900',
                        pink: 'bg-pink-50 border-pink-200 text-pink-900'
                      };
                      const btnColorMap = {
                        red: 'bg-red-600 hover:bg-red-700',
                        orange: 'bg-orange-600 hover:bg-orange-700',
                        teal: 'bg-blue-600 hover:bg-blue-700',
                        blue: 'bg-blue-600 hover:bg-blue-700',
                        purple: 'bg-purple-600 hover:bg-purple-700',
                        pink: 'bg-pink-600 hover:bg-pink-700'
                      };
                      return (
                        <div className="bg-white border-2 border-emerald-300 rounded-xl shadow-sm">
                          <div className="p-3 font-semibold text-emerald-900 flex items-center justify-between border-b border-emerald-200">
                            <span className="flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="clipboard-list" className="w-5 h-5 text-emerald-600"></i>
                              Order Bundles — Quick Copy ({bundles.length})
                            </span>
                            <span className="text-xs text-emerald-600 font-normal">Patient-specific, copy to clipboard</span>
                          </div>
                          <div className="p-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                            {bundles.map(b => (
                              <div key={b.id} className={`border rounded-lg p-3 ${colorMap[b.color] || 'bg-slate-50 border-slate-200 text-slate-900'}`}>
                                <div className="flex items-center justify-between mb-2">
                                  <span className="font-semibold text-sm flex items-center gap-1.5">
                                    <i aria-hidden="true" data-lucide={b.icon} className="w-4 h-4"></i>
                                    {b.label}
                                  </span>
                                  <button
                                    onClick={() => {
                                      const text = b.label + '\n' + b.orders.map(o => '- ' + o).join('\n');
                                      copyToClipboard(text, 'bundle-' + b.id);
                                    }}
                                    className={`flex items-center gap-1 px-2.5 py-1 text-xs font-medium text-white rounded-lg transition-colors ${copiedText === 'bundle-' + b.id ? 'bg-emerald-600' : (btnColorMap[b.color] || 'bg-slate-600 hover:bg-slate-700')}`}
                                  >
                                    <i aria-hidden="true" data-lucide={copiedText === 'bundle-' + b.id ? 'check' : 'copy'} className="w-3 h-3"></i>
                                    {copiedText === 'bundle-' + b.id ? 'Copied!' : 'Copy'}
                                  </button>
                                </div>
                                <ul className="space-y-0.5">
                                  {b.orders.map((o, i) => (
                                    <li key={i} className="text-xs flex gap-1.5">
                                      {o.startsWith('  ') ? <span className="ml-4">{o.trim()}</span> : <><span className="shrink-0">•</span><span>{o}</span></>}
                                    </li>
                                  ))}
                                </ul>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })()}

                    {/* ICH Content */}
                    {managementSubTab === 'ich' && (
                      <div id="mgmt-tabpanel-ich" role="tabpanel" aria-labelledby="mgmt-tab-ich" className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
                          <h2 className="text-xl font-semibold text-red-800">ICH Management</h2>
                          <span className="text-xs text-red-600 font-medium">Algorithmic workflow</span>
                        </div>

                        <div className="space-y-4">
                          {/* === ALL PATIENTS INITIAL STEPS === */}
                          <div className="bg-white border border-red-300 border-l-4 border-l-red-600 rounded-xl p-4 shadow-sm">
                            <p className="text-xs font-semibold uppercase tracking-wide text-red-700 mb-3">All Patients — Initial Steps</p>
                            <div className="space-y-2">
                              <div className="flex gap-2 items-start">
                                <span className="shrink-0 w-6 h-6 rounded-full bg-red-600 text-white text-xs flex items-center justify-center font-bold">1</span>
                                <p className="text-sm">Order <strong>STAT Emergency Stroke Panel</strong> (PT/INR, platelets, fibrinogen, PTT, TT)</p>
                              </div>
                              <div className="flex gap-2 items-start">
                                <span className="shrink-0 w-6 h-6 rounded-full bg-red-600 text-white text-xs flex items-center justify-center font-bold">2</span>
                                <p className="text-sm">Obtain <strong>antithrombotic history</strong> — agent, dose, last dose timing</p>
                              </div>
                              <div className="flex gap-2 items-start">
                                <span className="shrink-0 w-6 h-6 rounded-full bg-red-600 text-white text-xs flex items-center justify-center font-bold">3</span>
                                <p className="text-sm">Order <strong>Type & Screen</strong></p>
                              </div>
                            </div>
                          </div>

                          {/* === WARFARIN REVERSAL === */}
                          <details className="bg-white border border-red-200 rounded-xl shadow-sm">
                            <summary className="cursor-pointer px-4 py-3 font-semibold text-red-800 hover:bg-red-50 rounded-t-xl flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="pill" className="w-4 h-4 text-red-600"></i>
                              Warfarin Reversal Guide
                            </summary>
                            <div className="p-4 space-y-3">
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-amber-800 mb-1">Immediate — All Warfarin Patients:</p>
                                <p className="text-sm">Give <button onClick={() => setProtocolModal(protocolDetailMap.VITK)} className="text-blue-600 underline font-semibold hover:text-blue-800">Vitamin K 10 mg IV</button> immediately</p>
                              </div>

                              <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-red-800 mb-1">INR ≥ 1.6:</p>
                                <p className="text-sm">Give <button onClick={() => setProtocolModal(protocolDetailMap.PCC)} className="text-blue-600 underline font-semibold hover:text-blue-800">PCC (Kcentra) 2000 units IVPB x1</button></p>
                                <ul className="text-sm mt-2 space-y-1 ml-4">
                                  <li>• Check PT/INR at <strong>15-30 min</strong>, <strong>6h</strong>, and <strong>24h</strong> after PCC</li>
                                  <li>• If INR &gt;1.5 at 15-30 min → <strong>consult hematology</strong> for additional PCC</li>
                                  <li>• If INR &gt;1.5 at 24h → repeat vitamin K 10 mg IV over 30 min</li>
                                </ul>
                              </div>

                              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-slate-700 mb-1">INR 1.3-1.5:</p>
                                <p className="text-sm text-slate-600">Low evidence — consider PCC on a case-by-case basis</p>
                              </div>

                              <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-orange-800 mb-1">FFP Pathway (if PCC unavailable):</p>
                                <ol className="text-sm space-y-1 ml-4 list-decimal">
                                  <li>Give <button onClick={() => setProtocolModal(protocolDetailMap.FFP)} className="text-blue-600 underline font-semibold hover:text-blue-800">4 units emergency-release FFP</button></li>
                                  <li>Check INR → if &gt;1.5 give 4 more type-specific units</li>
                                  <li>If still &gt;1.5 → consult hematology</li>
                                </ol>
                              </div>

                              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <p className="text-xs font-semibold text-yellow-800 mb-1">Relative Contraindications to PCC/FFP:</p>
                                <ul className="text-xs space-y-0.5 text-yellow-900">
                                  <li>• Thrombotic event in past 6 weeks</li>
                                  <li>• Prothrombotic condition</li>
                                  <li>• Major surgery in past 6 weeks</li>
                                  <li>• IPH not considered survivable</li>
                                </ul>
                              </div>
                            </div>
                          </details>

                          {/* === DOAC REVERSAL === */}
                          <details className="bg-white border border-red-200 rounded-xl shadow-sm">
                            <summary className="cursor-pointer px-4 py-3 font-semibold text-red-800 hover:bg-red-50 rounded-t-xl flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="pill" className="w-4 h-4 text-purple-600"></i>
                              DOAC Reversal Guide
                            </summary>
                            <div className="p-4 space-y-3">
                              {/* Dabigatran */}
                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-purple-800 mb-2">Dabigatran (Direct Thrombin Inhibitor)</p>
                                <p className="text-xs text-purple-600 mb-2">Reverse if TT prolonged or unavailable</p>
                                <ul className="text-sm space-y-1.5">
                                  <li className="flex gap-2">
                                    <span className="shrink-0 font-bold text-purple-700">1.</span>
                                    <span>If ingestion &lt;2h → <button onClick={() => setProtocolModal(protocolDetailMap.CHARCOAL)} className="text-blue-600 underline hover:text-blue-800">activated charcoal</button></span>
                                  </li>
                                  <li className="flex gap-2">
                                    <span className="shrink-0 font-bold text-purple-700">2.</span>
                                    <span>Give <button onClick={() => setProtocolModal(protocolDetailMap.IDA)} className="text-blue-600 underline font-semibold hover:text-blue-800">idarucizumab (Praxbind) 5 g IV</button> — two 2.5 g doses, ≤15 min apart, each over 5-10 min</span>
                                  </li>
                                  <li className="flex gap-2">
                                    <span className="shrink-0 font-bold text-purple-700">3.</span>
                                    <span>If idarucizumab unavailable → <button onClick={() => setProtocolModal(protocolDetailMap.PCC_DOAC)} className="text-blue-600 underline hover:text-blue-800">PCC (Kcentra) 2000 units</button></span>
                                  </li>
                                </ul>
                                <p className="text-xs text-purple-600 mt-2">Emergent dialysis option — dabigatran ~65% removed by dialysis (t½ = 14h, longer in renal impairment)</p>
                              </div>

                              {/* Factor Xa Inhibitors */}
                              <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-indigo-800 mb-2">Rivaroxaban / Apixaban (Factor Xa Inhibitors)</p>
                                <p className="text-xs text-indigo-600 mb-2">Reverse if Direct Xa Inhibitor screen elevated</p>
                                <ul className="text-sm space-y-1.5">
                                  <li className="flex gap-2">
                                    <span className="shrink-0 font-bold text-indigo-700">1.</span>
                                    <span>If ingestion &lt;2h → <button onClick={() => setProtocolModal(protocolDetailMap.CHARCOAL)} className="text-blue-600 underline hover:text-blue-800">activated charcoal</button></span>
                                  </li>
                                  <li className="flex gap-2">
                                    <span className="shrink-0 font-bold text-indigo-700">2.</span>
                                    <span>Consider <button onClick={() => setProtocolModal(protocolDetailMap.PCC_DOAC)} className="text-blue-600 underline font-semibold hover:text-blue-800">PCC (Kcentra) 2000 units</button> — ONLY if no contraindications</span>
                                  </li>
                                </ul>
                                <p className="text-xs text-indigo-600 mt-2">NOT dialyzable (rivaroxaban t½ = 9h, apixaban t½ = 12h)</p>
                              </div>

                              {/* Edoxaban */}
                              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-slate-700 mb-1">Edoxaban</p>
                                <p className="text-sm text-slate-600">Direct Xa Inhibitor screen excludes presence; no calibrated specific assays available. t½ = 10-14h, NOT dialyzable.</p>
                              </div>

                              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <p className="text-xs font-semibold text-yellow-800 mb-1">Relative Contraindications to PCC:</p>
                                <ul className="text-xs space-y-0.5 text-yellow-900">
                                  <li>• Thrombotic event in past 6 weeks</li>
                                  <li>• Prothrombotic condition</li>
                                  <li>• Major surgery in past 6 weeks</li>
                                  <li>• IPH not considered survivable</li>
                                </ul>
                              </div>
                            </div>
                          </details>

                          {/* === POST-THROMBOLYTIC ICH SUSPICION === */}
                          <details className="bg-white border border-red-200 rounded-xl shadow-sm">
                            <summary className="cursor-pointer px-4 py-3 font-semibold text-red-800 hover:bg-red-50 rounded-t-xl flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="alert-triangle" className="w-4 h-4 text-red-600"></i>
                              Post-Thrombolytic ICH Suspicion Algorithm
                            </summary>
                            <div className="p-4 space-y-3">
                              <div className="bg-red-100 border border-red-300 rounded-lg p-3">
                                <p className="text-xs font-semibold text-red-800 mb-1">Triggered by:</p>
                                <p className="text-sm text-red-700">Sudden neurological deterioration, new headache, acute hypertension, nausea/vomiting</p>
                              </div>

                              <div className="space-y-2">
                                <div className="flex gap-2 items-start">
                                  <span className="shrink-0 w-6 h-6 rounded-full bg-red-700 text-white text-xs flex items-center justify-center font-bold">1</span>
                                  <p className="text-sm"><strong>STOP thrombolytic</strong> if still running</p>
                                </div>
                                <div className="flex gap-2 items-start">
                                  <span className="shrink-0 w-6 h-6 rounded-full bg-red-700 text-white text-xs flex items-center justify-center font-bold">2</span>
                                  <div className="text-sm">
                                    <p><strong>STAT non-contrast CT Head</strong> + <strong>STAT blood draw:</strong></p>
                                    <ul className="ml-4 mt-1 text-xs space-y-0.5">
                                      <li>• Emergency Hemorrhage Panel: PT/INR, platelets, fibrinogen</li>
                                      <li>• Coag screen: PTT, TT, D-dimers</li>
                                      <li>• CBC, Type & Cross</li>
                                    </ul>
                                  </div>
                                </div>
                                <div className="flex gap-2 items-start">
                                  <span className="shrink-0 w-6 h-6 rounded-full bg-red-700 text-white text-xs flex items-center justify-center font-bold">3</span>
                                  <p className="text-sm">Call <strong>Transfusion Support</strong>; order <button onClick={() => setProtocolModal(protocolDetailMap.CRYO)} className="text-blue-600 underline font-semibold hover:text-blue-800">2 pools Cryoprecipitate</button> (~15-20 min to prepare)</p>
                                </div>
                                <div className="flex gap-2 items-start">
                                  <span className="shrink-0 w-6 h-6 rounded-full bg-red-700 text-white text-xs flex items-center justify-center font-bold">4</span>
                                  <p className="text-sm"><strong>Notify family</strong></p>
                                </div>
                              </div>

                              {/* Decision tree */}
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-amber-800 mb-2">CT scan delayed &gt;30 min?</p>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  <div className="bg-white border border-amber-300 rounded p-2">
                                    <p className="text-xs font-semibold text-amber-700 mb-1">YES — CT delayed:</p>
                                    <p className="text-sm">Empirically administer 2 pools Cryo if fibrinogen &lt;200</p>
                                  </div>
                                  <div className="bg-white border border-amber-300 rounded p-2">
                                    <p className="text-xs font-semibold text-amber-700 mb-1">NO — CT available:</p>
                                    <p className="text-sm">Wait for CT results</p>
                                  </div>
                                </div>
                              </div>

                              <div className="bg-red-50 border border-red-300 rounded-lg p-3">
                                <p className="text-sm font-semibold text-red-800 mb-2">Intracranial blood on CT?</p>
                                <div className="space-y-2">
                                  <div className="bg-white border border-red-300 rounded p-2">
                                    <p className="text-xs font-semibold text-red-700 mb-1">YES — Blood confirmed:</p>
                                    <ol className="text-sm space-y-1 ml-4 list-decimal">
                                      <li>Give <button onClick={() => setProtocolModal(protocolDetailMap.CRYO)} className="text-blue-600 underline hover:text-blue-800">2 pools Cryo</button> over 10-30 min (or continue if already started)</li>
                                      <li>Give <button onClick={() => setProtocolModal(protocolDetailMap.TXA)} className="text-blue-600 underline hover:text-blue-800">TXA 1 g IV</button> over 10 min (or aminocaproic acid 4-5 g IV if TXA unavailable)</li>
                                      <li>Repeat hemorrhage panel</li>
                                      <li>Call Stroke/Neuro attending</li>
                                      <li>Consult neurosurgery</li>
                                    </ol>
                                    <p className="text-xs text-red-600 mt-1 italic">If Cryo already started + infusing and CT shows NO ICH → STOP infusion</p>
                                  </div>
                                  <div className="bg-white border border-emerald-300 rounded p-2">
                                    <p className="text-xs font-semibold text-emerald-700 mb-1">NO — No intracranial blood:</p>
                                    <ul className="text-sm space-y-1">
                                      <li>• Do <strong>NOT</strong> restart lytic</li>
                                      <li>• Consider other causes: extending infarct, seizure, hypoxia, hypercarbia, hypoglycemia, electrolyte abnormalities</li>
                                    </ul>
                                  </div>
                                </div>
                              </div>

                              <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                <p className="text-xs font-semibold text-purple-800 mb-2">ECASS Hemorrhagic Transformation Classification:</p>
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                  <div className="bg-white p-2 rounded border">
                                    <p className="font-semibold text-emerald-700">HI-1 (Asymptomatic)</p>
                                    <p>Small petechiae along infarct margin</p>
                                  </div>
                                  <div className="bg-white p-2 rounded border">
                                    <p className="font-semibold text-emerald-700">HI-2 (Asymptomatic)</p>
                                    <p>Confluent petechiae within infarct, no mass effect</p>
                                  </div>
                                  <div className="bg-white p-2 rounded border">
                                    <p className="font-semibold text-amber-700">PH-1 (Usually asymptomatic)</p>
                                    <p>Blood clot ≤30% of infarct, mild mass effect</p>
                                  </div>
                                  <div className="bg-white p-2 rounded border">
                                    <p className="font-semibold text-red-700">PH-2 (Often symptomatic)</p>
                                    <p>Blood clot &gt;30% of infarct with significant mass effect → neurosurgery consult</p>
                                  </div>
                                </div>
                                <p className="text-xs text-purple-700 mt-2"><strong>sICH definition:</strong> any hemorrhagic transformation + NIHSS increase ≥4 points from baseline (ECASS-II/SITS-MOST). PH-2 accounts for most sICH.</p>
                              </div>

                              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                <p className="text-xs font-semibold text-slate-700 mb-1">Follow-up & Management:</p>
                                <ul className="text-xs space-y-0.5 text-slate-600">
                                  <li>• Target SBP &lt;140 mmHg for confirmed sICH</li>
                                  <li>• Target fibrinogen &gt;200 mg/dL (repeat cryo if low)</li>
                                  <li>• If labs abnormal or uncontrolled bleeding → consult Hematology</li>
                                  <li>• Repeat hemorrhage panel q4h until normal</li>
                                  <li>• Repeat NCCT at 6h and 24h to assess stability</li>
                                  <li>• PH-2 with mass effect → urgent neurosurgery evaluation</li>
                                  <li>• Hold all antithrombotics until hemorrhage stable ≥24h</li>
                                  <li>• Update family — document goals of care discussion</li>
                                </ul>
                              </div>
                            </div>
                          </details>

                          {/* === ANGIOEDEMA MANAGEMENT === */}
                          <details className="bg-white border border-red-200 rounded-xl shadow-sm">
                            <summary className="cursor-pointer px-4 py-3 font-semibold text-red-800 hover:bg-red-50 rounded-t-xl flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="shield-alert" className="w-4 h-4 text-orange-600"></i>
                              Angioedema Management
                            </summary>
                            <div className="p-4 space-y-3">
                              <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                <p className="text-xs text-orange-600 mb-2">Post-thrombolytic orolingual angioedema</p>
                                <div className="space-y-2">
                                  <div className="flex gap-2 items-start">
                                    <span className="shrink-0 w-6 h-6 rounded-full bg-orange-600 text-white text-xs flex items-center justify-center font-bold">1</span>
                                    <p className="text-sm"><strong>Maintain airway</strong> — may not need intubation if limited to anterior tongue/lips; fiberoptic intubation preferred if needed</p>
                                  </div>
                                  <div className="flex gap-2 items-start">
                                    <span className="shrink-0 w-6 h-6 rounded-full bg-orange-600 text-white text-xs flex items-center justify-center font-bold">2</span>
                                    <p className="text-sm"><strong>Discontinue IV alteplase</strong> and <strong>hold ACE inhibitors</strong></p>
                                  </div>
                                  <div className="flex gap-2 items-start">
                                    <span className="shrink-0 w-6 h-6 rounded-full bg-orange-600 text-white text-xs flex items-center justify-center font-bold">3</span>
                                    <p className="text-sm"><button onClick={() => setProtocolModal(protocolDetailMap.METHYLPRED)} className="text-blue-600 underline hover:text-blue-800">Methylprednisolone 125 mg IV</button></p>
                                  </div>
                                  <div className="flex gap-2 items-start">
                                    <span className="shrink-0 w-6 h-6 rounded-full bg-orange-600 text-white text-xs flex items-center justify-center font-bold">4</span>
                                    <p className="text-sm"><button onClick={() => setProtocolModal(protocolDetailMap.DIPHEN)} className="text-blue-600 underline hover:text-blue-800">Diphenhydramine 50 mg IV</button></p>
                                  </div>
                                  <div className="flex gap-2 items-start">
                                    <span className="shrink-0 w-6 h-6 rounded-full bg-orange-600 text-white text-xs flex items-center justify-center font-bold">5</span>
                                    <p className="text-sm"><button onClick={() => setProtocolModal(protocolDetailMap.FAMOTIDINE)} className="text-blue-600 underline hover:text-blue-800">Famotidine 20 mg IV</button></p>
                                  </div>
                                </div>
                              </div>

                              <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                <p className="text-sm font-semibold text-red-800 mb-1">If worsening:</p>
                                <ul className="text-sm space-y-1">
                                  <li>• <button onClick={() => setProtocolModal(protocolDetailMap.EPI)} className="text-blue-600 underline hover:text-blue-800">Epinephrine 0.3 mg IM</button> (1 mg/mL, anterolateral thigh) or nebulized 3-5 mL of 1:1000</li>
                                  <li>• <button onClick={() => setProtocolModal(protocolDetailMap.ICATIBANT)} className="text-blue-600 underline hover:text-blue-800">Icatibant</button> (bradykinin B2 antagonist)</li>
                                  <li>• <button onClick={() => setProtocolModal(protocolDetailMap.BERINERT)} className="text-blue-600 underline hover:text-blue-800">C1 esterase inhibitor (Berinert) 20 IU/kg</button></li>
                                </ul>
                              </div>
                            </div>
                          </details>
                          <div className="bg-white border border-red-200 rounded-xl p-4 shadow-sm">
                            <div className="flex items-center justify-between mb-3">
                              <h4 className="text-sm font-semibold text-red-700">ABC/2 ICH Volume Calculator</h4>
                              {ichVolumeEstimate && (
                                <span className={`text-xs font-semibold px-2 py-1 rounded-full ${ichVolumeEstimate.exceeds30 ? 'bg-red-100 text-red-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                  {ichVolumeEstimate.display} mL
                                </span>
                              )}
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">A (cm)</label>
                                <input
                                  type="number" min="0.1" max="20" step="0.1"
                                  value={ichVolumeParams.a}
                                  onChange={(e) => setIchVolumeParams(prev => ({ ...prev, a: e.target.value }))}
                                  className="w-full px-2 py-1.5 border border-slate-200 rounded-lg"
                                  placeholder="e.g. 4.2"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">B (cm)</label>
                                <input
                                  type="number" min="0.1" max="20" step="0.1"
                                  value={ichVolumeParams.b}
                                  onChange={(e) => setIchVolumeParams(prev => ({ ...prev, b: e.target.value }))}
                                  className="w-full px-2 py-1.5 border border-slate-200 rounded-lg"
                                  placeholder="e.g. 3.6"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Slice thickness (mm)</label>
                                <input
                                  type="number" min="1" max="10" step="0.5"
                                  value={ichVolumeParams.thicknessMm}
                                  onChange={(e) => setIchVolumeParams(prev => ({ ...prev, thicknessMm: e.target.value }))}
                                  className="w-full px-2 py-1.5 border border-slate-200 rounded-lg"
                                  placeholder="e.g. 5"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-slate-500 mb-1">Slices w/ ICH</label>
                                <input
                                  type="number" min="1" max="100" step="1"
                                  value={ichVolumeParams.numSlices}
                                  onChange={(e) => setIchVolumeParams(prev => ({ ...prev, numSlices: e.target.value }))}
                                  className="w-full px-2 py-1.5 border border-slate-200 rounded-lg"
                                  placeholder="e.g. 6"
                                />
                              </div>
                            </div>
                            <p className="text-xs text-slate-500 mt-3">
                              Auto-flags volume ≥30 mL (predictive of worse outcomes and surgical consideration).
                            </p>
                          </div>
                          <div className="bg-white border border-red-200 rounded-xl p-4">
                              <h4 className="text-sm font-semibold text-red-700 mb-2">Telestroke rapid actions (phone or video)</h4>
                              <ul className="text-sm space-y-1 text-slate-700">
                                <li>Confirm anticoagulant/antiplatelet use and initiate reversal.</li>
                                <li>Target SBP &lt;140 (Class IIa, INTERACT2; avoid &lt;130 per ATACH-2). Use IV nicardipine or clevidipine for smooth control.</li>
                                <li>Screen for transfer triggers: cerebellar ICH ≥15 mL with deterioration/brainstem compression/hydrocephalus, IVH with hydrocephalus requiring EVD, or worsening supratentorial ICH.</li>
                                <li>Plan repeat imaging and close neuro checks; avoid new DNAR/withdrawal within first 24h if no preexisting limits.</li>
                              </ul>
                              <p className="text-xs text-slate-500 mt-2">
                                {consultationType === 'telephone'
                                  ? 'Telephone: confirm NIHSS and exam details with the bedside team.'
                                  : 'Video: perform a focused remote NIHSS and confirm imaging review.'}
                              </p>
                            </div>
                            <div className="bg-white border border-red-200 rounded-xl p-4">
                              <h4 className="text-sm font-semibold text-red-700 mb-2">Inpatient priorities</h4>
                              <ul className="text-sm space-y-1 text-slate-700">
                                <li>Continue anticoagulant reversal, monitor for hematoma expansion, and maintain SBP &lt;140.</li>
                                <li>Evaluate IVH/hydrocephalus for EVD and monitor for neurologic decline.</li>
                                <li>Manage seizures, avoid prophylaxis without seizures, and use EEG when indicated.</li>
                                <li>Implement supportive care bundle, early rehab, and structured goals-of-care discussions.</li>
                              </ul>
                            </div>
                        </div>

                        <details className="mt-5 bg-white border border-red-200 rounded-lg">
                          <summary className="cursor-pointer px-4 py-3 font-semibold text-red-800 hover:bg-red-50 rounded-lg">ICH protocol details</summary>
                          <div className="p-4 space-y-6">
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 className="text-lg font-semibold text-blue-800 mb-3">Minimally Invasive Evacuation (MIE)</h3>

                        <div className="bg-white p-3 rounded border mb-4">
                          <h4 className="font-semibold text-blue-700 mb-2">Surgical Selection</h4>
                          <ul className="text-sm space-y-1">
                            <li>Supratentorial ICH volume &gt;20-30 mL with GCS 5-12: MIS evacuation can reduce mortality.</li>
                            <li>MIS may be reasonable over conventional craniotomy in eligible patients.</li>
                            <li>Functional outcome benefit remains uncertain.</li>
                          </ul>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <div className="bg-white p-3 rounded border">
                            <h4 className="font-semibold text-emerald-600 mb-2">ENRICH MIE Inclusion (NCT02880878)</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Spontaneous <strong>lobar</strong> IPH — no underlying lesion (tumor/AVM)</li>
                              <li>• ICH volume 30-80 cc</li>
                              <li>• ≤24 hours of symptom onset</li>
                              <li>• Age 18-80 years</li>
                              <li>• NIHSS &gt;5</li>
                              <li>• GCS 5-15</li>
                              <li>• Pre-morbid mRS 0-1</li>
                            </ul>
                            <p className="text-xs text-emerald-700 mt-2 italic">* Reasonable to consider in cases 24-72h after onset and outside trial criteria — discuss with neurosurgery.</p>
                          </div>

                          <div className="bg-white p-3 rounded border">
                            <h4 className="font-semibold text-red-600 mb-2">ENRICH MIE Exclusion</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Coagulopathy</li>
                              <li>• IVH &gt;50% either lateral ventricle</li>
                              <li>• Thalamic or infratentorial ICH</li>
                              <li>• Underlying structural lesion (tumor, AVM)</li>
                            </ul>
                            <div className="mt-3 bg-blue-50 border border-blue-200 rounded p-2">
                              <p className="text-xs font-semibold text-blue-800">To discuss MIE candidates:</p>
                              <p className="text-xs text-blue-700">MIE Neurosurgery: <strong>see contact directory</strong> (6AM-10PM)</p>
                              <p className="text-xs text-blue-700">After 10PM: consult NSGY on-call, call MIE contact after 6AM</p>
                              <p className="text-xs text-blue-700 italic">Keep patient NPO until final decision made</p>
                            </div>
                          </div>
                        </div>

                        <div className="bg-slate-100 p-3 rounded">
                          <p className="text-sm font-semibold mb-2">ICH Volume Calculation:</p>
                          <p className="text-sm"><strong>ABC/2 Method:</strong></p>
                          <ul className="text-sm ml-4">
                            <li>A = largest ICH diameter (cm)</li>
                            <li>B = largest diameter 90 degrees to A on same slice (cm)</li>
                            <li>C = (# CT slices with ICH) x (slice thickness)</li>
                          </ul>
                          <p className="text-sm mt-2 font-semibold">Volume = A x B x C / 2</p>
                        </div>
                      </div>

                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">Anticoagulation Reversal</h3>

                        {/* Warfarin */}
                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-blue-700 mb-3">Warfarin</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Immediate:</strong> Vitamin K 10 mg IV for all warfarin patients.</li>
                            <li><strong>INR ≥1.6:</strong> PCC (Kcentra) 2000 units IVPB x1.</li>
                            <li><strong>Check INR:</strong> at 15-30 min, 6h, and 24h after PCC.</li>
                            <li><strong>INR &gt;1.5 at 15-30 min:</strong> consult hematology for additional PCC.</li>
                            <li><strong>INR &gt;1.5 at 24h:</strong> repeat vitamin K 10 mg IV over 30 min.</li>
                            <li><strong>INR 1.3-1.5:</strong> low evidence — consider on case-by-case basis.</li>
                            <li><strong>FFP pathway (if PCC unavailable):</strong> 4 units emergency-release FFP → recheck INR → if &gt;1.5 give 4 more → if still &gt;1.5 consult hematology.</li>
                          </ul>
                        </div>

                        {/* Direct Oral Anticoagulants (DOACs) */}
                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-purple-700 mb-3">Direct Oral Anticoagulants (DOACs)</h4>

                          <div className="mb-3">
                            <p className="text-sm font-semibold text-slate-700">Dabigatran (Direct Thrombin Inhibitor):</p>
                            <ul className="text-sm space-y-1">
                              <li><strong>Idarucizumab (Praxbind):</strong> 5 g IV — two 2.5 g doses, ≤15 min apart, each over 5-10 min.</li>
                              <li><strong>If unavailable:</strong> PCC (Kcentra) 2000 units.</li>
                              <li><strong>Activated charcoal:</strong> if ingestion &lt;2 hours.</li>
                              <li><strong>Dialysis:</strong> ~65% removed (t½ = 14h, longer in renal impairment).</li>
                            </ul>
                          </div>

                          <div>
                            <p className="text-sm font-semibold text-slate-700">Rivaroxaban / Apixaban (Factor Xa Inhibitors):</p>
                            <ul className="text-sm space-y-1">
                              <li><strong>PCC (Kcentra):</strong> 2000 units — consider ONLY if Direct Xa Inhibitor screen elevated and no contraindications.</li>
                              <li><strong>Activated charcoal:</strong> if ingestion &lt;2 hours.</li>
                              <li><strong>NOT dialyzable</strong> (rivaroxaban t½ = 9h, apixaban t½ = 12h).</li>
                            </ul>
                          </div>

                          <div className="mt-3">
                            <p className="text-sm font-semibold text-slate-700">Edoxaban:</p>
                            <ul className="text-sm space-y-1">
                              <li>Direct Xa Inhibitor screen excludes presence; no calibrated specific assays. t½ = 10-14h, NOT dialyzable.</li>
                            </ul>
                          </div>
                        </div>

                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-indigo-700 mb-3">Heparins</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>UFH:</strong> IV protamine is reasonable.</li>
                            <li><strong>LMWH:</strong> IV protamine may be considered.</li>
                          </ul>
                        </div>

                        {/* Relative Contraindications */}

                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-slate-700 mb-3">Relative contraindications to PCC/FFP:</h4>
                          <ul className="text-sm space-y-1">
                            <li>• History of major thrombosis/thromboembolism ≤6 weeks</li>
                            <li>• Major surgery ≤6 weeks</li>
                            <li>• Known prothrombotic disorder</li>
                            <li>• IPH not considered survivable</li>
                          </ul>
                        </div>
                      </div>

                        <div className="mb-6">
                          <h3 className="text-lg font-semibold text-red-700 mb-4">Antiplatelet-Associated ICH</h3>
                          <div className="bg-white p-4 rounded border">
                            <ul className="text-sm space-y-1">
                              <li>Aspirin with emergent neurosurgery: platelet transfusion might be considered.</li>
                              <li>Aspirin without planned surgery: platelet transfusions are potentially harmful and should not be given.</li>
                              <li>Desmopressin 0.3 mcg/kg IV once may be considered; benefit uncertain.</li>
                            </ul>
                          </div>
                        </div>

                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">Hematoma Expansion Prevention</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="bg-white p-4 rounded border">
                            <h4 className="font-semibold text-red-600 mb-2">Blood Pressure Target</h4>
                            <ul className="text-sm space-y-1">
                              <li><strong>Target:</strong> SBP &lt;140 mmHg within 2h (Class IIa, INTERACT2). Avoid SBP &lt;130 (ATACH-2).</li>
                              <li><strong>Smooth control:</strong> avoid peaks and variability.</li>
                              <li><strong>SBP &gt;220:</strong> Safety of intensive lowering is uncertain (Class IIb, LOE C-EO, AHA 2022). Reasonable to target modest reduction (SBP 140-160) using continuous IV infusion with close monitoring. Avoid rapid drops &gt;60 mmHg in the first hour. Consider starting nicardipine at a lower rate (2.5-5 mg/hr) and titrating slowly.</li>
                              <li><strong>Agent:</strong> IV nicardipine or clevidipine for titration.</li>
                            </ul>
                          </div>
                          <div className="bg-white p-4 rounded border">
                            <h4 className="font-semibold text-red-600 mb-2">Expansion Risk Factors</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Spot sign on CTA</li>
                              <li>• Anticoagulant use</li>
                              <li>• Time from onset &lt;3 hours</li>
                              <li>• Large initial volume (&gt;30 mL)</li>
                              <li>• Irregular hematoma shape</li>
                              <li>• Blend sign on NCCT</li>
                            </ul>
                          </div>
                        </div>
                      </div>

                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">IVH &amp; Hydrocephalus Management</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="bg-white p-4 rounded border">
                            <h4 className="font-semibold text-orange-600 mb-2">EVD Indications</h4>
                            <ul className="text-sm space-y-1">
                              <li>ICH or IVH with hydrocephalus causing decreased consciousness: EVD recommended to reduce mortality.</li>
                              <li>Large IVH with impaired consciousness: EVD preferred over medical management alone.</li>
                            </ul>
                          </div>
                          <div className="bg-white p-4 rounded border">
                            <h4 className="font-semibold text-orange-600 mb-2">IVH-Specific Management</h4>
                            <ul className="text-sm space-y-1">
                              <li>GCS &gt;3 with primary IVH or IVH extension from supratentorial ICH &lt;30 mL requiring EVD: EVD + thrombolytic is reasonable to reduce mortality.</li>
                              <li>Functional outcome benefit from EVD + thrombolytic is uncertain.</li>
                              <li>Neuroendoscopic evacuation + EVD benefit is uncertain.</li>
                            </ul>
                          </div>
                        </div>
                      </div>

                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">ICH Disposition &amp; Goals of Care</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="bg-white p-4 rounded border">
                            <h4 className="font-semibold text-blue-600 mb-2">Surgical Indications</h4>
                            <ul className="text-sm space-y-1">
                              <li><strong>Cerebellar ICH &gt;=15 mL</strong> with neurologic deterioration, brainstem compression, or hydrocephalus: immediate evacuation +/- EVD.</li>
                              <li><strong>Supratentorial ICH:</strong> routine craniotomy for outcome benefit is uncertain.</li>
                              <li><strong>Deteriorating supratentorial ICH:</strong> craniotomy may be considered as a lifesaving measure.</li>
                            </ul>
                          </div>
                          <div className="bg-white p-4 rounded border">
                            <h4 className="font-semibold text-blue-600 mb-2">Goals-of-Care Guidance</h4>
                            <ul className="text-sm space-y-1">
                              <li><strong>No preexisting limits:</strong> aggressive care and postpone new DNAR/withdrawal until at least the second full hospital day.</li>
                              <li>Do not limit other medical/surgical interventions solely due to DNAR unless explicitly specified.</li>
                              <li>Early palliative care for symptom management and shared decision making.</li>
                            </ul>
                          </div>
                        </div>
                      </div>

                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">Seizure Management in ICH</h3>
                        <div className="bg-white p-4 rounded border">
                          <ul className="text-sm space-y-1">
                            <li>Treat clinical seizures with antiseizure medication.</li>
                            <li>Treat electrographic seizures in impaired consciousness.</li>
                            <li>Continuous EEG (24 hours) is reasonable for unexplained abnormal or fluctuating mental status.</li>
                            <li>No prophylactic antiseizure medication in patients without seizures.</li>
                          </ul>
                        </div>
                      </div>

                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">Anticoagulation Restart After ICH</h3>
                        <div className="bg-white p-4 rounded border space-y-3">
                          <p className="text-xs text-slate-600">When and how to restart anticoagulation in patients with AF who had an ICH. Individualize based on ICH location, etiology, and stroke risk.</p>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                              <h4 className="font-semibold text-emerald-800 text-sm mb-2">Deep ICH (Favorable for Restart)</h4>
                              <ul className="text-xs text-slate-700 space-y-1">
                                <li>&#x2022; Lower rebleed risk (~2%/yr) vs lobar</li>
                                <li>&#x2022; Restart DOAC at <strong>4-8 weeks</strong> (AHA 2022)</li>
                                <li>&#x2022; Consider earlier (2-4 wks) if high CHA₂DS₂-VASc (&ge;6) and stable imaging</li>
                                <li>&#x2022; Prefer apixaban or edoxaban (lower ICH rates)</li>
                              </ul>
                            </div>
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                              <h4 className="font-semibold text-amber-800 text-sm mb-2">Lobar ICH (Higher Rebleed Risk)</h4>
                              <ul className="text-xs text-slate-700 space-y-1">
                                <li>&#x2022; Often CAA-associated &mdash; rebleed ~7-10%/yr</li>
                                <li>&#x2022; Delay restart to <strong>&ge;8 weeks</strong> or consider alternatives</li>
                                <li>&#x2022; <strong>LAA closure (Watchman)</strong>: reasonable if CHA₂DS₂-VASc &ge;3 + high rebleed risk (STROKE-CLOSE)</li>
                                <li>&#x2022; If restarting, use lowest effective DOAC dose</li>
                              </ul>
                            </div>
                          </div>
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h4 className="font-semibold text-blue-800 text-sm mb-2">Key Evidence</h4>
                            <ul className="text-xs text-slate-700 space-y-1">
                              <li>&#x2022; <strong>SoSTART (2021):</strong> OAC restart associated with lower recurrent stroke without excess ICH (observational)</li>
                              <li>&#x2022; <strong>APACHE-AF (2021):</strong> Apixaban vs no anticoagulation &mdash; underpowered, trend favoring restart</li>
                              <li>&#x2022; <strong>PRESTIGE-AF (2024):</strong> DOAC restart reduced ischemic events without significant increase in ICH</li>
                              <li>&#x2022; <strong>STROKE-CLOSE (2024):</strong> LAA closure (Watchman) showed lower composite endpoint vs DOAC in ICH patients with AF (HR 0.61). Particularly beneficial for lobar ICH with high rebleed risk.</li>
                              <li>&#x2022; <strong>DOAC preferred over warfarin</strong> for restart (lower ICH risk: 0.3-0.5%/yr vs 1%/yr)</li>
                            </ul>
                          </div>
                          <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                            <h4 className="font-semibold text-red-800 text-sm mb-2">Do NOT Restart If</h4>
                            <ul className="text-xs text-slate-700 space-y-1">
                              <li>&#x2022; Multiple lobar ICH or severe CAA burden on MRI</li>
                              <li>&#x2022; Ongoing hematoma expansion</li>
                              <li>&#x2022; Uncontrolled hypertension</li>
                              <li>&#x2022; Patient/family preference against restart</li>
                            </ul>
                          </div>
                        </div>
                      </div>

                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">ICH Supportive Care Bundle</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <div className="bg-white p-4 rounded border">
                            <h4 className="font-semibold text-slate-700 mb-2">Standard Orders</h4>
                            <ul className="text-sm space-y-1">
                              <li>NPO until dysphagia screen passed.</li>
                              <li>IPC starting day of diagnosis for VTE prophylaxis.</li>
                              <li>Low-dose UFH/LMWH can be useful to reduce PE risk.</li>
                              <li>Initiate UFH/LMWH at 24-48h if hematoma stable.</li>
                              <li>Graduated compression stockings alone are not beneficial.</li>
                              <li>Glucose target 140-180 (no intensive insulin).</li>
                              <li>Acetaminophen for temp &gt;38 C.</li>
                              <li>HOB 30 degrees.</li>
                            </ul>
                          </div>
                          <div className="bg-white p-4 rounded border">
                            <h4 className="font-semibold text-slate-700 mb-2">Monitoring</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Neuro checks q1h x 24h, then q2h</li>
                              <li>• Continuous telemetry</li>
                              <li>• Repeat CT at 6h or with any neurological change</li>
                              <li>• Daily CBC, BMP, coags if on reversal</li>
                              <li>• Early PT/OT/SLP once medically stable</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                          </div>
                        </details>
                      </div>
                    )}
                    {/* End of ICH Content */}

                    {/* Ischemic Stroke Management Content */}
                    {managementSubTab === 'ischemic' && (
                      <div id="mgmt-tabpanel-ischemic" role="tabpanel" aria-labelledby="mgmt-tab-ischemic" className="space-y-6">
                        {/* Section TOC */}
                        <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                          <p className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Jump to Section</p>
                          <div className="flex flex-wrap gap-1.5">
                            {[
                              ['isch-evt', 'EVT Eligibility'],
                              ['isch-af', 'AF/DOAC Timing'],
                              ['isch-bp', 'BP Management'],
                              ['isch-nbo', 'NBO'],
                              ['isch-postlytic', 'Post-Lytic ICH'],
                              ['isch-ht', 'HT Classification'],
                              ['isch-angioedema', 'Angioedema'],
                              ['isch-antiplatelet', 'Antiplatelets'],
                              ['isch-statin', 'Statins'],
                              ['isch-largecore', 'Large Core'],
                              ['isch-postevt', 'Post-EVT'],
                              ['isch-mevo', 'MeVO'],
                              ['isch-contrast', 'Contrast Allergy'],
                              ['isch-icad', 'ICAD'],
                              ['isch-posterior', 'Posterior Circ'],
                              ['isch-cad', 'CAD'],
                              ['isch-seizure', 'Seizure Ppx'],
                            ].map(([id, label]) => (
                              <button key={id} type="button" onClick={() => document.getElementById(id)?.scrollIntoView({behavior: 'smooth', block: 'start'})}
                                className="px-2.5 py-1.5 text-xs rounded-full bg-white border border-slate-300 text-slate-600 hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700 transition-colors">
                                {label}
                              </button>
                            ))}
                          </div>
                        </div>
                        <div id="isch-evt" className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
                            <h3 className="text-lg font-semibold text-blue-800">EVT Eligibility — Quick Reference</h3>
                          </div>

                          {/* Adult EVT Flowchart */}
                          <div className="space-y-3 mb-4">
                            <p className="text-xs font-semibold uppercase tracking-wide text-blue-700">Adult AIS — EVT Eligibility</p>

                            {/* LVO */}
                            <div className="bg-white rounded-xl border-l-4 border-blue-600 p-3 shadow-sm">
                              <p className="font-semibold text-blue-800 text-sm mb-2">LVO (ICA-T / M1)</p>
                              <p className="text-xs text-slate-600 mb-2">NIHSS ≥6 unless otherwise specified</p>

                              {/* 0-6h */}
                              <div className="ml-2 mb-3 pl-3 border-l-2 border-blue-200">
                                <p className="text-xs font-bold text-blue-600 mb-1.5">0 – 6 hours</p>
                                <div className="space-y-1.5 text-xs">
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">ASPECTS 3-10, mRS 0-1</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-emerald-600 text-white font-semibold">Recommended</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">ASPECTS 6-10, mRS 2</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800 font-semibold border border-emerald-300">Reasonable</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">ASPECTS 6-10, mRS 3-4</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold border border-amber-300">May be considered</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">ASPECTS 0-2, mRS 0-1 — consider CTP core ≤70-100cc</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold border border-amber-300">Very select cases</span>
                                  </div>
                                </div>
                              </div>

                              {/* 6-24h */}
                              <div className="ml-2 mb-3 pl-3 border-l-2 border-blue-200">
                                <p className="text-xs font-bold text-blue-600 mb-1.5">6 – 24 hours</p>
                                <div className="space-y-1.5 text-xs">
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">ASPECTS 6-10, mRS 0-1</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-emerald-600 text-white font-semibold">Recommended</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">ASPECTS 3-5, mRS 0-1 — consider CTP core ≤100cc + mismatch</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-emerald-600 text-white font-semibold">Recommended</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">ASPECTS 0-2</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 font-semibold border border-slate-300">Benefit unclear</span>
                                  </div>
                                </div>
                              </div>

                              {/* >24h */}
                              <div className="ml-2 pl-3 border-l-2 border-slate-200">
                                <p className="text-xs font-bold text-slate-500 mb-1.5">&gt;24 hours</p>
                                <div className="text-xs flex items-center gap-1.5">
                                  <span className="text-slate-500">Any</span>
                                  <span className="text-slate-500">→</span>
                                  <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 font-semibold border border-slate-300">Individualized</span>
                                </div>
                              </div>
                            </div>

                            {/* Basilar */}
                            <div className="bg-white rounded-xl border-l-4 border-violet-500 p-3 shadow-sm">
                              <p className="font-semibold text-violet-800 text-sm mb-2">Basilar Artery</p>
                              <div className="ml-2 pl-3 border-l-2 border-violet-200">
                                <p className="text-xs font-bold text-violet-600 mb-1.5">0 – 24 hours &bull; PC-ASPECTS ≥6</p>
                                <div className="space-y-1.5 text-xs">
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">mRS 0-1, NIHSS ≥10</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-emerald-600 text-white font-semibold">Recommended</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">NIHSS 6-9</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold border border-amber-300">May be considered</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-500">mRS 2+</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 font-semibold border border-slate-300">Individualized</span>
                                  </div>
                                </div>
                              </div>
                            </div>

                            {/* M2 / MeVO */}
                            <div className="bg-white rounded-xl border-l-4 border-slate-400 p-3 shadow-sm">
                              <p className="font-semibold text-slate-800 text-sm mb-2">M2 / Distal Vessels</p>
                              <div className="ml-2 pl-3 border-l-2 border-slate-200">
                                <div className="space-y-1.5 text-xs">
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">Proximal/dominant M2 ≤1cm of bifurcation, salvageable tissue, LKW ≤24h</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold border border-amber-300">May be considered (select cases)</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">M2-M4 MCA, ACA, PCA occlusions</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-semibold border border-red-300">Not recommended</span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Pediatric EVT Flowchart */}
                          <div className="space-y-3">
                            <p className="text-xs font-semibold uppercase tracking-wide text-blue-700">Pediatric AIS — EVT Eligibility</p>

                            <div className="bg-white rounded-xl border-l-4 border-sky-500 p-3 shadow-sm">
                              <p className="font-semibold text-sky-800 text-sm mb-2">Pediatric LVO</p>
                              <div className="ml-2 pl-3 border-l-2 border-sky-200">
                                <div className="space-y-1.5 text-xs">
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">Age 6-17y, 0-24h, salvageable tissue</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800 font-semibold border border-emerald-300">Reasonable</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-700">Age 28d-5y, 0-24h, salvageable tissue</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold border border-amber-300">May be considered</span>
                                  </div>
                                  <div className="flex flex-wrap items-center gap-1.5">
                                    <span className="text-slate-500">Neonates (0-28d) / &gt;24h</span>
                                    <span className="text-slate-500">→</span>
                                    <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-600 font-semibold border border-slate-300">Individualized</span>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div className="flex flex-wrap gap-2 text-xs text-slate-500">
                              <span><span className="inline-block w-3 h-3 rounded-full bg-emerald-600 align-middle mr-1"></span>Recommended</span>
                              <span><span className="inline-block w-3 h-3 rounded-full bg-emerald-100 border border-emerald-300 align-middle mr-1"></span>Reasonable</span>
                              <span><span className="inline-block w-3 h-3 rounded-full bg-amber-100 border border-amber-300 align-middle mr-1"></span>May be considered / Uncertain</span>
                              <span><span className="inline-block w-3 h-3 rounded-full bg-red-100 border border-red-300 align-middle mr-1"></span>Not recommended</span>
                              <span><span className="inline-block w-3 h-3 rounded-full bg-slate-100 border border-slate-300 align-middle mr-1"></span>Individualized decision</span>
                            </div>
                          </div>
                        </div>
                          <div className="bg-white border border-blue-200 rounded-xl p-4">
                            <h4 className="text-sm font-semibold text-blue-800 mb-2">Telestroke rapid decision stack (phone or video)</h4>
                            <ul className="text-sm space-y-1 text-slate-700">
                              <li>Confirm LKW and thrombolysis window; screen for contraindications and disabling deficit.</li>
                              <li>Use the EVT Eligibility Builder and activate transfer for LVO or large core candidates.</li>
                              <li>Set BP phase target and treat if above goal.</li>
                              <li>Document consent, contraindication review, and disposition; copy the consult note.</li>
                            </ul>
                            <p className="text-xs text-slate-500 mt-2">
                              {consultationType === 'telephone'
                                ? 'Telephone: request NIHSS and exam details from the bedside team and review imaging together.'
                                : 'Video: perform a focused remote NIHSS and confirm imaging review.'}
                            </p>
                          </div>
                          <div className="bg-white border border-blue-200 rounded-xl p-4">
                            <h4 className="text-sm font-semibold text-blue-800 mb-2">Inpatient priorities</h4>
                            <ul className="text-sm space-y-1 text-slate-700">
                              <li>Post-lytic and post-EVT monitoring with phase-appropriate BP targets.</li>
                              <li>Manage complications (sICH, angioedema) and ensure nursing flowsheet compliance.</li>
                              <li>Initiate secondary prevention: antithrombotic plan, statin, and risk-factor control.</li>
                            </ul>
                          </div>

                        <details className="bg-white border border-blue-200 rounded-lg">
                          <summary className="cursor-pointer px-4 py-3 font-semibold text-blue-800 hover:bg-blue-50 rounded-lg">Ischemic protocol details</summary>
                          <div className="p-4 space-y-6">
                        <div className="bg-white border border-blue-200 rounded-lg p-4">
                          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
                            <div>
                              <h3 className="text-lg font-semibold text-blue-800">EVT Eligibility Builder</h3>
                              <p className="text-xs text-slate-500">Guideline-aligned decision support (adult algorithm). Pediatric criteria kept separate.</p>
                            </div>
                            <span className="text-xs text-slate-500">
                              Auto time: {calculateTimeFromLKW() ? `${calculateTimeFromLKW().hours}h ${calculateTimeFromLKW().minutes}m` : 'Set LKW'}
                            </span>
                          </div>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">Occlusion</label>
                              <select
                                value={evtDecisionInputs.occlusion}
                                onChange={(e) => setEvtDecisionInputs(prev => ({ ...prev, occlusion: e.target.value }))}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                              >
                                <option value="lvo">LVO (ICA-T / M1)</option>
                                <option value="mvo-dominant">MVO (dominant M2)</option>
                                <option value="mvo-nondominant">MVO non-dominant M2 or DVO</option>
                                <option value="basilar">Basilar artery</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">Time window</label>
                              <select
                                value={evtDecisionInputs.timeWindow}
                                onChange={(e) => setEvtDecisionInputs(prev => ({ ...prev, timeWindow: e.target.value }))}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                              >
                                <option value="auto">Auto (from LKW)</option>
                                <option value="0-6">0-6 h</option>
                                <option value="6-24">6-24 h</option>
                                <option value=">24">&gt;24 h</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">ASPECTS</label>
                              <select
                                value={evtDecisionInputs.aspects}
                                onChange={(e) => setEvtDecisionInputs(prev => ({ ...prev, aspects: e.target.value }))}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                              >
                                <option value="6-10">6-10</option>
                                <option value="3-5">3-5</option>
                                <option value="0-2">0-2</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">Pre-stroke mRS</label>
                              <select
                                value={evtDecisionInputs.mrs}
                                onChange={(e) => setEvtDecisionInputs(prev => ({ ...prev, mrs: e.target.value }))}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                              >
                                <option value="0-1">0-1</option>
                                <option value="2">2</option>
                                <option value="3-4">3-4</option>
                                <option value=">=2">≥2</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">NIHSS (Basilar)</label>
                              <input
                                type="number"
                                value={evtDecisionInputs.nihss}
                                onChange={(e) => setEvtDecisionInputs(prev => ({ ...prev, nihss: e.target.value }))}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                                placeholder="e.g. 12"
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">PC-ASPECTS (Basilar)</label>
                              <select
                                value={evtDecisionInputs.pcAspects}
                                onChange={(e) => setEvtDecisionInputs(prev => ({ ...prev, pcAspects: e.target.value }))}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                              >
                                <option value=">=6">≥6</option>
                                <option value="<6">&lt;6</option>
                              </select>
                            </div>
                          </div>
                          {(() => {
                            const result = getEvtEligibilityRecommendation(evtDecisionInputs, calculateTimeFromLKW());
                            return (
                              <div className={`mt-4 rounded-lg border p-3 ${
                                result.color === 'emerald'
                                  ? 'bg-emerald-50 border-emerald-200 text-emerald-800'
                                  : result.color === 'amber'
                                    ? 'bg-amber-50 border-amber-200 text-amber-800'
                                    : result.color === 'rose'
                                      ? 'bg-red-50 border-red-200 text-red-800'
                                      : 'bg-slate-50 border-slate-200 text-slate-700'
                              }`}>
                                <div className="flex items-center justify-between">
                                  <div>
                                    <p className="text-xs uppercase tracking-wide">Class of Recommendation</p>
                                    <p className="text-lg font-semibold">{result.classOfRec}</p>
                                  </div>
                                  <p className="text-sm font-medium">{result.label}</p>
                                </div>
                                {result.rationale && result.rationale.length > 0 && (
                                  <ul className="text-xs mt-2 space-y-1">
                                    {result.rationale.map((item, idx) => (
                                      <li key={idx}>• {item}</li>
                                    ))}
                                  </ul>
                                )}
                              </div>
                            );
                          })()}
                        </div>

                        <div className="bg-white border border-blue-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-blue-800 mb-2">Mobile Stroke Units (MSU)</h3>
                          <p className="text-sm text-slate-700">Use MSUs where available for rapid stroke identification and IV thrombolysis delivery. MSUs reduce onset-to-treatment time and improve outcomes (Class I, LOE A).</p>
                        </div>

                        <div className="bg-white border border-blue-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-blue-800 mb-2">Pediatric Reperfusion (28 days–18 years)</h3>
                          <ul className="text-sm space-y-1 text-slate-700">
                            <li>• MRI is preferred for diagnostic imaging when feasible.</li>
                            <li>• IV thrombolysis may be considered within 4.5h in select children at experienced centers (Class IIb).</li>
                            <li>• EVT for LVO is reasonable for age ≥6 years (Class IIa).</li>
                            <li>• EVT may be considered for age 28 days–6 years with experienced neurointerventionalist (Class IIb).</li>
                          </ul>
                        </div>

                        <div id="isch-af" className="bg-white border border-blue-200 rounded-lg p-4">
                          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
                            <div>
                              <h3 className="text-lg font-semibold text-blue-800">AF Anticoagulation Timing (CATALYST)</h3>
                              <p className="text-xs text-slate-500">Computes earliest start date based on NIHSS severity and protocol selection.</p>
                            </div>
                          </div>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">NIHSS</label>
                              <input
                                type="number"
                                value={telestrokeNote.nihss}
                                onChange={(e) => setTelestrokeNote(prev => ({ ...prev, nihss: e.target.value }))}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                                placeholder={nihssScore ? `Auto ${nihssScore}` : 'e.g. 8'}
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">Onset (LKW)</label>
                              <input
                                type="text"
                                value={`${lkwDateForWindow || ''} ${lkwTimeForWindow || ''}`.trim()}
                                readOnly
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg bg-slate-50 text-slate-500"
                              />
                            </div>
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">Protocol</label>
                              <select
                                value={doacProtocol}
                                onChange={(e) => setDoacProtocol(e.target.value)}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                              >
                                {Object.entries(DOAC_PROTOCOLS).map(([key, rule]) => (
                                  <option key={key} value={key}>{rule.label}</option>
                                ))}
                              </select>
                            </div>
                          </div>
                          {(() => {
                            const onsetDate = lkwDateForWindow && lkwTimeForWindow ? (() => { const dt = new Date(`${lkwDateForWindow}T${lkwTimeForWindow}`); return Number.isNaN(dt.getTime()) ? null : dt; })() : null;
                            const result = calculateDOACStart(telestrokeNote.nihss || nihssScore, onsetDate, doacProtocol);
                            if (!result) {
                              return (
                                <div className="mt-3 text-xs text-slate-500">
                                  Enter NIHSS and LKW to calculate the earliest DOAC start date.
                                </div>
                              );
                            }
                            return (
                              <div className="mt-3 bg-emerald-50 border border-emerald-200 rounded-lg p-3 text-sm">
                                <p className="font-semibold text-emerald-800">Earliest start: {result.startDate.toLocaleDateString()}</p>
                                <p className="text-xs text-emerald-700 mt-1">
                                  Severity: {result.severity} • Wait {result.days} day(s) after onset.
                                </p>
                              </div>
                            );
                          })()}
                          <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div className="bg-slate-50 p-3 rounded border">
                              <p className="text-sm text-slate-700 mb-2">CATALYST meta-analysis (ELAN, OPTIMAS, TIMING, START) supports early DOAC initiation as safe and non-inferior to delayed initiation.</p>
                              <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3 text-xs">
                                <div className="bg-emerald-50 p-2 rounded border border-emerald-200 text-center">
                                  <p className="font-bold text-emerald-700 uppercase">Minor</p>
                                  <p className="text-slate-500">NIHSS &lt;8</p>
                                  <p className="text-sm font-bold text-emerald-800 mt-1">Within 48h</p>
                                </div>
                                <div className="bg-amber-50 p-2 rounded border border-amber-200 text-center">
                                  <p className="font-bold text-amber-700 uppercase">Moderate</p>
                                  <p className="text-slate-500">NIHSS 8-15</p>
                                  <p className="text-sm font-bold text-amber-800 mt-1">Day 3-5</p>
                                </div>
                                <div className="bg-red-50 p-2 rounded border border-red-200 text-center">
                                  <p className="font-bold text-red-700 uppercase">Severe</p>
                                  <p className="text-slate-500">NIHSS &gt;15</p>
                                  <p className="text-sm font-bold text-red-800 mt-1">Day 6-14</p>
                                </div>
                              </div>
                            </div>
                            <div className="bg-slate-50 p-3 rounded border">
                              <h4 className="font-semibold text-purple-700 mb-2">Preferred DOACs</h4>
                              <ul className="text-sm space-y-1">
                                <li>• <strong>Apixaban</strong> 5 mg BID (2.5 mg if age ≥80, weight ≤60 kg, or Cr ≥1.5)</li>
                                <li>• <strong>Rivaroxaban</strong> 20 mg daily (15 mg if CrCl 15-50)</li>
                                <li>• <strong>Dabigatran</strong> 150 mg BID (75 mg BID if CrCl 15-30 mL/min)</li>
                                <li className="text-slate-500 italic text-xs mt-1">DOAC preferred over warfarin (Class I, LOE A) — AHA/ASA 2021</li>
                              </ul>
                            </div>
                          </div>
                          <p className="text-xs text-slate-500 mt-2 italic">Fischer U et al. Lancet Neurol. 2025. Reassess imaging before DOAC start if concern for hemorrhagic transformation.</p>
                        </div>

                        <div id="isch-bp" className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-blue-800 mb-3">Blood Pressure Management</h3>

                          <div className="bg-white border border-blue-200 rounded-lg p-3 mb-4">
                            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                              <div>
                                <h4 className="text-sm font-semibold text-blue-800">Phase-aware BP target</h4>
                                <p className="text-xs text-slate-500">Toggles update the target and highlight current BP status.</p>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                {Object.entries(bpPhaseTargets).map(([key, value]) => (
                                  <button
                                    key={key}
                                    type="button"
                                    onClick={() => setTelestrokeNote(prev => ({ ...prev, bpPhase: key }))}
                                    className={`px-3 py-1.5 rounded-full text-xs font-semibold border ${
                                      currentBpPhase === key
                                        ? 'bg-blue-600 text-white border-blue-600'
                                        : 'bg-blue-50 text-blue-700 border-blue-200 hover:bg-blue-100'
                                    }`}
                                  >
                                    {value.label}
                                  </button>
                                ))}
                              </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3 text-sm">
                              <div className="bg-blue-50 border border-blue-100 rounded-lg p-2">
                                <p className="text-xs uppercase tracking-wide text-blue-600">Target</p>
                                <p className="text-sm font-semibold text-blue-800">
                                  SBP &lt; {currentBpTarget.systolic} / DBP &lt; {currentBpTarget.diastolic}
                                </p>
                              </div>
                              <div className="bg-slate-50 border border-slate-200 rounded-lg p-2">
                                <p className="text-xs uppercase tracking-wide text-slate-500">Current BP</p>
                                <input
                                  type="text"
                                  value={telestrokeNote.bpPostEVT || telestrokeNote.bpPreTNK || telestrokeNote.presentingBP || ''}
                                  onChange={(e) => setTelestrokeNote(prev => ({ ...prev, bpPostEVT: e.target.value }))}
                                  className="w-full mt-1 px-2 py-1 border border-slate-200 rounded text-sm"
                                  placeholder="e.g. 172/98"
                                />
                                <p className="text-xs text-slate-500 mt-1">Uses Post-EVT, then Pre-TNK, then Presenting BP.</p>
                              </div>
                              <div className={`rounded-lg p-2 border ${bpWithinTarget === null ? 'bg-slate-50 border-slate-200' : bpWithinTarget ? 'bg-emerald-50 border-emerald-200' : 'bg-red-50 border-red-200'}`}>
                                <p className="text-xs uppercase tracking-wide text-slate-500">Status</p>
                                <p className="text-sm font-semibold">
                                  {bpWithinTarget === null ? 'Enter BP to check' : bpWithinTarget ? 'Within target' : 'Above target'}
                                </p>
                                {bpWithinTarget === false && (
                                  <p className="text-xs text-red-600 mt-1">Consider IV antihypertensive titration.</p>
                                )}
                              </div>
                            </div>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-emerald-700 mb-2">BP Goals</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>Ischemic stroke:</strong> SBP &lt;220, DBP &lt;120</li>
                                <li><strong>Before lytics:</strong> SBP &lt;185, DBP &lt;110</li>
                                <li><strong>After lytics:</strong> SBP &lt;180, DBP &lt;105</li>
                                <li><strong>After thrombectomy:</strong> SBP &lt;180, DBP &lt;105</li>
                                <li><strong>IPH:</strong> SBP &lt;140 (INTERACT2; no specific DBP target)</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-blue-700 mb-2">Quick Reference</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>First-line:</strong> Labetalol IV push OR Nicardipine drip</li>
                                <li><strong>Second-line:</strong> Clevidipine or Hydralazine</li>
                                <li className="text-amber-700"><strong>Avoid:</strong> Sublingual nifedipine (unpredictable drops), nitroprusside (raises ICP)</li>
                              </ul>
                            </div>
                          </div>

                          <details className="bg-white border border-blue-200 rounded-lg mb-4">
                            <summary className="p-3 text-sm font-semibold text-blue-800 cursor-pointer flex items-center gap-2">
                              <i aria-hidden="true" data-lucide="chevron-right" className="w-3.5 h-3.5"></i>
                              IV Antihypertensive Titration Protocols
                            </summary>
                            <div className="px-3 pb-3 space-y-3">
                              <div className="bg-blue-50 border border-blue-100 rounded-lg p-3">
                                <h5 className="font-bold text-blue-800 mb-2">Labetalol IV Push Protocol</h5>
                                <div className="overflow-x-auto">
                                  <table className="w-full text-sm border-collapse">
                                    <thead>
                                      <tr className="bg-blue-100">
                                        <th scope="col" className="border border-blue-200 px-2 py-1 text-left">Step</th>
                                        <th scope="col" className="border border-blue-200 px-2 py-1 text-left">Dose</th>
                                        <th scope="col" className="border border-blue-200 px-2 py-1 text-left">Timing</th>
                                        <th scope="col" className="border border-blue-200 px-2 py-1 text-left">Cumulative</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr><td className="border border-blue-200 px-2 py-1">1</td><td className="border border-blue-200 px-2 py-1 font-semibold">10 mg IV over 1-2 min</td><td className="border border-blue-200 px-2 py-1">Time 0</td><td className="border border-blue-200 px-2 py-1">10 mg</td></tr>
                                      <tr><td className="border border-blue-200 px-2 py-1">2</td><td className="border border-blue-200 px-2 py-1 font-semibold">20 mg IV</td><td className="border border-blue-200 px-2 py-1">+10 min</td><td className="border border-blue-200 px-2 py-1">30 mg</td></tr>
                                      <tr><td className="border border-blue-200 px-2 py-1">3</td><td className="border border-blue-200 px-2 py-1 font-semibold">40 mg IV</td><td className="border border-blue-200 px-2 py-1">+10 min</td><td className="border border-blue-200 px-2 py-1">70 mg</td></tr>
                                      <tr><td className="border border-blue-200 px-2 py-1">4</td><td className="border border-blue-200 px-2 py-1 font-semibold">80 mg IV</td><td className="border border-blue-200 px-2 py-1">+10 min</td><td className="border border-blue-200 px-2 py-1">150 mg</td></tr>
                                      <tr><td className="border border-blue-200 px-2 py-1">5</td><td className="border border-blue-200 px-2 py-1 font-semibold">80 mg IV</td><td className="border border-blue-200 px-2 py-1">+10 min</td><td className="border border-blue-200 px-2 py-1">230 mg</td></tr>
                                    </tbody>
                                  </table>
                                </div>
                                <ul className="text-xs text-slate-600 mt-2 space-y-0.5">
                                  <li>• Max cumulative dose: 300 mg in 24 hours</li>
                                  <li>• Onset: 2-5 min | Peak: 5-15 min | Duration: 2-4 hours</li>
                                  <li>• Hold if HR &lt;60 or SBP &lt;100</li>
                                  <li className="text-red-600">• Contraindicated: asthma/severe COPD, 2nd/3rd degree AV block, decompensated HF, HR &lt;60</li>
                                </ul>
                              </div>

                              <div className="bg-purple-50 border border-purple-100 rounded-lg p-3">
                                <h5 className="font-bold text-purple-800 mb-2">Nicardipine IV Drip Protocol</h5>
                                <div className="overflow-x-auto">
                                  <table className="w-full text-sm border-collapse">
                                    <thead>
                                      <tr className="bg-purple-100">
                                        <th scope="col" className="border border-purple-200 px-2 py-1 text-left">Step</th>
                                        <th scope="col" className="border border-purple-200 px-2 py-1 text-left">Rate</th>
                                        <th scope="col" className="border border-purple-200 px-2 py-1 text-left">Instructions</th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr><td className="border border-purple-200 px-2 py-1">Start</td><td className="border border-purple-200 px-2 py-1 font-semibold">5 mg/hr</td><td className="border border-purple-200 px-2 py-1">Check BP q5 min</td></tr>
                                      <tr><td className="border border-purple-200 px-2 py-1">Titrate up</td><td className="border border-purple-200 px-2 py-1 font-semibold">+2.5 mg/hr</td><td className="border border-purple-200 px-2 py-1">q5-15 min until target</td></tr>
                                      <tr><td className="border border-purple-200 px-2 py-1">Max</td><td className="border border-purple-200 px-2 py-1 font-semibold">15 mg/hr</td><td className="border border-purple-200 px-2 py-1">Call MD if not at goal</td></tr>
                                      <tr><td className="border border-purple-200 px-2 py-1">At goal</td><td className="border border-purple-200 px-2 py-1 font-semibold">Decrease by 3 mg/hr</td><td className="border border-purple-200 px-2 py-1">q30 min, maintain lowest effective rate</td></tr>
                                    </tbody>
                                  </table>
                                </div>
                                <ul className="text-xs text-slate-600 mt-2 space-y-0.5">
                                  <li>• Onset: 5-15 min | Duration: continuous while infusing</li>
                                  <li>• Preferred for: sustained BP control, patients needing precise titration</li>
                                  <li>• Standard dilution: 25 mg/250 mL NS (0.1 mg/mL) or 50 mg/250 mL (0.2 mg/mL)</li>
                                  <li>• Transition to PO antihypertensive 1h before stopping drip</li>
                                </ul>
                              </div>

                              <div className="bg-amber-50 border border-amber-100 rounded-lg p-3">
                                <h5 className="font-bold text-amber-800 mb-2">Clevidipine IV Drip Protocol</h5>
                                <ul className="text-sm space-y-1">
                                  <li>• Start: <strong>1-2 mg/hr</strong></li>
                                  <li>• Titrate: <strong>Double the rate q90 seconds</strong> until near goal</li>
                                  <li>• Fine-tune: increase by &lt;double as goal is approached</li>
                                  <li>• Max: <strong>32 mg/hr</strong> (max 1000 mL/24h due to lipid load)</li>
                                  <li>• Onset: 2-4 min | Duration: 5-15 min after stopping</li>
                                </ul>
                                <p className="text-xs text-slate-500 mt-1">Advantage: ultra-short acting, no renal/hepatic adjustment needed. Contains soy/egg lecithin — check allergies.</p>
                              </div>

                              <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                <h5 className="font-bold text-slate-700 mb-2">Hydralazine (Rescue)</h5>
                                <ul className="text-sm space-y-1">
                                  <li>• <strong>10-20 mg IV q20-30 min PRN</strong> (max 40 mg/dose)</li>
                                  <li>• Onset: 10-20 min | Duration: 1-4 hours</li>
                                  <li>• Less predictable response — use as adjunct when labetalol/nicardipine insufficient</li>
                                  <li className="text-red-600">• Avoid in aortic dissection (reflex tachycardia)</li>
                                </ul>
                              </div>
                            </div>
                          </details>
                        </div>

                        <div id="isch-nbo" className="bg-sky-50 border border-sky-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-sky-800 mb-2">Normobaric Oxygen (NBO) Before EVT</h3>
                          <p className="text-sm text-slate-700 mb-2">
                            In AIS within 6h with anterior LVO, NIHSS 10-20, and ASPECTS ≥6, NBO is reasonable before EVT.
                          </p>
                          <ul className="text-sm space-y-1 text-slate-700">
                            <li>• 100% O₂ at 10 L/min via non-rebreather for 4 hours (or FiO₂ 1.0 if intubated)</li>
                            <li>• <strong>Class IIb, LOE B-R</strong> (2026 AHA/ASA)</li>
                            <li>• Evidence: PROOF-ICL trial — NBO showed improved 90-day functional outcomes (mRS 0-2: 50% vs 38%)</li>
                            <li className="text-amber-700">• Do NOT apply supplemental O₂ to non-hypoxic AIS patients without LVO (Class III: No Benefit)</li>
                          </ul>
                        </div>

                        <div className="bg-white border border-blue-200 rounded-lg p-4">
                          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
                            <div>
                              <h3 className="text-lg font-semibold text-blue-800">Nursing Flowsheet Generator</h3>
                              <p className="text-xs text-slate-500">Auto-generates q15m ×4, then q30m ×4 checks from groin puncture.</p>
                            </div>
                            <button
                              type="button"
                              onClick={() => setTelestrokeNote(prev => ({ ...prev, punctureTime: new Date().toTimeString().slice(0, 5) }))}
                              className="text-xs font-semibold text-blue-700 hover:text-blue-900"
                            >
                              Use current time
                            </button>
                          </div>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                            <div>
                              <label className="block text-xs text-slate-500 mb-1">Groin puncture time</label>
                              <input
                                type="time"
                                value={telestrokeNote.punctureTime || ''}
                                onChange={(e) => setTelestrokeNote(prev => ({ ...prev, punctureTime: e.target.value }))}
                                className="w-full px-2 py-2 border border-slate-200 rounded-lg"
                              />
                            </div>
                            <div className="md:col-span-2">
                              {(() => {
                                const schedule = buildNursingFlowsheet(telestrokeNote.punctureTime);
                                if (schedule.length === 0) {
                                  return <p className="text-xs text-slate-500 mt-2">Enter puncture time to generate schedule.</p>;
                                }
                                return (
                                  <div className="space-y-2">
                                    <div className="flex flex-wrap gap-2">
                                      {schedule.map((item) => (
                                        <label key={item.time} className="flex items-center gap-2 text-xs bg-slate-50 border border-slate-200 rounded-lg px-2 py-1">
                                          <input
                                            type="checkbox"
                                            checked={!!nursingFlowsheetChecks[item.time]}
                                            onChange={(e) => setNursingFlowsheetChecks(prev => ({ ...prev, [item.time]: e.target.checked }))}
                                          />
                                          <span>{item.time}</span>
                                          <span className="text-xs text-slate-500">{item.label}</span>
                                        </label>
                                      ))}
                                    </div>
                                    <button
                                      type="button"
                                      onClick={() => {
                                        const lines = schedule.map(item => `${item.time} (${item.label})`);
                                        copyPlainText(`Post-EVT checks:\\n${lines.join('\\n')}`);
                                      }}
                                      className="text-xs font-semibold text-blue-700 hover:text-blue-900"
                                    >
                                      Copy schedule
                                    </button>
                                  </div>
                                );
                              })()}
                            </div>
                          </div>
                        </div>

                        <div id="isch-postlytic" className="bg-red-50 border border-red-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-red-800 mb-3">Post-Lytic ICH Protocol</h3>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold mb-2">Immediate Actions</h4>
                              <ol className="text-sm space-y-1 list-decimal list-inside">
                                <li>Stop thrombolytic if still running</li>
                                <li>STAT non-contrast CT head + STAT blood draw (PT/INR, platelets, fibrinogen, PTT, TT, D-dimers, CBC, Type &amp; Cross)</li>
                                <li>Call Transfusion Support; order 2 pools cryoprecipitate</li>
                                <li>Notify patient's family</li>
                              </ol>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold mb-2">Reversal (if blood on CT)</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>Cryoprecipitate:</strong> 2 pools IV over 10-30 min (empirically if CT delayed &gt;30 min and fibrinogen &lt;200)</li>
                                <li><strong>TXA:</strong> 1 g IV over 10 min (or aminocaproic acid 4-5 g IV if TXA unavailable)</li>
                                <li><strong>Repeat hemorrhage panel</strong></li>
                                <li><strong>Consult neurosurgery</strong></li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        <details id="isch-ht" className="bg-rose-50 border border-rose-200 rounded-lg">
                          <summary className="cursor-pointer p-4 font-semibold text-rose-800 hover:bg-rose-100 rounded-lg">
                            ECASS Hemorrhagic Transformation Classification
                          </summary>
                          <div className="px-4 pb-4 space-y-3">
                            <p className="text-xs text-slate-600">ECASS classification determines severity and guides anticoagulation restart decisions. Obtain CT 24h post-TNK or if neurological decline.</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                                <h4 className="font-bold text-emerald-800 text-sm mb-1">HI-1 (Hemorrhagic Infarction Type 1)</h4>
                                <p className="text-xs text-slate-700">Small petechiae along the margins of the infarct</p>
                                <p className="text-xs text-emerald-700 mt-1 font-medium">Clinical impact: Benign. No change in management. May restart anticoagulation per schedule.</p>
                              </div>
                              <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <h4 className="font-bold text-yellow-800 text-sm mb-1">HI-2 (Hemorrhagic Infarction Type 2)</h4>
                                <p className="text-xs text-slate-700">Confluent petechiae within the infarcted area, no mass effect</p>
                                <p className="text-xs text-yellow-700 mt-1 font-medium">Clinical impact: Usually benign. Monitor closely. May delay anticoagulation restart by a few days.</p>
                              </div>
                              <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                                <h4 className="font-bold text-orange-800 text-sm mb-1">PH-1 (Parenchymal Hematoma Type 1)</h4>
                                <p className="text-xs text-slate-700">Blood clot ≤30% of infarcted area, with mild mass effect</p>
                                <p className="text-xs text-orange-700 mt-1 font-medium">Clinical impact: Moderate. Hold anticoagulation/antiplatelets. Repeat imaging in 24-48h. Consider cautious restart after 1-2 weeks if stable.</p>
                              </div>
                              <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                <h4 className="font-bold text-red-800 text-sm mb-1">PH-2 (Parenchymal Hematoma Type 2)</h4>
                                <p className="text-xs text-slate-700">Blood clot &gt;30% of infarcted area, with significant mass effect (or remote hemorrhage)</p>
                                <p className="text-xs text-red-700 mt-1 font-medium">Clinical impact: SEVERE. Symptomatic sICH. Associated with neurological deterioration and increased mortality. Hold all antithrombotics. Neurosurgery consult. Delay anticoagulation ≥4 weeks.</p>
                              </div>
                            </div>
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-2">
                              <p className="text-xs text-blue-800"><strong>sICH (Symptomatic ICH) definition:</strong> PH-2 with NIHSS increase ≥4 points within 36h of treatment (ECASS II/III definition). Occurs in 2-7% of IV thrombolysis patients.</p>
                            </div>
                            <div className="bg-slate-50 border border-slate-200 rounded-lg p-2">
                              <p className="text-xs text-slate-700"><strong>Anticoagulation restart after HT:</strong> HI-1/HI-2 → per standard DOAC timing (see AF section above). PH-1 → delay 7-14 days, repeat imaging first. PH-2 → delay ≥4 weeks, multidisciplinary discussion, consider LAA closure (Watchman) if high rebleed risk.</p>
                            </div>
                          </div>
                        </details>

                        <div id="isch-angioedema" className="bg-amber-50 border border-amber-300 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-amber-800 mb-3">Orolingual Angioedema Protocol</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-amber-700 mb-2">Risk Factors</h4>
                              <ul className="text-sm space-y-1">
                                <li>• ACE inhibitor use</li>
                                <li>• Insular cortex involvement</li>
                                <li>• Frontal operculum stroke</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-amber-700 mb-2">Treatment</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>Maintain airway</strong> — fiberoptic intubation if needed</li>
                                <li><strong>Discontinue IV alteplase</strong> and hold ACE inhibitors</li>
                                <li><strong>Methylprednisolone:</strong> 125 mg IV</li>
                                <li><strong>Diphenhydramine:</strong> 50 mg IV</li>
                                <li><strong>Famotidine:</strong> 20 mg IV (H2 blocker)</li>
                                <li><strong>If worsening: Epinephrine</strong> 0.3 mg IM (anterolateral thigh) or nebulized 3-5 mL of 1:1000</li>
                                <li><strong>Icatibant</strong> (bradykinin B2 antagonist)</li>
                                <li><strong>Berinert:</strong> 20 IU/kg IV (C1 esterase inhibitor)</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        <div id="isch-antiplatelet" className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-emerald-800 mb-3">Antiplatelet Loading Protocol</h3>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-emerald-700 mb-2">Minor Stroke / High-Risk TIA</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>DAPT x 21 days:</strong></li>
                                <li>• ASA 325 mg load → 81 mg daily</li>
                                <li>• Clopidogrel 300 mg load → 75 mg daily</li>
                                <li>• Start within 24h (NIHSS ≤3 or ABCD2 ≥4)</li>
                                <li>• Then single antiplatelet after 21 days</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-emerald-700 mb-2">NIHSS 4-5 or 24-72h Window</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>DAPT is reasonable:</strong></li>
                                <li>• Start within 24-72h if NIHSS 4-5 or delayed presentation</li>
                                <li>• DAPT x 21 days → then single antiplatelet</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-emerald-700 mb-2">Moderate-Severe Stroke (no lysis)</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>Single antiplatelet:</strong></li>
                                <li>• ASA 325 mg load within 24-48h of onset, then 81 mg daily</li>
                                <li>• If post-TNK: delay ASA 24 hours</li>
                                <li>• Avoid IV aspirin within 90 minutes of IVT start</li>
                                <li>• If AF: transition to DOAC per CATALYST timing</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        <div id="isch-statin" className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-indigo-800 mb-3">Statin Initiation</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-indigo-700 mb-2">High-Intensity Statin (LDL &lt;70)</h4>
                              <ul className="text-sm space-y-1">
                                <li>• <strong>Atorvastatin 80 mg</strong> daily (preferred)</li>
                                <li>• <strong>Rosuvastatin 20-40 mg</strong> daily</li>
                                <li>• Start during hospitalization</li>
                                <li>• Add ezetimibe 10 mg if LDL not at goal</li>
                                <li>• Consider PCSK9i if still above target</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-amber-700 mb-2">Special Considerations</h4>
                              <ul className="text-sm space-y-1">
                                <li>• sICAS (70-99%): high-intensity statin + LDL &lt;70</li>
                                <li>• Lobar ICH: caution — SATURN trial pending</li>
                                <li>• Check LFTs at baseline, recheck 4-12 weeks</li>
                                <li>• Do not discontinue statin for mild transaminase elevation (&lt;3x ULN)</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        <div id="isch-largecore" className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-blue-800 mb-3">Large Core EVT Selection</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-blue-700 mb-2">Early Window (0-6h)</h4>
                              <ul className="text-sm space-y-1">
                                <li>• ASPECTS 3-5: EVT recommended</li>
                                <li>• ASPECTS 0-2: EVT reasonable in select patients without mass effect (age &lt;80)</li>
                                <li>• ICA/M1 occlusion; pre-stroke mRS 0-1; age 18-80; NIHSS ≥6</li>
                                <li>• Higher sICH risk; discuss goals of care</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-blue-700 mb-2">Late Window (6-24h)</h4>
                              <ul className="text-sm space-y-1">
                                <li>• ASPECTS 3-5: EVT recommended</li>
                                <li>• ASPECTS 0-2: Benefit uncertain</li>
                                <li>• CTP core 50-100 mL supports EVT</li>
                                <li>• Eligibility is not limited to strict DAWN/DEFUSE mismatch criteria</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        <div id="isch-postevt" className="bg-violet-50 border border-violet-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-violet-800 mb-3">Post-EVT Management</h3>
                          <div className="bg-white p-3 rounded border">
                            <h4 className="font-semibold text-violet-700 mb-2">Post-Procedure Care</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Groin check q15 min x 4, q30 min x 4, then q1h</li>
                              <li>• Bed rest per protocol (typically 2-6h)</li>
                              <li>• Follow-up imaging: CT/CTA at 24h or if neuro change</li>
                              <li>• Antiplatelet: ASA 325 mg load within 24h if no hemorrhagic conversion, then 81 mg daily</li>
                              <li>• Neuro checks q1h x 24h minimum</li>
                            </ul>
                            <p className="text-xs text-slate-500 mt-2">Use the BP Management section and Nursing Flowsheet Generator for targets and monitoring cadence.</p>
                          </div>
                          <details className="mt-3 bg-white border border-red-200 rounded-lg">
                            <summary className="cursor-pointer p-3 text-sm font-semibold text-red-800 hover:bg-red-50 rounded-lg">
                              Groin Complication Recognition
                            </summary>
                            <div className="p-3 pt-0 space-y-2">
                              <div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                                <div className="bg-red-50 p-2 rounded border border-red-100">
                                  <h5 className="font-semibold text-red-800 mb-1">Expanding Hematoma</h5>
                                  <ul className="text-slate-700 space-y-0.5">
                                    <li>- Firm, expanding groin mass</li>
                                    <li>- Pain disproportionate to exam</li>
                                    <li>- Apply direct pressure 20 min</li>
                                    <li>- Call IR if not controlled</li>
                                  </ul>
                                </div>
                                <div className="bg-amber-50 p-2 rounded border border-amber-100">
                                  <h5 className="font-semibold text-amber-800 mb-1">Pseudoaneurysm</h5>
                                  <ul className="text-slate-700 space-y-0.5">
                                    <li>- Pulsatile mass + bruit</li>
                                    <li>- Confirm with duplex US</li>
                                    <li>- Thrombin injection or surgery</li>
                                    <li>- Avoid anticoag until resolved</li>
                                  </ul>
                                </div>
                                <div className="bg-purple-50 p-2 rounded border border-purple-100">
                                  <h5 className="font-semibold text-purple-800 mb-1">Retroperitoneal Bleed</h5>
                                  <ul className="text-slate-700 space-y-0.5">
                                    <li>- Back/flank/abdominal pain</li>
                                    <li>- Unexplained tachycardia/hypotension</li>
                                    <li>- Dropping hemoglobin</li>
                                    <li>- CT abdomen/pelvis with contrast</li>
                                    <li>- STAT call IR + vascular surgery</li>
                                  </ul>
                                </div>
                              </div>
                              <p className="text-xs text-red-700 font-medium">Call interventional radiology STAT if: expanding hematoma despite 20 min pressure, hemodynamic instability, or suspected retroperitoneal bleed.</p>
                            </div>
                          </details>
                        </div>

                        <div id="isch-mevo" className="bg-slate-50 border border-slate-300 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-slate-800 mb-3">Medium Vessel Occlusion (MeVO) EVT</h3>
                          <div className="bg-white p-3 rounded border">
                            <p className="text-sm text-red-700 font-semibold mb-2">EVT for isolated MeVO (M2/M3) is NOT recommended based on current evidence</p>
                            <ul className="text-sm space-y-1">
                              <li>• <strong>ESCAPE-MeVO:</strong> EVT did not improve outcomes vs medical therapy for M2/M3 occlusions</li>
                              <li>• <strong>DISTAL:</strong> No benefit of EVT for distal occlusions</li>
                              <li>• <strong>DISCOUNT:</strong> Negative for M2 thrombectomy</li>
                              <li>• All three trials showed similar functional outcomes with medical management alone</li>
                              <li>• Consider EVT only in trial setting (e.g., STEP-EVT adaptive platform)</li>
                            </ul>
                            <p className="text-xs text-slate-500 mt-2 italic">Note: LVO (ICA-T, M1, basilar) EVT remains recommended. This applies only to isolated medium/distal vessel occlusions.</p>
                          </div>
                        </div>

                        <div id="isch-contrast" className="bg-teal-50 border border-teal-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-teal-800 mb-3">Contrast Allergy + Suspected LVO Protocol</h3>
                          <div className="bg-white p-3 rounded border mb-3">
                            <p className="text-sm font-semibold text-teal-700 mb-2">Eligibility:</p>
                            <ul className="text-sm space-y-1">
                              <li>• CT contrast allergy (mild/moderate/unknown severity) AND suspected LVO</li>
                              <li>• <strong>Excludes:</strong> known contrast-related anaphylaxis</li>
                            </ul>
                          </div>
                          <div className="bg-white p-3 rounded border mb-3">
                            <p className="text-sm font-semibold text-teal-700 mb-2">Requirements:</p>
                            <ul className="text-sm space-y-1">
                              <li>• Consent from patient or LNOK</li>
                              <li>• Pre-administration approval from <strong>Stroke phone</strong>, <strong>Emergency MD</strong>, and <strong>Neuroradiology</strong></li>
                            </ul>
                          </div>
                          <div className="bg-white p-3 rounded border">
                            <p className="text-sm font-semibold text-teal-700 mb-2">Pre-medication:</p>
                            <ul className="text-sm space-y-1">
                              <li>• <button onClick={() => setProtocolModal(protocolDetailMap.HYDROCORT)} className="text-blue-600 underline hover:text-blue-800">Hydrocortisone 200 mg IV</button> <strong>OR</strong> <button onClick={() => setProtocolModal(protocolDetailMap.METHYLPRED)} className="text-blue-600 underline hover:text-blue-800">Methylprednisolone 40 mg IV</button></li>
                              <li>• <strong>PLUS</strong> <button onClick={() => setProtocolModal(protocolDetailMap.DIPHEN)} className="text-blue-600 underline hover:text-blue-800">Diphenhydramine 50 mg IV</button></li>
                            </ul>
                          </div>
                        </div>

                        <div id="isch-icad" className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-orange-800 mb-3">Intracranial Atherosclerotic Disease (ICAD)</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-orange-700 mb-2">Symptomatic ICAD (70-99% stenosis)</h4>
                              <ul className="text-sm space-y-1">
                                <li>• DAPT x 90 days (ASA + clopidogrel)</li>
                                <li>• High-intensity statin (LDL &lt;70)</li>
                                <li>• SBP &lt;140 mmHg</li>
                                <li>• <strong>NO intracranial stenting</strong> (SAMMPRIS, CASSISS: stenting inferior to medical therapy)</li>
                                <li className="text-slate-500 italic text-xs mt-1">Class III (Harm) for stenting — SAMMPRIS, CASSISS</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-orange-700 mb-2">Moderate ICAD (50-69%)</h4>
                              <ul className="text-sm space-y-1">
                                <li>• Single antiplatelet preferred</li>
                                <li>• Aggressive risk factor management</li>
                                <li>• Consider DAPT if recent symptomatic event</li>
                                <li>• Serial vascular imaging (MRA or CTA q6-12mo)</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        <div id="isch-posterior" className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-indigo-800 mb-3">Posterior Circulation Stroke</h3>
                          <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div className="bg-white p-3 rounded border">
                                <h4 className="font-semibold text-red-700 mb-2">Basilar Artery Occlusion (BAO)</h4>
                                <ul className="text-sm space-y-1">
                                  <li><strong>Clinical presentation:</strong> Coma, quadriplegia, locked-in syndrome, bilateral cranial nerve palsies, vertigo, dysarthria, ataxia</li>
                                  <li><strong>EVT evidence (0-24h):</strong></li>
                                  <li className="ml-3">ATTENTION trial: EVT + medical vs medical alone — significant benefit (mRS 0-3: 46% vs 23%)</li>
                                  <li className="ml-3">BAOCHE trial: EVT benefit in 6-24h window with favorable imaging</li>
                                  <li className="ml-3">BASICS trial: Neutral — but underpowered, slow enrollment</li>
                                  <li><strong>Current recommendation:</strong> EVT reasonable for BAO 0-24h with PC-ASPECTS ≥6, NIHSS ≥10 (Class IIa)</li>
                                  <li><strong>IV thrombolysis:</strong> Give TNK if within 4.5h and no contraindications, even if planning EVT (bridging therapy)</li>
                                </ul>
                              </div>
                              <div className="bg-white p-3 rounded border">
                                <h4 className="font-semibold text-indigo-700 mb-2">PC-ASPECTS Scoring</h4>
                                <ul className="text-sm space-y-1">
                                  <li><strong>10 points</strong> (normal), subtract points for each affected region:</li>
                                  <li className="ml-3">Left/Right thalamus (1 each)</li>
                                  <li className="ml-3">Left/Right cerebellum (1 each)</li>
                                  <li className="ml-3">Left/Right PCA territory (1 each)</li>
                                  <li className="ml-3">Midbrain (2)</li>
                                  <li className="ml-3">Pons (2)</li>
                                  <li><strong>PC-ASPECTS ≥8:</strong> Good EVT candidate</li>
                                  <li><strong>PC-ASPECTS 6-7:</strong> Consider EVT on case-by-case basis</li>
                                  <li><strong>PC-ASPECTS &lt;6:</strong> Poor prognosis, EVT benefit uncertain</li>
                                </ul>
                              </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div className="bg-white p-3 rounded border">
                                <h4 className="font-semibold text-indigo-700 mb-2">Cerebellar Stroke</h4>
                                <ul className="text-sm space-y-1">
                                  <li><strong>Key danger:</strong> Posterior fossa edema → brainstem compression → rapid deterioration</li>
                                  <li><strong>Monitor:</strong> Neuro checks q1h, repeat CT if any decline</li>
                                  <li><strong>Neurosurgery consult early</strong> for infarcts &gt;1/3 cerebellar hemisphere</li>
                                  <li><strong>Suboccipital decompressive craniectomy:</strong> Lifesaving if brainstem compression (Class I, LOE C-LD)</li>
                                  <li><strong>EVD:</strong> If obstructive hydrocephalus. Do NOT rely on EVD alone if mass effect present — decompress.</li>
                                  <li className="text-amber-700">Osmotic therapy (mannitol/HTS) is temporizing only — NOT definitive</li>
                                </ul>
                              </div>
                              <div className="bg-white p-3 rounded border">
                                <h4 className="font-semibold text-indigo-700 mb-2">Wallenberg Syndrome (Lateral Medullary)</h4>
                                <ul className="text-sm space-y-1">
                                  <li><strong>Vessel:</strong> PICA or vertebral artery</li>
                                  <li><strong>Classic findings:</strong></li>
                                  <li className="ml-3">Ipsilateral: facial pain/numbness, Horner syndrome, cerebellar ataxia, vocal cord paralysis</li>
                                  <li className="ml-3">Contralateral: body pain/temperature loss</li>
                                  <li><strong>Dysphagia:</strong> Major concern — aspiration risk is HIGH. Early SLP eval essential.</li>
                                  <li><strong>Prognosis:</strong> Generally good for motor recovery. Dysphagia and neuropathic pain may be prolonged.</li>
                                  <li><strong>Workup:</strong> MRI DWI (CT often negative), CTA/MRA vertebral arteries, evaluate for vertebral dissection</li>
                                </ul>
                              </div>
                            </div>
                            {/* Cannot-Miss Posterior Circulation Patterns */}
                            <div className="bg-red-50 border border-red-200 rounded-lg p-3 mt-4">
                              <h4 className="font-semibold text-red-800 mb-2">Cannot-Miss Posterior Circulation Patterns</h4>
                              <p className="text-xs text-slate-600 mb-2">High-yield pattern recognition for ED triage. If any pattern is present, obtain emergent CTA head/neck and consult stroke neurology.</p>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <ul className="text-sm space-y-1.5">
                                  <li><strong className="text-red-700">Acute vertigo + ANY neuro sign</strong> = posterior fossa until proven otherwise (PICA, AICA, or vertebral occlusion)</li>
                                  <li><strong className="text-red-700">Bilateral motor/sensory symptoms</strong> = basilar artery occlusion until proven otherwise</li>
                                  <li><strong className="text-red-700">Horner + ipsilateral facial numbness</strong> = vertebral/PICA (Wallenberg) — CT often negative, MRI DWI required</li>
                                  <li><strong className="text-red-700">Acute dysarthria + ataxia</strong> without cortical signs = lateral pontine or cerebellar stroke</li>
                                </ul>
                                <ul className="text-sm space-y-1.5">
                                  <li><strong className="text-red-700">Sudden bilateral vision loss ± confusion</strong> = top-of-basilar (bilateral PCA + thalamic + midbrain) — may present as "AMS" or "confusion" without obvious motor deficits</li>
                                  <li><strong className="text-red-700">Acute vertigo + hearing loss</strong> = AICA syndrome (not just labyrinthitis). Check: ipsilateral facial weakness, cerebellar ataxia, Horner</li>
                                  <li><strong className="text-red-700">Acute nausea/vomiting only</strong> = can be sole presentation of medullary or cerebellar stroke. Apply HINTS if vestibular component</li>
                                  <li><strong className="text-red-700">Fluctuating/waxing-waning deficits</strong> = basilar artery stenosis with flow-dependent ischemia — high risk of complete occlusion</li>
                                </ul>
                              </div>
                              <p className="text-xs text-slate-500 mt-2 italic">NIHSS underscores posterior circulation strokes. A "low NIHSS" does NOT exclude significant posterior fossa pathology.</p>
                            </div>
                          </div>
                        </div>

                        <div id="isch-cad" className="bg-pink-50 border border-pink-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-pink-800 mb-3">Cervical Artery Dissection (CAD)</h3>
                          <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div className="bg-white p-3 rounded border">
                                <h4 className="font-semibold text-pink-700 mb-2">Diagnosis</h4>
                                <ul className="text-sm space-y-1">
                                  <li><strong>Classic triad (carotid):</strong> ipsilateral neck pain/headache, partial Horner syndrome, cerebral ischemia</li>
                                  <li><strong>Vertebral:</strong> occipital/posterior neck pain, lateral medullary or cerebellar infarct</li>
                                  <li><strong>Imaging:</strong></li>
                                  <li className="ml-3">CTA neck: intimal flap, vessel irregularity, string sign, occlusion</li>
                                  <li className="ml-3">MRI/MRA neck with fat-sat: intramural hematoma (crescent sign)</li>
                                  <li className="ml-3">Conventional angiography: gold standard (rarely needed)</li>
                                  <li><strong>Risk factors:</strong> Recent trauma/chiropractic manipulation, connective tissue disorders (FMD, Ehlers-Danlos IV, Marfan), recent infection</li>
                                </ul>
                              </div>
                              <div className="bg-white p-3 rounded border">
                                <h4 className="font-semibold text-pink-700 mb-2">Antithrombotic Management</h4>
                                <ul className="text-sm space-y-1">
                                  <li><strong>CADISS trial:</strong> Antiplatelet vs anticoagulation — NO significant difference in stroke recurrence or death</li>
                                  <li><strong>Either approach acceptable</strong> (Class IIa, LOE B-R)</li>
                                  <li><strong>Antiplatelet preferred if:</strong></li>
                                  <li className="ml-3">Large completed infarct (hemorrhagic transformation risk)</li>
                                  <li className="ml-3">Intracranial extension of dissection</li>
                                  <li className="ml-3">Pseudoaneurysm (debatable)</li>
                                  <li><strong>Anticoagulation preferred if:</strong></li>
                                  <li className="ml-3">Free-floating thrombus</li>
                                  <li className="ml-3">Recurrent ischemic events on antiplatelet therapy</li>
                                  <li className="ml-3">High-grade stenosis with hemodynamic compromise</li>
                                  <li><strong>Duration:</strong> 3-6 months, then reassess with follow-up imaging</li>
                                </ul>
                              </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div className="bg-white p-3 rounded border">
                                <h4 className="font-semibold text-pink-700 mb-2">Follow-Up Imaging</h4>
                                <ul className="text-sm space-y-1">
                                  <li>• CTA or MRA neck at 3-6 months to assess healing</li>
                                  <li>• Most dissections heal within 3-6 months</li>
                                  <li>• If recanalized → can consider stopping anticoagulation/simplifying antiplatelet</li>
                                  <li>• If persistent stenosis/occlusion → continue antithrombotic, repeat imaging at 12 months</li>
                                  <li>• Pseudoaneurysm: low risk of thromboembolic events; usually managed conservatively</li>
                                </ul>
                              </div>
                              <div className="bg-white p-3 rounded border">
                                <h4 className="font-semibold text-pink-700 mb-2">Special Populations</h4>
                                <ul className="text-sm space-y-1">
                                  <li><strong>Fibromuscular dysplasia (FMD):</strong> Screen all cervical/cerebral vessels (multivessel disease common). Screen renal arteries.</li>
                                  <li><strong>Connective tissue disorders:</strong> Genetic testing if recurrent dissection, family history, or phenotypic features. Vascular EDS (type IV) = high mortality risk.</li>
                                  <li><strong>Young stroke (&lt;50):</strong> Dissection accounts for ~15-25% of ischemic strokes. Always consider in the workup.</li>
                                  <li><strong>Thrombolysis:</strong> TNK is NOT contraindicated in suspected dissection if within treatment window. Treat the stroke first.</li>
                                </ul>
                              </div>
                            </div>
                            <div className="bg-red-50 border border-red-200 rounded-lg p-3 mt-3">
                              <h4 className="font-semibold text-red-800 text-sm mb-2">Intracranial vs Extracranial Vertebral Artery Dissection</h4>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div className="text-xs space-y-1">
                                  <p className="font-semibold text-slate-700">Extracranial VA dissection:</p>
                                  <ul className="space-y-0.5">
                                    <li>• Most common at V3 segment (atlas loop)</li>
                                    <li>• Usually causes ischemia (embolism to posterior circulation)</li>
                                    <li>• Antiplatelet or anticoagulation per CADISS (either acceptable)</li>
                                    <li>• SAH risk is very low</li>
                                    <li>• Good prognosis; most heal within 3-6 months</li>
                                  </ul>
                                </div>
                                <div className="text-xs space-y-1">
                                  <p className="font-semibold text-red-700">Intracranial VA dissection:</p>
                                  <ul className="space-y-0.5">
                                    <li>• <strong className="text-red-700">Risk of SAH</strong> (intradural = no adventitial protection)</li>
                                    <li>• If SAH present: anticoagulation is CONTRAINDICATED</li>
                                    <li>• Urgent neurosurgical/neurointerventional consultation</li>
                                    <li>• May extend into basilar artery → catastrophic occlusion risk</li>
                                    <li>• Consider flow diverter or parent vessel sacrifice if recurrent SAH</li>
                                  </ul>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div id="isch-seizure" className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                          <h3 className="text-lg font-semibold text-yellow-800 mb-3">Seizure Prophylaxis in Ischemic Stroke</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-yellow-700 mb-2">AHA/ASA Recommendations</h4>
                              <ul className="text-sm space-y-1">
                                <li>• Routine prophylactic AEDs are <strong>NOT recommended</strong> (Class III: No Benefit, LOE A)</li>
                                <li>• Treat acute symptomatic seizures with standard AEDs</li>
                                <li>• Post-stroke epilepsy risk: ~5-10% in ischemic stroke</li>
                                <li>• Higher risk with cortical involvement, hemorrhagic transformation, severe stroke</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-yellow-700 mb-2">When to Treat</h4>
                              <ul className="text-sm space-y-1">
                                <li>• Witnessed clinical seizure or confirmed EEG seizure activity</li>
                                <li>• First-line: <strong>Levetiracetam</strong> 1000-1500 mg IV load, then 500-1000 mg BID</li>
                                <li>• Alternative: Lacosamide 200 mg IV load, then 100-200 mg BID</li>
                                <li>• Avoid phenytoin if thrombolytics given (drug interaction, hypotension risk)</li>
                                <li>• Consider cEEG monitoring if persistent altered mental status out of proportion to infarct size</li>
                              </ul>
                            </div>
                          </div>
                        </div>
                          </div>
                        </details>
                      </div>
                    )}
                    {/* End of Ischemic Stroke Management Content */}

                    {/* SAH Management Content */}
                    {managementSubTab === 'sah' && (
                      <div id="mgmt-tabpanel-sah" role="tabpanel" aria-labelledby="mgmt-tab-sah" className="space-y-4">
                        {/* SAH Quick Summary */}
                        <div className="bg-white border-l-4 border-l-purple-600 border border-slate-200 rounded-lg p-4">
                          <h3 className="text-lg font-bold text-purple-900 mb-1">Subarachnoid Hemorrhage Management</h3>
                          <p className="text-sm text-slate-600">2023 AHA/ASA Guidelines for Management of Aneurysmal SAH</p>
                        </div>

                        {/* Acute SAH Protocol */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">1</span>
                            Immediate Actions (First 6 Hours)
                          </h4>
                          <div className="space-y-2">
                            {[
                              { step: 'Secure airway', detail: 'Intubate if GCS ≤8; elevate HOB 30°', urgent: true },
                              { step: 'BP control: SBP <160 mmHg', detail: 'Nicardipine 5-15 mg/h IV or labetalol IV (pre-aneurysm securing)', urgent: true },
                              { step: 'Start Nimodipine 60 mg PO/NG q4h', detail: 'Begin within 96h of onset; continue 21 days. Class I, LOE A for DCI prevention', urgent: true },
                              { step: 'Neurosurgery/Neurointerventional consult', detail: 'For aneurysm securing strategy (clip vs coil) — target within 24h', urgent: true },
                              { step: 'Analgesia for headache', detail: 'Acetaminophen 1g IV/PO q6h. Avoid NSAIDs. Cautious opioids if severe', urgent: false },
                              { step: 'Seizure prophylaxis (if indicated)', detail: 'Short-term (3-7d) levetiracetam 500-1000mg BID. Not routine for all patients', urgent: false },
                              { step: 'EVD placement', detail: 'If acute hydrocephalus or GCS ≤8 with IVH. Open at 15-20 cmH₂O', urgent: false },
                              { step: 'Labs: CBC, BMP, Coags, Type & Screen, Troponin, Mg²⁺', detail: 'Repeat BMP q6h initially for Na⁺ monitoring', urgent: false }
                            ].map((item, i) => (
                              <div key={i} className={`flex items-start gap-3 p-2 rounded ${item.urgent ? 'bg-purple-50' : 'bg-slate-50'}`}>
                                <span className={`mt-0.5 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold ${item.urgent ? 'bg-purple-600 text-white' : 'bg-slate-300 text-slate-700'}`}>{i + 1}</span>
                                <div>
                                  <span className="text-sm font-semibold text-slate-800">{item.step}</span>
                                  <span className="block text-xs text-slate-500">{item.detail}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Fisher Grade & Vasospasm Risk */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">2</span>
                            Fisher Grade — Vasospasm Risk Prediction
                          </h4>
                          <div className="space-y-2">
                            {[
                              { grade: '1', ct: 'No blood detected', risk: '~0%', active: 'bg-emerald-600 text-white border-emerald-600', badge: 'text-emerald-700 bg-emerald-50' },
                              { grade: '2', ct: 'Diffuse thin SAH (<1 mm thick)', risk: '~20%', active: 'bg-amber-600 text-white border-amber-600', badge: 'text-amber-700 bg-amber-50' },
                              { grade: '3', ct: 'Localized clot or thick layer (>1 mm)', risk: '~33%', active: 'bg-red-600 text-white border-red-600', badge: 'text-red-700 bg-red-50' },
                              { grade: '4', ct: 'Intraventricular or intracerebral blood ± diffuse SAH', risk: '~25%', active: 'bg-orange-600 text-white border-orange-600', badge: 'text-orange-700 bg-orange-50' }
                            ].map(f => {
                              const isSelected = telestrokeNote.fisherGrade === f.grade;
                              return (
                              <button key={f.grade} type="button"
                                className={`w-full text-left p-3 rounded-lg border transition-colors ${isSelected ? f.active : 'bg-white border-slate-200 hover:bg-slate-50'}`}
                                onClick={() => setTelestrokeNote(prev => ({...prev, fisherGrade: f.grade}))}
                              >
                                <div className="flex justify-between items-center">
                                  <div>
                                    <span className="font-semibold">Grade {f.grade}</span>
                                    <span className={`block text-sm ${isSelected ? 'opacity-80' : 'text-slate-600'}`}>{f.ct}</span>
                                  </div>
                                  <span className={`text-sm font-bold px-2 py-0.5 rounded ${isSelected ? 'bg-white/20' : f.badge}`}>
                                    Spasm risk: {f.risk}
                                  </span>
                                </div>
                              </button>
                              );
                            })}
                          </div>
                          {telestrokeNote.fisherGrade === '3' && (
                            <div className="mt-3 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-800">
                              <strong>Highest vasospasm risk.</strong> Initiate daily TCD monitoring days 3-14. Consider CTP if clinical decline.
                            </div>
                          )}
                        </div>

                        {/* Modified Fisher Scale */}
                        <details className="bg-white border border-slate-200 rounded-lg">
                          <summary className="cursor-pointer p-4 font-bold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">+</span>
                            Modified Fisher Scale (Better Vasospasm Prediction)
                          </summary>
                          <div className="px-4 pb-4">
                            <p className="text-xs text-slate-600 mb-2">Frontera et al., 2006. More predictive of symptomatic vasospasm than original Fisher grade.</p>
                            <div className="space-y-1.5">
                              {[
                                { grade: '0', ct: 'No SAH or IVH', risk: 'Minimal' },
                                { grade: '1', ct: 'Thin SAH, no IVH', risk: '24%' },
                                { grade: '2', ct: 'Thin SAH with IVH', risk: '33%' },
                                { grade: '3', ct: 'Thick SAH, no IVH', risk: '33%' },
                                { grade: '4', ct: 'Thick SAH with IVH', risk: '40%' }
                              ].map(f => (
                                <div key={f.grade} className="flex justify-between items-center p-2 rounded bg-slate-50 text-sm">
                                  <div><span className="font-mono font-bold mr-2">mF {f.grade}</span><span className="text-slate-600">{f.ct}</span></div>
                                  <span className="text-xs font-semibold text-purple-700">Spasm: {f.risk}</span>
                                </div>
                              ))}
                            </div>
                            <p className="text-xs text-slate-500 mt-2">Thick = &gt;1mm layer. IVH = intraventricular hemorrhage present bilaterally.</p>
                          </div>
                        </details>

                        {/* Vasospasm Monitoring & DCI */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">3</span>
                            Vasospasm Monitoring & DCI Management
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-purple-50 rounded-lg p-3">
                              <h5 className="font-semibold text-purple-800 text-sm mb-2">Monitoring Protocol</h5>
                              <ul className="space-y-1.5 text-sm text-slate-700">
                                <li className="flex items-start gap-2"><span className="text-purple-600 font-bold">&#x2022;</span> Daily TCD: Days 3-14 (peak vasospasm window)</li>
                                <li className="flex items-start gap-2"><span className="text-purple-600 font-bold">&#x2022;</span> MCA velocity &gt;120 cm/s = mild spasm</li>
                                <li className="flex items-start gap-2"><span className="text-purple-600 font-bold">&#x2022;</span> MCA velocity &gt;200 cm/s or Lindegaard ratio &gt;6 = severe</li>
                                <li className="flex items-start gap-2"><span className="text-purple-600 font-bold">&#x2022;</span> Neuro checks q1h for first 14 days</li>
                                <li className="flex items-start gap-2"><span className="text-purple-600 font-bold">&#x2022;</span> CTP if new deficit or rising TCD velocities</li>
                              </ul>
                            </div>
                            <div className="bg-red-50 rounded-lg p-3">
                              <h5 className="font-semibold text-red-800 text-sm mb-2">DCI Treatment Escalation</h5>
                              <div className="space-y-2 text-sm text-slate-700">
                                <div className="flex items-start gap-2">
                                  <span className="bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shrink-0">1</span>
                                  <span><strong>Euvolemia + induced hypertension:</strong> Phenylephrine or norepinephrine to raise MAP 20-25% above baseline</span>
                                </div>
                                <div className="flex items-start gap-2">
                                  <span className="bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shrink-0">2</span>
                                  <span><strong>No improvement:</strong> Endovascular rescue — intra-arterial verapamil/nicardipine</span>
                                </div>
                                <div className="flex items-start gap-2">
                                  <span className="bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shrink-0">3</span>
                                  <span><strong>Refractory:</strong> Balloon angioplasty for proximal vasospasm</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Electrolyte Management */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">4</span>
                            Electrolyte Monitoring — CSW vs SIADH
                          </h4>
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm border-collapse">
                              <thead>
                                <tr className="bg-slate-100">
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left font-semibold">Feature</th>
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left font-semibold text-amber-700">Cerebral Salt Wasting</th>
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left font-semibold text-blue-700">SIADH</th>
                                </tr>
                              </thead>
                              <tbody>
                                {[
                                  ['Volume status', 'Hypovolemic (dehydrated)', 'Euvolemic / mildly hypervolemic'],
                                  ['Urine output', 'High (polyuria)', 'Low / normal'],
                                  ['Serum Na⁺', 'Low (<135)', 'Low (<135)'],
                                  ['Urine Na⁺', 'High (>40 mEq/L)', 'High (>40 mEq/L)'],
                                  ['Urine osmolality', 'High', 'Inappropriately high'],
                                  ['CVP / volume markers', 'Low (hemoconcentration)', 'Normal / elevated'],
                                  ['Treatment', 'NS or hypertonic saline + fludrocortisone 0.1-0.2 mg BID', 'Fluid restriction ± salt tabs ± conivaptan/tolvaptan'],
                                  ['Key differentiator', 'Volume depletion + high urine output', 'Euvolemia + concentrated urine']
                                ].map((row, i) => (
                                  <tr key={i} className={i % 2 === 0 ? '' : 'bg-slate-50'}>
                                    <td className="border border-slate-200 px-3 py-1.5 font-medium">{row[0]}</td>
                                    <td className="border border-slate-200 px-3 py-1.5">{row[1]}</td>
                                    <td className="border border-slate-200 px-3 py-1.5">{row[2]}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                          <p className="text-xs text-slate-500 mt-2">Monitor Na⁺ q4-6h. Correct hyponatremia slowly (max 8-10 mEq/L per 24h). CSW is more common in SAH than SIADH.</p>
                        </div>

                        {/* Rebleeding Risk */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">5</span>
                            Rebleeding Risk & Aneurysm Securing
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-red-50 rounded-lg p-3">
                              <h5 className="font-semibold text-red-800 text-sm mb-2">Rebleeding Risk Timeline</h5>
                              <div className="space-y-1 text-sm">
                                <div className="flex justify-between"><span>First 6 hours</span><span className="font-bold text-red-700">~15% (peak risk)</span></div>
                                <div className="w-full bg-red-200 rounded-full h-3"><div className="bg-red-600 h-3 rounded-full" style={{width: '100%'}}></div></div>
                                <div className="flex justify-between mt-2"><span>6-24 hours</span><span className="font-bold text-orange-700">~5-10%</span></div>
                                <div className="w-full bg-orange-200 rounded-full h-3"><div className="bg-orange-500 h-3 rounded-full" style={{width: '60%'}}></div></div>
                                <div className="flex justify-between mt-2"><span>Day 2-14</span><span className="font-bold text-amber-700">~1-2%/day</span></div>
                                <div className="w-full bg-amber-200 rounded-full h-3"><div className="bg-amber-500 h-3 rounded-full" style={{width: '25%'}}></div></div>
                                <div className="flex justify-between mt-2"><span>After 14 days</span><span className="font-bold text-emerald-700">~0.5%/day declining</span></div>
                                <div className="w-full bg-emerald-200 rounded-full h-3"><div className="bg-emerald-500 h-3 rounded-full" style={{width: '10%'}}></div></div>
                              </div>
                            </div>
                            <div className="space-y-3">
                              <div className="bg-purple-50 rounded-lg p-3">
                                <h5 className="font-semibold text-purple-800 text-sm mb-2">Securing Strategy</h5>
                                <ul className="space-y-1 text-sm text-slate-700">
                                  <li><strong>Coiling (endovascular):</strong> Preferred for posterior circulation, elderly, poor-grade, basilar tip. Class I.</li>
                                  <li><strong>Clipping (surgical):</strong> Consider for MCA, large/wide-necked aneurysms, concurrent hematoma needing evacuation.</li>
                                  <li><strong>Timeline:</strong> Secure within 24h of presentation (Class I, LOE B-NR).</li>
                                </ul>
                              </div>
                              <div className="bg-amber-50 rounded-lg p-3">
                                <h5 className="font-semibold text-amber-800 text-sm mb-2">Risk Factors for Rebleeding</h5>
                                <ul className="space-y-1 text-sm text-slate-700">
                                  <li>&#x2022; Unsecured aneurysm (most important)</li>
                                  <li>&#x2022; Poor clinical grade (H&H 4-5)</li>
                                  <li>&#x2022; Systolic BP &gt;160 mmHg</li>
                                  <li>&#x2022; Large aneurysm size (&gt;10 mm)</li>
                                  <li>&#x2022; Posterior circulation location</li>
                                </ul>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Post-Securing BP Targets */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-purple-600 text-white text-xs flex items-center justify-center font-bold">6</span>
                            BP Targets by Phase
                          </h4>
                          <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            {[
                              { phase: 'Pre-Securing', target: 'SBP <160', detail: 'Until aneurysm clipped/coiled', bg: 'bg-red-50 border-red-200', text: 'text-red-700' },
                              { phase: 'Post-Securing', target: 'SBP <180', detail: 'First 24-72h after securing', bg: 'bg-amber-50 border-amber-200', text: 'text-amber-700' },
                              { phase: 'DCI Treatment', target: 'Induced HTN', detail: 'MAP +20-25% above baseline', bg: 'bg-purple-50 border-purple-200', text: 'text-purple-700' }
                            ].map(bp => (
                              <div key={bp.phase} className={`${bp.bg} border rounded-lg p-3 text-center`}>
                                <div className="text-xs text-slate-600 mb-1">{bp.phase}</div>
                                <div className={`text-xl font-bold ${bp.text}`}>{bp.target}</div>
                                <div className="text-xs text-slate-500 mt-1">{bp.detail}</div>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* SAH Supportive Care Bundle */}
                        <details className="bg-white border border-slate-200 rounded-lg">
                          <summary className="cursor-pointer p-4 font-bold text-slate-800 hover:bg-slate-50 rounded-lg">
                            SAH ICU Supportive Care Bundle
                          </summary>
                          <div className="px-4 pb-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {[
                                { cat: 'Cardiac', items: ['Troponin + ECG on admission (SAH can cause stress cardiomyopathy)', 'Continuous telemetry', 'Echo if troponin elevated or hemodynamic instability'] },
                                { cat: 'DVT Prevention', items: ['SCDs immediately', 'UFH 5000u SC q8-12h after aneurysm secured', 'LMWH if no EVD and aneurysm secured'] },
                                { cat: 'Glycemic Control', items: ['Target glucose 140-180 mg/dL', 'Insulin drip if persistent hyperglycemia', 'Avoid hypoglycemia (<70 mg/dL)'] },
                                { cat: 'Fever Management', items: ['Target normothermia (<38°C)', 'Acetaminophen 1g q6h scheduled', 'Cooling device if refractory', 'Workup: blood/urine cultures, CXR'] },
                                { cat: 'Nutrition', items: ['NPO until swallow evaluation', 'Dobhoff if intubated >48h or failed swallow', 'Early enteral nutrition preferred'] },
                                { cat: 'Positioning', items: ['HOB 30°', 'Quiet, low-stimulation environment', 'Stool softeners (avoid Valsalva)', 'Activity restrictions until aneurysm secured'] }
                              ].map(section => (
                                <div key={section.cat} className="bg-slate-50 rounded-lg p-3">
                                  <h5 className="font-semibold text-slate-800 text-sm mb-1">{section.cat}</h5>
                                  <ul className="space-y-0.5">
                                    {section.items.map((item, i) => (
                                      <li key={i} className="text-xs text-slate-600 flex items-start gap-1">
                                        <span className="text-purple-400 mt-0.5">&#x2022;</span> {item}
                                      </li>
                                    ))}
                                  </ul>
                                </div>
                              ))}
                            </div>
                          </div>
                        </details>
                      </div>
                    )}
                    {/* End of SAH Management Content */}

                    {/* TIA Management Content */}
                    {managementSubTab === 'tia' && (
                      <div id="mgmt-tabpanel-tia" role="tabpanel" aria-labelledby="mgmt-tab-tia" className="space-y-4">
                        {/* TIA Header */}
                        <div className="bg-white border-l-4 border-l-orange-500 border border-slate-200 rounded-lg p-4">
                          <h3 className="text-lg font-bold text-orange-900 mb-1">TIA Management & Secondary Prevention</h3>
                          <p className="text-sm text-slate-600">Urgent evaluation and risk reduction for transient ischemic attack</p>
                        </div>

                        {/* Admit All TIAs */}
                        <div className="bg-orange-50 border border-orange-300 rounded-lg p-3">
                          <p className="text-sm text-orange-900 font-semibold">Admit ALL TIAs for urgent inpatient workup (Class I, LOE B-NR). Do not use ABCD2 score alone for disposition decisions.</p>
                        </div>

                        {/* ABCD2 Risk Stratification */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-orange-500 text-white text-xs flex items-center justify-center font-bold">1</span>
                            Risk Stratification (ABCD2)
                          </h4>
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm border-collapse">
                              <thead>
                                <tr className="bg-slate-100">
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left">Score</th>
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left">Risk Level</th>
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left">2-Day Stroke Risk</th>
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left">7-Day</th>
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left">90-Day</th>
                                  <th scope="col" className="border border-slate-200 px-3 py-2 text-left">Action</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr className="bg-emerald-50">
                                  <td className="border border-slate-200 px-3 py-1.5 font-mono font-bold">0-3</td>
                                  <td className="border border-slate-200 px-3 py-1.5"><span className="text-emerald-700 font-semibold">Low</span></td>
                                  <td className="border border-slate-200 px-3 py-1.5">1.0%</td>
                                  <td className="border border-slate-200 px-3 py-1.5">1.2%</td>
                                  <td className="border border-slate-200 px-3 py-1.5">3.1%</td>
                                  <td className="border border-slate-200 px-3 py-1.5 text-xs">Admit, urgent workup within 24h</td>
                                </tr>
                                <tr className="bg-amber-50">
                                  <td className="border border-slate-200 px-3 py-1.5 font-mono font-bold">4-5</td>
                                  <td className="border border-slate-200 px-3 py-1.5"><span className="text-amber-700 font-semibold">Moderate</span></td>
                                  <td className="border border-slate-200 px-3 py-1.5">4.1%</td>
                                  <td className="border border-slate-200 px-3 py-1.5">5.9%</td>
                                  <td className="border border-slate-200 px-3 py-1.5">9.8%</td>
                                  <td className="border border-slate-200 px-3 py-1.5 text-xs">Admit, expedited workup + DAPT</td>
                                </tr>
                                <tr className="bg-red-50">
                                  <td className="border border-slate-200 px-3 py-1.5 font-mono font-bold">6-7</td>
                                  <td className="border border-slate-200 px-3 py-1.5"><span className="text-red-700 font-semibold">High</span></td>
                                  <td className="border border-slate-200 px-3 py-1.5">8.1%</td>
                                  <td className="border border-slate-200 px-3 py-1.5">11.7%</td>
                                  <td className="border border-slate-200 px-3 py-1.5">17.8%</td>
                                  <td className="border border-slate-200 px-3 py-1.5 text-xs">Admit, STAT workup + DAPT + vascular imaging</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                          <p className="text-xs text-slate-500 mt-2">ABCD2 is informational only — all TIA patients should be admitted regardless of score.</p>
                        </div>

                        {/* Urgent Imaging Protocol */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-orange-500 text-white text-xs flex items-center justify-center font-bold">2</span>
                            Urgent Imaging Protocol
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-blue-50 rounded-lg p-3">
                              <h5 className="font-semibold text-blue-800 text-sm mb-2">Brain Imaging</h5>
                              <ul className="space-y-1.5 text-sm text-slate-700">
                                <li className="flex items-start gap-2"><span className="text-blue-600 font-bold">1.</span> <strong>MRI DWI</strong> (preferred) — 80% sensitivity for acute ischemia. Obtain within 24h.</li>
                                <li className="flex items-start gap-2"><span className="text-blue-600 font-bold">2.</span> <strong>CT Head</strong> — if MRI unavailable. Low sensitivity for TIA but rules out hemorrhage.</li>
                                <li className="flex items-start gap-2"><span className="text-blue-600 font-bold">3.</span> <strong>DWI-positive TIA</strong> = higher stroke risk. Consider as minor stroke.</li>
                              </ul>
                            </div>
                            <div className="bg-amber-50 rounded-lg p-3">
                              <h5 className="font-semibold text-amber-800 text-sm mb-2">Vascular Imaging</h5>
                              <ul className="space-y-1.5 text-sm text-slate-700">
                                <li className="flex items-start gap-2"><span className="text-amber-600 font-bold">1.</span> <strong>CTA Head & Neck</strong> (preferred) or MRA — Obtain STAT</li>
                                <li className="flex items-start gap-2"><span className="text-amber-600 font-bold">2.</span> <strong>Carotid duplex</strong> — if anterior circulation TIA + CTA not done</li>
                                <li className="flex items-start gap-2"><span className="text-amber-600 font-bold">3.</span> <strong>Intracranial vessel imaging</strong> — CTA or MRA for ICAD evaluation</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        {/* DAPT Initiation */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-orange-500 text-white text-xs flex items-center justify-center font-bold">3</span>
                            Antiplatelet Therapy — DAPT Protocol
                          </h4>
                          <div className="space-y-3">
                            <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                              <h5 className="font-semibold text-emerald-800 text-sm mb-2">High-Risk TIA or Minor Stroke (NIHSS ≤3) — CHANCE/POINT Protocol</h5>
                              <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                <div className="bg-white rounded p-2 border border-emerald-100">
                                  <div className="font-semibold text-slate-800">Day 1 (Loading)</div>
                                  <div className="text-slate-600">ASA 325 mg + Clopidogrel 300 mg</div>
                                </div>
                                <div className="bg-white rounded p-2 border border-emerald-100">
                                  <div className="font-semibold text-slate-800">Days 2-21</div>
                                  <div className="text-slate-600">ASA 81 mg + Clopidogrel 75 mg daily</div>
                                </div>
                                <div className="bg-white rounded p-2 border border-emerald-100">
                                  <div className="font-semibold text-slate-800">Day 22+</div>
                                  <div className="text-slate-600">Mono antiplatelet (ASA 81 or Clop 75)</div>
                                </div>
                              </div>
                            </div>
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm">
                              <strong className="text-amber-800">CYP2C19 Testing:</strong> Order CYP2C19 genotyping. Poor metabolizers (*2/*2, *2/*3, *3/*3) have reduced clopidogrel efficacy — switch to ticagrelor 90mg BID.
                            </div>
                            <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm text-slate-700">
                              <strong>If AF identified:</strong> Switch from DAPT to anticoagulation (DOAC preferred). Do NOT combine long-term DAPT + anticoagulation.
                            </div>
                          </div>
                        </div>

                        {/* Etiologic Workup */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-orange-500 text-white text-xs flex items-center justify-center font-bold">4</span>
                            Etiologic Workup Checklist
                          </h4>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                            {[
                              { cat: 'Cardiac', items: ['12-Lead ECG', 'Continuous telemetry (≥24h)', 'TTE with bubble study', 'Extended cardiac monitoring (14-30 day) if no AF on telemetry'], bg: 'bg-red-50', heading: 'text-red-800', bullet: 'text-red-400' },
                              { cat: 'Vascular', items: ['CTA Head & Neck (or MRA)', 'Carotid duplex if anterior TIA', 'Vessel wall MRI if ICAD suspected', 'Aortic arch imaging if embolism suspected'], bg: 'bg-blue-50', heading: 'text-blue-800', bullet: 'text-blue-400' },
                              { cat: 'Laboratory', items: ['CBC, BMP, HbA1c', 'Fasting lipid panel', 'TSH', 'ESR/CRP if vasculitis suspected', 'Hypercoagulable panel if age <50 or cryptogenic'], bg: 'bg-emerald-50', heading: 'text-emerald-800', bullet: 'text-emerald-400' }
                            ].map(section => (
                              <div key={section.cat} className={`${section.bg} rounded-lg p-3`}>
                                <h5 className={`font-semibold ${section.heading} text-sm mb-2`}>{section.cat}</h5>
                                <ul className="space-y-1">
                                  {section.items.map((item, i) => (
                                    <li key={i} className="text-xs text-slate-700 flex items-start gap-1">
                                      <span className={`${section.bullet} mt-0.5`}>&#x2022;</span> {item}
                                    </li>
                                  ))}
                                </ul>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Carotid Stenosis Decision Tree */}
                        <div className="bg-white border border-slate-200 rounded-lg p-4">
                          <h4 className="font-bold text-slate-800 mb-3 flex items-center gap-2">
                            <span className="w-6 h-6 rounded-full bg-orange-500 text-white text-xs flex items-center justify-center font-bold">5</span>
                            Carotid Stenosis Management
                          </h4>
                          <div className="space-y-2">
                            {[
                              { stenosis: '70-99% Symptomatic', action: 'CEA within 2 weeks (Class I, LOE A)', detail: 'CAS reasonable alternative if high surgical risk. Best outcomes if revascularization within 14 days.', rowBg: 'bg-red-50 border-red-200', badge: 'text-red-700 bg-red-100' },
                              { stenosis: '50-69% Symptomatic', action: 'Individualize — CEA may be considered', detail: 'Benefit greatest in males, age >75, recent symptoms. Consider patient comorbidities.', rowBg: 'bg-amber-50 border-amber-200', badge: 'text-amber-700 bg-amber-100' },
                              { stenosis: '<50% Symptomatic', action: 'Medical management only', detail: 'DAPT + high-intensity statin + BP control. Revascularization NOT recommended.', rowBg: 'bg-emerald-50 border-emerald-200', badge: 'text-emerald-700 bg-emerald-100' },
                              { stenosis: 'Near-occlusion / string sign', action: 'Medical management preferred', detail: 'Revascularization benefit uncertain. Aggressive medical therapy.', rowBg: 'bg-slate-50 border-slate-200', badge: 'text-slate-700 bg-slate-100' }
                            ].map(row => (
                              <div key={row.stenosis} className={`flex items-start gap-3 p-3 rounded-lg border ${row.rowBg}`}>
                                <div className={`shrink-0 px-2 py-1 rounded text-xs font-bold ${row.badge}`}>{row.stenosis}</div>
                                <div>
                                  <div className="text-sm font-semibold text-slate-800">{row.action}</div>
                                  <div className="text-xs text-slate-600">{row.detail}</div>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>

                        {/* Secondary Prevention */}
                        <details className="bg-white border border-slate-200 rounded-lg">
                          <summary className="cursor-pointer p-4 font-bold text-slate-800 hover:bg-slate-50 rounded-lg">
                            Secondary Prevention — Complete Checklist
                          </summary>
                          <div className="px-4 pb-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {[
                                { cat: 'Antithrombotic', items: ['DAPT x21d then mono antiplatelet (if no AF)', 'DOAC if AF confirmed (apixaban/rivaroxaban preferred)', 'CYP2C19 genotyping for clopidogrel efficacy'] },
                                { cat: 'Lipid Management', items: ['High-intensity statin: Atorvastatin 80mg or Rosuvastatin 20-40mg', 'LDL target <70 mg/dL', 'Add ezetimibe 10mg if not at goal', 'PCSK9i if refractory (evolocumab, alirocumab)'] },
                                { cat: 'Blood Pressure', items: ['Target <130/80 mmHg (Class I)', 'Initiate/optimize after 24-48h post-event', 'Preferred: ACE-I/ARB + thiazide or CCB', 'Home BP monitoring'] },
                                { cat: 'Diabetes & Lifestyle', items: ['HbA1c target <7%', 'GLP-1 RA (semaglutide/liraglutide) — CV benefit', 'Smoking cessation (varenicline/NRT)', 'Mediterranean diet', 'Exercise: 150 min/week moderate intensity'] }
                              ].map(section => (
                                <div key={section.cat} className="bg-slate-50 rounded-lg p-3">
                                  <h5 className="font-semibold text-slate-800 text-sm mb-1">{section.cat}</h5>
                                  <ul className="space-y-0.5">
                                    {section.items.map((item, i) => (
                                      <li key={i} className="text-xs text-slate-600">&#x2022; {item}</li>
                                    ))}
                                  </ul>
                                </div>
                              ))}
                            </div>
                          </div>
                        </details>
                      </div>
                    )}
                    {/* End of TIA Management Content */}

                    {/* CVT Management Content */}
                    {managementSubTab === 'cvt' && (
                      <div id="mgmt-tabpanel-cvt" role="tabpanel" aria-labelledby="mgmt-tab-cvt" className="space-y-4">
                        {/* CVT Header */}
                        <div className="bg-white border-l-4 border-l-indigo-500 border border-slate-200 rounded-lg p-4">
                          <h2 className="text-xl font-bold text-indigo-900 flex items-center gap-2">
                            <i aria-hidden="true" data-lucide="git-branch" className="w-6 h-6"></i>
                            Cerebral Venous Thrombosis (CVT) Management
                          </h2>
                          <p className="text-sm text-slate-600 mt-1">AHA/ASA 2024 Guidelines — CSBP 2024</p>
                        </div>

                        {/* CVT Treatment Checklist */}
                        <div className="bg-white border border-indigo-200 rounded-lg p-4">
                          <h3 className="text-base font-bold text-indigo-800 mb-3 flex items-center gap-2">
                            <i aria-hidden="true" data-lucide="clipboard-check" className="w-5 h-5"></i>
                            Acute Management Checklist
                          </h3>
                          <div className="space-y-2">
                            <label className="flex items-start gap-2 cursor-pointer p-2 rounded-lg hover:bg-indigo-50">
                              <input type="checkbox" checked={!!telestrokeNote.cvtAnticoagStarted}
                                onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtAnticoagStarted: c})); }}
                                className="mt-0.5 rounded border-indigo-300 text-indigo-600" />
                              <div>
                                <span className="text-sm font-medium text-slate-800">Anticoagulation initiated</span>
                                <span className="block text-xs text-slate-500">LMWH or UFH, even with hemorrhagic infarction (Class I, LOE B-NR)</span>
                              </div>
                            </label>
                            {telestrokeNote.cvtAnticoagStarted && (
                              <div className="ml-8 mb-2">
                                <select value={telestrokeNote.cvtAnticoagType || ''}
                                  onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, cvtAnticoagType: v})); }}
                                  className="w-full px-2 py-1.5 border border-slate-300 rounded-lg text-sm">
                                  <option value="">-- Select agent --</option>
                                  <option value="enoxaparin">Enoxaparin 1 mg/kg SC q12h</option>
                                  <option value="ufh">UFH weight-based (aPTT 60-80s)</option>
                                  <option value="other">Other</option>
                                </select>
                              </div>
                            )}
                            <label className="flex items-start gap-2 cursor-pointer p-2 rounded-lg hover:bg-indigo-50">
                              <input type="checkbox" checked={!!telestrokeNote.cvtIcpManaged}
                                onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtIcpManaged: c})); }}
                                className="mt-0.5 rounded border-indigo-300 text-indigo-600" />
                              <div>
                                <span className="text-sm font-medium text-slate-800">ICP assessment/management</span>
                                <span className="block text-xs text-slate-500">HOB 30°, acetazolamide if needed, LP drainage for visual impairment</span>
                              </div>
                            </label>
                            <label className="flex items-start gap-2 cursor-pointer p-2 rounded-lg hover:bg-indigo-50">
                              <input type="checkbox" checked={!!telestrokeNote.cvtSeizureManaged}
                                onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtSeizureManaged: c})); }}
                                className="mt-0.5 rounded border-indigo-300 text-indigo-600" />
                              <div>
                                <span className="text-sm font-medium text-slate-800">Seizure management addressed</span>
                                <span className="block text-xs text-slate-500">Treat acute seizures with levetiracetam; routine prophylaxis NOT recommended (AHA/ASA). EEG if supratentorial lesion with altered consciousness.</span>
                              </div>
                            </label>
                            <label className="flex items-start gap-2 cursor-pointer p-2 rounded-lg hover:bg-indigo-50">
                              <input type="checkbox" checked={!!telestrokeNote.cvtHematologyConsulted}
                                onChange={(e) => { const c = e.target.checked; setTelestrokeNote(prev => ({...prev, cvtHematologyConsulted: c})); }}
                                className="mt-0.5 rounded border-indigo-300 text-indigo-600" />
                              <div>
                                <span className="text-sm font-medium text-slate-800">Hematology consult / thrombophilia workup</span>
                                <span className="block text-xs text-slate-500">Factor V Leiden, prothrombin mutation, protein C/S, APLA</span>
                              </div>
                            </label>
                          </div>
                        </div>

                        {/* CVT Risk Factors */}
                        <div className="bg-white border border-indigo-200 rounded-lg p-4">
                          <h3 className="text-base font-bold text-indigo-800 mb-3">Risk Factor Assessment</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div className="bg-indigo-50 p-3 rounded-lg">
                              <h4 className="font-semibold text-indigo-800 mb-1">Prothrombotic</h4>
                              <ul className="text-xs text-slate-700 space-y-0.5">
                                <li>• Factor V Leiden mutation</li>
                                <li>• Prothrombin G20210A</li>
                                <li>• Protein C/S deficiency</li>
                                <li>• Antithrombin III deficiency</li>
                                <li>• Antiphospholipid syndrome</li>
                                <li>• Hyperhomocysteinemia</li>
                              </ul>
                            </div>
                            <div className="bg-indigo-50 p-3 rounded-lg">
                              <h4 className="font-semibold text-indigo-800 mb-1">Acquired</h4>
                              <ul className="text-xs text-slate-700 space-y-0.5">
                                <li>• OCP / hormonal therapy</li>
                                <li>• Pregnancy / puerperium</li>
                                <li>• Malignancy</li>
                                <li>• Infection (mastoiditis, sinusitis)</li>
                                <li>• IBD / nephrotic syndrome</li>
                                <li>• Dehydration / recent surgery</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        {/* CVT Imaging */}
                        <div className="bg-white border border-indigo-200 rounded-lg p-4">
                          <h3 className="text-base font-bold text-indigo-800 mb-3">Diagnostic Imaging</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div className="bg-white border border-slate-200 p-3 rounded-lg">
                              <h4 className="font-semibold text-slate-800 mb-1">First-line</h4>
                              <ul className="text-xs text-slate-700 space-y-0.5">
                                <li>• <strong>MRI + MRV</strong> (preferred)</li>
                                <li>• CT venography if MRI unavailable</li>
                                <li>• Non-contrast CT: cord sign, dense triangle sign, hemorrhagic venous infarct</li>
                              </ul>
                            </div>
                            <div className="bg-white border border-slate-200 p-3 rounded-lg">
                              <h4 className="font-semibold text-slate-800 mb-1">Follow-up</h4>
                              <ul className="text-xs text-slate-700 space-y-0.5">
                                <li>• Repeat MRV at 3-6 months</li>
                                <li>• Assess for recanalization</li>
                                <li>• Guide duration of anticoagulation</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        {/* Endovascular Therapy */}
                        <div className="bg-white border border-indigo-200 rounded-lg p-4">
                          <h3 className="text-base font-bold text-indigo-800 mb-3">Endovascular Therapy Consideration</h3>
                          <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm">
                            <p className="text-amber-800 font-medium mb-1">Consider EVT if clinical deterioration despite adequate anticoagulation:</p>
                            <ul className="text-xs text-amber-700 space-y-0.5">
                              <li>• Mechanical thrombectomy ± local thrombolysis</li>
                              <li>• Class IIb recommendation (LOE C-LD)</li>
                              <li>• Contact interventional neuroradiology early</li>
                              <li>• Decompressive craniectomy if impending herniation (Class IIa)</li>
                            </ul>
                          </div>
                        </div>

                        {/* Long-term Management */}
                        <div className="bg-white border border-indigo-200 rounded-lg p-4">
                          <h3 className="text-base font-bold text-indigo-800 mb-3">Long-term Anticoagulation</h3>
                          <div className="overflow-x-auto">
                            <table className="w-full text-sm border-collapse">
                              <thead>
                                <tr className="bg-indigo-50">
                                  <th scope="col" className="border border-indigo-200 px-3 py-2 text-left text-indigo-800">Scenario</th>
                                  <th scope="col" className="border border-indigo-200 px-3 py-2 text-left text-indigo-800">Duration</th>
                                  <th scope="col" className="border border-indigo-200 px-3 py-2 text-left text-indigo-800">Agent</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs">Provoked (OCP, pregnancy, infection)</td>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs font-medium">3-6 months</td>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs">VKA (INR 2-3) preferred</td>
                                </tr>
                                <tr className="bg-slate-50">
                                  <td className="border border-indigo-100 px-3 py-2 text-xs">Unprovoked / mild thrombophilia</td>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs font-medium">6-12 months</td>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs">VKA; DOAC may be considered (ACTION-CVT)</td>
                                </tr>
                                <tr>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs">Recurrent VTE or severe thrombophilia</td>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs font-medium">Indefinite</td>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs">VKA (INR 2-3)</td>
                                </tr>
                                <tr className="bg-slate-50">
                                  <td className="border border-indigo-100 px-3 py-2 text-xs">APS confirmed</td>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs font-medium">Indefinite</td>
                                  <td className="border border-indigo-100 px-3 py-2 text-xs">VKA only (DOACs contraindicated)</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                          <p className="text-xs text-slate-500 mt-2 italic">Reassess imaging (MRV) at 3-6 months to guide anticoag duration. Fischer U et al. Lancet Neurol. 2025.</p>
                        </div>

                        {/* Special Populations */}
                        <details className="bg-white border border-indigo-200 rounded-lg">
                          <summary className="cursor-pointer p-4 font-semibold text-indigo-800 hover:bg-indigo-50 rounded-lg flex items-center justify-between">
                            <span>CVT in Special Populations</span>
                            <i aria-hidden="true" data-lucide="chevron-down" className="w-4 h-4"></i>
                          </summary>
                          <div className="p-4 pt-0 space-y-3 text-sm">
                            <div className="bg-pink-50 border border-pink-200 rounded-lg p-3">
                              <h4 className="font-semibold text-pink-800 mb-1">Pregnancy / Postpartum</h4>
                              <ul className="text-xs text-slate-700 space-y-0.5">
                                <li>• LMWH throughout pregnancy (UFH also acceptable)</li>
                                <li>• Warfarin contraindicated in 1st trimester, acceptable postpartum</li>
                                <li>• DOACs contraindicated in pregnancy/breastfeeding</li>
                                <li>• Future pregnancy not contraindicated, but prophylactic LMWH recommended</li>
                              </ul>
                            </div>
                            <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                              <h4 className="font-semibold text-slate-800 mb-1">Pediatric CVT</h4>
                              <ul className="text-xs text-slate-700 space-y-0.5">
                                <li>• Anticoagulation recommended (LMWH or UFH)</li>
                                <li>• Treat underlying infection aggressively</li>
                                <li>• 3-6 months anticoagulation typical</li>
                                <li>• Thrombophilia workup recommended</li>
                              </ul>
                            </div>
                          </div>
                        </details>
                      </div>
                    )}
                    {/* End of CVT Management Content */}

                    {/* Calculators Content */}
                    {managementSubTab === 'calculators' && (
                  <GlobalPatientContext.Provider value={patientContextValue}>
                  <div id="mgmt-tabpanel-calculators" role="tabpanel" aria-labelledby="mgmt-tab-calculators" className="flex flex-col gap-4">
                    {/* Quick Dosing Reference */}
                    <details className="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-xl p-3">
                      <summary className="font-bold text-orange-900 text-sm cursor-pointer flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="pill" className="w-4 h-4"></i>
                        Quick Dosing Reference
                      </summary>
                      <div className="mt-3 grid grid-cols-1 md:grid-cols-2 gap-2">
                        {[
                          { label: 'TNK (Tenecteplase)', dose: `0.25 mg/kg IV bolus (max 25 mg)${telestrokeNote.weight ? ` → ${Math.min(25, Math.round(parseFloat(telestrokeNote.weight) * 0.25 * 2) / 2)} mg` : ''}`, color: 'emerald' },
                          { label: 'Alteplase (tPA)', dose: `0.9 mg/kg IV (max 90 mg): 10% bolus, 90% over 60 min${telestrokeNote.weight ? ` → ${Math.min(90, Math.round(parseFloat(telestrokeNote.weight) * 0.9 * 10) / 10)} mg` : ''}`, color: 'blue' },
                          { label: 'Nimodipine (SAH)', dose: '60 mg PO/NG q4h x 21 days. If hypotension: 30 mg q2h.', color: 'purple' },
                          { label: 'PCC / Kcentra', dose: `INR 2-3.9: 25 IU/kg (max 2500); INR 4-6: 35 IU/kg (max 3500); INR >6: 50 IU/kg (max 5000)${telestrokeNote.weight ? ` → at 25 IU/kg: ${Math.round(parseFloat(telestrokeNote.weight) * 25)} IU` : ''}`, color: 'red' },
                          { label: 'Idarucizumab', dose: '5 g IV (two 2.5 g vials) over 5-10 min. For dabigatran reversal.', color: 'rose' },
                          { label: 'FFP (if no PCC)', dose: `10-15 mL/kg IV. Goal INR <1.5.${telestrokeNote.weight ? ` → ${Math.round(parseFloat(telestrokeNote.weight) * 12.5)} mL (~${Math.round(parseFloat(telestrokeNote.weight) * 12.5 / 250)} units)` : ''}`, color: 'amber' },
                          { label: 'Labetalol IV', dose: '10-20 mg IV q10-20min (max 300 mg). Alt: nicardipine 5 mg/h, titrate q5min by 2.5 mg/h (max 15).', color: 'slate' },
                          { label: 'Levetiracetam', dose: '1000-1500 mg IV load, then 500-1000 mg IV/PO q12h. For acute seizures.', color: 'indigo' }
                        ].map(item => {
                          const colorMap = {
                            emerald: 'border-emerald-200 hover:bg-emerald-50 text-emerald-800',
                            blue: 'border-blue-200 hover:bg-blue-50 text-blue-800',
                            purple: 'border-purple-200 hover:bg-purple-50 text-purple-800',
                            red: 'border-red-200 hover:bg-red-50 text-red-800',
                            rose: 'border-rose-200 hover:bg-rose-50 text-rose-800',
                            amber: 'border-amber-200 hover:bg-amber-50 text-amber-800',
                            slate: 'border-slate-200 hover:bg-slate-50 text-slate-800',
                            indigo: 'border-indigo-200 hover:bg-indigo-50 text-indigo-800'
                          };
                          const classes = colorMap[item.color] || 'border-slate-200 hover:bg-slate-50 text-slate-800';
                          const [borderClass, hoverClass, textClass] = classes.split(' ');
                          return (
                          <button key={item.label} type="button"
                            aria-label={`Copy ${item.label} dosing`}
                            onClick={() => copyToClipboard(`${item.label}: ${item.dose}`, 'dosing-ref')}
                            className={`text-left px-3 py-2 bg-white border ${borderClass} rounded-lg ${hoverClass} transition-colors group`}>
                            <span className={`text-xs font-bold ${textClass} block`}>{item.label}</span>
                            <span className="text-xs text-slate-600 block">{item.dose}</span>
                            <span className="text-xs text-slate-400 opacity-0 group-hover:opacity-100 transition-opacity">Click to copy</span>
                          </button>
                          );
                        })}
                      </div>
                    </details>
                    <CalculatorSync />
                    <CalculatorPatientSnapshot />
                    <div className="bg-white border border-indigo-200 rounded-lg p-3 flex flex-wrap items-center gap-3 text-xs">
                      <label className="flex items-center gap-2 font-semibold text-indigo-800">
                        <input
                          type="checkbox"
                          checked={autoSyncCalculators}
                          onChange={(e) => setAutoSyncCalculators(e.target.checked)}
                        />
                        Auto-sync calculators with encounter data
                      </label>
                      <span className="text-slate-500">Updates score tools plus CrCl/DOAC calculator inputs from age, sex, weight, and creatinine.</span>
                    </div>
                    {calculatorPriorityList.length > 0 && (
                      <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 text-xs">
                        <p className="font-semibold text-slate-700 mb-2">Priority calculators for {calculatorDiagnosisKey.toUpperCase()}</p>
                        <div className="flex flex-wrap gap-2">
                          {calculatorPriorityList.map((id) => (
                            <button
                              key={id}
                              type="button"
                              onClick={() => {
                                const el = document.getElementById(`calc-${id}`);
                                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                              }}
                              className="px-2 py-1 rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-100"
                            >
                              {calculatorLabelMap[id] || id}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                    {/* ============================================ */}
                    {/* CALCULATOR TRIAL PROMPTS                     */}
                    {/* Shows trial relevance after scoring          */}
                    {/* ============================================ */}
                    {(nihssScore || telestrokeNote.age) && (
                      <div className="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-xl p-4 shadow-md">
                        <div className="flex items-center justify-between mb-2">
                          <h2 className="text-lg font-bold text-purple-900 flex items-center gap-2">
                            <i aria-hidden="true" data-lucide="flask-conical" className="w-5 h-5"></i> Score → Trial Implications
                          </h2>
                          {telestrokeNote.age && (
                            <span className="text-sm text-purple-700">
                              Current: {telestrokeNote.age}{telestrokeNote.sex || '?'} | NIHSS {nihssScore || '?'}
                            </span>
                          )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                          {/* NIHSS-based prompts */}
                          {nihssScore !== null && nihssScore !== undefined && (
                            <div className="bg-white rounded p-3 border">
                              <h3 className="font-semibold text-purple-800 mb-2">NIHSS = {nihssScore}</h3>
                              <ul className="space-y-1 text-xs text-slate-700">
                                {nihssScore >= 4 && (
                                  <li className="text-emerald-700">
                                    <span className="inline-block w-2.5 h-2.5 rounded-full bg-emerald-500 mr-1"></span> <strong>SISTER eligible</strong>: NIHSS ≥4 threshold met{nihssScore <= 5 ? ' (4-5 requires disabling deficit)' : ''}
                                  </li>
                                )}
                                {nihssScore <= 5 && (
                                  <li className="text-amber-700">
                                    <span className="inline-block w-2.5 h-2.5 rounded-full bg-amber-500 mr-1"></span> <strong>STEP mild arm</strong>: Check for LVO (ICA/M1/basilar)
                                  </li>
                                )}
                                {nihssScore > 8 && (
                                  <li className="text-blue-700">
                                    <i aria-hidden="true" data-lucide="circle" className="w-3 h-3 inline text-blue-500"></i> <strong>STEP MeVO arm</strong>: Check for M2/M3 occlusion
                                  </li>
                                )}
                                {nihssScore < 4 && (
                                  <li className="text-slate-600">
                                    SISTER: NIHSS ≥4 required (current: {nihssScore})
                                  </li>
                                )}
                              </ul>
                            </div>
                          )}
                          {/* GCS-based prompts */}
                          {(() => {
                            const gcs = calculateGCS(gcsItems);
                            if (gcs === 0) return null;
                            return (
                              <div className="bg-white rounded p-3 border">
                                <h3 className="font-semibold text-purple-800 mb-2">GCS = {gcs}</h3>
                                <ul className="space-y-1 text-xs text-slate-700">
                                  {gcs >= 5 && gcs <= 14 && (
                                    <li className="text-blue-700">
                                      <i aria-hidden="true" data-lucide="circle" className="w-3 h-3 inline text-blue-500"></i> <strong>ENRICH range</strong>: GCS 5-14 for MIE consideration
                                    </li>
                                  )}
                                  {gcs > 14 && (
                                    <li className="text-slate-600">
                                      ENRICH: GCS 5-14 required (current: {gcs})
                                    </li>
                                  )}
                                  {gcs < 5 && (
                                    <li className="text-slate-600">
                                      GCS too low for most trial eligibility
                                    </li>
                                  )}
                                </ul>
                              </div>
                            );
                          })()}
                        </div>
                        <p className="text-xs text-purple-600 mt-2 italic">
                          These are quick prompts only. Full eligibility requires complete patient assessment.
                        </p>
                      </div>
                    )}

                    {/* NIHSS Summary Card */}
                    <details id="calc-nihss" style={{ order: getCalculatorOrder('nihss', 5) }} className="bg-red-50 border border-red-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-red-800 hover:bg-red-100 rounded-lg flex items-center justify-between">
                        <span>NIHSS Score</span>
                        <span className="text-sm font-normal text-red-600">Score: {nihssScore}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-between items-center mb-3">
                          <span className="text-xl font-bold text-red-600">Score: {nihssScore}/42</span>
                          <button
                            onClick={() => copyToClipboard(`NIHSS: ${nihssScore}`, 'NIHSS Score')}
                            className="p-1.5 hover:bg-red-100 rounded transition-colors"
                            aria-label="Copy NIHSS score to clipboard"
                          >
                            <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-red-600"></i>
                          </button>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3 text-xs">
                          <div className={`p-2 rounded border text-center ${nihssScore <= 4 ? 'bg-emerald-100 border-emerald-300 font-bold' : 'bg-white border-slate-200'}`}>
                            <p className="font-semibold">0-4</p><p>Minor</p>
                          </div>
                          <div className={`p-2 rounded border text-center ${nihssScore >= 5 && nihssScore <= 15 ? 'bg-amber-100 border-amber-300 font-bold' : 'bg-white border-slate-200'}`}>
                            <p className="font-semibold">5-15</p><p>Moderate</p>
                          </div>
                          <div className={`p-2 rounded border text-center ${nihssScore >= 16 && nihssScore <= 20 ? 'bg-orange-100 border-orange-300 font-bold' : 'bg-white border-slate-200'}`}>
                            <p className="font-semibold">16-20</p><p>Mod-Severe</p>
                          </div>
                          <div className={`p-2 rounded border text-center ${nihssScore >= 21 ? 'bg-red-100 border-red-300 font-bold' : 'bg-white border-slate-200'}`}>
                            <p className="font-semibold">21-42</p><p>Severe</p>
                          </div>
                        </div>
                        <p className="text-xs text-slate-500 mb-2">Use the NIHSS panel in the Encounter tab for full item-by-item scoring.</p>
                        <div className="text-xs text-slate-600 space-y-1">
                          <p><strong>Clinical significance:</strong></p>
                          <p>NIHSS ≤3: Consider DAPT (CHANCE/POINT criteria)</p>
                          <p>NIHSS ≥6: Likely LVO — consider EVT evaluation</p>
                          <p>NIHSS ≥8: CATALYST moderate severity — DOAC start day 3-5</p>
                          <p>NIHSS &gt;15: CATALYST severe — DOAC start day 6-14</p>
                        </div>
                        <details className="mt-3 bg-amber-50 border border-amber-200 rounded-lg">
                          <summary className="cursor-pointer p-2 text-xs font-semibold text-amber-800 hover:bg-amber-100 rounded-lg">NIHSS Scoring Pitfalls</summary>
                          <div className="p-2 text-xs text-slate-700 space-y-1">
                            <p><strong>1a (LOC):</strong> Do NOT score sedation/intubation as decreased LOC. Score best response. If patient requires stimulation only because of intubation/sedation, score 0.</p>
                            <p><strong>3 (Visual):</strong> Must use finger counting or visual stimulus, NOT visual threat. Test each eye&apos;s temporal and nasal field.</p>
                            <p><strong>5/6 (Motor):</strong> &quot;Drift&quot; = limb falls before 10s (arms) or 5s (legs). Amputation/fusion = 0, not UN. Test arms with palms down.</p>
                            <p><strong>7 (Ataxia):</strong> Test ONLY if there is no weakness obscuring assessment. If limb is plegic, score 0 (not UN). Ataxia must be out of proportion to weakness.</p>
                            <p><strong>9 (Language):</strong> Requires testing naming, reading, AND description — comprehension alone is insufficient. Use standardized picture card.</p>
                            <p><strong>11 (Extinction):</strong> Must test BILATERAL SIMULTANEOUS visual AND tactile stimulation, not just unilateral.</p>
                            <p><strong>Posterior circulation bias:</strong> Scale heavily weighted toward anterior/left MCA. Devastating posterior strokes (diplopia, vertigo, ataxia, dysphagia) may score 0-3. NIHSS 0 does NOT exclude stroke.</p>
                            <p><strong>General rule:</strong> Score WORST performance during exam, not best. Do not coach the patient.</p>
                          </div>
                        </details>
                        <details className="mt-3 bg-blue-50 border border-blue-200 rounded-lg">
                          <summary className="cursor-pointer p-2 text-xs font-semibold text-blue-800 hover:bg-blue-100 rounded-lg">NIHSS Exam Technique Guide (for telestroke coaching)</summary>
                          <div className="p-2 text-xs text-slate-700 space-y-2">
                            <p className="text-blue-700 font-semibold mb-1">Use this to coach spoke ED staff through each NIHSS item over video/phone.</p>
                            <div className="space-y-1.5">
                              <p><strong>1a. LOC:</strong> Observe alertness. If not alert, apply escalating stimuli: voice → loud voice → nail-bed pressure. Score response to each level. Do not attribute decreased LOC to sedation or intubation.</p>
                              <p><strong>1b. LOC Questions:</strong> Ask: &quot;What month is it?&quot; and &quot;What is your age?&quot; Patient must answer both correctly (no partial credit). Intubated/dysarthric patients who approximate answers score 1. Do NOT accept pointing or gestures.</p>
                              <p><strong>1c. LOC Commands:</strong> &quot;Open and close your eyes&quot; then &quot;Grip and release your non-paretic hand.&quot; If patient cannot use hands, substitute another one-step command. Score only first attempt. Demonstrate if there is a language barrier.</p>
                              <p><strong>2. Best Gaze:</strong> Test horizontal eye movements only. Ask patient to look left and right, or track your finger. If patient cannot follow commands, use oculocephalic reflex (doll&apos;s eyes). Score only conjugate horizontal gaze deviation or gaze palsy.</p>
                              <p><strong>3. Visual Fields:</strong> Test by finger counting or visual stimulus in all four quadrants. Patient fixates on your nose. Present 1-3 fingers in upper and lower temporal and nasal fields of each eye separately, or simultaneously if bilateral assessment needed. Do NOT use visual threat (finger poke) — it tests a different pathway. If one eye blind, test the other.</p>
                              <p><strong>4. Facial Palsy:</strong> Ask patient to show teeth (or smile) AND raise eyebrows. Compare both sides. If patient cannot follow commands: observe symmetry of grimace to nail-bed pressure. Central palsy = lower face only; peripheral = upper and lower face.</p>
                              <p><strong>5a/5b. Motor Arms:</strong> Position: arms extended 90° if sitting, 45° if supine, palms DOWN. Count aloud to 10. Score each arm separately. &quot;Drift&quot; = any downward movement before 10 seconds. If limb cannot be positioned against gravity due to pain/contracture, score best effort. Amputation/fusion = 0.</p>
                              <p><strong>6a/6b. Motor Legs:</strong> Position: supine, each leg raised to 30° from bed. Count aloud to 5. Score each leg separately. &quot;Drift&quot; = leg falls to bed before 5 seconds. Test one leg at a time.</p>
                              <p><strong>7. Limb Ataxia:</strong> Finger-nose-finger test (arms) and heel-shin test (legs). Patient must reach YOUR finger, not their own nose repeatedly. Test must be meaningful — do NOT test if limb is plegic (score 0) or if weakness obscures assessment. Ataxia must be OUT OF PROPORTION to weakness. Eyes open during testing.</p>
                              <p><strong>8. Sensory:</strong> Use pinprick (broken tongue depressor or pin). Test face, arm, trunk, and leg bilaterally. Ask &quot;Does this feel sharp? Does it feel the same on both sides?&quot; If patient cannot report, score grimace asymmetry to noxious stimulus. Only stroke-related loss counts — pre-existing neuropathy = 0.</p>
                              <p><strong>9. Best Language:</strong> Three required components: (1) Show cookie theft picture — patient describes the scene; (2) Naming card — patient names objects (feather, hammock, cactus); (3) Reading card — patient reads sentences aloud. Comprehension alone is NOT sufficient. If no cards available: ask patient to describe what happened, name objects in the room, read text on a clipboard. Mute/intubated who cannot write = score 3.</p>
                              <p><strong>10. Dysarthria:</strong> Ask patient to read or repeat: &quot;You know how.&quot; &quot;Down to earth.&quot; &quot;I got home from work.&quot; &quot;Near the table in the dining room.&quot; &quot;They heard him speak on the radio last night.&quot; Score clarity. Intubated/mechanical barrier = UN. If patient has severe aphasia, score dysarthria from spontaneous speech.</p>
                              <p><strong>11. Extinction/Inattention:</strong> Two simultaneous tests required: (1) VISUAL: Stand in front of patient, raise one finger on each side in peripheral fields simultaneously — ask &quot;Which side did you see?&quot; (2) TACTILE: With patient&apos;s eyes closed, touch both hands simultaneously — ask &quot;Where did I touch you?&quot; Both must be tested. Score only if one-sided extinction (perceives single stimuli but ignores one side during bilateral stimulation).</p>
                            </div>
                          </div>
                        </details>
                      </div>
                    </details>

                    {/* COR/LOE Legend */}
                    <div className="bg-white border border-slate-200 rounded-lg p-3 text-xs" style={{ order: 999 }}>
                      <details>
                        <summary className="cursor-pointer font-semibold text-slate-700 hover:text-slate-900">
                          COR/LOE Reference Legend
                        </summary>
                        <div className="mt-2 grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div>
                            <p className="font-bold text-slate-700 mb-1">Class of Recommendation (COR)</p>
                            <div className="space-y-1">
                              <div className="flex items-center gap-2"><span className="px-2 py-0.5 rounded-full bg-emerald-600 text-white font-semibold text-xs">Class I</span><span>Strong benefit, should be performed</span></div>
                              <div className="flex items-center gap-2"><span className="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-800 font-semibold text-xs border border-emerald-300">Class IIa</span><span>Reasonable, benefit likely outweighs risk</span></div>
                              <div className="flex items-center gap-2"><span className="px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 font-semibold text-xs border border-amber-300">Class IIb</span><span>May be considered, benefit uncertain</span></div>
                              <div className="flex items-center gap-2"><span className="px-2 py-0.5 rounded-full bg-red-100 text-red-800 font-semibold text-xs border border-red-300">Class III: No Benefit</span><span>Not useful</span></div>
                              <div className="flex items-center gap-2"><span className="px-2 py-0.5 rounded-full bg-red-600 text-white font-semibold text-xs">Class III: Harm</span><span>Harmful, should NOT be performed</span></div>
                            </div>
                          </div>
                          <div>
                            <p className="font-bold text-slate-700 mb-1">Level of Evidence (LOE)</p>
                            <div className="space-y-1">
                              <p><strong>A:</strong> Multiple RCTs or meta-analyses</p>
                              <p><strong>B-R:</strong> Randomized, moderate-quality evidence</p>
                              <p><strong>B-NR:</strong> Non-randomized, well-designed studies</p>
                              <p><strong>C-LD:</strong> Limited data, observational/registries</p>
                              <p><strong>C-EO:</strong> Expert opinion/consensus</p>
                            </div>
                          </div>
                        </div>
                      </details>
                    </div>

                    {/* Modified Fisher Scale */}
                    <details id="calc-mod-fisher" style={{ order: getCalculatorOrder('mod-fisher', 85) }} className="bg-purple-50 border border-purple-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg flex items-center justify-between">
                        <span>Modified Fisher Scale</span>
                        <span className="text-sm font-normal text-purple-600">Vasospasm Risk</span>
                      </summary>
                      <div className="p-4">
                        <p className="text-xs text-slate-600 mb-3">Predicts risk of symptomatic vasospasm after SAH based on CT appearance.</p>
                        <div className="space-y-1.5">
                          {[
                            {grade: 0, desc: 'No SAH or IVH', risk: '~0%', color: 'bg-emerald-50 border-emerald-200'},
                            {grade: 1, desc: 'Thin SAH, no IVH', risk: '~24%', color: 'bg-yellow-50 border-yellow-200'},
                            {grade: 2, desc: 'Thin SAH with IVH', risk: '~33%', color: 'bg-amber-50 border-amber-200'},
                            {grade: 3, desc: 'Thick SAH, no IVH', risk: '~33%', color: 'bg-orange-50 border-orange-200'},
                            {grade: 4, desc: 'Thick SAH with IVH', risk: '~40%', color: 'bg-red-50 border-red-200'},
                          ].map(item => (
                            <div key={item.grade} className={`flex items-center justify-between p-2 rounded border text-sm ${item.color}`}>
                              <span><strong>Grade {item.grade}:</strong> {item.desc}</span>
                              <span className="font-semibold text-xs">Vasospasm risk: {item.risk}</span>
                            </div>
                          ))}
                        </div>
                        <p className="text-xs text-slate-500 mt-2 italic">Frontera et al., Neurosurgery 2006. Thin = &lt;1mm, Thick = ≥1mm.</p>
                      </div>
                    </details>

                    {/* Glasgow Coma Scale */}
                    <details id="calc-gcs" style={{ order: getCalculatorOrder('gcs', 10) }} className="bg-slate-50 border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-slate-800 hover:bg-slate-100 rounded-lg flex items-center justify-between">
                        <span>Glasgow Coma Scale (GCS)</span>
                        <span className="text-sm font-normal text-slate-600">Score: {calculateGCS(gcsItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                        <div className="text-right">
                          <span className="text-xl font-bold text-slate-600" aria-live="polite">Score: {calculateGCS(gcsItems)}</span>
                          <div className="text-xs text-slate-500">Range: 3-15</div>
                        </div>
                        <button
                          onClick={() => copyToClipboard(`GCS: ${calculateGCS(gcsItems)}`, 'GCS Score')}
                          className="p-1.5 hover:bg-slate-100 rounded transition-colors"
                          aria-label="Copy GCS score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-slate-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-2">
                        <div className="space-y-1" role="group" aria-label="Eye Opening">
                          <h4 className="font-semibold text-sm mb-1">Eye Opening</h4>
                          {[{v:'4',l:'Spontaneous'},{v:'3',l:'To sound'},{v:'2',l:'To pain'},{v:'1',l:'None'}].map(o => (
                            <button key={o.v} type="button"
                              className={`w-full text-left px-3 py-2 rounded border text-sm transition-colors ${gcsItems.eye === o.v ? 'bg-slate-700 text-white border-slate-700 font-medium' : 'bg-white border-slate-200 hover:bg-slate-50 active:bg-slate-100'}`}
                              onClick={() => setGcsItems(prev => ({...prev, eye: o.v}))}
                            >
                              <span className="font-mono mr-1">{o.v}</span> {o.l}
                            </button>
                          ))}
                        </div>
                        <div className="space-y-1" role="group" aria-label="Verbal Response">
                          <h4 className="font-semibold text-sm mb-1">Verbal Response</h4>
                          {[{v:'5',l:'Oriented'},{v:'4',l:'Confused'},{v:'3',l:'Inappropriate'},{v:'2',l:'Incomprehensible'},{v:'1',l:'None'}].map(o => (
                            <button key={o.v} type="button"
                              className={`w-full text-left px-3 py-2 rounded border text-sm transition-colors ${gcsItems.verbal === o.v ? 'bg-slate-700 text-white border-slate-700 font-medium' : 'bg-white border-slate-200 hover:bg-slate-50 active:bg-slate-100'}`}
                              onClick={() => setGcsItems(prev => ({...prev, verbal: o.v}))}
                            >
                              <span className="font-mono mr-1">{o.v}</span> {o.l}
                            </button>
                          ))}
                        </div>
                        <div className="space-y-1" role="group" aria-label="Motor Response">
                          <h4 className="font-semibold text-sm mb-1">Motor Response</h4>
                          {[{v:'6',l:'Obeying'},{v:'5',l:'Localizing'},{v:'4',l:'Flexing'},{v:'3',l:'Abnormal flexion'},{v:'2',l:'Extending'},{v:'1',l:'None'}].map(o => (
                            <button key={o.v} type="button"
                              className={`w-full text-left px-3 py-2 rounded border text-sm transition-colors ${gcsItems.motor === o.v ? 'bg-slate-700 text-white border-slate-700 font-medium' : 'bg-white border-slate-200 hover:bg-slate-50 active:bg-slate-100'}`}
                              onClick={() => setGcsItems(prev => ({...prev, motor: o.v}))}
                            >
                              <span className="font-mono mr-1">{o.v}</span> {o.l}
                            </button>
                          ))}
                        </div>
                      </div>
                      {(() => {
                        const gcs = calculateGCS(gcsItems);
                        if (!gcs) return null;
                        const label = gcs <= 8 ? 'Severe' : gcs <= 12 ? 'Moderate' : 'Mild';
                        const tone = gcs <= 8 ? 'bg-red-50 border-red-200 text-red-800' : gcs <= 12 ? 'bg-amber-50 border-amber-200 text-amber-800' : 'bg-emerald-50 border-emerald-200 text-emerald-800';
                        return (
                          <div className={`mt-3 border rounded-lg p-2 text-xs ${tone}`}>
                            <span className="font-semibold">Interpretation:</span> {label === 'Severe' ? 'SEVERE' : label === 'Moderate' ? 'MODERATE' : 'Mild'} brain injury (GCS {gcs}){gcs <= 8 ? ' — consider intubation for airway protection' : ''}
                          </div>
                        );
                      })()}
                      </div>
                    </details>

                    {/* ICH Score */}
                    <details id="calc-ich-score" style={{ order: getCalculatorOrder('ich-score', 20) }} className="bg-red-50 border border-red-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-red-800 hover:bg-red-100 rounded-lg flex items-center justify-between">
                        <span>ICH Score</span>
                        <span className="text-sm font-normal text-red-600">Score: {calculateICHScore(ichScoreItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-red-600">Score: {calculateICHScore(ichScoreItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`ICH Score: ${calculateICHScore(ichScoreItems)}`, 'ICH Score')}
                          className="p-1.5 hover:bg-red-100 rounded transition-colors"
                          aria-label="Copy ICH score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-red-600"></i>
                        </button>
                      </div>

                      {(() => {
                        const ichScore = calculateICHScore(ichScoreItems);
                        const mortalityData = {0: '0%', 1: '13%', 2: '26%', 3: '72%', 4: '97%', 5: '100%', 6: '100%'};
                        const mortality = mortalityData[Math.min(ichScore, 6)] || 'N/A';
                        const label = ichScore >= 4 ? 'High mortality risk' : ichScore >= 2 ? 'Moderate risk' : 'Lower risk';
                        const tone = ichScore >= 4 ? 'bg-red-50 border-red-200 text-red-800' : ichScore >= 2 ? 'bg-amber-50 border-amber-200 text-amber-800' : 'bg-emerald-50 border-emerald-200 text-emerald-800';
                        return (
                          <div className={`mt-2 border rounded-lg p-2 text-xs ${tone}`} aria-live="polite" aria-atomic="true">
                            <span className="font-semibold">Interpretation:</span> {label} (ICH Score {ichScore})
                            <span className="ml-2 font-semibold">30-day mortality: {mortality}</span>
                            <p className="mt-1 text-slate-500">Hemphill et al., Stroke 2001; validated in multiple cohorts</p>
                          </div>
                        );
                      })()}

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                        <div className="space-y-2">
                          <p className="font-semibold text-sm mb-1">Glasgow Coma Scale:</p>
                          {[{v:'gcs34',l:'GCS 3-4',p:'+2 points'},{v:'gcs512',l:'GCS 5-12',p:'+1 point'},{v:'',l:'GCS 13-15',p:'0 points'}].map(o => (
                            <button key={o.v} type="button"
                              className={`w-full text-left px-3 py-2 rounded border text-sm transition-colors ${ichScoreItems.gcs === o.v ? 'bg-red-700 text-white border-red-700 font-medium' : 'bg-white border-slate-200 hover:bg-slate-50 active:bg-slate-100'}`}
                              onClick={() => setIchScoreItems(prev => ({...prev, gcs: o.v}))}
                            >
                              {o.l} <span className={ichScoreItems.gcs === o.v ? 'text-white/70' : 'text-slate-500'}>({o.p})</span>
                            </button>
                          ))}
                          <hr className="my-3" />
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.age80}
                              onChange={(e) => setIchScoreItems(prev => ({...prev, age80: e.target.checked}))}
                            />
                            <span className="text-sm">Age ≥80 (+1)</span>
                          </label>
                        </div>
                        <div className="space-y-4">
                          <div className="bg-gradient-to-br from-white to-slate-50 p-4 rounded-xl border border-slate-200 shadow-sm relative overflow-hidden group">
                             <div className="absolute top-0 right-0 p-2 opacity-10 group-hover:opacity-20 transition-opacity pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                  <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-4A2.5 2.5 0 0 1 9.5 2Z" />
                                  <path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-4A2.5 2.5 0 0 0 14.5 2Z" />
                                </svg>
                             </div>
                            <div className="mb-4 relative z-10">
                              <h4 className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-blue-500">
                                  <rect width="16" height="20" x="4" y="2" rx="2" />
                                  <line x1="8" x2="16" y1="6" y2="6" />
                                  <path d="M16 14v4" />
                                  <path d="M16 10h.01" />
                                  <path d="M12 10h.01" />
                                  <path d="M8 10h.01" />
                                  <path d="M12 14h.01" />
                                  <path d="M8 14h.01" />
                                  <path d="M12 18h.01" />
                                  <path d="M8 18h.01" />
                                </svg>
                                ICH Volume Calculator (ABC/2)
                              </h4>
                              <p className="text-xs text-slate-500 mt-1">Calculate hematoma volume from CT measurements.</p>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-4 relative z-10">
                              <div className="space-y-1">
                                <label className="text-xs font-semibold text-slate-600 uppercase tracking-wider">A: Length</label>
                                <div className="relative">
                                  <input
                                    type="number"
                                    className="w-full pl-3 pr-8 py-2 text-sm bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm"
                                    placeholder="0.0"
                                    value={ichVolumeParams.a}
                                    onChange={(e) => setIchVolumeParams(prev => ({...prev, a: e.target.value}))}
                                  />
                                  <span className="absolute right-3 top-2 text-xs text-slate-500 font-medium">cm</span>
                                </div>
                              </div>
                              <div className="space-y-1">
                                <label className="text-xs font-semibold text-slate-600 uppercase tracking-wider">B: Width</label>
                                <div className="relative">
                                  <input
                                    type="number"
                                    className="w-full pl-3 pr-8 py-2 text-sm bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm"
                                    placeholder="0.0"
                                    value={ichVolumeParams.b}
                                    onChange={(e) => setIchVolumeParams(prev => ({...prev, b: e.target.value}))}
                                  />
                                  <span className="absolute right-3 top-2 text-xs text-slate-500 font-medium">cm</span>
                                </div>
                              </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4 mb-4 relative z-10">
                              <div className="space-y-1">
                                <label className="text-xs font-semibold text-slate-600 uppercase tracking-wider">Slice Thickness</label>
                                <div className="relative">
                                  <input
                                    type="number"
                                    className="w-full pl-3 pr-8 py-2 text-sm bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm"
                                    placeholder="e.g. 5"
                                    value={ichVolumeParams.thicknessMm}
                                    onChange={(e) => setIchVolumeParams(prev => ({...prev, thicknessMm: e.target.value}))}
                                  />
                                  <span className="absolute right-3 top-2 text-xs text-slate-500 font-medium">mm</span>
                                </div>
                              </div>
                              <div className="space-y-1">
                                <label className="text-xs font-semibold text-slate-600 uppercase tracking-wider"># Slices</label>
                                <div className="relative">
                                  <input
                                    type="number"
                                    className="w-full pl-3 pr-8 py-2 text-sm bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all shadow-sm"
                                    placeholder="0"
                                    value={ichVolumeParams.numSlices}
                                    onChange={(e) => setIchVolumeParams(prev => ({...prev, numSlices: e.target.value}))}
                                  />
                                  <span className="absolute right-3 top-2 text-xs text-slate-500 font-medium">#</span>
                                </div>
                              </div>
                            </div>

                            <div className={`mt-4 pt-3 border-t border-dashed border-slate-200 flex justify-between items-center transition-all duration-300 ${ichVolumeParams.a && ichVolumeParams.b && ichVolumeParams.thicknessMm && ichVolumeParams.numSlices ? 'opacity-100' : 'opacity-50'}`}>
                                <span className="text-xs font-medium text-slate-500">Calculated Volume</span>
                                <div className="flex items-baseline gap-1">
                                  <span className="text-2xl font-bold text-blue-600">
                                    {(() => {
                                      const _a = parseFloat(ichVolumeParams.a), _b = parseFloat(ichVolumeParams.b);
                                      const _t = parseFloat(ichVolumeParams.thicknessMm), _n = parseFloat(ichVolumeParams.numSlices);
                                      if ([_a, _b, _t, _n].some(v => Number.isNaN(v) || v <= 0)) return '0.0';
                                      return ((_a * _b * (_t / 10 * _n)) / 2).toFixed(1);
                                    })()}
                                  </span>
                                  <span className="text-sm font-medium text-blue-400">cc</span>
                                </div>
                            </div>
                          </div>
                          
                          <div className="space-y-3 pl-1">
                            <label className="flex items-center space-x-3 cursor-pointer group">
                              <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${ichScoreItems.volume30 ? 'bg-red-500 border-red-500' : 'bg-white border-slate-300 group-hover:border-red-400'}`}>
                                {ichScoreItems.volume30 && (
                                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="text-white">
                                    <polyline points="20 6 9 17 4 12" />
                                  </svg>
                                )}
                              </div>
                              <input 
                                type="checkbox" 
                                className="sr-only"
                                checked={ichScoreItems.volume30}
                                onChange={(e) => setIchScoreItems(prev => ({...prev, volume30: e.target.checked}))}
                              />
                              <span className={`text-sm ${ichScoreItems.volume30 ? 'font-medium text-slate-900' : 'text-slate-600'}`}>ICH volume ≥30 cc (+1)</span>
                            </label>

                            <label className="flex items-center space-x-3 cursor-pointer group">
                              <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${ichScoreItems.ivh ? 'bg-red-500 border-red-500' : 'bg-white border-slate-300 group-hover:border-red-400'}`}>
                                {ichScoreItems.ivh && (
                                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="text-white">
                                    <polyline points="20 6 9 17 4 12" />
                                  </svg>
                                )}
                              </div>
                              <input 
                                type="checkbox" 
                                className="sr-only"
                                checked={ichScoreItems.ivh}
                                onChange={(e) => setIchScoreItems(prev => ({...prev, ivh: e.target.checked}))}
                              />
                              <span className={`text-sm ${ichScoreItems.ivh ? 'font-medium text-slate-900' : 'text-slate-600'}`}>Intraventricular hemorrhage (+1)</span>
                            </label>

                            <label className="flex items-center space-x-3 cursor-pointer group">
                              <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${ichScoreItems.infratentorial ? 'bg-red-500 border-red-500' : 'bg-white border-slate-300 group-hover:border-red-400'}`}>
                                {ichScoreItems.infratentorial && (
                                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="text-white">
                                    <polyline points="20 6 9 17 4 12" />
                                  </svg>
                                )}
                              </div>
                              <input 
                                type="checkbox" 
                                className="sr-only"
                                checked={ichScoreItems.infratentorial}
                                onChange={(e) => setIchScoreItems(prev => ({...prev, infratentorial: e.target.checked}))}
                              />
                              <span className={`text-sm ${ichScoreItems.infratentorial ? 'font-medium text-slate-900' : 'text-slate-600'}`}>Infratentorial origin (+1)</span>
                            </label>
                          </div>
                        </div>
                      </div>
                      </div>
                    </details>

                    {/* FUNC Score */}
                    <details id="calc-func" style={{ order: getCalculatorOrder('func', 22) }} className="bg-rose-50 border border-rose-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-rose-800 hover:bg-rose-100 rounded-lg flex items-center justify-between">
                        <span>FUNC Score (ICH Functional Outcome)</span>
                        <span className="text-sm font-normal text-rose-600">Prognosis</span>
                      </summary>
                      <div className="p-4">
                        <p className="text-xs text-slate-600 mb-3">Predicts functional independence (GOS ≥4) at 90 days after ICH. Range 0-11. Higher = better prognosis. (Rost et al., Stroke 2008)</p>
                        {(() => {
                          const funcItems = {
                            volume: ichVolumeParams.a && ichVolumeParams.b && ichVolumeParams.thicknessMm && ichVolumeParams.numSlices
                              ? (() => {
                                  const cCm = parseFloat(ichVolumeParams.thicknessMm) / 10 * parseFloat(ichVolumeParams.numSlices);
                                  const vol = (parseFloat(ichVolumeParams.a) * parseFloat(ichVolumeParams.b) * cCm) / 2;
                                  return isNaN(vol) || vol <= 0 ? null : vol < 30 ? 4 : vol < 60 ? 2 : vol < 100 ? 1 : 0;
                                })()
                              : null,
                            age: telestrokeNote.age ? (parseInt(telestrokeNote.age, 10) < 70 ? 2 : parseInt(telestrokeNote.age, 10) <= 79 ? 1 : 0) : null,
                            location: ichScoreItems.infratentorial ? 0 : ichScoreItems.lobar ? 2 : 1,
                            gcs: ichScoreItems.gcs === 'gcs34' ? 0 : ichScoreItems.gcs === 'gcs512' ? 1 : 2,
                            cognitive: ichScoreItems.preCogImpairment ? 0 : 1,
                          };
                          const known = Object.values(funcItems).filter(v => v !== null);
                          const score = known.reduce((a, b) => a + b, 0);
                          const hasAll = !Object.values(funcItems).includes(null);
                          const funcOutcome = score >= 8 ? {label: 'Good (≥80% chance of functional independence)', color: 'bg-emerald-50 border-emerald-200 text-emerald-800'}
                            : score >= 5 ? {label: 'Moderate (50-80% chance)', color: 'bg-amber-50 border-amber-200 text-amber-800'}
                            : {label: 'Poor (<50% chance of functional independence)', color: 'bg-red-50 border-red-200 text-red-800'};
                          return (
                            <div className="space-y-3">
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                <div className="bg-white border rounded p-2">
                                  <p className="font-semibold text-rose-700">ICH Volume</p>
                                  <p className="text-xs text-slate-600">&lt;30 mL: +4 | 30-59 mL: +2 | ≥60 mL: +0</p>
                                  <p className="text-xs mt-1 font-medium">{funcItems.volume !== null ? `Current: +${funcItems.volume} (from ABC/2)` : 'Enter ICH volume above'}</p>
                                </div>
                                <div className="bg-white border rounded p-2">
                                  <p className="font-semibold text-rose-700">Age</p>
                                  <p className="text-xs text-slate-600">&lt;70: +2 | 70-79: +1 | ≥80: +0</p>
                                  <p className="text-xs mt-1 font-medium">{funcItems.age !== null ? `Current: +${funcItems.age} (age ${telestrokeNote.age})` : 'Enter age in encounter'}</p>
                                </div>
                                <div className="bg-white border rounded p-2">
                                  <p className="font-semibold text-rose-700">ICH Location</p>
                                  <p className="text-xs text-slate-600">Lobar: +2 | Deep: +1 | Infratentorial: +0</p>
                                  <div className="flex gap-2 mt-1">
                                    {[
                                      { val: 'lobar', label: 'Lobar', pts: 2 },
                                      { val: 'deep', label: 'Deep', pts: 1 },
                                      { val: 'infratentorial', label: 'Infratentorial', pts: 0 }
                                    ].map(loc => (
                                      <label key={loc.val} className={`flex items-center gap-1 text-xs px-2 py-1 rounded cursor-pointer border ${
                                        (loc.val === 'infratentorial' && ichScoreItems.infratentorial) ||
                                        (loc.val === 'lobar' && !ichScoreItems.infratentorial && ichScoreItems.lobar) ||
                                        (loc.val === 'deep' && !ichScoreItems.infratentorial && !ichScoreItems.lobar)
                                          ? 'bg-rose-100 border-rose-400 font-semibold' : 'bg-white border-slate-200'
                                      }`}>
                                        <input type="radio" name="func-location" className="sr-only"
                                          checked={
                                            (loc.val === 'infratentorial' && ichScoreItems.infratentorial) ||
                                            (loc.val === 'lobar' && !ichScoreItems.infratentorial && ichScoreItems.lobar) ||
                                            (loc.val === 'deep' && !ichScoreItems.infratentorial && !ichScoreItems.lobar)
                                          }
                                          onChange={() => setIchScoreItems(prev => ({...prev,
                                            infratentorial: loc.val === 'infratentorial',
                                            lobar: loc.val === 'lobar'
                                          }))}
                                        />
                                        {loc.label} (+{loc.pts})
                                      </label>
                                    ))}
                                  </div>
                                </div>
                                <div className="bg-white border rounded p-2">
                                  <p className="font-semibold text-rose-700">GCS Score</p>
                                  <p className="text-xs text-slate-600">≥9: +2 | 5-8: +1 | 3-4: +0</p>
                                  <p className="text-xs mt-1 font-medium">Current: +{funcItems.gcs}</p>
                                </div>
                                <div className="bg-white border rounded p-2">
                                  <p className="font-semibold text-rose-700">Pre-ICH Cognitive Status</p>
                                  <p className="text-xs text-slate-600">No impairment: +1 | Pre-ICH dementia: +0</p>
                                  <label className="flex items-center gap-2 mt-1 text-xs cursor-pointer">
                                    <input type="checkbox" checked={ichScoreItems.preCogImpairment || false}
                                      onChange={(e) => setIchScoreItems(prev => ({...prev, preCogImpairment: e.target.checked}))}
                                      className="w-4 h-4 text-rose-600" />
                                    Pre-ICH cognitive impairment
                                  </label>
                                  <p className="text-xs mt-1 font-medium">Current: +{funcItems.cognitive}</p>
                                </div>
                              </div>
                              <div className={`border rounded-lg p-3 ${funcOutcome.color}`}>
                                <p className="text-sm font-bold">FUNC Score: {score}/11 {!hasAll && '(partial — enter missing values)'}</p>
                                <p className="text-xs mt-1">{funcOutcome.label}</p>
                              </div>
                              <div className="bg-amber-50 border border-amber-200 rounded p-2 text-xs text-amber-800">
                                <strong>Important:</strong> FUNC Score should NOT be used alone for withdrawal-of-care decisions. Early aggressive care limitations (self-fulfilling prophecy) contribute to poor outcomes. AHA/ASA recommends postponing DNR orders for at least 24h after ICH onset.
                              </div>
                            </div>
                          );
                        })()}
                      </div>
                    </details>

                    {/* Modified Rankin Scale (mRS) */}
                    <details id="calc-mrs" style={{ order: getCalculatorOrder('mrs', 30) }} className="bg-slate-50 border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-slate-800 hover:bg-slate-100 rounded-lg flex items-center justify-between">
                        <span>Modified Rankin Scale (mRS)</span>
                        <span className="text-sm font-normal text-slate-600">Score: {mrsScore || 'Not Selected'}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <div className="text-right">
                            <span className="text-xl font-bold text-slate-600">
                              Score: {mrsScore || 'Not Selected'}
                            </span>
                          <div className="text-xs text-slate-500">Range: 0-6</div>
                        </div>
                        {mrsScore && (
                          <button
                            onClick={() => copyToClipboard(`mRS: ${mrsScore}`, 'mRS Score')}
                            className="p-1.5 hover:bg-slate-100 rounded transition-colors"
                            aria-label="Copy mRS score to clipboard"
                            title="Copy to clipboard"
                          >
                            <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-slate-600"></i>
                          </button>
                        )}
                      </div>

                      <div className="space-y-2">
                        {[
                          {v:'0',title:'0 - No symptoms',desc:'Completely recovered; no residual symptoms'},
                          {v:'1',title:'1 - No significant disability',desc:'Able to carry out all usual duties and activities despite some symptoms'},
                          {v:'2',title:'2 - Slight disability',desc:'Unable to carry out all previous activities but able to look after own affairs without assistance'},
                          {v:'3',title:'3 - Moderate disability',desc:'Requires some help, but able to walk without assistance'},
                          {v:'4',title:'4 - Moderately severe disability',desc:'Unable to walk without assistance and unable to attend to own bodily needs without assistance'},
                          {v:'5',title:'5 - Severe disability',desc:'Bedridden, incontinent, and requires constant nursing care and attention'},
                          {v:'6',title:'6 - Dead',desc:''}
                        ].map(o => (
                          <button key={o.v} type="button"
                            className={`w-full text-left p-3 rounded-lg border transition-colors ${mrsScore === o.v ? 'bg-blue-600 text-white border-blue-600' : 'bg-white border-slate-200 hover:bg-slate-50 active:bg-slate-100'}`}
                            onClick={() => setMrsScore(o.v)}
                          >
                            <div className="font-semibold">{o.title}</div>
                            {o.desc && <div className={`text-sm ${mrsScore === o.v ? 'text-blue-100' : 'text-slate-600'}`}>{o.desc}</div>}
                          </button>
                        ))}
                      </div>

                      {mrsScore && (
                        <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                          <p className="text-sm font-semibold text-blue-900 mb-1">Clinical Interpretation:</p>
                          <p className="text-sm text-blue-800">
                            {mrsScore === '0' && 'Excellent outcome - Complete recovery with no residual deficits'}
                            {mrsScore === '1' && 'Good outcome - Minor symptoms that do not interfere with lifestyle'}
                            {mrsScore === '2' && 'Fair outcome - Some restriction in lifestyle but retains capacity for independent living'}
                            {mrsScore === '3' && 'Moderate outcome - Significant lifestyle restriction; requires some assistance'}
                            {mrsScore === '4' && 'Moderately severe outcome - Clearly dependent; requires assistance with basic activities'}
                            {mrsScore === '5' && 'Severe outcome - Totally dependent; requires constant care'}
                            {mrsScore === '6' && 'Death'}
                          </p>
                        </div>
                      )}
                      <div className="mt-3 p-2 bg-slate-50 rounded border border-slate-200">
                        <p className="text-xs font-semibold text-slate-600 mb-1">EVT Trial Eligibility by Premorbid mRS:</p>
                        <div className="text-xs text-slate-500 space-y-0.5">
                          <p>mRS 0-1: MR CLEAN, ESCAPE, EXTEND-IA, SWIFT PRIME, REVASCAT, DAWN, DEFUSE 3</p>
                          <p>mRS 0-2: EXTEND, ECASS III (IVT), HERMES meta-analysis</p>
                          <p>mRS 0-3: SELECT2 (large core), ANGEL-ASPECT</p>
                        </div>
                      </div>
                      </div>
                    </details>

                    {/* ABCD2 */}
                    <details id="calc-abcd2" style={{ order: getCalculatorOrder('abcd2', 40) }} className="bg-orange-50 border border-orange-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-orange-800 hover:bg-orange-100 rounded-lg flex items-center justify-between">
                        <span>ABCD² Score</span>
                        <span className="text-sm font-normal text-orange-600">Score: {calculateABCD2Score(abcd2Items)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-orange-600">Score: {calculateABCD2Score(abcd2Items)}</span>
                        <button
                          onClick={() => copyToClipboard(`ABCD² Score: ${calculateABCD2Score(abcd2Items)}`, 'ABCD² Score')}
                          className="p-1.5 hover:bg-orange-100 rounded transition-colors"
                          aria-label="Copy ABCD² score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-orange-600"></i>
                        </button>
                      </div>

                      {(() => {
                        const abcd2 = calculateABCD2Score(abcd2Items);
                        const label = abcd2 >= 6 ? 'High risk' : abcd2 >= 4 ? 'Moderate risk' : 'Lower risk';
                        const tone = abcd2 >= 6 ? 'bg-red-50 border-red-200 text-red-800' : abcd2 >= 4 ? 'bg-amber-50 border-amber-200 text-amber-800' : 'bg-emerald-50 border-emerald-200 text-emerald-800';
                        return (
                          <div className={`mt-2 border rounded-lg p-2 text-xs ${tone}`}>
                            <span className="font-semibold">Interpretation:</span> {label} 2-day stroke risk (ABCD² {abcd2})
                          </div>
                        );
                      })()}

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.age60}
                              onChange={(e) => setAbcd2Items(prev => ({...prev, age60: e.target.checked}))}
                            />
                            <span className="text-sm">Age ≥60 (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.bp}
                              onChange={(e) => setAbcd2Items(prev => ({...prev, bp: e.target.checked}))}
                            />
                            <span className="text-sm">BP: SBP≥140 or DBP≥90 (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.unilateralWeakness}
                              onChange={(e) => setAbcd2Items(prev => ({...prev, unilateralWeakness: e.target.checked, speechDisturbance: e.target.checked ? false : prev.speechDisturbance}))}
                            />
                            <span className="text-sm">Unilateral weakness (+2)</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              className="text-orange-600"
                              checked={abcd2Items.speechDisturbance}
                              onChange={(e) => setAbcd2Items(prev => ({...prev, speechDisturbance: e.target.checked, unilateralWeakness: e.target.checked ? false : prev.unilateralWeakness}))}
                              disabled={abcd2Items.unilateralWeakness}
                            />
                            <span className={`text-sm ${abcd2Items.unilateralWeakness ? 'text-slate-500 line-through' : ''}`}>Speech disturbance w/o weakness (+1)</span>
                          </label>
                          <p className="font-semibold text-sm mt-3 mb-1">Symptom Duration:</p>
                          {[{v:'duration60',l:'\u226560 minutes',p:'+2 points'},{v:'duration10',l:'10-59 minutes',p:'+1 point'},{v:'',l:'<10 minutes',p:'0 points'}].map(o => (
                            <button key={o.v || 'none'} type="button"
                              className={`w-full text-left px-3 py-2 rounded border text-sm transition-colors mb-1 ${abcd2Items.duration === o.v ? 'bg-orange-600 text-white border-orange-600 font-medium' : 'bg-white border-slate-200 hover:bg-slate-50 active:bg-slate-100'}`}
                              onClick={() => setAbcd2Items(prev => ({...prev, duration: o.v}))}
                            >
                              {o.l} <span className={abcd2Items.duration === o.v ? 'text-white/70' : 'text-slate-500'}>({o.p})</span>
                            </button>
                          ))}
                          <hr className="my-3" />
                          <label className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              className="text-orange-600"
                              checked={abcd2Items.diabetes}
                              onChange={(e) => setAbcd2Items(prev => ({...prev, diabetes: e.target.checked}))}
                            />
                            <span className="text-sm">Diabetes mellitus (+1)</span>
                          </label>
                        </div>
                      </div>

                      <div className="bg-white p-3 rounded border">
                        <h4 className="font-semibold mb-2">2-Day, 7-Day, and 90-Day Stroke Risk</h4>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                          <div>
                            <p><strong>0-3:</strong></p>
                            <p>2-day: 1%</p>
                            <p>7-day: 1.2%</p>
                            <p>90-day: 3.1%</p>
                          </div>
                          <div>
                            <p><strong>4-5:</strong></p>
                            <p>2-day: 4.1%</p>
                            <p>7-day: 5.9%</p>
                            <p>90-day: 9.8%</p>
                          </div>
                          <div>
                            <p><strong>6-7:</strong></p>
                            <p>2-day: 8.1%</p>
                            <p>7-day: 11.7%</p>
                            <p>90-day: 17.8%</p>
                          </div>
                        </div>
                      </div>
                      </div>
                    </details>

                    {/* CHADS2-VASC */}
                    <details id="calc-chads2vasc" style={{ order: getCalculatorOrder('chads2vasc', 50) }} className="bg-purple-50 border border-purple-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg flex items-center justify-between">
                        <span>CHA₂DS₂-VASc Score</span>
                        <span className="text-sm font-normal text-purple-600">Score: {calculateCHADS2VascScore(chads2vascItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-purple-600">Score: {calculateCHADS2VascScore(chads2vascItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`CHADS₂-VASc: ${calculateCHADS2VascScore(chads2vascItems)}`, 'CHADS₂-VASc Score')}
                          className="p-1.5 hover:bg-purple-100 rounded transition-colors"
                          aria-label="Copy CHADS₂-VASc score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-purple-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-2">
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.age65}
                            onChange={(e) => setChads2vascItems(prev => ({...prev, age65: e.target.checked, age75: e.target.checked ? false : prev.age75}))}
                          />
                          <span className="text-sm">Age 65-74 (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input
                            type="checkbox"
                            className="text-purple-600"
                            checked={chads2vascItems.age75}
                            onChange={(e) => setChads2vascItems(prev => ({...prev, age75: e.target.checked, age65: e.target.checked ? false : prev.age65}))}
                          />
                          <span className="text-sm">Age ≥75 (+2)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.chf}
                            onChange={(e) => setChads2vascItems(prev => ({...prev, chf: e.target.checked}))}
                          />
                          <span className="text-sm">CHF (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.hypertension}
                            onChange={(e) => setChads2vascItems(prev => ({...prev, hypertension: e.target.checked}))}
                          />
                          <span className="text-sm">Hypertension (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.diabetes}
                            onChange={(e) => setChads2vascItems(prev => ({...prev, diabetes: e.target.checked}))}
                          />
                          <span className="text-sm">Diabetes (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.strokeTia}
                            onChange={(e) => setChads2vascItems(prev => ({...prev, strokeTia: e.target.checked}))}
                          />
                          <span className="text-sm">Stroke/TIA (+2)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.vascular}
                            onChange={(e) => setChads2vascItems(prev => ({...prev, vascular: e.target.checked}))}
                          />
                          <span className="text-sm">Vascular disease (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.female}
                            onChange={(e) => setChads2vascItems(prev => ({...prev, female: e.target.checked}))}
                          />
                          <span className="text-sm">Female sex (+1)</span>
                        </label>
                      </div>
                      
                      <div className="bg-white p-3 rounded border">
                        <h4 className="font-semibold mb-2">Annual Stroke/TE Risk (Friberg et al., JACC 2012)</h4>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                          <div>
                            <p><strong>Score 0:</strong> 0.2%</p>
                            <p><strong>Score 1:</strong> 0.6%</p>
                            <p><strong>Score 2:</strong> 2.2%</p>
                          </div>
                          <div>
                            <p><strong>Score 3:</strong> 3.2%</p>
                            <p><strong>Score 4:</strong> 4.8%</p>
                            <p><strong>Score 5:</strong> 7.2%</p>
                          </div>
                          <div>
                            <p><strong>Score 6:</strong> 9.7%</p>
                            <p><strong>Score 7:</strong> 11.2%</p>
                            <p><strong>Score 8:</strong> 10.8%</p>
                            <p><strong>Score 9:</strong> 12.2%</p>
                          </div>
                        </div>
                      </div>
                      </div>
                    </details>

                    {/* HAS-BLED Score */}
                    <details id="calc-hasbled" style={{ order: getCalculatorOrder('hasbled', 60) }} className="bg-pink-50 border border-pink-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-pink-800 hover:bg-pink-100 rounded-lg flex items-center justify-between">
                        <span>HAS-BLED Score</span>
                        <span className="text-sm font-normal text-pink-600">Score: {calculateHASBLEDScore(hasbledItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-pink-600">Score: {calculateHASBLEDScore(hasbledItems)}</span>
                          <button
                            onClick={() => copyToClipboard(`HAS-BLED: ${calculateHASBLEDScore(hasbledItems)}`, 'HAS-BLED Score')}
                            className="p-1.5 hover:bg-pink-100 rounded transition-colors"
                            aria-label="Copy HAS-BLED score to clipboard"
                            title="Copy to clipboard"
                          >
                            <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-pink-600"></i>
                          </button>
                        </div>

                        <div className="space-y-2 mb-4">
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.hypertension}
                              onChange={(e) => setHasbledItems(prev => ({...prev, hypertension: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>H</strong>ypertension (uncontrolled SBP &gt;160) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.renalDisease}
                              onChange={(e) => setHasbledItems(prev => ({...prev, renalDisease: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>A</strong>bnormal renal function (dialysis, transplant, Cr &gt;2.6) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.liverDisease}
                              onChange={(e) => setHasbledItems(prev => ({...prev, liverDisease: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>A</strong>bnormal liver function (cirrhosis, bilirubin &gt;2x, AST/ALT &gt;3x) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.stroke}
                              onChange={(e) => setHasbledItems(prev => ({...prev, stroke: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>S</strong>troke history (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.bleeding}
                              onChange={(e) => setHasbledItems(prev => ({...prev, bleeding: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>B</strong>leeding history or predisposition (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.labileINR}
                              onChange={(e) => setHasbledItems(prev => ({...prev, labileINR: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>L</strong>abile INR (TTR &lt;60%) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.elderly}
                              onChange={(e) => setHasbledItems(prev => ({...prev, elderly: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>E</strong>lderly (age ≥65) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.drugs}
                              onChange={(e) => setHasbledItems(prev => ({...prev, drugs: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>D</strong>rugs (antiplatelet agents, NSAIDs) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.alcohol}
                              onChange={(e) => setHasbledItems(prev => ({...prev, alcohol: e.target.checked}))}
                            />
                            <span className="text-sm"><strong>D</strong> (cont.) Alcohol use (≥8 drinks/week) (+1)</span>
                          </label>
                        </div>

                        <div className="bg-white p-3 rounded border" aria-live="polite" aria-atomic="true">
                          <h4 className="font-semibold text-pink-700 mb-2">Annual Bleeding Risk</h4>
                          <div className="text-sm space-y-1">
                            <p className={calculateHASBLEDScore(hasbledItems) === 0 ? "font-bold text-pink-600" : ""}><strong>Score 0:</strong> 1.13% per year</p>
                            <p className={calculateHASBLEDScore(hasbledItems) === 1 ? "font-bold text-pink-600" : ""}><strong>Score 1:</strong> 1.02% per year</p>
                            <p className={calculateHASBLEDScore(hasbledItems) === 2 ? "font-bold text-pink-600" : ""}><strong>Score 2:</strong> 1.88% per year</p>
                            <p className={calculateHASBLEDScore(hasbledItems) >= 3 ? "font-bold text-pink-600" : ""}><strong>Score ≥3:</strong> 3.74% per year (high risk)</p>
                          </div>
                          <p className="text-xs text-slate-600 mt-2 italic">High risk (≥3) indicates need for more frequent monitoring and caution with anticoagulation, but should not automatically exclude from treatment.</p>
                        </div>
                      </div>
                    </details>

                    {/* ROPE Score */}
                    <details id="calc-rope" style={{ order: getCalculatorOrder('rope', 70) }} className="bg-blue-50 border border-blue-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg flex items-center justify-between">
                        <span>ROPE Score and PASCAL Classification</span>
                        <span className="text-sm font-normal text-blue-600">Score: {calculateROPEScore(ropeItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-blue-600">Score: {calculateROPEScore(ropeItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`ROPE Score: ${calculateROPEScore(ropeItems)}`, 'ROPE Score')}
                          className="p-1.5 hover:bg-blue-100 rounded transition-colors"
                          aria-label="Copy ROPE score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-blue-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-blue-600"
                              checked={ropeItems.noHypertension}
                              onChange={(e) => setRopeItems(prev => ({...prev, noHypertension: e.target.checked}))}
                            />
                            <span className="text-sm">No history of hypertension (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-blue-600"
                              checked={ropeItems.noDiabetes}
                              onChange={(e) => setRopeItems(prev => ({...prev, noDiabetes: e.target.checked}))}
                            />
                            <span className="text-sm">No history of diabetes (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-blue-600"
                              checked={ropeItems.noStrokeTia}
                              onChange={(e) => setRopeItems(prev => ({...prev, noStrokeTia: e.target.checked}))}
                            />
                            <span className="text-sm">No history of stroke or TIA (+1)</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-blue-600"
                              checked={ropeItems.nonsmoker}
                              onChange={(e) => setRopeItems(prev => ({...prev, nonsmoker: e.target.checked}))}
                            />
                            <span className="text-sm">Nonsmoker (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-blue-600"
                              checked={ropeItems.cortical}
                              onChange={(e) => setRopeItems(prev => ({...prev, cortical: e.target.checked}))}
                            />
                            <span className="text-sm">Cortical infarct (+1)</span>
                          </label>
                          <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Age (years)</label>
                            <input 
                              type="number"
                              className="w-full px-3 py-1 border border-slate-300 rounded-md text-sm"
                              value={ropeItems.age}
                              onChange={(e) => setRopeItems(prev => ({...prev, age: e.target.value}))}
                              placeholder="Enter age"
                              min="18"
                              max="100"
                            />
                            <div className="text-xs text-slate-500 mt-1">
                              18-29: +5, 30-39: +4, 40-49: +3, 50-59: +2, 60-69: +1, ≥70: 0
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-3 rounded border" aria-live="polite" aria-atomic="true">
                          <h4 className="font-semibold mb-2">PFO-attributable fraction</h4>
                          <div className="text-sm">
                            <p className={calculateROPEScore(ropeItems) <= 3 ? "font-bold text-blue-600" : ""}><strong>Score 0-3:</strong> 0-23%</p>
                            <p className={calculateROPEScore(ropeItems) === 4 ? "font-bold text-blue-600" : ""}><strong>Score 4:</strong> 38%</p>
                            <p className={calculateROPEScore(ropeItems) === 5 ? "font-bold text-blue-600" : ""}><strong>Score 5:</strong> 34%</p>
                            <p className={calculateROPEScore(ropeItems) === 6 ? "font-bold text-blue-600" : ""}><strong>Score 6:</strong> 62%</p>
                            <p className={calculateROPEScore(ropeItems) === 7 ? "font-bold text-blue-600" : ""}><strong>Score 7:</strong> 72%</p>
                            <p className={calculateROPEScore(ropeItems) === 8 ? "font-bold text-blue-600" : ""}><strong>Score 8:</strong> 84%</p>
                            <p className={calculateROPEScore(ropeItems) >= 9 ? "font-bold text-blue-600" : ""}><strong>Score 9-10:</strong> 88%</p>
                          </div>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">2-Year Recurrent Stroke/TIA Risk</h4>
                          <div className="text-sm">
                            <p className={calculateROPEScore(ropeItems) <= 3 ? "font-bold text-blue-600" : ""}><strong>Score 0-3:</strong> 20%</p>
                            <p className={calculateROPEScore(ropeItems) === 4 ? "font-bold text-blue-600" : ""}><strong>Score 4:</strong> 12%</p>
                            <p className={calculateROPEScore(ropeItems) === 5 ? "font-bold text-blue-600" : ""}><strong>Score 5:</strong> 15%</p>
                            <p className={calculateROPEScore(ropeItems) === 6 ? "font-bold text-blue-600" : ""}><strong>Score 6:</strong> 8%</p>
                            <p className={calculateROPEScore(ropeItems) === 7 ? "font-bold text-blue-600" : ""}><strong>Score 7:</strong> 6%</p>
                            <p className={calculateROPEScore(ropeItems) === 8 ? "font-bold text-blue-600" : ""}><strong>Score 8:</strong> 6%</p>
                            <p className={calculateROPEScore(ropeItems) >= 9 ? "font-bold text-blue-600" : ""}><strong>Score 9-10:</strong> 2%</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* PASCAL Classification */}
                    <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-indigo-800 mb-3">PASCAL Classification (Kent et al., JAHA 2020)</h3>

                      <div className="space-y-4">
                        <div className="bg-white p-3 rounded border border-emerald-300">
                          <h4 className="font-semibold text-emerald-700 mb-2">Definite PFO-related stroke (closure strongly recommended):</h4>
                          <p className="text-sm">RoPE ≥7 + high-risk PFO (large shunt or atrial septal aneurysm)</p>
                        </div>

                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-emerald-600 mb-2">Probable PFO-related stroke (closure reasonable):</h4>
                          <ul className="text-sm space-y-1">
                            <li>• RoPE ≥7 + low-risk PFO (small shunt, no ASA)</li>
                            <li>• RoPE &lt;7 + high-risk PFO (large shunt or ASA)</li>
                          </ul>
                        </div>

                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-amber-700 mb-2">Possible PFO-related stroke (closure uncertain benefit):</h4>
                          <p className="text-sm">RoPE &lt;7 + low-risk PFO, no clear alternative stroke etiology</p>
                        </div>

                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-red-700 mb-2">Unlikely PFO-related stroke (closure not recommended):</h4>
                          <p className="text-sm">Clear alternative stroke etiology identified (AF, LAA, etc.), regardless of PFO features</p>
                        </div>
                      </div>
                      </div>
                    </details>


                    {/* RCVS2 Score */}
                    <details id="calc-rcvs2" style={{ order: getCalculatorOrder('rcvs2', 90) }} className="bg-blue-50 border border-blue-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg flex items-center justify-between">
                        <span>RCVS² Score</span>
                        <span className="text-sm font-normal text-blue-600">Score: {calculateRCVS2Score(rcvs2Items)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-blue-600">Score: {calculateRCVS2Score(rcvs2Items)}</span>
                          <button
                            onClick={() => copyToClipboard(`RCVS² Score: ${calculateRCVS2Score(rcvs2Items)}`, 'RCVS² Score')}
                            className="p-1.5 hover:bg-blue-100 rounded transition-colors"
                            aria-label="Copy RCVS² score to clipboard"
                            title="Copy to clipboard"
                          >
                            <i aria-hidden="true" data-lucide="copy" className="w-4 h-4 text-blue-600"></i>
                          </button>
                        </div>

                        <div className="space-y-2 mb-4">
                          <label className="flex items-center space-x-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-blue-600"
                              checked={rcvs2Items.recurrentTCH}
                              onChange={(e) => setRcvs2Items(prev => ({...prev, recurrentTCH: e.target.checked}))}
                            />
                            <span className="text-sm">Recurrent thunderclap headaches (+5)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-blue-600"
                              checked={rcvs2Items.carotidInvolvement}
                              onChange={(e) => setRcvs2Items(prev => ({...prev, carotidInvolvement: e.target.checked}))}
                            />
                            <span className="text-sm">Intracranial carotid artery involvement (-2)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-blue-600"
                              checked={rcvs2Items.vasoconstrictiveTrigger}
                              onChange={(e) => setRcvs2Items(prev => ({...prev, vasoconstrictiveTrigger: e.target.checked}))}
                            />
                            <span className="text-sm">Vasoconstrictive trigger exposure (+3)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-blue-600"
                              checked={rcvs2Items.female}
                              onChange={(e) => setRcvs2Items(prev => ({...prev, female: e.target.checked}))}
                            />
                            <span className="text-sm">Female sex (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-blue-600"
                              checked={rcvs2Items.sah}
                              onChange={(e) => setRcvs2Items(prev => ({...prev, sah: e.target.checked}))}
                            />
                            <span className="text-sm">Subarachnoid hemorrhage on imaging (+1)</span>
                          </label>
                        </div>

                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-blue-700 mb-2">RCVS Probability</h4>
                          <div className="text-sm space-y-1">
                            <p className={calculateRCVS2Score(rcvs2Items) < 2 ? "font-bold text-blue-600" : ""}><strong>Score &lt;2:</strong> Low probability of RCVS</p>
                            <p className={calculateRCVS2Score(rcvs2Items) >= 2 && calculateRCVS2Score(rcvs2Items) <= 4 ? "font-bold text-blue-600" : ""}><strong>Score 2-4:</strong> Intermediate probability</p>
                            <p className={calculateRCVS2Score(rcvs2Items) >= 5 ? "font-bold text-blue-600" : ""}><strong>Score ≥5:</strong> High probability of RCVS</p>
                          </div>
                          <p className="text-xs text-slate-600 mt-2 italic">RCVS² score helps distinguish RCVS from other causes of thunderclap headache. Consider vascular imaging and repeat imaging in 2-4 weeks if high suspicion.</p>
                        </div>
                      </div>
                    </details>

                    {/* Hunt and Hess Scale / WFNS Scale */}
                    <details id="calc-hunt-hess" style={{ order: getCalculatorOrder('hunt-hess', 80) }} className="bg-amber-50 border border-amber-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-amber-800 hover:bg-amber-100 rounded-lg flex items-center justify-between">
                        <span>Hunt and Hess / WFNS Scale (SAH Grading)</span>
                        <span className="text-sm font-normal text-amber-600">H&H: {huntHessGrade || 'Not Selected'} | WFNS: {wfnsGrade || 'Not Selected'}</span>
                      </summary>
                      <div className="p-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {/* Hunt and Hess Scale */}
                          <div className="space-y-3">
                            <h4 className="text-base font-semibold text-amber-800 mb-2">Hunt and Hess Scale</h4>
                            <div className="space-y-2">
                              {[
                                {v:'1',title:'Grade 1',desc:'Asymptomatic or mild headache'},
                                {v:'2',title:'Grade 2',desc:'Moderate-severe headache, nuchal rigidity, no deficit (except CN palsy)'},
                                {v:'3',title:'Grade 3',desc:'Drowsiness, confusion, or mild focal deficit'},
                                {v:'4',title:'Grade 4',desc:'Stupor, moderate-severe hemiparesis'},
                                {v:'5',title:'Grade 5',desc:'Deep coma, decerebrate rigidity, moribund'}
                              ].map(o => (
                                <button key={o.v} type="button"
                                  className={`w-full text-left p-3 rounded-lg border transition-colors ${huntHessGrade === o.v ? 'bg-amber-600 text-white border-amber-600' : 'bg-white border-amber-200 hover:bg-amber-50 active:bg-amber-100'}`}
                                  onClick={() => setHuntHessGrade(o.v)}
                                >
                                  <div className="font-semibold">{o.title}</div>
                                  <div className={`text-sm ${huntHessGrade === o.v ? 'text-amber-100' : 'text-slate-600'}`}>{o.desc}</div>
                                </button>
                              ))}
                            </div>
                          </div>

                          {/* WFNS Scale */}
                          <div className="space-y-3">
                            <h4 className="text-base font-semibold text-amber-800 mb-2">WFNS Scale</h4>
                            <div className="space-y-2">
                              {[
                                {v:'1',title:'Grade 1',desc:'GCS 15, no motor deficit'},
                                {v:'2',title:'Grade 2',desc:'GCS 13-14, no motor deficit'},
                                {v:'3',title:'Grade 3',desc:'GCS 13-14, with motor deficit'},
                                {v:'4',title:'Grade 4',desc:'GCS 7-12, with or without motor deficit'},
                                {v:'5',title:'Grade 5',desc:'GCS 3-6, with or without motor deficit'}
                              ].map(o => (
                                <button key={o.v} type="button"
                                  className={`w-full text-left p-3 rounded-lg border transition-colors ${wfnsGrade === o.v ? 'bg-amber-600 text-white border-amber-600' : 'bg-white border-amber-200 hover:bg-amber-50 active:bg-amber-100'}`}
                                  onClick={() => setWfnsGrade(o.v)}
                                >
                                  <div className="font-semibold">{o.title}</div>
                                  <div className={`text-sm ${wfnsGrade === o.v ? 'text-amber-100' : 'text-slate-600'}`}>{o.desc}</div>
                                </button>
                              ))}
                            </div>
                          </div>
                        </div>
                      </div>
                    </details>

                    {/* PREVENT 10-year ASCVD Risk */}
                    <details className="bg-red-50 border border-red-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-red-800 hover:bg-red-100 rounded-lg">
                        PREVENT 10-year ASCVD Risk Estimate
                      </summary>
                      <div className="p-4">
                        <div className="bg-white p-4 rounded border">
                        <a 
                          href="https://professional.heart.org/en/guidelines-and-statements/prevent-calculator" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm font-medium"
                        >
                          Open PREVENT Calculator →
                        </a>
                        </div>
                      </div>
                    </details>

                    {/* PHASES Score — Unruptured Aneurysm Rupture Risk */}
                    <details id="calc-phases" style={{ order: getCalculatorOrder('phases', 75) }} className="bg-teal-50 border border-teal-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-teal-800 hover:bg-teal-100 rounded-lg flex items-center justify-between">
                        <span>PHASES Score (Aneurysm Rupture Risk)</span>
                        <span className="text-sm font-normal text-teal-600">Score: {calculatePHASESScore(phasesItems)} — {getPHASESRisk(calculatePHASESScore(phasesItems)).risk} 5-yr risk</span>
                      </summary>
                      <div className="p-4">
                        <p className="text-xs text-slate-600 mb-3">Predicts 5-year absolute risk of rupture for unruptured intracranial aneurysms. Useful for counseling in stroke prevention clinic.</p>
                        <div className="space-y-3">
                          <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Population</label>
                            <select value={phasesItems.population}
                              onChange={(e) => setPhasesItems(prev => ({...prev, population: e.target.value}))}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                              <option value="north_american">North American / European (0 pts)</option>
                              <option value="japanese">Japanese (+3 pts)</option>
                              <option value="finnish">Finnish (+5 pts)</option>
                            </select>
                          </div>
                          <label className="flex items-center space-x-2">
                            <input type="checkbox" className="text-teal-600"
                              checked={phasesItems.hypertension}
                              onChange={(e) => setPhasesItems(prev => ({...prev, hypertension: e.target.checked}))} />
                            <span className="text-sm">History of hypertension (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input type="checkbox" className="text-teal-600"
                              checked={phasesItems.age70}
                              onChange={(e) => setPhasesItems(prev => ({...prev, age70: e.target.checked}))} />
                            <span className="text-sm">Age ≥70 years (+1)</span>
                          </label>
                          <div>
                            <label htmlFor="input-phases-size" className="block text-sm font-medium text-slate-700 mb-1">Aneurysm size (mm)</label>
                            <input id="input-phases-size" type="number" step="0.1" min="0" max="50"
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm"
                              value={phasesItems.size}
                              onChange={(e) => setPhasesItems(prev => ({...prev, size: e.target.value}))}
                              placeholder="Largest diameter in mm" />
                            <div className="text-xs text-slate-500 mt-1">&lt;7mm: 0 pts | 7-9.9mm: +3 | 10-19.9mm: +6 | ≥20mm: +10</div>
                          </div>
                          <label className="flex items-center space-x-2">
                            <input type="checkbox" className="text-teal-600"
                              checked={phasesItems.earlierSAH}
                              onChange={(e) => setPhasesItems(prev => ({...prev, earlierSAH: e.target.checked}))} />
                            <span className="text-sm">Earlier SAH from a different aneurysm (+1)</span>
                          </label>
                          <div>
                            <label htmlFor="input-phases-site" className="block text-sm font-medium text-slate-700 mb-1">Aneurysm site</label>
                            <select id="input-phases-site" value={phasesItems.site}
                              onChange={(e) => setPhasesItems(prev => ({...prev, site: e.target.value}))}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                              <option value="ica">ICA (0 pts)</option>
                              <option value="mca">MCA (+2 pts)</option>
                              <option value="aca_pcomm_posterior">ACA / Pcomm / Posterior circulation (+4 pts)</option>
                            </select>
                          </div>
                        </div>
                        {(() => {
                          const score = calculatePHASESScore(phasesItems);
                          const { risk, level } = getPHASESRisk(score);
                          const colorClass = score <= 4 ? 'bg-emerald-100 border-emerald-300 text-emerald-800'
                            : score <= 8 ? 'bg-amber-100 border-amber-300 text-amber-800'
                            : 'bg-red-100 border-red-300 text-red-800';
                          return (
                            <div className={`mt-3 p-3 rounded-lg border ${colorClass}`} aria-live="polite" aria-atomic="true">
                              <p className="font-bold">PHASES Score: {score} — {level}</p>
                              <p className="text-sm">5-year absolute rupture risk: <strong>{risk}</strong></p>
                              <button onClick={() => copyToClipboard(`PHASES Score: ${score}, 5-year rupture risk: ${risk} (${level})`, 'PHASES Score')}
                                className="mt-1 px-2 py-1 bg-white/60 rounded text-xs hover:bg-white/80" aria-label="Copy PHASES score to clipboard">Copy</button>
                            </div>
                          );
                        })()}
                        <div className="mt-2 text-xs text-slate-500">
                          <p>Greving JP et al. <em>Lancet Neurol</em> 2014;13(1):59-66. PHASES: Population, Hypertension, Age, Size, Earlier SAH, Site.</p>
                          <p className="mt-1">Note: PHASES score should be one factor in the treatment decision. Consider patient life expectancy, aneurysm morphology, family history, and patient preference.</p>
                        </div>
                      </div>
                    </details>

                    {/* ICH Volume Calculator (ABC/2) */}
                    <details id="calc-ich-volume" style={{ order: getCalculatorOrder('ich-volume', 21) }} className="bg-red-50 border border-red-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-red-800 hover:bg-red-100 rounded-lg flex items-center justify-between">
                        <span>ICH Volume Calculator (ABC/2 Method)</span>
                      </summary>
                      <div className="p-4">
                        <div className="grid grid-cols-3 gap-3 mb-3">
                          <div>
                            <label className="text-xs text-slate-600">A: Largest diameter (cm)</label>
                            <input type="number" step="0.1" min="0" max="30" value={(telestrokeNote.ichVolumeCalc || {}).lengthCm || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichVolumeCalc: {...(prev.ichVolumeCalc || {}), lengthCm: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="cm" />
                          </div>
                          <div>
                            <label className="text-xs text-slate-600">B: Perpendicular diameter (cm)</label>
                            <input type="number" step="0.1" min="0" max="30" value={(telestrokeNote.ichVolumeCalc || {}).widthCm || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichVolumeCalc: {...(prev.ichVolumeCalc || {}), widthCm: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="cm" />
                          </div>
                          <div>
                            <label className="text-xs text-slate-600">C: Slices x thickness (cm)</label>
                            <input type="number" step="0.1" min="0" max="30" value={(telestrokeNote.ichVolumeCalc || {}).slicesCm || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, ichVolumeCalc: {...(prev.ichVolumeCalc || {}), slicesCm: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="cm" />
                          </div>
                        </div>
                        {(() => {
                          const ichCalcInput = telestrokeNote.ichVolumeCalc || {};
                          const result = calculateICHVolume(ichCalcInput);
                          if (!result || !result.volume) {
                            const hasAnyInput = ichCalcInput.lengthCm || ichCalcInput.widthCm || ichCalcInput.slicesCm;
                            return hasAnyInput
                              ? <p className="text-xs text-amber-600 italic">Enter all three dimensions (A, B, C) to calculate volume.</p>
                              : <p className="text-xs text-slate-500 italic">Enter A, B, and C measurements from CT to calculate ICH volume.</p>;
                          }
                          return (
                            <div className={`p-3 rounded-lg border ${result.isLarge ? 'bg-red-100 border-red-300' : 'bg-emerald-100 border-emerald-300'}`}>
                              <p className="text-lg font-bold">Volume: {result.volume} mL</p>
                              <p className="text-sm text-slate-700">
                                {result.volume >= 60 ? 'Very large hematoma — poor prognosis, consider GOC discussion' :
                                 result.volume >= 30 ? 'Large hematoma (30-80 mL) — may qualify for ENRICH MIE' :
                                 result.volume >= 20 ? 'Moderate hematoma — monitor for expansion' :
                                 'Small hematoma'}
                              </p>
                              <button onClick={() => copyToClipboard(`ICH Volume (ABC/2): ${result.volume} mL`, 'ICH Volume')}
                                className="mt-1 px-2 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300" aria-label="Copy ICH volume to clipboard">Copy</button>
                            </div>
                          );
                        })()}
                        <p className="text-xs text-slate-500 mt-2">ABC/2 method: A = largest diameter, B = perpendicular diameter on same slice, C = number of slices with ICH x slice thickness.</p>
                      </div>
                    </details>

                    {/* Andexanet Alfa Dosing Calculator */}
                    <details id="calc-andexanet" style={{ order: getCalculatorOrder('andexanet', 36) }} className="bg-purple-50 border border-purple-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg flex items-center justify-between">
                        <span>Andexanet Alfa (Andexxa) Dosing</span>
                      </summary>
                      <div className="p-4">
                        <div className="grid grid-cols-2 gap-3 mb-3">
                          <div>
                            <label className="text-xs text-slate-600">DOAC Type</label>
                            <select value={(telestrokeNote.andexanetCalc || {}).doacType || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, andexanetCalc: {...(prev.andexanetCalc || {}), doacType: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                              <option value="">Select DOAC</option>
                              <option value="apixaban">Apixaban (Eliquis)</option>
                              <option value="rivaroxaban">Rivaroxaban (Xarelto)</option>
                              <option value="other">Other (not indicated for andexanet)</option>
                            </select>
                          </div>
                          <div>
                            <label className="text-xs text-slate-600">Hours since last DOAC dose</label>
                            <input type="number" step="0.5" min="0" max="240" value={(telestrokeNote.andexanetCalc || {}).lastDoseHours || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, andexanetCalc: {...(prev.andexanetCalc || {}), lastDoseHours: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="hours" />
                          </div>
                        </div>
                        <div className="mb-3">
                          <label className="text-xs text-slate-600">DOAC dose (mg per dose)</label>
                          <input type="number" step="0.5" min="0" max="60" value={(telestrokeNote.andexanetCalc || {}).doacDoseMg || ''}
                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, andexanetCalc: {...(prev.andexanetCalc || {}), doacDoseMg: v}})); }}
                            className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="e.g. 5 for apixaban 5mg BID" />
                        </div>
                        {(() => {
                          const result = calculateAndexanetDose(
                            (telestrokeNote.andexanetCalc || {}).doacType,
                            (telestrokeNote.andexanetCalc || {}).lastDoseHours,
                            (telestrokeNote.andexanetCalc || {}).doacDoseMg
                          );
                          if (result.regimen === 'N/A') return (
                            <p className="text-sm text-slate-500">Select apixaban or rivaroxaban. Andexanet not indicated for dabigatran (use idarucizumab) or edoxaban.</p>
                          );
                          return (
                            <div className={`p-3 rounded-lg border ${result.regimen === 'high-dose' ? 'bg-red-100 border-red-300' : 'bg-emerald-100 border-emerald-300'}`}>
                              <p className="text-sm font-bold uppercase">{result.regimen} regimen</p>
                              <p className="text-sm">Bolus: {result.bolus}</p>
                              <p className="text-sm">Infusion: {result.infusion}</p>
                              <p className="text-sm font-semibold">Total: {result.total}</p>
                              {result.doseWarning && (
                                <p className="text-xs text-amber-700 mt-1 bg-amber-50 border border-amber-200 rounded p-1">{result.doseWarning}</p>
                              )}
                              <button onClick={() => copyToClipboard(`Andexanet ${result.regimen}: Bolus ${result.bolus}, Infusion ${result.infusion}, Total ${result.total}`, 'Andexanet Dose')}
                                className="mt-1 px-2 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300" aria-label="Copy andexanet dose to clipboard">Copy</button>
                            </div>
                          );
                        })()}
                        <div className="mt-2 p-2 bg-amber-50 border border-amber-200 rounded text-xs text-amber-800">
                          <strong>Practice note:</strong> First-line Xa inhibitor reversal is 4F-PCC (Kcentra) 2000 units IVPB. AHA/ASA 2022 ICH Guidelines list andexanet alfa as Class IIa ("reasonable") for Xa inhibitor-associated ICH. Consider andexanet if PCC unavailable, ineffective, or contraindicated. Monitor for thrombotic events (11% in ANNEXA-4).
                        </div>
                        <p className="text-xs text-slate-500 mt-1">ANNEXA-4 trial. Low-dose if last DOAC &ge;8h ago (or apixaban &le;5mg). High-dose if last dose &lt;8h ago (or rivaroxaban &gt;10mg, apixaban &gt;5mg). Monitor for thrombotic events post-reversal.</p>
                      </div>
                    </details>

                    {/* Cockcroft-Gault CrCl Calculator */}
                    <details id="calc-crcl" style={{ order: getCalculatorOrder('crcl', 35) }} className="bg-indigo-50 border border-indigo-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-indigo-800 hover:bg-indigo-100 rounded-lg flex items-center justify-between">
                        <span>Creatinine Clearance (Cockcroft-Gault)</span>
                        {(telestrokeNote.age && telestrokeNote.weight && telestrokeNote.creatinine && !(telestrokeNote.crclCalc || {}).age) && (
                          <span className="text-xs bg-indigo-200 text-indigo-800 px-2 py-0.5 rounded-full font-normal">Auto-filled from patient data</span>
                        )}
                      </summary>
                      <div className="p-4">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                          <div>
                            <label className="text-xs text-slate-600">Age</label>
                            <input type="number" min="18" max="120" value={(telestrokeNote.crclCalc || {}).age || telestrokeNote.age || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, crclCalc: {...(prev.crclCalc || {}), age: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="years" />
                          </div>
                          <div>
                            <label className="text-xs text-slate-600">Weight (kg)</label>
                            <input type="number" min="20" max="350" value={(telestrokeNote.crclCalc || {}).weight || telestrokeNote.weight || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, crclCalc: {...(prev.crclCalc || {}), weight: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="kg" />
                          </div>
                          <div>
                            <label className="text-xs text-slate-600">Sex</label>
                            <select value={(telestrokeNote.crclCalc || {}).sex || telestrokeNote.sex || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, crclCalc: {...(prev.crclCalc || {}), sex: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm">
                              <option value="">Select</option>
                              <option value="M">Male</option>
                              <option value="F">Female</option>
                            </select>
                          </div>
                          <div>
                            <label className="text-xs text-slate-600">Serum Cr (mg/dL)</label>
                            <input type="number" step="0.1" min="0.1" max="20" value={(telestrokeNote.crclCalc || {}).cr || telestrokeNote.creatinine || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, crclCalc: {...(prev.crclCalc || {}), cr: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="mg/dL" />
                          </div>
                        </div>
                        <div className="mb-3">
                          <label className="text-xs text-slate-600">Height (cm) — for obesity-adjusted CrCl</label>
                          <input type="number" min="100" max="250" step="1" value={(telestrokeNote.crclCalc || {}).height || telestrokeNote.height || ''}
                            onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, crclCalc: {...(prev.crclCalc || {}), height: v}})); }}
                            className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="cm (optional — enables BMI/AdjBW calculation)" />
                        </div>
                        {(() => {
                          const result = calculateCrCl(
                            (telestrokeNote.crclCalc || {}).age || telestrokeNote.age,
                            (telestrokeNote.crclCalc || {}).weight || telestrokeNote.weight,
                            (telestrokeNote.crclCalc || {}).sex || telestrokeNote.sex,
                            (telestrokeNote.crclCalc || {}).cr || telestrokeNote.creatinine,
                            (telestrokeNote.crclCalc || {}).height || telestrokeNote.height
                          );
                          if (!result) return <p className="text-xs text-slate-500 italic">Enter age, weight, sex, and creatinine to calculate.</p>;
                          const colorClass = result.isLow ? 'bg-red-100 border-red-300' : result.isBorderline ? 'bg-amber-100 border-amber-300' : 'bg-emerald-100 border-emerald-300';
                          return (
                            <div className={`p-3 rounded-lg border ${colorClass}`}>
                              <p className="text-lg font-bold">CrCl: {result.value} mL/min</p>
                              {result.adjBwValue && <p className="text-sm font-bold text-amber-800">Adjusted Body Weight CrCl: {result.adjBwValue} mL/min (BMI {result.bmi})</p>}
                              <p className="text-sm font-medium">{result.label}</p>
                              {result.obesityWarning && <p className="text-xs mt-1 text-amber-700 font-medium">{result.obesityWarning}</p>}
                              <div className="mt-2 text-xs space-y-1">
                                {result.renalCategory === 'severe-dialysis' && <p className="text-red-700 font-semibold">Avoid DOACs. Consider warfarin or consult nephrology.</p>}
                                {result.renalCategory === 'severe' && (
                                  <div className="text-red-700">
                                    <p><strong>Apixaban:</strong> 5mg BID (2.5mg BID if also age ≥80 or wt ≤60kg). Apixaban is the only DOAC with data in ESRD.</p>
                                    <p><strong>Rivaroxaban:</strong> 15mg daily (avoid if CrCl &lt;15).</p>
                                    <p><strong>Dabigatran:</strong> 75mg BID (avoid if CrCl &lt;15). Idarucizumab available for reversal.</p>
                                    <p><strong>Edoxaban:</strong> 30mg daily (avoid if CrCl &lt;15).</p>
                                    <p><strong>Enoxaparin:</strong> 1 mg/kg SC <strong>daily</strong> (not BID). Check anti-Xa levels.</p>
                                  </div>
                                )}
                                {result.renalCategory === 'moderate' && (
                                  <div className="text-amber-700">
                                    <p><strong>Apixaban:</strong> Standard 5mg BID (2.5mg BID if 2 of 3: age ≥80, wt ≤60kg, Cr ≥1.5).</p>
                                    <p><strong>Rivaroxaban:</strong> 15mg daily for AF (20mg if CrCl &gt;50).</p>
                                    <p><strong>Dabigatran:</strong> 150mg BID (standard). 75mg BID if CrCl 15-30 mL/min per FDA. Contraindicated if CrCl &lt;15.</p>
                                    <p><strong>Edoxaban:</strong> 30mg daily.</p>
                                    <p><strong>Enoxaparin:</strong> Standard dosing; monitor anti-Xa if prolonged use.</p>
                                  </div>
                                )}
                                {(result.renalCategory === 'mild' || result.renalCategory === 'normal') && (
                                  <p className="text-emerald-700">Standard DOAC and enoxaparin dosing. No renal adjustment needed. {result.renalCategory === 'normal' && 'Note: Edoxaban 60mg — avoid if CrCl >95 (reduced efficacy, ENGAGE AF).'}</p>
                                )}
                              </div>
                              {result.obesityWarning && (
                                <p className="text-amber-700 text-xs mt-1 bg-amber-50 p-1 rounded border border-amber-200">{result.obesityWarning}</p>
                              )}
                              <button onClick={() => copyToClipboard(`CrCl (Cockcroft-Gault): ${result.value} mL/min — ${result.label}`, 'CrCl')}
                                className="mt-2 px-2 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300" aria-label="Copy CrCl to clipboard">Copy</button>
                            </div>
                          );
                        })()}
                        <p className="text-xs text-slate-500 mt-2">Cockcroft-Gault: CrCl = [(140 - age) × weight × (0.85 if female)] / (72 × Cr). Uses actual body weight. For obesity, consider adjusted body weight or cystatin C-based eGFR.</p>
                      </div>
                    </details>

                    {/* Weight-Based Enoxaparin Dosing */}
                    <details id="calc-enoxaparin" style={{ order: getCalculatorOrder('enoxaparin', 37) }} className="bg-blue-50 border border-blue-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg flex items-center justify-between">
                        <span>Enoxaparin Weight-Based Dosing</span>
                        {(telestrokeNote.weight && !(telestrokeNote.enoxCalc || {}).weightKg) && (
                          <span className="text-xs bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full font-normal">Auto-filled from patient data</span>
                        )}
                      </summary>
                      <div className="p-4">
                        <div className="grid grid-cols-2 gap-3 mb-3">
                          <div>
                            <label className="text-xs text-slate-600">Weight (kg)</label>
                            <input type="number" min="20" max="350" value={(telestrokeNote.enoxCalc || {}).weightKg || telestrokeNote.weight || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, enoxCalc: {...(prev.enoxCalc || {}), weightKg: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="kg" />
                          </div>
                          <div>
                            <label className="text-xs text-slate-600">CrCl (mL/min)</label>
                            <input type="number" value={(telestrokeNote.enoxCalc || {}).crCl || (() => { const c = calculateCrCl(telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.height); return c ? c.value : ''; })() || ''}
                              onChange={(e) => { const v = e.target.value; setTelestrokeNote(prev => ({...prev, enoxCalc: {...(prev.enoxCalc || {}), crCl: v}})); }}
                              className="w-full px-2 py-1 border border-slate-300 rounded text-sm" placeholder="mL/min (auto from demographics)" />
                          </div>
                        </div>
                        {(() => {
                          const autoCrCl = calculateCrCl(telestrokeNote.age, telestrokeNote.weight, telestrokeNote.sex, telestrokeNote.creatinine, telestrokeNote.height);
                          const result = calculateEnoxaparinDose(
                            (telestrokeNote.enoxCalc || {}).weightKg || telestrokeNote.weight,
                            (telestrokeNote.enoxCalc || {}).crCl || (autoCrCl ? autoCrCl.value : '')
                          );
                          if (!result) return null;
                          return (
                            <div className={`p-3 rounded-lg border ${result.isRenalAdjusted ? 'bg-amber-100 border-amber-300' : 'bg-emerald-100 border-emerald-300'}`}>
                              <p className="text-sm font-bold">{result.note}</p>
                              {!result.isRenalAdjusted && <p className="text-sm text-slate-600 mt-0.5">{result.dailyTreatmentNote}</p>}
                              <p className="text-sm font-semibold text-teal-700 mt-1">{result.prophylaxisNote}</p>
                              {result.isRenalAdjusted && <p className="text-xs text-amber-700">Renal dose adjustment applied (CrCl &lt;30 mL/min)</p>}
                              <button onClick={() => copyToClipboard(`${result.note}\n${result.dailyTreatmentNote}\n${result.prophylaxisNote}`, 'Enoxaparin Dose')}
                                className="mt-1 px-2 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300" aria-label="Copy enoxaparin dose to clipboard">Copy</button>
                            </div>
                          );
                        })()}
                        <p className="text-xs text-slate-500 mt-2">Treatment: 1 mg/kg SC BID (standard) or 1.5 mg/kg SC daily (alternative). CrCl &lt;30: 1 mg/kg SC daily. Prophylaxis: 40 mg SC daily (30 mg if CrCl &lt;30). Check anti-Xa for extremes of weight.</p>
                      </div>
                    </details>

                    {/* ASPECTS Interactive Scorer */}
                    <details id="calc-aspects" style={{ order: getCalculatorOrder('aspects', 15) }} className="bg-blue-50 border border-blue-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg flex items-center justify-between">
                        <span>ASPECTS Score (Interactive)</span>
                        <span className="text-sm font-normal text-blue-600">Score: {10 - Object.values(typeof aspectsRegions !== 'undefined' ? aspectsRegions : {}).filter(Boolean).length}/10</span>
                      </summary>
                      <div className="p-4">
                        <p className="text-xs text-slate-600 mb-3">Click regions with <strong>early ischemic changes</strong> on CT. ASPECTS = 10 minus number of affected regions.</p>
                        <div className="grid grid-cols-5 gap-2 mb-3">
                          {[
                            { id: 'C', label: 'C', desc: 'Caudate' },
                            { id: 'L', label: 'L', desc: 'Lentiform' },
                            { id: 'IC', label: 'IC', desc: 'Internal Capsule' },
                            { id: 'I', label: 'I', desc: 'Insular Ribbon' },
                            { id: 'M1', label: 'M1', desc: 'Anterior MCA' },
                            { id: 'M2', label: 'M2', desc: 'MCA lateral to insular ribbon' },
                            { id: 'M3', label: 'M3', desc: 'Posterior MCA' },
                            { id: 'M4', label: 'M4', desc: 'Anterior MCA above M1' },
                            { id: 'M5', label: 'M5', desc: 'Lateral MCA above M2' },
                            { id: 'M6', label: 'M6', desc: 'Posterior MCA above M3' }
                          ].map(region => {
                            const isAffected = !!(telestrokeNote.aspectsRegions || {})[region.id];
                            return (
                              <button key={region.id} type="button"
                                className={`flex flex-col items-center p-2 rounded-lg border-2 transition-colors text-center ${isAffected ? 'bg-red-600 text-white border-red-600' : 'bg-white border-slate-200 hover:bg-blue-50 hover:border-blue-300'}`}
                                onClick={() => {
                                  const rid = region.id, toggled = !isAffected;
                                  setTelestrokeNote(prev => {
                                    const newRegions = {...(prev.aspectsRegions || {}), [rid]: toggled};
                                    return {...prev, aspectsRegions: newRegions};
                                  });
                                  const newRegions = {...(telestrokeNote.aspectsRegions || {}), [region.id]: !isAffected};
                                  const score = 10 - Object.values(newRegions).filter(Boolean).length;
                                  if (typeof setAspectsScore === 'function') setAspectsScore(score);
                                  // Sync to calculator drawer state (array format: checked=true means normal)
                                  setAspectsRegionState(prev => prev.map(r => r.id === region.id ? {...r, checked: isAffected} : r));
                                }}
                                title={region.desc}
                              >
                                <span className="font-bold text-sm">{region.label}</span>
                                <span className={`text-[10px] ${isAffected ? 'text-white/70' : 'text-slate-500'}`}>{region.desc}</span>
                              </button>
                            );
                          })}
                        </div>
                        {(() => {
                          const score = 10 - Object.values(telestrokeNote.aspectsRegions || {}).filter(Boolean).length;
                          const colorMap = score >= 6 ? { bg: 'bg-emerald-50 border-emerald-200', text: 'text-emerald-700' } : score >= 3 ? { bg: 'bg-amber-50 border-amber-200', text: 'text-amber-700' } : { bg: 'bg-red-50 border-red-200', text: 'text-red-700' };
                          return (
                            <div className={`p-3 rounded-lg border ${colorMap.bg}`} aria-live="polite" aria-atomic="true">
                              <div className="flex items-center justify-between">
                                <span className={`text-2xl font-bold ${colorMap.text}`}>ASPECTS: {score}</span>
                                <span className={`text-sm font-semibold ${colorMap.text}`}>
                                  {score >= 6 ? 'Favorable for EVT' : score >= 3 ? 'Large core — EVT may be considered' : 'Very large core — EVT uncertain'}
                                </span>
                              </div>
                              <div className="mt-1 text-xs text-slate-600">
                                {score >= 6 ? 'ASPECTS 6-10: Standard EVT candidacy (Class I for LVO 0-6h)' :
                                 score >= 3 ? 'ASPECTS 3-5: EVT recommended for select patients (mRS 0-1, 0-6h)' :
                                 'ASPECTS 0-2: EVT may be reasonable in select patients (ICA/M1, mRS 0-1)'}
                              </div>
                            </div>
                          );
                        })()}
                        <button type="button" onClick={() => { setTelestrokeNote(prev => ({...prev, aspectsRegions: {}})); if (typeof setAspectsScore === 'function') setAspectsScore(10); setAspectsRegionState(getDefaultAspectsRegionState()); }}
                          className="mt-2 text-xs text-slate-500 hover:text-slate-700 underline">Reset all regions</button>
                      </div>
                    </details>

                    {/* PC-ASPECTS Calculator */}
                    <details id="calc-pc-aspects" style={{ order: getCalculatorOrder('pc-aspects', 16) }} className="bg-blue-50 border border-blue-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg flex items-center justify-between">
                        <span>PC-ASPECTS (Posterior Circulation)</span>
                        <span className="text-sm font-normal text-blue-600">Score: {(() => { const r = telestrokeNote.pcAspectsRegions || {}; return 10 - ((r.pons ? 2 : 0) + (r.midbrain ? 2 : 0) + (r.cerebL ? 1 : 0) + (r.cerebR ? 1 : 0) + (r.pcaL ? 1 : 0) + (r.pcaR ? 1 : 0) + (r.thalL ? 1 : 0) + (r.thalR ? 1 : 0)); })()}/10</span>
                      </summary>
                      <div className="p-4">
                        <p className="text-xs text-slate-600 mb-3">Click regions with early ischemic changes. Used for basilar artery EVT eligibility (≥6 favors intervention).</p>
                        <div className="grid grid-cols-4 gap-2 mb-3">
                          {[
                            { id: 'pons', label: 'Pons', pts: 2 },
                            { id: 'midbrain', label: 'Midbrain', pts: 2 },
                            { id: 'cerebL', label: 'Cerebellum L', pts: 1 },
                            { id: 'cerebR', label: 'Cerebellum R', pts: 1 },
                            { id: 'pcaL', label: 'PCA L', pts: 1 },
                            { id: 'pcaR', label: 'PCA R', pts: 1 },
                            { id: 'thalL', label: 'Thalamus L', pts: 1 },
                            { id: 'thalR', label: 'Thalamus R', pts: 1 }
                          ].map(region => {
                            const isAffected = !!(telestrokeNote.pcAspectsRegions || {})[region.id];
                            return (
                              <button key={region.id} type="button"
                                className={`flex flex-col items-center p-2 rounded-lg border-2 transition-colors ${isAffected ? 'bg-red-600 text-white border-red-600' : 'bg-white border-slate-200 hover:bg-blue-50'}`}
                                onClick={() => { const rid = region.id, toggled = !isAffected; setTelestrokeNote(prev => ({...prev, pcAspectsRegions: {...(prev.pcAspectsRegions || {}), [rid]: toggled}})); }}
                              >
                                <span className="font-bold text-xs">{region.label}</span>
                                <span className={`text-[10px] ${isAffected ? 'text-white/70' : 'text-slate-500'}`}>{region.pts}pt{region.pts > 1 ? 's' : ''}</span>
                              </button>
                            );
                          })}
                        </div>
                        {(() => {
                          const r = telestrokeNote.pcAspectsRegions || {};
                          const deducted = (r.pons ? 2 : 0) + (r.midbrain ? 2 : 0) + (r.cerebL ? 1 : 0) + (r.cerebR ? 1 : 0) + (r.pcaL ? 1 : 0) + (r.pcaR ? 1 : 0) + (r.thalL ? 1 : 0) + (r.thalR ? 1 : 0);
                          const score = 10 - deducted;
                          return (
                            <div className={`p-3 rounded-lg ${score >= 6 ? 'bg-emerald-50 border border-emerald-200' : 'bg-red-50 border border-red-200'}`} aria-live="polite" aria-atomic="true">
                              <span className={`text-2xl font-bold ${score >= 6 ? 'text-emerald-700' : 'text-red-700'}`}>PC-ASPECTS: {score}</span>
                              <span className={`ml-2 text-sm ${score >= 6 ? 'text-emerald-600' : 'text-red-600'}`}>
                                {score >= 6 ? 'Favorable for basilar EVT (ATTENTION/BAOCHE trials)' : 'Poor prognosis — EVT benefit uncertain'}
                              </span>
                            </div>
                          );
                        })()}
                      </div>
                    </details>

                    {/* Alteplase (tPA) Dosing Calculator */}
                    <details id="calc-alteplase" style={{ order: getCalculatorOrder('alteplase', 24) }} className="bg-violet-50 border border-violet-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-violet-800 hover:bg-violet-100 rounded-lg flex items-center justify-between">
                        <span>Alteplase (tPA) Dosing Calculator</span>
                        <span className="text-xs font-normal text-violet-600">0.9 mg/kg, max 90 mg</span>
                      </summary>
                      <div className="p-4">
                        {(() => {
                          const wt = parseFloat(telestrokeNote.weight) || 0;
                          const alt = wt > 0 ? calculateAlteplaseDose(wt) : null;
                          return alt ? (
                            <div className="space-y-3">
                              <div className="grid grid-cols-3 gap-3 text-center">
                                <div className="bg-violet-100 p-3 rounded-lg">
                                  <div className="text-2xl font-black text-violet-900">{alt.bolus}</div>
                                  <div className="text-xs text-violet-700">mg Bolus (10%)</div>
                                  <div className="text-xs text-violet-600">over 1 min</div>
                                </div>
                                <div className="bg-violet-100 p-3 rounded-lg">
                                  <div className="text-2xl font-black text-violet-900">{alt.infusion}</div>
                                  <div className="text-xs text-violet-700">mg Infusion (90%)</div>
                                  <div className="text-xs text-violet-600">over 60 min</div>
                                </div>
                                <div className="bg-violet-100 p-3 rounded-lg">
                                  <div className="text-2xl font-black text-violet-900">{alt.totalDose}</div>
                                  <div className="text-xs text-violet-700">mg Total</div>
                                  {alt.capped && <div className="text-xs text-amber-600 font-bold">MAX DOSE</div>}
                                </div>
                              </div>
                              <p className="text-xs text-slate-500 text-center">{wt} kg × 0.9 mg/kg = {(wt * 0.9).toFixed(1)} mg{alt.capped ? ' → capped at 90 mg' : ''}</p>
                              <button onClick={() => copyToClipboard(`Alteplase: ${alt.totalDose} mg total (${alt.bolus} mg bolus IV over 1 min + ${alt.infusion} mg infusion over 60 min)`, 'Alteplase dose')}
                                className="w-full px-2 py-1 bg-violet-200 rounded text-xs hover:bg-violet-300" aria-label="Copy alteplase dose">Copy Dose</button>
                            </div>
                          ) : (
                            <p className="text-sm text-amber-600">Enter patient weight in the encounter section to calculate dose.</p>
                          );
                        })()}
                      </div>
                    </details>

                    {/* SPAN-100 / DRAGON / sICH Risk */}
                    <details id="calc-risk-scores" style={{ order: getCalculatorOrder('risk-scores', 25) }} className="bg-amber-50 border border-amber-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-amber-800 hover:bg-amber-100 rounded-lg flex items-center justify-between">
                        <span>Thrombolysis Risk Scores (SPAN-100, DRAGON, SEDAN)</span>
                        <span className="text-sm font-normal text-amber-600">sICH Risk Assessment</span>
                      </summary>
                      <div className="p-4 space-y-4">
                        {/* SPAN-100 */}
                        <div className="bg-white rounded-lg p-3 border border-slate-200">
                          <h5 className="font-semibold text-sm text-slate-800 mb-2">SPAN-100 Index</h5>
                          <p className="text-xs text-slate-700 mb-2">Age + NIHSS ≥ 100 predicts higher symptomatic ICH risk and lower chance of good outcome after IV thrombolysis.</p>
                          {(() => {
                            const age = parseInt(telestrokeNote.age, 10) || 0;
                            const nihss = parseInt(telestrokeNote.nihss || nihssScore, 10) || 0;
                            const span = age + nihss;
                            const positive = span >= 100;
                            return (
                              <div className={`p-3 rounded-lg ${positive ? 'bg-red-50 border border-red-200' : 'bg-emerald-50 border border-emerald-200'}`} aria-live="polite" aria-atomic="true">
                                <div className="flex items-center justify-between">
                                  <span className={`text-xl font-bold ${positive ? 'text-red-700' : 'text-emerald-700'}`}>
                                    Age ({age || '?'}) + NIHSS ({nihss || '?'}) = {age && nihss ? span : '?'}
                                  </span>
                                  <span className={`px-2 py-1 rounded text-xs font-bold ${positive ? 'bg-red-600 text-white' : 'bg-emerald-600 text-white'}`}>
                                    {positive ? 'POSITIVE — Higher sICH Risk' : 'NEGATIVE — Lower Risk'}
                                  </span>
                                </div>
                              </div>
                            );
                          })()}
                        </div>

                        {/* SEDAN Score */}
                        <div className="bg-white rounded-lg p-3 border border-slate-200">
                          <h5 className="font-semibold text-sm text-slate-800 mb-2">SEDAN Score (sICH Risk Post-Thrombolysis)</h5>
                          <p className="text-xs text-slate-500 mb-2">Sugar + Early infarct signs + Dense artery + Age + NIHSS</p>
                          {(() => {
                            const glucose = parseInt(telestrokeNote.glucose, 10) || 0;
                            const nihss = parseInt(telestrokeNote.nihss || nihssScore, 10) || 0;
                            const age = parseInt(telestrokeNote.age, 10) || 0;
                            let sedanScore = 0;
                            const items = [];
                            if (glucose > 144 && glucose <= 216) { sedanScore += 1; items.push('Glucose 145-216 (+1)'); }
                            else if (glucose > 216) { sedanScore += 2; items.push('Glucose >216 (+2)'); }
                            else items.push('Glucose ≤144 (0)');
                            if (telestrokeNote.earlyInfarctSigns) { sedanScore += 1; items.push('Early infarct signs on CT (+1) ✓'); }
                            else items.push('Early infarct signs on CT (0) — set in Treatment Decision section');
                            if (telestrokeNote.denseArterySign) { sedanScore += 1; items.push('Dense artery sign (+1) ✓'); }
                            else items.push('Dense artery sign (0) — set in Treatment Decision section');
                            if (age > 75) { sedanScore += 1; items.push('Age >75 (+1)'); }
                            else items.push('Age ≤75 (0)');
                            if (nihss >= 10) { sedanScore += 1; items.push('NIHSS ≥10 (+1)'); }
                            else items.push('NIHSS <10 (0)');
                            const risk = sedanScore === 0 ? '~1%' : sedanScore === 1 ? '~3%' : sedanScore === 2 ? '~5%' : sedanScore === 3 ? '~9%' : sedanScore === 4 ? '~16%' : '~28%+';
                            return (
                              <div>
                                <div className="space-y-1 mb-2">
                                  {items.map((item, i) => (
                                    <div key={i} className="text-xs text-slate-600 flex items-center gap-2">
                                      <span className="text-amber-500">&#x2022;</span> {item}
                                    </div>
                                  ))}
                                </div>
                                <div className={`p-2 rounded ${sedanScore >= 3 ? 'bg-red-50 border border-red-200' : 'bg-amber-50 border border-amber-200'}`} aria-live="polite" aria-atomic="true">
                                  <span className="font-bold text-sm">SEDAN: {sedanScore}/6</span>
                                  <span className="ml-2 text-xs text-slate-600">Estimated sICH risk: {risk}</span>
                                </div>
                              </div>
                            );
                          })()}
                        </div>
                      </div>
                    </details>

                    {/* TICI Reperfusion Score */}
                    <details id="calc-tici" style={{ order: getCalculatorOrder('tici', 18) }} className="bg-emerald-50 border border-emerald-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-emerald-800 hover:bg-emerald-100 rounded-lg flex items-center justify-between">
                        <span>mTICI Reperfusion Score (Post-EVT)</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-4 h-4"></i>
                      </summary>
                      <div className="p-4 space-y-2">
                        <p className="text-xs text-slate-500 mb-3">Modified Treatment in Cerebral Ischemia. Select the grade that best describes post-procedure reperfusion.</p>
                        <div className="space-y-2">
                          {[
                            { grade: '0', label: 'No perfusion', desc: 'No antegrade flow beyond occlusion', color: 'red' },
                            { grade: '1', label: 'Minimal perfusion', desc: 'Antegrade flow past occlusion, no distal filling', color: 'red' },
                            { grade: '2a', label: 'Partial (< 50%)', desc: 'Antegrade flow fills <50% of downstream territory', color: 'amber' },
                            { grade: '2b', label: 'Substantial (50-99%)', desc: 'Antegrade flow fills 50-99% of downstream territory', color: 'emerald' },
                            { grade: '2c', label: 'Near-complete', desc: 'Near-complete perfusion with slow flow or few small distal emboli', color: 'emerald' },
                            { grade: '3', label: 'Complete perfusion', desc: 'Full antegrade flow, normal filling speed', color: 'emerald' }
                          ].map(({ grade, label, desc, color }) => {
                            const isSelected = telestrokeNote.ticiScore === grade;
                            const colorMap = {
                              red: isSelected ? 'bg-red-600 text-white border-red-600' : 'bg-white border-red-200 hover:bg-red-50',
                              amber: isSelected ? 'bg-amber-600 text-white border-amber-600' : 'bg-white border-amber-200 hover:bg-amber-50',
                              emerald: isSelected ? 'bg-emerald-600 text-white border-emerald-600' : 'bg-white border-emerald-200 hover:bg-emerald-50'
                            };
                            return (
                              <button
                                key={grade}
                                type="button"
                                onClick={() => setTelestrokeNote(prev => ({ ...prev, ticiScore: isSelected ? '' : grade }))}
                                className={`w-full text-left px-4 py-3 rounded-lg border-2 transition-all ${colorMap[color]}`}
                              >
                                <div className="flex items-center justify-between">
                                  <div>
                                    <span className="font-bold text-sm">mTICI {grade}</span>
                                    <span className="ml-2 text-sm">{label}</span>
                                  </div>
                                  {isSelected && <i aria-hidden="true" data-lucide="check" className="w-5 h-5"></i>}
                                </div>
                                <p className={`text-xs mt-0.5 ${isSelected ? 'opacity-80' : 'text-slate-500'}`}>{desc}</p>
                              </button>
                            );
                          })}
                        </div>
                        {telestrokeNote.ticiScore && (
                          <div className={`mt-3 p-3 rounded-lg text-sm ${
                            ['2b', '2c', '3'].includes(telestrokeNote.ticiScore)
                              ? 'bg-emerald-100 border border-emerald-300 text-emerald-800'
                              : 'bg-amber-100 border border-amber-300 text-amber-800'
                          }`}>
                            <strong>mTICI {telestrokeNote.ticiScore}:</strong>{' '}
                            {['2b', '2c', '3'].includes(telestrokeNote.ticiScore)
                              ? 'Successful reperfusion — associated with better functional outcomes.'
                              : 'Incomplete reperfusion — consider further attempts or adjunctive measures.'}
                          </div>
                        )}
                      </div>
                    </details>

                    {/* DRAGON Score */}
                    <details id="calc-dragon" style={{ order: getCalculatorOrder('dragon', 26) }} className="bg-purple-50 border border-purple-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg flex items-center justify-between">
                        <span>DRAGON Score (IVT Outcome Prediction)</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-4 h-4"></i>
                      </summary>
                      <div className="p-4">
                        <p className="text-xs text-slate-500 mb-3">Predicts 3-month outcome after IV thrombolysis. Auto-calculated from patient data where available.</p>
                        {(() => {
                          const age = parseInt(telestrokeNote.age, 10) || 0;
                          const nihss = parseInt(telestrokeNote.nihss || nihssScore, 10) || 0;
                          const glucose = parseFloat(telestrokeNote.glucose) || 0;
                          const glucoseMmol = glucose > 30 ? glucose / 18.0 : glucose;

                          let score = 0;
                          const items = [];

                          // D - Dense cerebral artery / early infarct (manual)
                          items.push({ label: 'Dense artery sign or early infarct on NCCT', value: '?', points: '+1-2', auto: false });

                          // R - mRS > 1 pre-stroke
                          const mrs = parseInt(telestrokeNote.premorbidMRS, 10);
                          if (!isNaN(mrs) && mrs > 1) { score += 1; items.push({ label: `Pre-stroke mRS > 1 (mRS=${mrs})`, value: 'Yes', points: '+1', auto: true }); }
                          else items.push({ label: 'Pre-stroke mRS > 1', value: isNaN(mrs) ? '?' : 'No', points: mrs > 1 ? '+1' : '+0', auto: !isNaN(mrs) });

                          // A - Age
                          if (age >= 80) { score += 2; items.push({ label: `Age ≥80 (${age})`, value: 'Yes', points: '+2', auto: true }); }
                          else if (age >= 65) { score += 1; items.push({ label: `Age 65-79 (${age})`, value: 'Yes', points: '+1', auto: true }); }
                          else items.push({ label: `Age <65 (${age || '?'})`, value: age ? 'No' : '?', points: '+0', auto: !!age });

                          // G - Glucose
                          if (glucoseMmol > 8 || glucose > 144) { score += 1; items.push({ label: `Glucose >8 mmol/L (${glucose} mg/dL)`, value: 'Yes', points: '+1', auto: true }); }
                          else items.push({ label: `Glucose ≤8 mmol/L (${glucose || '?'})`, value: glucose ? 'No' : '?', points: '+0', auto: !!glucose });

                          // O - Onset to treatment (manual)
                          items.push({ label: 'Onset to treatment >90 min', value: '?', points: '+1', auto: false });

                          // N - NIHSS
                          if (nihss > 15) { score += 3; items.push({ label: `NIHSS >15 (${nihss})`, value: 'Yes', points: '+3', auto: true }); }
                          else if (nihss >= 10) { score += 2; items.push({ label: `NIHSS 10-15 (${nihss})`, value: 'Yes', points: '+2', auto: true }); }
                          else if (nihss >= 5) { score += 1; items.push({ label: `NIHSS 5-9 (${nihss})`, value: 'Yes', points: '+1', auto: true }); }
                          else items.push({ label: `NIHSS <5 (${nihss || '?'})`, value: nihss ? 'No' : '?', points: '+0', auto: !!nihss });

                          const prognosis = score <= 3 ? { text: 'Good outcome likely (mRS 0-2)', bg: 'bg-emerald-50 border-emerald-200', text2: 'text-emerald-700', badge: 'bg-emerald-600' }
                            : score <= 5 ? { text: 'Intermediate prognosis', bg: 'bg-amber-50 border-amber-200', text2: 'text-amber-700', badge: 'bg-amber-600' }
                            : { text: 'Poor outcome likely (mRS 5-6 or miserable outcome)', bg: 'bg-red-50 border-red-200', text2: 'text-red-700', badge: 'bg-red-600' };

                          return (
                            <div className="space-y-3">
                              <div className="space-y-1">
                                {items.map((item, i) => (
                                  <div key={i} className={`flex items-center justify-between p-2 rounded text-xs ${item.auto ? 'bg-white border border-slate-200' : 'bg-slate-50 border border-dashed border-slate-300'}`}>
                                    <span className="text-slate-700">{item.label}</span>
                                    <div className="flex items-center gap-2">
                                      <span className={`font-mono text-xs ${item.auto ? 'text-purple-600' : 'text-slate-500'}`}>{item.points}</span>
                                      {item.auto ? <span className="text-emerald-600 text-xs">auto</span> : <span className="text-slate-500 text-xs">manual</span>}
                                    </div>
                                  </div>
                                ))}
                              </div>
                              <div className={`p-3 rounded-lg border ${prognosis.bg}`} aria-live="polite" aria-atomic="true">
                                <div className="flex items-center justify-between">
                                  <span className={`text-lg font-bold ${prognosis.text2}`}>DRAGON: {score} (auto-components)</span>
                                  <span className={`text-xs px-2 py-1 rounded ${prognosis.badge} text-white font-bold`}>
                                    {score <= 3 ? 'Good' : score <= 5 ? 'Intermediate' : 'Poor'}
                                  </span>
                                </div>
                                <p className={`text-xs text-${prognosis.color}-700 mt-1`}>{prognosis.text}</p>
                              </div>
                              <p className="text-xs text-slate-500">Note: D (dense artery/early infarct) and O (onset time) must be assessed manually. Add +1-2 for D and +1 for O if applicable.</p>
                            </div>
                          );
                        })()}
                      </div>
                    </details>

                  </div>
                  </GlobalPatientContext.Provider>
                    )}

                    {/* References & Evidence Content */}
                    {managementSubTab === 'references' && (
                  <div id="mgmt-tabpanel-references" role="tabpanel" aria-labelledby="mgmt-tab-references" className="space-y-6">

                    {/* Evidence Filter */}
                    <div className="bg-white border border-slate-200 rounded-lg p-4">
                      <div className="relative">
                        <input
                          type="text"
                          placeholder="Filter evidence documents..."
                          value={evidenceFilter}
                          onChange={(e) => setEvidenceFilter(e.target.value)}
                          className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                          aria-label="Filter evidence documents"
                        />
                        <i aria-hidden="true" data-lucide="search" className="w-5 h-5 absolute left-3 top-2.5 text-slate-500"></i>
                        {evidenceFilter && (
                          <button
                            type="button"
                            onClick={() => setEvidenceFilter('')}
                            className="absolute right-3 top-1 text-slate-500 hover:text-slate-700 min-h-[36px] min-w-[36px] flex items-center justify-center"
                            aria-label="Clear filter"
                          >
                            <i aria-hidden="true" data-lucide="x" className="w-5 h-5"></i>
                          </button>
                        )}
                      </div>
                      {evidenceFilter && (
                        <p className="text-sm text-slate-600 mt-2">
                          Filtering by: <span className="font-semibold">{evidenceFilter}</span>
                        </p>
                      )}
                    </div>

                    {/* Quick Links */}
                    <div className="flex flex-col sm:flex-row gap-3">
                      <div className="flex items-center gap-2">
                        <a
                          href="https://www.openevidence.com"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex flex-1 items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                        >
                          <i aria-hidden="true" data-lucide="external-link" className="w-5 h-5"></i>
                          <span>OpenEvidence</span>
                        </a>
                      </div>
                      <div className="flex items-center gap-2">
                        <a
                          href="https://www.uptodate.com"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex flex-1 items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                        >
                          <i aria-hidden="true" data-lucide="external-link" className="w-5 h-5"></i>
                          <span>UpToDate</span>
                        </a>
                      </div>
                      <div className="flex items-center gap-2">
                        <a
                          href="https://asta.allen.ai/chat"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex flex-1 items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                        >
                          <i aria-hidden="true" data-lucide="external-link" className="w-5 h-5"></i>
                          <span>Asta (Ai2)</span>
                        </a>
                      </div>
                    </div>

                    {/* References TOC */}
                    <div className="flex flex-wrap gap-1.5">
                      {[
                        ['ref-hints', 'HINTS Exam'],
                        ['ref-cvt', 'CVT'],
                        ['ref-prognosis', 'Prognosis'],
                        ...(isTraineeMode ? [['ref-pearls', 'Clinical Pearls'], ['ref-pitfalls', 'Pitfalls']] : []),
                        ['ref-imaging', 'Imaging F/U'],
                        ['ref-mimics', 'Mimics DDx'],
                        ['ref-chameleons', 'Chameleons'],
                        ['ref-spinalcord', 'Spinal Cord'],
                        ['ref-ctp', 'CTP Guide'],
                        ['ref-orders', 'Admission Orders'],
                        ['ref-guidelines', 'Guidelines'],
                      ].map(([id, label]) => (
                        <button key={id} onClick={() => { const el = document.getElementById(id); if (el) { if (el.tagName === 'DETAILS') el.open = true; el.scrollIntoView({ behavior: 'smooth', block: 'start' }); }}} className="px-3 py-1.5 text-xs font-medium bg-slate-100 hover:bg-blue-100 text-slate-700 hover:text-blue-700 rounded-full border border-slate-200 hover:border-blue-300 transition-colors min-h-[36px]">{label}</button>
                      ))}
                    </div>

                    {/* HINTS Exam Protocol */}
                    <details id="ref-hints" className="bg-white border border-violet-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-violet-800 hover:bg-violet-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="eye" className="w-4 h-4 text-violet-600"></i>
                        HINTS Exam — Acute Vestibular Syndrome
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <p className="text-xs text-slate-600">For acute continuous vertigo with nystagmus, head-motion intolerance, nausea/vomiting, gait unsteadiness lasting &gt;24h. Sensitivity 96.8%, specificity 98.5% for central cause (Kattah et al., 2009).</p>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                          <div className="bg-violet-50 border border-violet-200 rounded-lg p-3">
                            <h4 className="font-bold text-violet-900 text-sm mb-1">H — Head Impulse</h4>
                            <p className="text-xs text-slate-700">Rapid passive head rotation → observe for corrective saccade.</p>
                            <p className="text-xs text-violet-700 mt-1 font-medium">Normal (no saccade) = DANGEROUS → suggests central lesion</p>
                            <p className="text-xs text-emerald-700">Abnormal (catch-up saccade) = peripheral (vestibular neuritis)</p>
                          </div>
                          <div className="bg-violet-50 border border-violet-200 rounded-lg p-3">
                            <h4 className="font-bold text-violet-900 text-sm mb-1">N — Nystagmus</h4>
                            <p className="text-xs text-slate-700">Observe nystagmus direction in primary gaze and with gaze changes.</p>
                            <p className="text-xs text-violet-700 mt-1 font-medium">Direction-changing or vertical = DANGEROUS → central</p>
                            <p className="text-xs text-emerald-700">Unidirectional horizontal = peripheral</p>
                          </div>
                          <div className="bg-violet-50 border border-violet-200 rounded-lg p-3">
                            <h4 className="font-bold text-violet-900 text-sm mb-1">TS — Test of Skew</h4>
                            <p className="text-xs text-slate-700">Alternating cover test — observe for vertical eye correction.</p>
                            <p className="text-xs text-violet-700 mt-1 font-medium">Skew deviation present = DANGEROUS → central</p>
                            <p className="text-xs text-emerald-700">No skew = peripheral</p>
                          </div>
                        </div>
                        <div className="bg-red-50 border border-red-200 rounded-lg p-2">
                          <p className="text-xs font-semibold text-red-800">Any ONE dangerous sign → treat as central (stroke) until proven otherwise. Obtain urgent MRI DWI.</p>
                        </div>
                        <p className="text-xs text-slate-500">Kattah JC et al. Stroke. 2009;40:3504-3510. Newman-Toker DE et al. Stroke. 2008;39:3070-3074.</p>
                      </div>
                    </details>

                    {/* CVT Monitoring Parameters */}
                    <details id="ref-cvt" className="bg-white border border-teal-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-teal-800 hover:bg-teal-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="activity" className="w-4 h-4 text-teal-600"></i>
                        CVT Monitoring Parameters
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-teal-50 border border-teal-200 rounded-lg p-3 space-y-2">
                            <h4 className="font-bold text-teal-900 text-sm">Imaging Follow-Up</h4>
                            <ul className="text-xs text-slate-700 space-y-1">
                              <li>• MRI/MRV at 3-6 months to assess recanalization</li>
                              <li>• Repeat if clinical worsening or new symptoms</li>
                              <li>• CTV acceptable if MRI contraindicated</li>
                              <li>• Consider D-dimer trending if elevated at diagnosis</li>
                            </ul>
                          </div>
                          <div className="bg-teal-50 border border-teal-200 rounded-lg p-3 space-y-2">
                            <h4 className="font-bold text-teal-900 text-sm">ICP Monitoring</h4>
                            <ul className="text-xs text-slate-700 space-y-1">
                              <li>• Fundoscopy at baseline and follow-up</li>
                              <li>• Visual acuity + visual fields baseline</li>
                              <li>• LP opening pressure if pseudotumor cerebri suspected (&gt;25 cmH₂O)</li>
                              <li>• Acetazolamide 250-500 mg BID for persistent elevated ICP</li>
                            </ul>
                          </div>
                          <div className="bg-teal-50 border border-teal-200 rounded-lg p-3 space-y-2">
                            <h4 className="font-bold text-teal-900 text-sm">Thrombophilia Workup</h4>
                            <ul className="text-xs text-slate-700 space-y-1">
                              <li>• Factor V Leiden, Prothrombin G20210A</li>
                              <li>• Protein C, Protein S, Antithrombin III</li>
                              <li>• Antiphospholipid antibodies (lupus anticoagulant, anticardiolipin, anti-β2GP1)</li>
                              <li>• JAK2 V617F if polycythemia suspected</li>
                              <li>• Defer testing during acute anticoagulation (false positives)</li>
                            </ul>
                          </div>
                          <div className="bg-teal-50 border border-teal-200 rounded-lg p-3 space-y-2">
                            <h4 className="font-bold text-teal-900 text-sm">Seizure Management</h4>
                            <ul className="text-xs text-slate-700 space-y-1">
                              <li>• No routine prophylaxis recommended (AHA/ASA)</li>
                              <li>• Treat acute seizures with levetiracetam 500-1000 mg IV</li>
                              <li>• Duration: 3-6 months if acute symptomatic seizure</li>
                              <li>• EEG if altered consciousness or status epilepticus suspected</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </details>

                    {/* Neuroprognostication Framework */}
                    <details id="ref-prognosis" className="bg-white border border-rose-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-rose-800 hover:bg-rose-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="heart-pulse" className="w-4 h-4 text-rose-600"></i>
                        Neuroprognostication &amp; Goals of Care
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <div className="bg-red-50 border border-red-200 rounded-lg p-2">
                          <p className="text-xs font-bold text-red-800">AHA/ASA 2022: New DNR orders should be postponed until at least the second full day of hospitalization (Class IIa, LOE C-LD). Early care limitations are a strong independent predictor of mortality — the "self-fulfilling prophecy."</p>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-rose-50 border border-rose-200 rounded-lg p-3">
                            <h4 className="font-bold text-rose-900 text-sm mb-2">ICH Prognostication</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>ICH Score:</strong> Validated for 30-day mortality (see Calculators tab). NOT validated for long-term functional outcomes.</li>
                              <li><strong>FUNC Score:</strong> Predicts 90-day functional independence — use for positive framing with families.</li>
                              <li><strong>Volume trajectory matters:</strong> Repeat CT at 6h. Stable or shrinking volume = better prognosis.</li>
                              <li><strong>Location matters:</strong> Lobar and deep small (&lt;30 mL) have best outcomes. Brainstem and large deep (&gt;60 mL) have worst.</li>
                              <li className="text-amber-700"><strong>Caution:</strong> ICH Score was derived from populations with high rates of early DNR — it overestimates mortality when aggressive care is provided.</li>
                            </ul>
                          </div>
                          <div className="bg-rose-50 border border-rose-200 rounded-lg p-3">
                            <h4 className="font-bold text-rose-900 text-sm mb-2">Severe AIS Prognostication</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>Early NIHSS does NOT predict long-term outcome</strong> after successful reperfusion. Dramatic early improvement is common.</li>
                              <li><strong>ASPECTS ≥6 with successful recanalization:</strong> ~50% achieve functional independence (mRS 0-2) even with initial NIHSS &gt;20.</li>
                              <li><strong>Malignant MCA infarction:</strong> Hemicraniectomy within 48h (age &lt;60) — NNT 2 for survival, NNT 4 for mRS 0-3 (DECIMAL/DESTINY/HAMLET).</li>
                              <li><strong>Basilar artery occlusion:</strong> Outcomes improving with EVT (ATTENTION/BAOCHE) — do not assume futility.</li>
                              <li className="text-emerald-700"><strong>Framework:</strong> "We are early. The brain needs time. Let us give aggressive medical care for 72 hours, then reassess together."</li>
                            </ul>
                          </div>
                        </div>
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                          <h4 className="font-bold text-blue-800 text-sm mb-2">Talking to Families</h4>
                          <ul className="text-xs text-slate-700 space-y-1">
                            <li>• Use "best case / realistic case / worst case" framework rather than single prediction</li>
                            <li>• Avoid "devastating" or "catastrophic" — use measurable descriptors (size, location, function)</li>
                            <li>• Ask: "What would [patient name] consider an acceptable quality of life?"</li>
                            <li>• Discuss what we WILL do (aggressive medical care, monitoring, rehab), not just what went wrong</li>
                            <li>• Revisit at planned intervals (24h, 72h, 1 week) — avoid repeated ad hoc updates that increase family anxiety</li>
                            <li>• Document the conversation: who was present, what was discussed, family's questions, plan</li>
                          </ul>
                        </div>
                      </div>
                    </details>

                    {/* Clinical Pearls for Trainees */}
                    {isTraineeMode && (
                    <details id="ref-pearls" className="bg-white border border-indigo-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-indigo-800 hover:bg-indigo-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="lightbulb" className="w-4 h-4 text-indigo-600"></i>
                        Clinical Pearls for Trainees
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <h4 className="font-bold text-blue-900 text-sm mb-2">Acute Assessment Pearls</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>Time is brain:</strong> ~1.9 million neurons lost per minute in untreated LVO. Every minute of delay = 1 day less of disability-free life.</li>
                              <li><strong>NIHSS 0 does not mean no stroke:</strong> Posterior circulation strokes (vertigo, diplopia, ataxia, dysarthria) can score 0. Always consider the clinical picture.</li>
                              <li><strong>Always check glucose before TNK:</strong> Hypoglycemia is a treatable mimic. BG &lt;60 should be corrected first.</li>
                              <li><strong>Blood pressure:</strong> Do NOT lower BP aggressively in AIS unless giving lytics. Permissive hypertension (SBP &lt;220) is appropriate.</li>
                              <li><strong>CT negative ≠ no stroke:</strong> CT sensitivity for ischemic stroke in first 6h is only ~25%. A normal CT DOES NOT rule out AIS.</li>
                              <li><strong>ASPECTS:</strong> Count the regions INVOLVED (not spared). Subtract from 10. ASPECTS 10 = normal CT.</li>
                            </ul>
                          </div>
                          <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                            <h4 className="font-bold text-emerald-900 text-sm mb-2">Treatment Pearls</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>TNK vs alteplase:</strong> TNK 0.25 mg/kg (max 25 mg) single bolus is now preferred for AIS. No infusion needed. Easier logistics.</li>
                              <li><strong>Don't delay TNK for perfusion imaging:</strong> If within 4.5h and no contraindications, give TNK. Perfusion imaging is for extending the window, not for gatekeeping.</li>
                              <li><strong>DAPT timing:</strong> For minor stroke (NIHSS ≤3), start DAPT within 24h. Loading doses: ASA 325 + clopidogrel 300. Continue x 21 days (CHANCE/POINT).</li>
                              <li><strong>Statin timing:</strong> Start high-intensity statin (atorvastatin 80 mg) in hospital. Don't wait for fasting lipids.</li>
                              <li><strong>AF detection:</strong> If stroke is cryptogenic after routine workup, extended cardiac monitoring (≥14 days) finds AF in ~12-16% of patients.</li>
                              <li><strong>Anticoagulation after stroke + AF:</strong> ELAN trial: early DOAC (&lt;48h for minor, day 3-4 for moderate, day 6-7 for severe) is non-inferior and safe.</li>
                            </ul>
                          </div>
                          <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                            <h4 className="font-bold text-amber-900 text-sm mb-2">ICH Pearls</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>BP control matters most in first 2h:</strong> Target SBP &lt;140 mmHg within 2h (INTERACT2, Class IIa). Avoid SBP &lt;130 (ATACH-2 showed no benefit of intensive SBP 110-139 vs 140-179, with trend toward renal harm). Nicardipine drip preferred for smooth control.</li>
                              <li><strong>Anticoagulant reversal:</strong> This is the MOST time-sensitive intervention in ICH. Give PCC/idarucizumab BEFORE the CT in known anticoagulated patients.</li>
                              <li><strong>Spot sign on CTA:</strong> Contrast extravasation predicts hematoma expansion. If present → more aggressive BP control and close monitoring.</li>
                              <li><strong>IVH worsens prognosis:</strong> Consider EVD if hydrocephalus develops. Intraventricular alteplase (CLEAR III) reduces mortality but doesn't improve functional outcome.</li>
                              <li><strong>When to restart anticoagulation:</strong> For AF + ICH, generally restart DOAC at 4-8 weeks (individualized). Lobar ICH = higher rebleed risk than deep.</li>
                            </ul>
                          </div>
                          <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                            <h4 className="font-bold text-purple-900 text-sm mb-2">Disposition Pearls</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>Stroke unit care matters:</strong> Admission to a dedicated stroke unit reduces mortality and disability regardless of stroke type (NNT 18 for death or dependency). Cochrane 2020.</li>
                              <li><strong>Early mobilization:</strong> Avoid bedrest beyond 24h unless post-TNK. AVERT trial: very early (&lt;24h) aggressive mobilization may be harmful; gradual is better.</li>
                              <li><strong>Swallow screen before anything PO:</strong> Aspiration pneumonia is the #1 preventable complication. Formal SLP eval if bedside screen abnormal.</li>
                              <li><strong>DVT prophylaxis:</strong> SCDs on admission for all. SQ heparin after 24h post-TNK (or 48h post-ICH). IPC + anticoagulation is better than IPC alone.</li>
                              <li><strong>Fever is bad:</strong> Target normothermia. Every 1°C rise in temperature in the first 72h worsens outcomes. Workup infection aggressively.</li>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Trainee Pitfalls — Common Mistakes */}
                    {isTraineeMode && (
                    <details id="ref-pitfalls" className="bg-white border border-red-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-red-800 hover:bg-red-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="triangle-alert" className="w-4 h-4 text-red-600"></i>
                        Common Trainee Pitfalls
                      </summary>
                      <div className="px-4 pb-4 space-y-2">
                        <p className="text-xs text-slate-600 mb-2">Scenario-based Q&amp;A for common mistakes during stroke consultations.</p>
                        {[
                          {
                            q: 'Patient got TNK and now has trace blood on urine dip. Should I reverse?',
                            a: 'No. Microscopic hematuria is not an indication to reverse thrombolysis. Only gross hematuria, active bleeding requiring transfusion, or symptomatic intracranial hemorrhage warrants reversal. Continue monitoring.',
                            ref: 'AHA/ASA 2019 Acute Ischemic Stroke Guidelines'
                          },
                          {
                            q: 'Patient has ICH Score of 4. Family wants to know prognosis. Should we recommend comfort care?',
                            a: 'No. The ICH Score predicts 30-day MORTALITY, not functional outcome, and was derived from cohorts with high rates of early DNR/withdrawal. AHA recommends postponing DNR at least 24h (Class IIa). Use FUNC Score for functional prognosis and provide aggressive care for at least 72 hours before prognosticating.',
                            ref: 'AHA/ASA ICH 2022; Hemphill 2001; Rost 2008'
                          },
                          {
                            q: 'Patient has cerebral venous thrombosis with hemorrhagic venous infarction. Should I hold anticoagulation?',
                            a: 'No. Anticoagulate even with hemorrhage. CVT-associated hemorrhage is caused by venous congestion, and anticoagulation treats the underlying cause. AHA/ASA recommends initial anticoagulation with heparin even in presence of ICH (Class IIa, LOE B).',
                            ref: 'AHA/ASA CVT 2024; ESO 2017'
                          },
                          {
                            q: 'Patient has NIHSS 3 but CTA shows M1 occlusion. Do they need EVT?',
                            a: 'Likely yes. Low NIHSS does not exclude LVO benefit. MR CLEAN-LATE and ESCAPE showed benefit even with lower NIHSS in LVO. Early neurological deterioration occurs in up to 30% of untreated LVO patients with initially low NIHSS. Discuss with neurointerventionalist.',
                            ref: 'AHA/ASA 2026; MR CLEAN-LATE 2023'
                          },
                          {
                            q: 'Patient had a seizure at stroke onset. Is TNK contraindicated?',
                            a: 'No. Seizure at onset is no longer an absolute contraindication if residual deficits are clearly attributable to stroke (not postictal). If doubt exists, CT/CTA can help. The key concern is misdiagnosing Todd paralysis as stroke — do a thorough exam.',
                            ref: 'AHA/ASA 2019; ACT-FAST 2022'
                          },
                          {
                            q: 'Should I start prophylactic anti-seizure medication in this ICH patient?',
                            a: 'No. Routine prophylactic AEDs are NOT recommended for ICH (Class III: No Benefit). Only treat clinical or electrographic seizures. If the patient has altered mental status disproportionate to the lesion, order continuous EEG — non-convulsive seizures occur in up to 28% of ICH patients.',
                            ref: 'AHA/ASA ICH 2022'
                          },
                          {
                            q: 'Patient is on clopidogrel and taking omeprazole. Is this a concern?',
                            a: 'Yes. Omeprazole and esomeprazole are strong CYP2C19 inhibitors that significantly reduce clopidogrel active metabolite. Switch to pantoprazole (weak CYP2C19 inhibitor) or consider H2 blocker. This interaction does NOT apply to DOACs or aspirin.',
                            ref: 'FDA Safety Communication 2009; COGENT trial 2010'
                          },
                          {
                            q: 'Patient had TNK 3 hours ago, now new hemianopia. HT or new ischemia?',
                            a: 'Get STAT CT head. HT typically presents with headache, nausea, BP elevation, and decreased consciousness. New focal deficit without consciousness change suggests re-occlusion or new territory ischemia. If CT shows no hemorrhage, consider repeat CTA to assess vessel patency — may need rescue EVT.',
                            ref: 'Clinical reasoning; AHA/ASA 2019'
                          },
                          {
                            q: 'Should I use phenytoin for post-stroke seizures?',
                            a: 'Avoid if possible. Phenytoin has drug interactions with DOACs/statins, causes hypotension, and has worse cognitive outcomes. First-line: Levetiracetam 1000-1500 mg IV load, then 500-1000 mg BID. Alternative: Lacosamide 200 mg IV load.',
                            ref: 'AHA/ASA 2022; Clinical consensus'
                          },
                          {
                            q: 'Patient is 62 with malignant MCA infarction. Is hemicraniectomy indicated?',
                            a: 'Discuss with the patient/family and neurosurgery. DESTINY II showed survival benefit in age >60 BUT higher rate of severe disability (mRS 4-5). NNT 2 for survival, but most survivors have moderate-severe disability. This requires a goals-of-care conversation — some patients/families value survival, others prioritize independence.',
                            ref: 'DESTINY II (Juttler 2014); DECIMAL/DESTINY/HAMLET pooled analysis'
                          },
                        ].map((item, idx) => (
                          <details key={idx} className="bg-red-50 border border-red-100 rounded-lg">
                            <summary className="cursor-pointer p-2 text-sm font-medium text-red-900 hover:bg-red-100 rounded-lg">{item.q}</summary>
                            <div className="px-3 pb-2">
                              <p className="text-xs text-slate-700 mt-1">{item.a}</p>
                              <p className="text-xs text-slate-500 mt-1 italic">Ref: {item.ref}</p>
                            </div>
                          </details>
                        ))}
                      </div>
                    </details>
                    )}

                    {/* Imaging Follow-Up Protocols */}
                    <details id="ref-imaging" className="bg-white border border-cyan-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-cyan-800 hover:bg-cyan-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="scan" className="w-4 h-4 text-cyan-600"></i>
                        Imaging Follow-Up Protocols by Diagnosis
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <p className="text-xs text-slate-600">Ensures no imaging gets missed during admission or at discharge. Protocol-driven imaging reduces diagnostic errors.</p>
                        <div className="space-y-2">
                          <details className="bg-blue-50 border border-blue-200 rounded-lg" open>
                            <summary className="cursor-pointer p-2 text-sm font-semibold text-blue-800">AIS (Post-TNK)</summary>
                            <div className="px-3 pb-2 text-xs space-y-1">
                              <p><strong>24h:</strong> NCHCT — screen for hemorrhagic transformation (required before starting antithrombotics)</p>
                              <p><strong>24-48h:</strong> MRI DWI/FLAIR if not done — confirm infarct extent, detect silent infarcts</p>
                              <p><strong>If neuro decline:</strong> STAT NCHCT +/- CTA (reocclusion vs HT vs edema)</p>
                              <p><strong>Discharge:</strong> Ensure CTA/MRA head and neck completed. If not → outpatient within 1 week.</p>
                              <p><strong>Outpatient (3-6 months):</strong> If carotid/vertebral stenosis → repeat CTA/MRA to assess progression</p>
                            </div>
                          </details>
                          <details className="bg-blue-50 border border-blue-200 rounded-lg">
                            <summary className="cursor-pointer p-2 text-sm font-semibold text-blue-800">AIS (Post-EVT)</summary>
                            <div className="px-3 pb-2 text-xs space-y-1">
                              <p><strong>Immediately post-procedure:</strong> Flat-panel CT in angio suite (contrast extravasation vs staining)</p>
                              <p><strong>24h:</strong> NCHCT +/- CTA — assess for HT, confirm reperfusion, evaluate stent/device patency</p>
                              <p><strong>If neuro decline:</strong> STAT NCHCT + CTA (reocclusion, HT, edema, vasospasm)</p>
                              <p><strong>48-72h:</strong> MRI DWI if available — final infarct volume for prognostication</p>
                              <p><strong>If stent placed:</strong> CTA at 3-6 months for in-stent stenosis surveillance</p>
                            </div>
                          </details>
                          <details className="bg-red-50 border border-red-200 rounded-lg">
                            <summary className="cursor-pointer p-2 text-sm font-semibold text-red-800">ICH</summary>
                            <div className="px-3 pb-2 text-xs space-y-1">
                              <p><strong>6h:</strong> Repeat NCHCT — assess for hematoma expansion (≥33% or ≥6 mL = significant)</p>
                              <p><strong>24h:</strong> Repeat NCHCT if stable; CTA if no etiology identified (AVM, aneurysm, tumor)</p>
                              <p><strong>If neuro decline:</strong> STAT NCHCT (expansion, hydrocephalus, new hemorrhage)</p>
                              <p><strong>If young/no HTN/lobar:</strong> MRI with GRE/SWI and contrast — evaluate for underlying lesion, amyloid angiopathy (microbleeds)</p>
                              <p><strong>Before DVT prophylaxis:</strong> Confirm stable hematoma on repeat imaging</p>
                              <p><strong>Outpatient (3 months):</strong> MRI brain if not done inpatient; consider conventional angiogram if high suspicion for vascular malformation</p>
                            </div>
                          </details>
                          <details className="bg-amber-50 border border-amber-200 rounded-lg">
                            <summary className="cursor-pointer p-2 text-sm font-semibold text-amber-800">SAH</summary>
                            <div className="px-3 pb-2 text-xs space-y-1">
                              <p><strong>Day 0:</strong> CTA head/neck to identify aneurysm source. If CTA negative → conventional angiogram.</p>
                              <p><strong>Day 3-14 (vasospasm window):</strong> Daily TCDs. CTA/CTP if TCD velocities &gt;200 cm/s or clinical decline.</p>
                              <p><strong>If neuro decline:</strong> STAT NCHCT (rebleed, hydrocephalus, infarction) + CTA/CTP (vasospasm)</p>
                              <p><strong>Post-coiling:</strong> Follow-up conventional angiogram or MRA at 6 months, 18 months, 3 years</p>
                              <p><strong>Post-clipping:</strong> CTA at 6-12 months to confirm clip positioning and rule out residual aneurysm</p>
                              <p><strong>Perimesencephalic SAH (CTA neg):</strong> Repeat conventional angiogram in 1-2 weeks if initial was negative</p>
                            </div>
                          </details>
                          <details className="bg-pink-50 border border-pink-200 rounded-lg">
                            <summary className="cursor-pointer p-2 text-sm font-semibold text-pink-800">Cervical Artery Dissection</summary>
                            <div className="px-3 pb-2 text-xs space-y-1">
                              <p><strong>Acute:</strong> CTA neck (or MRI/MRA with fat-sat) to confirm dissection</p>
                              <p><strong>3-6 months:</strong> Repeat CTA or MRA neck — assess healing, recanalization</p>
                              <p><strong>If recanalized:</strong> May simplify antithrombotic regimen</p>
                              <p><strong>If persistent stenosis/occlusion:</strong> Continue antithrombotics, repeat at 12 months</p>
                              <p><strong>If FMD suspected:</strong> CTA from aortic arch to circle of Willis + renal arteries screening</p>
                            </div>
                          </details>
                          <details className="bg-teal-50 border border-teal-200 rounded-lg">
                            <summary className="cursor-pointer p-2 text-sm font-semibold text-teal-800">CVT (Cerebral Venous Thrombosis)</summary>
                            <div className="px-3 pb-2 text-xs space-y-1">
                              <p><strong>Acute:</strong> MRI/MRV brain (or CTV if MRI contraindicated)</p>
                              <p><strong>3-6 months:</strong> Repeat MRI/MRV — assess recanalization</p>
                              <p><strong>If worsening:</strong> Repeat MRI/MRV urgently; consider conventional venography + endovascular intervention</p>
                              <p><strong>If persistent headache:</strong> LP opening pressure to evaluate for pseudotumor cerebri</p>
                              <p><strong>If recanalized:</strong> May consider stopping anticoagulation (if provoked; indefinite if unprovoked or thrombophilia)</p>
                            </div>
                          </details>
                          <details className="bg-slate-50 border border-slate-200 rounded-lg">
                            <summary className="cursor-pointer p-2 text-sm font-semibold text-slate-800">Cryptogenic Stroke Workup</summary>
                            <div className="px-3 pb-2 text-xs space-y-1">
                              <p><strong>Inpatient:</strong> MRI DWI, CTA/MRA head and neck, TTE with bubble study, continuous telemetry ≥24h</p>
                              <p><strong>If TTE negative + high suspicion:</strong> TEE (PFO, LAA thrombus, aortic arch atheroma)</p>
                              <p><strong>Extended monitoring:</strong> 14-30 day ambulatory cardiac monitor (ICM if recurrent or high-risk)</p>
                              <p><strong>If age &lt;60:</strong> Consider vessel wall MRI (vasculitis, reversible vasoconstriction, dissection), hypercoagulability workup</p>
                              <p><strong>If ESUS confirmed:</strong> Antiplatelet therapy (not anticoagulation) per NAVIGATE ESUS/RE-SPECT ESUS. Extended monitoring is key to finding AF.</p>
                            </div>
                          </details>
                        </div>
                      </div>
                    </details>

                    {/* Code Stroke Activation Criteria */}
                    <details id="ref-code-stroke" className="bg-white border border-red-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-red-800 hover:bg-red-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="siren" className="w-4 h-4 text-red-600"></i>
                        Code Stroke Activation Criteria
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                          <h4 className="font-bold text-red-900 text-sm mb-2">ACTIVATE Code Stroke When ALL Present</h4>
                          <ul className="text-xs text-slate-700 space-y-1.5">
                            <li><strong>1. Acute focal neurological deficit</strong> — facial droop, arm/leg weakness, speech difficulty, visual field cut, neglect, ataxia, diplopia, dysarthria</li>
                            <li><strong>2. Last known well (LKW) within 24 hours</strong> — or unknown onset (wake-up strokes may be eligible for intervention)</li>
                            <li><strong>3. Age typically ≥18</strong> — pediatric stroke protocols differ; involve pediatric neurology early</li>
                            <li><strong>4. No immediately obvious alternative</strong> — check glucose before activation if possible (BG &lt;60 mg/dL can mimic stroke)</li>
                          </ul>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                            <h4 className="font-bold text-amber-900 text-sm mb-2">LVO Alert Criteria (Upgrade)</h4>
                            <p className="text-xs text-slate-600 mb-2">Upgrade to LVO alert for potential emergent thrombectomy when:</p>
                            <ul className="text-xs text-slate-700 space-y-1">
                              <li>NIHSS ≥6 (or RACE ≥5, LAMS ≥4)</li>
                              <li>Cortical signs: gaze deviation, neglect, aphasia, hemianopia</li>
                              <li>Acute basilar symptoms: bilateral motor, LOC, locked-in presentation</li>
                              <li>LKW within 24 hours (late-window EVT per DAWN/DEFUSE-3)</li>
                            </ul>
                          </div>
                          <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-3">
                            <h4 className="font-bold text-emerald-900 text-sm mb-2">De-escalation Criteria</h4>
                            <p className="text-xs text-slate-600 mb-2">Consider standing down code when:</p>
                            <ul className="text-xs text-slate-700 space-y-1">
                              <li>NIHSS 0 with complete symptom resolution AND LKW &gt;4.5h (TIA pathway)</li>
                              <li>Hypoglycemia (BG &lt;60) with deficits resolving after glucose correction</li>
                              <li>Confirmed active seizure with improving postictal deficit</li>
                              <li>Known chronic/stable deficits confirmed identical to prior baseline</li>
                              <li>Onset clearly &gt;24 hours with no mismatch imaging indication</li>
                            </ul>
                          </div>
                        </div>
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                          <h4 className="font-bold text-blue-900 text-sm mb-2">When NOT to Activate</h4>
                          <ul className="text-xs text-slate-700 space-y-1">
                            <li>Isolated dizziness without other posterior fossa signs (unless HINTS exam is central pattern)</li>
                            <li>Isolated headache without focal deficits (unless thunderclap → SAH protocol)</li>
                            <li>Chronic stable neurological deficits with no acute change</li>
                            <li>Symptoms clearly explained by non-stroke diagnosis already established</li>
                          </ul>
                          <p className="text-xs text-red-700 font-semibold mt-2">When in doubt, ACTIVATE. It is always safer to stand down a code stroke than to miss a treatable stroke.</p>
                        </div>
                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-3">
                          <h4 className="font-bold text-purple-900 text-sm mb-2">Rapid LVO Screen: RACE Scale (Pre-CTA)</h4>
                          <p className="text-xs text-slate-600 mb-2">Rapid Arterial oCclusion Evaluation — for use by EMS or spoke ED before CTA is available. Score ≥5 suggests LVO (sensitivity ~85%, specificity ~68%). (Perez de la Ossa N et al., Stroke 2014)</p>
                          <div className="text-xs text-slate-700 space-y-1">
                            <p><strong>Facial palsy:</strong> 0 = absent, 1 = mild, 2 = moderate-severe</p>
                            <p><strong>Arm motor:</strong> 0 = normal, 1 = mild weakness, 2 = moderate-severe/plegia</p>
                            <p><strong>Leg motor:</strong> 0 = normal, 1 = mild weakness, 2 = moderate-severe/plegia</p>
                            <p><strong>Head/gaze deviation:</strong> 0 = absent, 1 = present</p>
                            <p><strong>Aphasia (L) or Agnosia (R):</strong> 0 = absent, 1 = mild, 2 = moderate-severe</p>
                            <p className="font-semibold mt-1">Total: 0-9. Score ≥5 → activate LVO alert, prioritize CTA, notify neurointerventional team.</p>
                          </div>
                        </div>
                      </div>
                    </details>

                    {/* Stroke Mimic DDx Tool */}
                    <details id="ref-mimics" className="bg-white border border-orange-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-orange-800 hover:bg-orange-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="shield-alert" className="w-4 h-4 text-orange-600"></i>
                        Stroke Mimic Differential Diagnosis
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <p className="text-xs text-slate-600">Up to 25-30% of suspected strokes are mimics. Key features favoring mimic: age &lt;50, no vascular risk factors, seizure at onset, normal NIHSS, symptoms not conforming to vascular territory.</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <h4 className="font-bold text-orange-900 text-sm mb-2">Common Mimics</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>Seizure/Todd paralysis:</strong> Witnessed seizure activity, postictal state, gradual resolution. EEG if uncertain.</li>
                              <li><strong>Migraine with aura:</strong> Positive symptoms (scintillations, spreading paresthesias), headache history, gradual march over 20-60 min.</li>
                              <li><strong>Hypoglycemia:</strong> BG &lt;60 mg/dL, focal deficits resolve with glucose correction. Always check BG first.</li>
                              <li><strong>Conversion disorder (FND):</strong> Inconsistent exam, give-way weakness, non-anatomic sensory loss. Often young patients. <strong>Hoover sign:</strong> Place hand under the "weak" heel; ask patient to lift the <em>good</em> leg against resistance — involuntary downward pressure on the paretic side = positive (functional weakness). Absent hip extension = true weakness.</li>
                              <li><strong>Peripheral vertigo:</strong> HINTS exam peripheral pattern, no focal deficits. See HINTS section above.</li>
                            </ul>
                          </div>
                          <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                            <h4 className="font-bold text-orange-900 text-sm mb-2">Less Common Mimics</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>Hypertensive encephalopathy/PRES:</strong> Severely elevated BP, visual changes, seizures, posterior edema on MRI.</li>
                              <li><strong>Bell palsy:</strong> Isolated facial weakness (upper AND lower face), no limb weakness, ear pain.</li>
                              <li><strong>Hemiplegic migraine:</strong> Family history, prior episodes, fully reversible motor aura. Diagnosis of exclusion.</li>
                              <li><strong>CNS infection:</strong> Fever, meningismus, CSF pleocytosis. Consider HSV encephalitis if temporal lobe symptoms.</li>
                              <li><strong>Brain tumor:</strong> Subacute onset, progressive symptoms, seizures. CT/MRI diagnostic.</li>
                              <li><strong>Toxic/metabolic:</strong> Hepatic encephalopathy, uremia, hypo/hypernatremia, drug intoxication (lithium, phenytoin).</li>
                              <li><strong>Demyelinating disease:</strong> Young patient, optic neuritis, prior episodes, MRI white matter lesions.</li>
                            </ul>
                          </div>
                        </div>
                        <div className="bg-red-50 border border-red-200 rounded-lg p-2">
                          <p className="text-xs font-semibold text-red-800">If in doubt, treat as stroke. TNK is relatively safe; missing a true stroke is far worse than treating a mimic. False-negative rate of CT is high in the first 6-12 hours.</p>
                        </div>
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-2">
                          <p className="text-xs text-blue-800"><strong>FABS Score (mimic predictor):</strong> Facial palsy absent (+1), AF history absent (+1), BP at presentation SBP &lt;150 (+1), Seizure at onset (+1). Score ≥3 → consider mimic. (Ali SF et al., Stroke 2014)</p>
                        </div>
                      </div>
                    </details>

                    {/* Spinal Cord Stroke */}
                    <details id="ref-spinalcord" className="bg-white border border-violet-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-violet-800 hover:bg-violet-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="activity" className="w-4 h-4 text-violet-600"></i>
                        Spinal Cord Stroke
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <p className="text-xs text-slate-600">Rare (~1% of all strokes) but devastating. Most commonly anterior spinal artery territory. Often missed initially. Key etiologies: aortic surgery/dissection, atherosclerosis, systemic hypotension, fibrocartilaginous embolism.</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-violet-50 border border-violet-200 rounded-lg p-3">
                            <h4 className="font-bold text-violet-900 text-sm mb-2">Clinical Syndromes</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>Anterior spinal artery (most common):</strong> Bilateral motor loss below the level, loss of pain/temperature (spinothalamic), bowel/bladder dysfunction. <em>Preserved</em> proprioception and vibration (posterior columns spared).</li>
                              <li><strong>Posterior spinal artery (rare):</strong> Loss of proprioception, vibration, fine touch. Motor relatively preserved. Sensory ataxia.</li>
                              <li><strong>Central cord syndrome:</strong> Cape-like dissociated sensory loss, upper &gt; lower extremity weakness.</li>
                              <li><strong>Brown-Séquard (unilateral):</strong> Ipsilateral motor + proprioception loss, contralateral pain/temperature loss. Uncommon in ischemia; consider sulcal artery occlusion.</li>
                            </ul>
                          </div>
                          <div className="bg-violet-50 border border-violet-200 rounded-lg p-3">
                            <h4 className="font-bold text-violet-900 text-sm mb-2">Workup &amp; Management</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>MRI spine with DWI:</strong> Gold standard. DWI detects ischemia within hours. Sagittal &quot;pencil-like&quot; or axial &quot;owl-eye&quot; pattern.</li>
                              <li><strong>CT aortography:</strong> Essential to exclude aortic dissection or post-surgical complications.</li>
                              <li><strong>BP augmentation:</strong> MAP target ≥85-90 mmHg. Avoid hypotension.</li>
                              <li><strong>CSF drainage:</strong> Post-aortic surgery: target CSF pressure &lt;10-15 cmH2O. Place lumbar drain early if deteriorating.</li>
                              <li><strong>Antithrombotics:</strong> Antiplatelet therapy (extrapolated from cerebral ischemic stroke). Anticoagulation if embolic source.</li>
                              <li><strong>Exclude mimics:</strong> Transverse myelitis, epidural abscess/hematoma, GBS, MS, compressive myelopathy.</li>
                            </ul>
                          </div>
                        </div>
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-2">
                          <p className="text-xs text-amber-800"><strong>Red flags:</strong> Acute bilateral leg weakness with dissociated sensory loss + recent aortic procedure or known aortic disease. Fibrocartilaginous embolism: young patient, onset during Valsalva/exertion, disc disease on MRI.</p>
                        </div>
                      </div>
                    </details>

                    {/* CTP Interpretation Guide */}
                    <details id="ref-ctp" className="bg-white border border-cyan-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-cyan-800 hover:bg-cyan-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="scan" className="w-4 h-4 text-cyan-600"></i>
                        CT Perfusion (CTP) Interpretation Guide
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <p className="text-xs text-slate-600">CTP maps tissue perfusion to identify ischemic core and salvageable penumbra. Key to EVT decisions in extended windows (6-24h). Most centers use RAPID automated software.</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-cyan-50 border border-cyan-200 rounded-lg p-3">
                            <h4 className="font-bold text-cyan-900 text-sm mb-2">Perfusion Maps</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>CBV (Cerebral Blood Volume):</strong> Reduced in irreversibly infarcted tissue. Low CBV = dead tissue.</li>
                              <li><strong>CBF (Cerebral Blood Flow):</strong> Reduced in hypoperfused tissue. rCBF &lt;30% defines ischemic core in RAPID.</li>
                              <li><strong>MTT (Mean Transit Time):</strong> Prolonged in ischemic tissue. MTT = CBV/CBF. High sensitivity but low specificity.</li>
                              <li><strong>Tmax (Time to Maximum):</strong> Delay in contrast arrival. <strong>Tmax &gt;6s</strong> defines critically hypoperfused tissue (penumbra + core). Primary RAPID output.</li>
                            </ul>
                          </div>
                          <div className="bg-cyan-50 border border-cyan-200 rounded-lg p-3">
                            <h4 className="font-bold text-cyan-900 text-sm mb-2">Trial Criteria</h4>
                            <div className="bg-white border rounded p-2 mb-2">
                              <p className="text-xs font-semibold text-cyan-800">DEFUSE-3 (6-16h):</p>
                              <ul className="text-xs text-slate-700 space-y-0.5 ml-2">
                                <li>Core (rCBF &lt;30%): &lt;70 mL</li>
                                <li>Tmax &gt;6s volume: 15-180 mL</li>
                                <li>Mismatch ratio: ≥1.8</li>
                                <li>Mismatch volume: ≥15 mL</li>
                              </ul>
                            </div>
                            <div className="bg-white border rounded p-2">
                              <p className="text-xs font-semibold text-cyan-800">DAWN (6-24h):</p>
                              <ul className="text-xs text-slate-700 space-y-0.5 ml-2">
                                <li>Group A: ≥80 yr, NIHSS ≥10, core &lt;21 mL</li>
                                <li>Group B: &lt;80 yr, NIHSS ≥10, core &lt;31 mL</li>
                                <li>Group C: &lt;80 yr, NIHSS ≥20, core 31-51 mL</li>
                              </ul>
                            </div>
                          </div>
                        </div>
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                          <h4 className="font-bold text-amber-800 text-xs mb-1">CTP Pitfalls</h4>
                          <ul className="text-xs text-slate-700 space-y-1">
                            <li><strong>Crossed cerebellar diaschisis:</strong> Contralateral cerebellar hypoperfusion from supratentorial stroke — not true cerebellar ischemia.</li>
                            <li><strong>Chronic carotid stenosis:</strong> Ipsilateral Tmax delay without acute stroke. Correlate with DWI and clinical timing.</li>
                            <li><strong>Low cardiac output:</strong> Global bilateral delay. All Tmax values elevated — not a focal lesion.</li>
                            <li><strong>Posterior fossa:</strong> Limited scanner coverage may miss posterior circulation on some 64-slice scanners.</li>
                            <li><strong>Core overestimation (&lt;90 min):</strong> RAPID may overestimate core in hyperacute phase. If clinical-imaging mismatch, proceed with treatment.</li>
                            <li><strong>Motion artifact:</strong> Patient movement degrades maps. Repeat if maps are clearly artifactual.</li>
                          </ul>
                        </div>
                        <details className="bg-blue-50 border border-blue-200 rounded-lg">
                          <summary className="cursor-pointer p-2 text-xs font-semibold text-blue-800 hover:bg-blue-100 rounded-lg">Collateral Assessment Scoring</summary>
                          <div className="p-2 text-xs text-slate-700 space-y-1.5">
                            <p>Good collaterals independently predict better EVT outcomes and can support candidacy when CTP is unavailable or equivocal.</p>
                            <p><strong>ASITN/SIR Collateral Flow Grading (0-4):</strong> 0 = no collaterals; 1 = slow collaterals to &lt;50% of MCA; 2 = slow to 100% of MCA; 3 = rapid to &lt;100% of MCA; 4 = complete and rapid. Grade 3-4 = good collaterals.</p>
                            <p><strong>Tan Score (Multiphase CTA, 0-3):</strong> Used in ESCAPE trial. 0 = no filling in any phase; 1 = filling in some phases; 2 = delayed filling in late phases; 3 = normal pial arterial filling. Score 2-3 = good collaterals.</p>
                            <p><strong>Single-phase CTA:</strong> Compare pial vessel opacification in affected vs unaffected hemisphere. &gt;50% filling on CTA = favorable collaterals.</p>
                          </div>
                        </details>
                      </div>
                    </details>

                    {/* Stroke Chameleons — True Strokes Mimicking Non-Stroke Diagnoses */}
                    <details id="ref-chameleons" className="bg-white border border-red-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-red-800 hover:bg-red-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="eye-off" className="w-4 h-4 text-red-600"></i>
                        Stroke Chameleons — Missed Stroke Presentations
                      </summary>
                      <div className="px-4 pb-4 space-y-3">
                        <p className="text-xs text-slate-600">Stroke chameleons are true strokes that present as non-stroke diagnoses and are therefore missed. More dangerous than mimics because they represent missed treatment opportunities. (Richoz B et al., Eur Stroke J 2020)</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                            <h4 className="font-bold text-red-900 text-sm mb-2">Common Chameleons</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>Isolated vertigo/dizziness:</strong> PICA/AICA/vertebral artery stroke. Use HINTS exam — dangerous pattern (normal HIT, direction-changing nystagmus, skew deviation) has higher sensitivity than MRI in first 48h.</li>
                              <li><strong>Acute confusional state:</strong> Right PCA territory, thalamic, or top-of-basilar infarcts can present as delirium without obvious motor deficits. Check visual fields.</li>
                              <li><strong>Isolated headache:</strong> Vertebral/carotid dissection, CVT, or sentinel SAH. Always consider if headache is thunderclap, positional, or associated with neck pain.</li>
                              <li><strong>Acute psychiatric symptoms:</strong> Right non-dominant hemisphere strokes can present with acute agitation, mania, or psychosis without hemiparesis.</li>
                              <li><strong>Isolated nausea/vomiting:</strong> Lateral medullary (Wallenberg) syndrome. Check for Horner syndrome, crossed sensory findings, gait ataxia.</li>
                            </ul>
                          </div>
                          <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                            <h4 className="font-bold text-red-900 text-sm mb-2">Less Common Chameleons</h4>
                            <ul className="text-xs text-slate-700 space-y-1.5">
                              <li><strong>Movement disorder onset:</strong> Hemichorea-hemiballismus from contralateral basal ganglia (subthalamic nucleus) infarction. Can present subacutely.</li>
                              <li><strong>Bilateral weakness mimicking GBS:</strong> Bilateral pontine infarct can cause bilateral motor deficits. Check for facial weakness, eye movement abnormalities.</li>
                              <li><strong>Amnesia (TGA-like):</strong> Bilateral hippocampal or thalamic infarction. Persistent amnesia beyond 24h or vascular risk factors should prompt DWI MRI.</li>
                              <li><strong>Alien hand syndrome:</strong> ACA territory or corpus callosum infarction. Involuntary purposeful hand movements.</li>
                              <li><strong>Monocular vision loss:</strong> Retinal artery occlusion IS a stroke (AHA/ASA 2021). Same workup as cerebral ischemia; CRAO has ~25% risk of subsequent cerebral event.</li>
                            </ul>
                          </div>
                        </div>
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-2">
                          <p className="text-xs text-amber-800"><strong>Key principle:</strong> If vascular risk factors are present and the differential includes stroke, obtain urgent vascular imaging (CTA head/neck) and DWI MRI. NIHSS of 0 does NOT exclude stroke — the scale is heavily weighted toward anterior circulation and misses many posterior and right-hemisphere presentations.</p>
                        </div>
                      </div>
                    </details>

                    {/* Admission Order Checklists */}
                    <details id="ref-orders" className="bg-white border border-emerald-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-emerald-800 hover:bg-emerald-50 rounded-lg flex items-center gap-2">
                        <i aria-hidden="true" data-lucide="clipboard-list" className="w-4 h-4 text-emerald-600"></i>
                        Admission Order Checklists
                      </summary>
                      <div className="px-4 pb-4 space-y-4">

                        <details className="bg-blue-50 border border-blue-200 rounded-lg" open>
                          <summary className="cursor-pointer p-3 font-semibold text-blue-800 text-sm">AIS (Acute Ischemic Stroke) Orders</summary>
                          <div className="px-3 pb-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                              <div className="space-y-1">
                                <p className="font-bold text-blue-700 mb-1">Monitoring</p>
                                <p>Neuro checks q1h x 24h (post-TNK: q15min x 2h, q30min x 6h, q1h x 16h)</p>
                                <p>Cardiac telemetry continuous</p>
                                <p>VS q1h (BP, HR, O2 sat)</p>
                                <p>I&O q shift</p>
                                <p>Fingerstick glucose q6h</p>
                                <p>NPO until swallow eval</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-blue-700 mb-1">Activity & Safety</p>
                                <p>Bedrest with HOB 30° x 24h (if post-TNK)</p>
                                <p>Fall precautions</p>
                                <p>Aspiration precautions</p>
                                <p>DVT prophylaxis: SCDs (hold heparin x 24h post-TNK)</p>
                                <p>IV NS at 75 mL/hr (avoid D5W)</p>
                                <p>Foley catheter only if unable to void; remove within 24h</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-blue-700 mb-1">Medications</p>
                                <p>ASA 325 mg load (hold 24h post-TNK), then 81 mg daily</p>
                                <p>Atorvastatin 80 mg daily</p>
                                <p>BP meds per protocol (see BP section)</p>
                                <p>Home medications (review for interactions)</p>
                                <p>Hold anticoagulants per clinical situation</p>
                                <p>Fever: Acetaminophen 650-1000 mg PO/PR q4-6h PRN temp &gt;37.8°C; target normothermia (SHINE: intensive glucose control is Class III Harm)</p>
                                <p>Insulin protocol: target BG 140-180 mg/dL; avoid hypoglycemia (&lt;60 mg/dL)</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-blue-700 mb-1">Labs & Imaging</p>
                                <p>CBC, CMP, PT/INR, PTT on admission</p>
                                <p>Lipid panel, HbA1c (fasting AM)</p>
                                <p>Troponin x 2 (q6h), BNP</p>
                                <p>CT head 24h post-TNK (or sooner if decline)</p>
                                <p>MRI brain with DWI if not obtained</p>
                                <p>TTE with bubble study (or TEE if indicated)</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-blue-700 mb-1">Consults & Therapy</p>
                                <p>PT/OT/Speech eval within 24h</p>
                                <p>Swallow evaluation before PO intake</p>
                                <p>Social work/case management</p>
                                <p>Cardiac monitoring (extended if no AF found)</p>
                              </div>
                            </div>
                          </div>
                        </details>

                        <details className="bg-red-50 border border-red-200 rounded-lg">
                          <summary className="cursor-pointer p-3 font-semibold text-red-800 text-sm">ICH (Intracerebral Hemorrhage) Orders</summary>
                          <div className="px-3 pb-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                              <div className="space-y-1">
                                <p className="font-bold text-red-700 mb-1">Monitoring</p>
                                <p>ICU admission (GCS &lt;8 or deteriorating)</p>
                                <p>Neuro checks q1h</p>
                                <p>Arterial line for continuous BP monitoring</p>
                                <p>VS q1h (strict BP control)</p>
                                <p>ICP monitoring if GCS &lt;8 or hydrocephalus</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-red-700 mb-1">BP & Medications</p>
                                <p>Target SBP &lt;140 mmHg (INTERACT2, Class IIa, LOE B-R). Avoid SBP &lt;130 (ATACH-2: no benefit, possible harm).</p>
                                <p>Nicardipine drip preferred (see BP section)</p>
                                <p>Reversal agents if on anticoagulation (see ICH tab)</p>
                                <p>Hold all antithrombotics</p>
                                <p>DVT prophylaxis: SCDs (delay SQ heparin 24-48h)</p>
                                <p>Seizure meds ONLY if clinical seizure (no prophylaxis)</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-red-700 mb-1">Labs & Imaging</p>
                                <p>STAT: CBC, CMP, PT/INR, PTT, fibrinogen</p>
                                <p>Type & screen</p>
                                <p>Repeat CT head at 6h or if neuro change</p>
                                <p>CTA if no known etiology (AVM, aneurysm)</p>
                                <p>Toxicology screen if young/no risk factors</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-red-700 mb-1">Consults</p>
                                <p>Neurosurgery (EVD if hydrocephalus; evac if indicated)</p>
                                <p>Goals of care discussion within 24h</p>
                                <p>PT/OT/Speech when stable</p>
                              </div>
                            </div>
                          </div>
                        </details>

                        <details className="bg-amber-50 border border-amber-200 rounded-lg">
                          <summary className="cursor-pointer p-3 font-semibold text-amber-800 text-sm">SAH (Subarachnoid Hemorrhage) Orders</summary>
                          <div className="px-3 pb-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                              <div className="space-y-1">
                                <p className="font-bold text-amber-700 mb-1">Monitoring</p>
                                <p>Neuro ICU admission</p>
                                <p>Neuro checks q1h</p>
                                <p>Arterial line, central line</p>
                                <p>Continuous EEG if poor grade or altered</p>
                                <p>Transcranial Dopplers (TCDs) daily starting day 3</p>
                                <p>Strict I&O, daily weights</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-amber-700 mb-1">Medications</p>
                                <p>Nimodipine 60 mg PO/NG q4h x 21 days</p>
                                <p>Target SBP &lt;160 until aneurysm secured</p>
                                <p>Euvolemia (avoid hypovolemia)</p>
                                <p>Stool softeners (avoid Valsalva)</p>
                                <p>Seizure prophylaxis: brief course if indicated (levetiracetam)</p>
                                <p>VTE prophylaxis: SCDs until aneurysm secured, then SQ heparin</p>
                                <p>Pain control: avoid NSAIDs; acetaminophen, short-acting opioids</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-amber-700 mb-1">Labs & Imaging</p>
                                <p>CBC, CMP, Mg, Phos q6-12h</p>
                                <p>PT/INR, PTT, fibrinogen on admit</p>
                                <p>CTA to identify aneurysm source</p>
                                <p>Conventional angiogram if CTA negative</p>
                                <p>CT head if neuro change</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-amber-700 mb-1">Consults & Goals</p>
                                <p>Neurosurgery/Neurointerventional (secure aneurysm &lt;24h)</p>
                                <p>Goals of care (especially poor-grade SAH)</p>
                                <p>Vasospasm watch days 3-14 (peak day 7-10)</p>
                              </div>
                            </div>
                          </div>
                        </details>

                        <details className="bg-teal-50 border border-teal-200 rounded-lg">
                          <summary className="cursor-pointer p-3 font-semibold text-teal-800 text-sm">TIA (Transient Ischemic Attack) Orders</summary>
                          <div className="px-3 pb-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                              <div className="space-y-1">
                                <p className="font-bold text-teal-700 mb-1">Risk Stratification</p>
                                <p>Admit ALL TIAs for urgent inpatient workup (Class I, LOE B-NR)</p>
                                <p>Do NOT use ABCD2 alone for disposition (poor sensitivity)</p>
                                <p>Rapid outpatient workup only if 24-48h evaluation can be guaranteed AND low-risk features</p>
                                <p>Crescendo TIA → admit, treat as high-risk</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-teal-700 mb-1">Workup</p>
                                <p>MRI brain with DWI (within 24h)</p>
                                <p>CTA or MRA head/neck</p>
                                <p>TTE with bubble study</p>
                                <p>Cardiac monitoring ≥24h (extended if cryptogenic)</p>
                                <p>Labs: CBC, CMP, lipid panel, HbA1c, PT/INR</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-teal-700 mb-1">Treatment</p>
                                <p>DAPT if minor stroke/high-risk TIA: ASA 325 load + clopidogrel 300 load, then ASA 81 + clopidogrel 75 x 21 days</p>
                                <p>Single antiplatelet if low-risk: ASA 81 mg daily</p>
                                <p>High-intensity statin: atorvastatin 80 mg</p>
                                <p>BP control: target &lt;130/80 (after acute phase)</p>
                                <p>If AF: anticoagulation per DOAC timing (see AF section)</p>
                              </div>
                              <div className="space-y-1">
                                <p className="font-bold text-teal-700 mb-1">Disposition</p>
                                <p>Stroke neurology follow-up within 1-2 weeks</p>
                                <p>PCP follow-up within 1 week</p>
                                <p>Driving restrictions counseling</p>
                                <p>Stroke education: FAST signs, when to call 911</p>
                              </div>
                            </div>
                          </div>
                        </details>

                      </div>
                    </details>

                    {/* Guideline Library */}
                    <div id="ref-guidelines" className="bg-white border border-indigo-200 rounded-lg p-4">
                      <div className="flex flex-wrap items-center justify-between gap-2 mb-3">
                        <div>
                          <h3 className="text-lg font-semibold text-indigo-800">Guideline Library</h3>
                          <p className="text-xs text-slate-600">Full COR/LOE recommendations with direct publisher PDF links.</p>
                        </div>
                        <span className="text-xs text-indigo-700 font-medium">{guidelineLibraryResultsCount} recommendations</span>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div className="relative">
                          <input
                            type="text"
                            placeholder="Search recommendations..."
                            value={guidelineLibraryQuery}
                            onChange={(e) => setGuidelineLibraryQuery(e.target.value)}
                            className="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            aria-label="Search guideline recommendations"
                          />
                          <i aria-hidden="true" data-lucide="search" className="w-4 h-4 absolute left-3 top-2.5 text-slate-500"></i>
                        </div>
                        <select
                          value={guidelineLibraryGuideline}
                          onChange={(e) => {
                            setGuidelineLibraryGuideline(e.target.value);
                            setGuidelineLibrarySection('');
                          }}
                          className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          aria-label="Filter by guideline"
                        >
                          <option value="">All guidelines</option>
                          {guidelineLibraryGuidelineOptions.map((option) => (
                            <option key={option.id} value={option.id}>{option.label}</option>
                          ))}
                        </select>
                        <select
                          value={guidelineLibrarySection}
                          onChange={(e) => setGuidelineLibrarySection(e.target.value)}
                          className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          aria-label="Filter by section"
                        >
                          <option value="">All sections</option>
                          {guidelineLibrarySectionOptions.map((section) => (
                            <option key={section} value={section}>{section}</option>
                          ))}
                        </select>
                        <select
                          value={guidelineLibraryClass}
                          onChange={(e) => setGuidelineLibraryClass(e.target.value)}
                          className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                          aria-label="Filter by class of recommendation"
                        >
                          <option value="">All classes</option>
                          {guidelineLibraryClassOptions.map((item) => (
                            <option key={item} value={item}>{item}</option>
                          ))}
                        </select>
                      </div>

                      {filteredGuidelineLibrary.length === 0 ? (
                        <p className="text-sm text-slate-600 mt-3">No recommendations match the current filters.</p>
                      ) : (
                        <div className="mt-4 space-y-3">
                          {filteredGuidelineLibrary.map((guideline) => {
                            const grouped = {};
                            guideline.recommendations.forEach((rec) => {
                              if (!grouped[rec.section]) grouped[rec.section] = [];
                              grouped[rec.section].push(rec);
                            });
                            const shouldExpand = Boolean(guidelineLibraryQuery || guidelineLibraryGuideline || guidelineLibrarySection || guidelineLibraryClass);
                            return (
                              <details key={guideline.id} className="border border-indigo-200 rounded-lg bg-indigo-50/40" open={shouldExpand}>
                                <summary className="cursor-pointer p-3 font-semibold text-indigo-900 hover:bg-indigo-100 rounded-lg flex items-center justify-between">
                                  <span>{guideline.shortTitle || guideline.title}</span>
                                  <span className="text-xs text-indigo-600">{guideline.recommendations.length} recs</span>
                                </summary>
                                <div className="p-3 pt-0 space-y-3">
                                  {Object.entries(grouped).map(([section, recs]) => (
                                    <details key={section} className="bg-white border border-indigo-100 rounded-lg" open={shouldExpand || guidelineLibrarySection === section}>
                                      <summary className="cursor-pointer px-3 py-2 text-sm font-semibold text-indigo-800 hover:bg-indigo-50 rounded-lg flex items-center justify-between">
                                        <span>{section}</span>
                                        <span className="text-xs text-indigo-500">{recs.length}</span>
                                      </summary>
                                      <div className="px-3 pb-3 space-y-2">
                                        {recs.map((rec) => {
                                          const recClass = rec.classOfRec || 'Statement';
                                          const recLevel = rec.levelOfEvidence || 'Ungraded';
                                          const classLabel = rec.classNote ? `${recClass} (${rec.classNote})` : recClass;
                                          const quickActions = getGuidelineQuickActions(rec.text);
                                          return (
                                            <div key={rec.id} className="border border-indigo-100 rounded-lg p-2 bg-indigo-50/50">
                                              <div className="flex items-start gap-2">
                                                <span className={`inline-flex items-center px-1.5 py-0.5 rounded text-xs font-bold shrink-0 ${GUIDELINE_CLASS_COLORS[recClass] || 'bg-slate-500 text-white'}`}>
                                                  {classLabel}/{recLevel}
                                                </span>
                                                <div className="flex-1 min-w-0">
                                                  <p className="text-sm text-slate-800">{rec.text}</p>
                                                  <p className="text-xs text-slate-500 mt-1">
                                                    {guideline.title}
                                                    {rec.page ? ` · p. ${rec.page}` : ''}
                                                  </p>
                                                  <div className="flex flex-wrap items-center gap-2 mt-1 text-xs">
                                                    {rec.sourceUrl && (
                                                      <a href={rec.sourceUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-0.5 text-indigo-600 hover:text-indigo-800 font-medium">
                                                        <i aria-hidden="true" data-lucide="external-link" className="w-3 h-3"></i>
                                                        <span>Publisher</span>
                                                      </a>
                                                    )}
                                                    {rec.pdfSourceUrl && (
                                                      <a href={rec.pdfSourceUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center gap-0.5 text-indigo-600 hover:text-indigo-800 font-medium">
                                                        <i aria-hidden="true" data-lucide="external-link" className="w-3 h-3"></i>
                                                        <span>PDF p.{rec.page}</span>
                                                      </a>
                                                    )}
                                                  </div>
                                                  {quickActions.length > 0 && (
                                                    <div className="flex flex-wrap gap-1 mt-2">
                                                      {quickActions.map((action) => (
                                                        <button
                                                          key={action.id}
                                                          type="button"
                                                          onClick={() => navigateTo(action.target.tab, { subTab: action.target.subTab })}
                                                          className="px-3 py-1.5 text-xs font-semibold rounded-full border border-indigo-200 text-indigo-700 hover:bg-indigo-100 min-h-[32px]"
                                                        >
                                                          {action.label}
                                                        </button>
                                                      ))}
                                                    </div>
                                                  )}
                                                </div>
                                              </div>
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </details>
                                  ))}
                                </div>
                              </details>
                            );
                          })}
                        </div>
                      )}
                    </div>

                    {/* Aneurysms & Vascular Malformations Section */}
                    {evidenceSectionMatches('Aneurysms & Vascular Malformations', ['Unruptured Cerebral Aneurysms']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Aneurysms & Vascular Malformations</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Unruptured Cerebral Aneurysms */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Unruptured Cerebral Aneurysms</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/aneurysms/Unruptured Cerebral Aneurysms.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/aneurysms/Unruptured Cerebral Aneurysms.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Unruptured Cerebral Aneurysms', 'documents/aneurysms/Unruptured Cerebral Aneurysms.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Antiplatelet Therapy Section */}
                    {evidenceSectionMatches('Antiplatelet Therapy', ['DAPT Minor Stroke-TIA Trials', 'DAPT After Ischemic Stroke-TIA']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Antiplatelet Therapy</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - DAPT Minor Stroke-TIA Trials */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">DAPT Minor Stroke-TIA Trials</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/antiplatelet/DAPT Minor Stroke-TIA Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/antiplatelet/DAPT Minor Stroke-TIA Trials.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('DAPT Minor Stroke-TIA Trials', 'documents/antiplatelet/DAPT Minor Stroke-TIA Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                        {/* Document 2 - DAPT After Ischemic Stroke-TIA */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="image" className="w-6 h-6 text-emerald-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">DAPT After Ischemic Stroke-TIA</h4>
                              <p className="text-xs text-slate-500">Infographic - Match Patient to Trial</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/antiplatelet/DAPT After Ischemic Stroke-TIA.jpeg"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/antiplatelet/DAPT After Ischemic Stroke-TIA.jpeg"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('DAPT After Ischemic Stroke-TIA', 'documents/antiplatelet/DAPT After Ischemic Stroke-TIA.jpeg')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Cerebral Small Vessel Disease Section */}
                    {evidenceSectionMatches('Cerebral Small Vessel Disease', ['Lacunar Stroke']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Cerebral Small Vessel Disease</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Lacunar Stroke */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Lacunar Stroke</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/csvd/Lacunar Stroke 7.13.22.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/csvd/Lacunar Stroke 7.13.22.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Lacunar Stroke', 'documents/csvd/Lacunar Stroke 7.13.22.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* EBM Section */}
                    {evidenceSectionMatches('EBM', ['Interpretation of Clinical Trials', 'CEBM Oxford Resources']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Critical Appraisal</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Interpretation of Clinical Trials */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Interpretation of Clinical Trials</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/ebm/Interpretation of Clinical Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/ebm/Interpretation of Clinical Trials.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Interpretation of Clinical Trials', 'documents/ebm/Interpretation of Clinical Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                        {/* External Link - CEBM Oxford Resources */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="external-link" className="w-6 h-6 text-blue-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">CEBM Oxford Resources</h4>
                              <p className="text-xs text-slate-500">Centre for Evidence-Based Medicine - University of Oxford</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="https://www.cebm.ox.ac.uk/resources"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="external-link" className="w-4 h-4"></i>
                              Visit
                            </a>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* EVT Section */}
                    {evidenceSectionMatches('EVT', ['Large Core Anterior Circulation LVO EVT Trials', 'Basilar Artery Occlusion EVT Trials', 'MeVO & Distal Vessel Occlusion EVT Trials']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Endovascular Therapy</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Large Core Anterior Circulation LVO EVT Trials */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Large Core Anterior Circulation LVO EVT Trials</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/evt/Large Core Anterior Circulation LVO EVT Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/evt/Large Core Anterior Circulation LVO EVT Trials.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Large Core Anterior Circulation LVO EVT Trials', 'documents/evt/Large Core Anterior Circulation LVO EVT Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Document 2 - Basilar Artery Occlusion EVT Trials */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Basilar Artery Occlusion EVT Trials</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/evt/Basilar Artery Occlusion EVT Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/evt/Basilar Artery Occlusion EVT Trials.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Basilar Artery Occlusion EVT Trials', 'documents/evt/Basilar Artery Occlusion EVT Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Document 3 - MeVO & Distal Vessel Occlusion EVT Trials */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">MeVO & Distal Vessel Occlusion EVT Trials</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/evt/MeVO & Distal Vessel Occlusion EVT Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/evt/MeVO & Distal Vessel Occlusion EVT Trials.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('MeVO & Distal Vessel Occlusion EVT Trials', 'documents/evt/MeVO & Distal Vessel Occlusion EVT Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Risk Factors Section */}
                    {evidenceSectionMatches('Risk Factors', ['Timing of Anticoagulation after AF-Related Stroke', 'Atrial Fibrillation & Secondary Stroke Prevention', 'AFib Stroke EPI519', 'Diabetes and stroke', 'Lipids and Cerebrovascular Disease']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Risk Factors</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-4 p-4 pt-0">

                        {/* Atrial Fibrillation Subsection */}
                        <div className="border-l-4 border-purple-500 pl-4">
                          <h4 className="text-base font-semibold text-purple-800 mb-3">Atrial Fibrillation</h4>
                          <div className="space-y-3">
                            {/* Document 1 - Timing of Anticoagulation after AF-Related Stroke */}
                            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-slate-900">Timing of Anticoagulation after AF-Related Stroke</h5>
                                  <p className="text-xs text-slate-500">PDF Document</p>
                                </div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <a
                                  href="documents/afib/AC timing after AF-related Stroke.pdf"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                                >
                                  <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                                  View
                                </a>
                                <a
                                  href="documents/afib/AC timing after AF-related Stroke.pdf"
                                  download
                                  className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                                >
                                  <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                                  Download
                                </a>
                                <button
                                  onClick={() => emailDocument('AC timing after AF-related Stroke', 'documents/afib/AC timing after AF-related Stroke.pdf')}
                                  className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                                  title="Email this document"
                                >
                                  <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                                  Email
                                </button>
                              </div>
                            </div>

                            {/* Document 2 - Atrial Fibrillation & Secondary Stroke Prevention */}
                            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-slate-900">Atrial Fibrillation & Secondary Stroke Prevention</h5>
                                  <p className="text-xs text-slate-500">PDF Document</p>
                                </div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <a
                                  href="documents/afib/AF & secondary stroke prevention July 2024.pdf"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                                >
                                  <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                                  View
                                </a>
                                <a
                                  href="documents/afib/AF & secondary stroke prevention July 2024.pdf"
                                  download
                                  className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                                >
                                  <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                                  Download
                                </a>
                                <button
                                  onClick={() => emailDocument('AF & secondary stroke prevention July 2024', 'documents/afib/AF & secondary stroke prevention July 2024.pdf')}
                                  className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                                  title="Email this document"
                                >
                                  <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                                  Email
                                </button>
                              </div>
                            </div>

                            {/* Document 3 - 2023 AHA AFib Guidelines */}
                            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i aria-hidden="true" data-lucide="external-link" className="w-6 h-6 text-purple-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-slate-900">2023 AHA AFib Guidelines</h5>
                                  <p className="text-xs text-slate-500">External Link - AHA Journals</p>
                                </div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <a
                                  href="https://www.ahajournals.org/doi/10.1161/CIR.0000000000001193"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-medium hover:bg-purple-700 transition-colors flex items-center gap-1"
                                >
                                  <i aria-hidden="true" data-lucide="external-link" className="w-4 h-4"></i>
                                  Open Link
                                </a>
                              </div>
                            </div>

                            {/* Document 4 - 2024 ESC AFib Guidelines */}
                            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i aria-hidden="true" data-lucide="external-link" className="w-6 h-6 text-purple-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-slate-900">2024 ESC AFib Guidelines</h5>
                                  <p className="text-xs text-slate-500">External Link - European Heart Journal</p>
                                </div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <a
                                  href="https://academic.oup.com/eurheartj/article/45/36/3314/7738779"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-medium hover:bg-purple-700 transition-colors flex items-center gap-1"
                                >
                                  <i aria-hidden="true" data-lucide="external-link" className="w-4 h-4"></i>
                                  Open Link
                                </a>
                              </div>
                            </div>

                            {/* Document 5 - AFib Stroke EPI519 */}
                            <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-slate-900">AFib Stroke EPI519</h5>
                                  <p className="text-xs text-slate-500">PDF Document</p>
                                </div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <a
                                  href="documents/afib/AFib Stroke EPI519.pdf"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                                >
                                  <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                                  View
                                </a>
                                <a
                                  href="documents/afib/AFib Stroke EPI519.pdf"
                                  download
                                  className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                                >
                                  <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                                  Download
                                </a>
                                <button
                                  onClick={() => emailDocument('AFib Stroke EPI519', 'documents/afib/AFib Stroke EPI519.pdf')}
                                  className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                                  title="Email this document"
                                >
                                  <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                                  Email
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Diabetes and stroke */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Diabetes and stroke</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/epidemiology/Diabetes and stroke.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/epidemiology/Diabetes and stroke.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Diabetes and stroke', 'documents/epidemiology/Diabetes and stroke.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Lipids and Cerebrovascular Disease */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Lipids and Cerebrovascular Disease</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/epidemiology/Lipids and Cerebrovascular Disease.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/epidemiology/Lipids and Cerebrovascular Disease.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Lipids and Cerebrovascular Disease', 'documents/epidemiology/Lipids and Cerebrovascular Disease.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Thrombolytic Therapy Section */}
                    {evidenceSectionMatches('Thrombolytic Therapy', ['Thrombolytic Therapy AIS 4.5-24h RCTs', 'WAKE-UP Trial']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Thrombolytic Therapy</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Thrombolytic Therapy AIS 4.5-24h RCTs */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Thrombolytic Therapy AIS 4.5-24h RCTs</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/thrombolytic/Thrombolytic Therapy AIS 4.5-24h RCTs.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/thrombolytic/Thrombolytic Therapy AIS 4.5-24h RCTs.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Thrombolytic Therapy AIS 4.5-24h RCTs', 'documents/thrombolytic/Thrombolytic Therapy AIS 4.5-24h RCTs.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Document 2 - WAKE-UP Trial */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="external-link" className="w-6 h-6 text-blue-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">WAKE-UP Trial</h4>
                              <p className="text-xs text-slate-500">External Link - New England Journal of Medicine</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="https://www.nejm.org/doi/full/10.1056/NEJMoa1804355"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="external-link" className="w-4 h-4"></i>
                              Open Link
                            </a>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Exam Section */}
                    {evidenceSectionMatches('Exam', ['Differentiating Acute Confusional State (Delirium) from Aphasia', 'Coma Exam']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Exam</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Differentiating Delirium from Aphasia */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Differentiating Acute Confusional State (Delirium) from Aphasia</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/exam/Differentiating Acute Confusional State (Delirium) from Aphasia.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/exam/Differentiating Acute Confusional State (Delirium) from Aphasia.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Differentiating Acute Confusional State (Delirium) from Aphasia', 'documents/exam/Differentiating Acute Confusional State (Delirium) from Aphasia.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Document 2 - Coma Exam */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Coma Exam</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/exam/coma exam.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/exam/coma exam.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('coma exam', 'documents/exam/coma exam.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Large Artery Disease Section */}
                    {evidenceSectionMatches('Large Artery Disease', ['Symptomatic Cervical Carotid Artery Stenosis', 'CREST-2 Trial']) && (
                    <details className="bg-white border border-slate-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-slate-800 hover:bg-slate-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Large Artery Disease</span>
                        <i aria-hidden="true" data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Symptomatic Cervical Carotid Artery Stenosis */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">Symptomatic Cervical Carotid Artery Stenosis</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/lad/Symptomatic Cervical Carotid Artery Stenosis.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/lad/Symptomatic Cervical Carotid Artery Stenosis.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Symptomatic Cervical Carotid Artery Stenosis', 'documents/lad/Symptomatic Cervical Carotid Artery Stenosis.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                        {/* Document 2 - CREST-2 Trial */}
                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i aria-hidden="true" data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-slate-900">CREST-2 Trial (December 2025)</h4>
                              <p className="text-xs text-slate-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/lad/CREST-2 Trial - Dec 2025.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/lad/CREST-2 Trial - Dec 2025.pdf"
                              download
                              className="px-3 py-2 bg-slate-600 text-white rounded-lg text-xs font-medium hover:bg-slate-700 transition-colors flex items-center gap-1"
                            >
                              <i aria-hidden="true" data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('CREST-2 Trial (December 2025)', 'documents/lad/CREST-2 Trial - Dec 2025.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i aria-hidden="true" data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                  </div>
                )}
                {/* End of References/Evidence Content */}

                  </div>
                </ErrorBoundary>
                )}
                {/* End of Combined Management Tab (Ischemic, ICH, Calculators, References) */}

                {/* ============================================ */}
                {/* CLINICAL TRIALS TAB                          */}
                {/* Uses trialsData object and TrialCard component */}
                {/* ============================================ */}
                {(activeTab === 'trials' || (activeTab === 'library' && librarySection === 'trials')) && (
                  <div id="tabpanel-trials" role="tabpanel" aria-labelledby="tab-trials" className="space-y-6">
                    {/* Header Section with Patient Summary */}
                    <div className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                      <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div>
                          <h2 className="text-3xl font-bold flex items-center gap-3">
                            <i aria-hidden="true" data-lucide="flask-conical" className="w-7 h-7"></i> Clinical Trials
                          </h2>
                          <p className="text-blue-100 mt-1">Reference for active clinical trials</p>
                        </div>

                      </div>

                    </div>

                    {/* Diagnosis-based recommendation banner */}
                    {telestrokeNote.diagnosisCategory && (telestrokeNote.diagnosisCategory === 'ischemic' || telestrokeNote.diagnosisCategory === 'ich') && (
                      <div className={`mb-4 p-4 rounded-lg border-2 flex items-center gap-3 ${
                        telestrokeNote.diagnosisCategory === 'ischemic'
                          ? 'bg-blue-50 border-blue-300 text-blue-800'
                          : 'bg-red-50 border-red-300 text-red-800'
                      }`}>
                        <i aria-hidden="true" data-lucide="target" className="w-5 h-5"></i>
                        <div>
                          <span className="font-semibold">
                            Patient Diagnosis: {telestrokeNote.diagnosisCategory === 'ischemic' ? 'Suspected Ischemic Stroke' : 'ICH'}
                          </span>
                          <span className="ml-2 text-sm opacity-75">
                            — Showing {telestrokeNote.diagnosisCategory === 'ischemic' ? 'ischemic stroke' : 'ICH'} trials by default
                          </span>
                        </div>
                        {trialsCategory !== telestrokeNote.diagnosisCategory && (
                          <button
                            onClick={() => setTrialsCategory(telestrokeNote.diagnosisCategory)}
                            className={`ml-auto px-3 py-1 rounded text-sm font-medium ${
                              telestrokeNote.diagnosisCategory === 'ischemic'
                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                : 'bg-red-600 text-white hover:bg-red-700'
                            }`}
                          >
                            Show Recommended Trials
                          </button>
                        )}
                      </div>
                    )}

                    {/* Trial Category Filter Buttons */}
                    <div className="flex flex-wrap gap-2 mb-6">
                      {Object.keys(trialsData).map(category => {
                        const categoryData = trialsData[category];
                        const totalTrialCount = countTrialsInCategory(categoryData, { filtered: false });
                        const visibleTrialCount = countTrialsInCategory(categoryData, { filtered: true });
                        const displayCount = trialsRecruitingOnly ? `${visibleTrialCount}/${totalTrialCount}` : `${totalTrialCount}`;

                        const getCategoryColor = (cat) => {
                          switch(cat) {
                            case 'ischemic': return 'bg-blue-600 hover:bg-blue-700';
                            case 'ich': return 'bg-red-600 hover:bg-red-700';
                            case 'rehab': return 'bg-emerald-600 hover:bg-emerald-700';
                            case 'cadasil': return 'bg-purple-600 hover:bg-purple-700';
                            default: return 'bg-slate-600 hover:bg-slate-700';
                          }
                        };

                        const getCategoryName = (cat) => {
                          switch(cat) {
                            case 'ischemic': return 'Ischemic Stroke';
                            case 'ich': return 'Intracerebral Hemorrhage';
                            case 'rehab': return 'Rehabilitation';
                            case 'cadasil': return 'CADASIL';
                            default: return categoryData.title;
                          }
                        };

                        // Check if this category matches patient diagnosis
                        const isRecommended = telestrokeNote.diagnosisCategory === category;

                        return (
                          <button
                            key={category}
                            onClick={() => setTrialsCategory(category)}
                            className={`relative px-4 py-2 rounded-full font-medium transition-all ${
                              trialsCategory === category
                                ? `${getCategoryColor(category)} text-white shadow-lg`
                                : isRecommended
                                  ? 'bg-slate-200 text-slate-700 hover:bg-slate-300 ring-2 ring-offset-1 ring-yellow-400'
                                  : 'bg-slate-200 text-slate-700 hover:bg-slate-300'
                            }`}
                          >
                            {isRecommended && (
                              <span className="absolute -top-2 -right-1 text-xs bg-amber-400 text-amber-900 px-1.5 py-0.5 rounded-full font-bold">
                                <i aria-hidden="true" data-lucide="star" className="w-3 h-3 inline"></i>
                              </span>
                            )}
                            {getCategoryName(category)} ({displayCount})
                          </button>
                        );
                      })}
                    </div>

                    <div className="mb-4 flex flex-wrap items-center justify-between gap-2">
                      <span className="text-xs text-slate-500">
                        Trial card controls{trialsRecruitingOnly ? ' • showing recruiting/enrolling only' : ''}
                      </span>
                      <div className="flex items-center gap-2">
                        <button
                          type="button"
                          onClick={() => setTrialsRecruitingOnly((prev) => !prev)}
                          className={`px-3 py-1.5 rounded-lg border text-xs font-semibold transition-colors ${
                            trialsRecruitingOnly
                              ? 'border-emerald-300 bg-emerald-50 text-emerald-700 hover:bg-emerald-100'
                              : 'border-slate-300 bg-white text-slate-700 hover:bg-slate-50'
                          }`}
                        >
                          {trialsRecruitingOnly ? 'Recruiting Only: On' : 'Recruiting Only'}
                        </button>
                        <button
                          type="button"
                          onClick={() => setVisibleTrialCardsOpen(true)}
                          className="px-3 py-1.5 rounded-lg border border-blue-200 bg-blue-50 text-blue-700 text-xs font-semibold hover:bg-blue-100"
                        >
                          Expand Visible
                        </button>
                        <button
                          type="button"
                          onClick={() => setVisibleTrialCardsOpen(false)}
                          className="px-3 py-1.5 rounded-lg border border-slate-300 bg-white text-slate-700 text-xs font-semibold hover:bg-slate-50"
                        >
                          Collapse Visible
                        </button>
                      </div>
                    </div>

                    {/* Patient-based Trial Relevance Summary */}
                    {(telestrokeNote.age || nihssScore > 0) && (
                      <div className="bg-gradient-to-r from-slate-50 to-blue-50 border border-slate-200 rounded-xl p-4">
                        <h3 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2">
                          <i aria-hidden="true" data-lucide="user-check" className="w-4 h-4 text-blue-600"></i>
                          Patient-Specific Trial Relevance
                        </h3>
                        <div className="flex flex-wrap gap-2 text-xs">
                          {telestrokeNote.age && <span className="px-2 py-1 bg-white border rounded-full text-slate-700">Age: {telestrokeNote.age}</span>}
                          {(nihssScore > 0 || telestrokeNote.nihss) && <span className="px-2 py-1 bg-white border rounded-full text-slate-700">NIHSS: {telestrokeNote.nihss || nihssScore}</span>}
                          {telestrokeNote.diagnosis && <span className="px-2 py-1 bg-white border rounded-full text-slate-700">Dx: {telestrokeNote.diagnosis}</span>}
                          {calculateGCS(gcsItems) > 0 && <span className="px-2 py-1 bg-white border rounded-full text-slate-700">GCS: {calculateGCS(gcsItems)}</span>}
                        </div>
                        <div className="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2 text-xs">
                          {nihssScore >= 4 && trialsCategory === 'ischemic' && (
                            <div className="flex items-center gap-1.5 text-emerald-700 bg-emerald-50 rounded-lg px-2 py-1.5">
                              <i aria-hidden="true" data-lucide="check-circle" className="w-3.5 h-3.5"></i>
                              <span><strong>SISTER:</strong> NIHSS {'\u2265'}4 threshold met{nihssScore <= 5 ? ' (requires disabling deficit)' : ''}</span>
                            </div>
                          )}
                          {nihssScore > 0 && nihssScore <= 5 && trialsCategory === 'ischemic' && (
                            <div className="flex items-center gap-1.5 text-amber-700 bg-amber-50 rounded-lg px-2 py-1.5">
                              <i aria-hidden="true" data-lucide="alert-circle" className="w-3.5 h-3.5"></i>
                              <span><strong>STEP mild arm:</strong> Check for LVO</span>
                            </div>
                          )}
                          {(() => { const gcs = calculateGCS(gcsItems); return gcs >= 5 && gcs <= 14 && trialsCategory === 'ich' ? (
                            <div className="flex items-center gap-1.5 text-blue-700 bg-blue-50 rounded-lg px-2 py-1.5">
                              <i aria-hidden="true" data-lucide="check-circle" className="w-3.5 h-3.5"></i>
                              <span><strong>ENRICH:</strong> GCS 5-14 range met</span>
                            </div>
                          ) : null; })()}
                          {telestrokeNote.age && parseInt(telestrokeNote.age, 10) >= 18 && parseInt(telestrokeNote.age, 10) <= 85 && (
                            <div className="flex items-center gap-1.5 text-slate-600 bg-slate-50 rounded-lg px-2 py-1.5">
                              <i aria-hidden="true" data-lucide="info" className="w-3.5 h-3.5"></i>
                              <span>Age within most trial ranges (18-85)</span>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Trial Cards - Uses trialsData and TrialCard component */}
                    <div className="space-y-4">
                      {(() => {
                        const categoryData = trialsData[trialsCategory];
                        const visibleTrialCount = countTrialsInCategory(categoryData, { filtered: true });
                        return (
                          <div className="space-y-4">
                            <h2 className="text-2xl font-bold text-slate-800 border-b-2 border-slate-300 pb-2">
                              {categoryData.title}
                            </h2>
                            {trialsRecruitingOnly && visibleTrialCount === 0 && (
                              <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800 flex flex-wrap items-center justify-between gap-2">
                                <span>No actively recruiting/enrolling trials in this category. Switch filter off to view all studies.</span>
                                <button
                                  type="button"
                                  onClick={() => setTrialsRecruitingOnly(false)}
                                  className="px-3 py-1.5 rounded-lg border border-amber-300 bg-white text-amber-800 text-xs font-semibold hover:bg-amber-100"
                                >
                                  Show All Trials
                                </button>
                              </div>
                            )}
                            {categoryData.hasSubsections ? (
                              Object.entries(categoryData.subsections).map(([subKey, subsection]) => {
                                const visibleTrials = filterTrialsForDisplay(subsection.trials);
                                if (visibleTrials.length === 0) return null;
                                return (
                                  <div key={subKey} className="space-y-4">
                                    <h3 className="text-xl font-semibold text-slate-700 ml-4">
                                      {subsection.title}
                                    </h3>
                                    {visibleTrials.map((trial, index) =>
                                      renderTrialCard(trial, trialsCategory, `${subKey}-${index}`)
                                    )}
                                  </div>
                                );
                              })
                            ) : (
                              filterTrialsForDisplay(categoryData.trials).map((trial, index) =>
                                renderTrialCard(trial, trialsCategory, index)
                              )
                            )}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}
                {/* End Clinical Trials Tab */}

              </div>

            </div>

            {/* Sticky Action Bar - single encounter workflow rail */}
            {showEncounterActionBar && (
              <div className="fixed inset-x-0 bottom-0 z-40 no-print">
                <div className="mx-auto max-w-7xl px-2 sm:px-4 pb-2 sm:pb-3">
                  <div className="bg-white/95 backdrop-blur border border-slate-200 shadow-lg rounded-xl px-3 py-2 sm:px-4 sm:py-3">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                      <div className="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-slate-500">
                        <i aria-hidden="true" data-lucide="list-checks" className="w-3.5 h-3.5"></i>
                        Next Steps
                      </div>
                      <div className="flex flex-wrap items-center gap-2">
                        <button
                          type="button"
                          onClick={() => scrollToSection('treatment-decision')}
                          className="px-3 py-2 rounded-lg text-xs font-semibold border border-red-200 bg-red-50 text-red-700 hover:bg-red-100"
                        >
                          1. Check Contraindications
                        </button>
                        <button
                          type="button"
                          onClick={() => scrollToSection('treatment-decision')}
                          className="px-3 py-2 rounded-lg text-xs font-semibold border border-blue-200 bg-blue-50 text-blue-700 hover:bg-blue-100"
                        >
                          2. Calculate TNK Dose
                        </button>
                        <button
                          type="button"
                          onClick={() => {
                            const note = generateTelestrokeNote();
                            copyToClipboard(note, 'Consult Note');
                          }}
                          className="px-3 py-2 rounded-lg text-xs font-semibold border border-emerald-300 bg-emerald-600 text-white hover:bg-emerald-700"
                        >
                          3. Copy Consult Note
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* ===== CALCULATOR DRAWER — with inline GCS + quick nav ===== */}
            {calcDrawerOpen && (
              <>
                <div className="fixed inset-0 z-50 bg-black/30" onClick={() => setCalcDrawerOpen(false)} role="presentation" aria-hidden="true"></div>
                <div className="fixed inset-x-0 bottom-0 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 z-50 w-full sm:w-[32rem] sm:max-h-[85vh] bg-white sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="calc-drawer-title">
                  <div className="sticky top-0 bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between z-10">
                    <h2 id="calc-drawer-title" className="text-base font-semibold text-slate-900 flex items-center gap-2">
                      <i aria-hidden="true" data-lucide="calculator" className="w-4 h-4 text-blue-600"></i>
                      Calculators
                      <kbd className="text-xs text-slate-500 font-mono ml-2">Ctrl+Shift+K</kbd>
                    </h2>
                    <button onClick={() => setCalcDrawerOpen(false)} className="p-2 hover:bg-slate-100 rounded-lg min-h-[36px] min-w-[36px] flex items-center justify-center focus:ring-2 focus:ring-blue-500" aria-label="Close calculators">
                      <i aria-hidden="true" data-lucide="x" className="w-5 h-5 text-slate-500"></i>
                    </button>
                  </div>

                  {/* Inline GCS Quick Score */}
                  <div className="px-4 py-3 border-b border-slate-100 bg-slate-50">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-semibold text-slate-800">Quick GCS</span>
                      <span className="text-lg font-bold text-slate-600">{calculateGCS(gcsItems) || '—'}</span>
                    </div>
                    <div className="grid grid-cols-3 gap-2 text-xs">
                      <fieldset className="border-0 p-0 m-0">
                        <legend className="font-medium text-slate-700 block mb-1">Eye</legend>
                        <div role="radiogroup" aria-label="GCS Eye Opening Response">
                        {[{v:'4',l:'Spontaneous'},{v:'3',l:'Sound'},{v:'2',l:'Pain'},{v:'1',l:'None'}].map(o => (
                          <button key={o.v} role="radio" aria-checked={gcsItems.eye === o.v} aria-label={`Eye ${o.l} (${o.v} points)`} onClick={() => setGcsItems(prev => ({...prev, eye: o.v}))}
                            className={`w-full text-left px-2 py-2.5 rounded mb-0.5 min-h-[36px] transition-colors ${gcsItems.eye === o.v ? 'bg-blue-600 text-white font-medium' : 'hover:bg-slate-200 text-slate-700'}`}>
                            {o.v} - {o.l}
                          </button>
                        ))}
                        </div>
                      </fieldset>
                      <fieldset className="border-0 p-0 m-0">
                        <legend className="font-medium text-slate-700 block mb-1">Verbal</legend>
                        <div role="radiogroup" aria-label="GCS Verbal Response">
                        {[{v:'5',l:'Oriented'},{v:'4',l:'Confused'},{v:'3',l:'Words'},{v:'2',l:'Sounds'},{v:'1',l:'None'}].map(o => (
                          <button key={o.v} role="radio" aria-checked={gcsItems.verbal === o.v} aria-label={`Verbal ${o.l} (${o.v} points)`} onClick={() => setGcsItems(prev => ({...prev, verbal: o.v}))}
                            className={`w-full text-left px-2 py-2.5 rounded mb-0.5 min-h-[36px] transition-colors ${gcsItems.verbal === o.v ? 'bg-blue-600 text-white font-medium' : 'hover:bg-slate-200 text-slate-700'}`}>
                            {o.v} - {o.l}
                          </button>
                        ))}
                        </div>
                      </fieldset>
                      <fieldset className="border-0 p-0 m-0">
                        <legend className="font-medium text-slate-700 block mb-1">Motor</legend>
                        <div role="radiogroup" aria-label="GCS Motor Response">
                        {[{v:'6',l:'Obeys'},{v:'5',l:'Localizes'},{v:'4',l:'Withdraws'},{v:'3',l:'Flexion'},{v:'2',l:'Extension'},{v:'1',l:'None'}].map(o => (
                          <button key={o.v} role="radio" aria-checked={gcsItems.motor === o.v} aria-label={`Motor ${o.l} (${o.v} points)`} onClick={() => setGcsItems(prev => ({...prev, motor: o.v}))}
                            className={`w-full text-left px-2 py-2.5 rounded mb-0.5 min-h-[36px] transition-colors ${gcsItems.motor === o.v ? 'bg-blue-600 text-white font-medium' : 'hover:bg-slate-200 text-slate-700'}`}>
                            {o.v} - {o.l}
                          </button>
                        ))}
                        </div>
                      </fieldset>
                    </div>
                  </div>

                  {/* Calculator Navigation */}
                  <div className="p-3">
                    <p className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Acute Scoring</p>
                    <div className="grid grid-cols-2 gap-1.5 mb-3">
                      {[
                        { label: 'NIHSS', desc: 'Stroke severity', action: () => { setCalcDrawerOpen(false); navigateTo('encounter'); setEncounterPhase('phase-triage'); setTimeout(() => scrollToSection('nihss-section'), 100); }},
                        { label: 'ASPECTS', desc: 'Ischemic changes', action: () => { setCalcDrawerOpen(false); navigateTo('encounter'); setEncounterPhase('phase-triage'); }},
                        { label: 'ICH Score', desc: 'ICH prognosis', action: () => { setCalcDrawerOpen(false); navigateTo('management', { subTab: 'calculators' }); }},
                        { label: 'Hunt & Hess', desc: 'SAH severity', action: () => { setCalcDrawerOpen(false); navigateTo('management', { subTab: 'calculators' }); }}
                      ].map(c => (
                        <button key={c.label} onClick={c.action} className="flex items-center justify-between px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 focus:ring-2 focus:ring-blue-500 text-left">
                          <div><div className="font-medium text-sm text-slate-900">{c.label}</div><div className="text-xs text-slate-500">{c.desc}</div></div>
                          <i aria-hidden="true" data-lucide="chevron-right" className="w-3.5 h-3.5 text-slate-500"></i>
                        </button>
                      ))}
                    </div>
                    <p className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Risk Stratification</p>
                    <div className="grid grid-cols-2 gap-1.5 mb-3">
                      {[
                        { label: 'ABCD\u00B2', desc: 'TIA stroke risk' },
                        { label: 'CHA\u2082DS\u2082-VASc', desc: 'AF stroke risk' },
                        { label: 'HAS-BLED', desc: 'Bleeding risk' },
                        { label: 'ROPE', desc: 'PFO attribution' },
                        { label: 'RCVS\u00B2', desc: 'Vasoconstriction' }
                      ].map(c => (
                        <button key={c.label} onClick={() => { setCalcDrawerOpen(false); navigateTo('management', { subTab: 'calculators' }); }} className="flex items-center justify-between px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 focus:ring-2 focus:ring-blue-500 text-left">
                          <div><div className="font-medium text-sm text-slate-900">{c.label}</div><div className="text-xs text-slate-500">{c.desc}</div></div>
                          <i aria-hidden="true" data-lucide="chevron-right" className="w-3.5 h-3.5 text-slate-500"></i>
                        </button>
                      ))}
                    </div>
                    <p className="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Dosing / Volume</p>
                    <div className="grid grid-cols-2 gap-1.5">
                      {[
                        { label: 'CrCl / eGFR', desc: 'Renal function' },
                        { label: 'ICH Volume', desc: 'ABC/2 method' }
                      ].map(c => (
                        <button key={c.label} onClick={() => { setCalcDrawerOpen(false); navigateTo('management', { subTab: 'calculators' }); }} className="flex items-center justify-between px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg hover:bg-blue-50 hover:border-blue-200 focus:ring-2 focus:ring-blue-500 text-left">
                          <div><div className="font-medium text-sm text-slate-900">{c.label}</div><div className="text-xs text-slate-500">{c.desc}</div></div>
                          <i aria-hidden="true" data-lucide="chevron-right" className="w-3.5 h-3.5 text-slate-500"></i>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* ===== CHANGELOG MODAL ===== */}
            {showChangelog && (
              <>
                <div className="fixed inset-0 z-[150] bg-black/40" onClick={() => setShowChangelog(false)} role="presentation" aria-hidden="true"></div>
                <div role="dialog" aria-modal="true" aria-labelledby="changelog-title" className="fixed inset-x-4 top-[10%] sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 z-[150] w-auto sm:w-[28rem] max-h-[70vh] bg-white rounded-2xl shadow-2xl overflow-y-auto">
                  <div className="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between z-10">
                    <h2 id="changelog-title" className="text-base font-bold text-slate-900">What's New</h2>
                    <button onClick={() => setShowChangelog(false)} className="p-2 hover:bg-slate-100 rounded-lg min-h-[36px] min-w-[36px] flex items-center justify-center focus:ring-2 focus:ring-blue-500" aria-label="Close changelog"><i aria-hidden="true" data-lucide="x" className="w-5 h-5 text-slate-500"></i></button>
                  </div>
                  <div className="p-4 space-y-4">
                    {CHANGELOG.map((release) => (
                      <div key={release.version}>
                        <div className="flex items-center gap-2 mb-2">
                          <span className="font-bold text-blue-700">v{release.version}</span>
                          <span className="text-xs text-slate-500">{release.date}</span>
                        </div>
                        <ul className="space-y-1">
                          {release.items.map((item, i) => (
                            <li key={i} className="text-sm text-slate-700 flex gap-2">
                              <span className="text-emerald-500 shrink-0">+</span>
                              <span>{item}</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}

            {/* ===== KEYBOARD SHORTCUT HELP ===== */}
            {showKeyboardHelp && (
              <>
                <div className="fixed inset-0 z-[150] bg-black/40" onClick={() => setShowKeyboardHelp(false)} role="presentation" aria-hidden="true"></div>
                <div role="dialog" aria-modal="true" aria-labelledby="keyboard-help-title" className="fixed inset-x-4 top-[10%] sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 z-[150] w-auto sm:w-[24rem] bg-white rounded-2xl shadow-2xl overflow-hidden">
                  <div className="sticky top-0 bg-white border-b px-4 py-3 flex items-center justify-between">
                    <h2 id="keyboard-help-title" className="text-base font-bold text-slate-900">Keyboard Shortcuts</h2>
                    <button onClick={() => setShowKeyboardHelp(false)} className="p-2 hover:bg-slate-100 rounded-lg min-h-[36px] min-w-[36px] flex items-center justify-center focus:ring-2 focus:ring-blue-500" aria-label="Close keyboard shortcuts"><i aria-hidden="true" data-lucide="x" className="w-5 h-5 text-slate-500"></i></button>
                  </div>
                  <div className="p-4 space-y-3">
                    {[
                      { keys: 'Ctrl/Cmd + 1', action: 'Dashboard tab' },
                      { keys: 'Ctrl/Cmd + 2', action: 'Encounter tab' },
                      { keys: 'Ctrl/Cmd + 3', action: 'Library tab' },
                      { keys: 'Ctrl/Cmd + 4', action: 'Settings tab' },
                      { keys: '1 / 2 / 3 / 4', action: 'Encounter phase: Triage / Decision / Management / Documentation' },
                      { keys: 'Ctrl/Cmd + Shift + C', action: 'Copy consult note' },
                      { keys: 'Ctrl/Cmd + Shift + N', action: 'Jump to next required field' },
                      { keys: 'Ctrl/Cmd + K', action: 'Open search' },
                      { keys: 'Ctrl/Cmd + Shift + K', action: 'Toggle calculators' },
                      { keys: '/', action: 'Focus search' },
                      { keys: 'Ctrl/Cmd + Shift + F', action: 'Toggle focus mode' },
                      { keys: 'Esc', action: 'Close modal / dialog' },
                      { keys: '?', action: 'Toggle this help' }
                    ].map(({ keys, action }) => (
                      <div key={keys} className="flex items-center justify-between">
                        <span className="text-sm text-slate-700">{action}</span>
                        <kbd className="px-2 py-1 bg-slate-100 border border-slate-300 rounded text-xs font-mono text-slate-600">{keys}</kbd>
                      </div>
                    ))}
                    <div className="pt-2 mt-2 border-t border-slate-100">
                      <p className="text-xs font-semibold uppercase tracking-wide text-slate-500 mb-2">Search Command Examples</p>
                      <div className="grid grid-cols-1 gap-1.5">
                        {QUICK_SEARCH_COMMANDS.map((command) => (
                          <div key={command.value} className="flex items-center justify-between gap-2">
                            <kbd className="px-2 py-1 bg-blue-50 border border-blue-200 rounded text-xs font-mono text-blue-700">{command.label}</kbd>
                            <span className="text-xs text-slate-600 text-right">{command.hint}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* ===== CONFIRMATION MODAL ===== */}
            {confirmConfig && (
              <ConfirmModal config={confirmConfig} onClose={handleConfirmClose} />
            )}

            {/* ===== TOAST CONTAINER ===== */}
            <ToastContainer toasts={toasts} removeToast={removeToast} />

            {/* Mobile bottom nav removed — top nav is now sticky on mobile */}

          </div>
          );
        };

        // Render the component
        const root = createRoot(document.getElementById('root'));
        root.render(<StrokeClinicalTool />);

        // Initialize Lucide icons
        createIcons({ icons });
