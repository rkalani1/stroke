<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Comprehensive clinical decision support tool for stroke management including NIHSS, ASPECTS, and treatment protocols">
    <meta name="theme-color" content="#3B82F6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <!-- Aggressive cache control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>stroke CDS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js?v=20251016c"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js?v=20251016c"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js?v=20251016c"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js?v=20251016c"></script>
    <script src="https://cdn.tailwindcss.com?v=20251016c"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js?v=20251016c"></script>
    <style>
        /* Dark mode styles */
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white { background-color: #2d3748; }
        .dark .text-gray-800 { color: #e2e8f0; }
        .dark .text-gray-700 { color: #cbd5e0; }
        .dark .text-gray-600 { color: #a0aec0; }
        .dark .border-gray-200 { border-color: #4a5568; }
        .dark .bg-gray-50 { background-color: #2d3748; }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #1a202c;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1a202c transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Touch targets minimum 44px */
        button, input[type="checkbox"], input[type="radio"], select {
            min-height: 44px;
            min-width: 44px;
        }
        input[type="checkbox"], input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 12px;
        }

        /* Success animation */
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .success-pulse {
            animation: successPulse 0.6s;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        // CRITICAL: Version management and automatic data cleanup
        // This runs BEFORE React loads to prevent crashes from incompatible data
        (function() {
            const APP_VERSION = 'v2.1.0-encounter-enhancements'; // Increment this with each deployment
            const storedVersion = localStorage.getItem('app_version');

            // If version doesn't match, clear ALL localStorage to prevent crashes
            if (storedVersion !== APP_VERSION) {
                console.log('Version change detected (' + storedVersion + ' -> ' + APP_VERSION + '). Clearing localStorage for compatibility.');
                const darkModeValue = localStorage.getItem('darkMode'); // Preserve dark mode preference
                localStorage.clear();
                if (darkModeValue) {
                    localStorage.setItem('darkMode', darkModeValue);
                }
                localStorage.setItem('app_version', APP_VERSION);
            }

            // Dark mode initialization
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body>
    <div id="root"></div>

    <script>
        // Enhanced error handler with automatic recovery
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error caught:', msg, 'at line', lineNo);

            // If critical error occurs, clear localStorage and reload ONCE
            if (msg && (msg.includes('is not a function') || msg.includes('undefined'))) {
                const hasReloaded = sessionStorage.getItem('error_reload_attempted');
                if (!hasReloaded) {
                    console.log('Critical error detected. Clearing data and reloading...');
                    sessionStorage.setItem('error_reload_attempted', 'true');
                    localStorage.clear();
                    window.location.reload();
                } else {
                    // If already reloaded once, show error message instead of infinite loop
                    document.getElementById('root').innerHTML =
                        '<div style="padding: 40px; font-family: Arial; max-width: 600px; margin: 0 auto;">' +
                        '<h1 style="color: #dc2626;">Unable to Load Application</h1>' +
                        '<p style="color: #374151; margin: 20px 0;">A critical error occurred. Please try:</p>' +
                        '<ol style="color: #374151;">' +
                        '<li>Use a different browser (Chrome, Firefox, Safari)</li>' +
                        '<li>Try Incognito/Private mode</li>' +
                        '<li>Contact support if issue persists</li>' +
                        '</ol>' +
                        '<p style="color: #6b7280; font-size: 14px; margin-top: 30px;">Error: ' + msg + '</p>' +
                        '</div>';
                }
            }
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Calculator, Clock, Brain, AlertTriangle, FileText, CheckCircle, Moon, Sun, Download, Copy, Search, Check } = lucide;

        const StrokeClinicalTool = () => {
          // Load saved data from localStorage with validation
          const loadFromStorage = (key, defaultValue) => {
            try {
              const saved = localStorage.getItem(key);
              if (!saved) return defaultValue;

              const parsed = JSON.parse(saved);

              // Validate that arrays are actually arrays (fix for completedSteps issue)
              if (Array.isArray(defaultValue) && !Array.isArray(parsed)) {
                console.warn(`Invalid data type for ${key}, expected array. Resetting to default.`);
                return defaultValue;
              }

              return parsed;
            } catch (e) {
              console.warn(`Error loading ${key} from localStorage:`, e);
              return defaultValue;
            }
          };

          // Force activeTab to always start as 'encounter' - load saved value in useEffect after mount
          const [activeTab, setActiveTab] = useState('encounter');
          const [patientData, setPatientData] = useState(loadFromStorage('patientData', {}));
          const [nihssScore, setNihssScore] = useState(loadFromStorage('nihssScore', 0));
          const [aspectsScore, setAspectsScore] = useState(loadFromStorage('aspectsScore', 10));
          const [darkMode, setDarkMode] = useState(localStorage.getItem('darkMode') === 'true');
          const [searchQuery, setSearchQuery] = useState('');
          const [showSuccess, setShowSuccess] = useState(false);
          const [isCalculating, setIsCalculating] = useState(false);
          const [copiedText, setCopiedText] = useState('');
          const [isMounted, setIsMounted] = useState(false);
          const [showTemplateEditor, setShowTemplateEditor] = useState(false);
          const [editableTemplate, setEditableTemplate] = useState(loadFromStorage('telestrokeTemplate', `Chief complaint: {chiefComplaint}
Last known well (date/time): {lkwDate} {lkwTime}
HPI: {age} year old {sex} p/w {symptoms} at {lkwTime}
Relevant PMH: {pmh}
Medications: {medications}

Objective:
Vitals:
Presenting BP {presentingBP}
Blood pressure: BP prior to TNK administration: {bpPreTNK} at {bpPreTNKTime}
Labs: Glucose {glucose}
Exam: Scores: NIHSS {nihss} - {nihssDetails}

Imaging: I personally reviewed imaging
Date/time Non-contrast Head CT reviewed: {ctTime}; Non-contrast Head CT Results: {ctResults}
Date/time CTA reviewed: {ctaDate} {ctaTime}; CTA Results: {ctaResults}
Telemetry/EKG: {ekgResults}

Assessment and Plan:
Suspected Diagnosis: {diagnosis}
After ensuring that there were no evident contraindications, TNK administration was recommended at {tnkAdminTime}. Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the patient, patient's wife, and OSH provider. Both the patient and his wife expressed agreement with the recommendation.
TNK was administered at {tnkAdminTime} after a brief time-out.

Recommendations:
{recommendationsText}

Rizwan Kalani MD`));

          // Time tracking
          const [currentTime, setCurrentTime] = useState(new Date());
          const [lkwTime, setLkwTime] = useState(loadFromStorage('lkwTime', null) ? new Date(loadFromStorage('lkwTime', null)) : new Date());

          // Save status
          const [saveStatus, setSaveStatus] = useState('saved');
          const [lastSaved, setLastSaved] = useState(null);

          // Critical alerts state
          const [criticalAlerts, setCriticalAlerts] = useState([]);

          // Search
          const [searchResults, setSearchResults] = useState([]);
          const [searchOpen, setSearchOpen] = useState(false);

          // Mobile navigation
          const [mobileMoreOpen, setMobileMoreOpen] = useState(false);

          // Workflow tracking
          const [currentStep, setCurrentStep] = useState(loadFromStorage('currentStep', 0));
          const [completedSteps, setCompletedSteps] = useState(loadFromStorage('completedSteps', []));

          const [gcsItems, setGcsItems] = useState(loadFromStorage('gcsItems', {
            eye: 0,
            verbal: 0,
            motor: 0
          }));
          const [ichScoreItems, setIchScoreItems] = useState(loadFromStorage('ichScoreItems', {
            gcs: '', // Changed to single field for mutual exclusivity
            age80: false,
            volume30: false,
            ivh: false,
            infratentorial: false
          }));
          const [abcd2Items, setAbcd2Items] = useState(loadFromStorage('abcd2Items', {
            age60: false,
            bp: false,
            unilateralWeakness: false,
            speechDisturbance: false,
            duration: '', // Changed to single field for mutual exclusivity
            diabetes: false
          }));
          const [chads2vascItems, setChads2vascItems] = useState(loadFromStorage('chads2vascItems', {
            chf: false,
            hypertension: false,
            age75: false,
            diabetes: false,
            strokeTia: false,
            vascular: false,
            age65: false,
            female: false
          }));
          const [ropeItems, setRopeItems] = useState(loadFromStorage('ropeItems', {
            noHypertension: false,
            noDiabetes: false,
            noStrokeTia: false,
            nonsmoker: false,
            cortical: false,
            age: ''
          }));
          const [trialsCategory, setTrialsCategory] = useState('ischemic');

          const [strokeCodeForm, setStrokeCodeForm] = useState(loadFromStorage('strokeCodeForm', {
            age: '',
            sex: '',
            hx: '',
            sx: '',
            lkw: '',
            lkw_date: new Date().toISOString().split('T')[0],
            nihss: '',
            aspects: '',
            def: '',
            hct: '',
            cta: '',
            ctp: '',
            tnk: [],
            tnk_rec: '',
            evt_rec: '',
            rec_reason: ''
          }));
          const [aspectsRegionState, setAspectsRegionState] = useState([
            { id: 'M1', name: 'M1 - Anterior MCA cortex', checked: true },
            { id: 'M2', name: 'M2 - MCA cortex lateral to insular ribbon', checked: true },
            { id: 'M3', name: 'M3 - Posterior MCA cortex', checked: true },
            { id: 'M4', name: 'M4 - Anterior MCA territory immediately superior to M1', checked: true },
            { id: 'M5', name: 'M5 - Lateral MCA territory immediately superior to M2', checked: true },
            { id: 'M6', name: 'M6 - Posterior MCA territory immediately superior to M3', checked: true },
            { id: 'IC', name: 'IC - Internal capsule', checked: true },
            { id: 'L', name: 'L - Lentiform nucleus', checked: true },
            { id: 'C', name: 'C - Caudate', checked: true },
            { id: 'I', name: 'I - Insular ribbon', checked: true }
          ]);

          // PC-ASPECTS regions state
          const [pcAspectsRegions, setPcAspectsRegions] = useState(loadFromStorage('pcAspectsRegions', [
            { id: 'THAL', name: 'Thalami (bilateral)', checked: true, points: 1 },
            { id: 'MIDBRAIN', name: 'Midbrain', checked: true, points: 2 },
            { id: 'PONS', name: 'Pons', checked: true, points: 2 },
            { id: 'MEDULLA', name: 'Medulla', checked: true, points: 1 },
            { id: 'CEREBELLUM-L', name: 'Left Cerebellar Hemisphere', checked: true, points: 1 },
            { id: 'CEREBELLUM-R', name: 'Right Cerebellar Hemisphere', checked: true, points: 1 },
            { id: 'PCA-L', name: 'Left Occipital Lobe (PCA Territory)', checked: true, points: 1 },
            { id: 'PCA-R', name: 'Right Occipital Lobe (PCA Territory)', checked: true, points: 1 }
          ]));

          // Telestroke Documentation State
          const [telestrokeNote, setTelestrokeNote] = useState(loadFromStorage('telestrokeNote', {
            chiefComplaint: '',
            lkwDate: new Date().toISOString().split('T')[0],
            lkwTime: '',
            age: '',
            sex: 'M',
            symptoms: '',
            pmh: '',
            medications: '',
            noAnticoagulants: false,
            presentingBP: '',
            bpPreTNK: '',
            bpPreTNKTime: '',
            glucose: '',
            plateletsCoags: '',
            creatinine: '',
            nihss: '',
            nihssDetails: '',
            imagingReviewed: true,
            ctDate: new Date().toISOString().split('T')[0],
            ctTime: '',
            ctResults: '',
            ctaDate: new Date().toISOString().split('T')[0],
            ctaTime: '',
            ctaResults: '',
            ctpResults: '',
            ekgResults: '',
            diagnosis: '',
            tnkRecommended: false,
            evtRecommended: false,
            rationale: '',
            tnkConsentDiscussed: false,
            patientFamilyConsent: false,
            presumedConsent: false,
            preTNKSafetyPause: false,
            tnkAdminTime: '',
            admitLocation: '',
            recommendationsText: '',
            recommendations: {
              neuroChecks: false,
              noAntithrombotics: false,
              bpControl: false,
              followUpCT: false,
              mri: false,
              ekg: false,
              echo: false,
              lipids: false,
              therapies: false,
              dvtPpx: false,
              neuroConsult: false
            }
          }));


          // Trials data
          const trialsData = {
            ischemic: {
                title: "Ischemic Stroke Studies",
                hasSubsections: true,
                subsections: {
                    acute: {
                        title: "Acute Trials",
                        trials: [
                            {
                                name: "SISTER Trial",
                                nct: "NCT05948566",
                                phase: "Phase 2",
                                status: "",
                                description: "TS23 (monoclonal antibody to α2-antiplasmin) for late thrombolysis in acute ischemic stroke patients presenting 4.5-24 hours from last known well",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Suspected anterior circulation acute ischemic stroke",
                                    "NIH Stroke Scale score ≥4 prior to randomization (participant must have a clearly disabling deficit if NIHSS is 4-5)",
                                    "Time from last known well: 4.5-24 hours",
                                    "Favorable baseline neuroimaging consisting of ALL of the following:",
                                    "• ASPECTS ≥6 on CT (or ASPECTS ≥7 on MRI)",
                                    "• Favorable perfusion imaging on CTP/MR-PWI consisting of ALL:",
                                    "  - Mismatch ratio of penumbra:core >1.2",
                                    "  - Mismatch volume >10 cc",
                                    "  - Ischemic core volume <70 cc",
                                    "Able to receive assigned study drug within 4.5 to 24 hours of stroke onset or last known well",
                                    "Informed consent obtained from participant or legally authorized representative",
                                    "Study drug administration encouraged within 90 minutes after qualifying perfusion image (allowed up to 120 minutes)"
                                ],
                                exclusion: [
                                    "Received endovascular treatment with clot engagement (patients with groin puncture but no clot engagement due to spontaneous distal migration are permitted)",
                                    "Received or planned to receive intravenous thrombolysis",
                                    "Pre-stroke modified Rankin score >2",
                                    "Previous treatment with TS23 or known previous allergy to antibody therapy",
                                    "Known pregnancy, breastfeeding, or plan to breastfeed within 3 months of receiving TS23",
                                    "Positive urine or serum pregnancy test for women of childbearing potential",
                                    "Known previous stroke in the past 90 days",
                                    "Known previous intracranial hemorrhage, intracranial neoplasm, subarachnoid hemorrhage, or arteriovenous malformation",
                                    "Known active diagnosis of intracranial neoplasm",
                                    "Clinical presentation suggestive of subarachnoid hemorrhage (even if initial CT scan was normal)",
                                    "Surgery or biopsy of parenchymal organ in the past 30 days",
                                    "Known trauma with internal injuries or persistent ulcerative wounds in the past 30 days",
                                    "Severe head trauma in the past 90 days",
                                    "Persistent systolic blood pressure >180mmHg or diastolic blood pressure >105mmHg despite best medical management",
                                    "Serious systemic hemorrhage in the past 30 days",
                                    "Hereditary or acquired hemorrhagic diathesis or coagulation factor deficiency",
                                    "Use of dual antiplatelet agents within 48 hours prior to stroke symptom onset",
                                    "International normalized ratio (INR) >1.7 or partial thromboplastin time (PTT) > 2x upper limit of normal",
                                    "Use of direct thrombin inhibitors or direct factor Xa inhibitors within past 48 hours unless aPTT, INR, platelet count, ecarin clotting time (ECT), thrombin time (TT), or appropriate factor Xa activity assays are normal",
                                    "Glucose <50 mg/dL or >400 mg/dL",
                                    "Platelets <100,000/µL",
                                    "Known severe renal failure with creatinine >3 mg/dL or glomerular filtration rate <30 mL/min",
                                    "Severe contrast allergy that cannot be managed medically",
                                    "Suspected cerebral vasculitis based on medical history and CTA/MRA",
                                    "Suspected intracranial dissection based on medical history and CTA/MRA",
                                    "Intracranial stenosis related to atherosclerosis proximal to intracranial thrombus",
                                    "Intracranial stent in place proximal to the intracranial occlusion",
                                    "Acute myocardial infarction in past 7 days",
                                    "Major surgery (requiring intubation or transfusion) in past 30 days",
                                    "Suspicion of aortic dissection on history, examination, or imaging",
                                    "Presumed septic embolus; suspicion of bacterial endocarditis",
                                    "Life expectancy <90 days",
                                    "Currently participating in another investigational drug or device study"
                                ]
                            },
                            {
                                name: "STEP-EVT Trial",
                                nct: "NCT06289985",
                                phase: "Adaptive Platform",
                                status: "",
                                description: "NIH StrokeNet adaptive platform trial optimizing endovascular therapy for mild stroke and medium/distal vessel occlusions",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Acute ischemic stroke due to large vessel occlusion (LVO) or medium vessel occlusion (MVO)",
                                    "Within 24 hours of last known well",
                                    "For Low NIHSS Domain:",
                                    "• NIHSS 0-5 with ICA or M1 occlusion",
                                    "• Disabling symptoms despite low NIHSS",
                                    "For Medium/Distal Vessel Occlusion Domain:",
                                    "• M2, M3, or M4 occlusion",
                                    "• A1, A2, or A3 occlusion",
                                    "• P1, P2, or P3 occlusion",
                                    "• Appropriate perfusion imaging criteria demonstrating salvageable tissue",
                                    "Ability to start EVT within appropriate time window",
                                    "Pre-stroke mRS ≤2 (able to live independently)",
                                    "Informed consent from patient or legally authorized representative"
                                ],
                                exclusion: [
                                    "Known pre-existing medical, neurological or psychiatric disease that would confound outcome evaluations",
                                    "Known serious, advanced, or terminal illness with life expectancy <6 months",
                                    "Unfavorable vascular anatomy limiting endovascular access to occluded artery",
                                    "Acute occlusions in multiple vascular territories",
                                    "Suspected septic embolus",
                                    "Suspected bacterial endocarditis",
                                    "Seizure at stroke onset with postictal residual impairments",
                                    "Contrast allergy precluding EVT that cannot be adequately pre-medicated",
                                    "Chronic total occlusion of target vessel",
                                    "Known intracranial dissection",
                                    "Known vasculitis",
                                    "Known moyamoya disease or syndrome",
                                    "Pregnancy or positive pregnancy test",
                                    "Currently breastfeeding",
                                    "Large core infarct (ASPECTS <3 or core volume >100cc depending on time window)",
                                    "Evidence of intracranial hemorrhage on baseline imaging",
                                    "Clinical suspicion of subarachnoid hemorrhage despite negative imaging",
                                    "Known bleeding diathesis or coagulopathy",
                                    "Platelet count <50,000/μL",
                                    "INR >3.0",
                                    "Blood glucose <50mg/dL",
                                    "Refractory hypertension (SBP >185 or DBP >110 despite treatment)",
                                    "Currently participating in another interventional clinical trial"
                                ]
                            },
                            {
                                name: "PICASSO Trial",
                                nct: "NCT05611242",
                                phase: "Phase 3 RCT",
                                status: "",
                                description: "Mechanical thrombectomy with vs without acute carotid stenting for tandem lesions",
                                inclusion: [
                                    "Age 18-79 years",
                                    "Acute ischemic stroke in the anterior circulation",
                                    "Tandem lesion consisting of:",
                                    "• Proximal carotid artery stenosis 70-100% by NASCET criteria or complete occlusion",
                                    "• Intracranial large vessel occlusion (ICA terminus, M1, or proximal M2)",
                                    "Within 16 hours from stroke onset or last known well",
                                    "Pre-stroke mRS 0-2",
                                    "NIHSS ≥4",
                                    "For presentation ≤6 hours: ASPECTS ≥7 on non-contrast CT",
                                    "For presentation >6-16 hours:",
                                    "• ASPECTS ≥7 AND",
                                    "• Ischemic core volume <50cc on perfusion imaging",
                                    "• Mismatch ratio >1.8",
                                    "• Mismatch volume >15cc",
                                    "Ability to undergo groin puncture within treatment window",
                                    "Informed consent obtained"
                                ],
                                exclusion: [
                                    "Proximal carotid stenosis secondary to dissection",
                                    "Proximal carotid stenosis secondary to vasculitis",
                                    "Pre-stroke mRS >2",
                                    "Known hemorrhagic diathesis",
                                    "Known coagulation factor deficiency",
                                    "Absolute contraindications to antiplatelet therapy",
                                    "Need for acute therapeutic anticoagulation that cannot be stopped",
                                    "Platelet count <100,000/μL",
                                    "INR >1.7",
                                    "aPTT >1.5x normal",
                                    "Blood glucose <50mg/dL or >400mg/dL",
                                    "Serum creatinine >3.0mg/dL unless on dialysis",
                                    "Evidence of intracranial hemorrhage on baseline CT/MRI",
                                    "Clinical suspicion of subarachnoid hemorrhage",
                                    "Large territory infarction (>1/3 MCA territory)",
                                    "Known severe contrast allergy that cannot be adequately pre-medicated",
                                    "Known pregnancy or positive pregnancy test",
                                    "Life expectancy <90 days due to comorbid conditions",
                                    "Enrollment in another interventional clinical trial",
                                    "Previous carotid endarterectomy or carotid stenting on affected side",
                                    "Contralateral carotid occlusion",
                                    "Intracranial stenosis in addition to the tandem lesion",
                                    "Known cardiac source of embolism requiring anticoagulation",
                                    "Recent MI within 30 days with ongoing cardiac issues",
                                    "Severe or unstable congestive heart failure",
                                    "Uncontrolled hypertension (SBP >185 or DBP >110 despite treatment)"
                                ]
                            }
                        ]
                    },
                    inpatient: {
                        title: "Subacute Enrollment",
                        trials: [
                            {
                                name: "SCOUTS3 Trial",
                                nct: "NCT06029959",
                                phase: "Interventional",
                                status: "",
                                description: "Multicomponent behavioral package to improve CPAP adherence in stroke with OSA",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Acute ischemic stroke or intraparenchymal hemorrhage within past 30 days",
                                    "Currently admitted to inpatient rehabilitation facility",
                                    "Diagnosed with obstructive sleep apnea (OSA) during inpatient rehabilitation stay:",
                                    "• AHI ≥5 events/hour on diagnostic sleep study OR",
                                    "• REI ≥5 events/hour on home sleep apnea test",
                                    "CPAP therapy indicated and prescribed",
                                    "Able to provide informed consent in English or Spanish",
                                    "Expected to remain in inpatient rehabilitation for ≥3 nights after enrollment",
                                    "Cognitive ability to participate in behavioral intervention (MOCA ≥17)",
                                    "Has a caregiver/support person who can assist with CPAP use"
                                ],
                                exclusion: [
                                    "Unable to obtain informed consent",
                                    "Incarcerated or prisoner",
                                    "Known pregnancy",
                                    "Current mechanical ventilation",
                                    "Tracheostomy present",
                                    "Oxygen requirement >4L/min at rest",
                                    "Current PAP use or use within 14 days prior to stroke",
                                    "History of pneumothorax",
                                    "History of bullous emphysema",
                                    "Stroke related to brain tumors",
                                    "Stroke related to vascular malformations",
                                    "Subarachnoid hemorrhage",
                                    "Active sedative drug use interfering with OSA testing or treatment",
                                    "Anticipated inpatient rehabilitation length of stay <3 nights",
                                    "Unable to tolerate CPAP mask fitting",
                                    "Severe claustrophobia preventing CPAP use",
                                    "Severe facial/skull deformity preventing mask fit",
                                    "Active untreated psychiatric condition affecting participation",
                                    "Life expectancy <3 months",
                                    "Currently enrolled in another interventional sleep study"
                                ]
                            },
                            {
                                name: "COMA-SABI Study",
                                nct: "NCT05671874",
                                phase: "Observational",
                                status: "",
                                description: "Severe acute brain injury QOL and caregiver outcomes to 12 months (includes stroke/ICH/TBI)",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Severe acute brain injury including:",
                                    "• Ischemic stroke",
                                    "• Intracerebral hemorrhage",
                                    "• Traumatic brain injury",
                                    "• Hypoxic-ischemic encephalopathy",
                                    "GCS ≤12 at any point during ICU admission",
                                    "ICU admission for ≥48 hours",
                                    "Has an identifiable family member or caregiver willing to participate",
                                    "Caregiver speaks English or Spanish",
                                    "Expected to survive hospitalization per clinical team assessment"
                                ],
                                exclusion: [
                                    "Pre-existing life expectancy <12 months from non-neurologic condition",
                                    "No available family member or caregiver to provide information",
                                    "Pre-injury severe cognitive impairment or dementia",
                                    "Pre-injury residence in skilled nursing facility",
                                    "Prisoner or incarcerated",
                                    "Brain death or withdrawal of life support planned within 72 hours",
                                    "Previously enrolled in COMA-SABI study"
                                ]
                            },
                            {
                                name: "TESTED",
                                nct: "NCT05911568",
                                phase: "Comparative Effectiveness",
                                status: "",
                                description: "EVT vs medical therapy in LVO with pre-existing disability (mRS 3-4)",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Pre-stroke mRS 3-4 for at least 3 months prior to index stroke",
                                    "Large vessel occlusion:",
                                    "• ICA terminus",
                                    "• M1 segment of MCA",
                                    "• Dominant/co-dominant M2 segment",
                                    "Within 24 hours of last known well",
                                    "NIHSS ≥6",
                                    "ASPECTS ≥3 on non-contrast CT or ≥4 on MRI",
                                    "For 6-24 hour window: evidence of salvageable tissue on perfusion imaging",
                                    "Able to undergo groin puncture within time window",
                                    "Informed consent from patient or legally authorized representative"
                                ],
                                exclusion: [
                                    "Pre-stroke mRS 0-2 or mRS 5-6",
                                    "Life expectancy <6 months from non-stroke condition",
                                    "Pre-stroke disability deemed temporary or reversible",
                                    "Known pregnancy",
                                    "Evidence of intracranial hemorrhage",
                                    "Large established infarct (>1/3 MCA territory)",
                                    "Bilateral strokes",
                                    "Known vasculitis or moyamoya",
                                    "Intracranial tumor",
                                    "Currently participating in another stroke intervention trial",
                                    "Inability to follow up at 90 days"
                                ]
                            },
                            {
                                name: "VERIFY Study",
                                nct: "NCT05338697",
                                phase: "Observational",
                                status: "",
                                description: "Early TMS/MRI/clinical measures to predict upper extremity motor recovery",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Acute ischemic stroke within 7 days of onset",
                                    "Upper extremity weakness (shoulder abduction and/or finger extension ≤4 on MRC scale)",
                                    "Able to provide informed consent or has LAR",
                                    "Able to participate in study assessments",
                                    "Expected to survive at least 90 days"
                                ],
                                exclusion: [
                                    "Contraindications to TMS:",
                                    "• Implanted electronic devices (pacemaker, cochlear implant, etc.)",
                                    "• Intracranial metal",
                                    "• History of seizures",
                                    "• Active psychiatric medication affecting cortical excitability",
                                    "Contraindications to MRI",
                                    "Unable to complete follow-up visits at 30 and 90 days",
                                    "Pre-stroke mRS >2",
                                    "Bilateral upper extremity weakness",
                                    "Previous stroke affecting motor function",
                                    "Other neurological conditions affecting motor function",
                                    "Pregnancy"
                                ]
                            },
                            {
                                name: "DISCOVERY Study",
                                nct: "NCT04916210",
                                phase: "Observational",
                                status: "",
                                description: "Cognitive trajectories and biomarkers after stroke (includes AIS/ICH/SAH)",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Admitted with one of the following:",
                                    "• Acute ischemic stroke",
                                    "• Intracerebral hemorrhage",
                                    "• Aneurysmal subarachnoid hemorrhage",
                                    "Radiographic confirmation of stroke diagnosis",
                                    "Baseline visit can be completed within 6 weeks of stroke",
                                    "Fluent in English or Spanish",
                                    "Has study partner who knows patient well (contact ≥1x/week)",
                                    "Able to provide informed consent or has LAR",
                                    "Expected to survive at least 1 year"
                                ],
                                exclusion: [
                                    "Pre-stroke dementia diagnosis",
                                    "Pre-stroke cognitive impairment interfering with daily activities",
                                    "Concurrent enrollment in interventional trial affecting cognition",
                                    "Unable to complete study protocol due to:",
                                    "• Severe aphasia preventing cognitive testing",
                                    "• Severe motor impairment preventing testing",
                                    "• Blindness or severe visual impairment",
                                    "• Deafness or severe hearing impairment",
                                    "Active substance abuse",
                                    "Severe psychiatric illness affecting participation",
                                    "Terminal illness with life expectancy <1 year",
                                    "Previous enrollment in DISCOVERY",
                                    "Planned move out of area within study period"
                                ]
                            }
                        ]
                    },
                    imaging: {
                        title: "Imaging Studies",
                        trials: [
                            {
                                name: "ESUS Imaging Study",
                                nct: "NCT03820375",
                                phase: "Observational",
                                status: "",
                                description: "Cardiac and intracranial vessel wall MRI to reclassify ESUS",
                                inclusion: [
                                    "ESUS diagnosis",
                                    "Age ≥18 years",
                                    "Within 30 days of index stroke"
                                ],
                                exclusion: [
                                    "MRI contraindications",
                                    "Known stroke etiology"
                                ]
                            },
                            {
                                name: "MOCHA Imaging",
                                nct: "PMC8821414",
                                phase: "Observational",
                                status: "",
                                description: "Automated intracranial vessel-wall analysis for non-stenotic ICAD detection",
                                inclusion: [
                                    "Atherosclerotic lesions within the cerebrovascular tree clinically detected based on stenosis presence on clinical luminal imaging",
                                    "Presence of two or more atherosclerotic risk factors:",
                                    "• Age >50 years for men or >60 years for women",
                                    "• Hypertension",
                                    "• Diabetes mellitus", 
                                    "• Hyperlipidemia",
                                    "• Obesity",
                                    "• Smoking history",
                                    "No clinical evidence for other intracranial vasculopathies",
                                    "High-resolution MRI vessel wall imaging available"
                                ],
                                exclusion: [
                                    "Poor MRI image quality limiting vessel wall analysis",
                                    "Known intracranial vasculopathy (vasculitis, moyamoya, dissection)",
                                    "Unable to undergo MRI scanning",
                                    "Contraindications to MRI contrast if required for imaging protocol"
                                ]
                            }
                        ]
                    }
                }
            },
            ich: {
                title: "Intracerebral Hemorrhage Studies",
                hasSubsections: true,
                subsections: {
                    trials: {
                        title: "Trials",
                        trials: [
                            {
                                name: "SATURN Trial",
                                nct: "NCT03936361",
                                phase: "Phase 3",
                                status: "",
                                description: "Statins for intracerebral hemorrhage: Continue vs discontinue after lobar ICH",
                                inclusion: [
                                    "Age ≥50 years",
                                    "Spontaneous lobar intracerebral hemorrhage confirmed by CT or MRI",
                                    "Taking statin therapy at time of ICH onset for ≥1 month",
                                    "Modified Rankin Scale ≤4 at time of randomization",
                                    "Randomization within 7 days of ICH",
                                    "Clinical indication for statin therapy (dyslipidemia, atherosclerotic disease, diabetes)",
                                    "Able to provide informed consent or has LAR",
                                    "Expected to survive at least 6 months"
                                ],
                                exclusion: [
                                    "Deep (non-lobar) ICH location",
                                    "Secondary causes of ICH:",
                                    "• Trauma",
                                    "• Known brain tumor",
                                    "• Known vascular malformation or aneurysm",
                                    "• Hemorrhagic transformation of ischemic stroke",
                                    "• Known or suspected CNS vasculitis",
                                    "• Coagulopathy (INR >1.5, platelet count <100,000)",
                                    "• Drug-related (cocaine, amphetamines)",
                                    "Recent MI (<3 months) or unstable angina",
                                    "Coronary revascularization within past year",
                                    "Diabetes mellitus with prior MI or coronary revascularization",
                                    "Clear contraindication to statin discontinuation per treating physician",
                                    "Statin-related myopathy or rhabdomyolysis",
                                    "Severe hepatic impairment (ALT/AST >3x ULN)",
                                    "Life expectancy <6 months from non-ICH condition",
                                    "Unable to follow study protocol",
                                    "Pregnancy or breastfeeding",
                                    "Participation in another interventional trial"
                                ]
                            },
                            {
                                name: "ASPIRE Trial",
                                nct: "NCT03907046",
                                phase: "Phase 3",
                                status: "",
                                description: "Apixaban vs aspirin for stroke prevention after ICH in atrial fibrillation",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Spontaneous ICH confirmed by CT or MRI",
                                    "Non-valvular atrial fibrillation (paroxysmal, persistent, or permanent)",
                                    "CHA2DS2-VASc score ≥2",
                                    "Randomization 14-180 days after ICH",
                                    "Modified Rankin Scale ≤4 at randomization",
                                    "Able to take oral medications",
                                    "Informed consent obtained"
                                ],
                                exclusion: [
                                    "Clear indication for anticoagulation other than AF:",
                                    "• Mechanical heart valve",
                                    "• Recent DVT/PE requiring anticoagulation",
                                    "• Left ventricular thrombus",
                                    "Left atrial appendage closure device",
                                    "Valvular AF (moderate-severe mitral stenosis, mechanical valve)",
                                    "Secondary causes of ICH requiring specific treatment",
                                    "Creatinine ≥2.5mg/dL or CrCl <25mL/min",
                                    "Hepatic insufficiency (Child-Pugh B or C)",
                                    "Active bleeding or high bleeding risk condition",
                                    "Uncontrolled hypertension (BP ≥180/100 on multiple readings)",
                                    "Platelet count <100,000/μL",
                                    "Hemoglobin <8g/dL",
                                    "Need for dual antiplatelet therapy",
                                    "Contraindication to aspirin or apixaban",
                                    "Pregnancy or breastfeeding",
                                    "Life expectancy <1 year",
                                    "Unable to adhere to study protocol",
                                    "Participation in another antithrombotic trial"
                                ]
                            },
                            {
                                name: "cAPPricorn-1 Trial",
                                nct: "NCT06393712",
                                phase: "Phase 2",
                                status: "",
                                description: "Intrathecal ALN-APP (mivelsiran) for cerebral amyloid angiopathy",
                                inclusion: [
                                    "For sporadic CAA:",
                                    "• Age ≥50 years",
                                    "• Meets Boston Criteria v2.0 for probable CAA",
                                    "• Prior symptomatic lobar ICH ≥90 days ago",
                                    "For Dutch-type hereditary CAA:",
                                    "• Age ≥30 years",
                                    "• Confirmed E693Q APP variant",
                                    "• Prior ICH ≥90 days ago (if applicable)",
                                    "MRI evidence of CAA (microbleeds, superficial siderosis)",
                                    "Modified Rankin Scale ≤4",
                                    "Able to undergo lumbar punctures",
                                    "Adequate contraception if childbearing potential",
                                    "Informed consent obtained"
                                ],
                                exclusion: [
                                    "ICH within 90 days of screening",
                                    "Other cause of ICH identified",
                                    "ALT or AST >3× upper limit of normal",
                                    "eGFR <30 mL/min/1.73m²",
                                    "Platelet count <100,000/μL",
                                    "INR >1.5 or aPTT >1.5× ULN",
                                    "Contraindication to lumbar puncture",
                                    "Active CNS infection or inflammation",
                                    "Intrathecal pump or shunt",
                                    "Spinal cord compression or injury",
                                    "History of chemical or radiation meningitis",
                                    "Pregnancy or breastfeeding",
                                    "Life expectancy <2 years",
                                    "Chronic use of anticoagulation that cannot be stopped for LP",
                                    "Prior treatment with gene therapy or oligonucleotide therapy",
                                    "Participation in another interventional trial within 30 days"
                                ]
                            }
                        ]
                    },
                    observational: {
                        title: "Observational",
                        trials: [
                            {
                                name: "MIRROR Registry",
                                nct: "NCT04494295",
                                phase: "Observational Registry",
                                status: "",
                                description: "Minimally invasive endoscopic ICH evacuation using Aurora Surgiscope System",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Spontaneous supratentorial ICH confirmed by CT",
                                    "ICH volume ≥20mL",
                                    "Surgery planned within 24 hours of last known well",
                                    "NIHSS >5",
                                    "Baseline mRS ≤2",
                                    "GCS ≥5",
                                    "Ability to undergo general anesthesia",
                                    "Informed consent from patient or LAR"
                                ],
                                exclusion: [
                                    "Secondary ICH due to:",
                                    "• Vascular lesion (AVM, aneurysm, dural fistula)",
                                    "• Brain tumor",
                                    "• Trauma",
                                    "• Hemorrhagic transformation of ischemic stroke",
                                    "• Moyamoya disease",
                                    "Fixed and dilated pupils",
                                    "Bilateral extensor posturing",
                                    "Infratentorial or brainstem ICH",
                                    "Intraventricular hemorrhage as primary pathology",
                                    "Life expectancy <6 months from other condition",
                                    "Uncorrectable coagulopathy (INR >1.4, platelets <100,000)",
                                    "Known pregnancy",
                                    "Prisoner or ward of state",
                                    "Participation in another interventional trial"
                                ]
                            },
                            {
                                name: "COMA-SABI Study (ICH Cohort)",
                                nct: "NCT05671874",
                                phase: "Observational",
                                status: "",
                                description: "Severe ICH outcomes and caregiver QOL to 12 months",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Severe intracerebral hemorrhage",
                                    "GCS ≤12 at any point during ICU admission",
                                    "ICU admission for ≥48 hours",
                                    "Has identifiable caregiver willing to participate",
                                    "Expected to survive hospitalization"
                                ],
                                exclusion: [
                                    "Pre-existing life expectancy <12 months",
                                    "No available caregiver",
                                    "Pre-injury severe cognitive impairment",
                                    "Brain death or comfort care within 72 hours"
                                ]
                            },
                            {
                                name: "DISCOVERY Study (ICH Cohort)",
                                nct: "NCT04916210",
                                phase: "Observational",
                                status: "",
                                description: "Cognitive trajectories and biomarkers after ICH",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Admitted with intracerebral hemorrhage",
                                    "Radiographic confirmation of ICH",
                                    "Baseline visit within 6 weeks of ICH",
                                    "Fluent in English or Spanish",
                                    "Has study partner with regular contact",
                                    "Expected survival ≥1 year"
                                ],
                                exclusion: [
                                    "Pre-existing dementia",
                                    "Unable to complete cognitive testing",
                                    "Concurrent enrollment in cognitive intervention trial",
                                    "Active substance abuse",
                                    "Severe psychiatric illness",
                                    "Terminal illness with life expectancy <1 year"
                                ]
                            }
                        ]
                    }
                }
            },
            rehab: {
                title: "Rehabilitation",
                trials: [
                    {
                        name: "MR-PICS Study",
                        nct: "NCT06506279",
                        phase: "Phase 2",
                        status: "",
                        description: "Motor Recovery through Plasticity-Inducing Cortical Stimulation using CorTec Brain Interchange System for chronic stroke recovery",
                        inclusion: [
                            "Post-ischemic stroke patients with upper extremity deficit",
                            "Chronic stroke (minimum 6 months post-stroke)",
                            "Age 22-80 years",
                            "Able to participate meaningfully in rehabilitation (Upper Extremity Fugl-Meyer score 25-45)",
                            "Disability measured between 3-4 on modified Rankin Scale",
                            "Minimum 30% preservation of corticospinal tract integrity",
                            "Ability to provide informed consent",
                            "Medically stable and cleared for neurosurgical procedure",
                            "Willingness to comply with study protocol and follow-up visits",
                            "Access to caregiver support during recovery period"
                        ],
                        exclusion: [
                            "Seizure disorder or history of seizures",
                            "Contraindications to neurosurgical procedures",
                            "Contraindications to MRI scanning",
                            "Active psychiatric condition that would interfere with participation",
                            "Pregnancy or nursing",
                            "Life expectancy less than 2 years",
                            "Current participation in other interventional clinical trials",
                            "Inability to stop anti-platelet medications 7 days before and 3 days after surgery",
                            "Therapeutic anticoagulation that cannot be safely interrupted",
                            "Active substance abuse or dependence",
                            "Severe cognitive impairment preventing informed consent",
                            "Glenohumeral subluxation, adhesive capsulitis, or upper extremity contractures with associated pain that would limit participation",
                            "Implanted electronic devices incompatible with study procedures",
                            "Prior brain surgery or cranial implants",
                            "Hemorrhagic stroke (intracerebral hemorrhage excluded)",
                            "Bilateral stroke or multiple stroke locations"
                        ]
                    }
                ]
            },
            cadasil: {
                title: "CADASIL",
                trials: [
                    {
                        name: "CADASIL Registry",
                        nct: "NCT05567744",
                        phase: "Observational Registry",
                        status: "",
                        description: "Longitudinal registry for genetically confirmed or suspected CADASIL",
                        inclusion: [
                            "Confirmed NOTCH3 mutation or suspected CADASIL",
                            "Age ≥18 years"
                        ],
                        exclusion: [
                            "Unable to provide consent"
                        ]
                    }
                ]
            }
          };

          // Toggle trial details

          // Create trial card component
          const TrialCard = ({ trial, category }) => {
            const [isExpanded, setIsExpanded] = React.useState(false);
            
            const getCategoryColor = (cat) => {
              switch(cat) {
                case 'ischemic': return 'bg-blue-600 text-white';
                case 'ich': return 'bg-red-600 text-white';
                case 'rehab': return 'bg-green-600 text-white';
                case 'cadasil': return 'bg-purple-600 text-white';
                default: return 'bg-gray-600 text-white';
              }
            };
            
            const getCategoryBorderColor = (cat) => {
              switch(cat) {
                case 'ischemic': return 'border-blue-200';
                case 'ich': return 'border-red-200';
                case 'rehab': return 'border-green-200';
                case 'cadasil': return 'border-purple-200';
                default: return 'border-gray-200';
              }
            };
            
            return (
              <div className={`bg-white rounded-lg shadow-md overflow-hidden border-2 ${getCategoryBorderColor(category)} hover:shadow-lg transition-shadow`}>
                <div 
                  className={`${getCategoryColor(category)} p-4 cursor-pointer`}
                  onClick={() => setIsExpanded(!isExpanded)}
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <h3 className="text-xl font-bold mb-2">{trial.name}</h3>
                      <div className="flex flex-wrap gap-2 mb-3">
                        <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-semibold">
                          {trial.phase}
                        </span>
                        {trial.status && (
                          <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-semibold">
                            {trial.status}
                          </span>
                        )}
                      </div>
                      <p className="text-white text-opacity-95">{trial.description}</p>
                    </div>
                    <div className="ml-4">
                      <svg 
                        className={`w-6 h-6 transform transition-transform ${isExpanded ? 'rotate-180' : ''}`} 
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </div>
                  </div>
                  <div className="mt-3 flex items-center">
                    {trial.nct.startsWith('NCT') ? (
                      <button 
                        className="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center"
                        onClick={(e) => {
                          e.stopPropagation();
                          window.open(`https://clinicaltrials.gov/study/${trial.nct}`, '_blank');
                        }}
                      >
                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        {trial.nct}
                      </button>
                    ) : (
                      <span className="text-sm opacity-90">Reference: {trial.nct}</span>
                    )}
                  </div>
                </div>
                
                {isExpanded && (
                  <div className="bg-gray-50 p-4 border-t-2 border-gray-200">
                    <div className="grid md:grid-cols-2 gap-6">
                      <div>
                        <h4 className="font-bold text-green-700 mb-3 text-lg">✓ Inclusion Criteria</h4>
                        <ul className="space-y-2">
                          {trial.inclusion.map((item, idx) => (
                            <li key={idx} className="flex items-start">
                              <span className="text-green-500 mr-2 mt-1">•</span>
                              <span className="text-gray-700 text-sm">{item}</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                      <div>
                        <h4 className="font-bold text-red-700 mb-3 text-lg">✗ Exclusion Criteria</h4>
                        <ul className="space-y-2">
                          {trial.exclusion.map((item, idx) => (
                            <li key={idx} className="flex items-start">
                              <span className="text-red-500 mr-2 mt-1">•</span>
                              <span className="text-gray-700 text-sm">{item}</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                    </div>
                    {trial.nct.startsWith('NCT') && (
                      <div className="mt-6 pt-4 border-t border-gray-200 text-center">
                        <button 
                          className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center"
                          onClick={() => window.open(`https://clinicaltrials.gov/study/${trial.nct}`, '_blank')}
                        >
                          <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                          View Full Details on ClinicalTrials.gov
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          };


          // NIH Stroke Scale items
          const nihssItems = [
            { id: 'consciousness', name: '1a. Level of Consciousness', options: ['Alert (0)', 'Drowsy (1)', 'Stuporous (2)', 'Coma (3)'] },
            { id: 'loc_questions', name: '1b. LOC Questions', options: ['Both correct (0)', 'One correct (1)', 'Neither correct (2)'] },
            { id: 'loc_commands', name: '1c. LOC Commands', options: ['Obeys both correctly (0)', 'Obeys one correctly (1)', 'Neither correctly (2)'] },
            { id: 'best_gaze', name: '2. Best Gaze', options: ['Normal (0)', 'Partial gaze palsy (1)', 'Forced deviation (2)'] },
            { id: 'visual', name: '3. Visual', options: ['No visual loss (0)', 'Partial hemianopia (1)', 'Complete hemianopia (2)', 'Bilateral hemianopia (3)'] },
            { id: 'facial_palsy', name: '4. Facial Palsy', options: ['Normal (0)', 'Minor asymmetry (1)', 'Partial facial paralysis (2)', 'Complete facial paralysis (3)'] },
            { id: 'motor_arm_left', name: '5a. Motor Arm-Left', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_arm_right', name: '5b. Motor Arm-Right', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_leg_left', name: '6a. Motor Leg-Left', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_leg_right', name: '6b. Motor Leg-Right', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'limb_ataxia', name: '7. Limb Ataxia', options: ['Absent (0)', 'Present in upper or lower (1)', 'Present in both (2)'] },
            { id: 'sensory', name: '8. Sensory', options: ['Normal (0)', 'Partial loss (1)', 'Dense loss (2)'] },
            { id: 'language', name: '9. Best Language†', options: ['No aphasia (0)', 'Mild-moderate aphasia (1)', 'Severe aphasia (2)', 'Mute, global aphasia (3)'] },
            { id: 'dysarthria', name: '10. Dysarthria†', options: ['Normal articulation (0)', 'Mild-moderate slurring (1)', 'Severe dysarthria (2)', 'Intubated/other (2)'] },
            { id: 'extinction', name: '11. Extinction and Inattention', options: ['No neglect (0)', 'Visual, tactile, auditory, spatial, or personal inattention (1)', 'Profound hemi-inattention (2)'] }
          ];

          // Calculate NIHSS score
          const calculateNIHSS = (responses) => {
            return Object.values(responses).reduce((total, response) => {
              const score = parseInt(response?.split('(')[1]?.split(')')[0] || 0);
              return total + score;
            }, 0);
          };

          // Calculate ASPECTS score
          const calculateASPECTS = (regions) => {
            return regions.filter(region => region.checked).length;
          };

          // Calculate PC-ASPECTS score
          const calculatePCAspects = (regions) => {
            return regions.reduce((total, region) => {
              return total + (region.checked ? region.points : 0);
            }, 0);
          };

          // Calculate GCS score
          const calculateGCS = (items) => {
            return parseInt(items.eye || 0) + parseInt(items.verbal || 0) + parseInt(items.motor || 0);
          };

          // Calculate ICH score
          const calculateICHScore = (items) => {
            let score = 0;
            if (items.gcs === 'gcs34') score += 2;
            else if (items.gcs === 'gcs512') score += 1;
            if (items.age80) score += 1;
            if (items.volume30) score += 1;
            if (items.ivh) score += 1;
            if (items.infratentorial) score += 1;
            return score;
          };

          // Calculate ABCD2 score
          const calculateABCD2Score = (items) => {
            let score = 0;
            if (items.age60) score += 1;
            if (items.bp) score += 1;
            if (items.unilateralWeakness) score += 2;
            if (items.speechDisturbance) score += 1;
            if (items.duration === 'duration10') score += 1;
            else if (items.duration === 'duration60') score += 2;
            if (items.diabetes) score += 1;
            return score;
          };

          // Calculate CHADS2-VASc score
          const calculateCHADS2VascScore = (items) => {
            let score = 0;
            if (items.chf) score += 1;
            if (items.hypertension) score += 1;
            if (items.age75) score += 2;
            if (items.diabetes) score += 1;
            if (items.strokeTia) score += 2;
            if (items.vascular) score += 1;
            if (items.age65) score += 1;
            if (items.female) score += 1;
            return score;
          };

          // Calculate ROPE score
          const calculateROPEScore = (items) => {
            let score = 0;
            if (items.noHypertension) score += 1;
            if (items.noDiabetes) score += 1;
            if (items.noStrokeTia) score += 1;
            if (items.nonsmoker) score += 1;
            if (items.cortical) score += 1;
            
            // Age points
            const age = parseInt(items.age) || 0;
            if (age >= 18 && age <= 29) score += 5;
            else if (age >= 30 && age <= 39) score += 4;
            else if (age >= 40 && age <= 49) score += 3;
            else if (age >= 50 && age <= 59) score += 2;
            else if (age >= 60 && age <= 69) score += 1;
            // 70+ years gets 0 points
            
            return score;
          };

          // Create Icon component wrapper
          const Icon = ({ icon: IconComponent, size = 16 }) => {
            React.useEffect(() => {
              lucide.createIcons();
            }, []);

            return <i data-lucide={IconComponent} className="w-4 h-4 inline-block"></i>;
          };

          // PHI Protection - Data with expiration
          const PATIENT_DATA_TTL = 24 * 60 * 60 * 1000; // 24 hours

          const saveWithExpiration = (key, data) => {
            try {
              const item = {
                data: data,
                timestamp: new Date().getTime(),
                expiresAt: new Date().getTime() + PATIENT_DATA_TTL
              };
              localStorage.setItem(key, JSON.stringify(item));
              setSaveStatus('saved');
              setLastSaved(new Date());
            } catch (e) {
              setSaveStatus('error');
              console.error('Save failed:', e);
            }
          };

          const loadWithExpiration = (key, defaultValue) => {
            try {
              const item = JSON.parse(localStorage.getItem(key));
              if (!item) return defaultValue;

              if (new Date().getTime() > item.expiresAt) {
                localStorage.removeItem(key);
                return defaultValue;
              }
              return item.data;
            } catch {
              return defaultValue;
            }
          };

          // Debounce utility
          const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
              const later = () => {
                clearTimeout(timeout);
                func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
            };
          };

          // Debounced save (will be set up in useEffect)
          const debouncedSave = React.useCallback(
            debounce((key, data) => {
              setSaveStatus('saving');
              saveWithExpiration(key, data);
            }, 1000),
            []
          );

          // Utility Functions
          const copyToClipboard = (text, label) => {
            navigator.clipboard.writeText(text).then(() => {
              setCopiedText(label);
              setTimeout(() => setCopiedText(''), 2000);
            });
          };

          const exportToPDF = () => {
            const element = document.getElementById('root');
            const opt = {
              margin: 0.5,
              filename: `stroke-assessment-${new Date().toISOString().split('T')[0]}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
          };

          const toggleDarkMode = () => {
            const newDarkMode = !darkMode;
            setDarkMode(newDarkMode);
            localStorage.setItem('darkMode', newDarkMode);
            if (newDarkMode) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          };

          const Tooltip = ({ text, children }) => (
            <span className="tooltip">
              {children}
              <span className="tooltiptext">{text}</span>
            </span>
          );

          // Generate telestroke documentation note
          const generateTelestrokeNote = () => {
            const formatDate = (dateStr) => {
              if (!dateStr) return '';
              const date = new Date(dateStr);
              return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear().toString().slice(-2)}`;
            };

            const formatTime = (timeStr) => {
              if (!timeStr) return '';
              const [hours, minutes] = timeStr.split(':');
              const hour = parseInt(hours);
              const ampm = hour >= 12 ? 'pm' : 'am';
              const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
              return `${displayHour}:${minutes} ${ampm}`;
            };

            // Use the editable template and replace placeholders with actual values
            let note = editableTemplate;

            // Replace all placeholders with actual values
            note = note.replace(/{chiefComplaint}/g, telestrokeNote.chiefComplaint || '');
            note = note.replace(/{lkwDate}/g, formatDate(telestrokeNote.lkwDate));
            note = note.replace(/{lkwTime}/g, formatTime(telestrokeNote.lkwTime));
            note = note.replace(/{age}/g, telestrokeNote.age || '');
            note = note.replace(/{sex}/g, telestrokeNote.sex || '');
            note = note.replace(/{symptoms}/g, telestrokeNote.symptoms || '');
            note = note.replace(/{pmh}/g, telestrokeNote.pmh || '');
            note = note.replace(/{medications}/g, telestrokeNote.medications || '');
            note = note.replace(/{presentingBP}/g, telestrokeNote.presentingBP || '');
            note = note.replace(/{bpPreTNK}/g, telestrokeNote.bpPreTNK || '');
            note = note.replace(/{bpPreTNKTime}/g, formatTime(telestrokeNote.bpPreTNKTime));
            note = note.replace(/{glucose}/g, telestrokeNote.glucose || '');
            note = note.replace(/{plateletsCoags}/g, telestrokeNote.plateletsCoags || '');
            note = note.replace(/{creatinine}/g, telestrokeNote.creatinine || '');
            note = note.replace(/{nihss}/g, telestrokeNote.nihss || nihssScore || '');
            note = note.replace(/{nihssDetails}/g, telestrokeNote.nihssDetails || '');
            note = note.replace(/{ctTime}/g, formatTime(telestrokeNote.ctTime));
            note = note.replace(/{ctResults}/g, telestrokeNote.ctResults || '');
            note = note.replace(/{ctaDate}/g, formatDate(telestrokeNote.ctaDate));
            note = note.replace(/{ctaTime}/g, formatTime(telestrokeNote.ctaTime));
            note = note.replace(/{ctaResults}/g, telestrokeNote.ctaResults || '');
            note = note.replace(/{ekgResults}/g, telestrokeNote.ekgResults || '');
            note = note.replace(/{diagnosis}/g, telestrokeNote.diagnosis || '');
            note = note.replace(/{tnkAdminTime}/g, formatTime(telestrokeNote.tnkAdminTime));
            note = note.replace(/{recommendationsText}/g, telestrokeNote.recommendationsText || '');

            return note;

            // OLD TEMPLATE CODE BELOW - kept for reference but not used anymore
            /*

            let note = `Chief complaint: ${telestrokeNote.chiefComplaint}\n`;
            note += `Last known well (date/time): ${formatDate(telestrokeNote.lkwDate)} ${formatTime(telestrokeNote.lkwTime)}\n`;
            note += `HPI:\n`;
            note += `            ${telestrokeNote.age} year old ${telestrokeNote.sex} p/w ${telestrokeNote.symptoms}`;
            if (telestrokeNote.lkwTime) {
              note += ` at ${formatTime(telestrokeNote.lkwTime)}`;
            }
            note += `\n`;

            note += `Relevant PMH:\n`;
            note += `            ${telestrokeNote.pmh}\n`;

            note += `Medications: `;
            if (telestrokeNote.noAnticoagulants) {
              note += `no anticoagulants (confirmed with pt's wife), `;
            }
            note += `${telestrokeNote.medications}\n`;

            note += `Objective:\n`;
            note += `Vitals:\n`;
            if (telestrokeNote.presentingBP) {
              note += `Presenting BP ${telestrokeNote.presentingBP}\n`;
            }
            if (telestrokeNote.bpPreTNK) {
              note += `Blood pressure: BP prior to TNK administration: ${telestrokeNote.bpPreTNK}`;
              if (telestrokeNote.bpPreTNKTime) {
                note += ` at ${formatTime(telestrokeNote.bpPreTNKTime)}`;
              }
              note += `\n`;
            }

            note += `Labs: `;
            const labs = [];
            if (telestrokeNote.glucose) labs.push(`Glucose ${telestrokeNote.glucose}`);
            if (telestrokeNote.plateletsCoags) labs.push(`PLT and coags ${telestrokeNote.plateletsCoags}`);
            if (telestrokeNote.creatinine) labs.push(`Cr ${telestrokeNote.creatinine}`);
            note += labs.join(', ') + `\n`;

            note += `Exam: Scores: NIHSS ${telestrokeNote.nihss}`;
            if (telestrokeNote.nihssDetails) {
              note += ` - ${telestrokeNote.nihssDetails}`;
            }
            note += `\n`;

            note += `Imaging: `;
            if (telestrokeNote.imagingReviewed) {
              note += `I personally reviewed imaging\n`;
            } else {
              note += `\n`;
            }

            if (telestrokeNote.ctTime) {
              note += `Date/time Non-contrast Head CT reviewed: ${formatTime(telestrokeNote.ctTime)}\n`;
            }
            if (telestrokeNote.ctResults) {
              note += `Non-contrast Head CT Results: ${telestrokeNote.ctResults}\n`;
            }

            if (telestrokeNote.ctaDate && telestrokeNote.ctaTime) {
              note += `Date/time CTA reviewed: ${formatDate(telestrokeNote.ctaDate)} ${formatTime(telestrokeNote.ctaTime)}\n`;
            }
            if (telestrokeNote.ctaResults) {
              note += `CTA Results: ${telestrokeNote.ctaResults}\n`;
            }

            if (telestrokeNote.ekgResults) {
              note += `EKG - ${telestrokeNote.ekgResults}\n`;
            }

            note += `\nAssessment and Plan:\n`;
            note += `${telestrokeNote.diagnosis}\n`;

            if (telestrokeNote.tnkRecommended) {
              note += `After ensuring that there were no evident contraindications, TNK administration was recommended`;
              if (telestrokeNote.tnkAdminTime) {
                note += ` at ${formatTime(telestrokeNote.tnkAdminTime.split(' ')[0])}`;
              }
              note += `. `;

              if (telestrokeNote.tnkConsentDiscussed) {
                note += `Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the patient, patient's wife, and OSH provider. Both the patient and his wife expressed agreement with the recommendation.\n`;
              }

              if (telestrokeNote.tnkAdminTime) {
                note += `TNK was administered at ${formatTime(telestrokeNote.tnkAdminTime)} after a brief time-out.\n`;
              }
            }

            note += `\nRecommendations:\n`;
            if (telestrokeNote.recommendationsText) {
              note += `${telestrokeNote.recommendationsText}\n`;
            }

            note += `\nRizwan Kalani MD`;

            return note;
            */
          };

          // Time calculation functions
          const calculateTimeFromLKW = () => {
            if (!lkwTime) return null;
            const diffMs = currentTime - lkwTime;
            const diffHrs = diffMs / (1000 * 60 * 60);
            const diffMins = (diffMs / (1000 * 60)) % 60;
            return { hours: Math.floor(diffHrs), minutes: Math.floor(diffMins), total: diffHrs };
          };

          const getWindowStatus = (timeFromLKW) => {
            if (!timeFromLKW) return null;
            if (timeFromLKW.total <= 4.5) {
              // TNK eligible up to and including 4.5 hours
              if (timeFromLKW.total < 3) {
                return { color: 'green', message: 'Within TNK window (<3h)', urgent: false, eligible: 'tnk' };
              } else {
                return { color: 'yellow', message: 'Extended TNK window (3-4.5h)', urgent: false, eligible: 'tnk' };
              }
            } else if (timeFromLKW.total < 6) {
              return { color: 'orange', message: 'TNK window closed - EVT window (4.5-6h)', urgent: true, eligible: 'evt-early' };
            } else if (timeFromLKW.total < 24) {
              return { color: 'red', message: 'Late EVT window (6-24h - needs perfusion imaging)', urgent: true, eligible: 'evt-late' };
            } else {
              return { color: 'gray', message: 'Beyond standard treatment window', urgent: false, eligible: 'none' };
            }
          };

          // NIHSS validation
          const isNIHSSComplete = () => {
            return nihssItems.every(item => patientData[item.id] !== undefined && patientData[item.id] !== '');
          };

          const getIncompleteNIHSSItems = () => {
            return nihssItems.filter(item => !patientData[item.id]).map(item => item.name);
          };

          const getNIHSSInterpretation = (score) => {
            if (score === 0) return { severity: 'No stroke symptoms', color: 'green', guidance: 'Consider stroke mimics and alternative diagnoses' };
            if (score <= 4) return { severity: 'Minor stroke', color: 'yellow', guidance: 'Consider EVT if large vessel occlusion present despite low NIHSS' };
            if (score <= 15) return { severity: 'Moderate stroke', color: 'orange', guidance: 'Candidate for both thrombolysis and EVT if eligible' };
            if (score <= 20) return { severity: 'Moderate-severe stroke', color: 'red', guidance: 'Aggressive intervention warranted - high benefit potential' };
            return { severity: 'Severe stroke', color: 'red', guidance: 'All treatment options should be considered - high mortality risk without intervention' };
          };

          // Treatment validation
          const validateTreatmentRecommendation = () => {
            const hasContraindications = strokeCodeForm.tnk && strokeCodeForm.tnk.length > 0;
            const tnkRecommended = strokeCodeForm.tnk_rec === 'Recommended';

            if (hasContraindications && tnkRecommended) {
              return {
                valid: false,
                message: `⚠️ WARNING: TNK recommended but ${strokeCodeForm.tnk.length} contraindication(s) selected`,
                severity: 'error'
              };
            }

            if (!hasContraindications && strokeCodeForm.tnk_rec === 'Not Recommended') {
              return {
                valid: true,
                message: 'ℹ️ No contraindications selected. Confirm rationale for not recommending TNK.',
                severity: 'warning'
              };
            }

            return { valid: true, message: null, severity: null };
          };

          // Search function
          const performSearch = (query) => {
            if (!query || query.length < 2) {
              setSearchResults([]);
              return;
            }

            const results = [];
            const lowerQuery = query.toLowerCase();

            // Search in trials
            Object.entries(trialsData).forEach(([category, data]) => {
              if (data.hasSubsections) {
                Object.entries(data.subsections).forEach(([subKey, subsection]) => {
                  subsection.trials.forEach(trial => {
                    if (trial.name.toLowerCase().includes(lowerQuery) ||
                        trial.description.toLowerCase().includes(lowerQuery) ||
                        trial.nct.toLowerCase().includes(lowerQuery)) {
                      results.push({
                        type: 'Clinical Trial',
                        category: category,
                        title: trial.name,
                        description: trial.description.substring(0, 100) + '...',
                        action: () => {
                          setActiveTab('trials');
                          setTrialsCategory(category);
                          setSearchOpen(false);
                          setSearchQuery('');
                        }
                      });
                    }
                  });
                });
              }
            });

            // Search in protocols/calculators
            const searchableItems = [
              { name: 'NIHSS', keywords: ['nihss', 'stroke scale', 'neurological'], tab: 'nihss' },
              { name: 'ASPECTS', keywords: ['aspects', 'imaging', 'ct'], tab: 'imaging' },
              { name: 'TNK Eligibility', keywords: ['tnk', 'tenecteplase', 'thrombolysis', 'lytic'], tab: 'lytic' },
              { name: 'EVT Eligibility', keywords: ['evt', 'thrombectomy', 'mechanical', 'endovascular'], tab: 'evt' },
              { name: 'ICH Management', keywords: ['ich', 'hemorrhage', 'bleeding', 'reversal'], tab: 'ich' },
              { name: 'GCS Score', keywords: ['gcs', 'glasgow', 'coma', 'consciousness'], tab: 'calculators' },
              { name: 'ICH Score', keywords: ['ich score', 'hemorrhage score', 'mortality'], tab: 'calculators' },
              { name: 'ABCD² Score', keywords: ['abcd', 'tia', 'transient'], tab: 'calculators' },
              { name: 'CHA₂DS₂-VASc', keywords: ['chads', 'afib', 'atrial fibrillation', 'anticoagulation'], tab: 'calculators' },
              { name: 'ROPE Score', keywords: ['rope', 'pfo', 'paradoxical'], tab: 'calculators' },
              { name: 'Blood Pressure Management', keywords: ['bp', 'blood pressure', 'labetalol', 'nicardipine'], tab: 'protocols' }
            ];

            searchableItems.forEach(item => {
              if (item.name.toLowerCase().includes(lowerQuery) ||
                  item.keywords.some(k => k.includes(lowerQuery))) {
                results.push({
                  type: 'Tool/Protocol',
                  title: item.name,
                  description: `Go to ${item.name}`,
                  action: () => {
                    setActiveTab(item.tab);
                    setSearchOpen(false);
                    setSearchQuery('');
                  }
                });
              }
            });

            setSearchResults(results.slice(0, 10)); // Limit to 10 results
          };

          // Reset all data - New Patient
          const resetAllData = () => {
            if (!confirm('Start new patient assessment? All current data will be cleared. This cannot be undone.')) {
              return;
            }

            // Clear all state
            setPatientData({});
            setNihssScore(0);
            setAspectsScore(10);
            setLkwTime(null);
            setStrokeCodeForm({
              age: '',
              sex: '',
              hx: '',
              sx: '',
              lkw: '',
              lkw_date: new Date().toISOString().split('T')[0],
              nihss: '',
              def: '',
              hct: '',
              cta: '',
              ctp: '',
              tnk: [],
              tnk_rec: '',
              evt_rec: '',
              rec_reason: ''
            });
            setAspectsRegionState([
              { id: 'M1', name: 'M1 - Anterior MCA cortex', checked: true },
              { id: 'M2', name: 'M2 - MCA cortex lateral to insular ribbon', checked: true },
              { id: 'M3', name: 'M3 - Posterior MCA cortex', checked: true },
              { id: 'M4', name: 'M4 - Anterior MCA territory immediately superior to M1', checked: true },
              { id: 'M5', name: 'M5 - Lateral MCA territory immediately superior to M2', checked: true },
              { id: 'M6', name: 'M6 - Posterior MCA territory immediately superior to M3', checked: true },
              { id: 'IC', name: 'IC - Internal capsule', checked: true },
              { id: 'L', name: 'L - Lentiform nucleus', checked: true },
              { id: 'C', name: 'C - Caudate', checked: true },
              { id: 'I', name: 'I - Insular ribbon', checked: true }
            ]);
            setPcAspectsRegions([
              { id: 'THAL', name: 'Thalami (bilateral)', checked: true, points: 1 },
              { id: 'MIDBRAIN', name: 'Midbrain', checked: true, points: 2 },
              { id: 'PONS', name: 'Pons', checked: true, points: 2 },
              { id: 'MEDULLA', name: 'Medulla', checked: true, points: 1 },
              { id: 'CEREBELLUM-L', name: 'Left Cerebellar Hemisphere', checked: true, points: 1 },
              { id: 'CEREBELLUM-R', name: 'Right Cerebellar Hemisphere', checked: true, points: 1 },
              { id: 'PCA-L', name: 'Left Occipital Lobe (PCA Territory)', checked: true, points: 1 },
              { id: 'PCA-R', name: 'Right Occipital Lobe (PCA Territory)', checked: true, points: 1 }
            ]);
            setGcsItems({ eye: 0, verbal: 0, motor: 0 });
            setIchScoreItems({ gcs: '', age80: false, volume30: false, ivh: false, infratentorial: false });
            setAbcd2Items({ age60: false, bp: false, unilateralWeakness: false, speechDisturbance: false, duration: '', diabetes: false });
            setChads2vascItems({ chf: false, hypertension: false, age75: false, diabetes: false, strokeTia: false, vascular: false, age65: false, female: false });
            setRopeItems({ noHypertension: false, noDiabetes: false, noStrokeTia: false, nonsmoker: false, cortical: false, age: '' });
            setCurrentStep(0);
            setCompletedSteps([]);

            // Clear localStorage for patient data
            const keysToRemove = ['patientData', 'nihssScore', 'aspectsScore', 'gcsItems', 'ichScoreItems',
                                   'abcd2Items', 'chads2vascItems', 'ropeItems', 'strokeCodeForm', 'lkwTime',
                                   'currentStep', 'completedSteps', 'aspectsRegionState', 'pcAspectsRegions'];
            keysToRemove.forEach(key => localStorage.removeItem(key));

            setActiveTab('encounter');
            setSaveStatus('saved');
          };

          // Workflow steps definition
          const workflowSteps = [
            { id: 'assessment', name: 'Initial Assessment', tab: 'workflow' },
            { id: 'nihss', name: 'NIHSS Score', tab: 'nihss' },
            { id: 'imaging', name: 'Imaging Review', tab: 'imaging' },
            { id: 'eligibility', name: 'Treatment Eligibility', tab: 'lytic' },
            { id: 'documentation', name: 'Documentation', tab: 'encounter' }
          ];

          // Save to localStorage with expiration whenever state changes
          useEffect(() => {
            debouncedSave('activeTab', activeTab);
          }, [activeTab]);

          useEffect(() => {
            debouncedSave('patientData', patientData);
            const newScore = calculateNIHSS(patientData);
            if (newScore !== nihssScore) {
              setNihssScore(newScore);
            }
          }, [patientData]);

          useEffect(() => {
            debouncedSave('nihssScore', nihssScore);
          }, [nihssScore]);

          useEffect(() => {
            debouncedSave('aspectsScore', aspectsScore);
          }, [aspectsScore]);

          useEffect(() => {
            debouncedSave('gcsItems', gcsItems);
          }, [gcsItems]);

          useEffect(() => {
            debouncedSave('ichScoreItems', ichScoreItems);
          }, [ichScoreItems]);

          useEffect(() => {
            debouncedSave('abcd2Items', abcd2Items);
          }, [abcd2Items]);

          useEffect(() => {
            debouncedSave('chads2vascItems', chads2vascItems);
          }, [chads2vascItems]);

          useEffect(() => {
            debouncedSave('ropeItems', ropeItems);
          }, [ropeItems]);

          useEffect(() => {
            debouncedSave('strokeCodeForm', strokeCodeForm);
          }, [strokeCodeForm]);

          useEffect(() => {
            debouncedSave('aspectsRegionState', aspectsRegionState);
          }, [aspectsRegionState]);

          useEffect(() => {
            debouncedSave('pcAspectsRegions', pcAspectsRegions);
          }, [pcAspectsRegions]);

          useEffect(() => {
            debouncedSave('telestrokeNote', telestrokeNote);
          }, [telestrokeNote]);

          useEffect(() => {
            debouncedSave('telestrokeTemplate', editableTemplate);
          }, [editableTemplate]);

          useEffect(() => {
            if (lkwTime) {
              debouncedSave('lkwTime', lkwTime.toISOString());
            }
          }, [lkwTime]);

          useEffect(() => {
            debouncedSave('currentStep', currentStep);
          }, [currentStep]);

          useEffect(() => {
            debouncedSave('completedSteps', completedSteps);
          }, [completedSteps]);

          // Auto-populate Documentation form with Workflow data
          useEffect(() => {
            if (lkwTime) {
              const timeStr = lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
              const dateStr = lkwTime.toLocaleDateString('en-US');
              setStrokeCodeForm(prev => ({
                ...prev,
                lkw: timeStr,
                lkw_date: lkwTime.toISOString().split('T')[0]
              }));
            }
          }, [lkwTime]);

          useEffect(() => {
            if (nihssScore !== null && nihssScore !== undefined) {
              setStrokeCodeForm(prev => ({
                ...prev,
                nihss: nihssScore.toString()
              }));
            }
          }, [nihssScore]);

          useEffect(() => {
            if (aspectsScore !== null && aspectsScore !== undefined) {
              setStrokeCodeForm(prev => ({
                ...prev,
                aspects: aspectsScore.toString()
              }));
            }
          }, [aspectsScore]);

          // Update current time every minute
          useEffect(() => {
            const timer = setInterval(() => setCurrentTime(new Date()), 60000);
            return () => clearInterval(timer);
          }, []);

          // Monitor critical alerts
          useEffect(() => {
            const alerts = [];

            if (lkwTime) {
              const timeFromLKW = calculateTimeFromLKW();
              if (!timeFromLKW) return;

              const totalHours = timeFromLKW.total;
              const remainingToTNK = 4.5 - totalHours;
              const remainingToEVT = 6 - totalHours;

              // Alert if <30 min to TNK cutoff (4.5h)
              if (remainingToTNK > 0 && remainingToTNK <= 0.5) {
                const minsLeft = Math.floor(remainingToTNK * 60);
                alerts.push({
                  id: 'tnk-cutoff',
                  level: 'critical',
                  message: `⚠️ URGENT: Only ${minsLeft} minutes left for TNK window!`,
                  action: 'TNK must be given before 4.5h from LKW'
                });
              }

              // Alert if <30 min to early EVT cutoff (6h)
              if (remainingToEVT > 0 && remainingToEVT <= 0.5 && totalHours > 4.5) {
                const minsLeft = Math.floor(remainingToEVT * 60);
                alerts.push({
                  id: 'evt-cutoff',
                  level: 'critical',
                  message: `⚠️ URGENT: Only ${minsLeft} minutes left for early EVT window!`,
                  action: 'Consider EVT before 6h window requires perfusion imaging'
                });
              }
            }

            setCriticalAlerts(alerts);
          }, [currentTime, lkwTime]);

          // Perform search when query changes
          useEffect(() => {
            performSearch(searchQuery);
          }, [searchQuery]);

          // Initialize component and icons on mount
          useEffect(() => {
            // Initialize icons immediately on first render
            lucide.createIcons();

            // After icons are initialized, load saved tab if valid
            requestAnimationFrame(() => {
              setIsMounted(true);

              // Load saved tab preference AFTER initial render
              try {
                const savedTab = localStorage.getItem('activeTab');
                const validTabs = ['encounter', 'ich', 'protocols', 'calculators', 'trials', 'evidence'];
                if (savedTab && savedTab !== 'null' && savedTab !== 'undefined' && validTabs.includes(savedTab.replace(/"/g, ''))) {
                  setActiveTab(savedTab.replace(/"/g, ''));
                }
              } catch (e) {
                console.warn('Error loading saved tab:', e);
              }

              lucide.createIcons();
            });
          }, []);

          // Reinitialize icons when needed
          useEffect(() => {
            if (isMounted) {
              lucide.createIcons();
            }
          }, [activeTab, copiedText, darkMode, searchOpen, mobileMoreOpen, isMounted]);

          // Documentation generation functions
          const generateHPI = () => {
            const timeFromLKW = calculateTimeFromLKW();
            const timeElapsed = timeFromLKW ? `${timeFromLKW.hours}h ${timeFromLKW.minutes}m` : 'unknown';
            const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '__';
            const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : '__';
            const sexDisplay = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '__';
            const nihssDisplay = telestrokeNote.nihss || nihssScore || '__';

            return `HPI: ${telestrokeNote.age || '__'} year old ${sexDisplay} with PMH of ${telestrokeNote.pmh || '__'} presenting with ${telestrokeNote.symptoms || '__'} starting at ${lkw} on ${lkwDate} (${timeElapsed} ago). NIHSS ${nihssDisplay}.

IMAGING:
- Head CT: ${telestrokeNote.ctResults || 'pending'}
- CTA Head/Neck: ${telestrokeNote.ctaResults || 'pending'}
- CTP: ${telestrokeNote.ctpResults || 'pending'}
- ASPECTS: ${aspectsScore || '__'}

ASSESSMENT: ${telestrokeNote.diagnosis || 'Acute ischemic stroke'}, NIHSS ${nihssDisplay}
${telestrokeNote.tnkRecommended ? `\nTNK: Recommended` : '\nTNK: Not Recommended'}
${telestrokeNote.evtRecommended ? `EVT: Recommended` : 'EVT: Not Recommended'}`;
          };

          const generateAdmissionOrders = () => {
            const nihssDisplay = telestrokeNote.nihss || nihssScore || '__';

            return `ACUTE STROKE ADMISSION ORDERS:

1. Admit to Stroke Unit / Neuro ICU
2. Vital signs q1h x 24h, then q4h
3. Continuous telemetry monitoring
4. NPO until swallow evaluation completed
5. IV fluids: NS at 75 mL/hr
6. Maintain SBP <180/105 (or <185/110 if post-tPA)
7. Blood glucose 140-180 mg/dL
8. HOB elevated 30 degrees
9. DVT prophylaxis: SCDs (hold pharmacologic if tPA given)
10. Aspirin 325mg daily (hold x 24h if tPA given)
11. Statin therapy: Atorvastatin 80mg daily
12. Neurology consultation
13. PT/OT/Speech evaluation
14. Fall precautions

LABS:
- CBC, CMP, PT/INR, PTT
- Lipid panel, HbA1c
- Troponin, BNP
- Consider: ESR, CRP if indicated

IMAGING:
- MRI brain with DWI if not already done
- Carotid ultrasound
- Echocardiogram (TTE or TEE)

NIHSS: ${nihssDisplay} - reassess q4h x 24h, then daily`;
          };

          const generateSignOut = () => {
            const timeFromLKW = calculateTimeFromLKW();
            const timeElapsed = timeFromLKW ? `${timeFromLKW.hours}h ${timeFromLKW.minutes}m` : 'unknown';
            const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '__';
            const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : '__';
            const sexDisplay = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '__';
            const nihssDisplay = telestrokeNote.nihss || nihssScore || '__';

            return `STROKE SIGN-OUT:

Patient: ${telestrokeNote.age || '__'}yo ${sexDisplay}
PMH: ${telestrokeNote.pmh || '__'}

PRESENTATION: ${telestrokeNote.symptoms || '__'} starting ${lkw} on ${lkwDate} (${timeElapsed} ago)

NIHSS: ${nihssDisplay}
ASPECTS: ${aspectsScore || '__'}

IMAGING:
- CT: ${telestrokeNote.ctResults || 'pending'}
- CTA: ${telestrokeNote.ctaResults || 'pending'}
- CTP: ${telestrokeNote.ctpResults || 'pending'}

TREATMENT:
${telestrokeNote.tnkRecommended ? 'TNK: Recommended' : 'TNK: Not Recommended'}
${telestrokeNote.evtRecommended ? 'EVT: Recommended' : 'EVT: Not Recommended'}

TO DO:
- Monitor BP goal <180/105
- Repeat NIHSS q4h
- Swallow eval when awake
- MRI brain
- Carotid ultrasound
- Echo
- Start ASA/statin after 24h if tPA given`;
          };

          return (
            <div className={`max-w-7xl mx-auto p-3 sm:p-6 ${darkMode ? 'bg-gray-900' : 'bg-white'}`}>
              {/* Header */}
              <div className="mb-4 sm:mb-6">
                <div className="flex flex-col sm:flex-row justify-between items-center gap-3">
                  <div className="flex-1">
                    <h1 className="text-2xl sm:text-3xl font-bold text-blue-900 mb-1 text-center sm:text-left">
                      Stroke CDS
                    </h1>
                    <div className="flex items-center justify-center sm:justify-start gap-2 text-xs text-gray-500">
                      <span>Last Updated: October 2025 • v2.1</span>
                      {/* Save Status */}
                      <span className="flex items-center gap-1">
                        {saveStatus === 'saving' && (
                          <>
                            <div className="spinner"></div>
                            <span className="text-blue-600">Saving...</span>
                          </>
                        )}
                        {saveStatus === 'saved' && lastSaved && (
                          <>
                            <i data-lucide="check-circle" className="w-3 h-3 text-green-600"></i>
                            <span className="text-green-600">Saved {new Date(lastSaved).toLocaleTimeString()}</span>
                          </>
                        )}
                        {saveStatus === 'error' && (
                          <>
                            <i data-lucide="alert-circle" className="w-3 h-3 text-red-600"></i>
                            <span className="text-red-600">Save failed</span>
                          </>
                        )}
                      </span>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    {/* Search Bar with Results */}
                    <div className="relative">
                      <input
                        type="text"
                        placeholder="Search trials, protocols..."
                        value={searchQuery}
                        onChange={(e) => {
                          setSearchQuery(e.target.value);
                          setSearchOpen(true);
                        }}
                        onFocus={() => setSearchOpen(true)}
                        onBlur={() => setTimeout(() => setSearchOpen(false), 200)}
                        className="pl-8 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 md:w-64"
                        aria-label="Search clinical tools and protocols"
                      />
                      <i data-lucide="search" className="w-4 h-4 absolute left-2 top-3 text-gray-400"></i>

                      {/* Search Results Dropdown */}
                      {searchOpen && searchResults.length > 0 && (
                        <div className="absolute top-12 left-0 w-96 bg-white shadow-lg rounded-lg border max-h-96 overflow-y-auto z-50">
                          {searchResults.map((result, index) => (
                            <button
                              key={index}
                              onClick={result.action}
                              className="w-full text-left p-3 hover:bg-blue-50 border-b transition-colors"
                            >
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <p className="font-semibold text-sm">{result.title}</p>
                                  {result.description && (
                                    <p className="text-xs text-gray-600 mt-1">{result.description}</p>
                                  )}
                                </div>
                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded ml-2">{result.type}</span>
                              </div>
                            </button>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* New Patient Button */}
                    <button
                      onClick={resetAllData}
                      className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                      aria-label="Start new patient assessment"
                      title="Clear all data and start new patient"
                    >
                      <i data-lucide="user-plus" className="w-4 h-4"></i>
                      <span className="hidden lg:inline">New Patient</span>
                    </button>

                    {/* Export Button */}
                    <button
                      onClick={exportToPDF}
                      className="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                      aria-label="Export to PDF"
                      title="Export current view to PDF"
                    >
                      <i data-lucide="download" className="w-4 h-4"></i>
                      <span className="hidden sm:inline">PDF</span>
                    </button>

                    {/* Dark Mode Toggle */}
                    <button
                      onClick={toggleDarkMode}
                      className="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                      aria-label={darkMode ? "Switch to light mode" : "Switch to dark mode"}
                      title={darkMode ? "Switch to light mode" : "Switch to dark mode"}
                    >
                      <i data-lucide={darkMode ? "sun" : "moon"} className="w-5 h-5"></i>
                    </button>
                  </div>
                </div>

                {/* Success Notification */}
                {copiedText && (
                  <div className="mt-2 p-2 bg-green-100 border border-green-400 text-green-700 rounded-lg text-sm flex items-center gap-2">
                    <i data-lucide="check" className="w-4 h-4"></i>
                    <span>{copiedText} copied to clipboard!</span>
                  </div>
                )}
              </div>

              {/* Critical Alerts Banner */}
              {criticalAlerts.length > 0 && (
                <div className="mb-4 space-y-2">
                  {criticalAlerts.map(alert => (
                    <div
                      key={alert.id}
                      className={`p-4 rounded-lg border-2 flex items-start gap-3 ${
                        alert.level === 'critical'
                          ? 'bg-red-50 border-red-500 animate-pulse'
                          : 'bg-yellow-50 border-yellow-500'
                      }`}
                    >
                      <i
                        data-lucide="alert-triangle"
                        className={`w-6 h-6 flex-shrink-0 ${
                          alert.level === 'critical' ? 'text-red-600' : 'text-yellow-600'
                        }`}
                      ></i>
                      <div className="flex-1">
                        <p className={`font-bold text-lg ${
                          alert.level === 'critical' ? 'text-red-900' : 'text-yellow-900'
                        }`}>
                          {alert.message}
                        </p>
                        <p className={`text-sm mt-1 ${
                          alert.level === 'critical' ? 'text-red-700' : 'text-yellow-700'
                        }`}>
                          {alert.action}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Navigation Tabs - Desktop Only */}
              <div className="border-b border-gray-200 mb-4 sm:mb-6 pb-2 hidden md:block">
                <nav className="flex flex-wrap justify-center gap-2 md:justify-between md:gap-0">
                  {[
                    { id: 'encounter', name: '⚡ Encounter', icon: 'activity' },
                    { id: 'ich', name: 'ICH', icon: 'alert-triangle' },
                    { id: 'protocols', name: 'Management', icon: 'file-text' },
                    { id: 'calculators', name: 'Calculators', icon: 'calculator' },
                    { id: 'trials', name: 'Trials', icon: 'file-text' },
                    { id: 'evidence', name: 'Evidence', icon: 'file-text' }
                  ].map(tab => {
                    return (
                      <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`py-2 px-3 border-2 rounded-lg font-medium text-xs flex items-center space-x-1 transition-all
                          ${activeTab === tab.id
                            ? 'border-blue-500 bg-blue-50 text-blue-600'
                            : 'border-gray-300 bg-white text-gray-600 hover:text-gray-800 hover:border-gray-400'
                          }
                          sm:py-2 sm:px-2 sm:border-b-2 sm:border-t-0 sm:border-l-0 sm:border-r-0 sm:rounded-none
                          md:text-xs
                        `}
                      >
                        <i data-lucide={tab.icon} className="w-3 h-3 hidden sm:block"></i>
                        <span>{tab.name}</span>
                      </button>
                    );
                  })}
                </nav>
              </div>

              {/* Content */}
              <div className="space-y-4 sm:space-y-6 pb-24 md:pb-0">

                {/* CONSOLIDATED ENCOUNTER TAB */}
                {activeTab === 'encounter' && (
                  <div key="encounter-tab" className="space-y-4">
                    {/* Last Known Well Input */}
                    <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                      <label className="block font-semibold text-blue-900 mb-2">
                        <i data-lucide="clock" className="w-4 h-4 inline mr-1"></i>
                        Last Known Well Time *
                      </label>

                      {/* Separate Date and Time Inputs */}
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                          <label className="block text-sm font-medium text-blue-900 mb-1">Date</label>
                          <input
                            type="date"
                            value={lkwTime ? lkwTime.toISOString().split('T')[0] : ''}
                            onChange={(e) => {
                              if (e.target.value) {
                                const newDate = new Date(e.target.value);
                                if (lkwTime) {
                                  newDate.setHours(lkwTime.getHours(), lkwTime.getMinutes());
                                }
                                setLkwTime(newDate);
                              }
                            }}
                            max={currentTime.toISOString().split('T')[0]}
                            className="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-blue-900 mb-1">Time</label>
                          <input
                            type="time"
                            value={lkwTime ? lkwTime.toTimeString().slice(0, 5) : ''}
                            onChange={(e) => {
                              if (e.target.value) {
                                const [hours, minutes] = e.target.value.split(':');
                                const newDate = lkwTime ? new Date(lkwTime) : new Date();
                                newDate.setHours(parseInt(hours), parseInt(minutes));
                                setLkwTime(newDate);
                              }
                            }}
                            className="w-full px-4 py-3 border-2 border-blue-300 rounded-lg text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                      </div>
                    </div>

                    {/* Two-Column Layout: Desktop/Tablet | Single Column: Mobile */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">

                      {/* LEFT COLUMN - Data Entry (2/3 width on desktop) */}
                      <div className="lg:col-span-2 space-y-4">

                        {/* Section 1: Patient Info */}
                        <div className="bg-white border-2 border-blue-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-blue-900">1. Patient Info</h3>
                            <i data-lucide="user" className="w-5 h-5 text-blue-600"></i>
                          </div>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                              <input
                                type="number"
                                value={telestrokeNote.age}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, age: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder=""
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Sex</label>
                              <select
                                value={telestrokeNote.sex}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, sex: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="M">M</option>
                                <option value="F">F</option>
                              </select>
                            </div>
                          </div>
                          <div className="mt-3">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Chief Complaint</label>
                            <input
                              type="text"
                              value={telestrokeNote.chiefComplaint}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, chiefComplaint: e.target.value})}
                              placeholder=""
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>

                        {/* Section 2: History & Medications */}
                        <div className="bg-white border-2 border-purple-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-purple-900">2. History & Medications</h3>
                            <i data-lucide="file-text" className="w-5 h-5 text-purple-600"></i>
                          </div>
                          <div className="space-y-3">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Presenting Symptoms</label>
                              <textarea
                                value={telestrokeNote.symptoms}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, symptoms: e.target.value})}
                                placeholder=""
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Relevant PMH</label>
                              <input
                                type="text"
                                value={telestrokeNote.pmh}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, pmh: e.target.value})}
                                placeholder=""
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Medications</label>
                              <textarea
                                value={telestrokeNote.medications}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, medications: e.target.value})}
                                placeholder=""
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Section 3: NIHSS Examination */}
                        <div className="bg-white border-2 border-red-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-red-900">3. NIHSS Examination</h3>
                            <div className="flex items-center gap-2">
                              <span className="text-2xl font-bold text-red-600">Score: {nihssScore}</span>
                              <i data-lucide="brain" className="w-5 h-5 text-red-600"></i>
                            </div>
                          </div>

                          {/* Quick NIHSS Entry */}
                          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                            <p className="text-sm font-medium text-gray-700 mb-2">Quick Entry (if you already calculated NIHSS):</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              <input
                                type="number"
                                value={telestrokeNote.nihss}
                                onChange={(e) => {
                                  const value = e.target.value;
                                  setTelestrokeNote({...telestrokeNote, nihss: value});
                                  setNihssScore(parseInt(value) || 0);
                                }}
                                placeholder=""
                                className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Neurologic Deficits</label>
                                <input
                                  type="text"
                                  value={telestrokeNote.nihssDetails}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, nihssDetails: e.target.value})}
                                  placeholder=""
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                            </div>
                          </div>

                          {/* Full NIHSS Calculator (Collapsible) */}
                          <details className="bg-gray-50 border border-gray-200 rounded-lg">
                            <summary className="cursor-pointer p-3 font-semibold text-gray-800 hover:bg-gray-100 rounded-lg">
                              📊 Full NIHSS Calculator (Click to expand)
                            </summary>
                            <div className="p-4 space-y-3">
                              {nihssItems.map((item) => (
                                <div key={item.id} className="bg-white p-3 rounded border">
                                  <h4 className="font-semibold text-sm mb-2">{item.name}</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {item.options.map((option, optionIndex) => (
                                      <label key={optionIndex} className="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input
                                          type="radio"
                                          name={item.id}
                                          value={option}
                                          checked={patientData[item.id] === option}
                                          onChange={(e) => {
                                            const newData = { ...patientData, [item.id]: e.target.value };
                                            setPatientData(newData);
                                            const newScore = calculateNIHSS(newData);
                                            setNihssScore(newScore);
                                            setTelestrokeNote({...telestrokeNote, nihss: newScore.toString()});
                                          }}
                                          className="text-blue-600"
                                        />
                                        <span>{option}</span>
                                      </label>
                                    ))}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </details>
                        </div>

                        {/* Section 4: Vitals & Labs */}
                        <div className="bg-white border-2 border-green-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-green-900">4. Vitals & Labs</h3>
                            <i data-lucide="activity" className="w-5 h-5 text-green-600"></i>
                          </div>
                          <div className="space-y-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Presenting BP</label>
                                <input
                                  type="text"
                                  value={telestrokeNote.presentingBP}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, presentingBP: e.target.value})}
                                  placeholder=""
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Current BP (prior to TNK, if applicable)</label>
                                <div className="flex gap-2">
                                  <input
                                    type="text"
                                    value={telestrokeNote.bpPreTNK}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, bpPreTNK: e.target.value})}
                                    placeholder=""
                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  />
                                  <input
                                    type="time"
                                    value={telestrokeNote.bpPreTNKTime}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, bpPreTNKTime: e.target.value})}
                                    className="w-24 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                              </div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Glucose</label>
                              <input
                                type="text"
                                value={telestrokeNote.glucose}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, glucose: e.target.value})}
                                placeholder=""
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Section 5: Imaging Review */}
                        <div className="bg-white border-2 border-indigo-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-indigo-900">5. Imaging Review</h3>
                            <i data-lucide="image" className="w-5 h-5 text-indigo-600"></i>
                          </div>
                          <div className="space-y-3">
                            {/* Non-contrast Head CT */}
                            <div className="bg-gray-50 p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">Non-contrast Head CT</h4>
                              <div className="grid grid-cols-2 gap-2 mb-2">
                                <input
                                  type="date"
                                  value={telestrokeNote.ctDate}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, ctDate: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                                <input
                                  type="time"
                                  value={telestrokeNote.ctTime}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, ctTime: e.target.value})}
                                  placeholder="Time reviewed"
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <textarea
                                value={telestrokeNote.ctResults}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, ctResults: e.target.value})}
                                placeholder=""
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            {/* ASPECTS Calculator (Collapsible) */}
                            <details className="bg-blue-50 border border-blue-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg">
                                🧮 ASPECTS Calculator (Click to expand)
                              </summary>
                              <div className="p-4">
                                <div className="text-center mb-3">
                                  <span className="text-3xl font-bold text-blue-600">ASPECTS: {aspectsScore}</span>
                                </div>
                                <div className="space-y-2">
                                  {aspectsRegionState.map((region) => (
                                    <label key={region.id} className="flex items-center gap-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={region.checked}
                                        onChange={() => {
                                          const newState = aspectsRegionState.map(r =>
                                            r.id === region.id ? { ...r, checked: !r.checked } : r
                                          );
                                          setAspectsRegionState(newState);
                                          setAspectsScore(newState.filter(r => r.checked).length);
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className="text-sm">{region.name}</span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            </details>

                            {/* PC-ASPECTS Calculator (Collapsible) */}
                            <details className="bg-purple-50 border border-purple-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg">
                                🧮 PC-ASPECTS Calculator (Posterior Circulation)
                              </summary>
                              <div className="p-4">
                                <div className="flex justify-between items-center mb-3">
                                  <p className="text-sm text-gray-700">Start at 10 points, subtract points for affected regions:</p>
                                  <div className="text-center">
                                    <span className="text-3xl font-bold text-purple-600">PC-ASPECTS: {calculatePCAspects(pcAspectsRegions)}</span>
                                  </div>
                                </div>
                                <div className="space-y-2">
                                  {pcAspectsRegions.map((region, idx) => (
                                    <label key={region.id} className="flex items-center gap-2 p-2 hover:bg-purple-50 rounded cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={region.checked}
                                        onChange={(e) => {
                                          const newRegions = [...pcAspectsRegions];
                                          newRegions[idx].checked = e.target.checked;
                                          setPcAspectsRegions(newRegions);
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className="text-sm flex-1">{region.name}</span>
                                      <span className="text-xs font-semibold text-purple-700 bg-purple-100 px-2 py-1 rounded">
                                        {region.points} {region.points === 1 ? 'point' : 'points'}
                                      </span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            </details>

                            {/* CTA Head & Neck */}
                            <div className="bg-gray-50 p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">CTA Head & Neck</h4>
                              <div className="grid grid-cols-2 gap-2 mb-2">
                                <input
                                  type="date"
                                  value={telestrokeNote.ctaDate}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, ctaDate: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                                <input
                                  type="time"
                                  value={telestrokeNote.ctaTime}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, ctaTime: e.target.value})}
                                  placeholder="Time reviewed"
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <textarea
                                value={telestrokeNote.ctaResults}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, ctaResults: e.target.value})}
                                placeholder=""
                                rows="3"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            {/* CT Perfusion */}
                            <div className="bg-gray-50 p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">CT Perfusion</h4>
                              <textarea
                                value={telestrokeNote.ctpResults}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, ctpResults: e.target.value})}
                                placeholder=""
                                rows="3"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Section 6: Treatment Decision */}
                        <div className="bg-white border-2 border-orange-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-orange-900">6. Treatment Decision</h3>
                            <i data-lucide="zap" className="w-5 h-5 text-orange-600"></i>
                          </div>
                          <div className="space-y-3">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Diagnosis</label>
                              <textarea
                                value={telestrokeNote.diagnosis}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, diagnosis: e.target.value})}
                                placeholder=""
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            {/* Lytic Eligibility Criteria (Collapsible) */}
                            <details className="bg-green-50 border border-green-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-green-800 hover:bg-green-100 rounded-lg">
                                ✓ Lytic Eligibility Criteria (Click to expand)
                              </summary>
                              <div className="p-4 space-y-3 text-sm">
                                <div>
                                  <h4 className="font-semibold text-green-700 mb-2">Inclusion Criteria:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Diagnosis of ischemic stroke causing measurable neurologic deficit</li>
                                    <li>• Age ≥18 years</li>
                                    <li>• Onset of symptoms &lt;3 hours (or &lt;4.5h with additional criteria)</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-amber-700 mb-2">3-4.5h Window Additional Criteria:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Age ≤80 years</li>
                                    <li>• No history of both DM and prior stroke</li>
                                    <li>• NIHSS ≤25</li>
                                    <li>• No oral anticoagulant use</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-teal-700 mb-2">WAKE-UP:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• LKN unclear (not awake/known to have had sx for 4.5 hours) + NO LVO</li>
                                    <li>• MRI w/ DWI and T2/FLAIR</li>
                                    <li>• Discuss ↓ certainty in benefit and ↑ hemorrhage risk w/ thrombolysis</li>
                                  </ul>
                                </div>
                              </div>
                            </details>

                            {/* TNK Contraindications (Collapsible) */}
                            <details className="bg-red-50 border border-red-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-red-800 hover:bg-red-100 rounded-lg">
                                ✗ TNK Contraindications (Click to expand)
                              </summary>
                              <div className="p-4 space-y-3 text-sm">
                                <div>
                                  <h4 className="font-semibold text-red-700 mb-2">Imaging Exclusions:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• CT with evidence of hemorrhage</li>
                                    <li>• CT with extensive regions of clear hypoattenuation</li>
                                    <li>• Ischemic injury &gt;1/3 of MCA territory</li>
                                    <li>• Intra-axial, intracranial tumor (extra-axial tumors not absolute contraindication)</li>
                                    <li>• Aortic arch dissection</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-red-700 mb-2">Clinical Exclusions:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Recent stroke (&lt;90 days)</li>
                                    <li>• Recent severe head trauma (&lt;90 days)</li>
                                    <li>• Recent intracranial/intraspinal surgery (&lt;60 days)</li>
                                    <li>• Active internal bleeding</li>
                                    <li>• GI malignancy</li>
                                    <li>• Recent GI/urinary tract hemorrhage (&lt;21 days)</li>
                                    <li>• Clinical presentation suggestive of SAH (even if HCT normal)</li>
                                    <li>• Presentation consistent with infective endocarditis</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-red-700 mb-2">Lab/Vital Exclusions:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• SBP &gt;185 mmHg or DBP &gt;110 mmHg (unresponsive to meds)</li>
                                    <li>• Platelet count &lt;100,000</li>
                                    <li>• Blood glucose &lt;50 mg/dL</li>
                                    <li>• Warfarin use with PT &gt;15s, INR &gt;1.7, or aPTT &gt;40s</li>
                                    <li>• Recent DOAC use (&lt;48h)</li>
                                    <li>• Treatment-dose heparin/LMWH (&lt;24 hours)</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-yellow-700 mb-2">⚠ Cautionary Criteria:</h4>
                                  <p className="text-xs text-gray-600 mb-2">Consider risks/benefits and discuss with stroke team for:</p>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Prior known non-traumatic intracranial hemorrhage</li>
                                    <li>• Vascular malformation unless severe neurological sx (ischemic risk outweighs ICH)</li>
                                    <li>• Pregnancy; risk to fetus and woman unknown—consult OB/GYN ASAP</li>
                                    <li>• Major extra-cranial surgery or trauma within 14 days</li>
                                    <li>• Acute or recent MI (within 3 months), depending on what type of MI</li>
                                    <li>• Acute pericarditis</li>
                                    <li>• Abnormal aPTT, TT, or anti-Xa activity with unknown use of direct thrombin inhibitor or factor Xa inhibitor</li>
                                    <li>• Cerebral microbleeds: &gt;10 on prior MRI may increase risk for ICH</li>
                                    <li>• Lecanemab or other Alzheimer's medications with potential risk of amyloid related imaging abnormalities</li>
                                  </ul>
                                </div>
                              </div>
                            </details>

                            <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                              <input
                                type="checkbox"
                                checked={telestrokeNote.tnkRecommended}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, tnkRecommended: e.target.checked})}
                                className="w-4 h-4"
                              />
                              TNK Recommended
                            </label>

                            {telestrokeNote.tnkRecommended && (
                              <div className="bg-green-50 border border-green-200 rounded-lg p-3 space-y-3">
                                <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.tnkConsentDiscussed}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, tnkConsentDiscussed: e.target.checked})}
                                    className="w-4 h-4"
                                  />
                                  Risks/benefits discussed with patient and family
                                </label>
                                {telestrokeNote.tnkConsentDiscussed && (
                                  <div className="bg-white border border-purple-200 rounded-lg p-3 space-y-2">
                                    <p className="text-sm text-gray-700">
                                      We recommend a medication called Tenecteplase (TNK), which is a "clot-buster" drug. TNK reduces the risk of being disabled; people who get TNK have an improved chance of recovering without disability than people who don't get the medication. All medications have risks – the main risk is bleeding, up to 4% of people develop bleeding in the brain that leads to new symptoms. Very rarely, people have an allergic reaction. The potential benefits are thought to be higher than the potential risks and we recommend TNK is administered. Time is very important here - the sooner the treatment is started, the higher the likelihood of benefit.
                                    </p>

                                    <div className="mt-3 space-y-2">
                                      <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                        <input
                                          type="checkbox"
                                          checked={telestrokeNote.patientFamilyConsent}
                                          onChange={(e) => setTelestrokeNote({...telestrokeNote, patientFamilyConsent: e.target.checked})}
                                          className="w-4 h-4"
                                        />
                                        Patient/family provides consent
                                      </label>
                                      <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                        <input
                                          type="checkbox"
                                          checked={telestrokeNote.presumedConsent}
                                          onChange={(e) => setTelestrokeNote({...telestrokeNote, presumedConsent: e.target.checked})}
                                          className="w-4 h-4"
                                        />
                                        Presumed consent
                                      </label>
                                      <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                        <input
                                          type="checkbox"
                                          checked={telestrokeNote.preTNKSafetyPause}
                                          onChange={(e) => setTelestrokeNote({...telestrokeNote, preTNKSafetyPause: e.target.checked})}
                                          className="w-4 h-4"
                                        />
                                        Pre-TNK safety pause completed
                                      </label>
                                    </div>
                                  </div>
                                )}
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">TNK Administration Time</label>
                                  <input
                                    type="time"
                                    value={telestrokeNote.tnkAdminTime}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, tnkAdminTime: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                              </div>
                            )}

                            {/* EVT Eligibility (Collapsible) */}
                            <details className="bg-blue-50 border border-blue-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg">
                                🔧 EVT Eligibility Criteria (Click to expand)
                              </summary>
                              <div className="p-4 space-y-3 text-sm">
                                <div>
                                  <h4 className="font-semibold text-blue-700 mb-2">Basilar Artery Occlusion:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Last known well ≤24 hours</li>
                                    <li>• NIHSS score ≥10</li>
                                    <li>• pc-ASPECTS ≥6</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-green-700 mb-2">Anterior Circulation Large Vessel Occlusion:</h4>
                                  <p className="text-xs text-gray-600 mb-2">Trial evidence principally supports efficacy among adults ≥60 years of age, baseline mRS 0-1, NIHSS≥6 with disabling symptoms</p>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                                    <div className="bg-white p-2 rounded border">
                                      <p className="font-semibold text-green-700 text-xs mb-1">Early Window (0-6h):</p>
                                      <ul className="space-y-1 ml-2 text-xs">
                                        <li>• ASPECTS 3-10: Generally eligible for EVT</li>
                                        <li>• ASPECTS 0-2: Consider in very select cases; Consider CTP to evaluate if estimated core volume is &lt;70-100cc</li>
                                      </ul>
                                    </div>
                                    <div className="bg-white p-2 rounded border">
                                      <p className="font-semibold text-purple-700 text-xs mb-1">Late Window (6-24h):</p>
                                      <ul className="space-y-1 ml-2 text-xs">
                                        <li>• ASPECTS 6-10: Generally eligible for EVT</li>
                                        <li>• ASPECTS 3-5: Generally eligible; Consider CTP to evaluate if estimated core volume is ≤100cc + mismatch is present</li>
                                        <li>• ASPECTS 0-2: EVT benefit is unclear</li>
                                      </ul>
                                    </div>
                                  </div>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-orange-700 mb-2">Medium Vessel Occlusion:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Consider in select cases of proximal or dominant M2 segment MCA occlusion within ≤1cm of bifurcation in horizontal segment when there is evidence of salvageable tissue + last known well is ≤24 hours</li>
                                    <li>• Not recommended for M2-M4 MCA, ACA, and PCA occlusions</li>
                                  </ul>
                                </div>
                              </div>
                            </details>

                            <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                              <input
                                type="checkbox"
                                checked={telestrokeNote.evtRecommended}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, evtRecommended: e.target.checked})}
                                className="w-4 h-4"
                              />
                              EVT Recommended
                            </label>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Rationale for Recommendation</label>
                              <textarea
                                value={telestrokeNote.rationale}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, rationale: e.target.value})}
                                placeholder=""
                                rows="3"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Section 7: Recommendations */}
                        <div className="bg-white border-2 border-teal-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-teal-900">7. Recommendations</h3>
                            <i data-lucide="clipboard-check" className="w-5 h-5 text-teal-600"></i>
                          </div>
                          <div>
                            <textarea
                              value={telestrokeNote.recommendationsText}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, recommendationsText: e.target.value})}
                              placeholder=""
                              rows="6"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>

                        {/* Telestroke Section */}
                        <div className="bg-gray-50 border border-gray-300 rounded-lg p-4 mt-4">
                          <h3 className="text-lg font-semibold text-gray-800 mb-4">Telestroke</h3>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            {/* OSH Transfer */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">OSH Transfer:</h4>
                              <ul className="text-sm space-y-1">
                                <li>• BP treatment target</li>
                                <li>• AP tx (IS)</li>
                                <li>• Type of transport</li>
                                <li>• ETA</li>
                                <li>• Inform ER/NCCS about acute medical complications or comorbidities, intubation, hemodynamic instability, continuous infusions, and imaging planned on arrival</li>
                              </ul>
                            </div>

                            {/* TNK risk/benefit discussion documentation */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">TNK risk/benefit discussion documentation:</h4>
                              <p className="text-sm">After ensuring that there were no evident contraindications, TNK administration was recommended. Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the OSH provider and patient/family prior to initiating treatment.</p>
                            </div>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Post-IV TNK/tPA recommendations */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">Post-IV TNK/tPA recommendations:</h4>
                              <ul className="text-sm space-y-1">
                                <li>• Admit to ICU</li>
                                <li>• q1hour neurochecks and VS monitoring</li>
                                <li>• NO antithrombotics/anticoagulants for 24 hour after IV-tPA</li>
                                <li>• Maintain BP&lt;180/105 for 24 hours after IV-tPA</li>
                                <li>• HCT 24 hours post-tPA administration</li>
                                <li>• MRI Brain with diffusion weighted imaging</li>
                                <li>• EKG/telemetry</li>
                                <li>• Transthoracic echocardiogram</li>
                                <li>• Fasting lipid panel, HgA1c</li>
                                <li>• PT/OT/SLP evaluations</li>
                                <li>• SCDs for DVT ppx</li>
                                <li>• Inpatient neurology consultation for further diagnostic evaluation and management</li>
                              </ul>
                            </div>

                            {/* MT risk/benefit discussion */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">MT risk/benefit discussion:</h4>
                              <p className="text-sm">Given the presence of a large vascular occlusion, disabling neurological symptoms, and no evident contraindications - the patient will be transferred to HMC for mechanical thrombectomy consideration. Potential benefits, potential risks, and alternatives to treatment were discussed with the OSH provider and patient/family; the neuro-IR team at HMC will obtain informed consent from the patient/family.</p>
                            </div>
                          </div>
                        </div>

                        {/* Emergency Contacts */}
                        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
                          <h3 className="text-lg font-semibold text-red-800 mb-3">🚨 Emergency Contacts</h3>

                          <div className="space-y-4">
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-red-700 mb-2">Stroke Team</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>Stroke Phone:</strong> 206-744-6789</li>
                                <li><strong>STAT Pharmacy:</strong> 4-2241</li>
                                <li><strong>Paging Operator:</strong> 4-0147</li>
                              </ul>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-blue-700 mb-2">Neuroradiology</h4>
                              <div className="text-sm space-y-2">
                                <div>
                                  <p className="font-semibold text-gray-700">HMC Neuro Radiology:</p>
                                  <ul className="ml-3 space-y-1">
                                    <li><strong>HMC Stroke RAD HOTLINE</strong> (0800-1700 weekdays only): (206) 744-8484</li>
                                    <li><strong>Non-urgent:</strong> HMC RAD Reading Room for All: (206) 744-6741</li>
                                  </ul>
                                </div>
                                <div>
                                  <p className="font-semibold text-gray-700">UW Montlake:</p>
                                  <ul className="ml-3 space-y-1">
                                    <li><strong>UW Reading Room Coordinator</strong> (Days 0800-1700): (206) 597-4249</li>
                                    <li><strong>UW Neuro Rad Fellow</strong> (Days 0700-1900): (206) 598-7959</li>
                                    <li><strong>UW Neuro Rad Resident</strong> (Evenings 1700-0700): (206) 598-2068</li>
                                  </ul>
                                </div>
                              </div>
                            </div>
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-green-700 mb-2">Imaging</h4>
                              <ul className="text-sm space-y-1">
                                <li><strong>Non-code STAT CT:</strong> 4-7290</li>
                                <li><strong>Non-code STAT MRI:</strong> 4-2460</li>
                                <li><strong>Angio Suites:</strong> 4-3381, 4-6506</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        {/* Section 8: Pulsara Summary */}
                        <div className="bg-white border-2 border-indigo-300 rounded-lg p-4 shadow-md mt-4">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-indigo-900">8. Pulsara Summary</h3>
                            <i data-lucide="clipboard" className="w-5 h-5 text-indigo-600"></i>
                          </div>

                          {/* Auto-Generated Summary */}
                          <div className="mt-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div className="flex items-center justify-between mb-2">
                              <h4 className="font-semibold text-gray-800 text-sm">Pulsara Summary:</h4>
                              <button
                                onClick={() => {
                                  const age = telestrokeNote.age || "[Age]";
                                  const sexRaw = telestrokeNote.sex;
                                  const sex = sexRaw === 'M' ? 'male' : sexRaw === 'F' ? 'female' : '[sex]';
                                  const pmh = telestrokeNote.pmh || "no PMH";
                                  const symptoms = telestrokeNote.symptoms || "[symptoms]";
                                  const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : "[time]";
                                  const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : "[date]";
                                  const nihss = telestrokeNote.nihss || nihssScore || "[score]";
                                  const nihssDeficits = telestrokeNote.nihssDetails ? ` (${telestrokeNote.nihssDetails})` : "";
                                  const ctResults = telestrokeNote.ctResults || "[CT findings]";
                                  const ctaResults = telestrokeNote.ctaResults || "[CTA findings]";
                                  const ctpResults = telestrokeNote.ctpResults || "N/A";
                                  const aspectsStr = aspectsScore ? ` ASPECTS: ${aspectsScore}.` : "";
                                  const tnkStatus = telestrokeNote.tnkRecommended ? "Recommended" : "Not Recommended";
                                  const evtStatus = telestrokeNote.evtRecommended ? "Recommended" : "Not Recommended";
                                  const rationale = telestrokeNote.rationale || "[rationale]";

                                  const summary = `${age} year old ${sex} with ${pmh} who presents with ${symptoms}. Last known well is ${lkw} ${lkwDate}. NIHSS score: ${nihss}${nihssDeficits}. Head CT: ${ctResults}.${aspectsStr} CTA Head/Neck: ${ctaResults}. CTP: ${ctpResults}. TNK Treatment: ${tnkStatus}. EVT: ${evtStatus}. Rationale for Treatment Recommendation: ${rationale}.`;
                                  navigator.clipboard.writeText(summary);
                                  setCopiedText('pulsara-summary');
                                  setTimeout(() => setCopiedText(''), 2000);
                                }}
                                className="flex items-center gap-2 px-3 py-1 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700 transition-colors"
                              >
                                <i data-lucide={copiedText === 'pulsara-summary' ? 'check' : 'copy'} className="w-3 h-3"></i>
                                {copiedText === 'pulsara-summary' ? 'Copied!' : 'Copy'}
                              </button>
                            </div>
                            <p className="text-xs text-gray-700 whitespace-pre-wrap">
                              {(() => {
                                const age = telestrokeNote.age || "[Age]";
                                const sexRaw = telestrokeNote.sex;
                                const sex = sexRaw === 'M' ? 'male' : sexRaw === 'F' ? 'female' : '[sex]';
                                const pmh = telestrokeNote.pmh || "no PMH";
                                const symptoms = telestrokeNote.symptoms || "[symptoms]";
                                const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : "[time]";
                                const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : "[date]";
                                const nihss = telestrokeNote.nihss || nihssScore || "[score]";
                                const nihssDeficits = telestrokeNote.nihssDetails ? ` (${telestrokeNote.nihssDetails})` : "";
                                const ctResults = telestrokeNote.ctResults || "[CT findings]";
                                const ctaResults = telestrokeNote.ctaResults || "[CTA findings]";
                                const ctpResults = telestrokeNote.ctpResults || "N/A";
                                const aspectsStr = aspectsScore ? ` ASPECTS: ${aspectsScore}.` : "";
                                const tnkStatus = telestrokeNote.tnkRecommended ? "Recommended" : "Not Recommended";
                                const evtStatus = telestrokeNote.evtRecommended ? "Recommended" : "Not Recommended";
                                const rationale = telestrokeNote.rationale || "[rationale]";

                                return `${age} year old ${sex} with ${pmh} who presents with ${symptoms}. Last known well is ${lkw} ${lkwDate}. NIHSS score: ${nihss}${nihssDeficits}. Head CT: ${ctResults}.${aspectsStr} CTA Head/Neck: ${ctaResults}. CTP: ${ctpResults}. TNK Treatment: ${tnkStatus}. EVT: ${evtStatus}. Rationale for Treatment Recommendation: ${rationale}.`;
                              })()}
                            </p>
                          </div>
                        </div>

                        {/* Telestroke Note - Epic */}
                        <div className="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 shadow-md mt-4">
                          <div className="flex items-center justify-between mb-3">
                            <h4 className="font-bold text-gray-800 flex items-center gap-2">
                              <i data-lucide="file-text" className="w-5 h-5"></i>
                              Telestroke Note - Epic
                            </h4>
                            <div className="flex gap-2">
                              <button
                                onClick={() => setShowTemplateEditor(!showTemplateEditor)}
                                className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors"
                              >
                                <i data-lucide={showTemplateEditor ? 'eye-off' : 'edit'} className="w-4 h-4"></i>
                                {showTemplateEditor ? 'Hide Editor' : 'Edit Template'}
                              </button>
                              <button
                                onClick={() => {
                                  const note = generateTelestrokeNote();
                                  navigator.clipboard.writeText(note);
                                  setCopiedText('encounter-note');
                                  setTimeout(() => setCopiedText(''), 2000);
                                }}
                                className="flex items-center gap-2 px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors"
                              >
                                <i data-lucide={copiedText === 'encounter-note' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                {copiedText === 'encounter-note' ? 'Copied!' : 'Copy'}
                              </button>
                            </div>
                          </div>

                          {/* Template Editor */}
                          {showTemplateEditor && (
                            <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                              <div className="flex items-center justify-between mb-2">
                                <h5 className="font-semibold text-yellow-900">Edit Template</h5>
                                <button
                                  onClick={() => {
                                    if (confirm('Reset to default template? This will lose any customizations.')) {
                                      setEditableTemplate(`Chief complaint: {chiefComplaint}
Last known well (date/time): {lkwDate} {lkwTime}
HPI: {age} year old {sex} p/w {symptoms} at {lkwTime}
Relevant PMH: {pmh}
Medications: {medications}

Objective:
Vitals:
Presenting BP {presentingBP}
Blood pressure: BP prior to TNK administration: {bpPreTNK} at {bpPreTNKTime}
Labs: Glucose {glucose}
Exam: Scores: NIHSS {nihss} - {nihssDetails}

Imaging: I personally reviewed imaging
Date/time Non-contrast Head CT reviewed: {ctTime}; Non-contrast Head CT Results: {ctResults}
Date/time CTA reviewed: {ctaDate} {ctaTime}; CTA Results: {ctaResults}
Telemetry/EKG: {ekgResults}

Assessment and Plan:
Suspected Diagnosis: {diagnosis}
After ensuring that there were no evident contraindications, TNK administration was recommended at {tnkAdminTime}. Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the patient, patient's wife, and OSH provider. Both the patient and his wife expressed agreement with the recommendation.
TNK was administered at {tnkAdminTime} after a brief time-out.

Recommendations:
{recommendationsText}

Rizwan Kalani MD`);
                                    }
                                  }}
                                  className="text-xs px-2 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700"
                                >
                                  Reset to Default
                                </button>
                              </div>
                              <p className="text-xs text-yellow-800 mb-2">
                                Use placeholders like {'{chiefComplaint}'}, {'{age}'}, {'{sex}'}, etc. Changes save automatically.
                              </p>
                              <textarea
                                value={editableTemplate}
                                onChange={(e) => setEditableTemplate(e.target.value)}
                                className="w-full h-96 px-3 py-2 border border-yellow-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-yellow-500 focus:outline-none"
                                spellCheck="false"
                              />
                            </div>
                          )}

                          <div className="bg-white p-3 rounded border border-gray-200 max-h-96 overflow-y-auto">
                            <pre className="whitespace-pre-wrap text-xs text-gray-800 font-mono">
                              {generateTelestrokeNote()}
                            </pre>
                          </div>
                        </div>

                      </div>

                      {/* RIGHT COLUMN - Live Preview & Tools (1/3 width on desktop, full width on mobile) */}
                      <div className="lg:col-span-1 space-y-4">

                        {/* Time from LKW (Sticky on desktop) */}
                        <div className="bg-gradient-to-br from-red-500 to-orange-500 text-white rounded-lg p-4 shadow-lg lg:sticky lg:top-4 z-30">
                          <div className="text-center">
                            <p className="text-sm font-medium opacity-90">Time from LKW</p>
                            <p className="text-4xl font-bold mt-1">
                              {(() => {
                                const timeCalc = calculateTimeFromLKW();
                                return timeCalc ? `${timeCalc.hours}h ${timeCalc.minutes}m` : '--:--';
                              })()}
                            </p>
                            <p className="text-xs mt-2 opacity-75">
                              {lkwTime ? new Date(lkwTime).toLocaleString() : 'Set LKW time'}
                            </p>
                          </div>
                        </div>

                        {/* Treatment Window Countdown */}
                        {(() => {
                          const timeFromLKW = calculateTimeFromLKW();
                          if (!timeFromLKW) return null;

                          const totalHours = timeFromLKW.total;
                          const tnkRemaining = 4.5 - totalHours;
                          const evtEarlyRemaining = 6 - totalHours;
                          const evtLateRemaining = 24 - totalHours;

                          return (
                            <div className="bg-white p-4 rounded-lg shadow-md border-2 border-blue-300 lg:sticky lg:top-40 z-30">
                              <div className="flex items-center justify-between mb-3">
                                <h4 className="font-bold text-lg text-blue-900 flex items-center gap-2">
                                  <i data-lucide="clock" className="w-5 h-5"></i>
                                  Treatment Window Countdown
                                </h4>
                              </div>

                              <div className="space-y-3">
                                {/* TNK Window */}
                                <div className={`p-3 rounded-lg border-2 ${
                                  tnkRemaining > 1 ? 'bg-green-50 border-green-500' :
                                  tnkRemaining > 0 ? 'bg-yellow-50 border-yellow-500' :
                                  'bg-gray-50 border-gray-400'
                                } ${tnkRemaining > 0 && tnkRemaining < 0.5 ? 'animate-pulse' : ''}`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                      <span className="font-semibold text-sm">
                                        {tnkRemaining > 0 ? '💉 TNK' : '⏱️ TNK Closed'}
                                      </span>
                                    </div>
                                    {tnkRemaining > 0 && (
                                      <span className={`font-bold text-lg ${
                                        tnkRemaining < 0.5 ? 'text-red-600' : tnkRemaining < 1 ? 'text-yellow-600' : 'text-green-600'
                                      }`}>
                                        {Math.floor(tnkRemaining)} hrs {Math.floor((tnkRemaining % 1) * 60)} min
                                      </span>
                                    )}
                                    {tnkRemaining <= 0 && (
                                      <span className="text-gray-600 text-xs font-semibold">
                                        -{Math.floor(Math.abs(tnkRemaining))} hrs {Math.floor((Math.abs(tnkRemaining) % 1) * 60)} min
                                      </span>
                                    )}
                                  </div>
                                  {/* Progress Bar */}
                                  <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div
                                      className={`h-2 rounded-full transition-all ${
                                        tnkRemaining > 1 ? 'bg-green-500' :
                                        tnkRemaining > 0 ? 'bg-yellow-500' :
                                        'bg-gray-400'
                                      }`}
                                      style={{ width: `${Math.max(0, Math.min(100, (totalHours / 4.5) * 100))}%` }}
                                    ></div>
                                  </div>
                                  <p className="text-xs mt-1 text-gray-600">0-4.5h from LKW</p>
                                </div>

                                {/* Early EVT Window (0-6h) */}
                                <div className={`p-3 rounded-lg border-2 ${
                                  evtEarlyRemaining > 1 ? 'bg-blue-50 border-blue-500' :
                                  evtEarlyRemaining > 0 ? 'bg-yellow-50 border-yellow-500' :
                                  'bg-gray-50 border-gray-400'
                                } ${evtEarlyRemaining > 0 && evtEarlyRemaining < 0.5 ? 'animate-pulse' : ''}`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                      <span className="font-semibold text-sm">
                                        {evtEarlyRemaining > 0 ? '🧠 EVT (Early)' : '⏱️ Early EVT Closed'}
                                      </span>
                                    </div>
                                    {evtEarlyRemaining > 0 && (
                                      <span className={`font-bold text-lg ${
                                        evtEarlyRemaining < 0.5 ? 'text-red-600' : evtEarlyRemaining < 1 ? 'text-yellow-600' : 'text-blue-600'
                                      }`}>
                                        {Math.floor(evtEarlyRemaining)} hrs {Math.floor((evtEarlyRemaining % 1) * 60)} min
                                      </span>
                                    )}
                                    {evtEarlyRemaining <= 0 && (
                                      <span className="text-gray-600 text-xs font-semibold">
                                        -{Math.floor(Math.abs(evtEarlyRemaining))} hrs {Math.floor((Math.abs(evtEarlyRemaining) % 1) * 60)} min
                                      </span>
                                    )}
                                  </div>
                                  {/* Progress Bar */}
                                  <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div
                                      className={`h-2 rounded-full transition-all ${
                                        evtEarlyRemaining > 1 ? 'bg-blue-500' :
                                        evtEarlyRemaining > 0 ? 'bg-yellow-500' :
                                        'bg-gray-400'
                                      }`}
                                      style={{ width: `${Math.max(0, Math.min(100, (totalHours / 6) * 100))}%` }}
                                    ></div>
                                  </div>
                                  <p className="text-xs mt-1 text-gray-600">0-6h (no advanced imaging)</p>
                                </div>

                                {/* Late EVT Window (6-24h) */}
                                {totalHours >= 6 && (
                                  <div className={`p-3 rounded-lg border-2 ${
                                    evtLateRemaining > 0 ? 'bg-purple-50 border-purple-500' : 'bg-gray-50 border-gray-400'
                                  }`}>
                                    <div className="flex items-center justify-between mb-2">
                                      <div className="flex items-center gap-2">
                                        <span className="font-semibold text-sm">
                                          {evtLateRemaining > 0 ? '🧠 EVT (Late)' : '⏱️ EVT Closed'}
                                        </span>
                                      </div>
                                      {evtLateRemaining > 0 && (
                                        <span className="font-bold text-lg text-purple-600">
                                          {Math.floor(evtLateRemaining)} hrs {Math.floor((evtLateRemaining % 1) * 60)} min
                                        </span>
                                      )}
                                      {evtLateRemaining <= 0 && (
                                        <span className="text-gray-600 text-xs font-semibold">All closed</span>
                                      )}
                                    </div>
                                    {/* Progress Bar */}
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                      <div
                                        className={`h-2 rounded-full transition-all ${
                                          evtLateRemaining > 0 ? 'bg-purple-500' : 'bg-gray-400'
                                        }`}
                                        style={{ width: `${Math.max(0, Math.min(100, (totalHours / 24) * 100))}%` }}
                                      ></div>
                                    </div>
                                    <p className="text-xs mt-1 text-gray-600">6-24h (perfusion required)</p>
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })()}

                      </div>


                    </div>
                  </div>
                )}
                {/* Workflow */}




                {/* ICH */}
                {activeTab === 'ich' && (
                  <div className="space-y-6">
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <h2 className="text-xl font-semibold text-red-800 mb-4">ICH Management</h2>
                      
                      {/* Minimally Invasive Evacuation */}
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 className="text-lg font-semibold text-blue-800 mb-3">Minimally Invasive Evacuation (MIE)</h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <div className="bg-white p-3 rounded border">
                            <h4 className="font-semibold text-green-600 mb-2">ENRICH Trial Inclusion</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Spontaneous supratentorial lobar ICH</li>
                              <li>• ICH onset ≤24 hours</li>
                              <li>• Age 18-80 years</li>
                              <li>• GCS 5-14 and NIHSS ≥6</li>
                              <li>• ICH volume 30-80 cc</li>
                              <li>• Pre-morbid mRS 0-1</li>
                            </ul>
                          </div>
                          
                          <div className="bg-white p-3 rounded border">
                            <h4 className="font-semibold text-red-600 mb-2">ENRICH Trial Exclusion</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Coagulopathy</li>
                              <li>• IVH &gt;50% either lateral ventricle</li>
                              <li>• Thalamic/infratentorial ICH</li>
                            </ul>
                          </div>
                        </div>

                        <div className="bg-gray-100 p-3 rounded">
                          <p className="text-sm font-semibold mb-2">ICH Volume Calculation:</p>
                          <p className="text-sm"><strong>ABC/2 Method:</strong></p>
                          <ul className="text-sm ml-4">
                            <li>A = largest ICH diameter (cm)</li>
                            <li>B = largest diameter 90 degrees to A on same slice (cm)</li>
                            <li>C = (# CT slices with ICH) x (slice thickness)</li>
                          </ul>
                          <p className="text-sm mt-2 font-semibold">Volume = A x B x C / 2</p>
                        </div>
                      </div>

                      {/* Anticoagulation Reversal */}
                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">Anticoagulation Reversal</h3>
                        
                        {/* Warfarin */}
                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-blue-700 mb-3">Warfarin</h4>
                          <ul className="text-sm space-y-1">
                            <li>• <strong>Vitamin K:</strong> 10 mg IV over 20 min</li>
                            <li>• <strong>PCC (KCentra):</strong> 2000 U IV</li>
                          </ul>
                        </div>

                        {/* Direct Oral Anticoagulants (DOACs) */}
                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-purple-700 mb-3">Direct Oral Anticoagulants (DOACs)</h4>
                          
                          <div className="mb-3">
                            <p className="text-sm font-semibold text-gray-700">Direct Factor Xa Inhibitors:</p>
                            <p className="text-sm text-gray-600 mb-2">Apixaban, Rivaroxaban, Edoxaban</p>
                            <ul className="text-sm space-y-1">
                              <li>• <strong>PCC (KCentra):</strong> 50 IU/kg (max 5000 IU)</li>
                            </ul>
                          </div>
                          
                          <div>
                            <p className="text-sm font-semibold text-gray-700">Direct Thrombin Inhibitor:</p>
                            <p className="text-sm text-gray-600 mb-2">Dabigatran</p>
                            <ul className="text-sm space-y-1">
                              <li>• <strong>Idarucizumab (Praxbind):</strong> 5g IV (2 x 2.5g)</li>
                              <li>• <strong>If unavailable:</strong> PCC (KCentra)</li>
                            </ul>
                          </div>
                        </div>

                        {/* Relative Contraindications */}
                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-gray-700 mb-3">Relative contraindications to PCC/FFP:</h4>
                          <ul className="text-sm space-y-1">
                            <li>• History of major thrombosis/thromboembolism ≤6 weeks</li>
                            <li>• Major surgery ≤6 weeks</li>
                            <li>• Known prothrombotic disorder</li>
                            <li>• IPH not considered survivable</li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Trials */}
                                {activeTab === 'trials' && (
                  <div className="space-y-6">
                    {/* Header Section */}
                    <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                      <h1 className="text-3xl font-bold">Stroke Trials and Studies</h1>
                    </div>

                    {/* Trial Category Filter Buttons */}
                    <div className="flex flex-wrap gap-2 mb-6">
                      {Object.keys(trialsData).map(category => {
                        const categoryData = trialsData[category];
                        const trialCount = categoryData.hasSubsections 
                          ? Object.values(categoryData.subsections).reduce((acc, sub) => acc + sub.trials.length, 0)
                          : categoryData.trials.length;
                        
                        const getCategoryColor = (cat) => {
                          switch(cat) {
                            case 'ischemic': return 'bg-blue-600 hover:bg-blue-700';
                            case 'ich': return 'bg-red-600 hover:bg-red-700';
                            case 'rehab': return 'bg-green-600 hover:bg-green-700';
                            case 'cadasil': return 'bg-purple-600 hover:bg-purple-700';
                            default: return 'bg-gray-600 hover:bg-gray-700';
                          }
                        };
                        
                        const getCategoryName = (cat) => {
                          switch(cat) {
                            case 'ischemic': return 'Ischemic Stroke';
                            case 'ich': return 'Intracerebral Hemorrhage';
                            case 'rehab': return 'Rehabilitation';
                            case 'cadasil': return 'CADASIL';
                            default: return categoryData.title;
                          }
                        };
                        
                        return (
                          <button
                            key={category}
                            onClick={() => setTrialsCategory(category)}
                            className={`px-4 py-2 rounded-full font-medium transition-all ${
                              trialsCategory === category
                                ? `${getCategoryColor(category)} text-white shadow-lg`
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                          >
                            {getCategoryName(category)} ({trialCount})
                          </button>
                        );
                      })}
                    </div>
                    
                    {/* Trial Cards */}
                    <div className="space-y-4">
                      {(() => {
                        const categoryData = trialsData[trialsCategory];
                        return (
                          <div className="space-y-4">
                            <h2 className="text-2xl font-bold text-gray-800 border-b-2 border-gray-300 pb-2">
                              {categoryData.title}
                            </h2>
                            {categoryData.hasSubsections ? (
                              Object.entries(categoryData.subsections).map(([subKey, subsection]) => (
                                <div key={subKey} className="space-y-4">
                                  <h3 className="text-xl font-semibold text-gray-700 ml-4">
                                    {subsection.title}
                                  </h3>
                                  {subsection.trials.map((trial, index) => (
                                    <TrialCard key={index} trial={trial} category={trialsCategory} />
                                  ))}
                                </div>
                              ))
                            ) : (
                              categoryData.trials.map((trial, index) => (
                                <TrialCard key={index} trial={trial} category={trialsCategory} />
                              ))
                            )}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}

                {/* Risk Calculators */}
                {activeTab === 'calculators' && (
                  <div className="space-y-6">
                    {/* Glasgow Coma Scale */}
                    <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-gray-800 mb-3">
                        <Tooltip text="Glasgow Coma Scale - assesses level of consciousness based on eye, verbal, and motor responses">
                          Glasgow Coma Scale (GCS)
                        </Tooltip>
                      </h3>

                      <div className="flex justify-end items-center gap-2 mb-4">
                        <div className="text-right">
                          <span className="text-2xl font-bold text-gray-600">Total Score: {calculateGCS(gcsItems)}</span>
                          <div className="text-sm text-gray-500">Range: 3-15</div>
                        </div>
                        <button
                          onClick={() => copyToClipboard(`GCS: ${calculateGCS(gcsItems)}`, 'GCS Score')}
                          className="p-2 hover:bg-gray-100 rounded transition-colors"
                          aria-label="Copy GCS score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-5 h-5 text-gray-600"></i>
                        </button>
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div className="space-y-2">
                          <h4 className="font-semibold">Eye Opening</h4>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_eye" 
                              value="4" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, eye: e.target.value})}
                            />
                            <span className="text-sm">4 - Spontaneous</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_eye" 
                              value="3" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, eye: e.target.value})}
                            />
                            <span className="text-sm">3 - To sound</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_eye" 
                              value="2" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, eye: e.target.value})}
                            />
                            <span className="text-sm">2 - To pain</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_eye" 
                              value="1" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, eye: e.target.value})}
                            />
                            <span className="text-sm">1 - None</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <h4 className="font-semibold">Verbal Response</h4>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_verbal" 
                              value="5" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">5 - Oriented</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_verbal" 
                              value="4" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">4 - Confused</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_verbal" 
                              value="3" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">3 - Inappropriate</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_verbal" 
                              value="2" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">2 - Incomprehensible</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_verbal" 
                              value="1" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">1 - None</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <h4 className="font-semibold">Motor Response</h4>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_motor" 
                              value="6" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">6 - Obeying</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_motor" 
                              value="5" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">5 - Localizing</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_motor" 
                              value="4" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">4 - Flexing</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_motor" 
                              value="3" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">3 - Abnormal flexion</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_motor" 
                              value="2" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">2 - Extending</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="radio" 
                              name="gcs_motor" 
                              value="1" 
                              className="text-gray-600"
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">1 - None</span>
                          </label>
                        </div>
                      </div>
                    </div>

                    {/* ICH Score */}
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-red-800 mb-3">
                        <Tooltip text="Intracerebral Hemorrhage Score - predicts 30-day mortality after ICH">
                          ICH Score
                        </Tooltip>
                      </h3>

                      <div className="flex justify-end items-center gap-2 mb-4">
                        <span className="text-2xl font-bold text-red-600">Total Score: {calculateICHScore(ichScoreItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`ICH Score: ${calculateICHScore(ichScoreItems)}`, 'ICH Score')}
                          className="p-2 hover:bg-red-100 rounded transition-colors"
                          aria-label="Copy ICH score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-5 h-5 text-red-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div className="space-y-2">
                          <p className="font-semibold text-sm mb-2">Glasgow Coma Scale:</p>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="ich_gcs"
                              className="text-red-600"
                              checked={ichScoreItems.gcs === 'gcs34'}
                              onChange={() => setIchScoreItems({...ichScoreItems, gcs: 'gcs34'})}
                            />
                            <span className="text-sm">GCS 3-4 (+2 points)</span>
                          </label>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="ich_gcs"
                              className="text-red-600"
                              checked={ichScoreItems.gcs === 'gcs512'}
                              onChange={() => setIchScoreItems({...ichScoreItems, gcs: 'gcs512'})}
                            />
                            <span className="text-sm">GCS 5-12 (+1 point)</span>
                          </label>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="ich_gcs"
                              className="text-red-600"
                              checked={ichScoreItems.gcs === ''}
                              onChange={() => setIchScoreItems({...ichScoreItems, gcs: ''})}
                            />
                            <span className="text-sm">GCS 13-15 (0 points)</span>
                          </label>
                          <hr className="my-3" />
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.age80}
                              onChange={(e) => setIchScoreItems({...ichScoreItems, age80: e.target.checked})}
                            />
                            <span className="text-sm">Age ≥80 (+1)</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.volume30}
                              onChange={(e) => setIchScoreItems({...ichScoreItems, volume30: e.target.checked})}
                            />
                            <span className="text-sm">ICH volume ≥30 cc (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.ivh}
                              onChange={(e) => setIchScoreItems({...ichScoreItems, ivh: e.target.checked})}
                            />
                            <span className="text-sm">Intraventricular hemorrhage (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.infratentorial}
                              onChange={(e) => setIchScoreItems({...ichScoreItems, infratentorial: e.target.checked})}
                            />
                            <span className="text-sm">Infratentorial origin (+1)</span>
                          </label>
                        </div>
                      </div>
                    </div>

                    {/* ABCD2 */}
                    <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-orange-800 mb-3">
                        <Tooltip text="ABCD² Score - predicts stroke risk after TIA">
                          ABCD² Score
                        </Tooltip>
                      </h3>

                      <div className="flex justify-end items-center gap-2 mb-4">
                        <span className="text-2xl font-bold text-orange-600">Total Score: {calculateABCD2Score(abcd2Items)}</span>
                        <button
                          onClick={() => copyToClipboard(`ABCD² Score: ${calculateABCD2Score(abcd2Items)}`, 'ABCD² Score')}
                          className="p-2 hover:bg-orange-100 rounded transition-colors"
                          aria-label="Copy ABCD² score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-5 h-5 text-orange-600"></i>
                        </button>
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.age60}
                              onChange={(e) => setAbcd2Items({...abcd2Items, age60: e.target.checked})}
                            />
                            <span className="text-sm">Age ≥60 (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.bp}
                              onChange={(e) => setAbcd2Items({...abcd2Items, bp: e.target.checked})}
                            />
                            <span className="text-sm">BP: SBP≥140 or DBP≥90 (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.unilateralWeakness}
                              onChange={(e) => setAbcd2Items({...abcd2Items, unilateralWeakness: e.target.checked})}
                            />
                            <span className="text-sm">Unilateral weakness (+2)</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              className="text-orange-600"
                              checked={abcd2Items.speechDisturbance}
                              onChange={(e) => setAbcd2Items({...abcd2Items, speechDisturbance: e.target.checked})}
                            />
                            <span className="text-sm">Speech disturbance w/o weakness (+1)</span>
                          </label>
                          <p className="font-semibold text-sm mt-3 mb-2">Symptom Duration:</p>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="abcd2_duration"
                              className="text-orange-600"
                              checked={abcd2Items.duration === 'duration60'}
                              onChange={() => setAbcd2Items({...abcd2Items, duration: 'duration60'})}
                            />
                            <span className="text-sm">≥60 minutes (+2 points)</span>
                          </label>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="abcd2_duration"
                              className="text-orange-600"
                              checked={abcd2Items.duration === 'duration10'}
                              onChange={() => setAbcd2Items({...abcd2Items, duration: 'duration10'})}
                            />
                            <span className="text-sm">10-59 minutes (+1 point)</span>
                          </label>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="abcd2_duration"
                              className="text-orange-600"
                              checked={abcd2Items.duration === ''}
                              onChange={() => setAbcd2Items({...abcd2Items, duration: ''})}
                            />
                            <span className="text-sm">&lt;10 minutes (0 points)</span>
                          </label>
                          <hr className="my-3" />
                          <label className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              className="text-orange-600"
                              checked={abcd2Items.diabetes}
                              onChange={(e) => setAbcd2Items({...abcd2Items, diabetes: e.target.checked})}
                            />
                            <span className="text-sm">Diabetes mellitus (+1)</span>
                          </label>
                        </div>
                      </div>

                      <div className="bg-white p-3 rounded border">
                        <h4 className="font-semibold mb-2">2-Day, 7-Day, and 90-Day Stroke Risk</h4>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                          <div>
                            <p><strong>0-3:</strong></p>
                            <p>2-day: 1%</p>
                            <p>7-day: 1.2%</p>
                            <p>90-day: 3.1%</p>
                          </div>
                          <div>
                            <p><strong>4-5:</strong></p>
                            <p>2-day: 4.1%</p>
                            <p>7-day: 5.9%</p>
                            <p>90-day: 9.8%</p>
                          </div>
                          <div>
                            <p><strong>6-7:</strong></p>
                            <p>2-day: 8.1%</p>
                            <p>7-day: 11.7%</p>
                            <p>90-day: 17.8%</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* CHADS2-VASC */}
                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-purple-800 mb-3">
                        <Tooltip text="CHA₂DS₂-VASc Score - predicts stroke risk in atrial fibrillation">
                          CHADS₂-VASc Score
                        </Tooltip>
                      </h3>

                      <div className="flex justify-end items-center gap-2 mb-4">
                        <span className="text-2xl font-bold text-purple-600">Total Score: {calculateCHADS2VascScore(chads2vascItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`CHADS₂-VASc: ${calculateCHADS2VascScore(chads2vascItems)}`, 'CHADS₂-VASc Score')}
                          className="p-2 hover:bg-purple-100 rounded transition-colors"
                          aria-label="Copy CHADS₂-VASc score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-5 h-5 text-purple-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.age65}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, age65: e.target.checked})}
                          />
                          <span className="text-sm">Age 65-74 (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.age75}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, age75: e.target.checked})}
                          />
                          <span className="text-sm">Age ≥75 (+2)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.chf}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, chf: e.target.checked})}
                          />
                          <span className="text-sm">CHF (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.hypertension}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, hypertension: e.target.checked})}
                          />
                          <span className="text-sm">Hypertension (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.diabetes}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, diabetes: e.target.checked})}
                          />
                          <span className="text-sm">Diabetes (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.strokeTia}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, strokeTia: e.target.checked})}
                          />
                          <span className="text-sm">Stroke/TIA (+2)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.vascular}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, vascular: e.target.checked})}
                          />
                          <span className="text-sm">Vascular disease (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.female}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, female: e.target.checked})}
                          />
                          <span className="text-sm">Female sex (+1)</span>
                        </label>
                      </div>
                      
                      <div className="bg-white p-3 rounded border">
                        <h4 className="font-semibold mb-2">Annual Stroke and Thromboembolism Risk</h4>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                          <div>
                            <p><strong>Score 0:</strong> 0.8%</p>
                            <p><strong>Score 1:</strong> 2.0%</p>
                            <p><strong>Score 2:</strong> 3.7%</p>
                          </div>
                          <div>
                            <p><strong>Score 3:</strong> 5.9%</p>
                            <p><strong>Score 4:</strong> 9.3%</p>
                            <p><strong>Score 5:</strong> 15.3%</p>
                          </div>
                          <div>
                            <p><strong>Score 6:</strong> 19.7%</p>
                            <p><strong>Score 7:</strong> 21.5%</p>
                            <p><strong>Score 8:</strong> 22.4%</p>
                            <p><strong>Score 9:</strong> 23.6%</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* ROPE Score */}
                    <div className="bg-teal-50 border border-teal-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-teal-800 mb-3">
                        <Tooltip text="Risk of Paradoxical Embolism Score - estimates likelihood that PFO caused stroke">
                          ROPE Score
                        </Tooltip>
                      </h3>

                      <div className="flex justify-end items-center gap-2 mb-4">
                        <span className="text-2xl font-bold text-teal-600">Total Score: {calculateROPEScore(ropeItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`ROPE Score: ${calculateROPEScore(ropeItems)}`, 'ROPE Score')}
                          className="p-2 hover:bg-teal-100 rounded transition-colors"
                          aria-label="Copy ROPE score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-5 h-5 text-teal-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.noHypertension}
                              onChange={(e) => setRopeItems({...ropeItems, noHypertension: e.target.checked})}
                            />
                            <span className="text-sm">No history of hypertension (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.noDiabetes}
                              onChange={(e) => setRopeItems({...ropeItems, noDiabetes: e.target.checked})}
                            />
                            <span className="text-sm">No history of diabetes (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.noStrokeTia}
                              onChange={(e) => setRopeItems({...ropeItems, noStrokeTia: e.target.checked})}
                            />
                            <span className="text-sm">No history of stroke or TIA (+1)</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.nonsmoker}
                              onChange={(e) => setRopeItems({...ropeItems, nonsmoker: e.target.checked})}
                            />
                            <span className="text-sm">Nonsmoker (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.cortical}
                              onChange={(e) => setRopeItems({...ropeItems, cortical: e.target.checked})}
                            />
                            <span className="text-sm">Cortical infarct (+1)</span>
                          </label>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Age (years)</label>
                            <input 
                              type="number"
                              className="w-full px-3 py-1 border border-gray-300 rounded-md text-sm"
                              value={ropeItems.age}
                              onChange={(e) => setRopeItems({...ropeItems, age: e.target.value})}
                              placeholder="Enter age"
                              min="18"
                              max="100"
                            />
                            <div className="text-xs text-gray-500 mt-1">
                              18-29: +5, 30-39: +4, 40-49: +3, 50-59: +2, 60-69: +1, ≥70: 0
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">PFO-attributable fraction</h4>
                          <div className="text-sm">
                            <p className={calculateROPEScore(ropeItems) <= 3 ? "font-bold text-teal-600" : ""}><strong>Score 0-3:</strong> 0-23%</p>
                            <p className={calculateROPEScore(ropeItems) === 4 ? "font-bold text-teal-600" : ""}><strong>Score 4:</strong> 38%</p>
                            <p className={calculateROPEScore(ropeItems) === 5 ? "font-bold text-teal-600" : ""}><strong>Score 5:</strong> 34%</p>
                            <p className={calculateROPEScore(ropeItems) === 6 ? "font-bold text-teal-600" : ""}><strong>Score 6:</strong> 62%</p>
                            <p className={calculateROPEScore(ropeItems) === 7 ? "font-bold text-teal-600" : ""}><strong>Score 7:</strong> 72%</p>
                            <p className={calculateROPEScore(ropeItems) === 8 ? "font-bold text-teal-600" : ""}><strong>Score 8:</strong> 84%</p>
                            <p className={calculateROPEScore(ropeItems) >= 9 ? "font-bold text-teal-600" : ""}><strong>Score 9-10:</strong> 88%</p>
                          </div>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">2-Year Recurrent Stroke/TIA Risk</h4>
                          <div className="text-sm">
                            <p className={calculateROPEScore(ropeItems) <= 3 ? "font-bold text-teal-600" : ""}><strong>Score 0-3:</strong> 20%</p>
                            <p className={calculateROPEScore(ropeItems) === 4 ? "font-bold text-teal-600" : ""}><strong>Score 4:</strong> 12%</p>
                            <p className={calculateROPEScore(ropeItems) === 5 ? "font-bold text-teal-600" : ""}><strong>Score 5:</strong> 15%</p>
                            <p className={calculateROPEScore(ropeItems) === 6 ? "font-bold text-teal-600" : ""}><strong>Score 6:</strong> 8%</p>
                            <p className={calculateROPEScore(ropeItems) === 7 ? "font-bold text-teal-600" : ""}><strong>Score 7:</strong> 6%</p>
                            <p className={calculateROPEScore(ropeItems) === 8 ? "font-bold text-teal-600" : ""}><strong>Score 8:</strong> 6%</p>
                            <p className={calculateROPEScore(ropeItems) >= 9 ? "font-bold text-teal-600" : ""}><strong>Score 9-10:</strong> 2%</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* PASCAL Classification */}
                    <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-indigo-800 mb-3">PASCAL Classification</h3>
                      
                      <div className="space-y-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-green-700 mb-2">Probable PFO-related stroke:</h4>
                          <p className="text-sm">RoPE ≥7 + high-grade shunt / ASA</p>
                        </div>
                        
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-amber-700 mb-2">Possible PFO-related stroke:</h4>
                          <ul className="text-sm space-y-1">
                            <li>• RoPE &lt;7 + high-grade shunt / ASA</li>
                            <li>• RoPE ≥7 but no high-grade shunt / ASA</li>
                          </ul>
                        </div>
                        
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-red-700 mb-2">Unlikely PFO-related stroke:</h4>
                          <p className="text-sm">RoPE &lt;7, no high-grade shunt / ASA</p>
                        </div>
                      </div>
                    </div>

                    {/* PREVENT 10-year ASCVD Risk */}
                    <div className="bg-rose-50 border border-rose-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-rose-800 mb-3">PREVENT 10-year ASCVD Risk Estimate</h3>
                      <div className="bg-white p-4 rounded border">
                        <a 
                          href="https://professional.heart.org/en/guidelines-and-statements/prevent-calculator" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="inline-flex items-center px-4 py-2 bg-rose-600 text-white rounded-md hover:bg-rose-700 transition-colors text-sm font-medium"
                        >
                          Open PREVENT Calculator →
                        </a>
                      </div>
                    </div>


                  </div>
                )}

                {/* Management */}
                {activeTab === 'protocols' && (
                  <div className="space-y-6">
                    {/* Blood Pressure Management */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-blue-800 mb-3">Blood Pressure Management</h3>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-green-700 mb-2">BP Goals</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Ischemic stroke:</strong> SBP &lt;220, DBP &lt;120</li>
                            <li><strong>Before lytics:</strong> SBP &lt;185, DBP &lt;110</li>
                            <li><strong>After lytics:</strong> SBP &lt;180, DBP &lt;105</li>
                            <li><strong>After thrombectomy:</strong> SBP &lt;180, DBP &lt;105</li>
                            <li><strong>ICH:</strong> SBP &lt;160, DBP &lt;105</li>
                          </ul>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-blue-700 mb-2">Acute Treatment</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Labetalol:</strong> 10 mg IV q15min</li>
                            <li>Increase to 20mg, then 40mg, then 60mg</li>
                            <li>Max total dose: 300mg in 2 hours</li>
                            <li><strong>Alternative:</strong> Nicardipine 5 mg/hr IV</li>
                            <li>Titrate by 2.5 mg/hr q15min</li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    {/* Post-Lytic Complications */}
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-red-800 mb-3">Post-Lytic ICH Protocol</h3>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">Immediate Actions</h4>
                          <ol className="text-sm space-y-1 list-decimal list-inside">
                            <li>STAT non-contrast CT head</li>
                            <li>Emergency hemorrhage panel</li>
                            <li>Type & cross</li>
                            <li>Notify patient's family</li>
                          </ol>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">Reversal Agents</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Cryoprecipitate:</strong> 2 pools over 10-30 min</li>
                            <li><strong>Tranexamic acid:</strong> 1g IV infused over 10 minutes</li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    {/* Angioedema Protocol */}
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-yellow-800 mb-3">Orolingual Angioedema Protocol</h3>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">Assessment</h4>
                          <ul className="text-sm space-y-1">
                            <li>• Maintain airway</li>
                            <li>• Hold ACE inhibitors</li>
                            <li>• Consider intubation if severe</li>
                          </ul>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">Treatment</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Methylprednisolone:</strong> 125 mg IV</li>
                            <li><strong>Diphenhydramine:</strong> 50 mg IV</li>
                            <li><strong>Famotidine:</strong> 20 mg IV</li>
                            <li><strong>Epinephrine:</strong> 0.1% if severe</li>
                            <li><strong>Consider Berinert:</strong> 20 IU/kg (C1 esterase inhibitor)</li>
                            <li><strong>Supportive Care</strong></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Evidence */}
                {activeTab === 'evidence' && (
                  <div className="space-y-6">
                    {/* AFib Section */}
                    <div className="bg-white border border-gray-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-gray-800 mb-4">Atrial Fibrillation</h3>
                      <div className="space-y-3">
                        {/* Document 1 - PDF */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">AC timing after AF-related Stroke</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <a
                              href="documents/afib/AC timing after AF-related Stroke.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/afib/AC timing after AF-related Stroke.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                          </div>
                        </div>

                        {/* Document 2 - PPTX */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="presentation" className="w-6 h-6 text-orange-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">AF & secondary stroke prevention July 2024</h4>
                              <p className="text-xs text-gray-500">PowerPoint Presentation</p>
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <a
                              href="documents/afib/AF & secondary stroke prevention July 2024.pptx"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/afib/AF & secondary stroke prevention July 2024.pptx"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

              </div>

              {/* Mobile Bottom Navigation - Only visible on small screens */}
              <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-300 shadow-lg z-50 pb-safe">
                <div className="flex justify-around items-center px-2 py-2">
                  {[
                    { id: 'encounter', name: 'Encounter', icon: 'activity' },
                    { id: 'ich', name: 'ICH', icon: 'alert-triangle' },
                    { id: 'protocols', name: 'Management', icon: 'file-text' },
                    { id: 'calculators', name: 'Calculators', icon: 'calculator' },
                    { id: 'trials', name: 'Trials', icon: 'file-text' },
                    { id: 'evidence', name: 'Evidence', icon: 'file-text' }
                  ].map((tab) => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`flex flex-col items-center justify-center px-2 py-2 rounded-lg transition-all ${
                        activeTab === tab.id
                          ? 'text-blue-600 bg-blue-50'
                          : 'text-gray-600'
                      }`}
                    >
                      <i data-lucide={tab.icon} className="w-6 h-6 mb-1"></i>
                      <span className="text-xs font-medium">{tab.name}</span>
                    </button>
                  ))}
                  {/* More button */}
                  <button
                    onClick={() => setMobileMoreOpen(!mobileMoreOpen)}
                    className={`flex flex-col items-center justify-center px-2 py-2 rounded-lg transition-all ${
                      mobileMoreOpen ? 'text-blue-600 bg-blue-50' : 'text-gray-600'
                    }`}
                  >
                    <i data-lucide="menu" className="w-6 h-6 mb-1"></i>
                    <span className="text-xs font-medium">More</span>
                  </button>
                </div>
              </div>

              {/* Mobile More Menu - Modal overlay */}
              {mobileMoreOpen && (
                <div className="md:hidden fixed inset-0 bg-black bg-opacity-50 z-50" onClick={() => setMobileMoreOpen(false)}>
                  <div className="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl max-h-96 overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="p-4">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold text-gray-900">More Tabs</h3>
                        <button
                          onClick={() => setMobileMoreOpen(false)}
                          className="p-2 hover:bg-gray-100 rounded-lg"
                        >
                          <i data-lucide="x" className="w-6 h-6"></i>
                        </button>
                      </div>
                      <div className="grid grid-cols-2 gap-3">
                        {[
                          { id: 'workflow', name: 'Workflow', icon: 'check-circle' },
                          { id: 'evt', name: 'EVT', icon: 'zap' },
                          { id: 'documentation', name: 'Documentation', icon: 'file-text' },
                          { id: 'ich', name: 'ICH', icon: 'alert-triangle' },
                          { id: 'trials', name: 'Trials', icon: 'flask' },
                          { id: 'calculators', name: 'Calculators', icon: 'calculator' },
                          { id: 'protocols', name: 'Management', icon: 'clipboard-list' }
                        ].map((tab) => (
                          <button
                            key={tab.id}
                            onClick={() => {
                              setActiveTab(tab.id);
                              setMobileMoreOpen(false);
                            }}
                            className={`flex flex-col items-center justify-center p-4 rounded-lg border-2 transition-all ${
                              activeTab === tab.id
                                ? 'border-blue-500 bg-blue-50 text-blue-600'
                                : 'border-gray-200 bg-white text-gray-600 hover:border-blue-300'
                            }`}
                          >
                            <i data-lucide={tab.icon} className="w-8 h-8 mb-2"></i>
                            <span className="text-sm font-medium">{tab.name}</span>
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // Render the component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StrokeClinicalTool />);

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
