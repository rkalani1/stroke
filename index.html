<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Comprehensive clinical decision support tool for stroke management including NIHSS, ASPECTS, and treatment protocols">
    <meta name="theme-color" content="#3B82F6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="manifest.json">
    <!-- Aggressive cache control -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>stroke</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js?v=20251016c"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js?v=20251016c"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js?v=20251016c"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js?v=20251016c"></script>
    <script src="https://cdn.tailwindcss.com?v=20251016c"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js?v=20251016c"></script>
    <style>
        /* Mobile overflow fix - prevent horizontal scroll */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
            -webkit-overflow-scrolling: touch;
        }

        * {
            box-sizing: border-box;
        }

        /* Ensure all content respects viewport width */
        .main-container {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Fix for flex containers on mobile */
        @media (max-width: 640px) {
            .flex-wrap-mobile {
                flex-wrap: wrap !important;
            }

            /* Ensure buttons wrap properly on mobile */
            .flex.gap-2, .flex.gap-3 {
                flex-wrap: wrap;
            }

            /* Prevent long text from causing overflow */
            h1, h2, h3, h4, h5, p, span, a, button {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Fix for long URLs */
            a {
                word-break: break-all;
            }

            /* Ensure document cards don't overflow */
            .flex.items-center.justify-between {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            /* Make action buttons stack on very small screens */
            .flex.gap-2 > a,
            .flex.gap-2 > button {
                flex: 1 1 auto;
                min-width: 70px;
                text-align: center;
                justify-content: center;
            }
        }

        /* Extra small screen fixes */
        @media (max-width: 375px) {
            /* Smaller padding on very small screens */
            .p-4 {
                padding: 0.75rem !important;
            }
            .p-3 {
                padding: 0.5rem !important;
            }

            /* Smaller text */
            .text-lg {
                font-size: 1rem !important;
            }
            .text-sm {
                font-size: 0.75rem !important;
            }
        }

        /* Fix for date and time inputs on mobile */
        @media (max-width: 640px) {
            input[type="date"],
            input[type="time"] {
                max-width: 100%;
                min-width: 0;
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
        }

        /* Dark mode styles */
        .dark {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white { background-color: #2d3748; }
        .dark .text-gray-800 { color: #e2e8f0; }
        .dark .text-gray-700 { color: #cbd5e0; }
        .dark .text-gray-600 { color: #a0aec0; }
        .dark .border-gray-200 { border-color: #4a5568; }
        .dark .bg-gray-50 { background-color: #2d3748; }

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: min(250px, 90vw);
            background-color: #1a202c;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1a202c transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Touch targets minimum 44px */
        button, input[type="checkbox"], input[type="radio"], select {
            min-height: 44px;
            min-width: 44px;
        }
        input[type="checkbox"], input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 12px;
        }

        /* Success animation */
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .success-pulse {
            animation: successPulse 0.6s;
        }

        /* Alert flash animation for thrombolysis window */
        @keyframes alertFlash {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                transform: scale(1);
            }
            25% {
                box-shadow: 0 0 20px 10px rgba(239, 68, 68, 0.6);
                transform: scale(1.02);
            }
            50% {
                box-shadow: 0 0 30px 15px rgba(239, 68, 68, 0.4);
                transform: scale(1.01);
            }
            75% {
                box-shadow: 0 0 20px 10px rgba(239, 68, 68, 0.6);
                transform: scale(1.02);
            }
        }
        .alert-flash {
            animation: alertFlash 1s ease-in-out infinite;
        }

        /* Pulse animation for urgent countdown */
        @keyframes urgentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .urgent-pulse {
            animation: urgentPulse 0.5s ease-in-out infinite;
        }

        /* Fade in animation for FAB */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out forwards;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .focus\:not-sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: inherit;
            margin: inherit;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }

        /* Print styles */
        @media print {
            /* Hide unnecessary elements */
            button, .no-print, [data-lucide="search"], .dark-mode-toggle,
            nav, .breadcrumb, .keyboard-help, .mobile-nav {
                display: none !important;
            }

            /* Optimize for print */
            body {
                background: white;
                color: black;
                font-size: 12pt;
            }

            /* Page breaks */
            .page-break {
                page-break-after: always;
            }

            h1, h2, h3 {
                page-break-after: avoid;
            }

            /* Show URLs for links */
            a[href]:after {
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #666;
            }

            /* Optimize tables and calculators for print */
            table, .calculator, .score-card {
                page-break-inside: avoid;
            }

            /* Remove shadows and unnecessary styling */
            * {
                box-shadow: none !important;
                text-shadow: none !important;
            }

            /* Ensure good contrast */
            .bg-gray-50, .bg-blue-50, .bg-green-50, .bg-yellow-50, .bg-red-50 {
                background: white !important;
                border: 1px solid #ddd !important;
            }
        }

        /* Safe area insets for notched devices */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .mb-safe {
            margin-bottom: env(safe-area-inset-bottom, 0);
        }

        /* FAB positioning with safe area */
        @media (max-width: 768px) {
            .fixed.bottom-20 {
                bottom: calc(5rem + env(safe-area-inset-bottom, 0));
            }
        }

        /* Better mobile touch feedback */
        @media (max-width: 640px) {
            button, a {
                -webkit-tap-highlight-color: rgba(59, 130, 246, 0.2);
            }

            /* Larger touch targets for mobile */
            .touch-target {
                min-height: 48px;
                min-width: 48px;
            }

            /* Prevent text selection on interactive elements */
            button, .btn, [role="button"] {
                -webkit-user-select: none;
                user-select: none;
            }
        }

        /* Smooth scrolling for the entire app */
        html {
            scroll-behavior: smooth;
        }

        /* Better focus visibility for accessibility */
        :focus-visible {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }
    </style>
    <script>
        // CRITICAL: Version management and automatic data cleanup
        // This runs BEFORE React loads to prevent crashes from incompatible data
        (function() {
            const APP_VERSION = 'v2.2.0-dtn-tracker'; // Increment this with each deployment
            const storedVersion = localStorage.getItem('app_version');

            // If version doesn't match, clear ALL localStorage to prevent crashes
            if (storedVersion !== APP_VERSION) {
                console.log('Version change detected (' + storedVersion + ' -> ' + APP_VERSION + '). Clearing localStorage for compatibility.');
                const darkModeValue = localStorage.getItem('darkMode'); // Preserve dark mode preference
                localStorage.clear();
                if (darkModeValue) {
                    localStorage.setItem('darkMode', darkModeValue);
                }
                localStorage.setItem('app_version', APP_VERSION);
            }

            // Dark mode initialization
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (darkMode) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body>
    <div id="root"></div>

    <script>
        // Enhanced error handler with automatic recovery
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error caught:', msg, 'at line', lineNo);

            // If critical error occurs, clear localStorage and reload ONCE
            if (msg && (msg.includes('is not a function') || msg.includes('undefined'))) {
                const hasReloaded = sessionStorage.getItem('error_reload_attempted');
                if (!hasReloaded) {
                    console.log('Critical error detected. Clearing data and reloading...');
                    sessionStorage.setItem('error_reload_attempted', 'true');
                    localStorage.clear();
                    window.location.reload();
                } else {
                    // If already reloaded once, show error message instead of infinite loop
                    document.getElementById('root').innerHTML =
                        '<div style="padding: 40px; font-family: Arial; max-width: 600px; margin: 0 auto;">' +
                        '<h1 style="color: #dc2626;">Unable to Load Application</h1>' +
                        '<p style="color: #374151; margin: 20px 0;">A critical error occurred. Please try:</p>' +
                        '<ol style="color: #374151;">' +
                        '<li>Use a different browser (Chrome, Firefox, Safari)</li>' +
                        '<li>Try Incognito/Private mode</li>' +
                        '<li>Contact support if issue persists</li>' +
                        '</ol>' +
                        '<p style="color: #6b7280; font-size: 14px; margin-top: 30px;">Error: ' + msg + '</p>' +
                        '</div>';
                }
            }
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Calculator, Clock, Brain, AlertTriangle, FileText, CheckCircle, Moon, Sun, Download, Copy, Search, Check } = lucide;

        const StrokeClinicalTool = () => {
          // Load saved data from localStorage with validation
          const loadFromStorage = (key, defaultValue) => {
            try {
              const saved = localStorage.getItem(key);
              if (!saved) return defaultValue;

              const parsed = JSON.parse(saved);

              // Validate that arrays are actually arrays (fix for completedSteps issue)
              if (Array.isArray(defaultValue) && !Array.isArray(parsed)) {
                console.warn(`Invalid data type for ${key}, expected array. Resetting to default.`);
                return defaultValue;
              }

              return parsed;
            } catch (e) {
              console.warn(`Error loading ${key} from localStorage:`, e);
              return defaultValue;
            }
          };

          // Force activeTab to always start as 'encounter' - load saved value in useEffect after mount
          const [activeTab, setActiveTab] = useState('encounter');
          const [patientData, setPatientData] = useState(loadFromStorage('patientData', {}));
          const [nihssScore, setNihssScore] = useState(loadFromStorage('nihssScore', 0));
          const [aspectsScore, setAspectsScore] = useState(loadFromStorage('aspectsScore', 10));
          const [darkMode, setDarkMode] = useState(localStorage.getItem('darkMode') === 'true');
          const [searchQuery, setSearchQuery] = useState('');
          const [showSuccess, setShowSuccess] = useState(false);
          const [isCalculating, setIsCalculating] = useState(false);
          const [copiedText, setCopiedText] = useState('');
          const [isMounted, setIsMounted] = useState(false);
          const [strokeAlertMode, setStrokeAlertMode] = useState(false);
          const [alertStartTime, setAlertStartTime] = useState(null);
          const [showTemplateEditor, setShowTemplateEditor] = useState(false);
          const [editableTemplate, setEditableTemplate] = useState(loadFromStorage('telestrokeTemplate', `Chief complaint: {chiefComplaint}
Last known well (date/time): {lkwDate} {lkwTime}
HPI: {age} year old {sex} p/w {symptoms} at {lkwTime}
Relevant PMH: {pmh}
Medications: {medications}

Objective:
Vitals:
Presenting BP {presentingBP}
Blood pressure: BP prior to TNK administration: {bpPreTNK} at {bpPreTNKTime}
Labs: Glucose {glucose}
Exam: Scores: NIHSS {nihss} - {nihssDetails}

Imaging: I personally reviewed imaging
Date/time Non-contrast Head CT reviewed: {ctTime}; Non-contrast Head CT Results: {ctResults}
Date/time CTA reviewed: {ctaDate} {ctaTime}; CTA Results: {ctaResults}
Telemetry/EKG: {ekgResults}

Assessment and Plan:
Suspected Diagnosis: {diagnosis}
After ensuring that there were no evident contraindications, TNK administration was recommended at {tnkAdminTime}. Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the patient, patient's wife, and OSH provider. Both the patient and his wife expressed agreement with the recommendation.
TNK was administered at {tnkAdminTime} after a brief time-out.

Recommendations:
{recommendationsText}

Rizwan Kalani MD`));

          // Time tracking
          const [currentTime, setCurrentTime] = useState(new Date());
          const [lkwTime, setLkwTime] = useState(loadFromStorage('lkwTime', null) ? new Date(loadFromStorage('lkwTime', null)) : new Date());

          // Thrombolysis window alert state
          const [alertsMuted, setAlertsMuted] = useState(localStorage.getItem('thrombolysisAlertsMuted') === 'true');
          const [lastAlertPlayed, setLastAlertPlayed] = useState(null);
          const [alertFlashing, setAlertFlashing] = useState(false);
          const [elapsedSeconds, setElapsedSeconds] = useState(0);

          // Save status
          const [saveStatus, setSaveStatus] = useState('saved');
          const [lastSaved, setLastSaved] = useState(null);

          // Critical alerts state
          const [criticalAlerts, setCriticalAlerts] = useState([]);

          // Search
          const [searchResults, setSearchResults] = useState([]);
          const [searchOpen, setSearchOpen] = useState(false);
          const [evidenceFilter, setEvidenceFilter] = useState('');
          const [showKeyboardHelp, setShowKeyboardHelp] = useState(false);

          // Workflow tracking
          const [currentStep, setCurrentStep] = useState(loadFromStorage('currentStep', 0));
          const [completedSteps, setCompletedSteps] = useState(loadFromStorage('completedSteps', []));

          // ============================================
          // SHIFT TRACKING: Multi-patient management
          // ============================================
          // Each patient in shift has: id, summary, timestamp, formState snapshot
          const [shiftPatients, setShiftPatients] = useState(loadFromStorage('shiftPatients', []));
          const [currentPatientId, setCurrentPatientId] = useState(loadFromStorage('currentPatientId', null));
          const [showPatientSwitcher, setShowPatientSwitcher] = useState(false);

          // Trial Screening Sidebar state
          const [expandedTrial, setExpandedTrial] = useState(null);

          // Emergency Contacts FAB state
          const [fabExpanded, setFabExpanded] = useState(false);

          // ============================================
          // SIGN-OUT / HANDOFF FEATURE
          // ============================================
          // PHI-free patient summaries for shift handoff
          const [signOutPatients, setSignOutPatients] = useState(loadFromStorage('signOutPatients', []));
          const [showSignOutModal, setShowSignOutModal] = useState(false);
          const [showSignOutManager, setShowSignOutManager] = useState(false);
          const [signOutToast, setSignOutToast] = useState('');

          // Ref and state for Part 6 (Treatment Decision) scroll visibility
          const treatmentDecisionRef = useRef(null);
          const [showSmartPhrases, setShowSmartPhrases] = useState(false);

          const [gcsItems, setGcsItems] = useState(loadFromStorage('gcsItems', {
            eye: '',
            verbal: '',
            motor: ''
          }));
          const [mrsScore, setMrsScore] = useState(loadFromStorage('mrsScore', ''));
          const [ichScoreItems, setIchScoreItems] = useState(loadFromStorage('ichScoreItems', {
            gcs: '', // Changed to single field for mutual exclusivity
            age80: false,
            volume30: false,
            ivh: false,
            infratentorial: false
          }));
          const [abcd2Items, setAbcd2Items] = useState(loadFromStorage('abcd2Items', {
            age60: false,
            bp: false,
            unilateralWeakness: false,
            speechDisturbance: false,
            duration: '', // Changed to single field for mutual exclusivity
            diabetes: false
          }));
          const [chads2vascItems, setChads2vascItems] = useState(loadFromStorage('chads2vascItems', {
            chf: false,
            hypertension: false,
            age75: false,
            diabetes: false,
            strokeTia: false,
            vascular: false,
            age65: false,
            female: false
          }));
          const [ropeItems, setRopeItems] = useState(loadFromStorage('ropeItems', {
            noHypertension: false,
            noDiabetes: false,
            noStrokeTia: false,
            nonsmoker: false,
            cortical: false,
            age: ''
          }));
          const [huntHessGrade, setHuntHessGrade] = useState(loadFromStorage('huntHessGrade', ''));
          const [wfnsGrade, setWfnsGrade] = useState(loadFromStorage('wfnsGrade', ''));
          const [hasbledItems, setHasbledItems] = useState(loadFromStorage('hasbledItems', {
            hypertension: false,
            renalDisease: false,
            liverDisease: false,
            stroke: false,
            bleeding: false,
            labileINR: false,
            elderly: false,
            drugs: false,
            alcohol: false
          }));
          const [rcvs2Items, setRcvs2Items] = useState(loadFromStorage('rcvs2Items', {
            recurrentTCH: false,
            carotidInvolvement: false,
            vasoconstrictiveTrigger: false,
            female: false,
            sah: false
          }));
          const [trialsCategory, setTrialsCategory] = useState('ischemic');

          const [strokeCodeForm, setStrokeCodeForm] = useState(loadFromStorage('strokeCodeForm', {
            age: '',
            sex: '',
            hx: '',
            sx: '',
            lkw: '',
            lkw_date: new Date().toISOString().split('T')[0],
            nihss: '',
            aspects: '',
            def: '',
            hct: '',
            cta: '',
            ctp: '',
            tnk: [],
            tnk_rec: '',
            evt_rec: '',
            rec_reason: ''
          }));
          const [aspectsRegionState, setAspectsRegionState] = useState([
            { id: 'M1', name: 'M1 - Anterior MCA cortex', checked: true },
            { id: 'M2', name: 'M2 - MCA cortex lateral to insular ribbon', checked: true },
            { id: 'M3', name: 'M3 - Posterior MCA cortex', checked: true },
            { id: 'M4', name: 'M4 - Anterior MCA territory immediately superior to M1', checked: true },
            { id: 'M5', name: 'M5 - Lateral MCA territory immediately superior to M2', checked: true },
            { id: 'M6', name: 'M6 - Posterior MCA territory immediately superior to M3', checked: true },
            { id: 'IC', name: 'IC - Internal capsule', checked: true },
            { id: 'L', name: 'L - Lentiform nucleus', checked: true },
            { id: 'C', name: 'C - Caudate', checked: true },
            { id: 'I', name: 'I - Insular ribbon', checked: true }
          ]);

          // PC-ASPECTS regions state
          const [pcAspectsRegions, setPcAspectsRegions] = useState(loadFromStorage('pcAspectsRegions', [
            { id: 'THAL', name: 'Thalami (bilateral)', checked: true, points: 1 },
            { id: 'MIDBRAIN', name: 'Midbrain', checked: true, points: 2 },
            { id: 'PONS', name: 'Pons', checked: true, points: 2 },
            { id: 'MEDULLA', name: 'Medulla', checked: true, points: 1 },
            { id: 'CEREBELLUM-L', name: 'Left Cerebellar Hemisphere', checked: true, points: 1 },
            { id: 'CEREBELLUM-R', name: 'Right Cerebellar Hemisphere', checked: true, points: 1 },
            { id: 'PCA-L', name: 'Left Occipital Lobe (PCA Territory)', checked: true, points: 1 },
            { id: 'PCA-R', name: 'Right Occipital Lobe (PCA Territory)', checked: true, points: 1 }
          ]));

          // Telestroke Documentation State
          const [telestrokeNote, setTelestrokeNote] = useState(loadFromStorage('telestrokeNote', {
            chiefComplaint: '',
            lkwDate: new Date().toISOString().split('T')[0],
            lkwTime: '',
            lkwUnknown: false, // Wake-up stroke / unknown onset
            age: '',
            sex: 'M',
            affectedSide: '', // L or R for laterality
            weight: '', // kg - for TNK dosing
            height: '', // cm - for BMI/contrast dosing
            lastDOACDose: new Date().toISOString().slice(0, 16), // date/time of last anticoagulant - auto-populated with current time
            lastDOACType: '', // apixaban, rivaroxaban, dabigatran, edoxaban
            arrivalTime: '', // ED arrival for DTN calculation
            strokeAlertTime: '', // Stroke team activation time
            // DTN Time Metrics - all ISO datetime strings
            dtnEdArrival: '', // ED Arrival time (door)
            dtnStrokeAlert: '', // Stroke Alert called
            dtnCtStarted: '', // CT scan started
            dtnCtRead: '', // CT read/cleared for TNK
            dtnTnkOrdered: '', // TNK ordered
            dtnTnkAdministered: '', // TNK administered (needle time)
            symptoms: '',
            pmh: '',
            medications: '',
            noAnticoagulants: false,
            // NEW: Pre-stroke functional status for trial eligibility
            premorbidMRS: '',
            // NEW: Vessel occlusion for STEP and other trials
            vesselOcclusion: [], // Array of: ICA, M1, M2, M3, M4, A1, A2, A3, P1, P2, P3
            presentingBP: '',
            bpPreTNK: '',
            bpPreTNKTime: '',
            glucose: '',
            plateletsCoags: '',
            creatinine: '',
            inr: '', // actual INR value for contraindication check
            ptt: '', // PTT value
            plateletCount: '', // actual platelet count (not just notes)
            allergies: '', // including contrast, iodine
            contrastAllergy: false,
            nihss: '',
            nihssDetails: '',
            imagingReviewed: true,
            ctDate: new Date().toISOString().split('T')[0],
            ctTime: '',
            ctResults: '',
            ctaDate: new Date().toISOString().split('T')[0],
            ctaTime: '',
            ctaResults: '',
            ctpResults: '',
            ekgResults: '',
            diagnosis: '',
            tnkRecommended: false,
            evtRecommended: false,
            rationale: '',
            tnkConsentDiscussed: false,
            patientFamilyConsent: false,
            presumedConsent: false,
            preTNKSafetyPause: false,
            tnkAdminTime: '',
            admitLocation: '',
            recommendationsText: '',
            // Thrombolysis Contraindication Checklist
            tnkContraindicationChecklist: {
              // Absolute Contraindications
              activeInternalBleeding: false,
              recentIntracranialSurgery: false, // <3 months: intracranial/spinal surgery, head trauma, or stroke
              intracranialNeoplasm: false, // neoplasm, AVM, or aneurysm
              knownBleedingDiathesis: false,
              severeUncontrolledHTN: false, // despite treatment
              currentICH: false, // on imaging
              // Relative Contraindications
              recentMajorSurgery: false, // <14 days
              recentGIGUBleeding: false, // <21 days
              recentArterialPuncture: false, // <7 days at non-compressible site
              recentLumbarPuncture: false, // <7 days
              pregnancy: false,
              seizureAtOnset: false, // with postictal deficits
              lowPlatelets: false, // <100,000
              elevatedINR: false, // >1.7
              elevatedPTT: false, // >40s
              abnormalGlucose: false, // <50 or >400 mg/dL
              recentDOAC: false // within 48h unless reversal confirmed
            },
            tnkContraindicationReviewed: false,
            tnkContraindicationReviewTime: '',
            recommendations: {
              neuroChecks: false,
              noAntithrombotics: false,
              bpControl: false,
              followUpCT: false,
              mri: false,
              ekg: false,
              echo: false,
              lipids: false,
              therapies: false,
              dvtPpx: false,
              neuroConsult: false
            }
          }));


          // Trials data
          const trialsData = {
            ischemic: {
                title: "Ischemic Stroke Studies",
                hasSubsections: true,
                subsections: {
                    acute: {
                        title: "Acute Trials",
                        trials: [
                            {
                                name: "SISTER Trial",
                                nct: "NCT05948566",
                                phase: "Phase 2",
                                status: "",
                                description: "TS23 (monoclonal antibody to α2-antiplasmin) for late thrombolysis in acute ischemic stroke patients presenting 4.5-24 hours from last known well",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Suspected anterior circulation acute ischemic stroke",
                                    "NIH Stroke Scale score ≥4 prior to randomization (participant must have a clearly disabling deficit if NIHSS is 4-5)",
                                    "Time from last known well: 4.5-24 hours",
                                    "Favorable baseline neuroimaging consisting of ALL of the following:",
                                    "• ASPECTS ≥6 on CT (or ASPECTS ≥7 on MRI)",
                                    "• Favorable perfusion imaging on CTP/MR-PWI consisting of ALL:",
                                    "  - Mismatch ratio of penumbra:core >1.2",
                                    "  - Mismatch volume >10 cc",
                                    "  - Ischemic core volume <70 cc",
                                    "Able to receive assigned study drug within 4.5 to 24 hours of stroke onset or last known well",
                                    "Informed consent obtained from participant or legally authorized representative",
                                    "Study drug administration encouraged within 90 minutes after qualifying perfusion image (allowed up to 120 minutes)"
                                ],
                                exclusion: [
                                    "Received endovascular treatment with clot engagement (patients with groin puncture but no clot engagement due to spontaneous distal migration are permitted)",
                                    "Received or planned to receive intravenous thrombolysis",
                                    "Pre-stroke modified Rankin score >2",
                                    "Previous treatment with TS23 or known previous allergy to antibody therapy",
                                    "Known pregnancy, breastfeeding, or plan to breastfeed within 3 months of receiving TS23",
                                    "Positive urine or serum pregnancy test for women of childbearing potential",
                                    "Known previous stroke in the past 90 days",
                                    "Known previous intracranial hemorrhage, intracranial neoplasm, subarachnoid hemorrhage, or arteriovenous malformation",
                                    "Known active diagnosis of intracranial neoplasm",
                                    "Clinical presentation suggestive of subarachnoid hemorrhage (even if initial CT scan was normal)",
                                    "Surgery or biopsy of parenchymal organ in the past 30 days",
                                    "Known trauma with internal injuries or persistent ulcerative wounds in the past 30 days",
                                    "Severe head trauma in the past 90 days",
                                    "Persistent systolic blood pressure >180mmHg or diastolic blood pressure >105mmHg despite best medical management",
                                    "Serious systemic hemorrhage in the past 30 days",
                                    "Hereditary or acquired hemorrhagic diathesis or coagulation factor deficiency",
                                    "Use of dual antiplatelet agents within 48 hours prior to stroke symptom onset",
                                    "International normalized ratio (INR) >1.7 or partial thromboplastin time (PTT) > 2x upper limit of normal",
                                    "Use of direct thrombin inhibitors or direct factor Xa inhibitors within past 48 hours unless aPTT, INR, platelet count, ecarin clotting time (ECT), thrombin time (TT), or appropriate factor Xa activity assays are normal",
                                    "Glucose <50 mg/dL or >400 mg/dL",
                                    "Platelets <100,000/µL",
                                    "Known severe renal failure with creatinine >3 mg/dL or glomerular filtration rate <30 mL/min",
                                    "Severe contrast allergy that cannot be managed medically",
                                    "Suspected cerebral vasculitis based on medical history and CTA/MRA",
                                    "Suspected intracranial dissection based on medical history and CTA/MRA",
                                    "Intracranial stenosis related to atherosclerosis proximal to intracranial thrombus",
                                    "Intracranial stent in place proximal to the intracranial occlusion",
                                    "Acute myocardial infarction in past 7 days",
                                    "Major surgery (requiring intubation or transfusion) in past 30 days",
                                    "Suspicion of aortic dissection on history, examination, or imaging",
                                    "Presumed septic embolus; suspicion of bacterial endocarditis",
                                    "Life expectancy <90 days",
                                    "Currently participating in another investigational drug or device study"
                                ]
                            },
                            {
                                name: "STEP-EVT Trial",
                                nct: "NCT06289985",
                                phase: "Adaptive Platform",
                                status: "",
                                description: "NIH StrokeNet adaptive platform trial optimizing endovascular therapy for mild stroke and medium/distal vessel occlusions",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Acute ischemic stroke due to large vessel occlusion (LVO) or medium vessel occlusion (MVO)",
                                    "Within 24 hours of last known well",
                                    "For Low NIHSS Domain:",
                                    "• NIHSS 0-5 with ICA or M1 occlusion",
                                    "• Disabling symptoms despite low NIHSS",
                                    "For Medium/Distal Vessel Occlusion Domain:",
                                    "• M2, M3, or M4 occlusion",
                                    "• A1, A2, or A3 occlusion",
                                    "• P1, P2, or P3 occlusion",
                                    "• Appropriate perfusion imaging criteria demonstrating salvageable tissue",
                                    "Ability to start EVT within appropriate time window",
                                    "Pre-stroke mRS ≤2 (able to live independently)",
                                    "Informed consent from patient or legally authorized representative"
                                ],
                                exclusion: [
                                    "Known pre-existing medical, neurological or psychiatric disease that would confound outcome evaluations",
                                    "Known serious, advanced, or terminal illness with life expectancy <6 months",
                                    "Unfavorable vascular anatomy limiting endovascular access to occluded artery",
                                    "Acute occlusions in multiple vascular territories",
                                    "Suspected septic embolus",
                                    "Suspected bacterial endocarditis",
                                    "Seizure at stroke onset with postictal residual impairments",
                                    "Contrast allergy precluding EVT that cannot be adequately pre-medicated",
                                    "Chronic total occlusion of target vessel",
                                    "Known intracranial dissection",
                                    "Known vasculitis",
                                    "Known moyamoya disease or syndrome",
                                    "Pregnancy or positive pregnancy test",
                                    "Currently breastfeeding",
                                    "Large core infarct (ASPECTS <3 or core volume >100cc depending on time window)",
                                    "Evidence of intracranial hemorrhage on baseline imaging",
                                    "Clinical suspicion of subarachnoid hemorrhage despite negative imaging",
                                    "Known bleeding diathesis or coagulopathy",
                                    "Platelet count <50,000/μL",
                                    "INR >3.0",
                                    "Blood glucose <50mg/dL",
                                    "Refractory hypertension (SBP >185 or DBP >110 despite treatment)",
                                    "Currently participating in another interventional clinical trial"
                                ]
                            },
                            {
                                name: "PICASSO Trial",
                                nct: "NCT05611242",
                                phase: "Phase 3 RCT",
                                status: "",
                                description: "Mechanical thrombectomy with vs without acute carotid stenting for tandem lesions",
                                inclusion: [
                                    "Age 18-79 years",
                                    "Acute ischemic stroke in the anterior circulation",
                                    "Tandem lesion consisting of:",
                                    "• Proximal carotid artery stenosis 70-100% by NASCET criteria or complete occlusion",
                                    "• Intracranial large vessel occlusion (ICA terminus, M1, or proximal M2)",
                                    "Within 16 hours from stroke onset or last known well",
                                    "Pre-stroke mRS 0-2",
                                    "NIHSS ≥4",
                                    "For presentation ≤6 hours: ASPECTS ≥7 on non-contrast CT",
                                    "For presentation >6-16 hours:",
                                    "• ASPECTS ≥7 AND",
                                    "• Ischemic core volume <50cc on perfusion imaging",
                                    "• Mismatch ratio >1.8",
                                    "• Mismatch volume >15cc",
                                    "Ability to undergo groin puncture within treatment window",
                                    "Informed consent obtained"
                                ],
                                exclusion: [
                                    "Proximal carotid stenosis secondary to dissection",
                                    "Proximal carotid stenosis secondary to vasculitis",
                                    "Pre-stroke mRS >2",
                                    "Known hemorrhagic diathesis",
                                    "Known coagulation factor deficiency",
                                    "Absolute contraindications to antiplatelet therapy",
                                    "Need for acute therapeutic anticoagulation that cannot be stopped",
                                    "Platelet count <100,000/μL",
                                    "INR >1.7",
                                    "aPTT >1.5x normal",
                                    "Blood glucose <50mg/dL or >400mg/dL",
                                    "Serum creatinine >3.0mg/dL unless on dialysis",
                                    "Evidence of intracranial hemorrhage on baseline CT/MRI",
                                    "Clinical suspicion of subarachnoid hemorrhage",
                                    "Large territory infarction (>1/3 MCA territory)",
                                    "Known severe contrast allergy that cannot be adequately pre-medicated",
                                    "Known pregnancy or positive pregnancy test",
                                    "Life expectancy <90 days due to comorbid conditions",
                                    "Enrollment in another interventional clinical trial",
                                    "Previous carotid endarterectomy or carotid stenting on affected side",
                                    "Contralateral carotid occlusion",
                                    "Intracranial stenosis in addition to the tandem lesion",
                                    "Known cardiac source of embolism requiring anticoagulation",
                                    "Recent MI within 30 days with ongoing cardiac issues",
                                    "Severe or unstable congestive heart failure",
                                    "Uncontrolled hypertension (SBP >185 or DBP >110 despite treatment)"
                                ]
                            },
                            {
                                name: "TESTED",
                                nct: "NCT05911568",
                                phase: "Comparative Effectiveness",
                                status: "",
                                description: "EVT vs medical therapy in LVO with pre-existing disability (mRS 3-4)",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Pre-stroke mRS 3-4 for at least 3 months prior to index stroke",
                                    "Large vessel occlusion:",
                                    "• ICA terminus",
                                    "• M1 segment of MCA",
                                    "• Dominant/co-dominant M2 segment",
                                    "Within 24 hours of last known well",
                                    "NIHSS ≥6",
                                    "ASPECTS ≥3 on non-contrast CT or ≥4 on MRI",
                                    "For 6-24 hour window: evidence of salvageable tissue on perfusion imaging",
                                    "Able to undergo groin puncture within time window",
                                    "Informed consent from patient or legally authorized representative"
                                ],
                                exclusion: [
                                    "Pre-stroke mRS 0-2 or mRS 5-6",
                                    "Life expectancy <6 months from non-stroke condition",
                                    "Pre-stroke disability deemed temporary or reversible",
                                    "Known pregnancy",
                                    "Evidence of intracranial hemorrhage",
                                    "Large established infarct (>1/3 MCA territory)",
                                    "Bilateral strokes",
                                    "Known vasculitis or moyamoya",
                                    "Intracranial tumor",
                                    "Currently participating in another stroke intervention trial",
                                    "Inability to follow up at 90 days"
                                ]
                            }
                        ]
                    },
                    inpatient: {
                        title: "Subacute Enrollment",
                        trials: [
                            {
                                name: "VERIFY Study",
                                nct: "NCT05338697",
                                phase: "Observational",
                                status: "",
                                description: "Early TMS/MRI/clinical measures to predict upper extremity motor recovery",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Acute ischemic stroke within 7 days of onset",
                                    "Upper extremity weakness (shoulder abduction and/or finger extension ≤4 on MRC scale)",
                                    "Able to provide informed consent or has LAR",
                                    "Able to participate in study assessments",
                                    "Expected to survive at least 90 days"
                                ],
                                exclusion: [
                                    "Contraindications to TMS:",
                                    "• Implanted electronic devices (pacemaker, cochlear implant, etc.)",
                                    "• Intracranial metal",
                                    "• History of seizures",
                                    "• Active psychiatric medication affecting cortical excitability",
                                    "Contraindications to MRI",
                                    "Unable to complete follow-up visits at 30 and 90 days",
                                    "Pre-stroke mRS >2",
                                    "Bilateral upper extremity weakness",
                                    "Previous stroke affecting motor function",
                                    "Other neurological conditions affecting motor function",
                                    "Pregnancy"
                                ]
                            },
                            {
                                name: "DISCOVERY Study",
                                nct: "NCT04916210",
                                phase: "Observational",
                                status: "",
                                description: "Cognitive trajectories and biomarkers after stroke (includes AIS/ICH/SAH)",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Admitted with one of the following:",
                                    "• Acute ischemic stroke",
                                    "• Intracerebral hemorrhage",
                                    "• Aneurysmal subarachnoid hemorrhage",
                                    "Radiographic confirmation of stroke diagnosis",
                                    "Baseline visit can be completed within 6 weeks of stroke",
                                    "Fluent in English or Spanish",
                                    "Has study partner who knows patient well (contact ≥1x/week)",
                                    "Able to provide informed consent or has LAR",
                                    "Expected to survive at least 1 year"
                                ],
                                exclusion: [
                                    "Pre-stroke dementia diagnosis",
                                    "Pre-stroke cognitive impairment interfering with daily activities",
                                    "Concurrent enrollment in interventional trial affecting cognition",
                                    "Unable to complete study protocol due to:",
                                    "• Severe aphasia preventing cognitive testing",
                                    "• Severe motor impairment preventing testing",
                                    "• Blindness or severe visual impairment",
                                    "• Deafness or severe hearing impairment",
                                    "Active substance abuse",
                                    "Severe psychiatric illness affecting participation",
                                    "Terminal illness with life expectancy <1 year",
                                    "Previous enrollment in DISCOVERY",
                                    "Planned move out of area within study period"
                                ]
                            }
                        ]
                    },
                    imaging: {
                        title: "Imaging Studies",
                        trials: [
                            {
                                name: "ESUS Imaging Study",
                                nct: "NCT03820375",
                                phase: "Observational",
                                status: "",
                                description: "Cardiac and intracranial vessel wall MRI to reclassify ESUS",
                                inclusion: [
                                    "ESUS diagnosis",
                                    "Age ≥18 years",
                                    "Within 30 days of index stroke"
                                ],
                                exclusion: [
                                    "MRI contraindications",
                                    "Known stroke etiology"
                                ]
                            },
                            {
                                name: "MOCHA Imaging",
                                nct: "PMC8821414",
                                phase: "Observational",
                                status: "",
                                description: "Automated intracranial vessel-wall analysis for non-stenotic ICAD detection",
                                inclusion: [
                                    "Atherosclerotic lesions within the cerebrovascular tree clinically detected based on stenosis presence on clinical luminal imaging",
                                    "Presence of two or more atherosclerotic risk factors:",
                                    "• Age >50 years for men or >60 years for women",
                                    "• Hypertension",
                                    "• Diabetes mellitus", 
                                    "• Hyperlipidemia",
                                    "• Obesity",
                                    "• Smoking history",
                                    "No clinical evidence for other intracranial vasculopathies",
                                    "High-resolution MRI vessel wall imaging available"
                                ],
                                exclusion: [
                                    "Poor MRI image quality limiting vessel wall analysis",
                                    "Known intracranial vasculopathy (vasculitis, moyamoya, dissection)",
                                    "Unable to undergo MRI scanning",
                                    "Contraindications to MRI contrast if required for imaging protocol"
                                ]
                            }
                        ]
                    }
                }
            },
            ich: {
                title: "Intracerebral Hemorrhage Studies",
                hasSubsections: true,
                subsections: {
                    trials: {
                        title: "Trials",
                        trials: [
                            {
                                name: "SATURN Trial",
                                nct: "NCT03936361",
                                phase: "Phase 3",
                                status: "",
                                description: "Statins for intracerebral hemorrhage: Continue vs discontinue after lobar ICH",
                                inclusion: [
                                    "Age ≥50 years",
                                    "Spontaneous lobar intracerebral hemorrhage confirmed by CT or MRI",
                                    "Taking statin therapy at time of ICH onset for ≥1 month",
                                    "Modified Rankin Scale ≤4 at time of randomization",
                                    "Randomization within 7 days of ICH",
                                    "Clinical indication for statin therapy (dyslipidemia, atherosclerotic disease, diabetes)",
                                    "Able to provide informed consent or has LAR",
                                    "Expected to survive at least 6 months"
                                ],
                                exclusion: [
                                    "Deep (non-lobar) ICH location",
                                    "Secondary causes of ICH:",
                                    "• Trauma",
                                    "• Known brain tumor",
                                    "• Known vascular malformation or aneurysm",
                                    "• Hemorrhagic transformation of ischemic stroke",
                                    "• Known or suspected CNS vasculitis",
                                    "• Coagulopathy (INR >1.5, platelet count <100,000)",
                                    "• Drug-related (cocaine, amphetamines)",
                                    "Recent MI (<3 months) or unstable angina",
                                    "Coronary revascularization within past year",
                                    "Diabetes mellitus with prior MI or coronary revascularization",
                                    "Clear contraindication to statin discontinuation per treating physician",
                                    "Statin-related myopathy or rhabdomyolysis",
                                    "Severe hepatic impairment (ALT/AST >3x ULN)",
                                    "Life expectancy <6 months from non-ICH condition",
                                    "Unable to follow study protocol",
                                    "Pregnancy or breastfeeding",
                                    "Participation in another interventional trial"
                                ]
                            },
                            {
                                name: "ASPIRE Trial",
                                nct: "NCT03907046",
                                phase: "Phase 3",
                                status: "",
                                description: "Apixaban vs aspirin for stroke prevention after ICH in atrial fibrillation",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Spontaneous ICH confirmed by CT or MRI",
                                    "Non-valvular atrial fibrillation (paroxysmal, persistent, or permanent)",
                                    "CHA2DS2-VASc score ≥2",
                                    "Randomization 14-180 days after ICH",
                                    "Modified Rankin Scale ≤4 at randomization",
                                    "Able to take oral medications",
                                    "Informed consent obtained"
                                ],
                                exclusion: [
                                    "Clear indication for anticoagulation other than AF:",
                                    "• Mechanical heart valve",
                                    "• Recent DVT/PE requiring anticoagulation",
                                    "• Left ventricular thrombus",
                                    "Left atrial appendage closure device",
                                    "Valvular AF (moderate-severe mitral stenosis, mechanical valve)",
                                    "Secondary causes of ICH requiring specific treatment",
                                    "Creatinine ≥2.5mg/dL or CrCl <25mL/min",
                                    "Hepatic insufficiency (Child-Pugh B or C)",
                                    "Active bleeding or high bleeding risk condition",
                                    "Uncontrolled hypertension (BP ≥180/100 on multiple readings)",
                                    "Platelet count <100,000/μL",
                                    "Hemoglobin <8g/dL",
                                    "Need for dual antiplatelet therapy",
                                    "Contraindication to aspirin or apixaban",
                                    "Pregnancy or breastfeeding",
                                    "Life expectancy <1 year",
                                    "Unable to adhere to study protocol",
                                    "Participation in another antithrombotic trial"
                                ]
                            },
                            {
                                name: "cAPPricorn-1 Trial",
                                nct: "NCT06393712",
                                phase: "Phase 2",
                                status: "",
                                description: "Intrathecal ALN-APP (mivelsiran) for cerebral amyloid angiopathy",
                                inclusion: [
                                    "For sporadic CAA:",
                                    "• Age ≥50 years",
                                    "• Meets Boston Criteria v2.0 for probable CAA",
                                    "• Prior symptomatic lobar ICH ≥90 days ago",
                                    "For Dutch-type hereditary CAA:",
                                    "• Age ≥30 years",
                                    "• Confirmed E693Q APP variant",
                                    "• Prior ICH ≥90 days ago (if applicable)",
                                    "MRI evidence of CAA (microbleeds, superficial siderosis)",
                                    "Modified Rankin Scale ≤4",
                                    "Able to undergo lumbar punctures",
                                    "Adequate contraception if childbearing potential",
                                    "Informed consent obtained"
                                ],
                                exclusion: [
                                    "ICH within 90 days of screening",
                                    "Other cause of ICH identified",
                                    "ALT or AST >3× upper limit of normal",
                                    "eGFR <30 mL/min/1.73m²",
                                    "Platelet count <100,000/μL",
                                    "INR >1.5 or aPTT >1.5× ULN",
                                    "Contraindication to lumbar puncture",
                                    "Active CNS infection or inflammation",
                                    "Intrathecal pump or shunt",
                                    "Spinal cord compression or injury",
                                    "History of chemical or radiation meningitis",
                                    "Pregnancy or breastfeeding",
                                    "Life expectancy <2 years",
                                    "Chronic use of anticoagulation that cannot be stopped for LP",
                                    "Prior treatment with gene therapy or oligonucleotide therapy",
                                    "Participation in another interventional trial within 30 days"
                                ]
                            },
                            {
                                name: "FASTEST Trial",
                                nct: "NCT03496883",
                                phase: "Phase 3",
                                status: "Actively recruiting",
                                description: "Recombinant Factor VIIa (rFVIIa) for acute ICH within 2 hours of symptom onset to prevent hematoma expansion",
                                inclusion: [
                                    "Age 18-80 years",
                                    "Spontaneous supratentorial ICH confirmed by CT",
                                    "ICH symptom onset ≤2 hours before treatment",
                                    "Hematoma volume 2-60 mL",
                                    "Intraventricular hemorrhage (IVH) score ≤7",
                                    "Glasgow Coma Scale ≥8",
                                    "Able to receive study drug within 2 hours of symptom onset",
                                    "Informed consent from patient or legally authorized representative"
                                ],
                                exclusion: [
                                    "On anticoagulation therapy (warfarin, DOAC, heparin)",
                                    "Known coagulopathy",
                                    "Secondary ICH:",
                                    "• Trauma",
                                    "• Known vascular malformation (AVM, aneurysm)",
                                    "• Brain tumor",
                                    "• Hemorrhagic conversion of ischemic stroke",
                                    "• Dural venous sinus thrombosis",
                                    "Brainstem hemorrhage excluded; cerebellar hemorrhage permitted",
                                    "Planned surgical evacuation within 24 hours",
                                    "Pre-existing severe disability (mRS >2)",
                                    "Known allergy to rFVIIa",
                                    "History of thromboembolic disease within 30 days",
                                    "Pregnancy",
                                    "Life expectancy <3 months from pre-existing condition"
                                ]
                            }
                        ]
                    },
                    observational: {
                        title: "Observational",
                        trials: [
                            {
                                name: "MIRROR Registry",
                                nct: "NCT04494295",
                                phase: "Observational Registry",
                                status: "",
                                description: "Minimally invasive endoscopic ICH evacuation using Aurora Surgiscope System",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Spontaneous supratentorial ICH confirmed by CT",
                                    "ICH volume ≥20mL",
                                    "Surgery planned within 24 hours of last known well",
                                    "NIHSS >5",
                                    "Baseline mRS ≤2",
                                    "GCS ≥5",
                                    "Ability to undergo general anesthesia",
                                    "Informed consent from patient or LAR"
                                ],
                                exclusion: [
                                    "Secondary ICH due to:",
                                    "• Vascular lesion (AVM, aneurysm, dural fistula)",
                                    "• Brain tumor",
                                    "• Trauma",
                                    "• Hemorrhagic transformation of ischemic stroke",
                                    "• Moyamoya disease",
                                    "Fixed and dilated pupils",
                                    "Bilateral extensor posturing",
                                    "Infratentorial or brainstem ICH",
                                    "Intraventricular hemorrhage as primary pathology",
                                    "Life expectancy <6 months from other condition",
                                    "Uncorrectable coagulopathy (INR >1.4, platelets <100,000)",
                                    "Known pregnancy",
                                    "Prisoner or ward of state",
                                    "Participation in another interventional trial"
                                ]
                            },
                            {
                                name: "DISCOVERY Study (ICH Cohort)",
                                nct: "NCT04916210",
                                phase: "Observational",
                                status: "",
                                description: "Cognitive trajectories and biomarkers after ICH",
                                inclusion: [
                                    "Age ≥18 years",
                                    "Admitted with intracerebral hemorrhage",
                                    "Radiographic confirmation of ICH",
                                    "Baseline visit within 6 weeks of ICH",
                                    "Fluent in English or Spanish",
                                    "Has study partner with regular contact",
                                    "Expected survival ≥1 year"
                                ],
                                exclusion: [
                                    "Pre-existing dementia",
                                    "Unable to complete cognitive testing",
                                    "Concurrent enrollment in cognitive intervention trial",
                                    "Active substance abuse",
                                    "Severe psychiatric illness",
                                    "Terminal illness with life expectancy <1 year"
                                ]
                            }
                        ]
                    }
                }
            },
            rehab: {
                title: "Rehabilitation",
                trials: [
                    {
                        name: "MR-PICS Study",
                        nct: "NCT06506279",
                        phase: "Phase 2",
                        status: "",
                        description: "Motor Recovery through Plasticity-Inducing Cortical Stimulation using CorTec Brain Interchange System for chronic stroke recovery",
                        inclusion: [
                            "Post-ischemic stroke patients with upper extremity deficit",
                            "Chronic stroke (minimum 6 months post-stroke)",
                            "Age 22-80 years",
                            "Able to participate meaningfully in rehabilitation (Upper Extremity Fugl-Meyer score 25-45)",
                            "Disability measured between 3-4 on modified Rankin Scale",
                            "Minimum 30% preservation of corticospinal tract integrity",
                            "Ability to provide informed consent",
                            "Medically stable and cleared for neurosurgical procedure",
                            "Willingness to comply with study protocol and follow-up visits",
                            "Access to caregiver support during recovery period"
                        ],
                        exclusion: [
                            "Seizure disorder or history of seizures",
                            "Contraindications to neurosurgical procedures",
                            "Contraindications to MRI scanning",
                            "Active psychiatric condition that would interfere with participation",
                            "Pregnancy or nursing",
                            "Life expectancy less than 2 years",
                            "Current participation in other interventional clinical trials",
                            "Inability to stop anti-platelet medications 7 days before and 3 days after surgery",
                            "Therapeutic anticoagulation that cannot be safely interrupted",
                            "Active substance abuse or dependence",
                            "Severe cognitive impairment preventing informed consent",
                            "Glenohumeral subluxation, adhesive capsulitis, or upper extremity contractures with associated pain that would limit participation",
                            "Implanted electronic devices incompatible with study procedures",
                            "Prior brain surgery or cranial implants",
                            "Hemorrhagic stroke (intracerebral hemorrhage excluded)",
                            "Bilateral stroke or multiple stroke locations"
                        ]
                    }
                ]
            },
            cadasil: {
                title: "CADASIL",
                trials: [
                    {
                        name: "CADASIL Registry",
                        nct: "NCT05567744",
                        phase: "Observational Registry",
                        status: "",
                        description: "Longitudinal registry for genetically confirmed or suspected CADASIL",
                        inclusion: [
                            "Confirmed NOTCH3 mutation or suspected CADASIL",
                            "Age ≥18 years"
                        ],
                        exclusion: [
                            "Unable to provide consent"
                        ]
                    }
                ]
            }
          };

          // =================================================================
          // TRIAL ELIGIBILITY CONFIG - Modular structure for easy modification
          // Adding a new trial = Adding an object to this config
          // =================================================================
          const TRIAL_ELIGIBILITY_CONFIG = {
            SISTER: {
              id: 'SISTER',
              name: 'SISTER Trial',
              nct: 'NCT05948566',
              category: 'ischemic',
              quickDescription: 'Late thrombolysis (4.5-24h) for anterior circulation stroke, no TNK/EVT',
              lookingFor: [
                'Anterior circulation stroke',
                'Late presenter (4.5-24h from LKW)',
                'NOT getting TNK or EVT',
                'Has salvageable tissue on CTP (mismatch profile)'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age) >= 18, required: true },
                { id: 'nihss', label: 'NIHSS ≥6 (or 4-5 disabling)', field: 'nihss', evaluate: (data) => parseInt(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss) >= 4, required: true },
                { id: 'timeWindow', label: '4.5-24h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs >= 4.5 && hrs <= 24;
                  }, required: true },
                { id: 'noTNK', label: 'No IV thrombolysis', field: 'tnkRecommended', evaluate: (data) => data.telestrokeNote?.tnkRecommended === false, required: true },
                { id: 'noEVT', label: 'No EVT planned', field: 'evtRecommended', evaluate: (data) => data.telestrokeNote?.evtRecommended === false, required: true },
                { id: 'aspects', label: 'ASPECTS ≥6', field: 'aspects', evaluate: (data) => parseInt(data.aspectsScore) >= 6, required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS ≤2', field: 'premorbidMRS', evaluate: (data) => parseInt(data.telestrokeNote?.premorbidMRS) <= 2, required: true },
                { id: 'ctpMismatch', label: 'CTP mismatch profile', field: 'ctpResults', evaluate: (data) => {
                    const ctp = (data.telestrokeNote?.ctpResults || '').toLowerCase();
                    return ctp.includes('mismatch') || ctp.includes('penumbra') || ctp.includes('salvageable');
                  }, required: true }
              ],
              exclusionFlags: [
                { id: 'priorStroke90d', label: 'Prior stroke <90 days', field: 'priorStroke90d' },
                { id: 'priorICH', label: 'Prior intracranial hemorrhage', field: 'priorICH' },
                { id: 'onAnticoag', label: 'On anticoagulation', field: 'noAnticoagulants', evaluate: (data) => data.telestrokeNote?.noAnticoagulants === false }
              ]
            },
            STEP: {
              id: 'STEP',
              name: 'STEP-EVT Trial',
              nct: 'NCT06289985',
              category: 'ischemic',
              quickDescription: 'Adaptive platform for mild LVO or medium/distal vessel occlusions',
              lookingFor: [
                'Two domains: Low NIHSS with LVO, OR Medium/Distal Vessel Occlusion',
                'Low NIHSS (0-5) + ICA/M1 occlusion, or',
                'M2/M3/M4, A1-A3, P1-P3 occlusion regardless of NIHSS'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age) >= 18, required: true },
                { id: 'timeWindow', label: 'Within 24h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs <= 24;
                  }, required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS ≤2', field: 'premorbidMRS', evaluate: (data) => parseInt(data.telestrokeNote?.premorbidMRS) <= 2, required: true },
                { id: 'vesselOcclusion', label: 'LVO or MeVO present', field: 'vesselOcclusion', evaluate: (data) => {
                    const occlusion = data.telestrokeNote?.vesselOcclusion || [];
                    return occlusion.length > 0;
                  }, required: true },
                { id: 'domainMatch', label: 'Matches Low-NIHSS or MeVO domain', field: 'nihss', evaluate: (data) => {
                    const nihss = parseInt(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss);
                    const occlusion = data.telestrokeNote?.vesselOcclusion || [];
                    // Low NIHSS domain: NIHSS 0-5 with ICA or M1
                    const lowNIHSSMatch = nihss <= 5 && (occlusion.includes('ICA') || occlusion.includes('M1'));
                    // MeVO domain: M2, M3, A1-A3, P1-P3
                    const mevoMatch = occlusion.some(v => ['M2', 'M3', 'M4', 'A1', 'A2', 'A3', 'P1', 'P2', 'P3'].includes(v));
                    return lowNIHSSMatch || mevoMatch;
                  }, required: true }
              ],
              exclusionFlags: [
                { id: 'pregnancy', label: 'Pregnancy', field: 'pregnancy' },
                { id: 'hemorrhage', label: 'Evidence of hemorrhage', field: 'hemorrhage' }
              ]
            },
            PICASSO: {
              id: 'PICASSO',
              name: 'PICASSO Trial',
              nct: 'NCT05611242',
              category: 'ischemic',
              quickDescription: 'Tandem lesion: carotid stenosis + intracranial LVO',
              lookingFor: [
                'Tandem lesion (carotid + intracranial)',
                'Extracranial ICA stenosis 70-100%',
                'Plus intracranial LVO (ICA-T, M1, proximal M2)'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age 18-79', field: 'age', evaluate: (data) => {
                    const age = parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age);
                    return age >= 18 && age <= 79;
                  }, required: true },
                { id: 'timeWindow', label: 'Within 16h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs <= 16;
                  }, required: true },
                { id: 'nihss', label: 'NIHSS ≥4', field: 'nihss', evaluate: (data) => parseInt(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss) >= 4, required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS 0-2', field: 'premorbidMRS', evaluate: (data) => parseInt(data.telestrokeNote?.premorbidMRS) <= 2, required: true },
                { id: 'aspects', label: 'ASPECTS ≥7', field: 'aspects', evaluate: (data) => parseInt(data.aspectsScore) >= 7, required: true },
                { id: 'tandemLesion', label: 'Tandem lesion present', field: 'ctaResults', evaluate: (data) => {
                    const cta = (data.telestrokeNote?.ctaResults || data.strokeCodeForm?.cta || '').toLowerCase();
                    return (cta.includes('tandem') || (cta.includes('carotid') && (cta.includes('m1') || cta.includes('ica'))));
                  }, required: true }
              ],
              exclusionFlags: []
            },
            TESTED: {
              id: 'TESTED',
              name: 'TESTED',
              nct: 'NCT05911568',
              category: 'ischemic',
              quickDescription: 'EVT in patients with pre-existing disability (mRS 3-4)',
              lookingFor: [
                'Patient with EXISTING disability (mRS 3-4)',
                'LVO stroke within 24h',
                'ASPECTS ≥3'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age) >= 18, required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS 3-4', field: 'premorbidMRS', evaluate: (data) => {
                    const mrs = parseInt(data.telestrokeNote?.premorbidMRS);
                    return mrs >= 3 && mrs <= 4;
                  }, required: true },
                { id: 'nihss', label: 'NIHSS ≥6', field: 'nihss', evaluate: (data) => parseInt(data.telestrokeNote?.nihss || data.strokeCodeForm?.nihss) >= 6, required: true },
                { id: 'timeWindow', label: 'Within 24h from LKW', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs <= 24;
                  }, required: true },
                { id: 'aspects', label: 'ASPECTS ≥3', field: 'aspects', evaluate: (data) => parseInt(data.aspectsScore) >= 3, required: true },
                { id: 'lvo', label: 'LVO present', field: 'vesselOcclusion', evaluate: (data) => {
                    const occlusion = data.telestrokeNote?.vesselOcclusion || [];
                    return occlusion.some(v => ['ICA', 'M1', 'M2'].includes(v));
                  }, required: true }
              ],
              exclusionFlags: []
            },
            SATURN: {
              id: 'SATURN',
              name: 'SATURN Trial',
              nct: 'NCT03936361',
              category: 'ich',
              quickDescription: 'Statin continuation vs discontinuation after lobar ICH',
              lookingFor: [
                'Lobar ICH (NOT deep/basal ganglia)',
                'Already on statin therapy',
                'Age ≥50'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥50', field: 'age', evaluate: (data) => parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age) >= 50, required: true },
                { id: 'lobarICH', label: 'Lobar ICH location', field: 'ichLocation', evaluate: (data) => {
                    const loc = (data.ichLocation || '').toLowerCase();
                    return loc.includes('lobar') || loc.includes('cortical');
                  }, required: true },
                { id: 'onStatin', label: 'On statin at ICH onset', field: 'onStatin', evaluate: (data) => data.onStatin === true, required: true },
                { id: 'mrs', label: 'mRS ≤4 at randomization', field: 'mrsScore', evaluate: (data) => parseInt(data.mrsScore) <= 4, required: true }
              ],
              exclusionFlags: [
                { id: 'deepICH', label: 'Deep/non-lobar ICH', field: 'ichLocation' },
                { id: 'recentMI', label: 'Recent MI <3 months', field: 'recentMI' }
              ]
            },
            ASPIRE: {
              id: 'ASPIRE',
              name: 'ASPIRE Trial',
              nct: 'NCT03907046',
              category: 'ich',
              quickDescription: 'Apixaban vs aspirin post-ICH in atrial fibrillation',
              lookingFor: [
                'ICH patient with atrial fibrillation',
                'Randomize 14-180 days post-ICH',
                'CHA2DS2-VASc ≥2'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age) >= 18, required: true },
                { id: 'ichConfirmed', label: 'ICH confirmed', field: 'diagnosis', evaluate: (data) => {
                    const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                    return dx.includes('ich') || dx.includes('hemorrhage') || dx.includes('hemorrhagic');
                  }, required: true },
                { id: 'afib', label: 'Atrial fibrillation', field: 'pmh', evaluate: (data) => {
                    const pmh = (data.telestrokeNote?.pmh || '').toLowerCase();
                    return pmh.includes('afib') || pmh.includes('atrial fib') || pmh.includes('af ') || pmh.includes('a-fib');
                  }, required: true },
                { id: 'mrs', label: 'mRS ≤4', field: 'mrsScore', evaluate: (data) => parseInt(data.mrsScore) <= 4, required: true }
              ],
              exclusionFlags: [
                { id: 'mechValve', label: 'Mechanical heart valve', field: 'mechValve' }
              ]
            },
            FASTEST: {
              id: 'FASTEST',
              name: 'FASTEST Trial',
              nct: 'NCT03496883',
              category: 'ich',
              quickDescription: 'rFVIIa within 2 hours of ICH onset for hematoma expansion prevention',
              lookingFor: [
                'Acute ICH within 2 HOURS of symptom onset',
                'Hematoma volume 2-60 mL',
                'Not on anticoagulants',
                'Age 18-80'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age 18-80', field: 'age', evaluate: (data) => {
                    const age = parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age);
                    return age >= 18 && age <= 80;
                  }, required: true },
                { id: 'ichConfirmed', label: 'ICH confirmed on imaging', field: 'diagnosis', evaluate: (data) => {
                    const dx = (data.telestrokeNote?.diagnosis || data.strokeCodeForm?.diagnosis || '').toLowerCase();
                    const ct = (data.telestrokeNote?.ctResults || data.strokeCodeForm?.ctResults || '').toLowerCase();
                    return dx.includes('ich') || dx.includes('hemorrhage') || ct.includes('hemorrhage') || ct.includes('bleed');
                  }, required: true },
                { id: 'timeWindow', label: 'Within 2h of onset', field: 'lkw', evaluate: (data) => {
                    const hrs = data.hoursFromLKW;
                    return hrs !== null && hrs <= 2;
                  }, required: true },
                { id: 'volume', label: 'Hematoma 2-60 mL', field: 'ichVolume', evaluate: (data) => {
                    const vol = parseFloat(data.ichVolume);
                    return !isNaN(vol) && vol >= 2 && vol <= 60;
                  }, required: true },
                { id: 'noAnticoag', label: 'Not on anticoagulants', field: 'noAnticoagulants', evaluate: (data) => {
                    return data.telestrokeNote?.noAnticoagulants === true;
                  }, required: true },
                { id: 'gcs', label: 'GCS ≥8 (not deeply comatose)', field: 'gcs', evaluate: (data) => {
                    const gcs = parseInt(data.gcsScore);
                    return !isNaN(gcs) && gcs >= 8;
                  }, required: true },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS ≤2', field: 'premorbidMRS', evaluate: (data) => {
                    const mrs = parseInt(data.telestrokeNote?.premorbidMRS);
                    return !isNaN(mrs) && mrs <= 2;
                  }, required: true }
              ],
              exclusionFlags: [
                { id: 'onAnticoag', label: 'On anticoagulation', field: 'onAnticoag' },
                { id: 'largeIVH', label: 'IVH score >7', field: 'largeIVH' },
                { id: 'brainstem', label: 'Brainstem hemorrhage', field: 'brainstemICH' },
                { id: 'secondary', label: 'Secondary ICH (trauma, AVM, tumor)', field: 'secondaryICH' }
              ]
            },
            VERIFY: {
              id: 'VERIFY',
              name: 'VERIFY Study',
              nct: 'NCT05338697',
              category: 'ischemic',
              quickDescription: 'Observational: TMS/MRI to predict motor recovery',
              lookingFor: [
                'Acute ischemic stroke within 7 days',
                'Upper extremity weakness',
                'Inpatient enrollment opportunity'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age) >= 18, required: true },
                { id: 'ueWeakness', label: 'Upper extremity weakness', field: 'symptoms', evaluate: (data) => {
                    const sx = (data.telestrokeNote?.symptoms || '').toLowerCase();
                    return sx.includes('arm') || sx.includes('upper') || sx.includes('hand') || sx.includes('weakness');
                  }, required: false },
                { id: 'premorbidMRS', label: 'Pre-stroke mRS ≤2', field: 'premorbidMRS', evaluate: (data) => parseInt(data.telestrokeNote?.premorbidMRS) <= 2, required: true }
              ],
              exclusionFlags: [
                { id: 'seizures', label: 'History of seizures', field: 'seizures' },
                { id: 'implants', label: 'Implanted devices (pacemaker, etc.)', field: 'implants' }
              ]
            },
            DISCOVERY: {
              id: 'DISCOVERY',
              name: 'DISCOVERY Study',
              nct: 'NCT04916210',
              category: 'ischemic',
              quickDescription: 'Observational: Cognitive trajectories post-stroke',
              lookingFor: [
                'Any stroke type (AIS, ICH, SAH)',
                'Baseline visit within 6 weeks',
                'Able to complete cognitive testing'
              ],
              keyCriteria: [
                { id: 'age', label: 'Age ≥18', field: 'age', evaluate: (data) => parseInt(data.telestrokeNote?.age || data.strokeCodeForm?.age) >= 18, required: true },
                { id: 'strokeConfirmed', label: 'Stroke confirmed', field: 'diagnosis', evaluate: (data) => {
                    const dx = (data.telestrokeNote?.diagnosis || '').toLowerCase();
                    return dx.includes('stroke') || dx.includes('ischemic') || dx.includes('ich') || dx.includes('sah');
                  }, required: true }
              ],
              exclusionFlags: [
                { id: 'preDementia', label: 'Pre-existing dementia', field: 'preDementia' }
              ]
            }
          };

          // =================================================================
          // ELIGIBILITY EVALUATION FUNCTION
          // =================================================================
          const evaluateTrialEligibility = (trialId, data) => {
            const config = TRIAL_ELIGIBILITY_CONFIG[trialId];
            if (!config) return null;

            const results = {
              trialId,
              trialName: config.name,
              category: config.category,
              quickDescription: config.quickDescription,
              lookingFor: config.lookingFor,
              criteria: [],
              exclusions: [],
              status: 'pending', // 'eligible', 'not_eligible', 'needs_info', 'pending'
              metCount: 0,
              notMetCount: 0,
              unknownCount: 0,
              requiredMissing: 0
            };

            // Evaluate key criteria
            config.keyCriteria.forEach(criterion => {
              let status = 'unknown';
              let value = null;

              try {
                const evalResult = criterion.evaluate(data);
                if (evalResult === true) {
                  status = 'met';
                  results.metCount++;
                } else if (evalResult === false) {
                  status = 'not_met';
                  results.notMetCount++;
                  if (criterion.required) results.requiredMissing++;
                } else {
                  status = 'unknown';
                  results.unknownCount++;
                }
              } catch (e) {
                status = 'unknown';
                results.unknownCount++;
              }

              results.criteria.push({
                id: criterion.id,
                label: criterion.label,
                status,
                required: criterion.required
              });
            });

            // Evaluate exclusion flags
            config.exclusionFlags.forEach(exclusion => {
              let triggered = false;
              try {
                if (exclusion.evaluate) {
                  triggered = exclusion.evaluate(data);
                } else {
                  triggered = data[exclusion.field] === true;
                }
              } catch (e) {
                triggered = false;
              }

              if (triggered) {
                results.exclusions.push({
                  id: exclusion.id,
                  label: exclusion.label,
                  triggered: true
                });
                results.notMetCount++;
                results.status = 'not_eligible';
              }
            });

            // Determine overall status
            if (results.exclusions.some(e => e.triggered)) {
              results.status = 'not_eligible';
            } else if (results.requiredMissing > 0) {
              results.status = 'not_eligible';
            } else if (results.unknownCount > 0) {
              results.status = 'needs_info';
            } else if (results.notMetCount === 0) {
              results.status = 'eligible';
            } else {
              results.status = 'not_eligible';
            }

            return results;
          };

          // Evaluate all trials for current patient
          const evaluateAllTrials = (data) => {
            const results = {};
            Object.keys(TRIAL_ELIGIBILITY_CONFIG).forEach(trialId => {
              results[trialId] = evaluateTrialEligibility(trialId, data);
            });
            return results;
          };

          // Trial eligibility state
          const [trialEligibility, setTrialEligibility] = useState({});

          // Toggle trial details

          // Create trial card component
          const TrialCard = ({ trial, category }) => {
            const [isExpanded, setIsExpanded] = React.useState(false);
            
            const getCategoryColor = (cat) => {
              switch(cat) {
                case 'ischemic': return 'bg-blue-600 text-white';
                case 'ich': return 'bg-red-600 text-white';
                case 'rehab': return 'bg-green-600 text-white';
                case 'cadasil': return 'bg-purple-600 text-white';
                default: return 'bg-gray-600 text-white';
              }
            };
            
            const getCategoryBorderColor = (cat) => {
              switch(cat) {
                case 'ischemic': return 'border-blue-200';
                case 'ich': return 'border-red-200';
                case 'rehab': return 'border-green-200';
                case 'cadasil': return 'border-purple-200';
                default: return 'border-gray-200';
              }
            };
            
            return (
              <div className={`bg-white rounded-lg shadow-md overflow-hidden border-2 ${getCategoryBorderColor(category)} hover:shadow-lg transition-shadow`}>
                <div 
                  className={`${getCategoryColor(category)} p-4 cursor-pointer`}
                  onClick={() => setIsExpanded(!isExpanded)}
                >
                  <div className="flex justify-between items-start">
                    <div className="flex-1">
                      <h3 className="text-xl font-bold mb-2">{trial.name}</h3>
                      <div className="flex flex-wrap gap-2 mb-3">
                        <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-semibold">
                          {trial.phase}
                        </span>
                        {trial.status && (
                          <span className="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-semibold">
                            {trial.status}
                          </span>
                        )}
                      </div>
                      <p className="text-white text-opacity-95">{trial.description}</p>
                    </div>
                    <div className="ml-4">
                      <svg 
                        className={`w-6 h-6 transform transition-transform ${isExpanded ? 'rotate-180' : ''}`} 
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </div>
                  </div>
                  <div className="mt-3 flex items-center">
                    {trial.nct.startsWith('NCT') ? (
                      <button 
                        className="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center"
                        onClick={(e) => {
                          e.stopPropagation();
                          window.open(`https://clinicaltrials.gov/study/${trial.nct}`, '_blank');
                        }}
                      >
                        <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                        {trial.nct}
                      </button>
                    ) : (
                      <span className="text-sm opacity-90">Reference: {trial.nct}</span>
                    )}
                  </div>
                </div>
                
                {isExpanded && (
                  <div className="bg-gray-50 p-4 border-t-2 border-gray-200">
                    <div className="grid md:grid-cols-2 gap-6">
                      <div>
                        <h4 className="font-bold text-green-700 mb-3 text-lg">✓ Inclusion Criteria</h4>
                        <ul className="space-y-2">
                          {trial.inclusion.map((item, idx) => (
                            <li key={idx} className="flex items-start">
                              <span className="text-green-500 mr-2 mt-1">•</span>
                              <span className="text-gray-700 text-sm">{item}</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                      <div>
                        <h4 className="font-bold text-red-700 mb-3 text-lg">✗ Exclusion Criteria</h4>
                        <ul className="space-y-2">
                          {trial.exclusion.map((item, idx) => (
                            <li key={idx} className="flex items-start">
                              <span className="text-red-500 mr-2 mt-1">•</span>
                              <span className="text-gray-700 text-sm">{item}</span>
                            </li>
                          ))}
                        </ul>
                      </div>
                    </div>
                    {trial.nct.startsWith('NCT') && (
                      <div className="mt-6 pt-4 border-t border-gray-200 text-center">
                        <button 
                          className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors inline-flex items-center"
                          onClick={() => window.open(`https://clinicaltrials.gov/study/${trial.nct}`, '_blank')}
                        >
                          <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                          View Full Details on ClinicalTrials.gov
                        </button>
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          };


          // NIH Stroke Scale items
          const nihssItems = [
            { id: 'consciousness', name: '1a. Level of Consciousness', options: ['Alert (0)', 'Drowsy (1)', 'Stuporous (2)', 'Coma (3)'] },
            { id: 'loc_questions', name: '1b. LOC Questions', options: ['Both correct (0)', 'One correct (1)', 'Neither correct (2)'] },
            { id: 'loc_commands', name: '1c. LOC Commands', options: ['Obeys both correctly (0)', 'Obeys one correctly (1)', 'Neither correctly (2)'] },
            { id: 'best_gaze', name: '2. Best Gaze', options: ['Normal (0)', 'Partial gaze palsy (1)', 'Forced deviation (2)'] },
            { id: 'visual', name: '3. Visual', options: ['No visual loss (0)', 'Partial hemianopia (1)', 'Complete hemianopia (2)', 'Bilateral hemianopia (3)'] },
            { id: 'facial_palsy', name: '4. Facial Palsy', options: ['Normal (0)', 'Minor asymmetry (1)', 'Partial facial paralysis (2)', 'Complete facial paralysis (3)'] },
            { id: 'motor_arm_left', name: '5a. Motor Arm-Left', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_arm_right', name: '5b. Motor Arm-Right', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_leg_left', name: '6a. Motor Leg-Left', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'motor_leg_right', name: '6b. Motor Leg-Right', options: ['No drift (0)', 'Drift (1)', 'Some effort against gravity (2)', 'No effort against gravity (3)', 'No movement (4)'] },
            { id: 'limb_ataxia', name: '7. Limb Ataxia', options: ['Absent (0)', 'Present in upper or lower (1)', 'Present in both (2)'] },
            { id: 'sensory', name: '8. Sensory', options: ['Normal (0)', 'Partial loss (1)', 'Dense loss (2)'] },
            { id: 'language', name: '9. Best Language†', options: ['No aphasia (0)', 'Mild-moderate aphasia (1)', 'Severe aphasia (2)', 'Mute, global aphasia (3)'] },
            { id: 'dysarthria', name: '10. Dysarthria†', options: ['Normal articulation (0)', 'Mild-moderate slurring (1)', 'Severe dysarthria (2)', 'Intubated/other (2)'] },
            { id: 'extinction', name: '11. Extinction and Inattention', options: ['No neglect (0)', 'Visual, tactile, auditory, spatial, or personal inattention (1)', 'Profound hemi-inattention (2)'] }
          ];

          // Calculate NIHSS score
          const calculateNIHSS = (responses) => {
            return Object.values(responses).reduce((total, response) => {
              const score = parseInt(response?.split('(')[1]?.split(')')[0] || 0);
              return total + score;
            }, 0);
          };

          // Calculate ASPECTS score
          const calculateASPECTS = (regions) => {
            return regions.filter(region => region.checked).length;
          };

          // Calculate PC-ASPECTS score
          const calculatePCAspects = (regions) => {
            return regions.reduce((total, region) => {
              return total + (region.checked ? region.points : 0);
            }, 0);
          };

          // Calculate GCS score
          const calculateGCS = (items) => {
            return parseInt(items.eye || 0) + parseInt(items.verbal || 0) + parseInt(items.motor || 0);
          };

          // Calculate ICH score
          const calculateICHScore = (items) => {
            let score = 0;
            if (items.gcs === 'gcs34') score += 2;
            else if (items.gcs === 'gcs512') score += 1;
            if (items.age80) score += 1;
            if (items.volume30) score += 1;
            if (items.ivh) score += 1;
            if (items.infratentorial) score += 1;
            return score;
          };

          // Calculate ABCD2 score
          const calculateABCD2Score = (items) => {
            let score = 0;
            if (items.age60) score += 1;
            if (items.bp) score += 1;
            if (items.unilateralWeakness) score += 2;
            if (items.speechDisturbance) score += 1;
            if (items.duration === 'duration10') score += 1;
            else if (items.duration === 'duration60') score += 2;
            if (items.diabetes) score += 1;
            return score;
          };

          // Calculate CHADS2-VASc score
          const calculateCHADS2VascScore = (items) => {
            let score = 0;
            if (items.chf) score += 1;
            if (items.hypertension) score += 1;
            if (items.age75) score += 2;
            if (items.diabetes) score += 1;
            if (items.strokeTia) score += 2;
            if (items.vascular) score += 1;
            if (items.age65) score += 1;
            if (items.female) score += 1;
            return score;
          };

          // Calculate ROPE score
          const calculateROPEScore = (items) => {
            let score = 0;
            if (items.noHypertension) score += 1;
            if (items.noDiabetes) score += 1;
            if (items.noStrokeTia) score += 1;
            if (items.nonsmoker) score += 1;
            if (items.cortical) score += 1;

            // Age points
            const age = parseInt(items.age) || 0;
            if (age >= 18 && age <= 29) score += 5;
            else if (age >= 30 && age <= 39) score += 4;
            else if (age >= 40 && age <= 49) score += 3;
            else if (age >= 50 && age <= 59) score += 2;
            else if (age >= 60 && age <= 69) score += 1;
            // 70+ years gets 0 points

            return score;
          };

          // Calculate HAS-BLED score
          const calculateHASBLEDScore = (items) => {
            let score = 0;
            if (items.hypertension) score += 1;
            if (items.renalDisease) score += 1;
            if (items.liverDisease) score += 1;
            if (items.stroke) score += 1;
            if (items.bleeding) score += 1;
            if (items.labileINR) score += 1;
            if (items.elderly) score += 1;
            if (items.drugs) score += 1;
            if (items.alcohol) score += 1;
            return score;
          };

          // Calculate RCVS2 score
          const calculateRCVS2Score = (items) => {
            let score = 0;
            if (items.recurrentTCH) score += 5;
            if (items.carotidInvolvement) score += 3;
            if (items.vasoconstrictiveTrigger) score += 2;
            if (items.female) score += 1;
            if (items.sah) score -= 2;
            return score;
          };

          // =================================================================
          // TNK DOSING CALCULATOR (0.25 mg/kg, max 25 mg)
          // =================================================================
          const calculateTNKDose = (weightKg) => {
            const weight = parseFloat(weightKg);
            if (isNaN(weight) || weight <= 0) return null;

            // TNK dosing: 0.25 mg/kg, maximum 25 mg
            const rawDose = weight * 0.25;
            const finalDose = Math.min(rawDose, 25);

            // Pre-calculated doses for common weight ranges
            const doseTable = [
              { minWeight: 0, maxWeight: 59.9, dose: 'Variable (0.25 mg/kg)', vial: 'Calculate' },
              { minWeight: 60, maxWeight: 69.9, dose: '15-17.5 mg', vial: '3-3.5 mL' },
              { minWeight: 70, maxWeight: 79.9, dose: '17.5-20 mg', vial: '3.5-4 mL' },
              { minWeight: 80, maxWeight: 89.9, dose: '20-22.5 mg', vial: '4-4.5 mL' },
              { minWeight: 90, maxWeight: 99.9, dose: '22.5-25 mg', vial: '4.5-5 mL' },
              { minWeight: 100, maxWeight: Infinity, dose: '25 mg (MAX)', vial: '5 mL' }
            ];

            return {
              weightKg: weight,
              calculatedDose: finalDose.toFixed(1),
              isMaxDose: rawDose >= 25,
              doseTable
            };
          };

          // =================================================================
          // BP THRESHOLD CHECKER FOR THROMBOLYSIS
          // =================================================================
          const getBPThresholdStatus = (bpString) => {
            if (!bpString || typeof bpString !== 'string') {
              return { status: 'unknown', systolic: null, diastolic: null };
            }

            const bpMatch = bpString.match(/(\d+)\s*\/\s*(\d+)/);
            if (!bpMatch) {
              return { status: 'unknown', systolic: null, diastolic: null };
            }

            const systolic = parseInt(bpMatch[1]);
            const diastolic = parseInt(bpMatch[2]);

            if (isNaN(systolic) || isNaN(diastolic)) {
              return { status: 'unknown', systolic: null, diastolic: null };
            }

            // Thresholds for TNK/tPA eligibility
            const MAX_SBP = 185;
            const MAX_DBP = 110;
            const BORDERLINE_SBP_LOW = 175;
            const BORDERLINE_DBP_LOW = 105;

            let status = 'ok';
            let message = 'OK for lysis';
            let badgeClass = 'bg-green-100 text-green-800 border-green-300';
            let icon = String.fromCharCode(0x2713); // checkmark

            // Check if too high (absolute contraindication)
            if (systolic > MAX_SBP || diastolic > MAX_DBP) {
              status = 'too_high';
              message = 'Too high for TNK';
              badgeClass = 'bg-red-100 text-red-800 border-red-300';
              icon = String.fromCharCode(0x1F6AB); // prohibited sign
            }
            // Check if borderline
            else if ((systolic >= BORDERLINE_SBP_LOW && systolic <= MAX_SBP) ||
                     (diastolic >= BORDERLINE_DBP_LOW && diastolic <= MAX_DBP)) {
              status = 'borderline';
              message = 'Borderline';
              badgeClass = 'bg-yellow-100 text-yellow-800 border-yellow-300';
              icon = String.fromCharCode(0x26A0); // warning sign
            }

            // Calculate how much to lower if too high
            const sbpToLower = Math.max(0, systolic - MAX_SBP);
            const dbpToLower = Math.max(0, diastolic - MAX_DBP);

            return {
              status,
              systolic,
              diastolic,
              message,
              badgeClass,
              icon,
              sbpToLower,
              dbpToLower,
              needsLowering: sbpToLower > 0 || dbpToLower > 0
            };
          };

          // =================================================================
          // 4-FACTOR PCC (KCENTRA) DOSING CALCULATOR
          // =================================================================
          const calculate4FPCC = (weightKg, inr) => {
            const weight = parseFloat(weightKg);
            const inrValue = parseFloat(inr);
            if (isNaN(weight) || weight <= 0) return null;

            let unitsPerKg;
            let description;

            if (isNaN(inrValue) || inrValue < 2) {
              unitsPerKg = 25;
              description = 'INR <2 or unknown';
            } else if (inrValue >= 2 && inrValue <= 4) {
              unitsPerKg = 25;
              description = 'INR 2-4';
            } else if (inrValue > 4 && inrValue <= 6) {
              unitsPerKg = 35;
              description = 'INR 4-6';
            } else {
              unitsPerKg = 50;
              description = 'INR >6';
            }

            const totalDose = Math.min(weight * unitsPerKg, 5000); // Max 5000 IU

            return {
              weightKg: weight,
              inr: inrValue || 'unknown',
              unitsPerKg,
              totalDose: Math.round(totalDose),
              isMaxDose: weight * unitsPerKg >= 5000,
              description
            };
          };

          // =================================================================
          // DTN (DOOR-TO-NEEDLE) TIME CALCULATIONS
          // =================================================================
          const calculateDTNMetrics = () => {
            const metrics = {
              doorToCT: null,
              doorToNeedle: null,
              ctToNeedle: null,
              timestamps: {}
            };

            // Parse timestamps
            const edArrival = telestrokeNote.dtnEdArrival ? new Date(telestrokeNote.dtnEdArrival) : null;
            const ctStarted = telestrokeNote.dtnCtStarted ? new Date(telestrokeNote.dtnCtStarted) : null;
            const ctRead = telestrokeNote.dtnCtRead ? new Date(telestrokeNote.dtnCtRead) : null;
            const tnkAdmin = telestrokeNote.dtnTnkAdministered ? new Date(telestrokeNote.dtnTnkAdministered) : null;

            metrics.timestamps = {
              edArrival,
              strokeAlert: telestrokeNote.dtnStrokeAlert ? new Date(telestrokeNote.dtnStrokeAlert) : null,
              ctStarted,
              ctRead,
              tnkOrdered: telestrokeNote.dtnTnkOrdered ? new Date(telestrokeNote.dtnTnkOrdered) : null,
              tnkAdmin
            };

            // Door-to-CT: ED Arrival → CT started
            if (edArrival && ctStarted) {
              const diffMs = ctStarted - edArrival;
              const diffMins = Math.round(diffMs / (1000 * 60));
              metrics.doorToCT = diffMins;
            }

            // Door-to-Needle (DTN): ED Arrival → TNK administered
            if (edArrival && tnkAdmin) {
              const diffMs = tnkAdmin - edArrival;
              const diffMins = Math.round(diffMs / (1000 * 60));
              metrics.doorToNeedle = diffMins;
            }

            // CT-to-Needle: CT read → TNK administered
            if (ctRead && tnkAdmin) {
              const diffMs = tnkAdmin - ctRead;
              const diffMins = Math.round(diffMs / (1000 * 60));
              metrics.ctToNeedle = diffMins;
            }

            return metrics;
          };

          // Get DTN benchmark status and color
          const getDTNBenchmark = (dtnMinutes) => {
            if (dtnMinutes === null) return null;
            if (dtnMinutes <= 45) {
              return {
                status: 'excellent',
                color: 'green',
                label: 'Excellent',
                target: 45,
                delta: dtnMinutes - 45
              };
            } else if (dtnMinutes <= 60) {
              return {
                status: 'good',
                color: 'yellow',
                label: 'Good',
                target: 60,
                delta: dtnMinutes - 45 // Compare to ideal target
              };
            } else {
              return {
                status: 'needs_improvement',
                color: 'red',
                label: 'Needs Improvement',
                target: 60,
                delta: dtnMinutes - 60
              };
            }
          };

          // Format DTN metrics for Epic note
          const formatDTNForNote = () => {
            const metrics = calculateDTNMetrics();
            if (!metrics.doorToNeedle) return '';

            const benchmark = getDTNBenchmark(metrics.doorToNeedle);
            let noteText = '\nTime Metrics:\n';

            if (metrics.doorToCT !== null) {
              noteText += `Door-to-CT: ${metrics.doorToCT} minutes\n`;
            }
            noteText += `Door-to-Needle (DTN): ${metrics.doorToNeedle} minutes`;

            if (benchmark) {
              noteText += ` (${benchmark.label}`;
              if (benchmark.delta > 0) {
                noteText += `, +${benchmark.delta} min over ${benchmark.target} min target`;
              } else if (benchmark.delta < 0) {
                noteText += `, ${Math.abs(benchmark.delta)} min under ${benchmark.target} min target`;
              }
              noteText += ')';
            }
            noteText += '\n';

            if (metrics.ctToNeedle !== null) {
              noteText += `CT-to-Needle: ${metrics.ctToNeedle} minutes\n`;
            }

            return noteText;
          };

          // =================================================================
          // CONTRAINDICATION DETECTION
          // =================================================================
          const detectContraindications = (data) => {
            const alerts = [];

            // Glucose check
            const glucose = parseFloat(data.telestrokeNote?.glucose);
            if (!isNaN(glucose)) {
              if (glucose < 50) {
                alerts.push({ severity: 'critical', label: 'Hypoglycemia', message: `Glucose ${glucose} mg/dL - Correct before thrombolysis`, field: 'glucose' });
              } else if (glucose > 400) {
                alerts.push({ severity: 'critical', label: 'Hyperglycemia', message: `Glucose ${glucose} mg/dL - Correct before thrombolysis`, field: 'glucose' });
              }
            }

            // INR check
            const inr = parseFloat(data.telestrokeNote?.inr);
            if (!isNaN(inr) && inr > 1.7) {
              alerts.push({ severity: 'critical', label: 'Elevated INR', message: `INR ${inr.toFixed(1)} >1.7 - tPA/TNK CONTRAINDICATED`, field: 'inr' });
            }

            // Platelet check
            const platelets = parseFloat(data.telestrokeNote?.plateletCount);
            if (!isNaN(platelets) && platelets < 100000) {
              alerts.push({ severity: 'critical', label: 'Low Platelets', message: `${platelets.toLocaleString()}/μL <100,000 - tPA/TNK CONTRAINDICATED`, field: 'plateletCount' });
            }

            // BP check (parse from string like "185/110")
            const bp = data.telestrokeNote?.presentingBP || '';
            const bpMatch = bp.match(/(\d+)\s*\/\s*(\d+)/);
            if (bpMatch) {
              const systolic = parseInt(bpMatch[1]);
              const diastolic = parseInt(bpMatch[2]);
              if (systolic > 185 || diastolic > 110) {
                alerts.push({ severity: 'warning', label: 'Elevated BP', message: `${systolic}/${diastolic} exceeds 185/110 - Must lower before tPA/TNK`, field: 'presentingBP' });
              }
            }

            // DOAC check
            if (data.telestrokeNote?.lastDOACType && data.telestrokeNote?.lastDOACDose) {
              const lastDose = new Date(data.telestrokeNote.lastDOACDose);
              const now = new Date();
              const hoursSinceDose = (now - lastDose) / (1000 * 60 * 60);
              if (hoursSinceDose < 48) {
                alerts.push({ severity: 'warning', label: 'Recent DOAC', message: `${data.telestrokeNote.lastDOACType} within ${hoursSinceDose.toFixed(0)}h - Check drug-specific assay`, field: 'lastDOACDose' });
              }
            }

            // Age + NIHSS check (SPAN-100)
            const age = parseInt(data.telestrokeNote?.age);
            const nihss = parseInt(data.telestrokeNote?.nihss);
            if (!isNaN(age) && !isNaN(nihss) && (age + nihss >= 100)) {
              alerts.push({ severity: 'info', label: 'SPAN-100', message: `Age ${age} + NIHSS ${nihss} = ${age + nihss} ≥100 - Higher sICH risk`, field: 'nihss' });
            }

            // Time window check
            const lkwDate = data.telestrokeNote?.lkwDate;
            const lkwTime = data.telestrokeNote?.lkwTime;
            if (lkwDate && lkwTime) {
              const lkw = new Date(`${lkwDate}T${lkwTime}`);
              const now = new Date();
              const hoursFromLKW = (now - lkw) / (1000 * 60 * 60);
              if (hoursFromLKW > 4.5 && data.telestrokeNote?.tnkRecommended) {
                alerts.push({ severity: 'warning', label: 'Late Window', message: `${hoursFromLKW.toFixed(1)}h from LKW - Verify imaging criteria`, field: 'lkwTime' });
              }
            }

            return alerts;
          };

          // Create Icon component wrapper
          const Icon = ({ icon: IconComponent, size = 16 }) => {
            React.useEffect(() => {
              lucide.createIcons();
            }, []);

            return <i data-lucide={IconComponent} className="w-4 h-4 inline-block"></i>;
          };

          // PHI Protection - Data with expiration
          const PATIENT_DATA_TTL = 24 * 60 * 60 * 1000; // 24 hours

          const saveWithExpiration = (key, data) => {
            try {
              const item = {
                data: data,
                timestamp: new Date().getTime(),
                expiresAt: new Date().getTime() + PATIENT_DATA_TTL
              };
              localStorage.setItem(key, JSON.stringify(item));
              setSaveStatus('saved');
              setLastSaved(new Date());
            } catch (e) {
              setSaveStatus('error');
              console.error('Save failed:', e);
            }
          };

          const loadWithExpiration = (key, defaultValue) => {
            try {
              const item = JSON.parse(localStorage.getItem(key));
              if (!item) return defaultValue;

              if (new Date().getTime() > item.expiresAt) {
                localStorage.removeItem(key);
                return defaultValue;
              }
              return item.data;
            } catch {
              return defaultValue;
            }
          };

          // Debounce utility
          const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
              const later = () => {
                clearTimeout(timeout);
                func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
            };
          };

          // Debounced save (will be set up in useEffect)
          const debouncedSave = React.useCallback(
            debounce((key, data) => {
              setSaveStatus('saving');
              saveWithExpiration(key, data);
            }, 1000),
            []
          );

          // ============================================
          // SHIFT MANAGEMENT FUNCTIONS
          // ============================================

          // Generate unique patient ID
          const generatePatientId = () => {
            return `pt_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          };

          // Get current patient summary for display
          const getCurrentPatientSummary = () => {
            const age = telestrokeNote.age || '?';
            const sex = telestrokeNote.sex || '?';
            const symptoms = telestrokeNote.symptoms || 'Stroke symptoms';
            const nihss = telestrokeNote.nihss || nihssScore || '?';
            const timeFromLKW = calculateTimeFromLKW();
            const timeDisplay = timeFromLKW ? `${timeFromLKW.hours}h ${timeFromLKW.minutes}m` : '?';

            // Determine primary vessel/syndrome
            let vesselInfo = '';
            const vessels = telestrokeNote.vesselOcclusion || [];
            if (vessels.includes('M1')) vesselInfo = 'M1';
            else if (vessels.includes('ICA')) vesselInfo = 'ICA';
            else if (vessels.includes('M2')) vesselInfo = 'M2';
            else if (telestrokeNote.ctaResults) {
              if (telestrokeNote.ctaResults.toLowerCase().includes('m1')) vesselInfo = 'M1';
              else if (telestrokeNote.ctaResults.toLowerCase().includes('ica')) vesselInfo = 'ICA';
            }

            return {
              age,
              sex,
              symptoms: symptoms.substring(0, 30) + (symptoms.length > 30 ? '...' : ''),
              nihss,
              timeFromLKW: timeDisplay,
              vesselInfo,
              shortLabel: `${age}${sex} ${vesselInfo || 'AIS'} NIHSS ${nihss}`,
              fullLabel: `${age}yo ${sex === 'M' ? 'M' : sex === 'F' ? 'F' : '?'}, ${vesselInfo || 'Stroke'}, NIHSS ${nihss}, ${timeDisplay} from LKW`
            };
          };

          // Count trials by eligibility status
          const getTrialEligibilitySummary = () => {
            const counts = { eligible: 0, needsInfo: 0, notEligible: 0, total: 0 };
            Object.values(trialEligibility).forEach(result => {
              if (!result) return;
              counts.total++;
              if (result.status === 'eligible') counts.eligible++;
              else if (result.status === 'needs_info') counts.needsInfo++;
              else if (result.status === 'not_eligible') counts.notEligible++;
            });
            return counts;
          };

          // Generate trial eligibility text for notes (Pulsara, Epic)
          const getTrialEligibilityForNote = () => {
            const eligibleTrials = [];
            const needsInfoTrials = [];

            Object.entries(trialEligibility).forEach(([trialId, result]) => {
              if (!result) return;
              const config = TRIAL_ELIGIBILITY_CONFIG[trialId];
              if (!config) return;

              if (result.status === 'eligible') {
                eligibleTrials.push(config.name.replace(' Trial', ''));
              } else if (result.status === 'needs_info') {
                needsInfoTrials.push(config.name.replace(' Trial', ''));
              }
            });

            if (eligibleTrials.length === 0 && needsInfoTrials.length === 0) {
              return 'Clinical Trial Screening: No trial eligibility identified.';
            }

            let text = 'Clinical Trial Screening: ';
            if (eligibleTrials.length > 0) {
              text += `Potentially eligible for ${eligibleTrials.join(', ')}. `;
            }
            if (needsInfoTrials.length > 0) {
              text += `May qualify for ${needsInfoTrials.join(', ')} (additional info needed).`;
            }
            return text.trim();
          };

          // Generate shift sign-out summary for handoffs
          const generateShiftSignOut = () => {
            if (shiftPatients.length === 0) {
              return 'No patients tracked in this shift.';
            }

            let signOut = `SHIFT SIGN-OUT SUMMARY\n`;
            signOut += `Generated: ${new Date().toLocaleString()}\n`;
            signOut += `Total Patients: ${shiftPatients.length}\n\n`;

            shiftPatients.forEach((patient, index) => {
              signOut += `─────────────────────────────────────\n`;
              signOut += `${index + 1}. ${patient.summary?.fullLabel || 'Unknown Patient'}\n`;
              signOut += `   Time: ${new Date(patient.timestamp).toLocaleTimeString()}\n`;

              // Trial status
              if (patient.trialSummary?.eligible > 0) {
                signOut += `   ⚠️ TRIAL ELIGIBLE: ${patient.trialSummary.eligible} potential match(es)\n`;
              }

              // Key data
              if (patient.formState?.telestrokeNote) {
                const note = patient.formState.telestrokeNote;
                if (note.diagnosis) signOut += `   Dx: ${note.diagnosis}\n`;
                if (note.tnkRecommended) signOut += `   TNK: Recommended\n`;
                if (note.evtRecommended) signOut += `   EVT: Recommended\n`;
              }
              signOut += '\n';
            });

            signOut += `─────────────────────────────────────\n`;
            signOut += `END OF SHIFT SIGN-OUT\n`;

            return signOut;
          };

          // Save current patient to shift list
          const saveCurrentPatientToShift = () => {
            const patientId = currentPatientId || generatePatientId();
            const summary = getCurrentPatientSummary();
            const trialSummary = getTrialEligibilitySummary();

            const patientSnapshot = {
              id: patientId,
              timestamp: Date.now(),
              summary,
              trialSummary,
              // Save form state for restoration
              formState: {
                telestrokeNote: { ...telestrokeNote },
                strokeCodeForm: { ...strokeCodeForm },
                lkwTime: lkwTime ? lkwTime.toISOString() : null,
                nihssScore,
                aspectsScore,
                mrsScore,
                gcsItems: { ...gcsItems }
              }
            };

            setShiftPatients(prev => {
              // Update existing or add new
              const existingIndex = prev.findIndex(p => p.id === patientId);
              if (existingIndex >= 0) {
                const updated = [...prev];
                updated[existingIndex] = patientSnapshot;
                return updated;
              }
              return [...prev, patientSnapshot];
            });

            if (!currentPatientId) {
              setCurrentPatientId(patientId);
            }

            return patientId;
          };

          // Switch to a different patient from shift list
          const switchToPatient = (patientId) => {
            // First save current patient
            if (currentPatientId && telestrokeNote.age) {
              saveCurrentPatientToShift();
            }

            // Find and load the selected patient
            const patient = shiftPatients.find(p => p.id === patientId);
            if (!patient) return;

            const { formState } = patient;
            setTelestrokeNote(formState.telestrokeNote);
            setStrokeCodeForm(formState.strokeCodeForm);
            setLkwTime(formState.lkwTime ? new Date(formState.lkwTime) : null);
            setNihssScore(formState.nihssScore);
            setAspectsScore(formState.aspectsScore);
            setMrsScore(formState.mrsScore);
            setGcsItems(formState.gcsItems);
            setCurrentPatientId(patientId);
            setShowPatientSwitcher(false);
          };

          // Start a new patient (save current first)
          const startNewPatient = () => {
            // Save current if there's data
            if (telestrokeNote.age) {
              saveCurrentPatientToShift();
            }

            // Clear form for new patient
            resetAllData();
            setCurrentPatientId(generatePatientId());
            setShowPatientSwitcher(false);
          };

          // Remove patient from shift list
          const removePatientFromShift = (patientId) => {
            setShiftPatients(prev => prev.filter(p => p.id !== patientId));
            if (currentPatientId === patientId) {
              setCurrentPatientId(null);
            }
          };

          // ============================================
          // SIGN-OUT / HANDOFF FUNCTIONS
          // ============================================

          // Generate PHI-free patient identifier
          const generateSignOutPatientId = () => {
            const count = signOutPatients.length + 1;
            return `Pt ${count}`;
          };

          // Create PHI-free sign-out entry from current patient data
          const createSignOutEntry = (customLabel = '') => {
            const age = telestrokeNote.age || '';
            const sex = telestrokeNote.sex || '';
            const diagnosis = telestrokeNote.diagnosis || telestrokeNote.chiefComplaint || '';
            const nihss = telestrokeNote.nihss || nihssScore || '';
            const aspects = aspectsScore !== 10 ? aspectsScore : '';

            // Vessel occlusion
            let vessel = '';
            const vessels = telestrokeNote.vesselOcclusion || [];
            if (vessels.length > 0) {
              vessel = vessels.join(', ');
            } else if (telestrokeNote.ctaResults) {
              const cta = telestrokeNote.ctaResults.toLowerCase();
              if (cta.includes('m1')) vessel = 'M1';
              else if (cta.includes('m2')) vessel = 'M2';
              else if (cta.includes('ica')) vessel = 'ICA';
              else if (cta.includes('basilar')) vessel = 'Basilar';
            }

            // Time from LKW
            let timeFromLKW = '';
            const timeCalc = calculateTimeFromLKW();
            if (timeCalc) {
              timeFromLKW = `${timeCalc.hours}h ${timeCalc.minutes}m`;
            }

            // Treatment
            let treatment = [];
            if (telestrokeNote.tnkRecommended) treatment.push('TNK given');
            if (telestrokeNote.evtRecommended) treatment.push('EVT recommended');
            if (treatment.length === 0 && telestrokeNote.medications) {
              const meds = telestrokeNote.medications.toLowerCase();
              if (meds.includes('asa') || meds.includes('aspirin')) treatment.push('ASA');
              if (meds.includes('plavix') || meds.includes('clopidogrel')) treatment.push('Plavix');
            }

            // Pending items
            let pending = [];
            if (telestrokeNote.evtRecommended && !telestrokeNote.transferAccepted) pending.push('CSC transfer');
            if (telestrokeNote.tnkRecommended) pending.push('Post-tPA imaging');

            // Status/disposition
            let status = '';
            if (telestrokeNote.transferAccepted) status = 'Transferred to CSC';
            else if (telestrokeNote.disposition) status = telestrokeNote.disposition;

            return {
              id: Date.now().toString(),
              timestamp: new Date().toISOString(),
              label: customLabel || generateSignOutPatientId(),
              demographics: age && sex ? `${age}${sex}` : '',
              diagnosis: diagnosis,
              nihss: nihss,
              aspects: aspects,
              vessel: vessel,
              timeFromLKW: timeFromLKW,
              treatment: treatment.join(', '),
              pending: pending,
              status: status
            };
          };

          // Add current patient to sign-out list
          const addToSignOut = (customLabel = '') => {
            const entry = createSignOutEntry(customLabel);
            setSignOutPatients(prev => [...prev, entry]);
            saveWithExpiration('signOutPatients', [...signOutPatients, entry]);
            showSignOutNotification('Patient added to sign-out');
            return entry;
          };

          // Update sign-out entry
          const updateSignOutEntry = (id, updates) => {
            setSignOutPatients(prev => {
              const updated = prev.map(p => p.id === id ? { ...p, ...updates } : p);
              saveWithExpiration('signOutPatients', updated);
              return updated;
            });
          };

          // Remove sign-out entry
          const removeSignOutEntry = (id) => {
            setSignOutPatients(prev => {
              const updated = prev.filter(p => p.id !== id);
              saveWithExpiration('signOutPatients', updated);
              return updated;
            });
          };

          // Clear all sign-outs
          const clearAllSignOuts = () => {
            setSignOutPatients([]);
            localStorage.removeItem('signOutPatients');
          };

          // Generate formatted sign-out text for sharing
          const generateSignOutText = () => {
            if (signOutPatients.length === 0) {
              return 'No patients in sign-out list.';
            }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', {
              month: 'short', day: 'numeric', year: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('en-US', {
              hour: '2-digit', minute: '2-digit'
            });

            let text = `STROKE SIGN-OUT - ${dateStr} ${timeStr}\n`;
            text += `---\n`;

            signOutPatients.forEach((pt, index) => {
              // Header line: Label (demographics, vessel): key findings
              let header = pt.label;
              if (pt.demographics) {
                header += ` (${pt.demographics}`;
                if (pt.vessel) header += `, ${pt.vessel}`;
                header += `)`;
              }
              if (pt.diagnosis) header += `: ${pt.diagnosis}`;
              text += `${header}\n`;

              // Key findings
              let findings = [];
              if (pt.nihss) findings.push(`NIHSS ${pt.nihss}`);
              if (pt.aspects) findings.push(`ASPECTS ${pt.aspects}`);
              if (pt.vessel && !pt.demographics) findings.push(pt.vessel);
              if (findings.length > 0) {
                text += `- Findings: ${findings.join(', ')}\n`;
              }

              // Treatment
              if (pt.treatment) {
                text += `- Tx: ${pt.treatment}`;
                if (pt.timeFromLKW) text += ` (${pt.timeFromLKW} from LKW)`;
                text += `\n`;
              }

              // Pending
              if (pt.pending && pt.pending.length > 0) {
                text += `- Pending: ${pt.pending.join(', ')}\n`;
              }

              // Status
              if (pt.status) {
                text += `- Status: ${pt.status}\n`;
              }

              text += `\n`;
            });

            text += `---\n`;
            text += `[Generated by UW Stroke Tool]`;

            return text;
          };

          // Copy sign-out to clipboard
          const copySignOutToClipboard = async () => {
            const text = generateSignOutText();
            try {
              await navigator.clipboard.writeText(text);
              showSignOutNotification('Sign-out copied to clipboard');
              return true;
            } catch (err) {
              console.error('Failed to copy:', err);
              showSignOutNotification('Failed to copy');
              return false;
            }
          };

          // Share sign-out using native share API
          const shareSignOut = async () => {
            const text = generateSignOutText();
            if (navigator.share) {
              try {
                await navigator.share({
                  title: 'Stroke Sign-Out',
                  text: text
                });
                return true;
              } catch (err) {
                if (err.name !== 'AbortError') {
                  // Fallback to copy
                  return await copySignOutToClipboard();
                }
              }
            } else {
              // Fallback to copy
              return await copySignOutToClipboard();
            }
          };

          // Show toast notification for sign-out actions
          const showSignOutNotification = (message) => {
            setSignOutToast(message);
            setTimeout(() => setSignOutToast(''), 2500);
          };

          // Generate single patient sign-out for quick copy
          const generateSinglePatientSignOut = () => {
            const entry = createSignOutEntry('Current');
            let text = '';

            let header = entry.label;
            if (entry.demographics) {
              header += ` (${entry.demographics}`;
              if (entry.vessel) header += `, ${entry.vessel}`;
              header += `)`;
            }
            if (entry.diagnosis) header += `: ${entry.diagnosis}`;
            text += `${header}\n`;

            let findings = [];
            if (entry.nihss) findings.push(`NIHSS ${entry.nihss}`);
            if (entry.aspects) findings.push(`ASPECTS ${entry.aspects}`);
            if (findings.length > 0) {
              text += `- Findings: ${findings.join(', ')}\n`;
            }

            if (entry.treatment) {
              text += `- Tx: ${entry.treatment}`;
              if (entry.timeFromLKW) text += ` (${entry.timeFromLKW} from LKW)`;
              text += `\n`;
            }

            if (entry.pending && entry.pending.length > 0) {
              text += `- Pending: ${entry.pending.join(', ')}\n`;
            }

            if (entry.status) {
              text += `- Status: ${entry.status}\n`;
            }

            return text;
          };

          // Persist sign-out patients to localStorage
          React.useEffect(() => {
            if (signOutPatients.length > 0) {
              saveWithExpiration('signOutPatients', signOutPatients);
            }
          }, [signOutPatients]);

          // Persist shift patients to localStorage
          React.useEffect(() => {
            if (shiftPatients.length > 0) {
              saveWithExpiration('shiftPatients', shiftPatients);
            }
          }, [shiftPatients]);

          React.useEffect(() => {
            if (currentPatientId) {
              localStorage.setItem('currentPatientId', currentPatientId);
            }
          }, [currentPatientId]);

          // Utility Functions
          const copyToClipboard = (text, label) => {
            navigator.clipboard.writeText(text).then(() => {
              setCopiedText(label);
              setTimeout(() => setCopiedText(''), 2000);
            });
          };

          // Share document using Web Share API
          const shareDocument = async (title, url) => {
            const fullUrl = window.location.origin + window.location.pathname + url;
            if (navigator.share) {
              try {
                await navigator.share({
                  title: `Stroke Resource: ${title}`,
                  text: `Check out this stroke reference: ${title}`,
                  url: fullUrl
                });
              } catch (err) {
                if (err.name !== 'AbortError') {
                  // If share fails, fallback to copy
                  copyToClipboard(fullUrl, title);
                }
              }
            } else {
              // Fallback to copy if Web Share API not supported
              copyToClipboard(fullUrl, title);
            }
          };

          // Email document link
          const emailDocument = (title, url) => {
            const fullUrl = window.location.origin + window.location.pathname + url;
            const subject = encodeURIComponent(title);
            const body = encodeURIComponent(fullUrl);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
          };

          const exportToPDF = () => {
            const element = document.getElementById('root');
            const opt = {
              margin: 0.5,
              filename: `stroke-assessment-${new Date().toISOString().split('T')[0]}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
          };

          const toggleDarkMode = () => {
            const newDarkMode = !darkMode;
            setDarkMode(newDarkMode);
            localStorage.setItem('darkMode', newDarkMode);
            if (newDarkMode) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          };

          const handleShare = async () => {
            const shareData = {
              title: 'Stroke Clinical Decision Support',
              text: 'Comprehensive clinical decision support tool for stroke management',
              url: window.location.href
            };

            try {
              if (navigator.share) {
                await navigator.share(shareData);
              } else {
                // Fallback: copy link to clipboard
                await navigator.clipboard.writeText(window.location.href);
                setCopiedText('Link');
              }
            } catch (err) {
              if (err.name !== 'AbortError') {
                // User cancelled or error occurred - fallback to copy
                try {
                  await navigator.clipboard.writeText(window.location.href);
                  setCopiedText('Link');
                } catch (e) {
                  console.error('Share failed:', e);
                }
              }
            }
          };

          const Tooltip = ({ text, children }) => (
            <span className="tooltip">
              {children}
              <span className="tooltiptext">{text}</span>
            </span>
          );

          // Generate telestroke documentation note
          const generateTelestrokeNote = () => {
            const formatDate = (dateStr) => {
              if (!dateStr) return '';
              const date = new Date(dateStr);
              return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear().toString().slice(-2)}`;
            };

            const formatTime = (timeStr) => {
              if (!timeStr) return '';
              const [hours, minutes] = timeStr.split(':');
              const hour = parseInt(hours);
              const ampm = hour >= 12 ? 'pm' : 'am';
              const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
              return `${displayHour}:${minutes} ${ampm}`;
            };

            // Use the editable template and replace placeholders with actual values
            let note = editableTemplate;

            // Replace all placeholders with actual values
            note = note.replace(/{chiefComplaint}/g, telestrokeNote.chiefComplaint || '');
            note = note.replace(/{lkwDate}/g, formatDate(telestrokeNote.lkwDate));
            note = note.replace(/{lkwTime}/g, formatTime(telestrokeNote.lkwTime));
            note = note.replace(/{age}/g, telestrokeNote.age || '');
            note = note.replace(/{sex}/g, telestrokeNote.sex || '');
            note = note.replace(/{symptoms}/g, telestrokeNote.symptoms || '');
            note = note.replace(/{pmh}/g, telestrokeNote.pmh || '');
            note = note.replace(/{medications}/g, telestrokeNote.medications || '');
            note = note.replace(/{presentingBP}/g, telestrokeNote.presentingBP || '');
            note = note.replace(/{bpPreTNK}/g, telestrokeNote.bpPreTNK || '');
            note = note.replace(/{bpPreTNKTime}/g, formatTime(telestrokeNote.bpPreTNKTime));
            note = note.replace(/{glucose}/g, telestrokeNote.glucose || '');
            note = note.replace(/{plateletsCoags}/g, telestrokeNote.plateletsCoags || '');
            note = note.replace(/{creatinine}/g, telestrokeNote.creatinine || '');
            note = note.replace(/{nihss}/g, telestrokeNote.nihss || nihssScore || '');
            note = note.replace(/{nihssDetails}/g, telestrokeNote.nihssDetails || '');
            note = note.replace(/{ctTime}/g, formatTime(telestrokeNote.ctTime));
            note = note.replace(/{ctResults}/g, telestrokeNote.ctResults || '');
            note = note.replace(/{ctaDate}/g, formatDate(telestrokeNote.ctaDate));
            note = note.replace(/{ctaTime}/g, formatTime(telestrokeNote.ctaTime));
            note = note.replace(/{ctaResults}/g, telestrokeNote.ctaResults || '');
            note = note.replace(/{ekgResults}/g, telestrokeNote.ekgResults || '');
            note = note.replace(/{diagnosis}/g, telestrokeNote.diagnosis || '');
            note = note.replace(/{tnkAdminTime}/g, formatTime(telestrokeNote.tnkAdminTime));
            note = note.replace(/{recommendationsText}/g, telestrokeNote.recommendationsText || '');

            // Add DTN metrics if TNK was administered
            if (telestrokeNote.dtnTnkAdministered && telestrokeNote.tnkRecommended) {
              note += formatDTNForNote();
            }

            // Add contraindication review status if reviewed
            if (telestrokeNote.tnkContraindicationReviewed) {
              note += `\nThrombolysis Contraindication Review: Completed at ${telestrokeNote.tnkContraindicationReviewTime}. `;
              const checklist = telestrokeNote.tnkContraindicationChecklist || {};
              const absoluteKeys = ['activeInternalBleeding', 'recentIntracranialSurgery', 'intracranialNeoplasm', 'knownBleedingDiathesis', 'severeUncontrolledHTN', 'currentICH'];
              const relativeKeys = ['recentMajorSurgery', 'recentGIGUBleeding', 'recentArterialPuncture', 'recentLumbarPuncture', 'pregnancy', 'seizureAtOnset', 'lowPlatelets', 'elevatedINR', 'elevatedPTT', 'abnormalGlucose', 'recentDOAC'];
              const absoluteChecked = absoluteKeys.filter(k => checklist[k]);
              const relativeChecked = relativeKeys.filter(k => checklist[k]);
              if (absoluteChecked.length === 0 && relativeChecked.length === 0) {
                note += 'No absolute or relative contraindications identified.';
              } else if (absoluteChecked.length > 0) {
                note += `Absolute contraindication(s) identified: ${absoluteChecked.length}. TNK contraindicated.`;
              } else if (relativeChecked.length > 0) {
                note += `${relativeChecked.length} relative contraindication(s) identified. Clinical judgment applied.`;
              }
              note += '\n';
            }

            return note;

            // OLD TEMPLATE CODE BELOW - kept for reference but not used anymore
            /*

            let note = `Chief complaint: ${telestrokeNote.chiefComplaint}\n`;
            note += `Last known well (date/time): ${formatDate(telestrokeNote.lkwDate)} ${formatTime(telestrokeNote.lkwTime)}\n`;
            note += `HPI:\n`;
            note += `            ${telestrokeNote.age} year old ${telestrokeNote.sex} p/w ${telestrokeNote.symptoms}`;
            if (telestrokeNote.lkwTime) {
              note += ` at ${formatTime(telestrokeNote.lkwTime)}`;
            }
            note += `\n`;

            note += `Relevant PMH:\n`;
            note += `            ${telestrokeNote.pmh}\n`;

            note += `Medications: `;
            if (telestrokeNote.noAnticoagulants) {
              note += `no anticoagulants (confirmed with pt's wife), `;
            }
            note += `${telestrokeNote.medications}\n`;

            note += `Objective:\n`;
            note += `Vitals:\n`;
            if (telestrokeNote.presentingBP) {
              note += `Presenting BP ${telestrokeNote.presentingBP}\n`;
            }
            if (telestrokeNote.bpPreTNK) {
              note += `Blood pressure: BP prior to TNK administration: ${telestrokeNote.bpPreTNK}`;
              if (telestrokeNote.bpPreTNKTime) {
                note += ` at ${formatTime(telestrokeNote.bpPreTNKTime)}`;
              }
              note += `\n`;
            }

            note += `Labs: `;
            const labs = [];
            if (telestrokeNote.glucose) labs.push(`Glucose ${telestrokeNote.glucose}`);
            if (telestrokeNote.plateletsCoags) labs.push(`PLT and coags ${telestrokeNote.plateletsCoags}`);
            if (telestrokeNote.creatinine) labs.push(`Cr ${telestrokeNote.creatinine}`);
            note += labs.join(', ') + `\n`;

            note += `Exam: Scores: NIHSS ${telestrokeNote.nihss}`;
            if (telestrokeNote.nihssDetails) {
              note += ` - ${telestrokeNote.nihssDetails}`;
            }
            note += `\n`;

            note += `Imaging: `;
            if (telestrokeNote.imagingReviewed) {
              note += `I personally reviewed imaging\n`;
            } else {
              note += `\n`;
            }

            if (telestrokeNote.ctTime) {
              note += `Date/time Non-contrast Head CT reviewed: ${formatTime(telestrokeNote.ctTime)}\n`;
            }
            if (telestrokeNote.ctResults) {
              note += `Non-contrast Head CT Results: ${telestrokeNote.ctResults}\n`;
            }

            if (telestrokeNote.ctaDate && telestrokeNote.ctaTime) {
              note += `Date/time CTA reviewed: ${formatDate(telestrokeNote.ctaDate)} ${formatTime(telestrokeNote.ctaTime)}\n`;
            }
            if (telestrokeNote.ctaResults) {
              note += `CTA Results: ${telestrokeNote.ctaResults}\n`;
            }

            if (telestrokeNote.ekgResults) {
              note += `EKG - ${telestrokeNote.ekgResults}\n`;
            }

            note += `\nAssessment and Plan:\n`;
            note += `${telestrokeNote.diagnosis}\n`;

            if (telestrokeNote.tnkRecommended) {
              note += `After ensuring that there were no evident contraindications, TNK administration was recommended`;
              if (telestrokeNote.tnkAdminTime) {
                note += ` at ${formatTime(telestrokeNote.tnkAdminTime.split(' ')[0])}`;
              }
              note += `. `;

              if (telestrokeNote.tnkConsentDiscussed) {
                note += `Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the patient, patient's wife, and OSH provider. Both the patient and his wife expressed agreement with the recommendation.\n`;
              }

              if (telestrokeNote.tnkAdminTime) {
                note += `TNK was administered at ${formatTime(telestrokeNote.tnkAdminTime)} after a brief time-out.\n`;
              }
            }

            note += `\nRecommendations:\n`;
            if (telestrokeNote.recommendationsText) {
              note += `${telestrokeNote.recommendationsText}\n`;
            }

            note += `\nRizwan Kalani MD`;

            return note;
            */
          };

          // Time calculation functions
          const calculateTimeFromLKW = () => {
            if (!lkwTime) return null;
            const diffMs = currentTime - lkwTime;
            const diffHrs = diffMs / (1000 * 60 * 60);
            const diffMins = (diffMs / (1000 * 60)) % 60;
            return { hours: Math.floor(diffHrs), minutes: Math.floor(diffMins), total: diffHrs };
          };

          const getWindowStatus = (timeFromLKW) => {
            if (!timeFromLKW) return null;
            if (timeFromLKW.total <= 4.5) {
              // TNK eligible up to and including 4.5 hours
              if (timeFromLKW.total < 3) {
                return { color: 'green', message: 'Within TNK window (<3h)', urgent: false, eligible: 'tnk' };
              } else {
                return { color: 'yellow', message: 'Extended TNK window (3-4.5h)', urgent: false, eligible: 'tnk' };
              }
            } else if (timeFromLKW.total < 6) {
              return { color: 'orange', message: 'TNK window closed - EVT window (4.5-6h)', urgent: true, eligible: 'evt-early' };
            } else if (timeFromLKW.total < 24) {
              return { color: 'red', message: 'Late EVT window (6-24h - needs perfusion imaging)', urgent: true, eligible: 'evt-late' };
            } else {
              return { color: 'gray', message: 'Beyond standard treatment window', urgent: false, eligible: 'none' };
            }
          };

          // NIHSS validation
          const isNIHSSComplete = () => {
            return nihssItems.every(item => patientData[item.id] !== undefined && patientData[item.id] !== '');
          };

          const getIncompleteNIHSSItems = () => {
            return nihssItems.filter(item => !patientData[item.id]).map(item => item.name);
          };

          const getNIHSSInterpretation = (score) => {
            if (score === 0) return { severity: 'No stroke symptoms', color: 'green', guidance: 'Consider stroke mimics and alternative diagnoses' };
            if (score <= 4) return { severity: 'Minor stroke', color: 'yellow', guidance: 'Consider EVT if large vessel occlusion present despite low NIHSS' };
            if (score <= 15) return { severity: 'Moderate stroke', color: 'orange', guidance: 'Candidate for both thrombolysis and EVT if eligible' };
            if (score <= 20) return { severity: 'Moderate-severe stroke', color: 'red', guidance: 'Aggressive intervention warranted - high benefit potential' };
            return { severity: 'Severe stroke', color: 'red', guidance: 'All treatment options should be considered - high mortality risk without intervention' };
          };

          // Treatment validation
          const validateTreatmentRecommendation = () => {
            const hasContraindications = strokeCodeForm.tnk && strokeCodeForm.tnk.length > 0;
            const tnkRecommended = strokeCodeForm.tnk_rec === 'Recommended';

            if (hasContraindications && tnkRecommended) {
              return {
                valid: false,
                message: `⚠️ WARNING: TNK recommended but ${strokeCodeForm.tnk.length} contraindication(s) selected`,
                severity: 'error'
              };
            }

            if (!hasContraindications && strokeCodeForm.tnk_rec === 'Not Recommended') {
              return {
                valid: true,
                message: 'ℹ️ No contraindications selected. Confirm rationale for not recommending TNK.',
                severity: 'warning'
              };
            }

            return { valid: true, message: null, severity: null };
          };

          // Search function
          // Helper function to check if evidence section matches filter
          const evidenceSectionMatches = (sectionTitle, documentTitles) => {
            if (!evidenceFilter) return true;
            const filter = evidenceFilter.toLowerCase();
            if (sectionTitle.toLowerCase().includes(filter)) return true;
            return documentTitles.some(title => title.toLowerCase().includes(filter));
          };

          const performSearch = (query) => {
            if (!query || query.length < 2) {
              setSearchResults([]);
              return;
            }

            const results = [];
            const lowerQuery = query.toLowerCase();

            // Search in trials
            Object.entries(trialsData).forEach(([category, data]) => {
              if (data.hasSubsections) {
                Object.entries(data.subsections).forEach(([subKey, subsection]) => {
                  subsection.trials.forEach(trial => {
                    if (trial.name.toLowerCase().includes(lowerQuery) ||
                        trial.description.toLowerCase().includes(lowerQuery) ||
                        trial.nct.toLowerCase().includes(lowerQuery)) {
                      results.push({
                        type: 'Clinical Trial',
                        category: category,
                        title: trial.name,
                        description: trial.description.substring(0, 100) + '...',
                        action: () => {
                          setActiveTab('trials');
                          setTrialsCategory(category);
                          setSearchOpen(false);
                          setSearchQuery('');
                        }
                      });
                    }
                  });
                });
              }
            });

            // Search in protocols/calculators
            const searchableItems = [
              { name: 'NIHSS', keywords: ['nihss', 'stroke scale', 'neurological'], tab: 'nihss' },
              { name: 'ASPECTS', keywords: ['aspects', 'imaging', 'ct'], tab: 'imaging' },
              { name: 'TNK Eligibility', keywords: ['tnk', 'tenecteplase', 'thrombolysis', 'lytic'], tab: 'lytic' },
              { name: 'EVT Eligibility', keywords: ['evt', 'thrombectomy', 'mechanical', 'endovascular'], tab: 'evt' },
              { name: 'ICH Management', keywords: ['ich', 'hemorrhage', 'bleeding', 'reversal'], tab: 'ich' },
              { name: 'GCS Score', keywords: ['gcs', 'glasgow', 'coma', 'consciousness'], tab: 'calculators' },
              { name: 'ICH Score', keywords: ['ich score', 'hemorrhage score', 'mortality'], tab: 'calculators' },
              { name: 'ABCD² Score', keywords: ['abcd', 'tia', 'transient'], tab: 'calculators' },
              { name: 'CHA₂DS₂-VASc', keywords: ['chads', 'afib', 'atrial fibrillation', 'anticoagulation'], tab: 'calculators' },
              { name: 'ROPE Score', keywords: ['rope', 'pfo', 'paradoxical'], tab: 'calculators' },
              { name: 'Modified Rankin Scale (mRS)', keywords: ['mrs', 'rankin', 'disability', 'outcome', 'functional status'], tab: 'calculators' },
              { name: 'Hunt and Hess Scale', keywords: ['hunt', 'hess', 'sah', 'subarachnoid', 'hemorrhage', 'grading'], tab: 'calculators' },
              { name: 'WFNS Scale', keywords: ['wfns', 'world federation', 'neurosurgical', 'sah', 'subarachnoid'], tab: 'calculators' },
              { name: 'HAS-BLED Score', keywords: ['hasbled', 'has-bled', 'bleeding', 'risk', 'anticoagulation'], tab: 'calculators' },
              { name: 'RCVS² Score', keywords: ['rcvs', 'rcvs2', 'vasoconstriction', 'thunderclap', 'headache'], tab: 'calculators' },
              { name: 'Blood Pressure Management', keywords: ['bp', 'blood pressure', 'labetalol', 'nicardipine'], tab: 'protocols' }
            ];

            searchableItems.forEach(item => {
              if (item.name.toLowerCase().includes(lowerQuery) ||
                  item.keywords.some(k => k.includes(lowerQuery))) {
                results.push({
                  type: 'Tool/Protocol',
                  title: item.name,
                  description: `Go to ${item.name}`,
                  action: () => {
                    setActiveTab(item.tab);
                    setSearchOpen(false);
                    setSearchQuery('');
                  }
                });
              }
            });

            // Search in Evidence documents
            const evidenceDocuments = [
              { title: 'DAPT Minor Stroke-TIA Trials', section: 'Antiplatelet Therapy', keywords: ['dapt', 'antiplatelet', 'tia', 'minor stroke'] },
              { title: 'DAPT After Ischemic Stroke-TIA', section: 'Antiplatelet Therapy', keywords: ['dapt', 'antiplatelet', 'duration', 'ischemic stroke', 'tia', 'sammpris', 'chance', 'point', 'thales', 'inspires', 'icad'] },
              { title: 'Timing of Anticoagulation after AF-Related Stroke', section: 'Risk Factors', keywords: ['anticoagulation', 'atrial fibrillation', 'afib', 'timing'] },
              { title: 'Atrial Fibrillation & Secondary Stroke Prevention', section: 'Risk Factors', keywords: ['afib', 'atrial fibrillation', 'prevention'] },
              { title: 'Diabetes and stroke', section: 'Risk Factors', keywords: ['diabetes', 'risk factor', 'dm'] },
              { title: 'Lipids and Cerebrovascular Disease', section: 'Risk Factors', keywords: ['lipids', 'cholesterol', 'statins', 'ldl'] },
              { title: 'WAKE-UP Trial', section: 'Thrombolytic Therapy', keywords: ['wake-up', 'thrombolysis', 'tpa', 'alteplase', 'mri'] },
              { title: 'Thrombolytic Therapy 4.5-24h RCTs', section: 'Thrombolytic Therapy', keywords: ['thrombolysis', 'tpa', 'alteplase', 'rct', 'extended window', '4.5-24h'] },
              { title: 'Lacunar Stroke', section: 'Cerebral Small Vessel Disease', keywords: ['lacunar', 'small vessel', 'csvd'] },
              { title: 'Symptomatic Cervical Carotid Artery Stenosis', section: 'Large Artery Disease', keywords: ['carotid', 'stenosis', 'endarterectomy', 'cea', 'cas'] },
              { title: 'CREST-2 Trial', section: 'Large Artery Disease', keywords: ['crest', 'crest-2', 'carotid', 'stenting', 'endarterectomy', 'cea', 'cas', 'asymptomatic'] },
              { title: 'Differentiating Acute Confusional State (Delirium) from Aphasia', section: 'Exam', keywords: ['delirium', 'aphasia', 'confusion', 'exam'] },
              { title: 'Coma Exam', section: 'Exam', keywords: ['coma', 'exam', 'consciousness'] },
              { title: 'Large Core Anterior Circulation LVO EVT Trials', section: 'Endovascular Therapy', keywords: ['large core', 'lvo', 'thrombectomy', 'evt'] },
              { title: 'Basilar Artery Occlusion EVT Trials', section: 'Endovascular Therapy', keywords: ['basilar', 'posterior circulation', 'evt'] },
              { title: 'MeVO & Distal Vessel Occlusion EVT Trials', section: 'Endovascular Therapy', keywords: ['mevo', 'distal', 'medium vessel'] },
              { title: 'Unruptured Cerebral Aneurysms', section: 'Aneurysms & Vascular Malformations', keywords: ['aneurysm', 'unruptured', 'sah'] },
              { title: 'Interpretation of Clinical Trials', section: 'Critical Appraisal', keywords: ['ebm', 'clinical trials', 'evidence', 'statistics', 'critical appraisal'] },
              { title: 'CEBM Oxford Resources', section: 'Critical Appraisal', keywords: ['cebm', 'oxford', 'ebm', 'evidence-based medicine', 'critical appraisal', 'study designs', 'levels of evidence'] }
            ];

            evidenceDocuments.forEach(doc => {
              if (doc.title.toLowerCase().includes(lowerQuery) ||
                  doc.section.toLowerCase().includes(lowerQuery) ||
                  doc.keywords.some(k => k.toLowerCase().includes(lowerQuery))) {
                results.push({
                  type: 'Evidence',
                  title: doc.title,
                  description: `${doc.section} section`,
                  action: () => {
                    setActiveTab('evidence');
                    setSearchOpen(false);
                    setSearchQuery('');
                  }
                });
              }
            });

            setSearchResults(results.slice(0, 10)); // Limit to 10 results
          };

          // Reset all data - New Patient
          const resetAllData = () => {
            if (!confirm('Start new patient assessment? All current data will be cleared. This cannot be undone.')) {
              return;
            }

            // Clear all state
            setPatientData({});
            setNihssScore(0);
            setAspectsScore(10);
            setLkwTime(null);
            setStrokeCodeForm({
              age: '',
              sex: '',
              hx: '',
              sx: '',
              lkw: '',
              lkw_date: new Date().toISOString().split('T')[0],
              nihss: '',
              def: '',
              hct: '',
              cta: '',
              ctp: '',
              tnk: [],
              tnk_rec: '',
              evt_rec: '',
              rec_reason: ''
            });
            setAspectsRegionState([
              { id: 'M1', name: 'M1 - Anterior MCA cortex', checked: true },
              { id: 'M2', name: 'M2 - MCA cortex lateral to insular ribbon', checked: true },
              { id: 'M3', name: 'M3 - Posterior MCA cortex', checked: true },
              { id: 'M4', name: 'M4 - Anterior MCA territory immediately superior to M1', checked: true },
              { id: 'M5', name: 'M5 - Lateral MCA territory immediately superior to M2', checked: true },
              { id: 'M6', name: 'M6 - Posterior MCA territory immediately superior to M3', checked: true },
              { id: 'IC', name: 'IC - Internal capsule', checked: true },
              { id: 'L', name: 'L - Lentiform nucleus', checked: true },
              { id: 'C', name: 'C - Caudate', checked: true },
              { id: 'I', name: 'I - Insular ribbon', checked: true }
            ]);
            setPcAspectsRegions([
              { id: 'THAL', name: 'Thalami (bilateral)', checked: true, points: 1 },
              { id: 'MIDBRAIN', name: 'Midbrain', checked: true, points: 2 },
              { id: 'PONS', name: 'Pons', checked: true, points: 2 },
              { id: 'MEDULLA', name: 'Medulla', checked: true, points: 1 },
              { id: 'CEREBELLUM-L', name: 'Left Cerebellar Hemisphere', checked: true, points: 1 },
              { id: 'CEREBELLUM-R', name: 'Right Cerebellar Hemisphere', checked: true, points: 1 },
              { id: 'PCA-L', name: 'Left Occipital Lobe (PCA Territory)', checked: true, points: 1 },
              { id: 'PCA-R', name: 'Right Occipital Lobe (PCA Territory)', checked: true, points: 1 }
            ]);
            setGcsItems({ eye: 0, verbal: 0, motor: 0 });
            setMrsScore('');
            setIchScoreItems({ gcs: '', age80: false, volume30: false, ivh: false, infratentorial: false });
            setAbcd2Items({ age60: false, bp: false, unilateralWeakness: false, speechDisturbance: false, duration: '', diabetes: false });
            setChads2vascItems({ chf: false, hypertension: false, age75: false, diabetes: false, strokeTia: false, vascular: false, age65: false, female: false });
            setRopeItems({ noHypertension: false, noDiabetes: false, noStrokeTia: false, nonsmoker: false, cortical: false, age: '' });
            setHuntHessGrade('');
            setWfnsGrade('');
            setHasbledItems({ hypertension: false, renalDisease: false, liverDisease: false, stroke: false, bleeding: false, labileINR: false, elderly: false, drugs: false, alcohol: false });
            setRcvs2Items({ recurrentTCH: false, carotidInvolvement: false, vasoconstrictiveTrigger: false, female: false, sah: false });
            setCurrentStep(0);
            setCompletedSteps([]);

            // Clear localStorage for patient data
            const keysToRemove = ['patientData', 'nihssScore', 'aspectsScore', 'gcsItems', 'mrsScore', 'ichScoreItems',
                                   'abcd2Items', 'chads2vascItems', 'ropeItems', 'huntHessGrade', 'wfnsGrade',
                                   'hasbledItems', 'rcvs2Items', 'strokeCodeForm', 'lkwTime',
                                   'currentStep', 'completedSteps', 'aspectsRegionState', 'pcAspectsRegions'];
            keysToRemove.forEach(key => localStorage.removeItem(key));

            setActiveTab('encounter');
            setSaveStatus('saved');
          };

          // Workflow steps definition
          const workflowSteps = [
            { id: 'assessment', name: 'Initial Assessment', tab: 'workflow' },
            { id: 'nihss', name: 'NIHSS Score', tab: 'nihss' },
            { id: 'imaging', name: 'Imaging Review', tab: 'imaging' },
            { id: 'eligibility', name: 'Treatment Eligibility', tab: 'lytic' },
            { id: 'documentation', name: 'Documentation', tab: 'encounter' }
          ];

          // Save to localStorage with expiration whenever state changes
          useEffect(() => {
            debouncedSave('activeTab', activeTab);
          }, [activeTab]);

          useEffect(() => {
            debouncedSave('patientData', patientData);
            const newScore = calculateNIHSS(patientData);
            if (newScore !== nihssScore) {
              setNihssScore(newScore);
            }
          }, [patientData]);

          useEffect(() => {
            debouncedSave('nihssScore', nihssScore);
          }, [nihssScore]);

          useEffect(() => {
            debouncedSave('aspectsScore', aspectsScore);
          }, [aspectsScore]);

          useEffect(() => {
            debouncedSave('gcsItems', gcsItems);
          }, [gcsItems]);

          useEffect(() => {
            debouncedSave('mrsScore', mrsScore);
          }, [mrsScore]);

          useEffect(() => {
            debouncedSave('ichScoreItems', ichScoreItems);
          }, [ichScoreItems]);

          useEffect(() => {
            debouncedSave('abcd2Items', abcd2Items);
          }, [abcd2Items]);

          useEffect(() => {
            debouncedSave('chads2vascItems', chads2vascItems);
          }, [chads2vascItems]);

          useEffect(() => {
            debouncedSave('ropeItems', ropeItems);
          }, [ropeItems]);

          useEffect(() => {
            debouncedSave('huntHessGrade', huntHessGrade);
          }, [huntHessGrade]);

          useEffect(() => {
            debouncedSave('wfnsGrade', wfnsGrade);
          }, [wfnsGrade]);

          useEffect(() => {
            debouncedSave('hasbledItems', hasbledItems);
          }, [hasbledItems]);

          useEffect(() => {
            debouncedSave('rcvs2Items', rcvs2Items);
          }, [rcvs2Items]);

          useEffect(() => {
            debouncedSave('strokeCodeForm', strokeCodeForm);
          }, [strokeCodeForm]);

          useEffect(() => {
            debouncedSave('aspectsRegionState', aspectsRegionState);
          }, [aspectsRegionState]);

          useEffect(() => {
            debouncedSave('pcAspectsRegions', pcAspectsRegions);
          }, [pcAspectsRegions]);

          useEffect(() => {
            debouncedSave('telestrokeNote', telestrokeNote);
          }, [telestrokeNote]);

          useEffect(() => {
            debouncedSave('telestrokeTemplate', editableTemplate);
          }, [editableTemplate]);

          useEffect(() => {
            if (lkwTime) {
              debouncedSave('lkwTime', lkwTime.toISOString());
            }
          }, [lkwTime]);

          useEffect(() => {
            debouncedSave('currentStep', currentStep);
          }, [currentStep]);

          useEffect(() => {
            debouncedSave('completedSteps', completedSteps);
          }, [completedSteps]);

          // Auto-populate Documentation form with Workflow data
          useEffect(() => {
            if (lkwTime) {
              const timeStr = lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
              const dateStr = lkwTime.toLocaleDateString('en-US');
              setStrokeCodeForm(prev => ({
                ...prev,
                lkw: timeStr,
                lkw_date: lkwTime.toISOString().split('T')[0]
              }));
            }
          }, [lkwTime]);

          useEffect(() => {
            if (nihssScore !== null && nihssScore !== undefined) {
              setStrokeCodeForm(prev => ({
                ...prev,
                nihss: nihssScore.toString()
              }));
            }
          }, [nihssScore]);

          useEffect(() => {
            if (aspectsScore !== null && aspectsScore !== undefined) {
              setStrokeCodeForm(prev => ({
                ...prev,
                aspects: aspectsScore.toString()
              }));
            }
          }, [aspectsScore]);

          // Update current time every minute
          useEffect(() => {
            const timer = setInterval(() => setCurrentTime(new Date()), 60000);
            return () => clearInterval(timer);
          }, []);

          // ============================================================
          // THROMBOLYSIS WINDOW TIMER & AUDIBLE ALERTS
          // ============================================================

          // Web Audio API alert function
          const playAlertTone = (alertType) => {
            if (alertsMuted) return;

            try {
              const audioContext = new (window.AudioContext || window.webkitAudioContext)();
              const oscillator = audioContext.createOscillator();
              const gainNode = audioContext.createGain();

              oscillator.connect(gainNode);
              gainNode.connect(audioContext.destination);

              // Different tones for different alert types
              const toneConfigs = {
                'warning-30': { freq: 440, duration: 0.3, repeat: 2 },   // A4 - two beeps for 30 min warning
                'warning-15': { freq: 523, duration: 0.3, repeat: 3 },   // C5 - three beeps for 15 min warning
                'window-closed': { freq: 659, duration: 0.5, repeat: 4 } // E5 - four beeps for window closed
              };

              const config = toneConfigs[alertType] || toneConfigs['warning-30'];

              // Play repeating tones
              let currentTime = audioContext.currentTime;
              for (let i = 0; i < config.repeat; i++) {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.frequency.setValueAtTime(config.freq, currentTime);
                osc.type = 'sine';

                gain.gain.setValueAtTime(0, currentTime);
                gain.gain.linearRampToValueAtTime(0.3, currentTime + 0.05);
                gain.gain.linearRampToValueAtTime(0.3, currentTime + config.duration - 0.1);
                gain.gain.linearRampToValueAtTime(0, currentTime + config.duration);

                osc.start(currentTime);
                osc.stop(currentTime + config.duration);

                currentTime += config.duration + 0.15; // Gap between beeps
              }
            } catch (e) {
              console.log('Audio alert not supported:', e);
            }
          };

          // Toggle mute and persist to localStorage
          const toggleAlertMute = () => {
            const newMuted = !alertsMuted;
            setAlertsMuted(newMuted);
            localStorage.setItem('thrombolysisAlertsMuted', newMuted.toString());
          };

          // Second-level timer for elapsed time and alert checking
          useEffect(() => {
            if (!lkwTime) return;

            const checkAlertsAndUpdate = () => {
              const now = new Date();
              const diffMs = now - lkwTime;
              const diffMinutes = diffMs / (1000 * 60);
              const remainingMinutes = (4.5 * 60) - diffMinutes; // Minutes until 4.5h window closes

              setElapsedSeconds(Math.floor(diffMs / 1000));
              setCurrentTime(now);

              // Only check alerts if tab is visible and LKW is set
              if (document.hidden || !lkwTime) return;

              // Check for alert thresholds (within 30 seconds of the threshold)
              const alertThresholds = [
                { id: 'warning-30', minutesRemaining: 30, played: false },
                { id: 'warning-15', minutesRemaining: 15, played: false },
                { id: 'window-closed', minutesRemaining: 0, played: false }
              ];

              for (const threshold of alertThresholds) {
                // Check if we're within 30 seconds of this threshold
                const diff = Math.abs(remainingMinutes - threshold.minutesRemaining);
                if (diff < 0.5 && lastAlertPlayed !== threshold.id && remainingMinutes >= -1) {
                  // Play alert and flash
                  setLastAlertPlayed(threshold.id);
                  playAlertTone(threshold.id);
                  setAlertFlashing(true);

                  // Stop flashing after 10 seconds
                  setTimeout(() => setAlertFlashing(false), 10000);
                  break;
                }
              }
            };

            // Initial check
            checkAlertsAndUpdate();

            // Update every second for precise timing
            const timer = setInterval(checkAlertsAndUpdate, 1000);

            return () => clearInterval(timer);
          }, [lkwTime, alertsMuted, lastAlertPlayed]);

          // Reset last alert when LKW changes
          useEffect(() => {
            setLastAlertPlayed(null);
            setAlertFlashing(false);
          }, [lkwTime]);

          // =================================================================
          // TRIAL ELIGIBILITY - Auto-update when form data changes
          // =================================================================
          useEffect(() => {
            const timeFromLKW = calculateTimeFromLKW();
            const hoursFromLKW = timeFromLKW ? timeFromLKW.total : null;

            const evaluationData = {
              telestrokeNote,
              strokeCodeForm,
              aspectsScore,
              nihssScore,
              mrsScore,
              hoursFromLKW,
              lkwTime
            };

            const results = evaluateAllTrials(evaluationData);
            setTrialEligibility(results);
          }, [telestrokeNote, strokeCodeForm, aspectsScore, nihssScore, mrsScore, lkwTime, currentTime]);

          // Monitor scroll position for Part 6 (Treatment Decision) visibility
          useEffect(() => {
            const handleScroll = () => {
              if (treatmentDecisionRef.current && activeTab === 'encounter') {
                const rect = treatmentDecisionRef.current.getBoundingClientRect();
                // Show smart phrases when Part 6 is at or above 80% of viewport height from top
                const isVisible = rect.top <= window.innerHeight * 0.8;
                setShowSmartPhrases(isVisible);
              } else {
                setShowSmartPhrases(false);
              }
            };

            window.addEventListener('scroll', handleScroll);
            // Initial check
            handleScroll();

            return () => window.removeEventListener('scroll', handleScroll);
          }, [activeTab]);

          // Monitor critical alerts
          useEffect(() => {
            const alerts = [];

            if (lkwTime) {
              const timeFromLKW = calculateTimeFromLKW();
              if (!timeFromLKW) return;

              const totalHours = timeFromLKW.total;
              const remainingToTNK = 4.5 - totalHours;
              const remainingToEVT = 6 - totalHours;

              // Alert if <30 min to TNK cutoff (4.5h)
              if (remainingToTNK > 0 && remainingToTNK <= 0.5) {
                const minsLeft = Math.floor(remainingToTNK * 60);
                alerts.push({
                  id: 'tnk-cutoff',
                  level: 'critical',
                  message: `⚠️ URGENT: Only ${minsLeft} minutes left for TNK window!`,
                  action: 'TNK must be given before 4.5h from LKW'
                });
              }

              // Alert if <30 min to early EVT cutoff (6h)
              if (remainingToEVT > 0 && remainingToEVT <= 0.5 && totalHours > 4.5) {
                const minsLeft = Math.floor(remainingToEVT * 60);
                alerts.push({
                  id: 'evt-cutoff',
                  level: 'critical',
                  message: `⚠️ URGENT: Only ${minsLeft} minutes left for early EVT window!`,
                  action: 'Consider EVT before 6h window requires perfusion imaging'
                });
              }
            }

            setCriticalAlerts(alerts);
          }, [currentTime, lkwTime]);

          // Perform search when query changes
          useEffect(() => {
            performSearch(searchQuery);
          }, [searchQuery]);

          // Initialize component and icons on mount
          useEffect(() => {
            // Initialize icons immediately on first render
            lucide.createIcons();

            // After icons are initialized, load saved tab if valid
            requestAnimationFrame(() => {
              setIsMounted(true);

              // Load saved tab preference AFTER initial render
              try {
                const savedTab = localStorage.getItem('activeTab');
                const validTabs = ['encounter', 'ich', 'protocols', 'calculators', 'trials', 'evidence'];
                if (savedTab && savedTab !== 'null' && savedTab !== 'undefined' && validTabs.includes(savedTab.replace(/"/g, ''))) {
                  setActiveTab(savedTab.replace(/"/g, ''));
                }
              } catch (e) {
                console.warn('Error loading saved tab:', e);
              }

              lucide.createIcons();
            });
          }, []);

          // Reinitialize icons when needed
          useEffect(() => {
            if (isMounted) {
              lucide.createIcons();
            }
          }, [activeTab, copiedText, darkMode, searchOpen, isMounted]);

          // Documentation generation functions
          const generateHPI = () => {
            const timeFromLKW = calculateTimeFromLKW();
            const timeElapsed = timeFromLKW ? `${timeFromLKW.hours}h ${timeFromLKW.minutes}m` : 'unknown';
            const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '__';
            const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : '__';
            const sexDisplay = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '__';
            const nihssDisplay = telestrokeNote.nihss || nihssScore || '__';

            return `HPI: ${telestrokeNote.age || '__'} year old ${sexDisplay} with PMH of ${telestrokeNote.pmh || '__'} presenting with ${telestrokeNote.symptoms || '__'} starting at ${lkw} on ${lkwDate} (${timeElapsed} ago). NIHSS ${nihssDisplay}.

IMAGING:
- Head CT: ${telestrokeNote.ctResults || 'pending'}
- CTA Head/Neck: ${telestrokeNote.ctaResults || 'pending'}
- CTP: ${telestrokeNote.ctpResults || 'pending'}
- ASPECTS: ${aspectsScore || '__'}

ASSESSMENT: ${telestrokeNote.diagnosis || 'Acute ischemic stroke'}, NIHSS ${nihssDisplay}
${telestrokeNote.tnkRecommended ? `\nTNK: Recommended` : '\nTNK: Not Recommended'}
${telestrokeNote.evtRecommended ? `EVT: Recommended` : 'EVT: Not Recommended'}`;
          };

          const generateAdmissionOrders = () => {
            const nihssDisplay = telestrokeNote.nihss || nihssScore || '__';

            return `ACUTE STROKE ADMISSION ORDERS:

1. Admit to Stroke Unit / Neuro ICU
2. Vital signs q1h x 24h, then q4h
3. Continuous telemetry monitoring
4. NPO until swallow evaluation completed
5. IV fluids: NS at 75 mL/hr
6. Maintain SBP <180/105 (or <185/110 if post-tPA)
7. Blood glucose 140-180 mg/dL
8. HOB elevated 30 degrees
9. DVT prophylaxis: SCDs (hold pharmacologic if tPA given)
10. Aspirin 325mg daily (hold x 24h if tPA given)
11. Statin therapy: Atorvastatin 80mg daily
12. Neurology consultation
13. PT/OT/Speech evaluation
14. Fall precautions

LABS:
- CBC, CMP, PT/INR, PTT
- Lipid panel, HbA1c
- Troponin, BNP
- Consider: ESR, CRP if indicated

IMAGING:
- MRI brain with DWI if not already done
- Carotid ultrasound
- Echocardiogram (TTE or TEE)

NIHSS: ${nihssDisplay} - reassess q4h x 24h, then daily`;
          };

          const generateSignOut = () => {
            const timeFromLKW = calculateTimeFromLKW();
            const timeElapsed = timeFromLKW ? `${timeFromLKW.hours}h ${timeFromLKW.minutes}m` : 'unknown';
            const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '__';
            const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : '__';
            const sexDisplay = telestrokeNote.sex === 'M' ? 'male' : telestrokeNote.sex === 'F' ? 'female' : '__';
            const nihssDisplay = telestrokeNote.nihss || nihssScore || '__';

            return `STROKE SIGN-OUT:

Patient: ${telestrokeNote.age || '__'}yo ${sexDisplay}
PMH: ${telestrokeNote.pmh || '__'}

PRESENTATION: ${telestrokeNote.symptoms || '__'} starting ${lkw} on ${lkwDate} (${timeElapsed} ago)

NIHSS: ${nihssDisplay}
ASPECTS: ${aspectsScore || '__'}

IMAGING:
- CT: ${telestrokeNote.ctResults || 'pending'}
- CTA: ${telestrokeNote.ctaResults || 'pending'}
- CTP: ${telestrokeNote.ctpResults || 'pending'}

TREATMENT:
${telestrokeNote.tnkRecommended ? 'TNK: Recommended' : 'TNK: Not Recommended'}
${telestrokeNote.evtRecommended ? 'EVT: Recommended' : 'EVT: Not Recommended'}

TO DO:
- Monitor BP goal <180/105
- Repeat NIHSS q4h
- Swallow eval when awake
- MRI brain
- Carotid ultrasound
- Echo
- Start ASA/statin after 24h if tPA given`;
          };

          // Stroke Alert Mode Timer
          const [alertElapsed, setAlertElapsed] = React.useState(0);
          React.useEffect(() => {
            let interval;
            if (strokeAlertMode && alertStartTime) {
              interval = setInterval(() => {
                setAlertElapsed(Math.floor((new Date() - alertStartTime) / 1000));
              }, 1000);
            }
            return () => clearInterval(interval);
          }, [strokeAlertMode, alertStartTime]);

          // Keyboard shortcuts
          React.useEffect(() => {
            const handleKeyDown = (e) => {
              // Ignore if user is typing in an input/textarea
              if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                return;
              }

              // Cmd/Ctrl + K: Open search
              if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                setSearchOpen(true);
                document.querySelector('input[placeholder*="Search"]')?.focus();
              }

              // Escape: Close search/modals
              if (e.key === 'Escape') {
                setSearchOpen(false);
              }

              // Number keys 1-6 for tab navigation
              const tabMap = {
                '1': 'encounter',
                '2': 'ich',
                '3': 'protocols',
                '4': 'calculators',
                '5': 'trials',
                '6': 'evidence'
              };

              if (tabMap[e.key] && !e.metaKey && !e.ctrlKey && !e.altKey) {
                e.preventDefault();
                setActiveTab(tabMap[e.key]);
              }

              // Ctrl/Cmd + E: Export to PDF
              if ((e.metaKey || e.ctrlKey) && e.key === 'e') {
                e.preventDefault();
                handleExportPDF();
              }

              // Ctrl/Cmd + D: Toggle dark mode
              if ((e.metaKey || e.ctrlKey) && e.key === 'd') {
                e.preventDefault();
                toggleDarkMode();
              }

              // ? key: Show keyboard shortcuts help
              if (e.key === '?' && !e.metaKey && !e.ctrlKey) {
                e.preventDefault();
                setShowKeyboardHelp(prev => !prev);
              }
            };

            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
          }, []);

          return (
            <div className={`max-w-7xl mx-auto p-3 sm:p-6 overflow-x-hidden ${darkMode ? 'bg-gray-900' : 'bg-white'}`} role="main">
              {/* Skip Navigation Link for Screen Readers */}
              <a
                href="#main-content"
                className="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-blue-600 focus:text-white focus:rounded-lg"
              >
                Skip to main content
              </a>

              {/* Header */}
              <div className="mb-4 sm:mb-6" role="banner">
                <div className="flex flex-col sm:flex-row justify-between items-center gap-3">
                  <div className="flex-1">
                    <h1 className="text-2xl sm:text-3xl font-bold text-blue-900 mb-1 text-center sm:text-left">
                      Stroke
                    </h1>
                  </div>
                  <div className="flex items-center gap-2">
                    {/* Search Bar with Results */}
                    <div className="relative">
                      <input
                        type="text"
                        placeholder="Search trials, calculators, evidence..."
                        value={searchQuery}
                        onChange={(e) => {
                          setSearchQuery(e.target.value);
                          setSearchOpen(true);
                        }}
                        onFocus={() => setSearchOpen(true)}
                        onBlur={() => setTimeout(() => setSearchOpen(false), 200)}
                        className="pl-8 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 md:w-64"
                        aria-label="Search clinical tools and protocols"
                      />
                      <i data-lucide="search" className="w-4 h-4 absolute left-2 top-3 text-gray-400"></i>

                      {/* Search Results Dropdown */}
                      {searchOpen && searchResults.length > 0 && (
                        <div className="absolute top-12 left-0 right-0 sm:right-auto sm:w-96 bg-white shadow-lg rounded-lg border max-h-96 overflow-y-auto z-50">
                          {searchResults.map((result, index) => (
                            <button
                              key={index}
                              onClick={result.action}
                              className="w-full text-left p-3 hover:bg-blue-50 border-b transition-colors"
                            >
                              <div className="flex items-start justify-between">
                                <div className="flex-1">
                                  <p className="font-semibold text-sm">{result.title}</p>
                                  {result.description && (
                                    <p className="text-xs text-gray-600 mt-1">{result.description}</p>
                                  )}
                                </div>
                                <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded ml-2">{result.type}</span>
                              </div>
                            </button>
                          ))}
                        </div>
                      )}
                    </div>

                    {/* New Patient Button */}
                    <button
                      onClick={resetAllData}
                      className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                      aria-label="Start new patient assessment"
                      title="Clear all data and start new patient"
                    >
                      <i data-lucide="user-plus" className="w-4 h-4"></i>
                      <span className="hidden lg:inline">New Patient</span>
                    </button>

                    {/* Export Button */}
                    <button
                      onClick={exportToPDF}
                      className="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium"
                      aria-label="Export to PDF"
                      title="Export current view to PDF"
                    >
                      <i data-lucide="download" className="w-4 h-4"></i>
                      <span className="hidden sm:inline">PDF</span>
                    </button>

                    {/* Share Button */}
                    <button
                      onClick={handleShare}
                      className="flex items-center gap-1 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors"
                      aria-label="Share this page"
                      title="Share this page"
                    >
                      <i data-lucide="share-2" className="w-4 h-4"></i>
                      <span className="hidden sm:inline">Share</span>
                    </button>

                    {/* Dark Mode Toggle */}
                    <button
                      onClick={toggleDarkMode}
                      className="p-2 border border-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                      aria-label={darkMode ? "Switch to light mode" : "Switch to dark mode"}
                      title={darkMode ? "Switch to light mode" : "Switch to dark mode"}
                    >
                      <i data-lucide={darkMode ? "sun" : "moon"} className="w-5 h-5"></i>
                    </button>
                  </div>
                </div>

                {/* Success Notification */}
                {copiedText && (
                  <div className="mt-2 p-2 bg-green-100 border border-green-400 text-green-700 rounded-lg text-sm flex items-center gap-2">
                    <i data-lucide="check" className="w-4 h-4"></i>
                    <span>{copiedText} copied to clipboard!</span>
                  </div>
                )}
              </div>

              {/* Keyboard Shortcuts Help Modal */}
              {showKeyboardHelp && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setShowKeyboardHelp(false)}>
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6" onClick={(e) => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-4">
                      <h2 className="text-2xl font-bold text-gray-900">Keyboard Shortcuts</h2>
                      <button
                        onClick={() => setShowKeyboardHelp(false)}
                        className="text-gray-500 hover:text-gray-700"
                        aria-label="Close keyboard shortcuts"
                      >
                        <i data-lucide="x" className="w-6 h-6"></i>
                      </button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="space-y-3">
                        <h3 className="font-semibold text-gray-800 mb-2">Navigation</h3>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Encounter Tab</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">1</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">ICH Tab</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">2</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Management Tab</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">3</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Calculators Tab</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">4</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Trials Tab</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">5</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">References Tab</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">6</kbd>
                        </div>
                      </div>
                      <div className="space-y-3">
                        <h3 className="font-semibold text-gray-800 mb-2">Actions</h3>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Open Search</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">⌘K / Ctrl+K</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Export to PDF</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">⌘E / Ctrl+E</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Toggle Dark Mode</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">⌘D / Ctrl+D</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Close Modals</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">Esc</kbd>
                        </div>
                        <div className="flex justify-between items-center">
                          <span className="text-gray-700">Show This Help</span>
                          <kbd className="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-sm font-mono">?</kbd>
                        </div>
                      </div>
                    </div>
                    <div className="mt-6 text-center">
                      <button
                        onClick={() => setShowKeyboardHelp(false)}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                      >
                        Got it!
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Critical Alerts Banner */}
              {criticalAlerts.length > 0 && (
                <div className="mb-4 space-y-2" role="alert" aria-live="assertive" aria-atomic="true">
                  {criticalAlerts.map(alert => (
                    <div
                      key={alert.id}
                      className={`p-4 rounded-lg border-2 flex items-start gap-3 ${
                        alert.level === 'critical'
                          ? 'bg-red-50 border-red-500 animate-pulse'
                          : 'bg-yellow-50 border-yellow-500'
                      }`}
                    >
                      <i
                        data-lucide="alert-triangle"
                        className={`w-6 h-6 flex-shrink-0 ${
                          alert.level === 'critical' ? 'text-red-600' : 'text-yellow-600'
                        }`}
                      ></i>
                      <div className="flex-1">
                        <p className={`font-bold text-lg ${
                          alert.level === 'critical' ? 'text-red-900' : 'text-yellow-900'
                        }`}>
                          {alert.message}
                        </p>
                        <p className={`text-sm mt-1 ${
                          alert.level === 'critical' ? 'text-red-700' : 'text-yellow-700'
                        }`}>
                          {alert.action}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* ============================================ */}
              {/* PATIENT CONTEXT BAR - Visible on ALL tabs   */}
              {/* Shows current patient summary + trial badges */}
              {/* ============================================ */}
              {(telestrokeNote.age || shiftPatients.length > 0) && (
                <div className="mb-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-3 shadow-sm">
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                    {/* Patient Summary */}
                    <div className="flex items-center gap-3 flex-1">
                      {/* Patient Switcher Dropdown */}
                      <div className="relative">
                        <button
                          onClick={() => setShowPatientSwitcher(!showPatientSwitcher)}
                          className="flex items-center gap-2 px-3 py-1.5 bg-white border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors text-sm font-medium text-blue-900"
                          title="Switch patient"
                        >
                          <i data-lucide="user" className="w-4 h-4 text-blue-600"></i>
                          <span className="max-w-[180px] truncate">
                            {telestrokeNote.age
                              ? `${telestrokeNote.age}${telestrokeNote.sex || '?'} ${(telestrokeNote.vesselOcclusion || []).includes('M1') ? 'M1' : (telestrokeNote.vesselOcclusion || []).includes('ICA') ? 'ICA' : 'AIS'}`
                              : 'Select Patient'}
                          </span>
                          <i data-lucide="chevron-down" className="w-3 h-3 text-blue-500"></i>
                          {shiftPatients.length > 0 && (
                            <span className="ml-1 px-1.5 py-0.5 text-xs bg-blue-100 text-blue-700 rounded-full">
                              {shiftPatients.length}
                            </span>
                          )}
                        </button>

                        {/* Patient Switcher Dropdown */}
                        {showPatientSwitcher && (
                          <div className="absolute top-full left-0 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-50 overflow-hidden">
                            <div className="p-2 border-b bg-gray-50">
                              <p className="text-xs font-semibold text-gray-600 uppercase tracking-wide">Shift Patients</p>
                            </div>
                            <div className="max-h-64 overflow-y-auto">
                              {shiftPatients.length === 0 ? (
                                <p className="p-3 text-sm text-gray-500 italic">No patients saved to shift yet</p>
                              ) : (
                                shiftPatients.map(patient => (
                                  <button
                                    key={patient.id}
                                    onClick={() => switchToPatient(patient.id)}
                                    className={`w-full p-3 text-left hover:bg-blue-50 border-b border-gray-100 transition-colors ${
                                      currentPatientId === patient.id ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''
                                    }`}
                                  >
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <p className="font-medium text-sm text-gray-900">{patient.summary.shortLabel}</p>
                                        <p className="text-xs text-gray-500">{patient.summary.timeFromLKW} from LKW</p>
                                      </div>
                                      <div className="flex gap-1">
                                        {patient.trialSummary.eligible > 0 && (
                                          <span className="px-1.5 py-0.5 text-xs bg-green-100 text-green-700 rounded">
                                            {patient.trialSummary.eligible}🟢
                                          </span>
                                        )}
                                        {patient.trialSummary.needsInfo > 0 && (
                                          <span className="px-1.5 py-0.5 text-xs bg-yellow-100 text-yellow-700 rounded">
                                            {patient.trialSummary.needsInfo}🟡
                                          </span>
                                        )}
                                      </div>
                                    </div>
                                  </button>
                                ))
                              )}
                            </div>
                            <div className="p-2 border-t bg-gray-50">
                              <button
                                onClick={startNewPatient}
                                className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium"
                              >
                                <i data-lucide="user-plus" className="w-4 h-4"></i>
                                New Patient
                              </button>
                            </div>
                          </div>
                        )}
                      </div>

                      {/* Current Patient Details */}
                      {telestrokeNote.age && (
                        <div className="hidden md:flex items-center gap-4 text-sm">
                          <span className="text-gray-600">
                            NIHSS <span className="font-bold text-gray-900">{telestrokeNote.nihss || nihssScore || '?'}</span>
                          </span>
                          <span className="text-gray-400">|</span>
                          <span className="text-gray-600">
                            <span className="font-bold text-gray-900">{(() => {
                              const tfLKW = calculateTimeFromLKW();
                              return tfLKW ? `${tfLKW.hours}h ${tfLKW.minutes}m` : '?';
                            })()}</span> from LKW
                          </span>
                        </div>
                      )}
                    </div>

                    {/* Trial Eligibility Badges */}
                    <div className="flex items-center gap-2">
                      <span className="text-xs text-gray-500 hidden sm:inline">Trials:</span>
                      {(() => {
                        const summary = getTrialEligibilitySummary();
                        return (
                          <div className="flex items-center gap-1">
                            {summary.eligible > 0 && (
                              <span
                                className="px-2 py-1 text-xs font-semibold bg-green-100 text-green-800 rounded-full border border-green-300 cursor-pointer hover:bg-green-200 transition-colors"
                                title={`${summary.eligible} trial(s) potentially eligible - click Trials tab for details`}
                                onClick={() => setActiveTab('trials')}
                              >
                                🟢 {summary.eligible}
                              </span>
                            )}
                            {summary.needsInfo > 0 && (
                              <span
                                className="px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-800 rounded-full border border-yellow-300 cursor-pointer hover:bg-yellow-200 transition-colors"
                                title={`${summary.needsInfo} trial(s) need more info`}
                                onClick={() => setActiveTab('trials')}
                              >
                                🟡 {summary.needsInfo}
                              </span>
                            )}
                            {summary.notEligible > 0 && summary.eligible === 0 && summary.needsInfo === 0 && (
                              <span
                                className="px-2 py-1 text-xs text-gray-500 bg-gray-100 rounded-full border border-gray-200"
                                title="No trial eligibility detected"
                              >
                                No trials
                              </span>
                            )}
                            {summary.total === 0 && (
                              <span className="px-2 py-1 text-xs text-gray-400 italic">
                                Enter data to check trials
                              </span>
                            )}
                          </div>
                        );
                      })()}

                      {/* Save to Shift Button */}
                      {telestrokeNote.age && (
                        <button
                          onClick={() => {
                            saveCurrentPatientToShift();
                            setCopiedText('Patient saved to shift');
                          }}
                          className="ml-2 p-1.5 text-blue-600 hover:bg-blue-100 rounded transition-colors"
                          title="Save patient to shift list"
                        >
                          <i data-lucide="bookmark-plus" className="w-4 h-4"></i>
                        </button>
                      )}

                      {/* Shift Sign-Out Button */}
                      {shiftPatients.length > 0 && (
                        <button
                          onClick={() => {
                            const signOut = generateShiftSignOut();
                            navigator.clipboard.writeText(signOut);
                            setCopiedText('Shift sign-out copied!');
                            setTimeout(() => setCopiedText(''), 2000);
                          }}
                          className="p-1.5 text-purple-600 hover:bg-purple-100 rounded transition-colors"
                          title="Copy shift sign-out summary"
                        >
                          <i data-lucide="clipboard-list" className="w-4 h-4"></i>
                        </button>
                      )}

                      {/* PHI-Free Sign-Out Button */}
                      <div className="relative">
                        <button
                          onClick={() => setShowSignOutManager(!showSignOutManager)}
                          className={`p-1.5 rounded transition-colors ${
                            showSignOutManager
                              ? 'bg-orange-100 text-orange-700'
                              : 'text-orange-600 hover:bg-orange-100'
                          }`}
                          title="Manage shift sign-outs"
                        >
                          <i data-lucide="send" className="w-4 h-4"></i>
                        </button>
                        {signOutPatients.length > 0 && (
                          <span className="absolute -top-1 -right-1 bg-orange-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center pointer-events-none">
                            {signOutPatients.length}
                          </span>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Sign-Out Manager Panel */}
                  {showSignOutManager && (
                    <div className="mt-3 pt-3 border-t border-blue-200">
                      <div className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                        <div className="flex items-center justify-between mb-2">
                          <h4 className="font-semibold text-orange-900 flex items-center gap-2">
                            <i data-lucide="send" className="w-4 h-4"></i>
                            Shift Sign-Out (PHI-Free)
                          </h4>
                          <div className="flex gap-1">
                            {signOutPatients.length > 0 && (
                              <>
                                <button
                                  onClick={copySignOutToClipboard}
                                  className="px-2 py-1 text-xs bg-orange-600 text-white rounded hover:bg-orange-700 flex items-center gap-1"
                                >
                                  <i data-lucide="copy" className="w-3 h-3"></i>
                                  Copy All
                                </button>
                                <button
                                  onClick={shareSignOut}
                                  className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-1"
                                >
                                  <i data-lucide="share-2" className="w-3 h-3"></i>
                                  Share
                                </button>
                              </>
                            )}
                          </div>
                        </div>

                        {/* Add Current Patient to Sign-Out */}
                        {telestrokeNote.age && (
                          <div className="mb-2">
                            <button
                              onClick={() => {
                                const label = prompt('Enter patient nickname (e.g., "MCA patient", "TIA obs"):', generateSignOutPatientId());
                                if (label !== null) {
                                  addToSignOut(label || generateSignOutPatientId());
                                }
                              }}
                              className="w-full px-3 py-2 text-sm bg-white border border-orange-300 rounded-lg hover:bg-orange-50 flex items-center justify-center gap-2"
                            >
                              <i data-lucide="plus" className="w-4 h-4"></i>
                              Add Current Patient to Sign-Out
                            </button>
                          </div>
                        )}

                        {/* Sign-Out List */}
                        {signOutPatients.length === 0 ? (
                          <p className="text-sm text-orange-700 italic text-center py-2">
                            No patients in sign-out list yet
                          </p>
                        ) : (
                          <div className="space-y-2 max-h-48 overflow-y-auto">
                            {signOutPatients.map((pt, idx) => (
                              <div key={pt.id} className="bg-white rounded border border-orange-200 p-2">
                                <div className="flex items-start justify-between">
                                  <div className="flex-1 min-w-0">
                                    <div className="font-medium text-sm text-gray-900 truncate">
                                      {pt.label}
                                      {pt.demographics && <span className="text-gray-500 ml-1">({pt.demographics})</span>}
                                    </div>
                                    <div className="text-xs text-gray-600 truncate">
                                      {pt.diagnosis || 'No diagnosis'}
                                      {pt.nihss && ` | NIHSS ${pt.nihss}`}
                                    </div>
                                    {pt.status && (
                                      <div className="text-xs text-blue-600 mt-0.5">{pt.status}</div>
                                    )}
                                  </div>
                                  <button
                                    onClick={() => removeSignOutEntry(pt.id)}
                                    className="ml-2 p-1 text-red-500 hover:bg-red-50 rounded"
                                    title="Remove from sign-out"
                                  >
                                    <i data-lucide="x" className="w-3 h-3"></i>
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}

                        {/* Actions */}
                        {signOutPatients.length > 0 && (
                          <div className="mt-2 pt-2 border-t border-orange-200 flex justify-between items-center">
                            <button
                              onClick={() => {
                                if (confirm('Clear all sign-out entries?')) {
                                  clearAllSignOuts();
                                }
                              }}
                              className="text-xs text-red-600 hover:underline"
                            >
                              Clear All
                            </button>
                            <span className="text-xs text-orange-600">
                              {signOutPatients.length} patient{signOutPatients.length !== 1 ? 's' : ''}
                            </span>
                          </div>
                        )}

                        {/* Preview */}
                        {signOutPatients.length > 0 && (
                          <details className="mt-2">
                            <summary className="text-xs text-orange-700 cursor-pointer hover:underline">
                              Preview sign-out text
                            </summary>
                            <pre className="mt-2 p-2 bg-white border border-orange-200 rounded text-xs font-mono whitespace-pre-wrap max-h-40 overflow-y-auto">
                              {generateSignOutText()}
                            </pre>
                          </details>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Quick Trial Alert - Only show if there's a highly eligible trial */}
                  {Object.values(trialEligibility).some(t => t?.status === 'eligible') && (
                    <div className="mt-2 pt-2 border-t border-blue-200">
                      <div className="flex items-center gap-2 text-sm">
                        <span className="text-green-700 font-semibold">🔬 Potential Trial Match:</span>
                        <span className="text-gray-700">
                          {Object.entries(trialEligibility)
                            .filter(([_, t]) => t?.status === 'eligible')
                            .map(([id, _]) => TRIAL_ELIGIBILITY_CONFIG[id]?.name || id)
                            .slice(0, 3)
                            .join(', ')}
                          {Object.values(trialEligibility).filter(t => t?.status === 'eligible').length > 3 && ' ...'}
                        </span>
                        <button
                          onClick={() => setActiveTab('trials')}
                          className="text-blue-600 hover:underline font-medium ml-auto"
                        >
                          View Details →
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Breadcrumb Navigation */}
              <div className="mb-4 flex items-center gap-2 text-sm text-gray-600">
                <button
                  onClick={() => setActiveTab('encounter')}
                  className="hover:text-blue-600 transition-colors flex items-center gap-1"
                  aria-label="Go to home"
                >
                  <i data-lucide="home" className="w-4 h-4"></i>
                  <span>Home</span>
                </button>
                <i data-lucide="chevron-right" className="w-4 h-4 text-gray-400"></i>
                <span className="font-semibold text-gray-900">
                  {activeTab === 'encounter' && 'Encounter'}
                  {activeTab === 'ich' && 'ICH Score'}
                  {activeTab === 'protocols' && 'Management Protocols'}
                  {activeTab === 'calculators' && 'Calculators'}
                  {activeTab === 'trials' && 'Clinical Trials'}
                  {activeTab === 'evidence' && 'References'}
                </span>
              </div>

              {/* Navigation Tabs - Desktop Only */}
              <div className="border-b border-gray-200 mb-4 sm:mb-6 pb-2 hidden md:block" role="navigation" aria-label="Main navigation">
                <nav className="flex flex-wrap justify-center gap-2 md:justify-between md:gap-0" role="tablist">
                  {[
                    { id: 'encounter', name: '⚡ Encounter', icon: 'activity' },
                    { id: 'ich', name: 'ICH', icon: 'alert-triangle' },
                    { id: 'protocols', name: 'Management', icon: 'file-text' },
                    { id: 'calculators', name: 'Calculators', icon: 'calculator' },
                    { id: 'trials', name: 'Trials', icon: 'file-text' },
                    { id: 'evidence', name: 'References', icon: 'file-text' },
                    { id: 'regional', name: 'Regional Hospitals', icon: 'map' }
                  ].map(tab => {
                    return (
                      <button
                        key={tab.id}
                        onClick={() => {
                          if (tab.id === 'regional') {
                            window.open('https://rkalani1.github.io/telestroke-expansion-map/', '_blank');
                          } else {
                            setActiveTab(tab.id);
                          }
                        }}
                        className={`py-2 px-3 border-2 rounded-lg font-medium text-xs flex items-center space-x-1 transition-all
                          ${activeTab === tab.id
                            ? 'border-blue-500 bg-blue-50 text-blue-600'
                            : 'border-gray-300 bg-white text-gray-600 hover:text-gray-800 hover:border-gray-400'
                          }
                          sm:py-2 sm:px-2 sm:border-b-2 sm:border-t-0 sm:border-l-0 sm:border-r-0 sm:rounded-none
                          md:text-xs
                        `}
                      >
                        <i data-lucide={tab.icon} className="w-3 h-3 hidden sm:block"></i>
                        <span>{tab.name}</span>
                      </button>
                    );
                  })}
                </nav>
              </div>

              {/* STROKE ALERT MODE OVERLAY */}
              {strokeAlertMode && (
                <div className="fixed inset-0 z-50 bg-red-900 overflow-auto">
                  <div className="min-h-screen p-4">
                    {/* Header with Timer and Exit */}
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-4">
                        <span className="text-3xl font-bold text-white">🚨 STROKE ALERT</span>
                        {alertStartTime && (
                          <div className="bg-white text-red-900 px-4 py-2 rounded-lg font-mono text-2xl font-bold">
                            {`${Math.floor(alertElapsed / 60).toString().padStart(2, '0')}:${(alertElapsed % 60).toString().padStart(2, '0')}`}
                          </div>
                        )}
                      </div>
                      <button
                        onClick={() => {
                          setStrokeAlertMode(false);
                          setAlertStartTime(null);
                        }}
                        className="bg-white text-red-900 px-4 py-2 rounded-lg font-bold hover:bg-gray-100"
                      >
                        ✕ Exit Alert Mode
                      </button>
                    </div>

                    {/* Main Grid - Rapid Entry */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">

                      {/* Column 1: Patient ID */}
                      <div className="bg-white rounded-xl p-4 space-y-3">
                        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">👤 Patient</h3>

                        <div className="grid grid-cols-3 gap-2">
                          <div>
                            <label className="block text-xs text-gray-500 mb-1">Age</label>
                            <input
                              type="number"
                              value={telestrokeNote.age}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, age: e.target.value})}
                              className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-2xl font-bold text-center focus:border-blue-500"
                              placeholder="Age"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-gray-500 mb-1">Sex</label>
                            <select
                              value={telestrokeNote.sex}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, sex: e.target.value})}
                              className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-xl font-bold focus:border-blue-500"
                            >
                              <option value="">-</option>
                              <option value="M">M</option>
                              <option value="F">F</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-xs text-gray-500 mb-1">Side</label>
                            <div className="flex gap-1">
                              <button
                                onClick={() => setTelestrokeNote({...telestrokeNote, affectedSide: 'L'})}
                                className={`flex-1 py-2 rounded font-bold ${telestrokeNote.affectedSide === 'L' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                              >L</button>
                              <button
                                onClick={() => setTelestrokeNote({...telestrokeNote, affectedSide: 'R'})}
                                className={`flex-1 py-2 rounded font-bold ${telestrokeNote.affectedSide === 'R' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                              >R</button>
                            </div>
                          </div>
                        </div>

                        <div>
                          <label className="block text-xs text-gray-500 mb-1">Weight (kg)</label>
                          <input
                            type="number"
                            value={telestrokeNote.weight}
                            onChange={(e) => setTelestrokeNote({...telestrokeNote, weight: e.target.value})}
                            className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-xl font-bold focus:border-blue-500"
                            placeholder="Weight in kg"
                          />
                          {telestrokeNote.weight && calculateTNKDose(telestrokeNote.weight) && (
                            <div className="mt-2 bg-green-100 p-2 rounded text-center">
                              <span className="text-xl font-bold text-green-800">
                                TNK: {calculateTNKDose(telestrokeNote.weight).calculatedDose} mg
                              </span>
                            </div>
                          )}
                        </div>
                      </div>

                      {/* Column 2: LKW & Time */}
                      <div className="bg-white rounded-xl p-4 space-y-3">
                        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">⏰ Last Known Well</h3>

                        <div className="grid grid-cols-2 gap-2">
                          <div>
                            <label className="block text-xs text-gray-500 mb-1">Date</label>
                            <input
                              type="date"
                              value={telestrokeNote.lkwDate}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, lkwDate: e.target.value})}
                              className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500"
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-gray-500 mb-1">Time</label>
                            <input
                              type="time"
                              value={telestrokeNote.lkwTime}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, lkwTime: e.target.value})}
                              className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500"
                            />
                          </div>
                        </div>

                        {/* Time from LKW Display */}
                        {telestrokeNote.lkwDate && telestrokeNote.lkwTime && (
                          <div className={`text-center p-3 rounded-lg ${
                            (() => {
                              const lkw = new Date(`${telestrokeNote.lkwDate}T${telestrokeNote.lkwTime}`);
                              const hours = (new Date() - lkw) / (1000 * 60 * 60);
                              if (hours <= 4.5) return 'bg-green-100 text-green-800';
                              if (hours <= 24) return 'bg-amber-100 text-amber-800';
                              return 'bg-red-100 text-red-800';
                            })()
                          }`}>
                            <span className="text-2xl font-bold">
                              {(() => {
                                const lkw = new Date(`${telestrokeNote.lkwDate}T${telestrokeNote.lkwTime}`);
                                const hours = (new Date() - lkw) / (1000 * 60 * 60);
                                return hours.toFixed(1);
                              })()} hours
                            </span>
                            <span className="text-sm block">from LKW</span>
                          </div>
                        )}
                      </div>

                      {/* Column 3: NIHSS & Key Labs */}
                      <div className="bg-white rounded-xl p-4 space-y-3">
                        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">📊 Quick Assessment</h3>

                        <div>
                          <label className="block text-xs text-gray-500 mb-1">NIHSS Score</label>
                          <input
                            type="number"
                            value={telestrokeNote.nihss}
                            onChange={(e) => setTelestrokeNote({...telestrokeNote, nihss: e.target.value})}
                            className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-3xl font-bold text-center focus:border-blue-500"
                            placeholder="0-42"
                            min="0"
                            max="42"
                          />
                        </div>

                        <div className="grid grid-cols-3 gap-2">
                          <div>
                            <label className="block text-xs text-gray-500 mb-1">Glucose</label>
                            <input
                              type="number"
                              value={telestrokeNote.glucose}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, glucose: e.target.value})}
                              className={`w-full px-2 py-1 border-2 rounded text-lg font-bold text-center ${
                                parseFloat(telestrokeNote.glucose) < 50 || parseFloat(telestrokeNote.glucose) > 400
                                  ? 'border-red-500 bg-red-50' : 'border-gray-300'
                              }`}
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-gray-500 mb-1">INR</label>
                            <input
                              type="number"
                              value={telestrokeNote.inr}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, inr: e.target.value})}
                              step="0.1"
                              className={`w-full px-2 py-1 border-2 rounded text-lg font-bold text-center ${
                                parseFloat(telestrokeNote.inr) > 1.7 ? 'border-red-500 bg-red-50' : 'border-gray-300'
                              }`}
                            />
                          </div>
                          <div>
                            <label className="block text-xs text-gray-500 mb-1">BP</label>
                            <input
                              type="text"
                              value={telestrokeNote.presentingBP}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, presentingBP: e.target.value})}
                              placeholder="120/80"
                              className={`w-full px-2 py-1 border-2 rounded text-lg font-bold text-center ${
                                (() => {
                                  const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                                  if (bpStatus.status === 'too_high') return 'border-red-500 bg-red-50';
                                  if (bpStatus.status === 'borderline') return 'border-yellow-500 bg-yellow-50';
                                  if (bpStatus.status === 'ok') return 'border-green-500 bg-green-50';
                                  return 'border-gray-300';
                                })()
                              }`}
                            />
                            {/* BP Threshold Badge */}
                            {(() => {
                              const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                              if (bpStatus.status === 'unknown') return null;
                              return (
                                <div className={`mt-1 px-2 py-0.5 rounded text-xs font-semibold border text-center ${bpStatus.badgeClass}`}>
                                  {bpStatus.icon} {bpStatus.message}
                                </div>
                              );
                            })()}
                            {/* Quick BP Math - how much to lower */}
                            {(() => {
                              const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                              if (!bpStatus.needsLowering) return null;
                              return (
                                <div className="mt-1 text-xs text-red-700 font-medium text-center">
                                  Lower by {bpStatus.sbpToLower}/{bpStatus.dbpToLower} mmHg
                                </div>
                              );
                            })()}
                          </div>
                        </div>
                      </div>

                      {/* Row 2: Decision Panel - Full Width */}
                      <div className="bg-white rounded-xl p-4 md:col-span-2 lg:col-span-3">
                        <h3 className="text-lg font-bold text-gray-900 border-b pb-2 mb-4">⚡ Treatment Decision</h3>

                        <div className="grid grid-cols-2 gap-6">
                          {/* TNK Decision */}
                          <div className={`p-4 rounded-xl border-4 ${telestrokeNote.tnkRecommended ? 'border-green-500 bg-green-50' : 'border-gray-300'}`}>
                            <div className="flex items-center justify-between mb-3">
                              <span className="text-xl font-bold">TNK (Thrombolysis)</span>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => setTelestrokeNote({...telestrokeNote, tnkRecommended: true})}
                                  className={`px-6 py-3 rounded-lg text-lg font-bold transition ${
                                    telestrokeNote.tnkRecommended === true
                                      ? 'bg-green-500 text-white'
                                      : 'bg-gray-200 hover:bg-gray-300'
                                  }`}
                                >✓ YES</button>
                                <button
                                  onClick={() => setTelestrokeNote({...telestrokeNote, tnkRecommended: false})}
                                  className={`px-6 py-3 rounded-lg text-lg font-bold transition ${
                                    telestrokeNote.tnkRecommended === false
                                      ? 'bg-red-500 text-white'
                                      : 'bg-gray-200 hover:bg-gray-300'
                                  }`}
                                >✗ NO</button>
                              </div>
                            </div>
                            {telestrokeNote.tnkRecommended && telestrokeNote.weight && (
                              <div className="text-center bg-green-200 p-3 rounded-lg">
                                <span className="text-2xl font-bold text-green-800">
                                  Dose: {calculateTNKDose(telestrokeNote.weight)?.calculatedDose} mg
                                </span>
                              </div>
                            )}
                          </div>

                          {/* EVT Decision */}
                          <div className={`p-4 rounded-xl border-4 ${telestrokeNote.evtRecommended ? 'border-purple-500 bg-purple-50' : 'border-gray-300'}`}>
                            <div className="flex items-center justify-between mb-3">
                              <span className="text-xl font-bold">EVT (Thrombectomy)</span>
                              <div className="flex gap-2">
                                <button
                                  onClick={() => setTelestrokeNote({...telestrokeNote, evtRecommended: true})}
                                  className={`px-6 py-3 rounded-lg text-lg font-bold transition ${
                                    telestrokeNote.evtRecommended === true
                                      ? 'bg-purple-500 text-white'
                                      : 'bg-gray-200 hover:bg-gray-300'
                                  }`}
                                >✓ YES</button>
                                <button
                                  onClick={() => setTelestrokeNote({...telestrokeNote, evtRecommended: false})}
                                  className={`px-6 py-3 rounded-lg text-lg font-bold transition ${
                                    telestrokeNote.evtRecommended === false
                                      ? 'bg-red-500 text-white'
                                      : 'bg-gray-200 hover:bg-gray-300'
                                  }`}
                                >✗ NO</button>
                              </div>
                            </div>
                            {telestrokeNote.evtRecommended && (
                              <div className="text-center bg-purple-200 p-3 rounded-lg">
                                <span className="text-lg font-bold text-purple-800">
                                  🚁 Activate Transfer / Thrombectomy Team
                                </span>
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Contraindication Alerts in Alert Mode */}
                        {(() => {
                          const alerts = detectContraindications({ telestrokeNote });
                          if (alerts.length === 0) return null;
                          return (
                            <div className="mt-4 bg-red-100 border-2 border-red-400 rounded-lg p-3">
                              <span className="font-bold text-red-800">⚠️ ALERTS:</span>
                              <ul className="mt-2 space-y-1">
                                {alerts.map((alert, idx) => (
                                  <li key={idx} className="text-red-700 text-sm">
                                    <strong>{alert.label}:</strong> {alert.message}
                                  </li>
                                ))}
                              </ul>
                            </div>
                          );
                        })()}
                      </div>

                    </div>

                    {/* Bottom Action Bar */}
                    <div className="mt-4 flex justify-center gap-4">
                      <button
                        onClick={() => {
                          setStrokeAlertMode(false);
                          setActiveTab('encounter');
                        }}
                        className="px-8 py-4 bg-blue-600 text-white rounded-xl font-bold text-lg hover:bg-blue-700"
                      >
                        📝 Continue to Full Encounter
                      </button>
                      <button
                        onClick={() => {
                          setStrokeAlertMode(false);
                          setAlertStartTime(null);
                        }}
                        className="px-8 py-4 bg-gray-600 text-white rounded-xl font-bold text-lg hover:bg-gray-700"
                      >
                        ✕ Close Alert Mode
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Content */}
              <div id="main-content" className="space-y-4 sm:space-y-6 pb-24 md:pb-0" role="region" aria-label="Main content area">

                {/* CONSOLIDATED ENCOUNTER TAB */}
                {activeTab === 'encounter' && (
                  <div key="encounter-tab" className="space-y-4">
                    {/* Quick Links */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <div className="flex flex-col sm:flex-row gap-3">
                        <button
                          onClick={() => {
                            setStrokeAlertMode(true);
                            setAlertStartTime(new Date());
                          }}
                          className="flex items-center gap-2 px-4 py-3 bg-red-600 border-2 border-red-700 rounded-lg hover:bg-red-700 transition-colors text-white font-bold animate-pulse"
                        >
                          <span className="text-xl">🚨</span>
                          <span>STROKE ALERT</span>
                        </button>
                        <a
                          href="https://us-app.pulsara.com/user/login"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                        >
                          <i data-lucide="external-link" className="w-5 h-5"></i>
                          <span>Pulsara</span>
                        </a>
                        <a
                          href="https://urldefense.com/v3/__https:/imaging.visitnow.org/studies__;!!K-Hz7m0Vt54!nECcOahuNh21d0jzlVH-mSie_Il2fvDWCKseicWktKKQwdj4xk9XfAX2s8QyVGAs0n-NvzXDLAHKDw%24"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                        >
                          <i data-lucide="external-link" className="w-5 h-5"></i>
                          <span>Teladoc Imaging</span>
                        </a>
                        <a
                          href="https://intranet.neurology.uw.edu/telestroke-provider-resources/"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                        >
                          <i data-lucide="external-link" className="w-5 h-5"></i>
                          <span>Telestroke Provider Resources</span>
                        </a>
                        <a
                          href="https://access.uwmedicine.org/logon/LogonPoint/tmindex.html"
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                        >
                          <i data-lucide="external-link" className="w-5 h-5"></i>
                          <span>UW Medicine</span>
                        </a>
                      </div>
                    </div>

                    {/* Last Known Well Input */}
                    <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                      <label className="block font-semibold text-blue-900 mb-2">
                        <i data-lucide="clock" className="w-4 h-4 inline mr-1"></i>
                        Last Known Well Time *
                      </label>

                      {/* Separate Date and Time Inputs */}
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div className="min-w-0">
                          <label className="block text-sm font-medium text-blue-900 mb-1">Date</label>
                          <input
                            type="date"
                            value={lkwTime ? lkwTime.toISOString().split('T')[0] : ''}
                            onChange={(e) => {
                              if (e.target.value) {
                                const newDate = new Date(e.target.value);
                                if (lkwTime) {
                                  newDate.setHours(lkwTime.getHours(), lkwTime.getMinutes());
                                }
                                setLkwTime(newDate);
                              }
                            }}
                            max={currentTime.toISOString().split('T')[0]}
                            className="w-full px-2 sm:px-4 py-3 border-2 border-blue-300 rounded-lg text-base sm:text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 max-w-full"
                            style={{boxSizing: 'border-box'}}
                          />
                        </div>
                        <div className="min-w-0">
                          <label className="block text-sm font-medium text-blue-900 mb-1">Time</label>
                          <input
                            type="time"
                            value={lkwTime ? lkwTime.toTimeString().slice(0, 5) : ''}
                            onChange={(e) => {
                              if (e.target.value) {
                                const [hours, minutes] = e.target.value.split(':');
                                const newDate = lkwTime ? new Date(lkwTime) : new Date();
                                newDate.setHours(parseInt(hours), parseInt(minutes));
                                setLkwTime(newDate);
                              }
                            }}
                            className="w-full px-2 sm:px-4 py-3 border-2 border-blue-300 rounded-lg text-base sm:text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 max-w-full"
                            style={{boxSizing: 'border-box'}}
                          />
                        </div>
                      </div>

                      {/* Time from LKW Display */}
                      {lkwTime && (
                        <div className="mt-3 bg-blue-100 rounded-lg p-3 text-center">
                          <span className="text-2xl font-bold text-blue-900">
                            {(() => {
                              const tf = calculateTimeFromLKW();
                              return tf ? `${tf.hours}h ${tf.minutes}m` : '';
                            })()}
                          </span>
                          <span className="text-sm text-blue-700 ml-2">from LKW</span>
                        </div>
                      )}
                    </div>

                    {/* Two-Column Layout: Desktop/Tablet | Single Column: Mobile */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">

                      {/* LEFT COLUMN - Data Entry (2/3 width on desktop) */}
                      <div className="lg:col-span-2 space-y-4">

                        {/* Section 1: Patient Info */}
                        <div className="bg-white border-2 border-blue-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-blue-900">1. Patient Info</h3>
                            <i data-lucide="user" className="w-5 h-5 text-blue-600"></i>
                          </div>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Age</label>
                              <input
                                type="number"
                                value={telestrokeNote.age}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, age: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder=""
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Sex</label>
                              <select
                                value={telestrokeNote.sex}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, sex: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="M">M</option>
                                <option value="F">F</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                Weight
                                <span className="ml-1 text-xs text-orange-600 font-normal">(TNK dosing)</span>
                              </label>
                              <div className="flex items-center">
                                <input
                                  type="number"
                                  value={telestrokeNote.weight}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, weight: e.target.value})}
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder=""
                                  min="0"
                                />
                                <span className="ml-1 text-xs text-gray-500">kg</span>
                              </div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                Pre-stroke mRS
                                <span className="ml-1 text-xs text-blue-600 font-normal">(trials)</span>
                              </label>
                              <select
                                value={telestrokeNote.premorbidMRS}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, premorbidMRS: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              >
                                <option value="">Select...</option>
                                <option value="0">0 - No symptoms</option>
                                <option value="1">1 - No significant disability</option>
                                <option value="2">2 - Slight disability</option>
                                <option value="3">3 - Moderate disability</option>
                                <option value="4">4 - Moderately severe disability</option>
                                <option value="5">5 - Severe disability</option>
                              </select>
                            </div>
                          </div>
                          {/* Auto TNK Dose Display */}
                          {telestrokeNote.weight && calculateTNKDose(telestrokeNote.weight) && (
                            <div className="mt-2 bg-orange-50 border border-orange-200 rounded-lg p-2 flex items-center justify-between">
                              <div className="flex items-center gap-2">
                                <span className="text-orange-800 font-medium">💉 TNK Dose:</span>
                                <span className="text-lg font-bold text-orange-700">{calculateTNKDose(telestrokeNote.weight).calculatedDose} mg</span>
                                <span className="text-sm text-orange-600">({calculateTNKDose(telestrokeNote.weight).volume})</span>
                              </div>
                              <span className="text-xs text-orange-500">0.25 mg/kg, max 25 mg</span>
                            </div>
                          )}
                          <div className="mt-3">
                            <label className="block text-sm font-medium text-gray-700 mb-1">Chief Complaint</label>
                            <input
                              type="text"
                              value={telestrokeNote.chiefComplaint}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, chiefComplaint: e.target.value})}
                              placeholder=""
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>

                        {/* Section 2: History & Medications */}
                        <div className="bg-white border-2 border-purple-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-purple-900">2. History & Medications</h3>
                            <i data-lucide="file-text" className="w-5 h-5 text-purple-600"></i>
                          </div>
                          <div className="space-y-3">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Presenting Symptoms</label>
                              <textarea
                                value={telestrokeNote.symptoms}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, symptoms: e.target.value})}
                                placeholder=""
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Relevant PMH</label>
                              <input
                                type="text"
                                value={telestrokeNote.pmh}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, pmh: e.target.value})}
                                placeholder=""
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Medications</label>
                              <textarea
                                value={telestrokeNote.medications}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, medications: e.target.value})}
                                placeholder=""
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            {/* DOAC Status for thrombolysis eligibility */}
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 space-y-2">
                              <div className="flex items-center gap-2">
                                <span className="text-sm font-medium text-amber-800">💊 Anticoagulation Status</span>
                                <span className="text-xs text-amber-600">(Critical for thrombolysis)</span>
                              </div>
                              <div className="grid grid-cols-2 gap-3">
                                <div>
                                  <label className="block text-xs text-gray-600 mb-1">Anticoagulant Type</label>
                                  <select
                                    value={telestrokeNote.lastDOACType}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, lastDOACType: e.target.value})}
                                    className="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  >
                                    <option value="">None / Unknown</option>
                                    <option value="apixaban">Apixaban (Eliquis)</option>
                                    <option value="rivaroxaban">Rivaroxaban (Xarelto)</option>
                                    <option value="dabigatran">Dabigatran (Pradaxa)</option>
                                    <option value="edoxaban">Edoxaban (Savaysa)</option>
                                    <option value="warfarin">Warfarin (check INR)</option>
                                    <option value="heparin">Heparin (check PTT)</option>
                                  </select>
                                </div>
                                <div>
                                  <label className="block text-xs text-gray-600 mb-1">Last Dose (date/time)</label>
                                  <input
                                    type="datetime-local"
                                    value={telestrokeNote.lastDOACDose}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, lastDOACDose: e.target.value})}
                                    className="w-full px-2 py-1.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                              </div>
                              {telestrokeNote.lastDOACType && telestrokeNote.lastDOACType !== 'warfarin' && telestrokeNote.lastDOACType !== 'heparin' && (
                                <div className="text-xs text-amber-700 bg-amber-100 p-2 rounded">
                                  ⚠️ DOACs within 48h may contraindicate thrombolysis. Consider drug-specific assays (anti-Xa, dTT).
                                </div>
                              )}
                            </div>
                          </div>
                        </div>

                        {/* Section 3: NIHSS Examination */}
                        <div className="bg-white border-2 border-red-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-red-900">3. NIHSS Examination</h3>
                            <div className="flex items-center gap-2">
                              <span className="text-2xl font-bold text-red-600">Score: {nihssScore}</span>
                              <i data-lucide="brain" className="w-5 h-5 text-red-600"></i>
                            </div>
                          </div>

                          {/* Quick NIHSS Entry */}
                          <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                            <p className="text-sm font-medium text-gray-700 mb-2">Quick Entry:</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                              <div>
                                <label className="block text-xs text-gray-500 mb-1">NIHSS Score (0-42)</label>
                                <input
                                  type="number"
                                  value={telestrokeNote.nihss}
                                  onChange={(e) => {
                                    const value = e.target.value;
                                    setTelestrokeNote({...telestrokeNote, nihss: value});
                                    setNihssScore(parseInt(value) || 0);
                                  }}
                                  min="0"
                                  max="42"
                                  className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg text-2xl font-bold text-center focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <div>
                                <label className="block text-xs text-gray-500 mb-1">Neurologic Deficits</label>
                                <input
                                  type="text"
                                  value={telestrokeNote.nihssDetails}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, nihssDetails: e.target.value})}
                                  placeholder="e.g., R hemiparesis, aphasia"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                            </div>

                            {/* NIHSS Severity Interpretation */}
                            {(telestrokeNote.nihss || nihssScore > 0) && (
                              <div className={`p-2 rounded-lg text-center text-sm font-medium ${
                                nihssScore === 0 ? 'bg-green-100 text-green-800' :
                                nihssScore <= 4 ? 'bg-blue-100 text-blue-800' :
                                nihssScore <= 15 ? 'bg-yellow-100 text-yellow-800' :
                                nihssScore <= 20 ? 'bg-orange-100 text-orange-800' :
                                'bg-red-100 text-red-800'
                              }`}>
                                {nihssScore === 0 ? '0 = No stroke symptoms' :
                                 nihssScore <= 4 ? `${nihssScore} = Minor stroke` :
                                 nihssScore <= 15 ? `${nihssScore} = Moderate stroke` :
                                 nihssScore <= 20 ? `${nihssScore} = Moderate-Severe stroke` :
                                 `${nihssScore} = Severe stroke`}
                                {nihssScore >= 6 && nihssScore <= 24 && ' | Consider TNK if within window'}
                                {nihssScore >= 6 && ' | Consider LVO screening'}
                              </div>
                            )}
                          </div>

                          {/* Full NIHSS Calculator (Collapsible) */}
                          <details className="bg-gray-50 border border-gray-200 rounded-lg">
                            <summary className="cursor-pointer p-3 font-semibold text-gray-800 hover:bg-gray-100 rounded-lg">
                              📊 Full NIHSS Calculator (Click to expand)
                            </summary>
                            <div className="p-4 space-y-3">
                              {nihssItems.map((item) => (
                                <div key={item.id} className="bg-white p-3 rounded border">
                                  <h4 className="font-semibold text-sm mb-2">{item.name}</h4>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {item.options.map((option, optionIndex) => (
                                      <label key={optionIndex} className="flex items-center space-x-2 cursor-pointer text-sm">
                                        <input
                                          type="radio"
                                          name={item.id}
                                          value={option}
                                          checked={patientData[item.id] === option}
                                          onChange={(e) => {
                                            const newData = { ...patientData, [item.id]: e.target.value };
                                            setPatientData(newData);
                                            const newScore = calculateNIHSS(newData);
                                            setNihssScore(newScore);
                                            setTelestrokeNote({...telestrokeNote, nihss: newScore.toString()});
                                          }}
                                          className="text-blue-600"
                                        />
                                        <span>{option}</span>
                                      </label>
                                    ))}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </details>
                        </div>

                        {/* Section 4: Vitals & Labs */}
                        <div className="bg-white border-2 border-green-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-green-900">4. Vitals & Labs</h3>
                            <i data-lucide="activity" className="w-5 h-5 text-green-600"></i>
                          </div>
                          <div className="space-y-3">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Presenting BP</label>
                                <div className="flex items-center gap-2">
                                  <input
                                    type="text"
                                    value={telestrokeNote.presentingBP}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, presentingBP: e.target.value})}
                                    placeholder="185/110"
                                    className={`flex-1 px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                      (() => {
                                        const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                                        if (bpStatus.status === 'too_high') return 'border-red-400 bg-red-50';
                                        if (bpStatus.status === 'borderline') return 'border-yellow-400 bg-yellow-50';
                                        if (bpStatus.status === 'ok') return 'border-green-400 bg-green-50';
                                        return 'border-gray-300';
                                      })()
                                    }`}
                                  />
                                  {/* Inline BP Status Badge */}
                                  {(() => {
                                    const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                                    if (bpStatus.status === 'unknown') return null;
                                    return (
                                      <span className={`px-2 py-1 rounded text-xs font-bold border whitespace-nowrap ${bpStatus.badgeClass}`}>
                                        {bpStatus.icon} {bpStatus.message}
                                      </span>
                                    );
                                  })()}
                                </div>
                                {/* Quick BP Math - how much to lower */}
                                {(() => {
                                  const bpStatus = getBPThresholdStatus(telestrokeNote.presentingBP);
                                  if (!bpStatus.needsLowering) return null;
                                  return (
                                    <div className="mt-1 px-2 py-1 bg-red-100 border border-red-300 rounded text-xs text-red-800 font-medium">
                                      Need to lower by {bpStatus.sbpToLower}/{bpStatus.dbpToLower} mmHg to reach 185/110
                                    </div>
                                  );
                                })()}
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Current BP (prior to TNK, if applicable)</label>
                                <div className="flex items-center gap-2">
                                  <input
                                    type="text"
                                    value={telestrokeNote.bpPreTNK}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, bpPreTNK: e.target.value})}
                                    placeholder="185/110"
                                    className={`flex-1 px-3 py-2 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 ${
                                      (() => {
                                        const bpStatus = getBPThresholdStatus(telestrokeNote.bpPreTNK);
                                        if (bpStatus.status === 'too_high') return 'border-red-400 bg-red-50';
                                        if (bpStatus.status === 'borderline') return 'border-yellow-400 bg-yellow-50';
                                        if (bpStatus.status === 'ok') return 'border-green-400 bg-green-50';
                                        return 'border-gray-300';
                                      })()
                                    }`}
                                  />
                                  <input
                                    type="time"
                                    value={telestrokeNote.bpPreTNKTime}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, bpPreTNKTime: e.target.value})}
                                    className="w-24 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  />
                                  {/* Inline BP Status Badge for Pre-TNK BP */}
                                  {(() => {
                                    const bpStatus = getBPThresholdStatus(telestrokeNote.bpPreTNK);
                                    if (bpStatus.status === 'unknown') return null;
                                    return (
                                      <span className={`px-2 py-1 rounded text-xs font-bold border whitespace-nowrap ${bpStatus.badgeClass}`}>
                                        {bpStatus.icon} {bpStatus.message}
                                      </span>
                                    );
                                  })()}
                                </div>
                                {/* Quick BP Math for Pre-TNK BP */}
                                {(() => {
                                  const bpStatus = getBPThresholdStatus(telestrokeNote.bpPreTNK);
                                  if (!bpStatus.needsLowering) return null;
                                  return (
                                    <div className="mt-1 px-2 py-1 bg-red-100 border border-red-300 rounded text-xs text-red-800 font-medium">
                                      Need to lower by {bpStatus.sbpToLower}/{bpStatus.dbpToLower} mmHg to reach 185/110
                                    </div>
                                  );
                                })()}
                              </div>
                            </div>
                            {/* Post-TNK BP Target Reminder */}
                            {(telestrokeNote.tnkRecommended || telestrokeNote.dtnTnkAdministered) && (
                              <div className="mt-2 px-3 py-2 bg-blue-50 border-l-4 border-blue-500 rounded-r text-sm">
                                <span className="font-bold text-blue-800">Post-TNK Target:</span>
                                <span className="text-blue-700 ml-2">&lt;180/105 for 24 hours after thrombolysis</span>
                              </div>
                            )}
                            <div className="grid grid-cols-3 gap-3">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Glucose</label>
                                <div className="flex items-center">
                                  <input
                                    type="number"
                                    value={telestrokeNote.glucose}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, glucose: e.target.value})}
                                    placeholder=""
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    min="0"
                                  />
                                  <span className="ml-1 text-xs text-gray-500">mg/dL</span>
                                </div>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">INR</label>
                                <input
                                  type="number"
                                  value={telestrokeNote.inr}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, inr: e.target.value})}
                                  placeholder=""
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  step="0.1"
                                  min="0"
                                />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Platelets</label>
                                <div className="flex items-center">
                                  <input
                                    type="number"
                                    value={telestrokeNote.plateletCount}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, plateletCount: e.target.value})}
                                    placeholder=""
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    min="0"
                                  />
                                  <span className="ml-1 text-xs text-gray-500">/μL</span>
                                </div>
                              </div>
                            </div>

                            {/* Critical Timestamps for DTN/DTP */}
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                              <h4 className="font-semibold text-yellow-800 mb-2">⏱️ Critical Timestamps</h4>
                              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <div>
                                  <label className="block text-xs font-medium text-gray-600 mb-1">Door Time (ED Arrival)</label>
                                  <input
                                    type="time"
                                    value={telestrokeNote.doorTime || ''}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, doorTime: e.target.value})}
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-yellow-500"
                                  />
                                </div>
                                <div>
                                  <label className="block text-xs font-medium text-gray-600 mb-1">CT Time</label>
                                  <input
                                    type="time"
                                    value={telestrokeNote.ctTime || ''}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, ctTime: e.target.value})}
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-yellow-500"
                                  />
                                </div>
                                <div>
                                  <label className="block text-xs font-medium text-gray-600 mb-1">Needle Time (TNK)</label>
                                  <input
                                    type="time"
                                    value={telestrokeNote.needleTime || ''}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, needleTime: e.target.value})}
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-yellow-500"
                                  />
                                </div>
                                <div>
                                  <label className="block text-xs font-medium text-gray-600 mb-1">Puncture Time (EVT)</label>
                                  <input
                                    type="time"
                                    value={telestrokeNote.punctureTime || ''}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, punctureTime: e.target.value})}
                                    className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-yellow-500"
                                  />
                                </div>
                              </div>

                              {/* DTN/DTP Auto-Calculation */}
                              {(telestrokeNote.doorTime && (telestrokeNote.needleTime || telestrokeNote.punctureTime)) && (
                                <div className="mt-3 grid grid-cols-2 gap-3">
                                  {telestrokeNote.needleTime && (() => {
                                    const [doorH, doorM] = telestrokeNote.doorTime.split(':').map(Number);
                                    const [needleH, needleM] = telestrokeNote.needleTime.split(':').map(Number);
                                    let dtn = (needleH * 60 + needleM) - (doorH * 60 + doorM);
                                    if (dtn < 0) dtn += 1440; // Handle midnight crossing
                                    const isGood = dtn <= 60;
                                    return (
                                      <div className={`p-2 rounded text-center ${isGood ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300'}`}>
                                        <span className="block text-xs text-gray-600">Door-to-Needle</span>
                                        <span className={`text-xl font-bold ${isGood ? 'text-green-800' : 'text-red-800'}`}>
                                          {dtn} min
                                        </span>
                                        <span className="block text-xs text-gray-500">{isGood ? '✓ Goal ≤60 min' : '⚠ Goal ≤60 min'}</span>
                                      </div>
                                    );
                                  })()}
                                  {telestrokeNote.punctureTime && (() => {
                                    const [doorH, doorM] = telestrokeNote.doorTime.split(':').map(Number);
                                    const [punctureH, punctureM] = telestrokeNote.punctureTime.split(':').map(Number);
                                    let dtp = (punctureH * 60 + punctureM) - (doorH * 60 + doorM);
                                    if (dtp < 0) dtp += 1440; // Handle midnight crossing
                                    const isGood = dtp <= 90;
                                    return (
                                      <div className={`p-2 rounded text-center ${isGood ? 'bg-green-100 border border-green-300' : 'bg-red-100 border border-red-300'}`}>
                                        <span className="block text-xs text-gray-600">Door-to-Puncture</span>
                                        <span className={`text-xl font-bold ${isGood ? 'text-green-800' : 'text-red-800'}`}>
                                          {dtp} min
                                        </span>
                                        <span className="block text-xs text-gray-500">{isGood ? '✓ Goal ≤90 min' : '⚠ Goal ≤90 min'}</span>
                                      </div>
                                    );
                                  })()}
                                </div>
                              )}
                            </div>

                            {/* Additional Labs */}
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Creatinine</label>
                                <div className="flex items-center">
                                  <input
                                    type="number"
                                    value={telestrokeNote.creatinine || ''}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, creatinine: e.target.value})}
                                    placeholder=""
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                    step="0.1"
                                    min="0"
                                  />
                                  <span className="ml-1 text-xs text-gray-500">mg/dL</span>
                                </div>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Platelets/Coags</label>
                                <input
                                  type="text"
                                  value={telestrokeNote.plateletsCoags || ''}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, plateletsCoags: e.target.value})}
                                  placeholder="e.g., pending, WNL"
                                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Section 5: Imaging Review */}
                        <div className="bg-white border-2 border-indigo-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-indigo-900">5. Imaging Review</h3>
                            <i data-lucide="image" className="w-5 h-5 text-indigo-600"></i>
                          </div>
                          <div className="space-y-3">
                            {/* Non-contrast Head CT */}
                            <div className="bg-gray-50 p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">Non-contrast Head CT</h4>
                              <div className="grid grid-cols-2 gap-2 mb-2">
                                <input
                                  type="date"
                                  value={telestrokeNote.ctDate}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, ctDate: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                                <input
                                  type="time"
                                  value={telestrokeNote.ctTime}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, ctTime: e.target.value})}
                                  placeholder="Time reviewed"
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <textarea
                                value={telestrokeNote.ctResults}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, ctResults: e.target.value})}
                                placeholder=""
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            {/* Quick ASPECTS Entry */}
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                              <div className="flex items-center justify-between mb-2">
                                <label className="text-sm font-medium text-blue-800">ASPECTS Score</label>
                                <span className="text-2xl font-bold text-blue-600">{aspectsScore}/10</span>
                              </div>

                              {/* Quick ASPECTS Buttons */}
                              <div className="flex flex-wrap gap-2 mb-2">
                                {[10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0].map(score => (
                                  <button
                                    key={score}
                                    onClick={() => {
                                      setAspectsScore(score);
                                      // Also update region state to reflect the score
                                      const newState = aspectsRegionState.map((r, idx) => ({
                                        ...r,
                                        checked: idx < score
                                      }));
                                      setAspectsRegionState(newState);
                                    }}
                                    className={`w-8 h-8 rounded-lg text-sm font-bold transition ${
                                      aspectsScore === score ? 'ring-2 ring-offset-1 ring-blue-500' : ''
                                    } ${
                                      score >= 7 ? 'bg-green-100 hover:bg-green-200 text-green-800' :
                                      score >= 6 ? 'bg-yellow-100 hover:bg-yellow-200 text-yellow-800' :
                                      score >= 3 ? 'bg-orange-100 hover:bg-orange-200 text-orange-800' :
                                      'bg-red-100 hover:bg-red-200 text-red-800'
                                    }`}
                                  >
                                    {score}
                                  </button>
                                ))}
                              </div>

                              {/* ASPECTS Interpretation */}
                              <div className={`p-2 rounded-lg text-center text-xs font-medium ${
                                aspectsScore >= 7 ? 'bg-green-100 text-green-800' :
                                aspectsScore >= 6 ? 'bg-yellow-100 text-yellow-800' :
                                aspectsScore >= 3 ? 'bg-orange-100 text-orange-800' :
                                'bg-red-100 text-red-800'
                              }`}>
                                {aspectsScore >= 7 ? `ASPECTS ${aspectsScore} = Favorable for EVT (most trials)` :
                                 aspectsScore === 6 ? `ASPECTS 6 = May qualify for late window EVT (SELECT2, RESCUE-Japan LIMIT)` :
                                 aspectsScore >= 3 ? `ASPECTS ${aspectsScore} = Large core, may consider EVT if SELECT2/RESCUE criteria met` :
                                 `ASPECTS ${aspectsScore} = Very large core, poor EVT candidate`}
                              </div>
                            </div>

                            {/* ASPECTS Calculator (Collapsible) */}
                            <details className="bg-blue-50 border border-blue-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg">
                                🧮 Full ASPECTS Calculator (Click to expand)
                              </summary>
                              <div className="p-4">
                                <div className="text-center mb-3">
                                  <span className="text-3xl font-bold text-blue-600">ASPECTS: {aspectsScore}</span>
                                </div>
                                <div className="space-y-2">
                                  {aspectsRegionState.map((region) => (
                                    <label key={region.id} className="flex items-center gap-2 p-2 hover:bg-blue-50 rounded cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={region.checked}
                                        onChange={() => {
                                          const newState = aspectsRegionState.map(r =>
                                            r.id === region.id ? { ...r, checked: !r.checked } : r
                                          );
                                          setAspectsRegionState(newState);
                                          setAspectsScore(newState.filter(r => r.checked).length);
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className="text-sm">{region.name}</span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            </details>

                            {/* PC-ASPECTS Calculator (Collapsible) */}
                            <details className="bg-purple-50 border border-purple-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg">
                                🧮 PC-ASPECTS Calculator (Posterior Circulation)
                              </summary>
                              <div className="p-4">
                                <div className="flex justify-between items-center mb-3">
                                  <p className="text-sm text-gray-700">Start at 10 points, subtract points for affected regions:</p>
                                  <div className="text-center">
                                    <span className="text-3xl font-bold text-purple-600">PC-ASPECTS: {calculatePCAspects(pcAspectsRegions)}</span>
                                  </div>
                                </div>
                                <div className="space-y-2">
                                  {pcAspectsRegions.map((region, idx) => (
                                    <label key={region.id} className="flex items-center gap-2 p-2 hover:bg-purple-50 rounded cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={region.checked}
                                        onChange={(e) => {
                                          const newRegions = [...pcAspectsRegions];
                                          newRegions[idx].checked = e.target.checked;
                                          setPcAspectsRegions(newRegions);
                                        }}
                                        className="w-4 h-4"
                                      />
                                      <span className="text-sm flex-1">{region.name}</span>
                                      <span className="text-xs font-semibold text-purple-700 bg-purple-100 px-2 py-1 rounded">
                                        {region.points} {region.points === 1 ? 'point' : 'points'}
                                      </span>
                                    </label>
                                  ))}
                                </div>
                              </div>
                            </details>

                            {/* CTA Head & Neck */}
                            <div className="bg-gray-50 p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">CTA Head & Neck</h4>
                              <div className="grid grid-cols-2 gap-2 mb-2">
                                <input
                                  type="date"
                                  value={telestrokeNote.ctaDate}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, ctaDate: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                                <input
                                  type="time"
                                  value={telestrokeNote.ctaTime}
                                  onChange={(e) => setTelestrokeNote({...telestrokeNote, ctaTime: e.target.value})}
                                  placeholder="Time reviewed"
                                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                />
                              </div>
                              <textarea
                                value={telestrokeNote.ctaResults}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, ctaResults: e.target.value})}
                                placeholder=""
                                rows="3"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />

                              {/* Vessel Occlusion Quick Select for Trial Eligibility */}
                              <div className="mt-3 p-2 bg-blue-50 border border-blue-200 rounded-lg">
                                <p className="text-xs font-semibold text-blue-800 mb-2">
                                  🔬 Vessel Occlusion <span className="font-normal">(for trial screening)</span>
                                </p>
                                <div className="flex flex-wrap gap-2">
                                  {['ICA', 'M1', 'M2', 'M3', 'M4', 'A1', 'A2', 'A3', 'P1', 'P2', 'P3'].map(vessel => (
                                    <label key={vessel} className="flex items-center gap-1 cursor-pointer">
                                      <input
                                        type="checkbox"
                                        checked={(telestrokeNote.vesselOcclusion || []).includes(vessel)}
                                        onChange={(e) => {
                                          const current = telestrokeNote.vesselOcclusion || [];
                                          const updated = e.target.checked
                                            ? [...current, vessel]
                                            : current.filter(v => v !== vessel);
                                          setTelestrokeNote({...telestrokeNote, vesselOcclusion: updated});
                                        }}
                                        className="w-3 h-3"
                                      />
                                      <span className={`text-xs px-2 py-0.5 rounded ${
                                        (telestrokeNote.vesselOcclusion || []).includes(vessel)
                                          ? 'bg-blue-600 text-white font-semibold'
                                          : 'bg-gray-200 text-gray-700'
                                      }`}>{vessel}</span>
                                    </label>
                                  ))}
                                  {(telestrokeNote.vesselOcclusion || []).length === 0 && (
                                    <span className="text-xs text-gray-500 italic">None selected</span>
                                  )}
                                </div>
                              </div>
                            </div>

                            {/* CT Perfusion */}
                            <div className="bg-gray-50 p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">CT Perfusion</h4>
                              <textarea
                                value={telestrokeNote.ctpResults}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, ctpResults: e.target.value})}
                                placeholder=""
                                rows="3"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Section 6: Treatment Decision */}
                        <div ref={treatmentDecisionRef} className="bg-white border-2 border-orange-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-orange-900">6. Treatment Decision</h3>
                            <i data-lucide="zap" className="w-5 h-5 text-orange-600"></i>
                          </div>

                          {/* Auto Treatment Recommendation */}
                          {(() => {
                            const timeFromLKW = calculateTimeFromLKW();
                            const hoursFromLKW = timeFromLKW ? timeFromLKW.total : null;
                            const nihss = parseInt(telestrokeNote.nihss) || nihssScore || 0;
                            const aspects = aspectsScore;
                            const age = parseInt(telestrokeNote.age) || 0;
                            const contraindications = detectContraindications({ telestrokeNote });
                            const criticalContraindications = contraindications.filter(c => c.severity === 'critical');

                            // Determine TNK recommendation
                            let tnkRec = { eligible: false, reason: '', confidence: 'low' };
                            let evtRec = { eligible: false, reason: '', confidence: 'low' };

                            // TNK Logic
                            if (criticalContraindications.length > 0) {
                              tnkRec = { eligible: false, reason: 'Absolute contraindication(s) present', confidence: 'high' };
                            } else if (!hoursFromLKW) {
                              tnkRec = { eligible: false, reason: 'Set LKW time to evaluate', confidence: 'low' };
                            } else if (nihss < 4 && !telestrokeNote.nihssDetails) {
                              tnkRec = { eligible: false, reason: `NIHSS ${nihss} - minor stroke, TNK not typically indicated`, confidence: 'medium' };
                            } else if (hoursFromLKW <= 4.5) {
                              if (nihss >= 4 || telestrokeNote.nihssDetails) {
                                tnkRec = { eligible: true, reason: `Within 4.5h window, NIHSS ${nihss}`, confidence: 'high' };
                              }
                            } else if (hoursFromLKW > 4.5 && hoursFromLKW <= 24) {
                              if (aspects >= 6) {
                                tnkRec = { eligible: false, reason: 'Consider SISTER trial (late window TNK research)', confidence: 'medium' };
                              } else {
                                tnkRec = { eligible: false, reason: 'Outside TNK window (>4.5h)', confidence: 'high' };
                              }
                            } else if (hoursFromLKW > 24) {
                              tnkRec = { eligible: false, reason: 'Outside all TNK windows (>24h)', confidence: 'high' };
                            }

                            // EVT Logic
                            if (!hoursFromLKW) {
                              evtRec = { eligible: false, reason: 'Set LKW time to evaluate', confidence: 'low' };
                            } else if (nihss >= 6 && hoursFromLKW <= 24) {
                              if (aspects >= 7 && hoursFromLKW <= 6) {
                                evtRec = { eligible: true, reason: `Early window, NIHSS ${nihss}, ASPECTS ${aspects}`, confidence: 'high' };
                              } else if (aspects >= 6 && hoursFromLKW > 6 && hoursFromLKW <= 24) {
                                evtRec = { eligible: true, reason: `Late window eligible (DAWN/DEFUSE criteria likely met)`, confidence: 'medium' };
                              } else if (aspects >= 3 && hoursFromLKW <= 24) {
                                evtRec = { eligible: true, reason: `Large core - may qualify under SELECT2/RESCUE-Japan`, confidence: 'medium' };
                              } else if (aspects < 3) {
                                evtRec = { eligible: false, reason: `ASPECTS ${aspects} too low for EVT`, confidence: 'high' };
                              }
                            } else if (nihss < 6) {
                              evtRec = { eligible: false, reason: `NIHSS ${nihss} - consider if LVO present (STEP trial)`, confidence: 'medium' };
                            } else if (hoursFromLKW > 24) {
                              evtRec = { eligible: false, reason: 'Outside EVT window (>24h)', confidence: 'high' };
                            }

                            // Only show if we have some data to work with
                            if (!age && !nihss && !hoursFromLKW) return null;

                            return (
                              <div className="bg-gradient-to-r from-blue-50 to-green-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                                <div className="flex items-center gap-2 mb-3">
                                  <span className="text-lg font-bold text-blue-900">🤖 Auto-Recommendation</span>
                                  <span className="text-xs text-gray-500">(based on entered data)</span>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  {/* TNK Recommendation */}
                                  <div className={`p-3 rounded-lg border-2 ${
                                    tnkRec.eligible ? 'bg-green-100 border-green-400' :
                                    tnkRec.confidence === 'low' ? 'bg-gray-100 border-gray-300' :
                                    'bg-red-50 border-red-300'
                                  }`}>
                                    <div className="flex items-center justify-between mb-2">
                                      <span className="font-bold text-gray-800">TNK (Thrombolysis)</span>
                                      {tnkRec.eligible ? (
                                        <span className="px-2 py-1 bg-green-500 text-white text-xs font-bold rounded">CONSIDER</span>
                                      ) : tnkRec.confidence === 'low' ? (
                                        <span className="px-2 py-1 bg-gray-400 text-white text-xs font-bold rounded">PENDING</span>
                                      ) : (
                                        <span className="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded">NOT INDICATED</span>
                                      )}
                                    </div>
                                    <p className="text-sm text-gray-700">{tnkRec.reason}</p>
                                  </div>

                                  {/* EVT Recommendation */}
                                  <div className={`p-3 rounded-lg border-2 ${
                                    evtRec.eligible ? 'bg-purple-100 border-purple-400' :
                                    evtRec.confidence === 'low' ? 'bg-gray-100 border-gray-300' :
                                    'bg-red-50 border-red-300'
                                  }`}>
                                    <div className="flex items-center justify-between mb-2">
                                      <span className="font-bold text-gray-800">EVT (Thrombectomy)</span>
                                      {evtRec.eligible ? (
                                        <span className="px-2 py-1 bg-purple-500 text-white text-xs font-bold rounded">CONSIDER</span>
                                      ) : evtRec.confidence === 'low' ? (
                                        <span className="px-2 py-1 bg-gray-400 text-white text-xs font-bold rounded">PENDING</span>
                                      ) : (
                                        <span className="px-2 py-1 bg-red-500 text-white text-xs font-bold rounded">NOT INDICATED</span>
                                      )}
                                    </div>
                                    <p className="text-sm text-gray-700">{evtRec.reason}</p>
                                  </div>
                                </div>

                              </div>
                            );
                          })()}

                          {/* Active Contraindication Alerts */}
                          {(() => {
                            const contraindications = detectContraindications({
                              telestrokeNote
                            });
                            if (contraindications.length === 0) return null;

                            const criticalAlerts = contraindications.filter(c => c.severity === 'critical');
                            const warningAlerts = contraindications.filter(c => c.severity === 'warning');
                            const infoAlerts = contraindications.filter(c => c.severity === 'info');

                            return (
                              <div className="mb-3 space-y-2">
                                {criticalAlerts.length > 0 && (
                                  <div className="bg-red-100 border-2 border-red-400 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-red-700 font-bold">🚨 CRITICAL CONTRAINDICATION{criticalAlerts.length > 1 ? 'S' : ''}</span>
                                    </div>
                                    <ul className="space-y-1">
                                      {criticalAlerts.map((alert, idx) => (
                                        <li key={idx} className="text-sm text-red-800 flex items-start gap-2">
                                          <span className="text-red-500">•</span>
                                          <span><strong>{alert.label}:</strong> {alert.message}</span>
                                        </li>
                                      ))}
                                    </ul>
                                  </div>
                                )}

                                {warningAlerts.length > 0 && (
                                  <div className="bg-amber-50 border-2 border-amber-400 rounded-lg p-3">
                                    <div className="flex items-center gap-2 mb-2">
                                      <span className="text-amber-700 font-bold">⚠️ CAUTION{warningAlerts.length > 1 ? 'S' : ''}</span>
                                    </div>
                                    <ul className="space-y-1">
                                      {warningAlerts.map((alert, idx) => (
                                        <li key={idx} className="text-sm text-amber-800 flex items-start gap-2">
                                          <span className="text-amber-500">•</span>
                                          <span><strong>{alert.label}:</strong> {alert.message}</span>
                                        </li>
                                      ))}
                                    </ul>
                                  </div>
                                )}

                                {infoAlerts.length > 0 && (
                                  <div className="bg-blue-50 border border-blue-300 rounded-lg p-2">
                                    <ul className="space-y-1">
                                      {infoAlerts.map((alert, idx) => (
                                        <li key={idx} className="text-sm text-blue-800 flex items-start gap-2">
                                          <span className="text-blue-500">ℹ️</span>
                                          <span>{alert.message}</span>
                                        </li>
                                      ))}
                                    </ul>
                                  </div>
                                )}
                              </div>
                            );
                          })()}

                          <div className="space-y-3">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Diagnosis</label>
                              <textarea
                                value={telestrokeNote.diagnosis}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, diagnosis: e.target.value})}
                                placeholder=""
                                rows="2"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>

                            {/* Lytic Eligibility Criteria (Collapsible) */}
                            <details className="bg-green-50 border border-green-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-green-800 hover:bg-green-100 rounded-lg">
                                ✓ Lytic Eligibility Criteria (Click to expand)
                              </summary>
                              <div className="p-4 space-y-3 text-sm">
                                <div>
                                  <h4 className="font-semibold text-green-700 mb-2">Inclusion Criteria:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Diagnosis of ischemic stroke causing measurable neurologic deficit</li>
                                    <li>• Age ≥18 years</li>
                                    <li>• Onset of symptoms &lt;3 hours (or &lt;4.5h with additional criteria)</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-amber-700 mb-2">3-4.5h Window Additional Criteria:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Age ≤80 years</li>
                                    <li>• No history of both DM and prior stroke</li>
                                    <li>• NIHSS ≤25</li>
                                    <li>• No oral anticoagulant use</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-teal-700 mb-2">WAKE-UP:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• LKN unclear (not awake/known to have had sx for 4.5 hours) + NO LVO</li>
                                    <li>• MRI w/ DWI and T2/FLAIR</li>
                                    <li>• Discuss ↓ certainty in benefit and ↑ hemorrhage risk w/ thrombolysis</li>
                                  </ul>
                                </div>
                              </div>
                            </details>

                            {/* ========== TNK CONTRAINDICATIONS ========== */}
                            {(() => {
                              const checklist = telestrokeNote.tnkContraindicationChecklist || {};

                              const absoluteContraindications = [
                                // Imaging Exclusions
                                { id: 'currentICH', label: 'CT with evidence of hemorrhage', note: null },
                                { id: 'extensiveHypoattenuation', label: 'CT with extensive regions of clear hypoattenuation', note: null },
                                { id: 'largeInfarct', label: 'Ischemic injury >1/3 of MCA territory', note: null },
                                { id: 'intracranialTumor', label: 'Intra-axial intracranial tumor', note: 'extra-axial not absolute' },
                                { id: 'aorticDissection', label: 'Aortic arch dissection', note: null },
                                // Clinical Exclusions
                                { id: 'recentStroke', label: 'Recent stroke', note: '<90 days' },
                                { id: 'recentHeadTrauma', label: 'Recent severe head trauma', note: '<90 days' },
                                { id: 'recentIntracranialSurgery', label: 'Recent intracranial/intraspinal surgery', note: '<60 days' },
                                { id: 'activeInternalBleeding', label: 'Active internal bleeding', note: null },
                                { id: 'giMalignancy', label: 'GI malignancy', note: null },
                                { id: 'sahPresentation', label: 'Clinical presentation suggestive of SAH', note: 'even if CT normal' },
                                { id: 'infectiveEndocarditis', label: 'Presentation consistent with infective endocarditis', note: null },
                                // Lab/Vital Exclusions
                                { id: 'severeUncontrolledHTN', label: 'SBP >185 or DBP >110 mmHg', note: 'unresponsive to treatment' },
                                { id: 'lowPlatelets', label: 'Platelet count <100,000', note: null },
                                { id: 'lowGlucose', label: 'Blood glucose <50 mg/dL', note: null },
                                { id: 'warfarinElevatedINR', label: 'Warfarin use with PT >15s, INR >1.7, or aPTT >40s', note: null },
                                { id: 'recentDOAC', label: 'Recent DOAC use', note: '<48h' },
                                { id: 'recentHeparin', label: 'Treatment-dose heparin/LMWH', note: '<24 hours' }
                              ];

                              const relativeContraindications = [
                                // Cautionary - Consider risks/benefits
                                { id: 'priorICH', label: 'Prior known non-traumatic intracranial hemorrhage', note: null },
                                { id: 'vascularMalformation', label: 'Intracranial vascular malformation', note: 'unless severe neuro sx' },
                                { id: 'intracranialAneurysm', label: 'Intracranial aneurysm', note: null },
                                { id: 'knownBleedingDiathesis', label: 'Known bleeding diathesis', note: null },
                                { id: 'pregnancy', label: 'Pregnancy', note: 'consult OB/GYN ASAP' },
                                { id: 'recentMajorSurgery', label: 'Major extracranial surgery or trauma', note: '<14 days' },
                                { id: 'recentGIGUBleeding', label: 'Recent GI/urinary tract hemorrhage', note: '<21 days' },
                                { id: 'recentMI', label: 'Acute or recent MI', note: '<3 months, depends on type' },
                                { id: 'acutePericarditis', label: 'Acute pericarditis', note: null },
                                { id: 'recentArterialPuncture', label: 'Recent arterial puncture at non-compressible site', note: '<7 days' },
                                { id: 'recentLumbarPuncture', label: 'Recent lumbar puncture', note: '<7 days' },
                                { id: 'seizureAtOnset', label: 'Seizure at onset with postictal deficits', note: 'consider stroke mimic' },
                                { id: 'abnormalCoagUnknown', label: 'Abnormal aPTT, TT, or anti-Xa with unknown anticoagulant use', note: null },
                                { id: 'cerebralMicrobleeds', label: 'Cerebral microbleeds >10 on prior MRI', note: 'increased ICH risk' },
                                { id: 'lecanemab', label: 'Lecanemab or other Alzheimer medications', note: 'ARIA risk' },
                                { id: 'highGlucose', label: 'Blood glucose >400 mg/dL', note: 'correct before treatment' }
                              ];

                              const autoDetected = {};
                              const glucoseVal = parseFloat(telestrokeNote.glucose);
                              if (!isNaN(glucoseVal) && glucoseVal < 50) autoDetected.lowGlucose = true;
                              if (!isNaN(glucoseVal) && glucoseVal > 400) autoDetected.highGlucose = true;
                              const inrVal = parseFloat(telestrokeNote.inr);
                              if (!isNaN(inrVal) && inrVal > 1.7) autoDetected.warfarinElevatedINR = true;
                              const pttVal = parseFloat(telestrokeNote.ptt);
                              if (!isNaN(pttVal) && pttVal > 40) autoDetected.warfarinElevatedINR = true;
                              const plateletsVal = parseFloat(telestrokeNote.plateletCount);
                              if (!isNaN(plateletsVal) && plateletsVal < 100000) autoDetected.lowPlatelets = true;
                              const bpVal = telestrokeNote.presentingBP || '';
                              const bpMatchVal = bpVal.match(/(\d+)\s*\/\s*(\d+)/);
                              if (bpMatchVal && (parseInt(bpMatchVal[1]) > 185 || parseInt(bpMatchVal[2]) > 110)) autoDetected.severeUncontrolledHTN = true;
                              // DOAC detection
                              if (telestrokeNote.lastDOACType && telestrokeNote.lastDOACType !== '' && telestrokeNote.lastDOACType !== 'none' && telestrokeNote.lastDOACType !== 'warfarin' && telestrokeNote.lastDOACType !== 'heparin') {
                                if (telestrokeNote.lastDOACDose) {
                                  const hoursSinceDOAC = (new Date() - new Date(telestrokeNote.lastDOACDose)) / (1000 * 60 * 60);
                                  if (hoursSinceDOAC < 48) autoDetected.recentDOAC = true;
                                } else { autoDetected.recentDOAC = true; }
                              }
                              // Heparin detection
                              if (telestrokeNote.lastDOACType === 'heparin') {
                                if (telestrokeNote.lastDOACDose) {
                                  const hoursSinceHeparin = (new Date() - new Date(telestrokeNote.lastDOACDose)) / (1000 * 60 * 60);
                                  if (hoursSinceHeparin < 24) autoDetected.recentHeparin = true;
                                } else { autoDetected.recentHeparin = true; }
                              }
                              // Warfarin with elevated INR
                              if (telestrokeNote.lastDOACType === 'warfarin' && !isNaN(inrVal) && inrVal > 1.7) {
                                autoDetected.warfarinElevatedINR = true;
                              }

                              const absoluteChecked = absoluteContraindications.filter(c => checklist[c.id] || autoDetected[c.id]);
                              const relativeChecked = relativeContraindications.filter(c => checklist[c.id] || autoDetected[c.id]);

                              let badgeColor, badgeText, badgeIcon;
                              if (absoluteChecked.length > 0) { badgeColor = 'bg-red-500 text-white'; badgeText = 'Absolute CI (' + absoluteChecked.length + ')'; badgeIcon = 'X'; }
                              else if (relativeChecked.length > 0) { badgeColor = 'bg-amber-500 text-white'; badgeText = relativeChecked.length + ' relative'; badgeIcon = '!'; }
                              else if (telestrokeNote.tnkContraindicationReviewed) { badgeColor = 'bg-green-500 text-white'; badgeText = 'No contraindications'; badgeIcon = 'check'; }
                              else { badgeColor = 'bg-gray-400 text-white'; badgeText = 'Not reviewed'; badgeIcon = '?'; }

                              const updateChecklistItem = (id, value) => setTelestrokeNote({...telestrokeNote, tnkContraindicationChecklist: {...telestrokeNote.tnkContraindicationChecklist, [id]: value}});

                              const clearAllAndProceed = () => {
                                const clearedChecklist = {};
                                [...absoluteContraindications, ...relativeContraindications].forEach(c => { clearedChecklist[c.id] = false; });
                                setTelestrokeNote({...telestrokeNote, tnkContraindicationChecklist: clearedChecklist, tnkContraindicationReviewed: true, tnkContraindicationReviewTime: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }), tnkRecommended: true});
                              };

                              return (
                                <details className="bg-gradient-to-r from-orange-50 to-red-50 border-2 border-orange-300 rounded-lg" open={!telestrokeNote.tnkContraindicationReviewed}>
                                  <summary className="cursor-pointer p-3 font-semibold text-orange-900 hover:bg-orange-100 rounded-lg flex items-center justify-between">
                                    <span>TNK Contraindications</span>
                                    <span className={'px-3 py-1 rounded-full text-xs font-bold ' + badgeColor}>
                                      {badgeIcon === 'check' && <span>&#10003; </span>}
                                      {badgeIcon === '!' && <span>&#9888; </span>}
                                      {badgeIcon === 'X' && <span>&#10007; </span>}
                                      {badgeText}
                                    </span>
                                  </summary>
                                  <div className="p-4 space-y-4">
                                    <div className="bg-red-100 border border-red-300 rounded-lg p-3">
                                      <h4 className="font-bold text-red-800 mb-3 flex items-center gap-2">
                                        <span className="bg-red-600 text-white px-2 py-0.5 rounded text-xs">ABSOLUTE</span>
                                        Contraindications - TNK is contraindicated if ANY checked
                                      </h4>
                                      <div className="space-y-2">
                                        {absoluteContraindications.map(item => {
                                          const isAutoDetected = autoDetected[item.id];
                                          const isChecked = checklist[item.id] || isAutoDetected;
                                          return (
                                            <label key={item.id} className={'flex items-start gap-2 p-2 rounded cursor-pointer transition ' + (isChecked ? 'bg-red-200' : 'hover:bg-red-50')}>
                                              <input type="checkbox" checked={isChecked} onChange={(e) => updateChecklistItem(item.id, e.target.checked)} className="w-4 h-4 mt-0.5 accent-red-600" />
                                              <div className="flex-1">
                                                <span className={'text-sm ' + (isChecked ? 'text-red-900 font-semibold' : 'text-gray-800')}>{item.label}</span>
                                                {item.note && <span className="text-xs text-red-600 ml-1">({item.note})</span>}
                                                {isAutoDetected && <span className="ml-2 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded">Auto-detected</span>}
                                              </div>
                                            </label>
                                          );
                                        })}
                                      </div>
                                    </div>
                                    <div className="bg-amber-50 border border-amber-300 rounded-lg p-3">
                                      <h4 className="font-bold text-amber-800 mb-3 flex items-center gap-2">
                                        <span className="bg-amber-500 text-white px-2 py-0.5 rounded text-xs">RELATIVE</span>
                                        Contraindications - Use clinical judgment
                                      </h4>
                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        {relativeContraindications.map(item => {
                                          const isAutoDetected = autoDetected[item.id];
                                          const isChecked = checklist[item.id] || isAutoDetected;
                                          return (
                                            <label key={item.id} className={'flex items-start gap-2 p-2 rounded cursor-pointer transition ' + (isChecked ? 'bg-amber-200' : 'hover:bg-amber-100')}>
                                              <input type="checkbox" checked={isChecked} onChange={(e) => updateChecklistItem(item.id, e.target.checked)} className="w-4 h-4 mt-0.5 accent-amber-600" />
                                              <div className="flex-1">
                                                <span className={'text-sm ' + (isChecked ? 'text-amber-900 font-semibold' : 'text-gray-800')}>{item.label}</span>
                                                {item.note && <span className="text-xs text-amber-600 block">({item.note})</span>}
                                                {isAutoDetected && <span className="ml-2 text-xs bg-amber-500 text-white px-1.5 py-0.5 rounded">Auto-detected</span>}
                                              </div>
                                            </label>
                                          );
                                        })}
                                      </div>
                                    </div>
                                    <div className="flex items-center justify-between pt-2 border-t border-orange-200">
                                      <div className="text-sm text-gray-600">
                                        {telestrokeNote.tnkContraindicationReviewed && <span className="text-green-700">Reviewed at {telestrokeNote.tnkContraindicationReviewTime}</span>}
                                      </div>
                                      <div className="flex gap-2">
                                        {absoluteChecked.length === 0 && (
                                          <button onClick={clearAllAndProceed} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition flex items-center gap-2">
                                            <span>&#10003;</span> All reviewed - Proceed with TNK
                                          </button>
                                        )}
                                        {absoluteChecked.length > 0 && (
                                          <div className="px-4 py-2 bg-red-100 text-red-800 rounded-lg font-semibold border border-red-300">
                                            &#10007; TNK Contraindicated - {absoluteChecked.length} absolute CI{absoluteChecked.length > 1 ? 's' : ''}
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                  </div>
                                </details>
                              );
                            })()}

                            {/* Contextual Trial Consideration Hint */}
                            {(() => {
                              const eligibleTrials = Object.entries(trialEligibility)
                                .filter(([_, t]) => t?.status === 'eligible' || t?.status === 'needs_info');
                              if (eligibleTrials.length === 0) return null;
                              return (
                                <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
                                  <div className="flex items-center gap-2 text-sm">
                                    <span className="text-indigo-700 font-medium">🔬 Trial Consideration:</span>
                                    <span className="text-indigo-600">
                                      {eligibleTrials.filter(([_, t]) => t?.status === 'eligible').length > 0
                                        ? `Patient may qualify for ${eligibleTrials.filter(([_, t]) => t?.status === 'eligible').map(([id]) => TRIAL_ELIGIBILITY_CONFIG[id]?.name.replace(' Trial', '')).join(', ')}`
                                        : 'Check trial eligibility in sidebar →'}
                                    </span>
                                  </div>
                                </div>
                              );
                            })()}

                            <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                              <input
                                type="checkbox"
                                checked={telestrokeNote.tnkRecommended}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, tnkRecommended: e.target.checked})}
                                className="w-4 h-4"
                              />
                              TNK Recommended
                            </label>

                            {telestrokeNote.tnkRecommended && (
                              <div className="bg-green-50 border border-green-200 rounded-lg p-3 space-y-3">
                                {/* TNK Dosing Calculator */}
                                <div className="bg-white border border-green-300 rounded-lg p-3 space-y-2">
                                  <div className="flex items-center justify-between">
                                    <span className="text-sm font-semibold text-green-800">💉 TNK Dosing Calculator</span>
                                    <span className="text-xs text-gray-500">0.25 mg/kg, max 25 mg</span>
                                  </div>

                                  <div className="flex items-center gap-3">
                                    <label className="text-sm text-gray-700">Weight:</label>
                                    <input
                                      type="number"
                                      value={telestrokeNote.weight}
                                      onChange={(e) => setTelestrokeNote({...telestrokeNote, weight: e.target.value})}
                                      placeholder="kg"
                                      className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                      min="0"
                                      step="0.1"
                                    />
                                    <span className="text-xs text-gray-500">kg</span>
                                  </div>

                                  {(() => {
                                    const doseCalc = calculateTNKDose(telestrokeNote.weight);
                                    if (!doseCalc) {
                                      return (
                                        <div className="text-sm text-amber-600 bg-amber-50 px-2 py-1 rounded">
                                          ⚠️ Enter patient weight to calculate TNK dose
                                        </div>
                                      );
                                    }
                                    return (
                                      <div className={`p-2 rounded ${doseCalc.isMaxDose ? 'bg-amber-100 border border-amber-300' : 'bg-green-100 border border-green-300'}`}>
                                        <div className="flex items-center justify-between">
                                          <span className="text-lg font-bold text-green-800">
                                            TNK Dose: {doseCalc.calculatedDose} mg
                                          </span>
                                          {doseCalc.isMaxDose && (
                                            <span className="text-xs bg-amber-200 text-amber-800 px-2 py-0.5 rounded font-medium">
                                              MAX DOSE
                                            </span>
                                          )}
                                        </div>
                                        <div className="text-xs text-gray-600 mt-1">
                                          {doseCalc.weightKg} kg × 0.25 mg/kg = {(doseCalc.weightKg * 0.25).toFixed(1)} mg
                                          {doseCalc.isMaxDose && ' → capped at 25 mg'}
                                        </div>
                                      </div>
                                    );
                                  })()}
                                </div>

                                <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                  <input
                                    type="checkbox"
                                    checked={telestrokeNote.tnkConsentDiscussed}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, tnkConsentDiscussed: e.target.checked})}
                                    className="w-4 h-4"
                                  />
                                  Risks/benefits discussed with patient and family
                                </label>
                                {telestrokeNote.tnkConsentDiscussed && (
                                  <div className="bg-white border border-purple-200 rounded-lg p-3 space-y-2">
                                    <p className="text-sm text-gray-700">
                                      We recommend a medication called Tenecteplase (TNK), which is a "clot-buster" drug. TNK reduces the risk of being disabled; people who get TNK have an improved chance of recovering without disability than people who don't get the medication. All medications have risks – the main risk is bleeding, up to 4% of people develop bleeding in the brain that leads to new symptoms. Very rarely, people have an allergic reaction. The potential benefits are thought to be higher than the potential risks and we recommend TNK is administered. Time is very important here - the sooner the treatment is started, the higher the likelihood of benefit.
                                    </p>

                                    <div className="mt-3 space-y-2">
                                      <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                        <input
                                          type="checkbox"
                                          checked={telestrokeNote.patientFamilyConsent}
                                          onChange={(e) => setTelestrokeNote({...telestrokeNote, patientFamilyConsent: e.target.checked})}
                                          className="w-4 h-4"
                                        />
                                        Patient/family provides consent
                                      </label>
                                      <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                        <input
                                          type="checkbox"
                                          checked={telestrokeNote.presumedConsent}
                                          onChange={(e) => setTelestrokeNote({...telestrokeNote, presumedConsent: e.target.checked})}
                                          className="w-4 h-4"
                                        />
                                        Presumed consent
                                      </label>
                                      <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                                        <input
                                          type="checkbox"
                                          checked={telestrokeNote.preTNKSafetyPause}
                                          onChange={(e) => setTelestrokeNote({...telestrokeNote, preTNKSafetyPause: e.target.checked})}
                                          className="w-4 h-4"
                                        />
                                        Pre-TNK safety pause completed
                                      </label>
                                    </div>
                                  </div>
                                )}
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">TNK Administration Time</label>
                                  <input
                                    type="time"
                                    value={telestrokeNote.tnkAdminTime}
                                    onChange={(e) => setTelestrokeNote({...telestrokeNote, tnkAdminTime: e.target.value})}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  />
                                </div>
                              </div>
                            )}

                            {/* Time Metrics Section - DTN Tracker (Collapsible) */}
                            <details className="bg-purple-50 border-2 border-purple-300 rounded-lg" open={telestrokeNote.tnkRecommended}>
                              <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg flex items-center justify-between">
                                <span className="flex items-center gap-2">
                                  <i data-lucide="timer" className="w-4 h-4"></i>
                                  Time Metrics (DTN Tracker)
                                </span>
                                {(() => {
                                  const metrics = calculateDTNMetrics();
                                  if (metrics.doorToNeedle !== null) {
                                    const benchmark = getDTNBenchmark(metrics.doorToNeedle);
                                    return (
                                      <span className={`px-2 py-1 rounded text-xs font-bold ${
                                        benchmark.color === 'green' ? 'bg-green-500 text-white' :
                                        benchmark.color === 'yellow' ? 'bg-yellow-500 text-white' :
                                        'bg-red-500 text-white'
                                      }`}>
                                        DTN: {metrics.doorToNeedle} min
                                      </span>
                                    );
                                  }
                                  return null;
                                })()}
                              </summary>
                              <div className="p-4 space-y-4">
                                {/* Timestamp capture fields */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                  {/* ED Arrival (Door) */}
                                  <div className="bg-white p-3 rounded-lg border border-purple-200">
                                    <div className="flex items-center justify-between mb-2">
                                      <label className="text-sm font-medium text-gray-700">ED Arrival (Door)</label>
                                      <button
                                        type="button"
                                        onClick={() => setTelestrokeNote({...telestrokeNote, dtnEdArrival: new Date().toISOString().slice(0, 16)})}
                                        className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors"
                                      >
                                        Now
                                      </button>
                                    </div>
                                    <input
                                      type="datetime-local"
                                      value={telestrokeNote.dtnEdArrival || ''}
                                      onChange={(e) => setTelestrokeNote({...telestrokeNote, dtnEdArrival: e.target.value})}
                                      className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500"
                                    />
                                  </div>

                                  {/* Stroke Alert Called */}
                                  <div className="bg-white p-3 rounded-lg border border-purple-200">
                                    <div className="flex items-center justify-between mb-2">
                                      <label className="text-sm font-medium text-gray-700">Stroke Alert Called</label>
                                      <button
                                        type="button"
                                        onClick={() => setTelestrokeNote({...telestrokeNote, dtnStrokeAlert: new Date().toISOString().slice(0, 16)})}
                                        className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors"
                                      >
                                        Now
                                      </button>
                                    </div>
                                    <input
                                      type="datetime-local"
                                      value={telestrokeNote.dtnStrokeAlert || ''}
                                      onChange={(e) => setTelestrokeNote({...telestrokeNote, dtnStrokeAlert: e.target.value})}
                                      className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500"
                                    />
                                  </div>

                                  {/* CT Scan Started */}
                                  <div className="bg-white p-3 rounded-lg border border-purple-200">
                                    <div className="flex items-center justify-between mb-2">
                                      <label className="text-sm font-medium text-gray-700">CT Scan Started</label>
                                      <button
                                        type="button"
                                        onClick={() => setTelestrokeNote({...telestrokeNote, dtnCtStarted: new Date().toISOString().slice(0, 16)})}
                                        className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors"
                                      >
                                        Now
                                      </button>
                                    </div>
                                    <input
                                      type="datetime-local"
                                      value={telestrokeNote.dtnCtStarted || ''}
                                      onChange={(e) => setTelestrokeNote({...telestrokeNote, dtnCtStarted: e.target.value})}
                                      className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500"
                                    />
                                  </div>

                                  {/* CT Read/Cleared for TNK */}
                                  <div className="bg-white p-3 rounded-lg border border-purple-200">
                                    <div className="flex items-center justify-between mb-2">
                                      <label className="text-sm font-medium text-gray-700">CT Read/Cleared for TNK</label>
                                      <button
                                        type="button"
                                        onClick={() => setTelestrokeNote({...telestrokeNote, dtnCtRead: new Date().toISOString().slice(0, 16)})}
                                        className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors"
                                      >
                                        Now
                                      </button>
                                    </div>
                                    <input
                                      type="datetime-local"
                                      value={telestrokeNote.dtnCtRead || ''}
                                      onChange={(e) => setTelestrokeNote({...telestrokeNote, dtnCtRead: e.target.value})}
                                      className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500"
                                    />
                                  </div>

                                  {/* TNK Ordered */}
                                  <div className="bg-white p-3 rounded-lg border border-purple-200">
                                    <div className="flex items-center justify-between mb-2">
                                      <label className="text-sm font-medium text-gray-700">TNK Ordered</label>
                                      <button
                                        type="button"
                                        onClick={() => setTelestrokeNote({...telestrokeNote, dtnTnkOrdered: new Date().toISOString().slice(0, 16)})}
                                        className="px-2 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors"
                                      >
                                        Now
                                      </button>
                                    </div>
                                    <input
                                      type="datetime-local"
                                      value={telestrokeNote.dtnTnkOrdered || ''}
                                      onChange={(e) => setTelestrokeNote({...telestrokeNote, dtnTnkOrdered: e.target.value})}
                                      className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-purple-500"
                                    />
                                  </div>

                                  {/* TNK Administered (Needle Time) */}
                                  <div className="bg-white p-3 rounded-lg border-2 border-green-400">
                                    <div className="flex items-center justify-between mb-2">
                                      <label className="text-sm font-bold text-green-700">TNK Administered (Needle)</label>
                                      <button
                                        type="button"
                                        onClick={() => setTelestrokeNote({...telestrokeNote, dtnTnkAdministered: new Date().toISOString().slice(0, 16)})}
                                        className="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors"
                                      >
                                        Now
                                      </button>
                                    </div>
                                    <input
                                      type="datetime-local"
                                      value={telestrokeNote.dtnTnkAdministered || ''}
                                      onChange={(e) => setTelestrokeNote({...telestrokeNote, dtnTnkAdministered: e.target.value})}
                                      className="w-full px-2 py-1 border border-green-300 rounded text-sm focus:ring-2 focus:ring-green-500"
                                    />
                                  </div>
                                </div>

                                {/* Auto-calculated Time Metrics */}
                                {(() => {
                                  const metrics = calculateDTNMetrics();
                                  const hasSomeData = metrics.doorToCT !== null || metrics.doorToNeedle !== null || metrics.ctToNeedle !== null;

                                  if (!hasSomeData) {
                                    return (
                                      <div className="text-center text-gray-500 text-sm py-2">
                                        Enter timestamps above to calculate time metrics
                                      </div>
                                    );
                                  }

                                  return (
                                    <div className="bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg p-4 border-2 border-purple-300">
                                      <h5 className="font-bold text-purple-900 mb-3 flex items-center gap-2">
                                        <i data-lucide="bar-chart-2" className="w-4 h-4"></i>
                                        Calculated Intervals
                                      </h5>
                                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        {/* Door-to-CT */}
                                        <div className="bg-white p-3 rounded-lg border border-blue-200 text-center">
                                          <p className="text-xs text-gray-600 mb-1">Door-to-CT</p>
                                          <p className="text-2xl font-bold text-blue-600">
                                            {metrics.doorToCT !== null ? `${metrics.doorToCT} min` : '--'}
                                          </p>
                                          <p className="text-xs text-gray-500">Target: &lt;25 min</p>
                                        </div>

                                        {/* Door-to-Needle (DTN) */}
                                        {metrics.doorToNeedle !== null && (() => {
                                          const benchmark = getDTNBenchmark(metrics.doorToNeedle);
                                          return (
                                            <div className={`p-3 rounded-lg border-2 text-center ${
                                              benchmark.color === 'green' ? 'bg-green-100 border-green-500' :
                                              benchmark.color === 'yellow' ? 'bg-yellow-100 border-yellow-500' :
                                              'bg-red-100 border-red-500'
                                            }`}>
                                              <p className="text-xs text-gray-700 mb-1 font-semibold">Door-to-Needle (DTN)</p>
                                              <p className={`text-3xl font-bold ${
                                                benchmark.color === 'green' ? 'text-green-700' :
                                                benchmark.color === 'yellow' ? 'text-yellow-700' :
                                                'text-red-700'
                                              }`}>
                                                {metrics.doorToNeedle} min
                                              </p>
                                              <p className={`text-sm font-semibold ${
                                                benchmark.color === 'green' ? 'text-green-600' :
                                                benchmark.color === 'yellow' ? 'text-yellow-600' :
                                                'text-red-600'
                                              }`}>
                                                {benchmark.label}
                                              </p>
                                              {benchmark.delta !== 0 && (
                                                <p className="text-xs text-gray-600 mt-1">
                                                  {benchmark.delta > 0
                                                    ? `+${benchmark.delta} min over ${benchmark.target} min target`
                                                    : `${Math.abs(benchmark.delta)} min under target`}
                                                </p>
                                              )}
                                            </div>
                                          );
                                        })()}
                                        {metrics.doorToNeedle === null && (
                                          <div className="bg-white p-3 rounded-lg border border-gray-200 text-center">
                                            <p className="text-xs text-gray-600 mb-1">Door-to-Needle (DTN)</p>
                                            <p className="text-2xl font-bold text-gray-400">--</p>
                                            <p className="text-xs text-gray-500">Target: &lt;45 min</p>
                                          </div>
                                        )}

                                        {/* CT-to-Needle */}
                                        <div className="bg-white p-3 rounded-lg border border-blue-200 text-center">
                                          <p className="text-xs text-gray-600 mb-1">CT-to-Needle</p>
                                          <p className="text-2xl font-bold text-blue-600">
                                            {metrics.ctToNeedle !== null ? `${metrics.ctToNeedle} min` : '--'}
                                          </p>
                                          <p className="text-xs text-gray-500">Target: &lt;20 min</p>
                                        </div>
                                      </div>

                                      {/* Benchmark Legend */}
                                      <div className="mt-3 pt-3 border-t border-purple-200">
                                        <p className="text-xs text-gray-600 text-center">
                                          DTN Benchmarks:
                                          <span className="ml-2 px-2 py-0.5 bg-green-500 text-white rounded">≤45 min = Excellent</span>
                                          <span className="ml-1 px-2 py-0.5 bg-yellow-500 text-white rounded">46-60 min = Good</span>
                                          <span className="ml-1 px-2 py-0.5 bg-red-500 text-white rounded">&gt;60 min = Needs Improvement</span>
                                        </p>
                                      </div>
                                    </div>
                                  );
                                })()}
                              </div>
                            </details>

                            {/* EVT Eligibility (Collapsible) */}
                            <details className="bg-blue-50 border border-blue-200 rounded-lg">
                              <summary className="cursor-pointer p-3 font-semibold text-blue-800 hover:bg-blue-100 rounded-lg">
                                🔧 EVT Eligibility Criteria (Click to expand)
                              </summary>
                              <div className="p-4 space-y-3 text-sm">
                                <div>
                                  <h4 className="font-semibold text-blue-700 mb-2">Basilar Artery Occlusion:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Last known well ≤24 hours</li>
                                    <li>• NIHSS score ≥10</li>
                                    <li>• pc-ASPECTS ≥6</li>
                                  </ul>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-green-700 mb-2">Anterior Circulation Large Vessel Occlusion:</h4>
                                  <p className="text-xs text-gray-600 mb-2">Trial evidence principally supports efficacy among adults ≥60 years of age, baseline mRS 0-1, NIHSS≥6 with disabling symptoms</p>
                                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
                                    <div className="bg-white p-2 rounded border">
                                      <p className="font-semibold text-green-700 text-xs mb-1">Early Window (0-6h):</p>
                                      <ul className="space-y-1 ml-2 text-xs">
                                        <li>• ASPECTS 3-10: Generally eligible for EVT</li>
                                        <li>• ASPECTS 0-2: Consider in very select cases; Consider CTP to evaluate if estimated core volume is &lt;70-100cc</li>
                                      </ul>
                                    </div>
                                    <div className="bg-white p-2 rounded border">
                                      <p className="font-semibold text-purple-700 text-xs mb-1">Late Window (6-24h):</p>
                                      <ul className="space-y-1 ml-2 text-xs">
                                        <li>• ASPECTS 6-10: Generally eligible for EVT</li>
                                        <li>• ASPECTS 3-5: Generally eligible; Consider CTP to evaluate if estimated core volume is ≤100cc + mismatch is present</li>
                                        <li>• ASPECTS 0-2: EVT benefit is unclear</li>
                                      </ul>
                                    </div>
                                  </div>
                                </div>
                                <div>
                                  <h4 className="font-semibold text-orange-700 mb-2">Medium Vessel Occlusion:</h4>
                                  <ul className="space-y-1 ml-4">
                                    <li>• Consider in select cases of proximal or dominant M2 segment MCA occlusion within ≤1cm of bifurcation in horizontal segment when there is evidence of salvageable tissue + last known well is ≤24 hours</li>
                                    <li>• Not recommended for M2-M4 MCA, ACA, and PCA occlusions</li>
                                  </ul>
                                </div>
                              </div>
                            </details>

                            <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
                              <input
                                type="checkbox"
                                checked={telestrokeNote.evtRecommended}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, evtRecommended: e.target.checked})}
                                className="w-4 h-4"
                              />
                              EVT Recommended
                            </label>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">Rationale for Recommendation</label>
                              <textarea
                                value={telestrokeNote.rationale}
                                onChange={(e) => setTelestrokeNote({...telestrokeNote, rationale: e.target.value})}
                                placeholder=""
                                rows="3"
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                              />
                            </div>
                          </div>
                        </div>

                        {/* Section 7: Recommendations */}
                        <div className="bg-white border-2 border-teal-300 rounded-lg p-4 shadow-md">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-teal-900">7. Recommendations</h3>
                            <i data-lucide="clipboard-check" className="w-5 h-5 text-teal-600"></i>
                          </div>
                          <div>
                            <textarea
                              value={telestrokeNote.recommendationsText}
                              onChange={(e) => setTelestrokeNote({...telestrokeNote, recommendationsText: e.target.value})}
                              placeholder=""
                              rows="6"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>

                        {/* Telestroke Section */}
                        <div className="bg-gray-50 border border-gray-300 rounded-lg p-4 mt-4">
                          <h3 className="text-lg font-semibold text-gray-800 mb-4">Telestroke</h3>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            {/* OSH Transfer */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">OSH Transfer:</h4>
                              <ul className="text-sm space-y-1">
                                <li>• BP treatment target</li>
                                <li>• AP tx (IS)</li>
                                <li>• Type of transport</li>
                                <li>• ETA</li>
                                <li>• Inform ER/NCCS about acute medical complications or comorbidities, intubation, hemodynamic instability, continuous infusions, and imaging planned on arrival</li>
                              </ul>
                            </div>

                            {/* TNK risk/benefit discussion documentation */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">TNK risk/benefit discussion documentation:</h4>
                              <p className="text-sm">After ensuring that there were no evident contraindications, TNK administration was recommended. Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the OSH provider and patient/family prior to initiating treatment.</p>
                            </div>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Post-IV TNK/tPA recommendations */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">Post-IV TNK/tPA recommendations:</h4>
                              <ul className="text-sm space-y-1">
                                <li>• Admit to ICU</li>
                                <li>• q1hour neurochecks and VS monitoring</li>
                                <li>• NO antithrombotics/anticoagulants for 24 hour after IV-tPA</li>
                                <li>• Maintain BP&lt;180/105 for 24 hours after IV-tPA</li>
                                <li>• HCT 24 hours post-tPA administration</li>
                                <li>• MRI Brain with diffusion weighted imaging</li>
                                <li>• EKG/telemetry</li>
                                <li>• Transthoracic echocardiogram</li>
                                <li>• Fasting lipid panel, HgA1c</li>
                                <li>• PT/OT/SLP evaluations</li>
                                <li>• SCDs for DVT ppx</li>
                                <li>• Inpatient neurology consultation for further diagnostic evaluation and management</li>
                              </ul>
                            </div>

                            {/* MT risk/benefit discussion */}
                            <div className="bg-white p-3 rounded border">
                              <h4 className="font-semibold text-gray-700 mb-2">MT risk/benefit discussion:</h4>
                              <p className="text-sm">Given the presence of a large vascular occlusion, disabling neurological symptoms, and no evident contraindications - the patient will be transferred to HMC for mechanical thrombectomy consideration. Potential benefits, potential risks, and alternatives to treatment were discussed with the OSH provider and patient/family; the neuro-IR team at HMC will obtain informed consent from the patient/family.</p>
                            </div>
                          </div>
                        </div>

                        {/* Section 8: Pulsara Summary */}
                        <div className="bg-white border-2 border-indigo-300 rounded-lg p-4 shadow-md mt-4">
                          <div className="flex items-center justify-between mb-3">
                            <h3 className="text-lg font-bold text-indigo-900">8. Pulsara Summary</h3>
                            <i data-lucide="clipboard" className="w-5 h-5 text-indigo-600"></i>
                          </div>

                          {/* Auto-Generated Summary */}
                          <div className="mt-4 bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div className="flex items-center justify-between mb-2">
                              <h4 className="font-semibold text-gray-800 text-sm">Pulsara Summary:</h4>
                              <button
                                onClick={() => {
                                  const age = telestrokeNote.age || "[Age]";
                                  const sexRaw = telestrokeNote.sex;
                                  const sex = sexRaw === 'M' ? 'male' : sexRaw === 'F' ? 'female' : '[sex]';
                                  const pmh = telestrokeNote.pmh || "no PMH";
                                  const symptoms = telestrokeNote.symptoms || "[symptoms]";
                                  const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : "[time]";
                                  const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : "[date]";
                                  const nihss = telestrokeNote.nihss || nihssScore || "[score]";
                                  const nihssDeficits = telestrokeNote.nihssDetails ? ` (${telestrokeNote.nihssDetails})` : "";
                                  const ctResults = telestrokeNote.ctResults || "[CT findings]";
                                  const ctaResults = telestrokeNote.ctaResults || "[CTA findings]";
                                  const ctpResults = telestrokeNote.ctpResults || "N/A";
                                  const aspectsStr = aspectsScore ? ` ASPECTS: ${aspectsScore}.` : "";
                                  const tnkStatus = telestrokeNote.tnkRecommended ? "Recommended" : "Not Recommended";
                                  const evtStatus = telestrokeNote.evtRecommended ? "Recommended" : "Not Recommended";
                                  const rationale = telestrokeNote.rationale || "[rationale]";

                                  const trialText = getTrialEligibilityForNote();
                                  const summary = `${age} year old ${sex} with ${pmh} who presents with ${symptoms}. Last known well is ${lkw} ${lkwDate}. NIHSS score: ${nihss}${nihssDeficits}. Head CT: ${ctResults}.${aspectsStr} CTA Head/Neck: ${ctaResults}. CTP: ${ctpResults}. TNK Treatment: ${tnkStatus}. EVT: ${evtStatus}. Rationale for Treatment Recommendation: ${rationale}. ${trialText}`;
                                  navigator.clipboard.writeText(summary);
                                  setCopiedText('pulsara-summary');
                                  setTimeout(() => setCopiedText(''), 2000);
                                }}
                                className="flex items-center gap-2 px-3 py-1 bg-green-600 text-white text-xs rounded-lg hover:bg-green-700 transition-colors"
                              >
                                <i data-lucide={copiedText === 'pulsara-summary' ? 'check' : 'copy'} className="w-3 h-3"></i>
                                {copiedText === 'pulsara-summary' ? 'Copied!' : 'Copy'}
                              </button>
                            </div>
                            <p className="text-xs text-gray-700 whitespace-pre-wrap">
                              {(() => {
                                const age = telestrokeNote.age || "[Age]";
                                const sexRaw = telestrokeNote.sex;
                                const sex = sexRaw === 'M' ? 'male' : sexRaw === 'F' ? 'female' : '[sex]';
                                const pmh = telestrokeNote.pmh || "no PMH";
                                const symptoms = telestrokeNote.symptoms || "[symptoms]";
                                const lkw = lkwTime ? lkwTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : "[time]";
                                const lkwDate = lkwTime ? lkwTime.toLocaleDateString('en-US') : "[date]";
                                const nihss = telestrokeNote.nihss || nihssScore || "[score]";
                                const nihssDeficits = telestrokeNote.nihssDetails ? ` (${telestrokeNote.nihssDetails})` : "";
                                const ctResults = telestrokeNote.ctResults || "[CT findings]";
                                const ctaResults = telestrokeNote.ctaResults || "[CTA findings]";
                                const ctpResults = telestrokeNote.ctpResults || "N/A";
                                const aspectsStr = aspectsScore ? ` ASPECTS: ${aspectsScore}.` : "";
                                const tnkStatus = telestrokeNote.tnkRecommended ? "Recommended" : "Not Recommended";
                                const evtStatus = telestrokeNote.evtRecommended ? "Recommended" : "Not Recommended";
                                const rationale = telestrokeNote.rationale || "[rationale]";

                                const trialText = getTrialEligibilityForNote();
                                return `${age} year old ${sex} with ${pmh} who presents with ${symptoms}. Last known well is ${lkw} ${lkwDate}. NIHSS score: ${nihss}${nihssDeficits}. Head CT: ${ctResults}.${aspectsStr} CTA Head/Neck: ${ctaResults}. CTP: ${ctpResults}. TNK Treatment: ${tnkStatus}. EVT: ${evtStatus}. Rationale for Treatment Recommendation: ${rationale}. ${trialText}`;
                              })()}
                            </p>
                          </div>
                        </div>

                        {/* Telestroke Note - Epic */}
                        <div className="bg-gray-50 border-2 border-gray-300 rounded-lg p-4 shadow-md mt-4">
                          <div className="flex items-center justify-between mb-3">
                            <h4 className="font-bold text-gray-800 flex items-center gap-2">
                              <i data-lucide="file-text" className="w-5 h-5"></i>
                              Telestroke Note - Epic
                            </h4>
                            <div className="flex gap-2 flex-wrap">
                              <button
                                onClick={() => setShowTemplateEditor(!showTemplateEditor)}
                                className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors"
                              >
                                <i data-lucide={showTemplateEditor ? 'eye-off' : 'edit'} className="w-4 h-4"></i>
                                {showTemplateEditor ? 'Hide Editor' : 'Edit Template'}
                              </button>
                              <button
                                onClick={() => {
                                  let note = generateTelestrokeNote();
                                  // Append trial eligibility screening
                                  note += `\n\n${getTrialEligibilityForNote()}`;
                                  navigator.clipboard.writeText(note);
                                  setCopiedText('encounter-note');
                                  setTimeout(() => setCopiedText(''), 2000);
                                }}
                                className="flex items-center gap-2 px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors"
                              >
                                <i data-lucide={copiedText === 'encounter-note' ? 'check' : 'copy'} className="w-4 h-4"></i>
                                {copiedText === 'encounter-note' ? 'Copied!' : 'Copy Note'}
                              </button>
                              {/* Copy Sign-Out Button */}
                              <button
                                onClick={() => {
                                  const signOutText = generateSinglePatientSignOut();
                                  navigator.clipboard.writeText(signOutText);
                                  setCopiedText('sign-out');
                                  setTimeout(() => setCopiedText(''), 2000);
                                }}
                                className="flex items-center gap-2 px-3 py-2 bg-orange-500 text-white text-sm rounded-lg hover:bg-orange-600 transition-colors"
                                title="Copy PHI-free sign-out summary for this patient"
                              >
                                <i data-lucide={copiedText === 'sign-out' ? 'check' : 'send'} className="w-4 h-4"></i>
                                {copiedText === 'sign-out' ? 'Copied!' : 'Copy Sign-Out'}
                              </button>
                            </div>
                          </div>

                          {/* Template Editor */}
                          {showTemplateEditor && (
                            <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                              <div className="flex items-center justify-between mb-2">
                                <h5 className="font-semibold text-yellow-900">Edit Template</h5>
                                <button
                                  onClick={() => {
                                    if (confirm('Reset to default template? This will lose any customizations.')) {
                                      setEditableTemplate(`Chief complaint: {chiefComplaint}
Last known well (date/time): {lkwDate} {lkwTime}
HPI: {age} year old {sex} p/w {symptoms} at {lkwTime}
Relevant PMH: {pmh}
Medications: {medications}

Objective:
Vitals:
Presenting BP {presentingBP}
Blood pressure: BP prior to TNK administration: {bpPreTNK} at {bpPreTNKTime}
Labs: Glucose {glucose}
Exam: Scores: NIHSS {nihss} - {nihssDetails}

Imaging: I personally reviewed imaging
Date/time Non-contrast Head CT reviewed: {ctTime}; Non-contrast Head CT Results: {ctResults}
Date/time CTA reviewed: {ctaDate} {ctaTime}; CTA Results: {ctaResults}
Telemetry/EKG: {ekgResults}

Assessment and Plan:
Suspected Diagnosis: {diagnosis}
After ensuring that there were no evident contraindications, TNK administration was recommended at {tnkAdminTime}. Potential benefits, potential risks (including a potential risk of sx ICH of up to 4%), and alternatives to treatment were discussed with the patient, patient's wife, and OSH provider. Both the patient and his wife expressed agreement with the recommendation.
TNK was administered at {tnkAdminTime} after a brief time-out.

Recommendations:
{recommendationsText}

Rizwan Kalani MD`);
                                    }
                                  }}
                                  className="text-xs px-2 py-1 bg-yellow-600 text-white rounded hover:bg-yellow-700"
                                >
                                  Reset to Default
                                </button>
                              </div>
                              <p className="text-xs text-yellow-800 mb-2">
                                Use placeholders like {'{chiefComplaint}'}, {'{age}'}, {'{sex}'}, etc. Changes save automatically.
                              </p>
                              <textarea
                                value={editableTemplate}
                                onChange={(e) => setEditableTemplate(e.target.value)}
                                className="w-full h-96 px-3 py-2 border border-yellow-300 rounded-lg font-mono text-xs focus:ring-2 focus:ring-yellow-500 focus:outline-none"
                                spellCheck="false"
                              />
                            </div>
                          )}

                          <div className="bg-white p-3 rounded border border-gray-200 max-h-96 overflow-y-auto">
                            <pre className="whitespace-pre-wrap text-xs text-gray-800 font-mono">
                              {generateTelestrokeNote()}
                            </pre>
                          </div>
                        </div>

                      </div>

                      {/* RIGHT COLUMN - Live Preview & Tools (1/3 width on desktop, full width on mobile) */}
                      <div className="lg:col-span-1 space-y-4">

                        {/* Time from LKW (Sticky on desktop) */}
                        <div className="bg-gradient-to-br from-red-500 to-orange-500 text-white rounded-lg p-4 shadow-lg lg:sticky lg:top-4 z-30">
                          <div className="text-center">
                            <p className="text-sm font-medium opacity-90">Time from LKW</p>
                            <p className="text-4xl font-bold mt-1">
                              {(() => {
                                const timeCalc = calculateTimeFromLKW();
                                return timeCalc ? `${timeCalc.hours}h ${timeCalc.minutes}m` : '--:--';
                              })()}
                            </p>
                            <p className="text-xs mt-2 opacity-75">
                              {lkwTime ? new Date(lkwTime).toLocaleString() : 'Set LKW time'}
                            </p>
                          </div>
                        </div>

                        {/* Treatment Window Countdown - Enhanced with Elapsed Timer & Audible Alerts */}
                        {(() => {
                          const timeFromLKW = calculateTimeFromLKW();
                          if (!timeFromLKW) return null;

                          const totalHours = timeFromLKW.total;
                          const totalMinutes = totalHours * 60;
                          const tnkRemaining = 4.5 - totalHours;
                          const tnkRemainingMinutes = tnkRemaining * 60;
                          const evtEarlyRemaining = 6 - totalHours;
                          const evtLateRemaining = 24 - totalHours;

                          // Calculate elapsed time with seconds precision
                          const elapsedHours = Math.floor(elapsedSeconds / 3600);
                          const elapsedMins = Math.floor((elapsedSeconds % 3600) / 60);
                          const elapsedSecs = elapsedSeconds % 60;

                          // Determine color based on elapsed time
                          const getElapsedColor = () => {
                            if (totalHours < 3) return 'from-green-500 to-green-600';
                            if (totalHours < 4) return 'from-yellow-500 to-yellow-600';
                            if (totalHours < 4.5) return 'from-orange-500 to-orange-600';
                            return 'from-red-600 to-red-700';
                          };

                          const getTextColor = () => {
                            if (totalHours < 3) return 'text-green-100';
                            if (totalHours < 4) return 'text-yellow-100';
                            if (totalHours < 4.5) return 'text-orange-100';
                            return 'text-red-100';
                          };

                          return (
                            <div className={`bg-white p-4 rounded-lg shadow-lg border-2 ${
                              alertFlashing ? 'border-red-500 alert-flash' : 'border-blue-400'
                            } lg:sticky lg:top-40 z-30`}>

                              {/* Header with Mute Toggle */}
                              <div className="flex items-center justify-between mb-3">
                                <h4 className="font-bold text-lg text-blue-900 flex items-center gap-2">
                                  <i data-lucide="clock" className="w-5 h-5"></i>
                                  Treatment Windows
                                </h4>
                                <button
                                  onClick={toggleAlertMute}
                                  className={`p-2 rounded-full transition-colors ${
                                    alertsMuted
                                      ? 'bg-gray-200 text-gray-500 hover:bg-gray-300'
                                      : 'bg-blue-100 text-blue-600 hover:bg-blue-200'
                                  }`}
                                  title={alertsMuted ? 'Unmute alerts' : 'Mute alerts'}
                                >
                                  {alertsMuted ? (
                                    <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                      <path d="m11 5-6 6h-4v6h4l6 6v-18z"></path>
                                      <line x1="23" y1="9" x2="17" y2="15"></line>
                                      <line x1="17" y1="9" x2="23" y2="15"></line>
                                    </svg>
                                  ) : (
                                    <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                      <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                      <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                      <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                                    </svg>
                                  )}
                                </button>
                              </div>

                              {/* ============================================ */}
                              {/* PROMINENT ELAPSED TIMER FROM LKW             */}
                              {/* ============================================ */}
                              <div className={`bg-gradient-to-r ${getElapsedColor()} rounded-xl p-4 mb-4 text-white shadow-md ${
                                totalHours >= 4 && totalHours < 4.5 ? 'urgent-pulse' : ''
                              }`}>
                                <div className="text-center">
                                  <p className={`text-xs font-medium ${getTextColor()} opacity-90 uppercase tracking-wide`}>
                                    Time Elapsed from LKW
                                  </p>
                                  <div className="text-4xl font-mono font-bold mt-1 tracking-tight">
                                    {elapsedHours}h {elapsedMins.toString().padStart(2, '0')}m {elapsedSecs.toString().padStart(2, '0')}s
                                  </div>
                                  <p className={`text-xs mt-1 ${getTextColor()} opacity-75`}>
                                    LKW: {lkwTime ? new Date(lkwTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--'}
                                  </p>
                                </div>

                                {/* Countdown to TNK window closure */}
                                {tnkRemaining > 0 && (
                                  <div className={`mt-3 pt-3 border-t border-white/30 text-center ${
                                    tnkRemainingMinutes <= 30 ? 'urgent-pulse' : ''
                                  }`}>
                                    <p className="text-xs opacity-80 uppercase tracking-wide">TNK Window Closes In</p>
                                    <div className={`text-2xl font-bold ${
                                      tnkRemainingMinutes <= 15 ? 'text-yellow-200' : 'text-white'
                                    }`}>
                                      {Math.floor(tnkRemainingMinutes / 60)}h {Math.floor(tnkRemainingMinutes % 60)}m
                                    </div>
                                    {tnkRemainingMinutes <= 30 && (
                                      <p className="text-xs text-yellow-200 font-semibold mt-1 animate-pulse">
                                        {tnkRemainingMinutes <= 15 ? 'CRITICAL - Less than 15 min remaining!' : 'Less than 30 min remaining'}
                                      </p>
                                    )}
                                  </div>
                                )}

                                {/* Window closed message */}
                                {tnkRemaining <= 0 && (
                                  <div className="mt-3 pt-3 border-t border-white/30 text-center">
                                    <p className="text-lg font-bold text-white/90">TNK Window Closed</p>
                                    <p className="text-xs text-white/70">
                                      {Math.abs(Math.floor(tnkRemainingMinutes / 60))}h {Math.abs(Math.floor(tnkRemainingMinutes % 60))}m ago
                                    </p>
                                  </div>
                                )}
                              </div>

                              <div className="space-y-3">
                                {/* TNK Window */}
                                <div className={`p-3 rounded-lg border-2 ${
                                  tnkRemaining > 1 ? 'bg-green-50 border-green-500' :
                                  tnkRemaining > 0 ? 'bg-yellow-50 border-yellow-500' :
                                  'bg-gray-50 border-gray-400'
                                } ${tnkRemaining > 0 && tnkRemaining < 0.5 ? 'animate-pulse' : ''}`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                      <span className="font-semibold text-sm">
                                        {tnkRemaining > 0 ? 'TNK (Thrombolysis)' : 'TNK Closed'}
                                      </span>
                                    </div>
                                    {tnkRemaining > 0 && (
                                      <span className={`font-bold text-lg ${
                                        tnkRemaining < 0.5 ? 'text-red-600' : tnkRemaining < 1 ? 'text-yellow-600' : 'text-green-600'
                                      }`}>
                                        {Math.floor(tnkRemaining)}h {Math.floor((tnkRemaining % 1) * 60)}m left
                                      </span>
                                    )}
                                    {tnkRemaining <= 0 && (
                                      <span className="text-gray-600 text-xs font-semibold">
                                        -{Math.floor(Math.abs(tnkRemaining))}h {Math.floor((Math.abs(tnkRemaining) % 1) * 60)}m
                                      </span>
                                    )}
                                  </div>
                                  {/* Progress Bar */}
                                  <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div
                                      className={`h-2 rounded-full transition-all ${
                                        tnkRemaining > 1 ? 'bg-green-500' :
                                        tnkRemaining > 0 ? 'bg-yellow-500' :
                                        'bg-gray-400'
                                      }`}
                                      style={{ width: `${Math.max(0, Math.min(100, (totalHours / 4.5) * 100))}%` }}
                                    ></div>
                                  </div>
                                  <p className="text-xs mt-1 text-gray-600">0-4.5h from LKW</p>
                                </div>

                                {/* Early EVT Window (0-6h) */}
                                <div className={`p-3 rounded-lg border-2 ${
                                  evtEarlyRemaining > 1 ? 'bg-blue-50 border-blue-500' :
                                  evtEarlyRemaining > 0 ? 'bg-yellow-50 border-yellow-500' :
                                  'bg-gray-50 border-gray-400'
                                } ${evtEarlyRemaining > 0 && evtEarlyRemaining < 0.5 ? 'animate-pulse' : ''}`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                      <span className="font-semibold text-sm">
                                        {evtEarlyRemaining > 0 ? 'EVT (Early Window)' : 'Early EVT Closed'}
                                      </span>
                                    </div>
                                    {evtEarlyRemaining > 0 && (
                                      <span className={`font-bold text-lg ${
                                        evtEarlyRemaining < 0.5 ? 'text-red-600' : evtEarlyRemaining < 1 ? 'text-yellow-600' : 'text-blue-600'
                                      }`}>
                                        {Math.floor(evtEarlyRemaining)}h {Math.floor((evtEarlyRemaining % 1) * 60)}m left
                                      </span>
                                    )}
                                    {evtEarlyRemaining <= 0 && (
                                      <span className="text-gray-600 text-xs font-semibold">
                                        -{Math.floor(Math.abs(evtEarlyRemaining))}h {Math.floor((Math.abs(evtEarlyRemaining) % 1) * 60)}m
                                      </span>
                                    )}
                                  </div>
                                  {/* Progress Bar */}
                                  <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                    <div
                                      className={`h-2 rounded-full transition-all ${
                                        evtEarlyRemaining > 1 ? 'bg-blue-500' :
                                        evtEarlyRemaining > 0 ? 'bg-yellow-500' :
                                        'bg-gray-400'
                                      }`}
                                      style={{ width: `${Math.max(0, Math.min(100, (totalHours / 6) * 100))}%` }}
                                    ></div>
                                  </div>
                                  <p className="text-xs mt-1 text-gray-600">0-6h from LKW</p>
                                </div>

                                {/* Late EVT Window (6-24h) */}
                                {totalHours >= 6 && (
                                  <div className={`p-3 rounded-lg border-2 ${
                                    evtLateRemaining > 0 ? 'bg-purple-50 border-purple-500' : 'bg-gray-50 border-gray-400'
                                  }`}>
                                    <div className="flex items-center justify-between mb-2">
                                      <div className="flex items-center gap-2">
                                        <span className="font-semibold text-sm">
                                          {evtLateRemaining > 0 ? 'EVT (Extended Window)' : 'All Windows Closed'}
                                        </span>
                                      </div>
                                      {evtLateRemaining > 0 && (
                                        <span className="font-bold text-lg text-purple-600">
                                          {Math.floor(evtLateRemaining)}h {Math.floor((evtLateRemaining % 1) * 60)}m left
                                        </span>
                                      )}
                                      {evtLateRemaining <= 0 && (
                                        <span className="text-gray-600 text-xs font-semibold">All closed</span>
                                      )}
                                    </div>
                                    {/* Progress Bar */}
                                    <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                      <div
                                        className={`h-2 rounded-full transition-all ${
                                          evtLateRemaining > 0 ? 'bg-purple-500' : 'bg-gray-400'
                                        }`}
                                        style={{ width: `${Math.max(0, Math.min(100, (totalHours / 24) * 100))}%` }}
                                      ></div>
                                    </div>
                                    <p className="text-xs mt-1 text-gray-600">6-24h (perfusion imaging required)</p>
                                  </div>
                                )}
                              </div>

                              {/* Alert status indicator */}
                              <div className="mt-3 pt-3 border-t border-gray-200 flex items-center justify-between text-xs text-gray-500">
                                <span>
                                  Alerts: {alertsMuted ? 'Muted' : 'Active'}
                                  {!alertsMuted && tnkRemaining > 0 && tnkRemaining < 0.5 && ' (30m, 15m, 0m)'}
                                </span>
                                {lastAlertPlayed && (
                                  <span className="text-orange-600 font-medium">
                                    Last: {lastAlertPlayed === 'warning-30' ? '30m warning' :
                                           lastAlertPlayed === 'warning-15' ? '15m warning' :
                                           'Window closed'}
                                  </span>
                                )}
                              </div>
                            </div>
                          );
                        })()}

                        {/* ============================================ */}
                        {/* TRIAL SCREENING SIDEBAR                     */}
                        {/* Collapsed by default, expands in-place      */}
                        {/* ============================================ */}
                        {(() => {
                          const eligibleTrials = Object.entries(trialEligibility).filter(([_, t]) => t?.status === 'eligible' || t?.status === 'needs_info');
                          const hasData = telestrokeNote.age || nihssScore;

                          if (!hasData) return null;

                          return (
                            <div className="bg-white border-2 border-indigo-200 rounded-lg shadow-md lg:sticky lg:top-[420px] z-20 overflow-hidden">
                              {/* Header */}
                              <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-3">
                                <div className="flex items-center justify-between">
                                  <h4 className="font-bold text-sm flex items-center gap-2">
                                    🔬 Clinical Trial Screening
                                  </h4>
                                  <div className="flex items-center gap-1">
                                    {eligibleTrials.filter(([_, t]) => t?.status === 'eligible').length > 0 && (
                                      <span className="px-2 py-0.5 text-xs bg-green-400 text-green-900 rounded-full font-semibold">
                                        {eligibleTrials.filter(([_, t]) => t?.status === 'eligible').length} match
                                      </span>
                                    )}
                                  </div>
                                </div>
                              </div>

                              {/* Trial Cards */}
                              <div className="max-h-[400px] overflow-y-auto">
                                {Object.entries(trialEligibility).length === 0 ? (
                                  <p className="p-4 text-sm text-gray-500 italic text-center">
                                    Enter patient data to see trial eligibility
                                  </p>
                                ) : (
                                  Object.entries(trialEligibility)
                                    .sort(([, a], [, b]) => {
                                      // Sort: eligible first, then needs_info, then not_eligible
                                      const order = { eligible: 0, needs_info: 1, not_eligible: 2, pending: 3 };
                                      return (order[a?.status] || 3) - (order[b?.status] || 3);
                                    })
                                    .map(([trialId, result]) => {
                                      if (!result) return null;
                                      const config = TRIAL_ELIGIBILITY_CONFIG[trialId];
                                      if (!config) return null;

                                      const isExpanded = expandedTrial === trialId;
                                      const statusColors = {
                                        eligible: 'border-l-green-500 bg-green-50',
                                        needs_info: 'border-l-yellow-500 bg-yellow-50',
                                        not_eligible: 'border-l-gray-400 bg-gray-50',
                                        pending: 'border-l-blue-400 bg-blue-50'
                                      };
                                      const statusLabels = {
                                        eligible: { text: 'Potentially Eligible', color: 'text-green-700 bg-green-100' },
                                        needs_info: { text: 'Needs Info', color: 'text-yellow-700 bg-yellow-100' },
                                        not_eligible: { text: 'Not Eligible', color: 'text-gray-600 bg-gray-100' },
                                        pending: { text: 'Pending', color: 'text-blue-700 bg-blue-100' }
                                      };

                                      return (
                                        <div
                                          key={trialId}
                                          className={`border-l-4 ${statusColors[result.status]} border-b border-gray-200`}
                                        >
                                          {/* Trial Header - Clickable */}
                                          <button
                                            onClick={() => setExpandedTrial(isExpanded ? null : trialId)}
                                            className="w-full p-3 text-left hover:bg-opacity-75 transition-colors"
                                          >
                                            <div className="flex items-start justify-between gap-2">
                                              <div className="flex-1">
                                                <div className="flex items-center gap-2">
                                                  <span className="font-semibold text-sm text-gray-900">{config.name}</span>
                                                  <i
                                                    data-lucide={isExpanded ? 'chevron-up' : 'chevron-down'}
                                                    className="w-3 h-3 text-gray-500"
                                                  ></i>
                                                </div>
                                                <p className="text-xs text-gray-600 mt-0.5">{config.quickDescription}</p>
                                              </div>
                                              <span className={`px-2 py-0.5 text-xs rounded font-medium whitespace-nowrap ${statusLabels[result.status]?.color}`}>
                                                {statusLabels[result.status]?.text}
                                              </span>
                                            </div>

                                            {/* Quick Stats */}
                                            <div className="flex items-center gap-3 mt-2 text-xs">
                                              <span className="text-green-600">✓ {result.metCount} met</span>
                                              {result.unknownCount > 0 && (
                                                <span className="text-yellow-600">? {result.unknownCount} unknown</span>
                                              )}
                                              {result.notMetCount > 0 && (
                                                <span className="text-red-600">✗ {result.notMetCount} not met</span>
                                              )}
                                            </div>
                                          </button>

                                          {/* Expanded Criteria - In-Place */}
                                          {isExpanded && (
                                            <div className="px-3 pb-3 border-t border-gray-200 bg-white">
                                              {/* Inclusion Criteria */}
                                              <div className="mt-2">
                                                <p className="text-xs font-semibold text-gray-700 mb-1">Inclusion Criteria:</p>
                                                <div className="space-y-1">
                                                  {result.criteria.map((c, idx) => (
                                                    <div key={idx} className="flex items-start gap-2 text-xs">
                                                      <span className={`flex-shrink-0 ${
                                                        c.status === 'met' ? 'text-green-600' :
                                                        c.status === 'not_met' ? 'text-red-600' :
                                                        'text-yellow-600'
                                                      }`}>
                                                        {c.status === 'met' ? '✓' : c.status === 'not_met' ? '✗' : '?'}
                                                      </span>
                                                      <span className={`${
                                                        c.status === 'met' ? 'text-gray-700' :
                                                        c.status === 'not_met' ? 'text-red-700 line-through' :
                                                        'text-yellow-700'
                                                      }`}>
                                                        {c.label}
                                                        {c.value !== undefined && c.value !== null && (
                                                          <span className="text-gray-500 ml-1">({c.value})</span>
                                                        )}
                                                      </span>
                                                    </div>
                                                  ))}
                                                </div>
                                              </div>

                                              {/* Exclusion Criteria */}
                                              {result.exclusions && result.exclusions.length > 0 && (
                                                <div className="mt-2">
                                                  <p className="text-xs font-semibold text-gray-700 mb-1">Exclusion Criteria:</p>
                                                  <div className="space-y-1">
                                                    {result.exclusions.map((e, idx) => (
                                                      <div key={idx} className="flex items-start gap-2 text-xs">
                                                        <span className={`flex-shrink-0 ${
                                                          e.status === 'clear' ? 'text-green-600' :
                                                          e.status === 'excluded' ? 'text-red-600' :
                                                          'text-yellow-600'
                                                        }`}>
                                                          {e.status === 'clear' ? '✓' : e.status === 'excluded' ? '✗' : '?'}
                                                        </span>
                                                        <span className="text-gray-600">{e.label}</span>
                                                      </div>
                                                    ))}
                                                  </div>
                                                </div>
                                              )}

                                              {/* Quick Actions */}
                                              <div className="mt-3 flex gap-2">
                                                <button
                                                  onClick={() => setActiveTab('trials')}
                                                  className="text-xs text-indigo-600 hover:underline font-medium"
                                                >
                                                  Full Details →
                                                </button>
                                              </div>
                                            </div>
                                          )}
                                        </div>
                                      );
                                    })
                                )}
                              </div>
                            </div>
                          );
                        })()}


                        {/* ============================================ */}
                        {/* SMART PHRASE LIBRARY                        */}
                        {/* Quick-copy documentation templates          */}
                        {/* Only visible when scrolled to Part 6        */}
                        {/* ============================================ */}
                        {showSmartPhrases && (
                          <details className="bg-white border-2 border-teal-200 rounded-lg shadow-md overflow-hidden">
                            <summary className="bg-gradient-to-r from-teal-500 to-cyan-500 text-white p-3 cursor-pointer hover:from-teal-600 hover:to-cyan-600 transition-colors">
                              <span className="font-bold text-sm flex items-center gap-2">
                                📋 Smart Phrases
                                <span className="text-xs opacity-75">(click to expand)</span>
                              </span>
                            </summary>

                            <div className="p-3 space-y-2 max-h-80 overflow-y-auto">
                              {/* Generate from Current Data */}
                              <div className="space-y-2 mb-3">
                                <p className="text-xs font-semibold text-gray-600 uppercase">From Current Patient</p>
                                <button
                                  onClick={() => {
                                    const text = generateHPI();
                                    navigator.clipboard.writeText(text);
                                    setCopiedText('HPI copied!');
                                    setTimeout(() => setCopiedText(''), 2000);
                                  }}
                                  className="w-full p-2 bg-teal-50 hover:bg-teal-100 border border-teal-200 rounded text-left text-xs transition-colors"
                                >
                                  <span className="font-medium text-teal-700">HPI + Assessment</span>
                                  <p className="text-gray-500 truncate">Auto-generated from form data</p>
                                </button>
                                <button
                                  onClick={() => {
                                    const text = generateAdmissionOrders();
                                    navigator.clipboard.writeText(text);
                                    setCopiedText('Orders copied!');
                                    setTimeout(() => setCopiedText(''), 2000);
                                  }}
                                  className="w-full p-2 bg-teal-50 hover:bg-teal-100 border border-teal-200 rounded text-left text-xs transition-colors"
                                >
                                  <span className="font-medium text-teal-700">Admission Orders</span>
                                  <p className="text-gray-500 truncate">Standard stroke admission order set</p>
                                </button>
                                <button
                                  onClick={() => {
                                    const text = generateSignOut();
                                    navigator.clipboard.writeText(text);
                                    setCopiedText('Sign-out copied!');
                                    setTimeout(() => setCopiedText(''), 2000);
                                  }}
                                  className="w-full p-2 bg-teal-50 hover:bg-teal-100 border border-teal-200 rounded text-left text-xs transition-colors"
                                >
                                  <span className="font-medium text-teal-700">Stroke Sign-Out</span>
                                  <p className="text-gray-500 truncate">Concise handoff summary</p>
                                </button>
                              </div>

                              {/* Common Phrases */}
                              <div className="space-y-2 border-t pt-3">
                                <p className="text-xs font-semibold text-gray-600 uppercase">Common Phrases</p>

                                {[
                                  { label: 'TNK Eligible', text: 'Patient meets criteria for IV thrombolysis. Risks and benefits discussed including ~3% risk of symptomatic ICH, ~40% chance of significant improvement. Patient/family agree to proceed.' },
                                  { label: 'TNK Not Indicated', text: 'IV thrombolysis not indicated: [outside window / NIHSS minor and non-disabling / anticoagulation / contraindication]. Will proceed with supportive care and secondary prevention.' },
                                  { label: 'EVT Recommendation', text: 'Large vessel occlusion identified. Patient is a candidate for mechanical thrombectomy. Transferred to comprehensive stroke center for endovascular evaluation.' },
                                  { label: 'Stroke Mimic', text: 'Clinical presentation initially concerning for acute stroke, however imaging and clinical evaluation more consistent with stroke mimic. Consider: [seizure with Todd paralysis / complex migraine / functional neurological disorder / peripheral etiology].' },
                                  { label: 'TIA Workup', text: 'Transient ischemic attack with complete symptom resolution. ABCD2 score: __. Plan: MRI brain with DWI, vessel imaging, cardiac monitoring, lipid panel, HbA1c. Start dual antiplatelet therapy (aspirin + clopidogrel) for 21 days if no contraindication.' },
                                  { label: 'Wake-up Stroke', text: 'Patient with wake-up stroke, symptoms discovered at __ upon awakening. Last known well: __ (prior evening). Will obtain MRI with DWI to assess for DWI-FLAIR mismatch. If favorable mismatch, may be candidate for thrombolysis per WAKE-UP trial criteria.' },
                                  { label: 'Late Window', text: 'Patient presenting in extended window (>6 hours). CTP demonstrates favorable perfusion profile with small core and significant penumbra. Meets criteria for EVT consideration per DAWN/DEFUSE-3 extended window protocols.' },
                                  { label: 'Swallow Precautions', text: 'NPO until formal swallow evaluation completed by speech therapy. Risk of aspiration pneumonia in acute stroke patients. Will reassess diet orders after evaluation.' },
                                  { label: 'BP Management Post-TNK', text: 'Post-thrombolysis BP management: Maintain SBP <180 and DBP <105 for 24 hours. If persistent hypertension, initiate IV labetalol or nicardipine drip. Avoid SBP <100 to maintain cerebral perfusion.' },
                                  { label: 'Secondary Prevention', text: 'Secondary stroke prevention initiated: High-intensity statin (atorvastatin 80mg), antiplatelet therapy (aspirin 81mg daily after 24h if received tPA), BP goal optimization, glucose control, smoking cessation counseling, lifestyle modifications discussed.' }
                                ].map((phrase, idx) => (
                                  <button
                                    key={idx}
                                    onClick={() => {
                                      navigator.clipboard.writeText(phrase.text);
                                      setCopiedText(`${phrase.label} copied!`);
                                      setTimeout(() => setCopiedText(''), 2000);
                                    }}
                                    className="w-full p-2 bg-gray-50 hover:bg-gray-100 border border-gray-200 rounded text-left text-xs transition-colors"
                                  >
                                    <span className="font-medium text-gray-700">{phrase.label}</span>
                                    <p className="text-gray-500 truncate">{phrase.text.substring(0, 60)}...</p>
                                  </button>
                                ))}
                              </div>
                            </div>

                            <div className="bg-teal-50 p-2 text-center border-t border-teal-200">
                              <p className="text-xs text-teal-700">Click any phrase to copy</p>
                            </div>
                          </details>
                        )}

                      </div>


                    </div>
                  </div>
                )}
                {/* Workflow */}




                {/* ICH */}
                {activeTab === 'ich' && (
                  <div className="space-y-6">
                    {/* ============================================ */}
                    {/* ICH-SPECIFIC TRIAL ELIGIBILITY PANEL         */}
                    {/* Shows ICH-relevant trials for current patient */}
                    {/* ============================================ */}
                    {telestrokeNote.age && (
                      <div className="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-300 rounded-lg p-4 shadow-md">
                        <div className="flex items-center justify-between mb-3">
                          <h2 className="text-lg font-bold text-red-900 flex items-center gap-2">
                            🔬 ICH Trial Eligibility - Current Patient
                          </h2>
                          <div className="text-sm text-red-700">
                            {telestrokeNote.age}{telestrokeNote.sex || '?'} | GCS {telestrokeNote.gcs || '?'} | NIHSS {nihssScore || '?'}
                          </div>
                        </div>
                        <p className="text-sm text-red-700 mb-3">Trials relevant for intracerebral hemorrhage patients:</p>

                        {/* ICH-Relevant Trial Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                          {/* ASPIRE Trial Card */}
                          {(() => {
                            const aspireResult = trialEligibility['ASPIRE'];
                            if (!aspireResult) return null;
                            const statusStyles = {
                              eligible: 'bg-green-100 border-green-500',
                              needs_info: 'bg-yellow-100 border-yellow-500',
                              not_eligible: 'bg-gray-100 border-gray-400',
                              pending: 'bg-blue-100 border-blue-400'
                            };
                            const statusLabels = {
                              eligible: '🟢 Potentially Eligible',
                              needs_info: '🟡 Needs More Info',
                              not_eligible: '⚪ Not Eligible',
                              pending: '🔵 Pending Evaluation'
                            };
                            return (
                              <div className={`p-3 rounded-lg border-2 ${statusStyles[aspireResult.status]}`}>
                                <div className="flex justify-between items-start mb-2">
                                  <h3 className="font-bold text-gray-900">ASPIRE Trial</h3>
                                  <span className="text-xs">{statusLabels[aspireResult.status]}</span>
                                </div>
                                <p className="text-xs text-gray-600 mb-2">Antiplatelet after spontaneous ICH</p>
                                <div className="text-xs space-y-1">
                                  <p className="font-semibold">Key Criteria:</p>
                                  <ul className="ml-2 space-y-0.5">
                                    <li>• Age 18-85</li>
                                    <li>• Spontaneous ICH 14-180 days prior</li>
                                    <li>• mRS ≤4</li>
                                    <li>• Indication for antiplatelet</li>
                                  </ul>
                                </div>
                              </div>
                            );
                          })()}
                        </div>
                      </div>
                    )}

                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <h2 className="text-xl font-semibold text-red-800 mb-4">ICH Management</h2>

                      {/* Minimally Invasive Evacuation */}
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 className="text-lg font-semibold text-blue-800 mb-3">Minimally Invasive Evacuation (MIE)</h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <div className="bg-white p-3 rounded border">
                            <h4 className="font-semibold text-green-600 mb-2">ENRICH Trial Inclusion (NCT02880878)</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Spontaneous supratentorial lobar or basal ganglia ICH</li>
                              <li>• ICH onset ≤24 hours</li>
                              <li>• Age 18-80 years</li>
                              <li>• GCS 5-14 and NIHSS ≥6</li>
                              <li>• ICH volume 30-80 cc</li>
                              <li>• Pre-morbid mRS 0-1</li>
                            </ul>
                          </div>

                          <div className="bg-white p-3 rounded border">
                            <h4 className="font-semibold text-red-600 mb-2">ENRICH Trial Exclusion</h4>
                            <ul className="text-sm space-y-1">
                              <li>• Coagulopathy</li>
                              <li>• IVH &gt;50% either lateral ventricle</li>
                              <li>• Thalamic/infratentorial ICH</li>
                            </ul>
                          </div>
                        </div>

                        <div className="bg-gray-100 p-3 rounded">
                          <p className="text-sm font-semibold mb-2">ICH Volume Calculation:</p>
                          <p className="text-sm"><strong>ABC/2 Method:</strong></p>
                          <ul className="text-sm ml-4">
                            <li>A = largest ICH diameter (cm)</li>
                            <li>B = largest diameter 90 degrees to A on same slice (cm)</li>
                            <li>C = (# CT slices with ICH) x (slice thickness)</li>
                          </ul>
                          <p className="text-sm mt-2 font-semibold">Volume = A x B x C / 2</p>
                        </div>
                      </div>

                      {/* Anticoagulation Reversal */}
                      <div className="mb-6">
                        <h3 className="text-lg font-semibold text-red-700 mb-4">Anticoagulation Reversal</h3>
                        
                        {/* Warfarin */}
                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-blue-700 mb-3">Warfarin</h4>
                          <ul className="text-sm space-y-1">
                            <li>• <strong>Vitamin K:</strong> 10 mg IV over 20 min</li>
                            <li>• <strong>PCC (KCentra):</strong> 2000 U IV</li>
                          </ul>
                        </div>

                        {/* Direct Oral Anticoagulants (DOACs) */}
                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-purple-700 mb-3">Direct Oral Anticoagulants (DOACs)</h4>
                          
                          <div className="mb-3">
                            <p className="text-sm font-semibold text-gray-700">Direct Factor Xa Inhibitors:</p>
                            <p className="text-sm text-gray-600 mb-2">Apixaban, Rivaroxaban, Edoxaban</p>
                            <ul className="text-sm space-y-1">
                              <li>• <strong>PCC (KCentra):</strong> 50 IU/kg (max 5000 IU)</li>
                            </ul>
                          </div>
                          
                          <div>
                            <p className="text-sm font-semibold text-gray-700">Direct Thrombin Inhibitor:</p>
                            <p className="text-sm text-gray-600 mb-2">Dabigatran</p>
                            <ul className="text-sm space-y-1">
                              <li>• <strong>Idarucizumab (Praxbind):</strong> 5g IV (2 x 2.5g)</li>
                              <li>• <strong>If unavailable:</strong> PCC (KCentra)</li>
                            </ul>
                          </div>
                        </div>

                        {/* Relative Contraindications */}
                        <div className="bg-white p-4 rounded border mb-4">
                          <h4 className="font-semibold text-gray-700 mb-3">Relative contraindications to PCC/FFP:</h4>
                          <ul className="text-sm space-y-1">
                            <li>• History of major thrombosis/thromboembolism ≤6 weeks</li>
                            <li>• Major surgery ≤6 weeks</li>
                            <li>• Known prothrombotic disorder</li>
                            <li>• IPH not considered survivable</li>
                          </ul>
                        </div>
                      </div>

                      {/* ICH Prognostic Scores - Quick Link to Calculators */}
                      <div className="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-6">
                        <div className="flex items-center justify-between">
                          <h3 className="text-lg font-semibold text-purple-800">ICH Prognostic Scores</h3>
                          <button
                            onClick={() => setActiveTab('calculators')}
                            className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium"
                          >
                            <i data-lucide="calculator" className="w-4 h-4"></i>
                            Open Calculators
                          </button>
                        </div>
                        <p className="text-sm text-gray-600 mt-2">ICH Score, Fisher Scale, Hunt & Hess → Calculators tab</p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Trials */}
                                {activeTab === 'trials' && (
                  <div className="space-y-6">
                    {/* Header Section */}
                    <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-lg shadow-lg">
                      <h1 className="text-3xl font-bold">Stroke Trials and Studies</h1>
                    </div>

                    {/* ============================================ */}
                    {/* CURRENT PATIENT ELIGIBILITY PANEL            */}
                    {/* Shows eligibility status for current patient */}
                    {/* ============================================ */}
                    {telestrokeNote.age && (
                      <div className="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-300 rounded-lg p-4 shadow-md">
                        <div className="flex items-center justify-between mb-3">
                          <h2 className="text-lg font-bold text-indigo-900 flex items-center gap-2">
                            🔬 Current Patient Trial Eligibility
                          </h2>
                          <div className="text-sm text-indigo-700">
                            {telestrokeNote.age}{telestrokeNote.sex || '?'} | NIHSS {telestrokeNote.nihss || nihssScore || '?'} | {(() => {
                              const tf = calculateTimeFromLKW();
                              return tf ? `${tf.hours}h ${tf.minutes}m from LKW` : 'LKW not set';
                            })()}
                          </div>
                        </div>

                        {/* Eligibility Grid */}
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                          {Object.entries(trialEligibility)
                            .sort(([, a], [, b]) => {
                              const order = { eligible: 0, needs_info: 1, not_eligible: 2, pending: 3 };
                              return (order[a?.status] || 3) - (order[b?.status] || 3);
                            })
                            .map(([trialId, result]) => {
                              if (!result) return null;
                              const config = TRIAL_ELIGIBILITY_CONFIG[trialId];
                              if (!config) return null;

                              const statusStyles = {
                                eligible: 'bg-green-100 border-green-500 text-green-800',
                                needs_info: 'bg-yellow-100 border-yellow-500 text-yellow-800',
                                not_eligible: 'bg-gray-100 border-gray-400 text-gray-600',
                                pending: 'bg-blue-100 border-blue-400 text-blue-700'
                              };
                              const statusIcons = {
                                eligible: '🟢',
                                needs_info: '🟡',
                                not_eligible: '⚪',
                                pending: '🔵'
                              };

                              return (
                                <div
                                  key={trialId}
                                  className={`p-3 rounded-lg border-2 ${statusStyles[result.status]} cursor-pointer hover:shadow-md transition-shadow`}
                                  onClick={() => setExpandedTrial(expandedTrial === trialId ? null : trialId)}
                                >
                                  <div className="flex items-center justify-between">
                                    <span className="font-semibold text-sm">{config.name}</span>
                                    <span>{statusIcons[result.status]}</span>
                                  </div>
                                  <p className="text-xs mt-1 opacity-80">{config.quickDescription.substring(0, 40)}...</p>
                                  <div className="flex items-center gap-2 mt-2 text-xs">
                                    <span>✓{result.metCount}</span>
                                    <span>?{result.unknownCount}</span>
                                    <span>✗{result.notMetCount}</span>
                                  </div>

                                  {/* Expanded Details */}
                                  {expandedTrial === trialId && (
                                    <div className="mt-3 pt-3 border-t border-current border-opacity-20 text-xs">
                                      <p className="font-semibold mb-1">Key Criteria:</p>
                                      {result.criteria.slice(0, 5).map((c, i) => (
                                        <div key={i} className="flex items-center gap-1">
                                          <span>{c.status === 'met' ? '✓' : c.status === 'not_met' ? '✗' : '?'}</span>
                                          <span className={c.status === 'not_met' ? 'line-through' : ''}>{c.label}</span>
                                        </div>
                                      ))}
                                      {result.criteria.length > 5 && (
                                        <p className="text-xs opacity-70 mt-1">+{result.criteria.length - 5} more criteria</p>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                        </div>

                        {/* Legend */}
                        <div className="flex items-center gap-4 mt-3 pt-3 border-t border-indigo-200 text-xs text-indigo-700">
                          <span>🟢 Potentially Eligible</span>
                          <span>🟡 Needs More Info</span>
                          <span>⚪ Not Eligible</span>
                          <span className="ml-auto">Click card for details</span>
                        </div>
                      </div>
                    )}

                    {/* Trial Category Filter Buttons */}
                    <div className="flex flex-wrap gap-2 mb-6">
                      {Object.keys(trialsData).map(category => {
                        const categoryData = trialsData[category];
                        const trialCount = categoryData.hasSubsections 
                          ? Object.values(categoryData.subsections).reduce((acc, sub) => acc + sub.trials.length, 0)
                          : categoryData.trials.length;
                        
                        const getCategoryColor = (cat) => {
                          switch(cat) {
                            case 'ischemic': return 'bg-blue-600 hover:bg-blue-700';
                            case 'ich': return 'bg-red-600 hover:bg-red-700';
                            case 'rehab': return 'bg-green-600 hover:bg-green-700';
                            case 'cadasil': return 'bg-purple-600 hover:bg-purple-700';
                            default: return 'bg-gray-600 hover:bg-gray-700';
                          }
                        };
                        
                        const getCategoryName = (cat) => {
                          switch(cat) {
                            case 'ischemic': return 'Ischemic Stroke';
                            case 'ich': return 'Intracerebral Hemorrhage';
                            case 'rehab': return 'Rehabilitation';
                            case 'cadasil': return 'CADASIL';
                            default: return categoryData.title;
                          }
                        };
                        
                        return (
                          <button
                            key={category}
                            onClick={() => setTrialsCategory(category)}
                            className={`px-4 py-2 rounded-full font-medium transition-all ${
                              trialsCategory === category
                                ? `${getCategoryColor(category)} text-white shadow-lg`
                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            }`}
                          >
                            {getCategoryName(category)} ({trialCount})
                          </button>
                        );
                      })}
                    </div>
                    
                    {/* Trial Cards */}
                    <div className="space-y-4">
                      {(() => {
                        const categoryData = trialsData[trialsCategory];
                        return (
                          <div className="space-y-4">
                            <h2 className="text-2xl font-bold text-gray-800 border-b-2 border-gray-300 pb-2">
                              {categoryData.title}
                            </h2>
                            {categoryData.hasSubsections ? (
                              Object.entries(categoryData.subsections).map(([subKey, subsection]) => (
                                <div key={subKey} className="space-y-4">
                                  <h3 className="text-xl font-semibold text-gray-700 ml-4">
                                    {subsection.title}
                                  </h3>
                                  {subsection.trials.map((trial, index) => (
                                    <TrialCard key={index} trial={trial} category={trialsCategory} />
                                  ))}
                                </div>
                              ))
                            ) : (
                              categoryData.trials.map((trial, index) => (
                                <TrialCard key={index} trial={trial} category={trialsCategory} />
                              ))
                            )}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}

                {/* Risk Calculators */}
                {activeTab === 'calculators' && (
                  <div className="space-y-4">
                    {/* ============================================ */}
                    {/* CALCULATOR TRIAL PROMPTS                     */}
                    {/* Shows trial relevance after scoring          */}
                    {/* ============================================ */}
                    {(nihssScore || telestrokeNote.age) && (
                      <div className="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-300 rounded-lg p-4 shadow-md">
                        <div className="flex items-center justify-between mb-2">
                          <h2 className="text-lg font-bold text-purple-900 flex items-center gap-2">
                            🔬 Score → Trial Implications
                          </h2>
                          {telestrokeNote.age && (
                            <span className="text-sm text-purple-700">
                              Current: {telestrokeNote.age}{telestrokeNote.sex || '?'} | NIHSS {nihssScore || '?'}
                            </span>
                          )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                          {/* NIHSS-based prompts */}
                          {nihssScore !== null && nihssScore !== undefined && (
                            <div className="bg-white rounded p-3 border">
                              <h3 className="font-semibold text-purple-800 mb-2">NIHSS = {nihssScore}</h3>
                              <ul className="space-y-1 text-xs text-gray-700">
                                {nihssScore >= 6 && (
                                  <li className="text-green-700">
                                    🟢 <strong>SISTER eligible</strong>: NIHSS ≥6 threshold met
                                  </li>
                                )}
                                {nihssScore <= 5 && (
                                  <li className="text-yellow-700">
                                    🟡 <strong>STEP mild arm</strong>: Check for LVO (ICA/M1/basilar)
                                  </li>
                                )}
                                {nihssScore > 8 && (
                                  <li className="text-blue-700">
                                    🔵 <strong>STEP MeVO arm</strong>: Check for M2/M3 occlusion
                                  </li>
                                )}
                                {nihssScore < 6 && (
                                  <li className="text-gray-600">
                                    ⚪ SISTER: NIHSS ≥6 required (current: {nihssScore})
                                  </li>
                                )}
                              </ul>
                            </div>
                          )}
                          {/* GCS-based prompts */}
                          {(() => {
                            const gcs = calculateGCS(gcsItems);
                            if (gcs === 0) return null;
                            return (
                              <div className="bg-white rounded p-3 border">
                                <h3 className="font-semibold text-purple-800 mb-2">GCS = {gcs}</h3>
                                <ul className="space-y-1 text-xs text-gray-700">
                                  {gcs >= 5 && gcs <= 14 && (
                                    <li className="text-blue-700">
                                      🔵 <strong>ENRICH range</strong>: GCS 5-14 for MIE consideration
                                    </li>
                                  )}
                                  {gcs > 14 && (
                                    <li className="text-gray-600">
                                      ⚪ ENRICH: GCS 5-14 required (current: {gcs})
                                    </li>
                                  )}
                                  {gcs < 5 && (
                                    <li className="text-gray-600">
                                      ⚪ GCS too low for most trial eligibility
                                    </li>
                                  )}
                                </ul>
                              </div>
                            );
                          })()}
                        </div>
                        <p className="text-xs text-purple-600 mt-2 italic">
                          💡 These are quick prompts only. Full eligibility requires complete patient assessment.
                        </p>
                      </div>
                    )}

                    {/* Glasgow Coma Scale */}
                    <details className="bg-gray-50 border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-gray-800 hover:bg-gray-100 rounded-lg flex items-center justify-between">
                        <span>Glasgow Coma Scale (GCS)</span>
                        <span className="text-sm font-normal text-gray-600">Score: {calculateGCS(gcsItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                        <div className="text-right">
                          <span className="text-xl font-bold text-gray-600">Score: {calculateGCS(gcsItems)}</span>
                          <div className="text-xs text-gray-500">Range: 3-15</div>
                        </div>
                        <button
                          onClick={() => copyToClipboard(`GCS: ${calculateGCS(gcsItems)}`, 'GCS Score')}
                          className="p-1.5 hover:bg-gray-100 rounded transition-colors"
                          aria-label="Copy GCS score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-4 h-4 text-gray-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-2">
                        <div className="space-y-2">
                          <h4 className="font-semibold">Eye Opening</h4>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_eye"
                              value="4"
                              className="text-gray-600"
                              checked={gcsItems.eye === '4'}
                              onChange={(e) => setGcsItems({...gcsItems, eye: e.target.value})}
                            />
                            <span className="text-sm">4 - Spontaneous</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_eye"
                              value="3"
                              className="text-gray-600"
                              checked={gcsItems.eye === '3'}
                              onChange={(e) => setGcsItems({...gcsItems, eye: e.target.value})}
                            />
                            <span className="text-sm">3 - To sound</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_eye"
                              value="2"
                              className="text-gray-600"
                              checked={gcsItems.eye === '2'}
                              onChange={(e) => setGcsItems({...gcsItems, eye: e.target.value})}
                            />
                            <span className="text-sm">2 - To pain</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_eye"
                              value="1"
                              className="text-gray-600"
                              checked={gcsItems.eye === '1'}
                              onChange={(e) => setGcsItems({...gcsItems, eye: e.target.value})}
                            />
                            <span className="text-sm">1 - None</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <h4 className="font-semibold">Verbal Response</h4>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_verbal"
                              value="5"
                              className="text-gray-600"
                              checked={gcsItems.verbal === '5'}
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">5 - Oriented</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_verbal"
                              value="4"
                              className="text-gray-600"
                              checked={gcsItems.verbal === '4'}
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">4 - Confused</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_verbal"
                              value="3"
                              className="text-gray-600"
                              checked={gcsItems.verbal === '3'}
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">3 - Inappropriate</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_verbal"
                              value="2"
                              className="text-gray-600"
                              checked={gcsItems.verbal === '2'}
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">2 - Incomprehensible</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_verbal"
                              value="1"
                              className="text-gray-600"
                              checked={gcsItems.verbal === '1'}
                              onChange={(e) => setGcsItems({...gcsItems, verbal: e.target.value})}
                            />
                            <span className="text-sm">1 - None</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <h4 className="font-semibold">Motor Response</h4>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_motor"
                              value="6"
                              className="text-gray-600"
                              checked={gcsItems.motor === '6'}
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">6 - Obeying</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_motor"
                              value="5"
                              className="text-gray-600"
                              checked={gcsItems.motor === '5'}
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">5 - Localizing</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_motor"
                              value="4"
                              className="text-gray-600"
                              checked={gcsItems.motor === '4'}
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">4 - Flexing</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_motor"
                              value="3"
                              className="text-gray-600"
                              checked={gcsItems.motor === '3'}
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">3 - Abnormal flexion</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_motor"
                              value="2"
                              className="text-gray-600"
                              checked={gcsItems.motor === '2'}
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">2 - Extending</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input
                              type="radio"
                              name="gcs_motor"
                              value="1"
                              className="text-gray-600"
                              checked={gcsItems.motor === '1'}
                              onChange={(e) => setGcsItems({...gcsItems, motor: e.target.value})}
                            />
                            <span className="text-sm">1 - None</span>
                          </label>
                        </div>
                      </div>
                      </div>
                    </details>

                    {/* ICH Score */}
                    <details className="bg-red-50 border border-red-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-red-800 hover:bg-red-100 rounded-lg flex items-center justify-between">
                        <span>ICH Score</span>
                        <span className="text-sm font-normal text-red-600">Score: {calculateICHScore(ichScoreItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-red-600">Score: {calculateICHScore(ichScoreItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`ICH Score: ${calculateICHScore(ichScoreItems)}`, 'ICH Score')}
                          className="p-1.5 hover:bg-red-100 rounded transition-colors"
                          aria-label="Copy ICH score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-4 h-4 text-red-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                        <div className="space-y-2">
                          <p className="font-semibold text-sm mb-2">Glasgow Coma Scale:</p>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="ich_gcs"
                              className="text-red-600"
                              checked={ichScoreItems.gcs === 'gcs34'}
                              onChange={() => setIchScoreItems({...ichScoreItems, gcs: 'gcs34'})}
                            />
                            <span className="text-sm">GCS 3-4 (+2 points)</span>
                          </label>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="ich_gcs"
                              className="text-red-600"
                              checked={ichScoreItems.gcs === 'gcs512'}
                              onChange={() => setIchScoreItems({...ichScoreItems, gcs: 'gcs512'})}
                            />
                            <span className="text-sm">GCS 5-12 (+1 point)</span>
                          </label>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="ich_gcs"
                              className="text-red-600"
                              checked={ichScoreItems.gcs === ''}
                              onChange={() => setIchScoreItems({...ichScoreItems, gcs: ''})}
                            />
                            <span className="text-sm">GCS 13-15 (0 points)</span>
                          </label>
                          <hr className="my-3" />
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.age80}
                              onChange={(e) => setIchScoreItems({...ichScoreItems, age80: e.target.checked})}
                            />
                            <span className="text-sm">Age ≥80 (+1)</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.volume30}
                              onChange={(e) => setIchScoreItems({...ichScoreItems, volume30: e.target.checked})}
                            />
                            <span className="text-sm">ICH volume ≥30 cc (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.ivh}
                              onChange={(e) => setIchScoreItems({...ichScoreItems, ivh: e.target.checked})}
                            />
                            <span className="text-sm">Intraventricular hemorrhage (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-red-600"
                              checked={ichScoreItems.infratentorial}
                              onChange={(e) => setIchScoreItems({...ichScoreItems, infratentorial: e.target.checked})}
                            />
                            <span className="text-sm">Infratentorial origin (+1)</span>
                          </label>
                        </div>
                      </div>
                      </div>
                    </details>

                    {/* Modified Rankin Scale (mRS) */}
                    <details className="bg-gray-50 border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-gray-800 hover:bg-gray-100 rounded-lg flex items-center justify-between">
                        <span>Modified Rankin Scale (mRS)</span>
                        <span className="text-sm font-normal text-gray-600">Score: {mrsScore || 'Not Selected'}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <div className="text-right">
                            <span className="text-xl font-bold text-gray-600">
                              Score: {mrsScore || 'Not Selected'}
                            </span>
                          <div className="text-xs text-gray-500">Range: 0-6</div>
                        </div>
                        {mrsScore && (
                          <button
                            onClick={() => copyToClipboard(`mRS: ${mrsScore}`, 'mRS Score')}
                            className="p-1.5 hover:bg-gray-100 rounded transition-colors"
                            aria-label="Copy mRS score to clipboard"
                            title="Copy to clipboard"
                          >
                            <i data-lucide="copy" className="w-4 h-4 text-gray-600"></i>
                          </button>
                        )}
                      </div>

                      <div className="space-y-2">
                        <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                          <input
                            type="radio"
                            name="mrs"
                            value="0"
                            checked={mrsScore === '0'}
                            onChange={(e) => setMrsScore(e.target.value)}
                            className="mt-1 text-blue-600"
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-gray-900">0 - No symptoms</div>
                            <div className="text-sm text-gray-600">Completely recovered; no residual symptoms</div>
                          </div>
                        </label>

                        <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                          <input
                            type="radio"
                            name="mrs"
                            value="1"
                            checked={mrsScore === '1'}
                            onChange={(e) => setMrsScore(e.target.value)}
                            className="mt-1 text-blue-600"
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-gray-900">1 - No significant disability</div>
                            <div className="text-sm text-gray-600">Able to carry out all usual duties and activities despite some symptoms</div>
                          </div>
                        </label>

                        <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                          <input
                            type="radio"
                            name="mrs"
                            value="2"
                            checked={mrsScore === '2'}
                            onChange={(e) => setMrsScore(e.target.value)}
                            className="mt-1 text-blue-600"
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-gray-900">2 - Slight disability</div>
                            <div className="text-sm text-gray-600">Unable to carry out all previous activities but able to look after own affairs without assistance</div>
                          </div>
                        </label>

                        <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                          <input
                            type="radio"
                            name="mrs"
                            value="3"
                            checked={mrsScore === '3'}
                            onChange={(e) => setMrsScore(e.target.value)}
                            className="mt-1 text-blue-600"
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-gray-900">3 - Moderate disability</div>
                            <div className="text-sm text-gray-600">Requires some help, but able to walk without assistance</div>
                          </div>
                        </label>

                        <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                          <input
                            type="radio"
                            name="mrs"
                            value="4"
                            checked={mrsScore === '4'}
                            onChange={(e) => setMrsScore(e.target.value)}
                            className="mt-1 text-blue-600"
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-gray-900">4 - Moderately severe disability</div>
                            <div className="text-sm text-gray-600">Unable to walk without assistance and unable to attend to own bodily needs without assistance</div>
                          </div>
                        </label>

                        <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                          <input
                            type="radio"
                            name="mrs"
                            value="5"
                            checked={mrsScore === '5'}
                            onChange={(e) => setMrsScore(e.target.value)}
                            className="mt-1 text-blue-600"
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-gray-900">5 - Severe disability</div>
                            <div className="text-sm text-gray-600">Bedridden, incontinent, and requires constant nursing care and attention</div>
                          </div>
                        </label>

                        <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 cursor-pointer">
                          <input
                            type="radio"
                            name="mrs"
                            value="6"
                            checked={mrsScore === '6'}
                            onChange={(e) => setMrsScore(e.target.value)}
                            className="mt-1 text-blue-600"
                          />
                          <div className="flex-1">
                            <div className="font-semibold text-gray-900">6 - Dead</div>
                          </div>
                        </label>
                      </div>

                      {mrsScore && (
                        <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                          <p className="text-sm font-semibold text-blue-900 mb-1">Clinical Interpretation:</p>
                          <p className="text-sm text-blue-800">
                            {mrsScore === '0' && 'Excellent outcome - Complete recovery with no residual deficits'}
                            {mrsScore === '1' && 'Good outcome - Minor symptoms that do not interfere with lifestyle'}
                            {mrsScore === '2' && 'Fair outcome - Some restriction in lifestyle but retains capacity for independent living'}
                            {mrsScore === '3' && 'Moderate outcome - Significant lifestyle restriction; requires some assistance'}
                            {mrsScore === '4' && 'Moderately severe outcome - Clearly dependent; requires assistance with basic activities'}
                            {mrsScore === '5' && 'Severe outcome - Totally dependent; requires constant care'}
                            {mrsScore === '6' && 'Death'}
                          </p>
                        </div>
                      )}
                      </div>
                    </details>

                    {/* ABCD2 */}
                    <details className="bg-orange-50 border border-orange-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-orange-800 hover:bg-orange-100 rounded-lg flex items-center justify-between">
                        <span>ABCD² Score</span>
                        <span className="text-sm font-normal text-orange-600">Score: {calculateABCD2Score(abcd2Items)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-orange-600">Score: {calculateABCD2Score(abcd2Items)}</span>
                        <button
                          onClick={() => copyToClipboard(`ABCD² Score: ${calculateABCD2Score(abcd2Items)}`, 'ABCD² Score')}
                          className="p-1.5 hover:bg-orange-100 rounded transition-colors"
                          aria-label="Copy ABCD² score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-4 h-4 text-orange-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.age60}
                              onChange={(e) => setAbcd2Items({...abcd2Items, age60: e.target.checked})}
                            />
                            <span className="text-sm">Age ≥60 (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.bp}
                              onChange={(e) => setAbcd2Items({...abcd2Items, bp: e.target.checked})}
                            />
                            <span className="text-sm">BP: SBP≥140 or DBP≥90 (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-orange-600"
                              checked={abcd2Items.unilateralWeakness}
                              onChange={(e) => setAbcd2Items({...abcd2Items, unilateralWeakness: e.target.checked})}
                            />
                            <span className="text-sm">Unilateral weakness (+2)</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              className="text-orange-600"
                              checked={abcd2Items.speechDisturbance}
                              onChange={(e) => setAbcd2Items({...abcd2Items, speechDisturbance: e.target.checked})}
                            />
                            <span className="text-sm">Speech disturbance w/o weakness (+1)</span>
                          </label>
                          <p className="font-semibold text-sm mt-3 mb-2">Symptom Duration:</p>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="abcd2_duration"
                              className="text-orange-600"
                              checked={abcd2Items.duration === 'duration60'}
                              onChange={() => setAbcd2Items({...abcd2Items, duration: 'duration60'})}
                            />
                            <span className="text-sm">≥60 minutes (+2 points)</span>
                          </label>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="abcd2_duration"
                              className="text-orange-600"
                              checked={abcd2Items.duration === 'duration10'}
                              onChange={() => setAbcd2Items({...abcd2Items, duration: 'duration10'})}
                            />
                            <span className="text-sm">10-59 minutes (+1 point)</span>
                          </label>
                          <label className="flex items-center space-x-2 cursor-pointer">
                            <input
                              type="radio"
                              name="abcd2_duration"
                              className="text-orange-600"
                              checked={abcd2Items.duration === ''}
                              onChange={() => setAbcd2Items({...abcd2Items, duration: ''})}
                            />
                            <span className="text-sm">&lt;10 minutes (0 points)</span>
                          </label>
                          <hr className="my-3" />
                          <label className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              className="text-orange-600"
                              checked={abcd2Items.diabetes}
                              onChange={(e) => setAbcd2Items({...abcd2Items, diabetes: e.target.checked})}
                            />
                            <span className="text-sm">Diabetes mellitus (+1)</span>
                          </label>
                        </div>
                      </div>

                      <div className="bg-white p-3 rounded border">
                        <h4 className="font-semibold mb-2">2-Day, 7-Day, and 90-Day Stroke Risk</h4>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                          <div>
                            <p><strong>0-3:</strong></p>
                            <p>2-day: 1%</p>
                            <p>7-day: 1.2%</p>
                            <p>90-day: 3.1%</p>
                          </div>
                          <div>
                            <p><strong>4-5:</strong></p>
                            <p>2-day: 4.1%</p>
                            <p>7-day: 5.9%</p>
                            <p>90-day: 9.8%</p>
                          </div>
                          <div>
                            <p><strong>6-7:</strong></p>
                            <p>2-day: 8.1%</p>
                            <p>7-day: 11.7%</p>
                            <p>90-day: 17.8%</p>
                          </div>
                        </div>
                      </div>
                      </div>
                    </details>

                    {/* CHADS2-VASC */}
                    <details className="bg-purple-50 border border-purple-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-purple-800 hover:bg-purple-100 rounded-lg flex items-center justify-between">
                        <span>CHA₂DS₂-VASc Score</span>
                        <span className="text-sm font-normal text-purple-600">Score: {calculateCHADS2VascScore(chads2vascItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-purple-600">Score: {calculateCHADS2VascScore(chads2vascItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`CHADS₂-VASc: ${calculateCHADS2VascScore(chads2vascItems)}`, 'CHADS₂-VASc Score')}
                          className="p-1.5 hover:bg-purple-100 rounded transition-colors"
                          aria-label="Copy CHADS₂-VASc score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-4 h-4 text-purple-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-2 md:grid-cols-3 gap-3 mb-2">
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.age65}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, age65: e.target.checked})}
                          />
                          <span className="text-sm">Age 65-74 (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.age75}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, age75: e.target.checked})}
                          />
                          <span className="text-sm">Age ≥75 (+2)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.chf}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, chf: e.target.checked})}
                          />
                          <span className="text-sm">CHF (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.hypertension}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, hypertension: e.target.checked})}
                          />
                          <span className="text-sm">Hypertension (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.diabetes}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, diabetes: e.target.checked})}
                          />
                          <span className="text-sm">Diabetes (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.strokeTia}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, strokeTia: e.target.checked})}
                          />
                          <span className="text-sm">Stroke/TIA (+2)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.vascular}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, vascular: e.target.checked})}
                          />
                          <span className="text-sm">Vascular disease (+1)</span>
                        </label>
                        <label className="flex items-center space-x-2">
                          <input 
                            type="checkbox" 
                            className="text-purple-600"
                            checked={chads2vascItems.female}
                            onChange={(e) => setChads2vascItems({...chads2vascItems, female: e.target.checked})}
                          />
                          <span className="text-sm">Female sex (+1)</span>
                        </label>
                      </div>
                      
                      <div className="bg-white p-3 rounded border">
                        <h4 className="font-semibold mb-2">Annual Stroke and Thromboembolism Risk</h4>
                        <div className="grid grid-cols-3 gap-4 text-sm">
                          <div>
                            <p><strong>Score 0:</strong> 0.8%</p>
                            <p><strong>Score 1:</strong> 2.0%</p>
                            <p><strong>Score 2:</strong> 3.7%</p>
                          </div>
                          <div>
                            <p><strong>Score 3:</strong> 5.9%</p>
                            <p><strong>Score 4:</strong> 9.3%</p>
                            <p><strong>Score 5:</strong> 15.3%</p>
                          </div>
                          <div>
                            <p><strong>Score 6:</strong> 19.7%</p>
                            <p><strong>Score 7:</strong> 21.5%</p>
                            <p><strong>Score 8:</strong> 22.4%</p>
                            <p><strong>Score 9:</strong> 23.6%</p>
                          </div>
                        </div>
                      </div>
                      </div>
                    </details>

                    {/* HAS-BLED Score */}
                    <details className="bg-pink-50 border border-pink-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-pink-800 hover:bg-pink-100 rounded-lg flex items-center justify-between">
                        <span>HAS-BLED Score</span>
                        <span className="text-sm font-normal text-pink-600">Score: {calculateHASBLEDScore(hasbledItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-pink-600">Score: {calculateHASBLEDScore(hasbledItems)}</span>
                          <button
                            onClick={() => copyToClipboard(`HAS-BLED: ${calculateHASBLEDScore(hasbledItems)}`, 'HAS-BLED Score')}
                            className="p-1.5 hover:bg-pink-100 rounded transition-colors"
                            aria-label="Copy HAS-BLED score to clipboard"
                            title="Copy to clipboard"
                          >
                            <i data-lucide="copy" className="w-4 h-4 text-pink-600"></i>
                          </button>
                        </div>

                        <div className="space-y-2 mb-4">
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.hypertension}
                              onChange={(e) => setHasbledItems({...hasbledItems, hypertension: e.target.checked})}
                            />
                            <span className="text-sm"><strong>H</strong>ypertension (uncontrolled SBP &gt;160) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.renalDisease}
                              onChange={(e) => setHasbledItems({...hasbledItems, renalDisease: e.target.checked})}
                            />
                            <span className="text-sm"><strong>A</strong>bnormal renal function (dialysis, transplant, Cr &gt;2.6) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.liverDisease}
                              onChange={(e) => setHasbledItems({...hasbledItems, liverDisease: e.target.checked})}
                            />
                            <span className="text-sm"><strong>A</strong>bnormal liver function (cirrhosis, bilirubin &gt;2x, AST/ALT &gt;3x) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.stroke}
                              onChange={(e) => setHasbledItems({...hasbledItems, stroke: e.target.checked})}
                            />
                            <span className="text-sm"><strong>S</strong>troke history (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.bleeding}
                              onChange={(e) => setHasbledItems({...hasbledItems, bleeding: e.target.checked})}
                            />
                            <span className="text-sm"><strong>B</strong>leeding history or predisposition (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.labileINR}
                              onChange={(e) => setHasbledItems({...hasbledItems, labileINR: e.target.checked})}
                            />
                            <span className="text-sm"><strong>L</strong>abile INR (TTR &lt;60%) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.elderly}
                              onChange={(e) => setHasbledItems({...hasbledItems, elderly: e.target.checked})}
                            />
                            <span className="text-sm"><strong>E</strong>lderly (age &gt;65) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.drugs}
                              onChange={(e) => setHasbledItems({...hasbledItems, drugs: e.target.checked})}
                            />
                            <span className="text-sm"><strong>D</strong>rugs (antiplatelet agents, NSAIDs) (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-pink-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-pink-600"
                              checked={hasbledItems.alcohol}
                              onChange={(e) => setHasbledItems({...hasbledItems, alcohol: e.target.checked})}
                            />
                            <span className="text-sm"><strong>D</strong> (cont.) Alcohol use (≥8 drinks/week) (+1)</span>
                          </label>
                        </div>

                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-pink-700 mb-2">Annual Bleeding Risk</h4>
                          <div className="text-sm space-y-1">
                            <p className={calculateHASBLEDScore(hasbledItems) === 0 ? "font-bold text-pink-600" : ""}><strong>Score 0:</strong> 1.13% per year</p>
                            <p className={calculateHASBLEDScore(hasbledItems) === 1 ? "font-bold text-pink-600" : ""}><strong>Score 1:</strong> 1.02% per year</p>
                            <p className={calculateHASBLEDScore(hasbledItems) === 2 ? "font-bold text-pink-600" : ""}><strong>Score 2:</strong> 1.88% per year</p>
                            <p className={calculateHASBLEDScore(hasbledItems) >= 3 ? "font-bold text-pink-600" : ""}><strong>Score ≥3:</strong> 3.74% per year (high risk)</p>
                          </div>
                          <p className="text-xs text-gray-600 mt-2 italic">High risk (≥3) indicates need for more frequent monitoring and caution with anticoagulation, but should not automatically exclude from treatment.</p>
                        </div>
                      </div>
                    </details>

                    {/* ROPE Score */}
                    <details className="bg-teal-50 border border-teal-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-teal-800 hover:bg-teal-100 rounded-lg flex items-center justify-between">
                        <span>ROPE Score and PASCAL Classification</span>
                        <span className="text-sm font-normal text-teal-600">Score: {calculateROPEScore(ropeItems)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-teal-600">Score: {calculateROPEScore(ropeItems)}</span>
                        <button
                          onClick={() => copyToClipboard(`ROPE Score: ${calculateROPEScore(ropeItems)}`, 'ROPE Score')}
                          className="p-1.5 hover:bg-teal-100 rounded transition-colors"
                          aria-label="Copy ROPE score to clipboard"
                          title="Copy to clipboard"
                        >
                          <i data-lucide="copy" className="w-4 h-4 text-teal-600"></i>
                        </button>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-2">
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.noHypertension}
                              onChange={(e) => setRopeItems({...ropeItems, noHypertension: e.target.checked})}
                            />
                            <span className="text-sm">No history of hypertension (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.noDiabetes}
                              onChange={(e) => setRopeItems({...ropeItems, noDiabetes: e.target.checked})}
                            />
                            <span className="text-sm">No history of diabetes (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.noStrokeTia}
                              onChange={(e) => setRopeItems({...ropeItems, noStrokeTia: e.target.checked})}
                            />
                            <span className="text-sm">No history of stroke or TIA (+1)</span>
                          </label>
                        </div>
                        <div className="space-y-2">
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.nonsmoker}
                              onChange={(e) => setRopeItems({...ropeItems, nonsmoker: e.target.checked})}
                            />
                            <span className="text-sm">Nonsmoker (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2">
                            <input 
                              type="checkbox" 
                              className="text-teal-600"
                              checked={ropeItems.cortical}
                              onChange={(e) => setRopeItems({...ropeItems, cortical: e.target.checked})}
                            />
                            <span className="text-sm">Cortical infarct (+1)</span>
                          </label>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Age (years)</label>
                            <input 
                              type="number"
                              className="w-full px-3 py-1 border border-gray-300 rounded-md text-sm"
                              value={ropeItems.age}
                              onChange={(e) => setRopeItems({...ropeItems, age: e.target.value})}
                              placeholder="Enter age"
                              min="18"
                              max="100"
                            />
                            <div className="text-xs text-gray-500 mt-1">
                              18-29: +5, 30-39: +4, 40-49: +3, 50-59: +2, 60-69: +1, ≥70: 0
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">PFO-attributable fraction</h4>
                          <div className="text-sm">
                            <p className={calculateROPEScore(ropeItems) <= 3 ? "font-bold text-teal-600" : ""}><strong>Score 0-3:</strong> 0-23%</p>
                            <p className={calculateROPEScore(ropeItems) === 4 ? "font-bold text-teal-600" : ""}><strong>Score 4:</strong> 38%</p>
                            <p className={calculateROPEScore(ropeItems) === 5 ? "font-bold text-teal-600" : ""}><strong>Score 5:</strong> 34%</p>
                            <p className={calculateROPEScore(ropeItems) === 6 ? "font-bold text-teal-600" : ""}><strong>Score 6:</strong> 62%</p>
                            <p className={calculateROPEScore(ropeItems) === 7 ? "font-bold text-teal-600" : ""}><strong>Score 7:</strong> 72%</p>
                            <p className={calculateROPEScore(ropeItems) === 8 ? "font-bold text-teal-600" : ""}><strong>Score 8:</strong> 84%</p>
                            <p className={calculateROPEScore(ropeItems) >= 9 ? "font-bold text-teal-600" : ""}><strong>Score 9-10:</strong> 88%</p>
                          </div>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">2-Year Recurrent Stroke/TIA Risk</h4>
                          <div className="text-sm">
                            <p className={calculateROPEScore(ropeItems) <= 3 ? "font-bold text-teal-600" : ""}><strong>Score 0-3:</strong> 20%</p>
                            <p className={calculateROPEScore(ropeItems) === 4 ? "font-bold text-teal-600" : ""}><strong>Score 4:</strong> 12%</p>
                            <p className={calculateROPEScore(ropeItems) === 5 ? "font-bold text-teal-600" : ""}><strong>Score 5:</strong> 15%</p>
                            <p className={calculateROPEScore(ropeItems) === 6 ? "font-bold text-teal-600" : ""}><strong>Score 6:</strong> 8%</p>
                            <p className={calculateROPEScore(ropeItems) === 7 ? "font-bold text-teal-600" : ""}><strong>Score 7:</strong> 6%</p>
                            <p className={calculateROPEScore(ropeItems) === 8 ? "font-bold text-teal-600" : ""}><strong>Score 8:</strong> 6%</p>
                            <p className={calculateROPEScore(ropeItems) >= 9 ? "font-bold text-teal-600" : ""}><strong>Score 9-10:</strong> 2%</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* PASCAL Classification */}
                    <div className="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-indigo-800 mb-3">PASCAL Classification</h3>
                      
                      <div className="space-y-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-green-700 mb-2">Probable PFO-related stroke:</h4>
                          <p className="text-sm">RoPE ≥7 + high-grade shunt / ASA</p>
                        </div>
                        
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-amber-700 mb-2">Possible PFO-related stroke:</h4>
                          <ul className="text-sm space-y-1">
                            <li>• RoPE &lt;7 + high-grade shunt / ASA</li>
                            <li>• RoPE ≥7 but no high-grade shunt / ASA</li>
                          </ul>
                        </div>
                        
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-red-700 mb-2">Unlikely PFO-related stroke:</h4>
                          <p className="text-sm">RoPE &lt;7, no high-grade shunt / ASA</p>
                        </div>
                      </div>
                      </div>
                    </details>


                    {/* RCVS2 Score */}
                    <details className="bg-cyan-50 border border-cyan-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-cyan-800 hover:bg-cyan-100 rounded-lg flex items-center justify-between">
                        <span>RCVS² Score</span>
                        <span className="text-sm font-normal text-cyan-600">Score: {calculateRCVS2Score(rcvs2Items)}</span>
                      </summary>
                      <div className="p-4">
                        <div className="flex justify-end items-center gap-2 mb-3">
                          <span className="text-xl font-bold text-cyan-600">Score: {calculateRCVS2Score(rcvs2Items)}</span>
                          <button
                            onClick={() => copyToClipboard(`RCVS² Score: ${calculateRCVS2Score(rcvs2Items)}`, 'RCVS² Score')}
                            className="p-1.5 hover:bg-cyan-100 rounded transition-colors"
                            aria-label="Copy RCVS² score to clipboard"
                            title="Copy to clipboard"
                          >
                            <i data-lucide="copy" className="w-4 h-4 text-cyan-600"></i>
                          </button>
                        </div>

                        <div className="space-y-2 mb-4">
                          <label className="flex items-center space-x-2 p-2 hover:bg-cyan-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-cyan-600"
                              checked={rcvs2Items.recurrentTCH}
                              onChange={(e) => setRcvs2Items({...rcvs2Items, recurrentTCH: e.target.checked})}
                            />
                            <span className="text-sm">Recurrent thunderclap headaches (+5)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-cyan-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-cyan-600"
                              checked={rcvs2Items.carotidInvolvement}
                              onChange={(e) => setRcvs2Items({...rcvs2Items, carotidInvolvement: e.target.checked})}
                            />
                            <span className="text-sm">Intracranial carotid artery involvement (+3)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-cyan-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-cyan-600"
                              checked={rcvs2Items.vasoconstrictiveTrigger}
                              onChange={(e) => setRcvs2Items({...rcvs2Items, vasoconstrictiveTrigger: e.target.checked})}
                            />
                            <span className="text-sm">Vasoconstrictive trigger exposure (+2)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-cyan-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-cyan-600"
                              checked={rcvs2Items.female}
                              onChange={(e) => setRcvs2Items({...rcvs2Items, female: e.target.checked})}
                            />
                            <span className="text-sm">Female sex (+1)</span>
                          </label>
                          <label className="flex items-center space-x-2 p-2 hover:bg-cyan-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              className="text-cyan-600"
                              checked={rcvs2Items.sah}
                              onChange={(e) => setRcvs2Items({...rcvs2Items, sah: e.target.checked})}
                            />
                            <span className="text-sm">Subarachnoid hemorrhage on imaging (-2)</span>
                          </label>
                        </div>

                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-cyan-700 mb-2">RCVS Probability</h4>
                          <div className="text-sm space-y-1">
                            <p className={calculateRCVS2Score(rcvs2Items) < 2 ? "font-bold text-cyan-600" : ""}><strong>Score &lt;2:</strong> Low probability of RCVS</p>
                            <p className={calculateRCVS2Score(rcvs2Items) >= 2 && calculateRCVS2Score(rcvs2Items) <= 4 ? "font-bold text-cyan-600" : ""}><strong>Score 2-4:</strong> Intermediate probability</p>
                            <p className={calculateRCVS2Score(rcvs2Items) >= 5 ? "font-bold text-cyan-600" : ""}><strong>Score ≥5:</strong> High probability of RCVS</p>
                          </div>
                          <p className="text-xs text-gray-600 mt-2 italic">RCVS² score helps distinguish RCVS from other causes of thunderclap headache. Consider vascular imaging and repeat imaging in 2-4 weeks if high suspicion.</p>
                        </div>
                      </div>
                    </details>

                    {/* Hunt and Hess Scale / WFNS Scale */}
                    <details className="bg-amber-50 border border-amber-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-amber-800 hover:bg-amber-100 rounded-lg flex items-center justify-between">
                        <span>Hunt and Hess / WFNS Scale (SAH Grading)</span>
                        <span className="text-sm font-normal text-amber-600">H&H: {huntHessGrade || 'Not Selected'} | WFNS: {wfnsGrade || 'Not Selected'}</span>
                      </summary>
                      <div className="p-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          {/* Hunt and Hess Scale */}
                          <div className="space-y-3">
                            <h4 className="text-base font-semibold text-amber-800 mb-2">Hunt and Hess Scale</h4>
                            <div className="space-y-2">
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="huntHess"
                                  value="1"
                                  checked={huntHessGrade === '1'}
                                  onChange={(e) => setHuntHessGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 1</div>
                                  <div className="text-sm text-gray-600">Asymptomatic or mild headache</div>
                                </div>
                              </label>
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="huntHess"
                                  value="2"
                                  checked={huntHessGrade === '2'}
                                  onChange={(e) => setHuntHessGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 2</div>
                                  <div className="text-sm text-gray-600">Moderate-severe headache, nuchal rigidity, no deficit (except CN palsy)</div>
                                </div>
                              </label>
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="huntHess"
                                  value="3"
                                  checked={huntHessGrade === '3'}
                                  onChange={(e) => setHuntHessGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 3</div>
                                  <div className="text-sm text-gray-600">Drowsiness, confusion, or mild focal deficit</div>
                                </div>
                              </label>
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="huntHess"
                                  value="4"
                                  checked={huntHessGrade === '4'}
                                  onChange={(e) => setHuntHessGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 4</div>
                                  <div className="text-sm text-gray-600">Stupor, moderate-severe hemiparesis</div>
                                </div>
                              </label>
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="huntHess"
                                  value="5"
                                  checked={huntHessGrade === '5'}
                                  onChange={(e) => setHuntHessGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 5</div>
                                  <div className="text-sm text-gray-600">Deep coma, decerebrate rigidity, moribund</div>
                                </div>
                              </label>
                            </div>
                          </div>

                          {/* WFNS Scale */}
                          <div className="space-y-3">
                            <h4 className="text-base font-semibold text-amber-800 mb-2">WFNS Scale</h4>
                            <div className="space-y-2">
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="wfns"
                                  value="1"
                                  checked={wfnsGrade === '1'}
                                  onChange={(e) => setWfnsGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 1</div>
                                  <div className="text-sm text-gray-600">GCS 15, no motor deficit</div>
                                </div>
                              </label>
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="wfns"
                                  value="2"
                                  checked={wfnsGrade === '2'}
                                  onChange={(e) => setWfnsGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 2</div>
                                  <div className="text-sm text-gray-600">GCS 13-14, no motor deficit</div>
                                </div>
                              </label>
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="wfns"
                                  value="3"
                                  checked={wfnsGrade === '3'}
                                  onChange={(e) => setWfnsGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 3</div>
                                  <div className="text-sm text-gray-600">GCS 13-14, with motor deficit</div>
                                </div>
                              </label>
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="wfns"
                                  value="4"
                                  checked={wfnsGrade === '4'}
                                  onChange={(e) => setWfnsGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 4</div>
                                  <div className="text-sm text-gray-600">GCS 7-12, with or without motor deficit</div>
                                </div>
                              </label>
                              <label className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-amber-200 hover:bg-amber-50 cursor-pointer">
                                <input
                                  type="radio"
                                  name="wfns"
                                  value="5"
                                  checked={wfnsGrade === '5'}
                                  onChange={(e) => setWfnsGrade(e.target.value)}
                                  className="mt-1 text-amber-600"
                                />
                                <div className="flex-1">
                                  <div className="font-semibold text-gray-900">Grade 5</div>
                                  <div className="text-sm text-gray-600">GCS 3-6, with or without motor deficit</div>
                                </div>
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </details>

                    {/* PREVENT 10-year ASCVD Risk */}
                    <details className="bg-rose-50 border border-rose-200 rounded-lg">
                      <summary className="cursor-pointer p-3 font-semibold text-rose-800 hover:bg-rose-100 rounded-lg">
                        PREVENT 10-year ASCVD Risk Estimate
                      </summary>
                      <div className="p-4">
                        <div className="bg-white p-4 rounded border">
                        <a 
                          href="https://professional.heart.org/en/guidelines-and-statements/prevent-calculator" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="inline-flex items-center px-4 py-2 bg-rose-600 text-white rounded-md hover:bg-rose-700 transition-colors text-sm font-medium"
                        >
                          Open PREVENT Calculator →
                        </a>
                        </div>
                      </div>
                    </details>

                  </div>
                )}

                {/* Management */}
                {activeTab === 'protocols' && (
                  <div className="space-y-6">
                    {/* ============================================ */}
                    {/* PROTOCOL-TRIAL CONNECTION PANEL              */}
                    {/* Links protocols to relevant clinical trials  */}
                    {/* ============================================ */}
                    <div className="bg-gradient-to-r from-teal-50 to-cyan-50 border-2 border-teal-300 rounded-lg p-4 shadow-md">
                      <div className="flex items-center justify-between mb-3">
                        <h2 className="text-lg font-bold text-teal-900 flex items-center gap-2">
                          🔗 Protocol → Trial Connection
                        </h2>
                        {telestrokeNote.age && (
                          <span className="text-sm text-teal-700">
                            Current: {telestrokeNote.age}{telestrokeNote.sex || '?'} | NIHSS {nihssScore || '?'}
                          </span>
                        )}
                      </div>
                      <p className="text-sm text-teal-700 mb-3">Remember to consider clinical trials when applying protocols:</p>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                        {/* Thrombolysis Protocol → Trials */}
                        <div className="bg-white rounded p-3 border">
                          <h3 className="font-semibold text-teal-800 text-sm mb-2">Thrombolysis Protocols</h3>
                          <ul className="space-y-1 text-xs text-gray-700">
                            <li>→ <strong>SISTER</strong>: Late window (4.5-24h), no TNK/EVT</li>
                            <li>→ <strong>TESTED</strong>: TNK vs alteplase comparison</li>
                            <li className="text-gray-500 italic">If pt ineligible for standard lytics, check trial options</li>
                          </ul>
                        </div>
                        {/* EVT Protocol → Trials */}
                        <div className="bg-white rounded p-3 border">
                          <h3 className="font-semibold text-teal-800 text-sm mb-2">EVT/Thrombectomy</h3>
                          <ul className="space-y-1 text-xs text-gray-700">
                            <li>→ <strong>STEP</strong>: Mild LVO or MeVO patients</li>
                            <li>→ <strong>SATURN</strong>: Tandem occlusions</li>
                            <li className="text-gray-500 italic">Consider trials for borderline EVT candidates</li>
                          </ul>
                        </div>
                        {/* BP/ICH Protocol → Trials */}
                        <div className="bg-white rounded p-3 border">
                          <h3 className="font-semibold text-teal-800 text-sm mb-2">ICH Management</h3>
                          <ul className="space-y-1 text-xs text-gray-700">
                            <li>→ <strong>ASPIRE</strong>: Antiplatelet after ICH</li>
                            <li>→ <strong>ENRICH</strong>: Minimally invasive evacuation</li>
                            <li className="text-gray-500 italic">See ICH tab for detailed criteria</li>
                          </ul>
                        </div>
                      </div>
                      {/* Current patient trial status */}
                      {telestrokeNote.age && (
                        <div className="mt-3 pt-3 border-t border-teal-200">
                          <div className="flex items-center gap-4 text-sm">
                            <span className="font-semibold text-teal-800">Current Patient Eligibility:</span>
                            {(() => {
                              const summary = getTrialEligibilitySummary();
                              return (
                                <span className="flex items-center gap-3">
                                  {summary.eligible > 0 && (
                                    <span className="text-green-700">🟢 {summary.eligible} potentially eligible</span>
                                  )}
                                  {summary.needsInfo > 0 && (
                                    <span className="text-yellow-700">🟡 {summary.needsInfo} need more info</span>
                                  )}
                                  <button
                                    onClick={() => setActiveTab('trials')}
                                    className="text-teal-600 hover:text-teal-800 underline"
                                  >
                                    View details →
                                  </button>
                                </span>
                              );
                            })()}
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Blood Pressure Management */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-blue-800 mb-3">Blood Pressure Management</h3>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-green-700 mb-2">BP Goals</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Ischemic stroke:</strong> SBP &lt;220, DBP &lt;120</li>
                            <li><strong>Before lytics:</strong> SBP &lt;185, DBP &lt;110</li>
                            <li><strong>After lytics:</strong> SBP &lt;180, DBP &lt;105</li>
                            <li><strong>After thrombectomy:</strong> SBP &lt;180, DBP &lt;105</li>
                            <li><strong>ICH:</strong> SBP &lt;160, DBP &lt;105</li>
                          </ul>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold text-blue-700 mb-2">Acute Treatment</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Labetalol:</strong> 10 mg IV q15min</li>
                            <li>Increase to 20mg, then 40mg, then 60mg</li>
                            <li>Max total dose: 300mg in 2 hours</li>
                            <li><strong>Alternative:</strong> Nicardipine 5 mg/hr IV</li>
                            <li>Titrate by 2.5 mg/hr q15min</li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    {/* Post-Lytic Complications */}
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-red-800 mb-3">Post-Lytic ICH Protocol</h3>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">Immediate Actions</h4>
                          <ol className="text-sm space-y-1 list-decimal list-inside">
                            <li>STAT non-contrast CT head</li>
                            <li>Emergency hemorrhage panel</li>
                            <li>Type & cross</li>
                            <li>Notify patient's family</li>
                          </ol>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">Reversal Agents</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Cryoprecipitate:</strong> 2 pools over 10-30 min</li>
                            <li><strong>Tranexamic acid:</strong> 1g IV infused over 10 minutes</li>
                          </ul>
                        </div>
                      </div>
                    </div>

                    {/* Angioedema Protocol */}
                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <h3 className="text-lg font-semibold text-yellow-800 mb-3">Orolingual Angioedema Protocol</h3>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">Assessment</h4>
                          <ul className="text-sm space-y-1">
                            <li>• Maintain airway</li>
                            <li>• Hold ACE inhibitors</li>
                            <li>• Consider intubation if severe</li>
                          </ul>
                        </div>
                        <div className="bg-white p-3 rounded border">
                          <h4 className="font-semibold mb-2">Treatment</h4>
                          <ul className="text-sm space-y-1">
                            <li><strong>Methylprednisolone:</strong> 125 mg IV</li>
                            <li><strong>Diphenhydramine:</strong> 50 mg IV</li>
                            <li><strong>Famotidine:</strong> 20 mg IV</li>
                            <li><strong>Epinephrine:</strong> 0.1% if severe</li>
                            <li><strong>Consider Berinert:</strong> 20 IU/kg (C1 esterase inhibitor)</li>
                            <li><strong>Supportive Care</strong></li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Evidence */}
                                {activeTab === 'evidence' && (
                  <div className="space-y-6">

                    {/* Evidence Filter */}
                    <div className="bg-white border border-gray-200 rounded-lg p-4">
                      <div className="relative">
                        <input
                          type="text"
                          placeholder="Filter evidence documents..."
                          value={evidenceFilter}
                          onChange={(e) => setEvidenceFilter(e.target.value)}
                          className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                          aria-label="Filter evidence documents"
                        />
                        <i data-lucide="search" className="w-5 h-5 absolute left-3 top-2.5 text-gray-400"></i>
                        {evidenceFilter && (
                          <button
                            onClick={() => setEvidenceFilter('')}
                            className="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600"
                            aria-label="Clear filter"
                          >
                            <i data-lucide="x" className="w-5 h-5"></i>
                          </button>
                        )}
                      </div>
                      {evidenceFilter && (
                        <p className="text-sm text-gray-600 mt-2">
                          Filtering by: <span className="font-semibold">{evidenceFilter}</span>
                        </p>
                      )}
                    </div>

                    {/* Quick Links */}
                    <div className="flex flex-col sm:flex-row gap-3">
                      <a
                        href="https://www.openevidence.com"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                      >
                        <i data-lucide="external-link" className="w-5 h-5"></i>
                        <span>OpenEvidence</span>
                      </a>
                      <a
                        href="https://www.uptodate.com"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                      >
                        <i data-lucide="external-link" className="w-5 h-5"></i>
                        <span>UpToDate</span>
                      </a>
                      <a
                        href="https://asta.allen.ai/chat"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center gap-2 px-4 py-3 bg-white border border-blue-300 rounded-lg hover:bg-blue-100 transition-colors text-blue-700 font-medium"
                      >
                        <i data-lucide="external-link" className="w-5 h-5"></i>
                        <span>Asta (Ai2)</span>
                      </a>
                    </div>

                    {/* Aneurysms & Vascular Malformations Section */}
                    {evidenceSectionMatches('Aneurysms & Vascular Malformations', ['Unruptured Cerebral Aneurysms']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Aneurysms & Vascular Malformations</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Unruptured Cerebral Aneurysms */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Unruptured Cerebral Aneurysms</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/aneurysms/Unruptured Cerebral Aneurysms.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/aneurysms/Unruptured Cerebral Aneurysms.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Unruptured Cerebral Aneurysms', 'documents/aneurysms/Unruptured Cerebral Aneurysms.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Antiplatelet Therapy Section */}
                    {evidenceSectionMatches('Antiplatelet Therapy', ['DAPT Minor Stroke-TIA Trials', 'DAPT After Ischemic Stroke-TIA']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Antiplatelet Therapy</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - DAPT Minor Stroke-TIA Trials */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">DAPT Minor Stroke-TIA Trials</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/antiplatelet/DAPT Minor Stroke-TIA Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/antiplatelet/DAPT Minor Stroke-TIA Trials.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('DAPT Minor Stroke-TIA Trials', 'documents/antiplatelet/DAPT Minor Stroke-TIA Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                        {/* Document 2 - DAPT After Ischemic Stroke-TIA */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="image" className="w-6 h-6 text-green-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">DAPT After Ischemic Stroke-TIA</h4>
                              <p className="text-xs text-gray-500">Infographic - Match Patient to Trial</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/antiplatelet/DAPT After Ischemic Stroke-TIA.jpeg"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/antiplatelet/DAPT After Ischemic Stroke-TIA.jpeg"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('DAPT After Ischemic Stroke-TIA', 'documents/antiplatelet/DAPT After Ischemic Stroke-TIA.jpeg')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Cerebral Small Vessel Disease Section */}
                    {evidenceSectionMatches('Cerebral Small Vessel Disease', ['Lacunar Stroke']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Cerebral Small Vessel Disease</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Lacunar Stroke */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Lacunar Stroke</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/csvd/Lacunar Stroke 7.13.22.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/csvd/Lacunar Stroke 7.13.22.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Lacunar Stroke', 'documents/csvd/Lacunar Stroke 7.13.22.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* EBM Section */}
                    {evidenceSectionMatches('EBM', ['Interpretation of Clinical Trials', 'CEBM Oxford Resources']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Critical Appraisal</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Interpretation of Clinical Trials */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Interpretation of Clinical Trials</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/ebm/Interpretation of Clinical Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/ebm/Interpretation of Clinical Trials.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Interpretation of Clinical Trials', 'documents/ebm/Interpretation of Clinical Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                        {/* External Link - CEBM Oxford Resources */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="external-link" className="w-6 h-6 text-blue-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">CEBM Oxford Resources</h4>
                              <p className="text-xs text-gray-500">Centre for Evidence-Based Medicine - University of Oxford</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="https://www.cebm.ox.ac.uk/resources"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="external-link" className="w-4 h-4"></i>
                              Visit
                            </a>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* EVT Section */}
                    {evidenceSectionMatches('EVT', ['Large Core Anterior Circulation LVO EVT Trials', 'Basilar Artery Occlusion EVT Trials', 'MeVO & Distal Vessel Occlusion EVT Trials']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Endovascular Therapy</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Large Core Anterior Circulation LVO EVT Trials */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Large Core Anterior Circulation LVO EVT Trials</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/evt/Large Core Anterior Circulation LVO EVT Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/evt/Large Core Anterior Circulation LVO EVT Trials.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Large Core Anterior Circulation LVO EVT Trials', 'documents/evt/Large Core Anterior Circulation LVO EVT Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Document 2 - Basilar Artery Occlusion EVT Trials */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Basilar Artery Occlusion EVT Trials</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/evt/Basilar Artery Occlusion EVT Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/evt/Basilar Artery Occlusion EVT Trials.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Basilar Artery Occlusion EVT Trials', 'documents/evt/Basilar Artery Occlusion EVT Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Document 3 - MeVO & Distal Vessel Occlusion EVT Trials */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">MeVO & Distal Vessel Occlusion EVT Trials</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/evt/MeVO & Distal Vessel Occlusion EVT Trials.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/evt/MeVO & Distal Vessel Occlusion EVT Trials.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('MeVO & Distal Vessel Occlusion EVT Trials', 'documents/evt/MeVO & Distal Vessel Occlusion EVT Trials.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Risk Factors Section */}
                    {evidenceSectionMatches('Risk Factors', ['Timing of Anticoagulation after AF-Related Stroke', 'Atrial Fibrillation & Secondary Stroke Prevention', 'Diabetes and stroke', 'Lipids and Cerebrovascular Disease']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Risk Factors</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-4 p-4 pt-0">

                        {/* Atrial Fibrillation Subsection */}
                        <div className="border-l-4 border-purple-500 pl-4">
                          <h4 className="text-base font-semibold text-purple-800 mb-3">Atrial Fibrillation</h4>
                          <div className="space-y-3">
                            {/* Document 1 - Timing of Anticoagulation after AF-Related Stroke */}
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-gray-900">Timing of Anticoagulation after AF-Related Stroke</h5>
                                  <p className="text-xs text-gray-500">PDF Document</p>
                                </div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <a
                                  href="documents/afib/AC timing after AF-related Stroke.pdf"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                                >
                                  <i data-lucide="eye" className="w-4 h-4"></i>
                                  View
                                </a>
                                <a
                                  href="documents/afib/AC timing after AF-related Stroke.pdf"
                                  download
                                  className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                                >
                                  <i data-lucide="download" className="w-4 h-4"></i>
                                  Download
                                </a>
                                <button
                                  onClick={() => emailDocument('AC timing after AF-related Stroke', 'documents/afib/AC timing after AF-related Stroke.pdf')}
                                  className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                                  title="Email this document"
                                >
                                  <i data-lucide="mail" className="w-4 h-4"></i>
                                  Email
                                </button>
                              </div>
                            </div>

                            {/* Document 2 - Atrial Fibrillation & Secondary Stroke Prevention */}
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-gray-900">Atrial Fibrillation & Secondary Stroke Prevention</h5>
                                  <p className="text-xs text-gray-500">PDF Document</p>
                                </div>
                              </div>
                              <div className="flex flex-wrap gap-2">
                                <a
                                  href="documents/afib/AF & secondary stroke prevention July 2024.pdf"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                                >
                                  <i data-lucide="eye" className="w-4 h-4"></i>
                                  View
                                </a>
                                <a
                                  href="documents/afib/AF & secondary stroke prevention July 2024.pdf"
                                  download
                                  className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                                >
                                  <i data-lucide="download" className="w-4 h-4"></i>
                                  Download
                                </a>
                                <button
                                  onClick={() => emailDocument('AF & secondary stroke prevention July 2024', 'documents/afib/AF & secondary stroke prevention July 2024.pdf')}
                                  className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                                  title="Email this document"
                                >
                                  <i data-lucide="mail" className="w-4 h-4"></i>
                                  Email
                                </button>
                              </div>
                            </div>

                            {/* Document 3 - 2023 AHA AFib Guidelines */}
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i data-lucide="external-link" className="w-6 h-6 text-purple-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-gray-900">2023 AHA AFib Guidelines</h5>
                                  <p className="text-xs text-gray-500">External Link - AHA Journals</p>
                                </div>
                              </div>
                              <div className="flex gap-2">
                                <a
                                  href="https://www.ahajournals.org/doi/10.1161/CIR.0000000000001193"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-medium hover:bg-purple-700 transition-colors flex items-center gap-1"
                                >
                                  <i data-lucide="external-link" className="w-4 h-4"></i>
                                  Open Link
                                </a>
                              </div>
                            </div>

                            {/* Document 4 - 2024 ESC AFib Guidelines */}
                            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                              <div className="flex items-center gap-3 flex-1">
                                <i data-lucide="external-link" className="w-6 h-6 text-purple-600"></i>
                                <div className="flex-1">
                                  <h5 className="text-sm font-medium text-gray-900">2024 ESC AFib Guidelines</h5>
                                  <p className="text-xs text-gray-500">External Link - European Heart Journal</p>
                                </div>
                              </div>
                              <div className="flex gap-2">
                                <a
                                  href="https://academic.oup.com/eurheartj/article/45/36/3314/7738779"
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="px-3 py-2 bg-purple-600 text-white rounded-lg text-xs font-medium hover:bg-purple-700 transition-colors flex items-center gap-1"
                                >
                                  <i data-lucide="external-link" className="w-4 h-4"></i>
                                  Open Link
                                </a>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Diabetes and stroke */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Diabetes and stroke</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/epidemiology/Diabetes and stroke.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/epidemiology/Diabetes and stroke.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Diabetes and stroke', 'documents/epidemiology/Diabetes and stroke.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Lipids and Cerebrovascular Disease */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Lipids and Cerebrovascular Disease</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/epidemiology/Lipids and Cerebrovascular Disease.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/epidemiology/Lipids and Cerebrovascular Disease.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Lipids and Cerebrovascular Disease', 'documents/epidemiology/Lipids and Cerebrovascular Disease.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Thrombolytic Therapy Section */}
                    {evidenceSectionMatches('Thrombolytic Therapy', ['Thrombolytic Therapy 4.5-24h RCTs', 'WAKE-UP Trial']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Thrombolytic Therapy</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Thrombolytic Therapy 4.5-24h RCTs */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Thrombolytic Therapy 4.5-24h RCTs</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <a
                              href="documents/thrombolytic/Thrombolytic Therapy 4.5-24h RCTs.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/thrombolytic/Thrombolytic Therapy 4.5-24h RCTs.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Thrombolytic Therapy 4.5-24h RCTs', 'documents/thrombolytic/Thrombolytic Therapy 4.5-24h RCTs.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Document 2 - WAKE-UP Trial */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="external-link" className="w-6 h-6 text-blue-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">WAKE-UP Trial</h4>
                              <p className="text-xs text-gray-500">External Link - New England Journal of Medicine</p>
                            </div>
                          </div>
                          <div className="flex gap-2">
                            <a
                              href="https://www.nejm.org/doi/full/10.1056/NEJMoa1804355"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="external-link" className="w-4 h-4"></i>
                              Open Link
                            </a>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Exam Section */}
                    {evidenceSectionMatches('Exam', ['Differentiating Acute Confusional State (Delirium) from Aphasia', 'Coma Exam']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Exam</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Differentiating Delirium from Aphasia */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Differentiating Acute Confusional State (Delirium) from Aphasia</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/exam/Differentiating Acute Confusional State (Delirium) from Aphasia.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/exam/Differentiating Acute Confusional State (Delirium) from Aphasia.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Differentiating Acute Confusional State (Delirium) from Aphasia', 'documents/exam/Differentiating Acute Confusional State (Delirium) from Aphasia.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>

                        {/* Document 2 - Coma Exam */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Coma Exam</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/exam/coma exam.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/exam/coma exam.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('coma exam', 'documents/exam/coma exam.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}

                    {/* Large Artery Disease Section */}
                    {evidenceSectionMatches('Large Artery Disease', ['Symptomatic Cervical Carotid Artery Stenosis', 'CREST-2 Trial']) && (
                    <details className="bg-white border border-gray-200 rounded-lg">
                      <summary className="cursor-pointer p-4 font-semibold text-gray-800 hover:bg-gray-50 rounded-lg flex items-center justify-between text-lg">
                        <span>Large Artery Disease</span>
                        <i data-lucide="chevron-down" className="w-5 h-5"></i>
                      </summary>
                      <div className="space-y-3 p-4 pt-0">
                        {/* Document 1 - Symptomatic Cervical Carotid Artery Stenosis */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">Symptomatic Cervical Carotid Artery Stenosis</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/lad/Symptomatic Cervical Carotid Artery Stenosis.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/lad/Symptomatic Cervical Carotid Artery Stenosis.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('Symptomatic Cervical Carotid Artery Stenosis', 'documents/lad/Symptomatic Cervical Carotid Artery Stenosis.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                        {/* Document 2 - CREST-2 Trial */}
                        <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                          <div className="flex items-center gap-3 flex-1">
                            <i data-lucide="file-text" className="w-6 h-6 text-red-600"></i>
                            <div className="flex-1">
                              <h4 className="text-sm font-medium text-gray-900">CREST-2 Trial (December 2025)</h4>
                              <p className="text-xs text-gray-500">PDF Document</p>
                            </div>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            <a
                              href="documents/lad/CREST-2 Trial - Dec 2025.pdf"
                              target="_blank"
                              rel="noopener noreferrer"
                              className="px-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="eye" className="w-4 h-4"></i>
                              View
                            </a>
                            <a
                              href="documents/lad/CREST-2 Trial - Dec 2025.pdf"
                              download
                              className="px-3 py-2 bg-gray-600 text-white rounded-lg text-xs font-medium hover:bg-gray-700 transition-colors flex items-center gap-1"
                            >
                              <i data-lucide="download" className="w-4 h-4"></i>
                              Download
                            </a>
                            <button
                              onClick={() => emailDocument('CREST-2 Trial (December 2025)', 'documents/lad/CREST-2 Trial - Dec 2025.pdf')}
                              className="px-3 py-2 bg-orange-600 text-white rounded-lg text-xs font-medium hover:bg-orange-700 transition-colors flex items-center gap-1"
                              title="Email this document"
                            >
                              <i data-lucide="mail" className="w-4 h-4"></i>
                              Email
                            </button>
                          </div>
                        </div>
                      </div>
                    </details>
                    )}
                  </div>
                )}

              </div>

              {/* Emergency Contacts FAB - Floating Action Button */}
              <div className="fixed z-50 bottom-20 md:bottom-6 right-4">
                {/* Expanded Contact Panel */}
                {fabExpanded && (
                  <div className="absolute bottom-16 right-0 w-72 bg-white rounded-lg shadow-2xl border-2 border-red-300 overflow-hidden animate-fadeIn">
                    <div className="bg-gradient-to-r from-red-600 to-rose-500 text-white px-4 py-2 font-bold flex items-center justify-between">
                      <span className="flex items-center gap-2">
                        <i data-lucide="phone-call" className="w-4 h-4"></i>
                        Quick Contacts
                      </span>
                      <button
                        onClick={() => setFabExpanded(false)}
                        className="hover:bg-red-700 rounded p-1 transition-colors"
                        aria-label="Close contacts"
                      >
                        <i data-lucide="x" className="w-4 h-4"></i>
                      </button>
                    </div>
                    <div className="divide-y divide-gray-100">
                      {/* Stroke Team */}
                      <a
                        href="tel:+12067446789"
                        className="flex items-center gap-3 px-4 py-3 hover:bg-red-50 transition-colors"
                        onClick={() => setFabExpanded(false)}
                      >
                        <div className="bg-red-100 rounded-full p-2">
                          <i data-lucide="phone" className="w-5 h-5 text-red-600"></i>
                        </div>
                        <div>
                          <div className="font-semibold text-gray-900 text-sm">Stroke Phone</div>
                          <div className="text-xs text-gray-500">206-744-6789</div>
                        </div>
                        <i data-lucide="external-link" className="w-4 h-4 text-gray-400 ml-auto"></i>
                      </a>
                      {/* Pharmacy */}
                      <a
                        href="tel:+12067442241"
                        className="flex items-center gap-3 px-4 py-3 hover:bg-orange-50 transition-colors"
                        onClick={() => setFabExpanded(false)}
                      >
                        <div className="bg-orange-100 rounded-full p-2">
                          <i data-lucide="pill" className="w-5 h-5 text-orange-600"></i>
                        </div>
                        <div>
                          <div className="font-semibold text-gray-900 text-sm">STAT Pharmacy</div>
                          <div className="text-xs text-gray-500">206-744-2241</div>
                        </div>
                        <i data-lucide="external-link" className="w-4 h-4 text-gray-400 ml-auto"></i>
                      </a>
                      {/* Neuroradiology */}
                      <a
                        href="tel:+12067448484"
                        className="flex items-center gap-3 px-4 py-3 hover:bg-blue-50 transition-colors"
                        onClick={() => setFabExpanded(false)}
                      >
                        <div className="bg-blue-100 rounded-full p-2">
                          <i data-lucide="scan" className="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div>
                          <div className="font-semibold text-gray-900 text-sm">Stroke RAD Hotline</div>
                          <div className="text-xs text-gray-500">206-744-8484 (Weekdays 8-5)</div>
                        </div>
                        <i data-lucide="external-link" className="w-4 h-4 text-gray-400 ml-auto"></i>
                      </a>
                      {/* Angio Suite */}
                      <a
                        href="tel:+12067443381"
                        className="flex items-center gap-3 px-4 py-3 hover:bg-purple-50 transition-colors"
                        onClick={() => setFabExpanded(false)}
                      >
                        <div className="bg-purple-100 rounded-full p-2">
                          <i data-lucide="activity" className="w-5 h-5 text-purple-600"></i>
                        </div>
                        <div>
                          <div className="font-semibold text-gray-900 text-sm">Angio Suite</div>
                          <div className="text-xs text-gray-500">206-744-3381</div>
                        </div>
                        <i data-lucide="external-link" className="w-4 h-4 text-gray-400 ml-auto"></i>
                      </a>
                      {/* STAT CT */}
                      <a
                        href="tel:+12067447290"
                        className="flex items-center gap-3 px-4 py-3 hover:bg-green-50 transition-colors"
                        onClick={() => setFabExpanded(false)}
                      >
                        <div className="bg-green-100 rounded-full p-2">
                          <i data-lucide="circle-dot" className="w-5 h-5 text-green-600"></i>
                        </div>
                        <div>
                          <div className="font-semibold text-gray-900 text-sm">STAT CT</div>
                          <div className="text-xs text-gray-500">206-744-7290</div>
                        </div>
                        <i data-lucide="external-link" className="w-4 h-4 text-gray-400 ml-auto"></i>
                      </a>
                    </div>
                    <div className="bg-gray-50 px-4 py-2 text-xs text-gray-500 text-center">
                      Tap number to call directly
                    </div>
                  </div>
                )}

                {/* FAB Button */}
                <button
                  onClick={() => setFabExpanded(!fabExpanded)}
                  className={`w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition-all duration-200 ${
                    fabExpanded
                      ? 'bg-gray-600 hover:bg-gray-700 rotate-45'
                      : 'bg-gradient-to-br from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 animate-pulse'
                  }`}
                  aria-label={fabExpanded ? "Close emergency contacts" : "Open emergency contacts"}
                  aria-expanded={fabExpanded}
                  title="Emergency Contacts"
                >
                  <i data-lucide={fabExpanded ? "x" : "phone"} className="w-6 h-6 text-white"></i>
                </button>

                {/* Tooltip when collapsed */}
                {!fabExpanded && (
                  <div className="absolute bottom-16 right-0 bg-gray-900 text-white text-xs py-1 px-2 rounded whitespace-nowrap opacity-0 hover:opacity-100 pointer-events-none transition-opacity hidden md:block">
                    Quick Contacts
                  </div>
                )}
              </div>

              {/* Sign-Out Toast Notification */}
              {signOutToast && (
                <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 z-50 animate-fadeIn">
                  <div className="bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2">
                    <i data-lucide="check-circle" className="w-4 h-4 text-green-400"></i>
                    <span className="text-sm font-medium">{signOutToast}</span>
                  </div>
                </div>
              )}

              {/* Mobile Bottom Navigation - Only visible on small screens */}
              <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-300 shadow-lg z-50 pb-safe">
                <div className="flex justify-around items-center px-2 py-2">
                  {[
                    { id: 'encounter', name: 'Encounter', icon: 'activity' },
                    { id: 'ich', name: 'ICH', icon: 'alert-triangle' },
                    { id: 'protocols', name: 'Management', icon: 'file-text' },
                    { id: 'calculators', name: 'Calculators', icon: 'calculator' },
                    { id: 'trials', name: 'Trials', icon: 'file-text' },
                    { id: 'evidence', name: 'References', icon: 'file-text' },
                    { id: 'regional', name: 'Hospitals', icon: 'map' }
                  ].map((tab) => (
                    <button
                      key={tab.id}
                      onClick={() => {
                        if (tab.id === 'regional') {
                          window.open('https://rkalani1.github.io/telestroke-expansion-map/', '_blank');
                        } else {
                          setActiveTab(tab.id);
                        }
                      }}
                      className={`flex flex-col items-center justify-center px-2 py-2 rounded-lg transition-all ${
                        activeTab === tab.id
                          ? 'text-blue-600 bg-blue-50'
                          : 'text-gray-600'
                      }`}
                    >
                      <i data-lucide={tab.icon} className="w-6 h-6 mb-1"></i>
                      <span className="text-xs font-medium">{tab.name}</span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          );
        };

        // Render the component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StrokeClinicalTool />);

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
