<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Comprehensive clinical decision support tool for stroke management including NIHSS, ASPECTS, and treatment protocols">
    <meta name="theme-color" content="#3B82F6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-title" content="Stroke">
    <title>Stroke</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Newsreader:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="tailwind.css?v=5.14.11">
    <style>
        :root {
            --app-bg: #f8fafc;
            --app-bg-accent: #eef2f7;
            --shell-bg: rgba(255, 255, 255, 0.96);
            --shell-border: rgba(15, 23, 42, 0.06);
            --shell-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            --panel-bg: rgba(255, 255, 255, 0.94);
            --panel-border: rgba(15, 23, 42, 0.06);
            --card-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
            --accent: #2563eb;
            --accent-soft: #dbeafe;
            --text-strong: #0f172a;
            --text-muted: #475569;
        }

        body {
            font-family: "Manrope", "Segoe UI", sans-serif;
            background: radial-gradient(900px circle at 10% -10%, var(--app-bg-accent), transparent 60%),
                        linear-gradient(180deg, var(--app-bg) 0%, #eef2f7 100%);
            color: var(--text-strong);
            font-size: 16px;
            line-height: 1.6;
        }

        h1, h2, h3, h4, h5 {
            font-family: "Newsreader", "Times New Roman", serif;
            letter-spacing: -0.01em;
        }

        .app-shell {
            background: var(--shell-bg);
            border: 1px solid var(--shell-border);
            box-shadow: var(--shell-shadow);
            border-radius: 24px;
            backdrop-filter: blur(12px);
        }

        .app-header {
            background: #fff;
            border-bottom: 1px solid var(--panel-border);
            padding: 0.75rem 1.1rem;
        }

        .app-nav {
            background: #fff;
            border: 1px solid var(--panel-border);
            border-radius: 12px;
            padding: 0.35rem;
        }

        .tool-card {
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
            border-color: rgba(15, 23, 42, 0.1);
            transition: border-color 160ms ease;
        }
        .tool-card:hover {
            border-color: rgba(37, 99, 235, 0.3);
        }

        .tab-pill {
            border: none !important;
            background: transparent;
            border-radius: 999px;
            font-weight: 600;
        }
        .tab-pill.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.25);
        }
        .tab-pill.inactive {
            color: var(--text-muted);
        }
        .tab-pill.inactive:hover {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-strong);
        }

        .compact .p-4 { padding: 0.75rem !important; }
        .compact .p-3 { padding: 0.5rem !important; }
        .compact .gap-4 { gap: 0.75rem !important; }
        .compact .gap-3 { gap: 0.5rem !important; }
        .compact .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.75rem !important; }
        .compact .space-y-3 > :not([hidden]) ~ :not([hidden]) { margin-top: 0.5rem !important; }


        @media (max-width: 640px) {
            .app-shell {
                border-radius: 0;
                border: none;
                box-shadow: none;
            }
            .app-header {
                padding: 1rem;
            }
            .app-nav {
                padding: 0.25rem;
            }
        }

        /* Mobile overflow fix - prevent horizontal scroll */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
            -webkit-overflow-scrolling: touch;
        }

        * {
            box-sizing: border-box;
        }

        /* Ensure all content respects viewport width */
        .main-container {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Fix for flex containers on mobile */
        @media (max-width: 640px) {
            .flex-wrap-mobile {
                flex-wrap: wrap !important;
            }

            /* Ensure buttons wrap properly on mobile */
            .flex.gap-2, .flex.gap-3 {
                flex-wrap: wrap;
            }

            /* Prevent long text from causing overflow */
            h1, h2, h3, h4, h5, p, span, a, button {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            /* Fix for long URLs */
            a {
                word-break: break-all;
            }

            /* Ensure document cards don't overflow */
            .flex.items-center.justify-between {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            /* Make action buttons stack on very small screens */
            .flex.gap-2 > a,
            .flex.gap-2 > button {
                flex: 1 1 auto;
                min-width: 70px;
                text-align: center;
                justify-content: center;
            }
        }

        /* Extra small screen fixes */
        @media (max-width: 375px) {
            /* Smaller padding on very small screens */
            .p-4 {
                padding: 0.75rem !important;
            }
            .p-3 {
                padding: 0.5rem !important;
            }

            /* Smaller text */
            .text-lg {
                font-size: 1rem !important;
            }
            .text-sm {
                font-size: 0.75rem !important;
            }
        }

        /* Fix for date and time inputs on mobile */
        @media (max-width: 640px) {
            input[type="date"],
            input[type="time"] {
                max-width: 100%;
                min-width: 0;
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding-left: 8px !important;
                padding-right: 8px !important;
            }
        }

        /* Neutral overrides removed - using slate palette consistently */

        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            text-decoration: underline;
            text-decoration-style: dotted;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: min(250px, 90vw);
            background-color: #1a202c;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1a202c transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Touch targets minimum 44px */
        button, input[type="checkbox"], input[type="radio"], select {
            min-height: 44px;
            min-width: 44px;
        }
        input[type="checkbox"], input[type="radio"] {
            width: 20px;
            height: 20px;
            margin: 12px;
        }

        /* Success animation */
        @keyframes successPulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .success-pulse {
            animation: successPulse 0.6s;
        }

        /* Alert flash animation for thrombolysis window */
        @keyframes alertFlash {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                transform: scale(1);
            }
            25% {
                box-shadow: 0 0 20px 10px rgba(239, 68, 68, 0.6);
                transform: scale(1.02);
            }
            50% {
                box-shadow: 0 0 30px 15px rgba(239, 68, 68, 0.4);
                transform: scale(1.01);
            }
            75% {
                box-shadow: 0 0 20px 10px rgba(239, 68, 68, 0.6);
                transform: scale(1.02);
            }
        }
        .alert-flash {
            animation: alertFlash 1s ease-in-out infinite;
        }


        /* Fade in animation for FAB */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out forwards;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3B82F6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .focus\:not-sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: inherit;
            margin: inherit;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }

        /* Print styles */
        @media print {
            /* Hide unnecessary elements */
            button, .no-print, [data-lucide="search"], .dark-mode-toggle,
            nav, .breadcrumb, .keyboard-help, .mobile-nav {
                display: none !important;
            }

            /* Optimize for print */
            body {
                background: white;
                color: black;
                font-size: 12pt;
            }

            /* Page breaks */
            .page-break {
                page-break-after: always;
            }

            h1, h2, h3 {
                page-break-after: avoid;
            }

            /* Show URLs for links */
            a[href]:after {
                content: " (" attr(href) ")";
                font-size: 0.8em;
                color: #666;
            }

            /* Optimize tables and calculators for print */
            table, .calculator, .score-card {
                page-break-inside: avoid;
            }

            /* Remove shadows and unnecessary styling */
            * {
                box-shadow: none !important;
                text-shadow: none !important;
            }

            /* Ensure good contrast */
            .bg-gray-50, .bg-blue-50, .bg-green-50, .bg-yellow-50, .bg-red-50 {
                background: white !important;
                border: 1px solid #ddd !important;
            }
        }

        /* Safe area insets for notched devices */
        .pb-safe {
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .mb-safe {
            margin-bottom: env(safe-area-inset-bottom, 0);
        }
        .fab-offset {
            bottom: 1.5rem;
        }
        .fab-layer {
            z-index: 60;
        }

        .action-bar-shadow {
            box-shadow: 0 -8px 24px rgba(15, 23, 42, 0.12);
        }
        /* FAB positioning with safe area */

        /* Better mobile touch feedback */
        @media (max-width: 640px) {
            button, a {
                -webkit-tap-highlight-color: rgba(59, 130, 246, 0.2);
            }

            /* Larger touch targets for mobile */
            .touch-target {
                min-height: 48px;
                min-width: 48px;
            }

            /* Prevent text selection on interactive elements */
            button, .btn, [role="button"] {
                -webkit-user-select: none;
                user-select: none;
            }
        }
        @media (max-width: 640px) {
            body {
                font-size: 17px;
            }
        }

        /* Smooth scrolling for the entire app */
        html {
            scroll-behavior: smooth;
        }

        /* Better focus visibility for accessibility */
        :focus-visible {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* mermaid CSS removed â€” algorithms now use JSX */
    </style>
    <script>
        // CRITICAL: Version management and automatic data cleanup
        // This runs BEFORE React loads to prevent crashes from incompatible data
        (function() {
            const APP_VERSION = 'v5.14.11'; // Increment this with each deployment
            const STORAGE_PREFIX = 'strokeApp:';
            const APP_DATA_KEY = 'stroke.appData.v2';
            const LEGACY_KEYS = [
                'app_version',
                'darkMode',
                'activeTab',
                'patientData',
                'nihssScore',
                'aspectsScore',
                'gcsItems',
                'mrsScore',
                'ichScoreItems',
                'abcd2Items',
                'chads2vascItems',
                'ropeItems',
                'huntHessGrade',
                'wfnsGrade',
                'hasbledItems',
                'rcvs2Items',
                'strokeCodeForm',
                'lkwTime',
                'currentStep',
                'completedSteps',
                'aspectsRegionState',
                'pcAspectsRegions',
                'telestrokeNote',
                'telestrokeTemplate',
                'thrombolysisAlertsMuted',
                'timerSidebarCollapsed',
                'shiftPatients',
                'currentPatientId',
                'consultationType',
                'ttlHoursOverride',
                'lastUpdated',
                'legacyMigrated'
            ];
            const LEGACY_SESSION_KEYS = ['error_reload_attempted'];

            const parseStoredValue = (raw) => {
                if (raw === null || raw === undefined) return null;
                try {
                    return JSON.parse(raw);
                } catch {
                    return raw;
                }
            };

            const getStoredValue = (key) => {
                const namespaced = localStorage.getItem(STORAGE_PREFIX + key);
                if (namespaced !== null) {
                    return parseStoredValue(namespaced);
                }
                return parseStoredValue(localStorage.getItem(key));
            };

            const setStoredValue = (key, value) => {
                try {
                    localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value));
                } catch (e) {
                    console.warn('Failed to write storage key:', key, e);
                }
            };

            const clearAppStorage = (options = {}) => {
                const includeLegacy = options.includeLegacy !== false;
                try {
                    Object.keys(localStorage).forEach((key) => {
                        if (key.startsWith(STORAGE_PREFIX)) {
                            localStorage.removeItem(key);
                        }
                    });
                    localStorage.removeItem(APP_DATA_KEY);
                    if (includeLegacy) {
                        LEGACY_KEYS.forEach((key) => localStorage.removeItem(key));
                    }
                    Object.keys(sessionStorage).forEach((key) => {
                        if (key.startsWith(STORAGE_PREFIX)) {
                            sessionStorage.removeItem(key);
                        }
                    });
                    LEGACY_SESSION_KEYS.forEach((key) => sessionStorage.removeItem(key));
                } catch (e) {
                    console.warn('Storage clear failed:', e);
                }
            };

            window.strokeAppStorage = {
                prefix: STORAGE_PREFIX,
                appDataKey: APP_DATA_KEY,
                legacyKeys: LEGACY_KEYS,
                legacySessionKeys: LEGACY_SESSION_KEYS,
                getStoredValue,
                setStoredValue,
                clearAppStorage,
                appVersion: APP_VERSION
            };

            const storedVersion = getStoredValue('app_version');
            const storedDarkMode = getStoredValue('darkMode') === true;

            // If version doesn't match, clear app storage to prevent crashes
            if (storedVersion && storedVersion !== APP_VERSION) {
                console.log('Version change detected (' + storedVersion + ' -> ' + APP_VERSION + '). Clearing app storage for compatibility.');
                clearAppStorage({ includeLegacy: false });
                if (storedDarkMode) {
                    setStoredValue('darkMode', true);
                }
            }

            setStoredValue('app_version', APP_VERSION);

            // Dark mode initialization
            const darkMode = getStoredValue('darkMode') === true;
            if (darkMode) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body>
    <noscript>
        <div style="padding: 40px; font-family: Arial; max-width: 600px; margin: 0 auto; text-align: center;">
            <h1>Stroke Clinical Decision Support</h1>
            <p>This application requires JavaScript to run. Please enable JavaScript in your browser settings.</p>
        </div>
    </noscript>
    <div id="root"></div>

    <script>
        // Enhanced error handler with automatic recovery
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Error caught:', msg, 'at line', lineNo);

            // If critical error occurs, clear localStorage and reload ONCE
            if (msg && (msg.includes('is not a function') || msg.includes('undefined'))) {
                const hasReloaded = sessionStorage.getItem('error_reload_attempted');
                if (!hasReloaded) {
                    console.log('Critical error detected. Clearing data and reloading...');
                    try {
                        sessionStorage.setItem('error_reload_attempted', 'true');
                    } catch (e) {
                        console.warn('Unable to set session flag:', e);
                    }
                    if (window.strokeAppStorage && typeof window.strokeAppStorage.clearAppStorage === 'function') {
                        window.strokeAppStorage.clearAppStorage();
                    } else {
                        localStorage.clear();
                        sessionStorage.clear();
                    }
                    try {
                        sessionStorage.setItem('error_reload_attempted', 'true');
                    } catch (e) {
                        console.warn('Unable to reset session flag:', e);
                    }
                    window.location.reload();
                } else {
                    // If already reloaded once, show error message instead of infinite loop
                    document.getElementById('root').innerHTML =
                        '<div style="padding: 40px; font-family: Arial; max-width: 600px; margin: 0 auto;">' +
                        '<h1 style="color: #dc2626;">Unable to Load Application</h1>' +
                        '<p style="color: #374151; margin: 20px 0;">A critical error occurred. Please try:</p>' +
                        '<ol style="color: #374151;">' +
                        '<li>Use a different browser (Chrome, Firefox, Safari)</li>' +
                        '<li>Try Incognito/Private mode</li>' +
                        '<li>Contact support if issue persists</li>' +
                        '</ol>' +
                        '<p style="color: #6b7280; font-size: 14px; margin-top: 30px;">Error: ' + msg + '</p>' +
                        '</div>';
                }
            }
            return false;
        };
    </script>
    <script src="app.js?v=5.14.25" defer></script>
</body>
</html>
